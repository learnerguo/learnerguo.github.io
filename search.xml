<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ä¹¦å•è®°å½•</title>
    <url>/2023/d298f472fcd1/index.html</url>
    <content><![CDATA[<h2 id="java"><a href="#java" class="headerlink" title="java"></a>java</h2><ul>
<li>ğŸ“– ã€ŠJavaå¹¶å‘ç¼–ç¨‹æ·±åº¦è§£æä¸å®æˆ˜ã€‹ â€“ è°­é”‹   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ğŸ“– ã€Šå‰‘æŒ‡JVMï¼šè™šæ‹Ÿæœºæ—¶é—´ä¸æ€§èƒ½è°ƒä¼˜ã€‹   â€“ å°šç¡…è°·æ•™è‚²      ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€Šè®¾è®¡æ¨¡å¼å°±è¯¥è¿™ä¹ˆå­¦ï¼šåŸºäºç»å…¸æ¡†æ¶æºç å’ŒçœŸå®ä¸šåŠ¡åœºæ™¯ã€‹   â€“ è°­å‹‡å¾·   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€Šäº’è”ç½‘è½»é‡çº§SSMæ¡†æ¶è§£å¯†ï¼šSpringã€Spring MVCã€MyBatisæºç æ·±åº¦å‰–æã€‹   â€“ æè‰³é¹   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€Šåˆ†å¸ƒå¼ä¸­é—´ä»¶æŠ€æœ¯(Javaç‰ˆ)ã€‹  <a href="https://cmsblogs.cn/4303.html">ä¸‹è½½åœ°å€</a>    ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="Springç³»åˆ—"><a href="#Springç³»åˆ—" class="headerlink" title="Springç³»åˆ—"></a>Springç³»åˆ—</h2><ul>
<li>ã€ŠSpring Cloud Alibabaå¾®æœåŠ¡åŸç†ä¸å®æˆ˜ã€‹  <a href="https://cmsblogs.cn/2647.html">ä¸‹è½½åœ°å€</a>   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€ŠSpringBootæŠ€æœ¯å†…å¹•ã€‹   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h2><ul>
<li>ğŸ“–ã€ŠMySQLæŠ€æœ¯å†…å¹•ï¼šInnoDBå­˜å‚¨å¼•æ“ã€‹ â€“ å§œæ‰¿å°§</li>
<li>ğŸ“– <a href="https://relph1119.github.io/mysql-learning-notes/#/">ã€ŠMySQL æ˜¯æ€æ ·è¿è¡Œçš„ï¼šä»æ ¹å„¿ä¸Šç†è§£ MySQLã€‹</a></li>
</ul>
<h2 id="ç½‘ç»œ"><a href="#ç½‘ç»œ" class="headerlink" title="ç½‘ç»œ"></a>ç½‘ç»œ</h2><ul>
<li>ã€Šæ·±å…¥ç†è§£ TCP åè®®ï¼šä»åŸç†åˆ°å®æˆ˜ã€‹ <a href="https://juejin.cn/book/6844733788681928712">æ˜é‡‘å°å†Œ</a></li>
<li>ã€Šè¶£è°ˆç½‘ç»œåè®®ã€‹  â€“ åˆ˜è¶…  </li>
<li>ã€Šæ·±å…¥æµ…å‡ºè®¡ç®—æœºç½‘ç»œã€‹  â€“éŸ©ç«‹åˆš</li>
<li>ã€Šå®Œå…¨å›¾è§£æœåŠ¡å™¨å·¥ä½œåŸç†ã€‹</li>
<li>ã€Šæ·±å…¥ç†è§£Linuxç½‘ç»œã€‹</li>
<li>ã€Šæ·±å…¥æµ…å‡ºTCP&#x2F;IPã€‹</li>
<li>ã€Šå›¾è§£httpã€‹   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="MQ"><a href="#MQ" class="headerlink" title="MQ"></a>MQ</h2><ul>
<li>ğŸ“–ã€ŠRocketMQå®æˆ˜ä¸åŸç†è§£æã€‹  â€“ æ¨å¼€å…ƒ</li>
<li>ğŸ“– RocketMQåˆ†å¸ƒå¼ä¸­é—´ä»¶ï¼šæ ¸å¿ƒåŸç†ä¸æœ€ä½³å®è·µã€‹   â€“ æä¼Ÿ  ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="äº‘åŸç”Ÿ"><a href="#äº‘åŸç”Ÿ" class="headerlink" title="äº‘åŸç”Ÿ"></a>äº‘åŸç”Ÿ</h2><ul>
<li>ã€ŠKubernetesç½‘ç»œæƒå¨æŒ‡å—ï¼šåŸºç¡€ï¼ŒåŸç†ä¸å®è·µã€‹ â€“ æœå†›   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€Šäº‘åŸç”ŸKuberneteså…¨æ ˆæ¶æ„å¸ˆå®æˆ˜ã€‹ â€“ æœå®½    ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="è®¡ç®—æœºåŸºç¡€"><a href="#è®¡ç®—æœºåŸºç¡€" class="headerlink" title="è®¡ç®—æœºåŸºç¡€"></a>è®¡ç®—æœºåŸºç¡€</h2><ul>
<li>ã€Šæ¼«ç”»è®¡ç®—æœºåŸç†ã€‹</li>
<li>ã€Šè®¡ç®—æœºæ—¶æ€æ ·è·‘èµ·æ¥çš„ã€‹</li>
</ul>
<h2 id="DevOps"><a href="#DevOps" class="headerlink" title="DevOps"></a>DevOps</h2><ul>
<li>ã€ŠæŒç»­äº¤ä»˜2.0ï¼šä¸šåŠ¡å¼•é¢†çš„DevOpsç²¾è¦ã€‹   â€“ ä¹”æ¢      ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><ul>
<li>ã€Šå¯ä¼¸ç¼©åºŸç‰©æ¶æ„ï¼šæ¡†æ¶ä¸ä¸­é—´ä»¶ã€‹  â€“ æè‰³é¹   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€Šç¨‹åºå‘˜å¿…è¯»ä¹‹è½¯ä»¶æ¶æ„ã€‹    ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><ul>
<li>ã€Šæ–°ç¨‹åºå‘˜04ï¼šæˆ‘ä»¬çš„æŠ€æœ¯æ—¶ä»£ï¼Œæˆ‘ä»¬çš„ç¨‹åºäººç”Ÿã€‹    ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€Šç¨‹åºå‘˜çš„ä¿®ç‚¼ä¹‹é“ï¼šé€šå‘åŠ¡å®çš„æœ€é«˜å¢ƒç•Œã€‹           ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li></li>
</ul>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>book</tag>
      </tags>
  </entry>
  <entry>
    <title>Next7ä¸»é¢˜è‡ªå®šä¹‰åˆ†ç±»</title>
    <url>/2023/baf924a75393/index.html</url>
    <content><![CDATA[<p><a href="https://enigmatisms.github.io/2022/02/18/Hexo-NexT%E4%B8%BB%E9%A2%98-%E6%9B%B4%E5%BC%BA%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E9%A1%B5%E9%9D%A2/">å‚è€ƒæ–‡ç« </a></p>
<h2 id="æ·»åŠ ä¾èµ–åŒ…"><a href="#æ·»åŠ ä¾èµ–åŒ…" class="headerlink" title="æ·»åŠ ä¾èµ–åŒ…"></a>æ·»åŠ ä¾èµ–åŒ…</h2><figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">npm</span> uninstall hexo-generator-index</span><br><span class="line"><span class="built_in">npm</span> install hexo-generator-indexed</span><br><span class="line"><span class="built_in">npm</span> install hexo-pagination --save</span><br><span class="line"><span class="built_in">npm</span> install timsort --save</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h2 id="æ·»åŠ è‡ªå®šä¹‰æ–‡ä»¶"><a href="#æ·»åŠ è‡ªå®šä¹‰æ–‡ä»¶" class="headerlink" title="æ·»åŠ è‡ªå®šä¹‰æ–‡ä»¶"></a>æ·»åŠ è‡ªå®šä¹‰æ–‡ä»¶</h2><ol>
<li>å¢åŠ çš„åˆ†ç±»æ˜¯ é˜…è¯»ï¼šbook</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-home</span></span><br><span class="line">  <span class="attr">about:</span> <span class="string">/about/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-user</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">/tags/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-tags</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">/categories/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-th</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">/archives/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-archive</span></span><br><span class="line">  <span class="comment"># schedule: /schedule/ || fa fa-calendar</span></span><br><span class="line">  <span class="attr">book:</span> <span class="string">/book/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-book</span> <span class="comment">#è¿™é‡Œæ˜¯æ–°æ·»åŠ çš„èœå•</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åœ¨åšå®¢æ ¹ç›®å½•ä¸‹åˆ›å»º scripts ç›®å½•å¹¶åˆ›å»º <code>customcategory.js</code> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> pagination = <span class="built_in">require</span>(<span class="string">&#x27;hexo-pagination&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; sort &#125; = <span class="built_in">require</span>(<span class="string">&#x27;timsort&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> filteredCategory = <span class="string">&#x27;book&#x27;</span>;</span><br><span class="line"></span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">generator</span>.<span class="title function_">register</span>(<span class="string">&#x27;customcategory&#x27;</span>, <span class="keyword">function</span>(<span class="params">locals</span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> posts = locals.<span class="property">posts</span>.<span class="title function_">filter</span>(<span class="keyword">function</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x.<span class="property">categories</span>.<span class="property">data</span>[<span class="number">0</span>].<span class="property">name</span> == filteredCategory;</span><br><span class="line">  &#125;).<span class="title function_">sort</span>(<span class="string">&#x27;-date&#x27;</span>).<span class="title function_">slice</span>(<span class="number">0</span>);				<span class="comment">// å¤åˆ¶ï¼Œè€ŒéåŸåœ°æ“ä½œ</span></span><br><span class="line">  <span class="title function_">sort</span>(posts.<span class="property">data</span>, <span class="function">(<span class="params">a, b</span>) =&gt;</span> (b.<span class="property">sticky</span> || <span class="number">0</span>) - (a.<span class="property">sticky</span> || <span class="number">0</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">pagination</span>(<span class="string">&#x27;book&#x27;</span>, posts, &#123;</span><br><span class="line">    <span class="attr">perPage</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">layout</span>: [<span class="string">&#x27;customcategory&#x27;</span>],</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">      <span class="attr">__index</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>åœ¨ä¸»é¢˜çš„ layout ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶ <code>customcategory.njk</code> æ–‡ä»¶å†…å®¹å¦‚ä¸‹</li>
</ol>
<figure class="highlight django"><table><tr><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">extends</span></span> &#x27;_layout.njk&#x27; %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name">import</span> &#x27;_macro/post-collapse.njk&#x27; <span class="keyword">as</span> post_template with context %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name">import</span> &#x27;_macro/sidebar.njk&#x27; <span class="keyword">as</span> sidebar_template with context %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> title %&#125;</span><span class="template-variable">&#123;&#123; __(&#x27;title.category&#x27;) &#125;&#125;</span><span class="language-xml">: </span><span class="template-variable">&#123;&#123; page.category &#125;&#125;</span><span class="language-xml"> | </span><span class="template-variable">&#123;&#123; title &#125;&#125;</span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> class %&#125;</span><span class="language-xml">index posts-expand</span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> content %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;%- <span class="name"><span class="name">for</span></span> post <span class="keyword">in</span> page.posts.toArray() %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-variable">&#123;&#123; partial(&#x27;_macro/post.njk&#x27;, &#123;post: post, is_index: true&#125;) &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;%- <span class="name"><span class="name">include</span></span> &#x27;_partials/pagination.njk&#x27; -%&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> sidebar %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; sidebar_template.render(false) &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Next8ç‰ˆæœ¬ä¸»é¢˜ä¼˜åŒ–ä¿®æ”¹çš„æ–‡ä»¶</title>
    <url>/2023/44b973fe011c/index.html</url>
    <content><![CDATA[<p><a href="https://zhuanlan.zhihu.com/p/252983030">å‚è€ƒæ–‡ç« </a></p>
<span id="more"></span>

<p>é¦–é¡µæ¯ç¯‡æ–‡ç« å˜æˆåœ†è§’ï¼Œåªéœ€è¦åœ¨ <code>styles.styl</code> ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// æ·»åŠ é¦–é¡µæ¯ç¯‡æ–‡ç« åœ†è§’ç‹¬ç«‹ start ------------</span><br><span class="line">.post-block&#123;</span><br><span class="line">        background-color: rgba(255, 255, 255, 1);</span><br><span class="line">        //margin-top: 24px;</span><br><span class="line">        margin-bottom: 24px;</span><br><span class="line">        padding: 20px;</span><br><span class="line">        border-radius: 30px 50px 30px 50px;</span><br><span class="line">        box-shadow: 8px 7px 2px 0 rgba(0,0,0,0.12), 7px 4px 1px -2px rgba(0,0,0,0.06), 0 1px 5px 0 rgba(0,0,0,0.12);</span><br><span class="line">&#125;</span><br><span class="line">// æ·»åŠ é¦–é¡µæ¯ç¯‡æ–‡ç« åœ†è§’ç‹¬ç«‹ end ------------</span><br></pre></td></tr></table></figure>
<p><code>styles.styl</code> åœ¨åšå®¢æ ¹ç›®å½•ä¸‹çš„ï¼Œ<code>source/_data</code> ä¸‹ï¼Œè‹¥æ²¡æœ‰åˆ™éœ€è¦è‡ªå·±åˆ›å»ºå¹¶ä¸”åœ¨ <code>next</code> ä¸»é¢˜çš„ <code>_config.yml</code> ä¸­æ‰“å¼€ä¸‹é¢çš„æ³¨é‡Š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">custom_file_path:</span></span><br><span class="line">  <span class="comment">#head: source/_data/head.njk</span></span><br><span class="line">  <span class="comment">#header: source/_data/header.njk</span></span><br><span class="line">  <span class="attr">style:</span> <span class="string">source/_data/styles.styl</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>butterflyä¸»é¢˜å¤šçº§åˆ†ç±»æŠ˜å ä¸å±•å¼€</title>
    <url>/2023/acbd53e5de56/index.html</url>
    <content><![CDATA[<ol>
<li>å¼•å…¥ <code>jquery</code> å’Œ è‡ªå®šä¹‰çš„ js æ–‡ä»¶</li>
</ol>
<p>æ‰“å¼€ <code>_config.butterfly.yml</code> æ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">inject:</span></span><br><span class="line">  <span class="attr">head:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;link</span> <span class="string">rel=&quot;stylesheet&quot;</span> <span class="string">href=&quot;/cusconfig/css/hidemermaid.css?1&quot;&gt;</span></span><br><span class="line">    <span class="comment"># å¼•å…¥jquery</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;script</span> <span class="string">src=&quot;https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line">    <span class="comment"># å¼•å…¥è‡ªå®šä¹‰æ–‡ä»¶ï¼Œè‡ªå®šä¹‰æ–‡ä»¶æ”¾åœ¨åšå®¢æ ¹ç›®å½•çš„ /cusconfig/js ç›®å½•ä¸‹ï¼Œåç§°æ˜¯ category.js</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;script</span> <span class="string">src=&quot;/cusconfig/js/category.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line">  <span class="attr">bottom:</span></span><br><span class="line">    <span class="comment"># - &lt;script src=&quot;xxxx&quot;&gt;&lt;/script&gt;</span></span><br><span class="line">    <span class="comment"># - &lt;script src=&quot;https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js&quot;&gt;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>category.js æ–‡ä»¶å†…å®¹</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="title function_">categoryUnfold</span>();</span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">categoryUnfold</span>(<span class="params"></span>) &#123;</span><br><span class="line">		$(<span class="string">&quot;.category-list-link&quot;</span>).<span class="title function_">filter</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>($(<span class="variable language_">this</span>).<span class="title function_">siblings</span>(<span class="string">&quot;.category-list-child&quot;</span>).<span class="property">length</span> &gt; <span class="number">0</span>)</span><br><span class="line">                <span class="comment">// è¿™é‡Œå¼•å…¥äº†å‘ä¸‹å±•å¼€çš„å›¾æ ‡ï¼Œå¯ä»¥ç›´æ¥ä»æœ¬ç«™ä¸‹è½½æ”¾å…¥å¯¹åº”ç›®å½•å³å¯</span></span><br><span class="line">				$(<span class="variable language_">this</span>).<span class="title function_">parent</span>().<span class="title function_">css</span>(<span class="string">&quot;list-style-image&quot;</span>,<span class="string">&quot;url(&#x27;/cusconfig/img/category-unfold-16x16.png&#x27;&quot;</span>);</span><br><span class="line">		&#125;);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//ç‚¹å‡»å«æœ‰å­æ ‡ç­¾category-list-childçš„category-list-linkæ ‡ç­¾æ—¶ï¼Œä¸è¿›è¡Œè·³è½¬</span></span><br><span class="line">		$(<span class="string">&quot;.category-list-link&quot;</span>).<span class="title function_">filter</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> $(<span class="variable language_">this</span>).<span class="title function_">siblings</span>(<span class="string">&quot;.category-list-child&quot;</span>).<span class="property">length</span> &gt; <span class="number">0</span></span><br><span class="line">		&#125;).<span class="title function_">attr</span>(<span class="string">&quot;href&quot;</span>, <span class="string">&quot;javascript:void(0)&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//å«æœ‰å­æ ‡ç­¾category-list-childçš„category-list-linkæ ‡ç­¾å°†è‡ªåŠ¨éšè—å­æ ‡ç­¾</span></span><br><span class="line">		$(<span class="string">&quot;.category-list-link&quot;</span>).<span class="title function_">filter</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>($(<span class="variable language_">this</span>).<span class="title function_">siblings</span>(<span class="string">&quot;.category-list-child&quot;</span>).<span class="property">length</span> &gt; <span class="number">0</span>)</span><br><span class="line">				$(<span class="variable language_">this</span>).<span class="title function_">siblings</span>(<span class="string">&quot;.category-list-child&quot;</span>).<span class="title function_">hide</span>();</span><br><span class="line">		&#125;);	</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//ç‚¹å‡»å«æœ‰å­æ ‡ç­¾category-list-childçš„category-list-linkæ ‡ç­¾æ—¶ï¼Œå°†éšè—å­æ ‡ç­¾å±•å¼€</span></span><br><span class="line">		$(<span class="string">&quot;.category-list-link&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">			$(<span class="variable language_">this</span>).<span class="title function_">siblings</span>(<span class="string">&quot;.category-list-child&quot;</span>).<span class="title function_">slideToggle</span>();</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>butterflyä¸»é¢˜å½’æ¡£åˆ†ç±»é¡µé¢å±•ç¤ºæˆåŒæ </title>
    <url>/2023/e641424208d5/index.html</url>
    <content><![CDATA[<ol>
<li>åœ¨ åšå®¢æ ¹ç›®å½•çš„ <code>source</code> ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹ <code>cusconfig/css</code>, å¹¶åˆ›å»ºæ–‡ä»¶, <code>cus_butterfly.css</code>, æ·»åŠ å¦‚ä¸‹å†…å®¹</li>
</ol>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* å½’æ¡£ï¼Œåˆ†ç±»æ–‡æ¡£é¡µé¢è®¾ç½®åŒæ å±•ç¤ºï¼Œ å¢åŠ è¾¹æ¡† */</span></span><br><span class="line"><span class="selector-class">.no-article-cover</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">48%</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> dashed lightblue;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(<span class="number">241</span>, <span class="number">242</span>, <span class="number">246</span>, <span class="number">0.5</span>);</span><br><span class="line">    <span class="attribute">float</span>: left;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.article-sort-item</span><span class="selector-class">.year</span> &#123;</span><br><span class="line">    <span class="attribute">clear</span>: both;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#pagination</span> &#123;</span><br><span class="line">    <span class="attribute">clear</span>:both;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å¼•å…¥è‡ªå®šä¹‰ <code>css</code> æ–‡ä»¶ï¼Œ æ‰“å¼€ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>_config.butterfly.yml</code>, æ·»åŠ å¦‚ä¸‹å†…å®¹</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">inject:</span></span><br><span class="line">  <span class="attr">head:</span></span><br><span class="line">    <span class="comment"># æ·»åŠ ä¸‹é¢è¿™è¡Œå†…å®¹å¼•å…¥è‡ªå®šä¹‰ js</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;link</span> <span class="string">rel=&quot;stylesheet&quot;</span> <span class="string">href=&quot;/cusconfig/css/cus_butterfly.css?1&quot;&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="å»æ‰æ–‡æ¡£å‰é¢çš„ç‚¹å’Œç«–çº¿"><a href="#å»æ‰æ–‡æ¡£å‰é¢çš„ç‚¹å’Œç«–çº¿" class="headerlink" title="å»æ‰æ–‡æ¡£å‰é¢çš„ç‚¹å’Œç«–çº¿"></a>å»æ‰æ–‡æ¡£å‰é¢çš„ç‚¹å’Œç«–çº¿</h1><p>ä¿®æ”¹ <code>archives.styl</code> æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶è·¯å¾„ä¸º <code>åšå®¢æ ¹ç›®å½•/themes/butterfly/source/css_page</code> ä¸‹é¢ï¼Œ æœ‰æ³¨é‡Šçš„åœ°æ–¹ä»£è¡¨ä¿®æ”¹è¿‡</p>
<figure class="highlight nestedtext"><table><tr><td class="code"><pre><span class="line"><span class="attribute">.article-sort</span></span><br><span class="line"><span class="attribute">  margin-left</span><span class="punctuation">:</span> <span class="string">10px</span></span><br><span class="line">  <span class="attribute">padding-left</span><span class="punctuation">:</span> <span class="string">20px</span></span><br><span class="line">  <span class="attribute">// border-left</span><span class="punctuation">:</span> <span class="string">2px solid lighten($light-blue, 20)   è¿™ä¸€è¡Œæ³¨é‡Šæ‰ï¼Œè¿™é‡Œå»æ‰ç«–çº¿</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">&amp;-title</span></span><br><span class="line"><span class="attribute">    position</span><span class="punctuation">:</span> <span class="string">relative</span></span><br><span class="line">    <span class="attribute">margin-left</span><span class="punctuation">:</span> <span class="string">10px</span></span><br><span class="line">    <span class="attribute">padding-bottom</span><span class="punctuation">:</span> <span class="string">20px</span></span><br><span class="line">    <span class="attribute">padding-left</span><span class="punctuation">:</span> <span class="string">20px</span></span><br><span class="line">    <span class="attribute">font-size</span><span class="punctuation">:</span> <span class="string">1.72em</span></span><br><span class="line"></span><br><span class="line">    &amp;:hover</span><br><span class="line">      &amp;:before</span><br><span class="line">        <span class="attribute">border-color</span><span class="punctuation">:</span> <span class="string">var(--pseudo-hover)</span></span><br><span class="line"></span><br><span class="line">    &amp;:before</span><br><span class="line">      <span class="attribute">position</span><span class="punctuation">:</span> <span class="string">absolute</span></span><br><span class="line">      <span class="attribute">top</span><span class="punctuation">:</span> <span class="string">calc(((100% - 36px) / 2))</span></span><br><span class="line">      <span class="attribute">left</span><span class="punctuation">:</span> <span class="string">-9px</span></span><br><span class="line">      <span class="attribute">z-index</span><span class="punctuation">:</span> <span class="string">1</span></span><br><span class="line">      <span class="attribute">width</span><span class="punctuation">:</span> <span class="string">w = 10px</span></span><br><span class="line">      <span class="attribute">height</span><span class="punctuation">:</span> <span class="string">h = w</span></span><br><span class="line">      <span class="attribute">border</span><span class="punctuation">:</span> <span class="string">.5 * w solid $light-blue</span></span><br><span class="line">      <span class="attribute">border-radius</span><span class="punctuation">:</span> <span class="string">w</span></span><br><span class="line">      <span class="attribute">background</span><span class="punctuation">:</span> <span class="string">var(--card-bg)</span></span><br><span class="line">      <span class="attribute">content</span><span class="punctuation">:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="attribute">line-height</span><span class="punctuation">:</span> <span class="string">h</span></span><br><span class="line">      <span class="attribute">transition</span><span class="punctuation">:</span> <span class="string">all .2s ease-in-out</span></span><br><span class="line"></span><br><span class="line">    &amp;:after</span><br><span class="line">      <span class="attribute">position</span><span class="punctuation">:</span> <span class="string">absolute</span></span><br><span class="line">      <span class="attribute">bottom</span><span class="punctuation">:</span> <span class="string">0</span></span><br><span class="line">      <span class="attribute">left</span><span class="punctuation">:</span> <span class="string">0</span></span><br><span class="line">      <span class="attribute">z-index</span><span class="punctuation">:</span> <span class="string">0</span></span><br><span class="line">      <span class="attribute">width</span><span class="punctuation">:</span> <span class="string">2px</span></span><br><span class="line">      <span class="attribute">height</span><span class="punctuation">:</span> <span class="string">1.5em</span></span><br><span class="line">      <span class="attribute">background</span><span class="punctuation">:</span> <span class="string">lighten($light-blue, 20)</span></span><br><span class="line">      <span class="attribute">content</span><span class="punctuation">:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">&amp;-item</span></span><br><span class="line"><span class="attribute">    position</span><span class="punctuation">:</span> <span class="string">relative</span></span><br><span class="line">    <span class="attribute">display</span><span class="punctuation">:</span> <span class="string">flex</span></span><br><span class="line">    <span class="attribute">align-items</span><span class="punctuation">:</span> <span class="string">center</span></span><br><span class="line">    <span class="attribute">margin</span><span class="punctuation">:</span> <span class="string">0 0 20px 10px</span></span><br><span class="line">    <span class="attribute">transition</span><span class="punctuation">:</span> <span class="string">all .2s ease-in-out</span></span><br><span class="line"></span><br><span class="line">    &amp;:hover</span><br><span class="line">      &amp;:before</span><br><span class="line">        <span class="attribute">border-color</span><span class="punctuation">:</span> <span class="string">var(--pseudo-hover)</span></span><br><span class="line"></span><br><span class="line">    /* &amp;:before   è¿™ä¸€æ•´å—éƒ½æ³¨é‡Šæ‰ï¼Œè¿™é‡Œæ˜¯å»æ‰æ–‡ç« å‰é¢çš„ç‚¹</span><br><span class="line">      <span class="attribute">$w = 6px</span></span><br><span class="line"><span class="attribute">      position</span><span class="punctuation">:</span> <span class="string">absolute</span></span><br><span class="line">      <span class="attribute">left</span><span class="punctuation">:</span> <span class="string">calc(-20px - 17px)</span></span><br><span class="line">      <span class="attribute">width</span><span class="punctuation">:</span> <span class="string">w = $w</span></span><br><span class="line">      <span class="attribute">height</span><span class="punctuation">:</span> <span class="string">h = w</span></span><br><span class="line">      <span class="attribute">border</span><span class="punctuation">:</span> <span class="string">.5 * w solid $light-blue</span></span><br><span class="line">      <span class="attribute">border-radius</span><span class="punctuation">:</span> <span class="string">w</span></span><br><span class="line">      <span class="attribute">background</span><span class="punctuation">:</span> <span class="string">var(--card-bg)</span></span><br><span class="line">      <span class="attribute">content</span><span class="punctuation">:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="attribute">transition</span><span class="punctuation">:</span> <span class="string">all .2s ease-in-out */</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">&amp;.no-article-cover</span></span><br><span class="line"><span class="attribute">      height</span><span class="punctuation">:</span> <span class="string">80px</span></span><br><span class="line"></span><br><span class="line">      <span class="attribute">.article-sort-item-info</span></span><br><span class="line"><span class="attribute">        padding</span><span class="punctuation">:</span> <span class="string">0</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">&amp;.year</span></span><br><span class="line"><span class="attribute">      font-size</span><span class="punctuation">:</span> <span class="string">1.43em</span></span><br><span class="line"></span><br><span class="line">      &amp;:hover</span><br><span class="line">        &amp;:before</span><br><span class="line">          <span class="attribute">border-color</span><span class="punctuation">:</span> <span class="string">$light-blue</span></span><br><span class="line"></span><br><span class="line">      &amp;:before</span><br><span class="line">        <span class="attribute">border-color</span><span class="punctuation">:</span> <span class="string">var(--pseudo-hover)</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">&amp;-time</span></span><br><span class="line"><span class="attribute">      color</span><span class="punctuation">:</span> <span class="string">$theme-meta-color</span></span><br><span class="line">      <span class="attribute">font-size</span><span class="punctuation">:</span> <span class="string">95%</span></span><br><span class="line"></span><br><span class="line">      <span class="attribute">time</span></span><br><span class="line"><span class="attribute">        padding-left</span><span class="punctuation">:</span> <span class="string">6px</span></span><br><span class="line">        <span class="attribute">cursor</span><span class="punctuation">:</span> <span class="string">default</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">&amp;-title</span></span><br><span class="line"><span class="attribute">      @extend .limit-more-line</span></span><br><span class="line"><span class="attribute">      color</span><span class="punctuation">:</span> <span class="string">var(--font-color)</span></span><br><span class="line">      <span class="attribute">font-size</span><span class="punctuation">:</span> <span class="string">1.1em</span></span><br><span class="line">      <span class="attribute">transition</span><span class="punctuation">:</span> <span class="string">all .3s</span></span><br><span class="line">      <span class="attribute">-webkit-line-clamp</span><span class="punctuation">:</span> <span class="string">2</span></span><br><span class="line"></span><br><span class="line">      &amp;:hover</span><br><span class="line">        <span class="attribute">color</span><span class="punctuation">:</span> <span class="string">$text-hover</span></span><br><span class="line">        <span class="attribute">transform</span><span class="punctuation">:</span> <span class="string">translateX(10px)</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">&amp;-img</span></span><br><span class="line"><span class="attribute">      overflow</span><span class="punctuation">:</span> <span class="string">hidden</span></span><br><span class="line">      <span class="attribute">width</span><span class="punctuation">:</span> <span class="string">80px</span></span><br><span class="line">      <span class="attribute">height</span><span class="punctuation">:</span> <span class="string">80px</span></span><br><span class="line"></span><br><span class="line">      :first-child</span><br><span class="line">        <span class="attribute">@extend .imgHover</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">    &amp;-info</span></span><br><span class="line"><span class="attribute">      flex</span><span class="punctuation">:</span> <span class="string">1</span></span><br><span class="line">      <span class="attribute">padding</span><span class="punctuation">:</span> <span class="string">0 16px</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>




]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>butterflyæ ‡ç­¾é¡µå›ºå®šæ¯è¡Œä¸ªæ•°</title>
    <url>/2023/1099169ec3c6/index.html</url>
    <content><![CDATA[<ol>
<li><p>å¯ä»¥å…ˆå‚è€ƒå¦‚ä¸‹æ–‡ç« æ·»åŠ è‡ªå®šä¹‰ <code>css</code> æ–‡ä»¶</p>
<ol><li><a href="/2023/e641424208d5/index.html" title="butterflyä¸»é¢˜å½’æ¡£åˆ†ç±»é¡µé¢å±•ç¤ºæˆåŒæ ">butterflyä¸»é¢˜å½’æ¡£åˆ†ç±»é¡µé¢å±•ç¤ºæˆåŒæ </a></li></ol>
</li>
<li><p>åœ¨ <code>cus_butterfly.css</code> æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹</p>
</li>
</ol>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* ä¿®æ”¹æ ‡ç­¾é¡µï¼Œæ¯ä¸ªæ ‡ç­¾å®½åº¦å›ºå®š  start -------------- */</span></span><br><span class="line"><span class="selector-class">.tag-cloud-list</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-wrap</span>: wrap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ¯è¡Œæ”¾5ä¸ªæ ‡ç­¾ */</span></span><br><span class="line"><span class="selector-class">.tag-cloud-list</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">20%</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä¿®æ”¹æ ‡ç­¾é¡µï¼Œæ¯ä¸ªæ ‡ç­¾å®½åº¦å›ºå®š  end -------------- */</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>hexoä½¿ç”¨æ’å…¥æœ¬åœ°å›¾ç‰‡è·¯å¾„é—®é¢˜</title>
    <url>/2023/563e23df91d3/index.html</url>
    <content><![CDATA[<p>Hexo version: 7.0<br>Next version: 8.18</p>
<span id="more"></span>
<ol>
<li>å®‰è£…æ’ä»¶</li>
</ol>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">npm install hexo-renderer-marked <span class="comment">--save</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>ä¿®æ”¹ hexo é…ç½®æ–‡ä»¶ <code>_config.yml</code> (ä¸æ˜¯next ä¸»é¢˜çš„é…ç½®æ–‡ä»¶)</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è¿™æ ·æ–‡ç« ç”Ÿæˆçš„è·¯å¾„ä¼šæ˜¯å¹´/æœˆ/æ—¥/hashå€¼å½¢å¼</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">:year/:month/:day/:hash/</span></span><br><span class="line"><span class="comment"># å¼€å¯èµ„æºæ–‡ä»¶å¤¹åŠŸèƒ½</span></span><br><span class="line"><span class="attr">post_asset_folder:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">marked:</span></span><br><span class="line">  <span class="comment"># è¿™ä¸¤ä¸ªå€¼éƒ½é…ç½®ä¸ºfalseï¼Œç½‘ä¸Šå¾ˆå¤šæ–‡ç« é…ç½®æˆtrueï¼Œå¯èƒ½æ˜¯ä¸åŒç‰ˆæœ¬æ•ˆæœä¸åŒï¼Œåœ¨ Next8.18, hexo7 è¿™ä¸ªç‰ˆæœ¬è‹¥é…ç½®æˆtrueï¼Œå›¾ç‰‡è·¯å¾„ä¼šå¤šäº†æ—¥æœŸå¯¼è‡´æ˜¾ç¤ºå¤±è´¥ </span></span><br><span class="line">  <span class="attr">prependRoot:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">postAsset:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åœ¨ md æ–‡ç« ç›®å½•ä¸­åˆ›å»ºåŒåçš„æ–‡ä»¶å¤¹ï¼Œæ¯”å¦‚å½“å‰è¿™ç¯‡æ–‡ç« çš„åç§°æ˜¯ <code>hexoæ’å…¥æœ¬åœ°å›¾ç‰‡è·¯å¾„é—®é¢˜</code>ï¼Œ é‚£å°±éœ€è¦åœ¨è¿™ç¯‡æ–‡ç« çš„åŒçº§ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåŒåçš„æ–‡ä»¶å¤¹ï¼Œç„¶åå›¾ç‰‡å°±æ”¾åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­</li>
<li>åœ¨ä½¿ç”¨ md è¯­æ³•å¼•å…¥å›¾ç‰‡çš„æ—¶å€™ï¼Œå› ä¸ºå›¾ç‰‡æ˜¯æ”¾åœ¨ç›®å½•ä¸­ï¼ˆå’Œæ–‡ç« åŒåçš„é‚£ä¸ªç›®å½•ï¼‰ï¼Œä½†æ˜¯å¦‚æœåœ¨æœ¬åœ° vscode ä¸­å°†ç›®å½•ä¹ŸåŠ ä¸Šï¼Œè™½ç„¶æœ¬åœ°å¯ä»¥è®¿é—®ï¼Œä½†æ˜¯ hexo g ç”Ÿæˆä¹‹åï¼Œè®¿é—®åšå®¢åœ°å€æ˜¯æ— æ³•è®¿é—®çš„ï¼Œæ‰€ä»¥æœ¬åœ°å¼•å…¥å›¾ç‰‡çš„æ—¶å€™åªèƒ½å†™å›¾ç‰‡çš„æ–‡ä»¶åï¼Œä¸è¦è·¯å¾„ï¼Œè¿™æ ·è™½ç„¶æœ¬åœ°æ— æ³•é¢„è§ˆï¼Œä½†æ˜¯ hexo s å’Œ hexo d ä¹‹åçš„ç»“æœéƒ½å¯ä»¥æ­£å¸¸æŸ¥çœ‹</li>
</ol>
]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>hexoå’ŒNextä¸»é¢˜ä¿®æ”¹</title>
    <url>/2023/52739010ef7c/index.html</url>
    <content><![CDATA[<h1 id="hexoä¸­-Nextä¸»é¢˜ç›¸å…³ä¿®æ”¹"><a href="#hexoä¸­-Nextä¸»é¢˜ç›¸å…³ä¿®æ”¹" class="headerlink" title="hexoä¸­ Nextä¸»é¢˜ç›¸å…³ä¿®æ”¹"></a>hexoä¸­ Nextä¸»é¢˜ç›¸å…³ä¿®æ”¹</h1><h2 id="æ–‡ç« ç›®å½•é»˜è®¤å±•å¼€"><a href="#æ–‡ç« ç›®å½•é»˜è®¤å±•å¼€" class="headerlink" title="æ–‡ç« ç›®å½•é»˜è®¤å±•å¼€"></a>æ–‡ç« ç›®å½•é»˜è®¤å±•å¼€</h2><p>åŸºäº Next7.x ç‰ˆæœ¬</p>
<ol>
<li>ä¸»é¢˜é…ç½®æ–‡ä»¶ _config.yml ä¸­æœç´¢ custom_file_path,çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼Œæ‰“å¼€ style é‚£ä¸€è¡Œçš„æ³¨é‡Š</li>
</ol>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">custom_file_path:</span></span><br><span class="line">  <span class="comment">#head: source/_data/head.swig</span></span><br><span class="line">  <span class="comment">#header: source/_data/header.swig</span></span><br><span class="line">  <span class="comment">#sidebar: source/_data/sidebar.swig</span></span><br><span class="line">  <span class="comment">#postMeta: source/_data/post-meta.swig</span></span><br><span class="line">  <span class="comment">#postBodyEnd: source/_data/post-body-end.swig</span></span><br><span class="line">  <span class="comment">#footer: source/_data/footer.swig</span></span><br><span class="line">  <span class="comment">#bodyEnd: source/_data/body-end.swig</span></span><br><span class="line">  <span class="comment">#variable: source/_data/variables.styl</span></span><br><span class="line">  <span class="comment">#mixin: source/_data/mixins.styl</span></span><br><span class="line">  <span class="attr">style:</span> <span class="string">source/_data/styles.styl</span></span><br></pre></td></tr></table></figure>
<span id="more"></span>
<ol start="2">
<li>åœ¨é¡¹ç›®æ ¹ç›®å½•(æ³¨æ„è¿™é‡Œä¸æ˜¯åœ¨ä¸»é¢˜ç›®å½•ä¸‹æ–°å»º)ä¸‹çš„ source ç›®å½•ä¸‹æ–°å»º _data ç›®å½•ï¼Œå¹¶ä¸”åˆ›å»º style.styl æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</li>
</ol>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ–‡ç« ç›®å½•é»˜è®¤å±•å¼€</span></span><br><span class="line"><span class="selector-class">.post-toc</span> <span class="selector-class">.nav</span> <span class="selector-class">.nav-child</span> &#123; </span><br><span class="line">    <span class="attribute">display</span>: block; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ–‡ç« ç›®å½•å­—ä½“å¤§å°è°ƒæ•´</span></span><br><span class="line"><span class="selector-class">.post-toc</span> <span class="selector-tag">ol</span> &#123;  </span><br><span class="line">    <span class="attribute">font-size</span> : <span class="number">14px</span>;     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ _config.yml, æœç´¢ toc ä¿®æ”¹å†…å®¹å¦‚ä¸‹</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ–‡ç« ç›®å½•</span></span><br><span class="line"><span class="attr">toc:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">number:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">wrap:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="æ·»åŠ æœç´¢åŠŸèƒ½"><a href="#æ·»åŠ æœç´¢åŠŸèƒ½" class="headerlink" title="æ·»åŠ æœç´¢åŠŸèƒ½"></a>æ·»åŠ æœç´¢åŠŸèƒ½</h2><ol>
<li>å®‰è£…ä¾èµ–</li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">npm install hexo<span class="operator">-</span>generator<span class="operator">-</span><span class="keyword">search</span> <span class="comment">--save</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åœ¨å…¨å±€é…ç½®æ–‡ä»¶ _config.yml ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹</li>
</ol>
<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="symbol">search:</span></span><br><span class="line"><span class="symbol">  path:</span> search.xml</span><br><span class="line"><span class="symbol">  field:</span> post</span><br><span class="line"><span class="symbol">  format:</span> html</span><br><span class="line"><span class="symbol">  limit:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ _config.ymlï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ Next ä¸»é¢˜, æœç´¢ local_search å°† enable: false æ”¹æˆ true</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">local_search:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>é‡æ–°ç”Ÿæˆ</li>
</ol>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">hexo clean</span></span><br><span class="line"><span class="attribute">hexo g</span></span><br></pre></td></tr></table></figure>



<h2 id="æ–°å»ºèœå•ä»¥åŠæ·»åŠ èœå•å›¾æ ‡"><a href="#æ–°å»ºèœå•ä»¥åŠæ·»åŠ èœå•å›¾æ ‡" class="headerlink" title="æ–°å»ºèœå•ä»¥åŠæ·»åŠ èœå•å›¾æ ‡"></a>æ–°å»ºèœå•ä»¥åŠæ·»åŠ èœå•å›¾æ ‡</h2><p><a href="http://theme-next.iissnan.com/getting-started.html#menu-settings">nextå®˜ç½‘</a></p>
<p>åœ¨å®˜ç½‘ä¸­æŸ¥çœ‹ä¸»é¢˜è®¾å®š-&gt;èœå•é‚£éƒ¨åˆ†ï¼Œå½“æˆ‘ä»¬æ–°æ·»åŠ ä¸€ä¸ªèœå•æ˜¯(æ¯”å¦‚æˆ‘è¦æ·»åŠ é˜…è¯»)ï¼Œåœ¨<code>next</code>çš„é…ç½®æ–‡ä»¶ä¸­(<code>_config.yml</code>)é‡Œé¢æ‰¾åˆ°ä¸‹é¢çš„é…ç½®ï¼š</p>
<p>Next8.x ç‰ˆæœ¬</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-home</span></span><br><span class="line">  <span class="attr">about:</span> <span class="string">/about/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-user</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">/tags/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-tags</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">/categories/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-th</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">/archives/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-archive</span></span><br><span class="line">  <span class="comment"># schedule: /schedule/ || fa fa-calendar</span></span><br><span class="line">  <span class="attr">book:</span> <span class="string">/book/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-book</span> <span class="comment">#è¿™é‡Œæ˜¯æ–°æ·»åŠ çš„èœå•</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable/Disable menu icons.</span></span><br><span class="line"><span class="attr">menu_icons:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">book:</span> <span class="string">bookï¼ˆè¿™é‡Œæ˜¯å›¾æ ‡ï¼‰</span></span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨å¼€å¯çš„å¯¹åº”çš„è¯­è¨€æ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚æˆ‘ä½¿ç”¨çš„æ˜¯ä¸­æ–‡ï¼Œé‚£ä¹ˆå°±æ˜¯åœ¨<code>zh-CN.yml</code>æ–‡ä»¶ä¸­æ‰¾åˆ°<code>menu</code>ï¼š</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">é¦–é¡µ</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">å½’æ¡£</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">åˆ†ç±»</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">æ ‡ç­¾</span></span><br><span class="line">  <span class="attr">search:</span> <span class="string">æœç´¢</span></span><br><span class="line">  <span class="attr">book:</span> <span class="string">é˜…è¯»</span></span><br></pre></td></tr></table></figure>

<p>åé¢çš„booké‚£ä¸€æ æ˜¯åæ¥æ·»åŠ çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯åœ¨ä¸Šé¢çš„ç¬¬ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­æ‰€å†™çš„<code>book</code>æ˜¯<a href="http://fontawesome.io/">Font Awesome</a>ä¸­<code>icon</code>çš„åç§°ï¼Œè¿™æ ·æ‰å¯ä»¥åœ¨æˆ‘ä»¬è‡ªå·±çš„é¡µé¢æ˜¾ç¤ºå‡ºå›¾æ ‡ã€‚</p>
<p>åœ¨ <code>source/</code> ç›®å½•ä¸‹åˆ›å»ºç›®å½• <code>book</code>,  ç„¶ååœ¨ <code>source/book</code> ç›®å½•ä¸‹åˆ›å»º <code>index.md</code>, å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">book</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2023-11-10 21:12:59</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">book</span></span><br><span class="line"><span class="attr">comments:</span> <span class="literal">true</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<h2 id="æ·»åŠ ç¤¾äº¤åŠŸèƒ½ä¹‹é‚®ç®±"><a href="#æ·»åŠ ç¤¾äº¤åŠŸèƒ½ä¹‹é‚®ç®±" class="headerlink" title="æ·»åŠ ç¤¾äº¤åŠŸèƒ½ä¹‹é‚®ç®±"></a>æ·»åŠ ç¤¾äº¤åŠŸèƒ½ä¹‹é‚®ç®±</h2><p>åœ¨nextä¸»é¢˜é…ç½®æ–‡ä»¶æœç´¢social:</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">social:</span></span><br><span class="line">  <span class="attr">E-Mail:</span> <span class="string">mailto:1744709138@qq.com</span> <span class="string">||</span> <span class="string">envelope</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåªæ˜¯æ˜¾ç¤ºäº†é‚®ç®±ï¼Œè¿™äº›åŸæ¥éƒ½æ˜¯æ³¨é‡Šæ‰çš„ï¼Œè‡ªå·±å»æ‰å‰é¢çš„æ³¨é‡Šå³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯é‚®ç®±å‰é¢çš„<code>mailto</code>æ˜¯å¿…é¡»è¦ä¿ç•™çš„ï¼Œè¿˜æœ‰æœ€åé¢çš„<code>envelope</code>åˆ™æ˜¯å›¾æ ‡åå­—ï¼Œä¹Ÿæ˜¯ä¸èƒ½ä¿®æ”¹çš„ã€‚</p>
<h2 id="å‹æƒ…é“¾æ¥çš„é…ç½®"><a href="#å‹æƒ…é“¾æ¥çš„é…ç½®" class="headerlink" title="å‹æƒ…é“¾æ¥çš„é…ç½®"></a>å‹æƒ…é“¾æ¥çš„é…ç½®</h2><p>åœ¨<code>next</code>ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­æŸ¥æ‰¾æ ‡ç­¾<code>links</code>å¹¶è¿›è¡Œå¦‚ä¸‹é…ç½®:</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># title</span></span><br><span class="line"><span class="attr">links_title:</span> <span class="string">Links</span></span><br><span class="line"><span class="attr">links:</span></span><br><span class="line">  <span class="attr">MacTalk:</span> <span class="string">http://macshuo.com/</span></span><br><span class="line">  <span class="attr">Title:</span> <span class="string">http://example.com/</span></span><br></pre></td></tr></table></figure>

<h2 id="Next8-å¢åŠ è¯„è®ºåŠŸèƒ½ï¼ˆvalineï¼‰"><a href="#Next8-å¢åŠ è¯„è®ºåŠŸèƒ½ï¼ˆvalineï¼‰" class="headerlink" title="Next8 å¢åŠ è¯„è®ºåŠŸèƒ½ï¼ˆvalineï¼‰"></a>Next8 å¢åŠ è¯„è®ºåŠŸèƒ½ï¼ˆvalineï¼‰</h2><p>åœ¨ Next8.1.0 ä¸­ç§»é™¤äº† valine, <a href="https://github.com/next-theme/hexo-theme-next/issues/4">å‚è€ƒç½‘å€</a><br>å¦‚æœè¿˜éœ€è¦ç»§ç»­ä½¿ç”¨ï¼Œå®˜æ–¹æœ‰æä¾›æ’ä»¶ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹</p>
<ol>
<li>å®‰è£…æ’ä»¶ <code>npm install hexo-next-valine --save</code></li>
<li>ç¼–è¾‘ Next ä¸»é¢˜ _config.yml æ–‡ä»¶ï¼Œæ‰¾åˆ° <code>comments:</code> æ ‡ç­¾ï¼Œåœ¨ä¸‹é¢æ·»åŠ  valine ç›¸å…³è®¾ç½®</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">comments:</span></span><br><span class="line">  <span class="comment"># Available values: tabs | buttons</span></span><br><span class="line">  <span class="attr">style:</span> <span class="string">tabs</span></span><br><span class="line">  <span class="attr">active:</span> <span class="string">valine</span></span><br><span class="line"></span><br><span class="line"><span class="attr">valine:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">appId:</span> <span class="string">è®¾ç½®apiId</span></span><br><span class="line">  <span class="attr">appKey:</span> <span class="string">è®¾ç½®apiKey</span></span><br><span class="line">  <span class="attr">serverURLs:</span> <span class="string">https://leancloud.cn</span> <span class="comment"># When the custom domain name is enabled, fill it in here</span></span><br><span class="line">  <span class="attr">placeholder:</span> <span class="string">æœŸå¾…ä¸æ‚¨çš„äº¤æµ</span> <span class="comment"># Comment box placeholder</span></span><br><span class="line">  <span class="attr">avatar:</span> <span class="string">mm</span> <span class="comment"># Gravatar style</span></span><br><span class="line">  <span class="attr">meta:</span> [<span class="string">nick</span>, <span class="string">mail</span>, <span class="string">link</span>] <span class="comment"># Custom comment header</span></span><br><span class="line">  <span class="attr">pageSize:</span> <span class="number">10</span> <span class="comment"># Pagination size</span></span><br><span class="line">  <span class="attr">lang:</span> <span class="comment"># Language, available values: en, zh-cn</span></span><br><span class="line">  <span class="attr">visitor:</span> <span class="literal">false</span> <span class="comment"># Article reading statistic</span></span><br><span class="line">  <span class="attr">comment_count:</span> <span class="literal">true</span> <span class="comment"># If false, comment count will only be displayed in post page, not in home page</span></span><br><span class="line">  <span class="attr">recordIP:</span> <span class="literal">false</span> <span class="comment"># Whether to record the commenter IP</span></span><br><span class="line">  <span class="attr">enableQQ:</span> <span class="literal">false</span> <span class="comment"># Whether to enable the Nickname box to automatically get QQ Nickname and QQ Avatar</span></span><br><span class="line">  <span class="attr">requiredFields:</span> []</span><br></pre></td></tr></table></figure>

<h2 id="æ·»åŠ è¿‘æœŸæ–‡ç« å±•ç¤º"><a href="#æ·»åŠ è¿‘æœŸæ–‡ç« å±•ç¤º" class="headerlink" title="æ·»åŠ è¿‘æœŸæ–‡ç« å±•ç¤º"></a>æ·»åŠ è¿‘æœŸæ–‡ç« å±•ç¤º</h2><p><a href="https://blog.csdn.net/wugenqiang/article/details/88581218">æŸ¥çœ‹è½¬è½½æ–‡ç« </a></p>
<h2 id="æ˜¾ç¤ºæ–‡ç« çš„æ›´æ–°æ—¶é—´"><a href="#æ˜¾ç¤ºæ–‡ç« çš„æ›´æ–°æ—¶é—´" class="headerlink" title="æ˜¾ç¤ºæ–‡ç« çš„æ›´æ–°æ—¶é—´"></a>æ˜¾ç¤ºæ–‡ç« çš„æ›´æ–°æ—¶é—´</h2><p>åœ¨ä¸»é¢˜çš„é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°<code>updated_at</code>ï¼Œç„¶åå°†å…¶å€¼ä¿®æ”¹ä¸º<code>true</code>å³å¯(è¿™ç§æ–¹å¼åº”è¯¥æ˜¯é€‚ç”¨äº5ä»¥åçš„ç‰ˆæœ¬)</p>
<p>å¯¹äºä»¥å‰çš„æ–¹å¼å¯ä»¥çœ‹è¿™ç¯‡<a href="https://blog.csdn.net/ganzhilin520/article/details/79053399">åˆ«äººå†™çš„æ–‡ç« </a></p>
<h2 id="å­—æ•°ç»Ÿè®¡ä¸é˜…è¯»æ—¶é•¿"><a href="#å­—æ•°ç»Ÿè®¡ä¸é˜…è¯»æ—¶é•¿" class="headerlink" title="å­—æ•°ç»Ÿè®¡ä¸é˜…è¯»æ—¶é•¿"></a>å­—æ•°ç»Ÿè®¡ä¸é˜…è¯»æ—¶é•¿</h2><p><a href="https://www.cnblogs.com/php-linux/p/8418518.html">æŸ¥çœ‹è½¬è½½æ–‡ç« </a></p>
<h2 id="æ·»åŠ ç‰ˆæƒä¿¡æ¯"><a href="#æ·»åŠ ç‰ˆæƒä¿¡æ¯" class="headerlink" title="æ·»åŠ ç‰ˆæƒä¿¡æ¯"></a>æ·»åŠ ç‰ˆæƒä¿¡æ¯</h2><p>åœ¨ç«™ç‚¹é…ç½®æ–‡ä»¶æœç´¢<code>post_copyright</code>ï¼Œå°†<code>enable</code>ä¿®æ”¹ä¸º<code>true</code>ï¼Œæ·»åŠ <code>author</code>å³å¯ã€‚<br><a href="https://zhuanlan.zhihu.com/p/463548944#:~:text=%E4%BA%8C%E3%80%81hexo%E5%8D%9A%E5%AE%A2%E6%96%B0%E5%A2%9E%E5%BA%95%E9%83%A8%E7%89%88%E6%9D%83%E4%BF%A1%E6%81%AF%202.1%20%E5%BC%80%E5%90%AF%E6%96%87%E7%AB%A0%E5%BA%95%E9%83%A8%E7%89%88%E6%9D%83%E4%BF%A1%E6%81%AF%E9%85%8D%E7%BD%AE%20%E7%BC%96%E8%BE%91%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6themes%2Fnext%2F_config.yml%EF%BC%8C%E5%B0%86creative_commons%E4%B8%8B%E9%9D%A2%E7%9A%84post%E5%80%BC%E7%94%B1false%E6%94%B9%E4%B8%BAtrue%E3%80%82%20creative_commons%3A%20license%3A%20by-nc-sa,sidebar%3A%20false%20post%3A%20true%20language%3A%202.2%20%E6%9B%B4%E6%96%B0%E7%89%88%E6%9D%83%E8%AF%B4%E6%98%8E%20%E7%BC%96%E8%BE%91%E6%96%87%E4%BB%B6themes%2Fnext%2Flayout%2F_partials%2Fpost%2Fpost-copyright.swig%EF%BC%8C%E6%9B%B4%E6%96%B0%E7%89%88%E6%9D%83%E8%AF%B4%E6%98%8E%E6%96%87%E5%AD%97%EF%BC%8C%E4%BF%9D%E5%AD%98%E3%80%82">å‚è€ƒæ–‡ç« </a></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">post_copyright:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">license:</span> <span class="string">CC</span> <span class="string">BY-NC-SA</span> <span class="number">3.0</span></span><br><span class="line">  <span class="attr">license_url:</span> <span class="string">https://creativecommons.org/licenses/by-nc-sa/3.0/</span></span><br><span class="line">  <span class="attr">author:</span> <span class="string">å’–å•¡æ¯é‡Œçš„èŒ¶</span></span><br></pre></td></tr></table></figure>

<h2 id="ä¿®æ”¹æ–‡ç« åº•éƒ¨çš„æ ‡ç­¾"><a href="#ä¿®æ”¹æ–‡ç« åº•éƒ¨çš„æ ‡ç­¾" class="headerlink" title="ä¿®æ”¹æ–‡ç« åº•éƒ¨çš„æ ‡ç­¾"></a>ä¿®æ”¹æ–‡ç« åº•éƒ¨çš„æ ‡ç­¾</h2><p>åŸºäº Next7 ä¿®æ”¹<br>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>_config.yml</code> ä¸­å°†ä¸‹é¢é…ç½®è®¾ç½®ä¸º true å³å¯ï¼ˆè¯¥é…ç½®é»˜è®¤å€¼ä¸ºfalseï¼‰</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tag_icon:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="æ˜¾ç¤ºå›¾ç‰‡"><a href="#æ˜¾ç¤ºå›¾ç‰‡" class="headerlink" title="æ˜¾ç¤ºå›¾ç‰‡"></a>æ˜¾ç¤ºå›¾ç‰‡</h2><p><a href="https://www.jianshu.com/p/ea78bdd0551f">æ˜¾ç¤ºå›¾ç‰‡</a></p>
<h2 id="æ·»åŠ æœç´¢åŠŸèƒ½-1"><a href="#æ·»åŠ æœç´¢åŠŸèƒ½-1" class="headerlink" title="æ·»åŠ æœç´¢åŠŸèƒ½"></a>æ·»åŠ æœç´¢åŠŸèƒ½</h2><p><a href="https://blog.csdn.net/qq_40265501/article/details/80030627">æ·»åŠ æœç´¢</a></p>
<h2 id="æ·»åŠ æ‰“èµåŠŸèƒ½"><a href="#æ·»åŠ æ‰“èµåŠŸèƒ½" class="headerlink" title="æ·»åŠ æ‰“èµåŠŸèƒ½"></a>æ·»åŠ æ‰“èµåŠŸèƒ½</h2><p>åœ¨<code>next</code>ä¸»é¢˜çš„é…ç½®æ–‡ä»¶æ–‡ä»¶ä¸­åŠ ä¸Šä¸‹é¢çš„ä»£ç </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">reward_comment: åšæŒåŸåˆ›æŠ€æœ¯åˆ†äº«ï¼Œæ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œï¼</span><br><span class="line">wechatpay: /images/å¾®ä¿¡æ”¯ä»˜.jpg</span><br><span class="line">alipay: /images/æ”¯ä»˜å®æ”¯ä»˜.jpg</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>wechatpay</code>å’Œ<code>alipay</code>å¯¹åº”çš„æ˜¯å¾®ä¿¡æ”¯ä»˜æ”¶æ¬¾ç å’Œæ”¯ä»˜å®æ”¯ä»˜æ”¶æ¬¾ç çš„å›¾ç‰‡åœ°å€ï¼Œæˆ‘è¿™é‡Œæ˜¯å­˜æ”¾åœ¨ <code>ä¸»é¢˜\source\images\</code>ä¸‹é¢</p>
<h2 id="ç”Ÿæˆæ°¸ä¹…é“¾æ¥"><a href="#ç”Ÿæˆæ°¸ä¹…é“¾æ¥" class="headerlink" title="ç”Ÿæˆæ°¸ä¹…é“¾æ¥"></a>ç”Ÿæˆæ°¸ä¹…é“¾æ¥</h2><p><a href="https://zhuanlan.zhihu.com/p/134492757">Hexo ç”Ÿæˆæ°¸ä¹…æ–‡ç« é“¾æ¥ - çŸ¥ä¹ (zhihu.com)</a><br>å¯¹äºHeox7 ç‰ˆæœ¬å¯ä»¥æœ‰æ›´ç®€å•çš„æ–¹å¼ï¼Œç›´æ¥ä½¿ç”¨ hash å³å¯</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#permalink: :year/:month/:day/:title/</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">:hash/</span></span><br></pre></td></tr></table></figure>

<h2 id="æ–‡ç« æ”¶å½•"><a href="#æ–‡ç« æ”¶å½•" class="headerlink" title="æ–‡ç« æ”¶å½•"></a>æ–‡ç« æ”¶å½•</h2><p><a href="https://zhuanlan.zhihu.com/p/651590960">å…³äºHexoåšå®¢æ”¶å½•ä¸SEOé‚£äº›äº‹ - çŸ¥ä¹ (zhihu.com)</a><br>æ–‡ç« ä¸­éªŒè¯ç½‘ç«™çš„æ­¥éª¤ä¸­ä½¿ç”¨çš„æ˜¯ä¸‹è½½ html éªŒè¯æ–‡ä»¶ï¼Œæœ‰å¯èƒ½è¿™ç§æ–¹å¼éªŒè¯ä¸æˆåŠŸï¼Œå¯ä»¥é€‰æ‹©ç¬¬äºŒç§æ–¹å¼ï¼Œåœ¨ç½‘ç«™é¦–é¡µæ·»åŠ  meta æ ‡ç­¾ä¸­çš„å†…å®¹ï¼Œå°† meta ä¸­çš„å†…å®¹å¤åˆ¶åˆ°<br><code>themes\nextlayout\_partials\head\head.njk</code> æ–‡ä»¶ä¸­</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- è¿™é‡Œæ·»åŠ çš„æ˜¯ç™¾åº¦çš„éªŒè¯å¤´æ–‡ä»¶ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;baidu-site-verification&quot;</span> <span class="attr">content</span>=<span class="string">&quot;xxxx&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- è¿™é‡Œæ·»åŠ çš„æ˜¯bingéªŒè¯çš„å¤´æ–‡ä»¶ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;msvalidate.01&quot;</span> <span class="attr">content</span>=<span class="string">&quot;xxxx&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="å‡çº§-Hexo"><a href="#å‡çº§-Hexo" class="headerlink" title="å‡çº§ Hexo"></a>å‡çº§ Hexo</h2><p><a href="https://guoguocai.github.io/2022/06/05/%E5%A6%82%E4%BD%95%E5%8D%87%E7%BA%A7-Hexo-%E7%89%88%E6%9C%AC/">å‡çº§hexo</a></p>
<h2 id="Next7-å¤šçº§ç›®å½•æŠ˜å "><a href="#Next7-å¤šçº§ç›®å½•æŠ˜å " class="headerlink" title="Next7 å¤šçº§ç›®å½•æŠ˜å "></a>Next7 å¤šçº§ç›®å½•æŠ˜å </h2><p><a href="https://alex-mcavoy.github.io/hexo/41b257b8.html">å¤šçº§ç›®å½•æŠ˜å </a><br>æŒ‰ç…§ä¸Šé¢å‚è€ƒçš„æ–‡æ¡£å¼€å¯ Jquery, é¡µé¢ä¾ç„¶æŠ¥é”™ <code>$ ç¬¦å·æœªå®šä¹‰</code>, æ­¤æ—¶å¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹å¼ä¿®æ”¹,åœ¨è¿›å…¥ category.js ä¹‹å‰å…ˆå¼•å…¥ä¸€æ¬¡ Jquery</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- å¤šçº§ç›®å½• --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/category.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Hexo-Nextä¸»é¢˜æ”¯æŒ-mermaid"><a href="#Hexo-Nextä¸»é¢˜æ”¯æŒ-mermaid" class="headerlink" title="Hexo Nextä¸»é¢˜æ”¯æŒ mermaid"></a>Hexo Nextä¸»é¢˜æ”¯æŒ mermaid</h2><ol>
<li>è¿›å…¥åšå®¢æ ¹ç›®å½•ï¼Œæ‰§è¡Œå®‰è£…æ’ä»¶å‘½ä»¤ <code>npm install hexo-filter-mermaid-diagrams --save</code></li>
<li>æ‰“å¼€ Next ä¸»é¢˜ä¸‹çš„ _config.yml æ–‡ä»¶ï¼Œå°† mermaid çš„é…ç½®æ”¹æˆ true</li>
</ol>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mermaid:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>åœ¨ç«™ç‚¹é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹å¦‚ä¸‹(å»é™¤å›¾å½¢çš„é«˜äº®)</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">highlight:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># å¢åŠ ä¸‹é¢çš„å†…å®¹</span></span><br><span class="line">  <span class="attr">exclude_languages:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mermaid</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>é‡æ–°ç”Ÿæˆéƒ¨ç½²å³å¯</li>
</ol>
<h2 id="å¢åŠ å›¾ç‰‡èƒŒæ™¯å’Œé€æ˜åº¦"><a href="#å¢åŠ å›¾ç‰‡èƒŒæ™¯å’Œé€æ˜åº¦" class="headerlink" title="å¢åŠ å›¾ç‰‡èƒŒæ™¯å’Œé€æ˜åº¦"></a>å¢åŠ å›¾ç‰‡èƒŒæ™¯å’Œé€æ˜åº¦</h2><ol>
<li>å°†èƒŒæ™¯å›¾ç‰‡æ”¾åœ¨ä¸»é¢˜ç›®å½•ä¸‹ <code>themes/next/source/images/</code> ä¸‹é¢</li>
<li>ä¿®æ”¹ Next ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>_config.yml</code>, å°†ä¸‹é¢çš„æ³¨é‡Šæ‰“å¼€</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">custom_file_path:</span></span><br><span class="line">  <span class="comment">#head: source/_data/head.swig</span></span><br><span class="line">  <span class="comment">#header: source/_data/header.swig</span></span><br><span class="line">  <span class="comment">#sidebar: source/_data/sidebar.swig</span></span><br><span class="line">  <span class="comment">#postMeta: source/_data/post-meta.swig</span></span><br><span class="line">  <span class="comment">#postBodyEnd: source/_data/post-body-end.swig</span></span><br><span class="line">  <span class="comment">#footer: source/_data/footer.swig</span></span><br><span class="line">  <span class="comment">#bodyEnd: source/_data/body-end.swig</span></span><br><span class="line">  <span class="comment">#variable: source/_data/variables.styl</span></span><br><span class="line">  <span class="comment">#mixin: source/_data/mixins.styl</span></span><br><span class="line">  <span class="attr">style:</span> <span class="string">source/_data/styles.styl</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>åœ¨åšå®¢æ ¹ç›®å½•ä¸‹çš„ <code>source/</code> ä¸‹é¢åˆ›å»º <code>_data/styles.styl</code> æ–‡ä»¶ï¼ˆé»˜è®¤åœ¨ source ç›®å½•ä¸‹æ²¡æœ‰ _data ç›®å½•ï¼Œè‹¥æ²¡æœ‰ä¹Ÿéœ€è¦åˆ›å»ºï¼‰</li>
<li>åœ¨ä¸Šé¢åˆ›å»ºçš„ <code>styles.styl</code> æ–‡ä»¶ä¸­å¢åŠ å¦‚ä¸‹å†…å®¹</li>
</ol>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å›¾ç‰‡èƒŒæ™¯ start------------</span></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>:url(<span class="string">/images/background.jpg</span>);		<span class="comment">//å›¾ç‰‡è·¯å¾„ï¼Œé»˜è®¤</span></span><br><span class="line">    <span class="attribute">background-repeat</span>: no-repeat;			<span class="comment">//å›¾ç‰‡æ— æ³•é“ºæ»¡æ—¶ï¼Œæ˜¯å¦é‡å¤åŠé‡å¤æ–¹å¼</span></span><br><span class="line">    <span class="attribute">background-attachment</span>:fixed;		<span class="comment">//å›¾ç‰‡æ˜¯å¦è·Ÿéšæ»šåŠ¨</span></span><br><span class="line">    <span class="attribute">background-size</span>:cover;				<span class="comment">//è¦†ç›–</span></span><br><span class="line">    <span class="attribute">background-position</span>:center;		<span class="comment">//å›¾ç‰‡æ˜¾ç¤ºèµ·å§‹ä½ç½®</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å›¾ç‰‡èƒŒæ™¯ end------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// é€æ˜åº¦start----------------------------</span></span><br><span class="line"><span class="comment">// æ–‡ç« å†…å®¹é€æ˜åº¦è®¾ç½®</span></span><br><span class="line"><span class="comment">// 7 ç‰ˆæœ¬æœ‰æ•ˆ</span></span><br><span class="line"><span class="selector-class">.content-wrap</span> &#123;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0.9</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8ç‰ˆæœ¬æœ‰æ•ˆ</span></span><br><span class="line"><span class="selector-class">.main-inner</span> &#123;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0.9</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.header-inner</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.9</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¾§è¾¹æ¡†çš„é€æ˜åº¦è®¾ç½®</span></span><br><span class="line"><span class="selector-class">.sidebar</span> &#123;</span><br><span class="line">  <span class="attribute">opacity</span>: <span class="number">0.9</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœç´¢æ¡†çš„é€æ˜åº¦</span></span><br><span class="line"><span class="selector-class">.popup</span> &#123;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0.9</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é€æ˜åº¦end----------------------------</span></span><br></pre></td></tr></table></figure>

<h2 id="é™æ€èµ„æºå‹ç¼©"><a href="#é™æ€èµ„æºå‹ç¼©" class="headerlink" title="é™æ€èµ„æºå‹ç¼©"></a>é™æ€èµ„æºå‹ç¼©</h2><p><a href="https://github.com/rozbo/hexo-neat">å‚è€ƒgithub hexo-neat æ’ä»¶</a></p>
<ol>
<li>å®‰è£…æ’ä»¶</li>
</ol>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">npm install hexo-neat <span class="comment">--save</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åœ¨ hexo é…ç½®æ–‡ä»¶ <code>_config.yml</code> ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é™æ€æ–‡ä»¶å‹ç¼© start-----------------</span></span><br><span class="line"><span class="attr">neat_enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">neat_html:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">exclude:</span></span><br><span class="line"><span class="attr">neat_css:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">exclude:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*.min.css&#x27;</span></span><br><span class="line"><span class="attr">neat_js:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">mangle:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">output:</span></span><br><span class="line">  <span class="attr">compress:</span></span><br><span class="line">  <span class="attr">exclude:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*.min.js&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;**/*.min.js&#x27;</span></span><br><span class="line"><span class="comment"># é™æ€æ–‡ä»¶å‹ç¼© end-----------------</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>é‡æ–°ç”Ÿæˆæ¨é€å³å¯</li>
</ol>
<h2 id="å¼•ç”¨è‡ªå·±çš„æ–‡ç« "><a href="#å¼•ç”¨è‡ªå·±çš„æ–‡ç« " class="headerlink" title="å¼•ç”¨è‡ªå·±çš„æ–‡ç« "></a>å¼•ç”¨è‡ªå·±çš„æ–‡ç« </h2><p><code>&#123;% post_path filename %&#125;</code><br>filename å°±æ˜¯å¼•ç”¨æ–‡ç« çš„åç§°</p>
<h2 id="é˜»æ­¢ç‚¹å‡»moreæ—¶è·³è½¬åˆ°moreä½ç½®"><a href="#é˜»æ­¢ç‚¹å‡»moreæ—¶è·³è½¬åˆ°moreä½ç½®" class="headerlink" title="é˜»æ­¢ç‚¹å‡»moreæ—¶è·³è½¬åˆ°moreä½ç½®"></a>é˜»æ­¢ç‚¹å‡»moreæ—¶è·³è½¬åˆ°moreä½ç½®</h2><ol>
<li>å¦‚æœç»™æ–‡ç« æ·»åŠ äº† <code>&lt;!--more--&gt;</code> ç‚¹å‡»é˜…è¯»æ›´å¤šæ—¶ä¼šè·³è½¬åˆ° <code>more</code> é”šç‚¹ä½ç½®ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢æ–¹å¼ä¿®æ”¹</li>
<li>æ‰¾åˆ° <code>themes\next-8.18.2\layout\_macro\post.njk</code> æ–‡ä»¶ï¼Œ æœç´¢ <code>elif post.excerpt</code>ï¼Œç›¸å…³éƒ¨åˆ†åŸæ¥çš„ä»£ç å¦‚ä¸‹</li>
</ol>
<figure class="highlight handlebars"><table><tr><td class="code"><pre><span class="line"><span class="language-xml">&#123;% elif post.excerpt %&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">post.excerpt</span> &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!--noindex--&gt;</span></span></span><br><span class="line"><span class="language-xml">  &#123;%- if theme.read_more_btn %&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;post-button&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; <span class="name">url_for</span>(<span class="name">post.path</span>) &#125;&#125;</span><span class="template-variable">&#123;&#123;<span class="name">suffix</span>&#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;contents&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        </span><span class="template-variable">&#123;&#123; <span class="name">__</span>(<span class="name">&#x27;post.read_more&#x27;</span>) &#125;&#125;</span><span class="language-xml"> <span class="symbol">&amp;raquo;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  &#123;%- endif %&#125;</span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!--/noindex--&gt;</span></span></span><br><span class="line"><span class="language-xml">&#123;% else %&#125;</span></span><br></pre></td></tr></table></figure>
<p>æ·»åŠ éƒ¨åˆ†å†…å®¹åå˜æˆå¦‚ä¸‹å†…å®¹</p>
<figure class="highlight django"><table><tr><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">elif</span></span> post.excerpt %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; post.excerpt &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!--noindex--&gt;</span></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> theme.read_more_btn %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- æ­¤å¤„æ˜¯æ·»åŠ çš„å†…å®¹ --&gt;</span></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;%- <span class="name">set</span> suffix = &quot;&quot;%&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> theme.read_more_anchor %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-tag">&#123;%- <span class="name">set</span> suffix = &quot;#more&quot;%&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- æ·»åŠ ç»“æŸ --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;post-button&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="comment">&lt;!-- è¿™é‡Œæœ‰ä¿®æ”¹ï¼Œå°† #more æ”¹æˆäº† </span></span><span class="template-variable">&#123;&#123;suffix&#125;&#125;</span><span class="language-xml"><span class="comment"> --&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; url_for(post.path) &#125;&#125;</span><span class="template-variable">&#123;&#123;suffix&#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;contents&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        </span><span class="template-variable">&#123;&#123; __(&#x27;post.read_more&#x27;) &#125;&#125;</span><span class="language-xml"> <span class="symbol">&amp;raquo;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!--/noindex--&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>åœ¨ next çš„ <code>_config.yml</code> æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹å³å¯ï¼Œé…ç½®ä¸ºtrueæ—¶ä¾ç„¶è·³è½¬åˆ°more</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">read_more_anchor:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>hexoçš„butterflyä¸»é¢˜æ›´æ¢walineç³»ç»Ÿcdnåœ°å€</title>
    <url>/2023/0fd7aa9951f7/index.html</url>
    <content><![CDATA[<ol>
<li><p>butterflyä¸»é¢˜é»˜è®¤ä½¿ç”¨ cdn.jsdelivr.netï¼Œåœ¨å›½å†…ä½¿ç”¨å¾ˆæ…¢ï¼Œæœ‰æ—¶å€™åŠ è½½ä¸å‡ºæ¥ï¼Œå¯ä»¥æ›¿æ¢æˆå›½å†…æºï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸¤ä¸ª</p>
<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//www.staticfile.org/</span></span><br><span class="line"><span class="symbol">https:</span><span class="comment">//cdn.onmicrosoft.cn/</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€ä¸ªï¼Œæ‰“å¼€ <code>http://www.staticfile.org/</code> åï¼Œä¼šå‡ºç°æœç´¢æ¡†ï¼Œæœç´¢ <code>waline</code>ï¼Œ ç„¶åé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬å°±å¥½äº†ï¼Œå¦‚æœä¸çŸ¥é“è‡ªå·±çš„ç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨åˆ‡æ¢å‰å…ˆæ‰“å¼€è‡ªå·±çš„ <code>wailne</code> ç³»ç»Ÿï¼Œåœ¨è¯„è®ºæ¡†ä¸‹é¢ä¼šæ˜¾ç¤ºç‰ˆæœ¬</p>
</li>
<li><p>æ‰¾åˆ°å¯¹åº”çš„ç‰ˆæœ¬åå¤åˆ¶å‡ºå¯¹åº”çš„ <code>css</code> å’Œ <code>js</code> åœ°å€ï¼Œæ·»åŠ åˆ° <code>_config.butterfly.yml</code> æ–‡ä»¶ä¸­,æ¯”å¦‚æˆ‘ä½¿ç”¨çš„æ˜¯3.0ç‰ˆæœ¬ï¼Œåˆ™æ‰“å¼€ <code>wailne_css</code> å’Œ <code>waline_js</code> æ³¨é‡Šå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹</p>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">CDN:</span></span><br><span class="line">  <span class="attr">option:</span></span><br><span class="line">    <span class="attr">waline_css:</span> <span class="string">https://cdn.staticfile.org/waline/3.0.0-alpha.2/waline.min.css</span></span><br><span class="line">    <span class="attr">waline_js:</span> <span class="string">https://cdn.staticfile.org/waline/3.0.0-alpha.2/waline.min.js</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>æ¯”è¾ƒ</title>
    <url>/2023/2084759b2332/index.html</url>
    <content><![CDATA[<blockquote>
<p>äººæ„Ÿåˆ°ä¸å¹¸ç¦å¤§å¤šæ¥æºäºæ¯”è¾ƒï¼Œæ„Ÿåˆ°æ»¡è¶³ä¹Ÿæºäºæ¯”è¾ƒ</p>
</blockquote>
<span id="more"></span>
<p>åœ¨å¾®ä¿¡è¯»ä¹¦çœ‹åˆ°ä¸€ä½ä¹¦å‹å†™åˆ°ï¼Œä½œä¸ºå†œæ‘å‡ºæ¥çš„å­©å­ï¼Œåº”è¯¥å¦‚ä½•æ”¹å˜è‡ªå·±çš„å‘½è¿ï¼Œå› ä¸ºå‘¨å›´çš„ä¸€åˆ‡åœ¨å‘Šè¯‰æˆ‘ä»¬ï¼Œå°±ç®—ä½ åŠªåŠ›äº†äºŒåå‡ å¹´ï¼Œæ‰å‹‰å¼ºè¾¾åˆ°äº†åˆ«äººçš„èµ·è·‘çº¿ï¼Œä½†æ˜¯æˆ‘ä»¬çš„å‡ºèº«æ˜¯è‡ªå·±æ— æ³•å†³å®šçš„ï¼Œé‚£æˆ‘ä»¬åº”è¯¥å¦‚ä½•æ›´è¿›ä¸€æ­¥å‘¢ï¼Ÿ</p>
<p>çœ‹åˆ°å¦å¤–ä¸€ä½ä¹¦å‹çš„å›ç­”å¾ˆæœ‰æ„Ÿè§¦ï¼Œä¸”è®°å½•åœ¨æ­¤ï¼Œå’Œæœ‰ç¼˜äººå…±å‹‰</p>
<blockquote>
<p>å›å¤´çœ‹ï¼Œè½»èˆŸå·²è¿‡ä¸‡é‡å±±<br>å‘å‰çœ‹ï¼Œé•¿è·¯æ¼«æ¼«äº¦ç¿ç¿<br>å¹³å¸¸çœ‹ï¼Œäººé—´çƒŸç«ç”šç¿çƒ‚<br>ä½å¤´çœ‹ï¼Œä¸‡é‡Œé»„å±±çš†è„šä¸‹  </p>
</blockquote>
]]></content>
      <categories>
        <category>record</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>å®è´µçš„äººç”Ÿå»ºè®®</title>
    <url>/2023/5792ca8e5e27/index.html</url>
    <content><![CDATA[<ul>
<li>ä¹¦åï¼šã€Šå®è´µçš„äººç”Ÿå»ºè®®ã€‹</li>
<li>ä½œè€…ï¼šå‡¯æ–‡å‡¯åˆ©</li>
</ul>
<p>çœ‹è¿‡äº†ï¼Œè§‰å¾—æœ‰é“ç†ï¼Œæƒ³è¦æ”¹å˜éƒ½ä¸ä»£è¡¨ä½ çœŸçš„è®¤åŒå¹¶ç†è§£ï¼Œâ€åšå‡ºæ¥â€å°±æ˜¯å¯¹â€è®¤åŒâ€æœ€å¥½çš„å›å¤</p>
<span id="more"></span>

<blockquote>
<p>æŠŠâ€åˆ›é€ â€å’Œâ€æ”¹è¿›â€è¿™ä¸¤ä¸ªè¿‡ç¨‹åˆ†å¼€ï¼Œä½ ä¸èƒ½è¾¹å†™ä½œè¾¹ç¼–è¾‘ï¼Œè¾¹é›•åˆ»è¾¹æ‰“ç£¨ï¼Œè¾¹åˆ¶ä½œè¾¹åˆ†æã€‚å¦‚æœä½ è¿™ä¹ˆåšï¼Œç¼–è¾‘å°±ä¼šé˜»éåˆ›é€ ï¼Œå‘æ˜æ—¶ï¼Œä¸è¦é€‰æ‹©ã€‚ç”»è‰å›¾æ—¶ï¼Œä¸è¦æ£€æŸ¥ã€‚å†™åˆç¨¿æ—¶ï¼Œä¸è¦åæ€ã€‚ä¸€å¼€å§‹ï¼Œåˆ›é€ æ€§æ€ç»´å¿…é¡»æ˜¯è‡ªç”±çš„ï¼Œä¸å—æ‰¹åˆ¤çš„å¹²æ‰°ã€‚</p>
</blockquote>
<p>æ— è®ºæ˜¯æŠ€æœ¯ç±»æ–‡ç« è¿˜æ˜¯å…¶ä»–ç±»å‹çš„è®°å½•ï¼Œé‡ç‚¹æ˜¯å†™ï¼Œè€Œä¸æ˜¯å…ˆå­¦ä¹ å„ç§å„æ ·çš„å¥—è·¯(å¥—è·¯ä¹Ÿå¾ˆé‡è¦ï¼Œä½†å†…å®¹æ˜¯å‰æ)ï¼Œåç»­åœ¨å†™å†…å®¹ä¹‹å‰ä¸è¦è¿½æ±‚å®Œç¾ï¼Œå…ˆå†™å‡ºæ¥æ‰ä¼šæœ‰åç»­çš„æ•…äº‹</p>
<blockquote>
<p>å…»æˆä¹ æƒ¯çš„å¥½å¤„æ˜¯ï¼Œåœ¨è¡ŒåŠ¨æ—¶ï¼Œä¸å¿…å†è¿›è¡Œå†…å¿ƒçš„æƒè¡¡ã€‚ä¸å†æ¶ˆè€—èƒ½é‡å»æ€è€ƒæ˜¯å¦è¦åšè¿™ä»¶äº‹ã€‚ä½ åªç®¡å»åšã€‚å¥½ä¹ æƒ¯å¾ˆå¤šï¼Œä»è¯´çœŸè¯åˆ°ä½¿ç”¨ç‰™çº¿ã€‚</p>
</blockquote>
<p>ä¸è¦ä½¿ç”¨æ„å¿—åŠ›å»åšæŒåšä¸€ä»¶äº‹ï¼Œæ…¢æ…¢å…»æˆä¹ æƒ¯ï¼Œè®©åšæŸä»¶äº‹æˆä¸ºèº«ä½“çš„æœ¬èƒ½</p>
<blockquote>
<p>ææƒ§æ˜¯å› ä¸ºç¼ºä¹æƒ³è±¡åŠ›ã€‚ææƒ§çš„è§£è¯ä¸æ˜¯å‹‡æ•¢ï¼Œè€Œæ›´å¯èƒ½æ˜¯æƒ³è±¡åŠ›</p>
</blockquote>
<ul>
<li>ææƒ§æ˜¯å› ä¸ºç»å†çš„å¤ªå°‘ï¼ŒçŸ¥é“çš„å¤ªå°‘ï¼Œæ‡‚å¾—çš„å¤ªå°‘</li>
</ul>
<blockquote>
<p>ä½ å¹¶ä¸éœ€è¦æ›´å¤šæ—¶é—´ï¼Œå› ä¸ºä½ å·²ç»æ‹¥æœ‰äº†ä½ çš„æ‰€æœ‰æ—¶é—´</p>
</blockquote>
<blockquote>
<p>ä½ æœ€è¿‘ä¸€æ¬¡æ”¹å˜æ˜¯åœ¨ä»€ä¹ˆå¹´çºªï¼Œä½ å°±æ˜¯å¤šå°‘å²</p>
</blockquote>
<blockquote>
<p>ä¸è¦ç®¡åˆ«äººæ€ä¹ˆçœ‹å¾…ä½ ï¼Œå› ä¸ºä»–ä»¬æ ¹æœ¬æ²¡çœ‹ä½ </p>
</blockquote>
<blockquote>
<p>ä»»ä½•æœ‰ä»·å€¼çš„äº‹éƒ½éœ€è¦æ— å°½çš„å·¥ä½œã€‚ä½ æ— æ³•ç»™å·¥ä½œè®¾å®šä¸Šé™ï¼Œæ‰€ä»¥ä½ å¿…é¡»ç»™å·¥ä½œæ—¶é—´è®¾é™ã€‚ä½ å”¯ä¸€èƒ½ç®¡ç†çš„æ˜¯æ—¶é—´ï¼Œè€Œä¸æ˜¯å·¥ä½œ</p>
</blockquote>
<blockquote>
<p>å¦‚æœä½ æƒ³è¶…è¶Šä½ å¿ƒç›®ä¸­çš„è‹±é›„ï¼Œé‚£å°±æ”¾ä¸‹è‡ªå°Šå¿ƒï¼Œåƒå­¦ç”Ÿä¸€æ ·æ¨¡ä»¿ä»–ä»¬ï¼Œç›´åˆ°ä½ èƒ½è¶…è¶Šä»–ä»¬ã€‚è¿™æ˜¯æ‰€æœ‰å¤§å¸ˆçš„æˆåŠŸä¹‹é“</p>
</blockquote>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>book</tag>
      </tags>
  </entry>
  <entry>
    <title>å¾®ä¿¡è¯»ä¹¦é˜…è¯»æŒ‘æˆ˜</title>
    <url>/2023/c4c074b722a1/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p>å‚ä¸å¾®ä¿¡é˜…è¯»æŒ‘æˆ˜</p>
<ol>
<li>365 å¤©ä¸é—´æ–­</li>
<li>æœŸé—´æœ€å°‘é˜…è¯» 300 å°æ—¶</li>
<li>æ¯æœˆæ›´æ–°è¿›åº¦</li>
</ol>
<pre class="mermaid">pie title æ€»å¤©æ•°(365)
    "å·²è¯»" : 4
    "æœªè¯»" : 361</pre>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>book</tag>
      </tags>
  </entry>
  <entry>
    <title>HashMapè¯¦è§£</title>
    <url>/2023/834224a16039/index.html</url>
    <content><![CDATA[<h2 id="HashMapçš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#HashMapçš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="HashMapçš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ"></a>HashMapçš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ</h2><ol>
<li>ä¹‹å‰ <code>Jdk1.7</code> çš„å­˜å‚¨ç»“æ„æ˜¯æ•°ç»„+é“¾è¡¨ï¼Œåˆ°äº† <code>Jdk1.8</code> å˜æˆäº†æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ã€‚</li>
</ol>
<h2 id="HashMap-æ˜¯å¦‚ä½•å®šä½ç´¢å¼•ä¸‹æ ‡çš„"><a href="#HashMap-æ˜¯å¦‚ä½•å®šä½ç´¢å¼•ä¸‹æ ‡çš„" class="headerlink" title="HashMap æ˜¯å¦‚ä½•å®šä½ç´¢å¼•ä¸‹æ ‡çš„"></a>HashMap æ˜¯å¦‚ä½•å®šä½ç´¢å¼•ä¸‹æ ‡çš„</h2><p>å®šä½ <code>index</code> åˆ†æˆä¸¤æ­¥</p>
<ol>
<li><p>æ ¹æ® hash å‡½æ•°è·å– hash å€¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å¯ä»¥çœ‹åˆ°ä¸Šé¢ä»£ç è·å–åˆ° hashCode ä¹‹åè¿˜å³ç§» 16 ä½ï¼Œå…·ä½“åŸå› åœ¨ä¸‹é¢åˆ†æ</strong></p>
</li>
<li><p>æ ¹æ®ç¬¬ä¸€æ­¥è®¡ç®—çš„ <code>hash</code> å€¼è·å–æ•°ç»„ä½ç½®ï¼ˆä¸€èˆ¬æ˜¯å¯¹æ•°ç»„é•¿åº¦å–æ¨¡ï¼Œ<code>HashMap</code> ä¸­æ˜¯å¯¹é•¿åº¦ -1 è¿›è¡Œ <code>&amp;</code> è¿ç®—ï¼‰</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">boolean</span> onlyIfAbsent,</span></span><br><span class="line"><span class="params">                   <span class="type">boolean</span> evict)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="type">int</span> n, i;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">        <span class="comment">// è·å–ä¸‹æ ‡çš„æ“ä½œæ˜¯  i = (n-1) &amp; hash</span></span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="literal">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è·å–ä¸‹æ ‡ä¸ºä»€ä¹ˆæ˜¯å¯¹ n-1 è¿›è¡Œä¸æ“ä½œè€Œä¸æ˜¯å–æ¨¡ï¼Ÿå…·ä½“åŸå› ä¸‹é¢åˆ†æ</strong></p>
<h2 id="ä¸ºä»€ä¹ˆéœ€è¦å¯¹keyçš„-hash-å€¼å³ç§»-16ä½"><a href="#ä¸ºä»€ä¹ˆéœ€è¦å¯¹keyçš„-hash-å€¼å³ç§»-16ä½" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦å¯¹keyçš„ hash å€¼å³ç§» 16ä½"></a>ä¸ºä»€ä¹ˆéœ€è¦å¯¹keyçš„ hash å€¼å³ç§» 16ä½</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">HashMap</span> <span class="string">ä¸­ä½¿ç”¨çš„</span> <span class="string">hash</span> <span class="string">å‡½æ•°æ˜¯</span> <span class="string">key.hash</span> <span class="string">^</span> <span class="string">(key.hash</span> <span class="string">&gt;&gt;</span> <span class="number">16</span><span class="string">)</span>  <span class="string">è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨</span> <span class="string">key.hash,</span> <span class="string">è¿™ä¹ˆåšçš„åŸå› æ˜¯å¢åŠ äº†æ‰°åŠ¨è®¡ç®—ï¼Œä½¿å¾—</span> <span class="string">hash</span> <span class="string">åˆ†å¸ƒçš„å°½å¯èƒ½çš„å‡åŒ€ï¼Œ</span> <span class="string">è®©å…ƒç´ çš„é«˜16</span> <span class="string">ä½å’Œä½16</span> <span class="string">ä½éƒ½å‚ä¸è¿ç®—</span></span><br><span class="line"><span class="string">ç¤ºä¾‹ï¼š</span></span><br><span class="line"><span class="string">æ¯”å¦‚æœ‰ä¸€ä¸ªå…ƒç´ 1æ¢æˆäºŒè¿›åˆ¶å¦‚ä¸‹</span></span><br><span class="line"><span class="number">1111 </span><span class="number">1111 </span><span class="number">1111 </span><span class="number">1111 </span><span class="number">1010 </span><span class="number">1010 </span><span class="number">1010 </span><span class="number">1010</span> <span class="string">ï¼ˆæ²¡æœ‰å³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span></span><br><span class="line"><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">1111 </span><span class="number">1111 </span><span class="number">1111 </span><span class="number">1111</span>  <span class="string">ï¼ˆå³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="string">å¦å¤–ä¸€ä¸ªå…ƒç´ 2æ¢æˆäºŒè¿›åˆ¶å¦‚ä¸‹</span></span><br><span class="line"><span class="number">1111 </span><span class="number">1111 </span><span class="number">1111 </span><span class="number">1110 </span><span class="number">1010 </span><span class="number">1010 </span><span class="number">1010 </span><span class="number">1010</span> <span class="string">ï¼ˆæ²¡æœ‰å³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span></span><br><span class="line"><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">1111 </span><span class="number">1111 </span><span class="number">1111 </span><span class="number">1110</span>  <span class="string">ï¼ˆå³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="string">åœ¨è®¡ç®—æ•°ç»„ä½ç½®çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯</span> <span class="string">hash</span> <span class="string">&amp;</span> <span class="string">(n</span> <span class="number">-1</span><span class="string">),</span>  <span class="string">è¦çŸ¥é“</span> <span class="string">n-1</span> <span class="string">è‚¯å®šæ˜¯ä¸€ä¸ªç›¸å¯¹æ¥è¯´æ¯”è¾ƒå°çš„æ•°å­—ï¼ˆ32ä¸ªbit</span> <span class="string">åªä¼šä½¿ç”¨æ¯”è¾ƒå°‘çš„ä½ä½ï¼‰ï¼Œ</span> <span class="string">æ¯”å¦‚é•¿åº¦æ˜¯</span> <span class="number">32</span><span class="string">ï¼Œ</span> <span class="string">å¯¹åº”çš„äºŒè¿›åˆ¶æ˜¯</span> <span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0001 </span><span class="number">1111</span></span><br><span class="line"></span><br><span class="line"><span class="string">ä½¿ç”¨æ²¡æœ‰å³ç§»çš„å…ƒç´ 1å’Œ</span> <span class="string">ï¼ˆ32</span> <span class="number">-1</span><span class="string">ï¼‰</span> <span class="string">è¿›è¡Œä¸æ“ä½œï¼ˆä¸æ“ä½œæ˜¯éƒ½ä¸º1æ‰ä¸º1ï¼Œå¦åˆ™ä¸º0ï¼‰</span></span><br><span class="line"><span class="number">1111 </span><span class="number">1111 </span><span class="number">1111 </span><span class="number">1111     </span><span class="number">1010 </span><span class="number">1010 </span><span class="number">1010 </span><span class="number">1010</span> <span class="string">ï¼ˆæ²¡æœ‰å³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span></span><br><span class="line"><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000      </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0001 </span><span class="number">1111</span></span><br><span class="line"><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000      </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">1010</span></span><br><span class="line"></span><br><span class="line"><span class="string">ä½¿ç”¨æ²¡æœ‰å³ç§»çš„å…ƒç´ 2å’Œ</span> <span class="string">ï¼ˆ32</span> <span class="number">-1</span><span class="string">ï¼‰</span> <span class="string">è¿›è¡Œä¸æ“ä½œï¼ˆä¸æ“ä½œæ˜¯éƒ½ä¸º1æ‰ä¸º1ï¼Œå¦åˆ™ä¸º0ï¼‰</span></span><br><span class="line"><span class="number">1111 </span><span class="number">1111 </span><span class="number">1111 </span><span class="number">1100     </span><span class="number">1010 </span><span class="number">1010 </span><span class="number">1010 </span><span class="number">1010</span> <span class="string">ï¼ˆæ²¡æœ‰å³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span></span><br><span class="line"><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000      </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0001 </span><span class="number">1111</span></span><br><span class="line"><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000      </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">1010</span></span><br><span class="line"><span class="string">å¯ä»¥çœ‹åˆ°å…ƒç´ 1å’Œå…ƒç´ 2è®¡ç®—å‡ºæ¥ä¸‹æ ‡æ˜¯ç›¸åŒçš„ï¼Œè¿™ä¸ªä¸åŒæ˜¯å› ä¸ºå…ƒç´ 1å’Œå…ƒç´ 2çš„ä½16ä½æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œä¸åŒä¹‹å¤„åªåœ¨äºé«˜16ä½ï¼Œä½†æ˜¯å½“æˆ‘ä»¬å¯¹</span> <span class="string">ï¼ˆn-1ï¼‰è¿›è¡Œä¸æ“ä½œçš„æ—¶å€™ï¼Œç”±äº</span> <span class="string">n-1</span> <span class="string">çš„å€¼æ¯”è¾ƒå°ï¼Œç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œåªæœ‰ä½16ä½ä¼šè¿›è¡Œè¿ç®—çš„</span></span><br><span class="line"></span><br><span class="line"><span class="string">æ¥ä¸‹æ¥å†çœ‹ä¸€ä¸‹å¦‚æœä½¿ç”¨å³ç§»çš„hashè¿›è¡Œè®¡ç®—ä¼šæœ‰ä»€ä¹ˆä¸åŒ</span></span><br><span class="line"><span class="string">ä½¿ç”¨å³ç§»çš„å…ƒç´ 1å’Œ</span> <span class="string">ï¼ˆ32</span> <span class="number">-1</span><span class="string">ï¼‰</span> <span class="string">è¿›è¡Œä¸æ“ä½œï¼ˆä¸æ“ä½œæ˜¯éƒ½ä¸º1æ‰ä¸º1ï¼Œå¦åˆ™ä¸º0ï¼‰</span></span><br><span class="line"><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000      </span><span class="number">1111 </span><span class="number">1111 </span><span class="number">1111 </span><span class="number">1111</span> <span class="string">ï¼ˆæ²¡æœ‰å³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span></span><br><span class="line"><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000      </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0001 </span><span class="number">1111</span></span><br><span class="line"><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000      </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000  </span><span class="number">1111</span></span><br><span class="line"></span><br><span class="line"><span class="string">ç”¨å³ç§»çš„å…ƒç´ 2å’Œ</span> <span class="string">ï¼ˆ32</span> <span class="number">-1</span><span class="string">ï¼‰</span> <span class="string">è¿›è¡Œä¸æ“ä½œï¼ˆä¸æ“ä½œæ˜¯éƒ½ä¸º1æ‰ä¸º1ï¼Œå¦åˆ™ä¸º0ï¼‰</span></span><br><span class="line"><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000      </span><span class="number">1111 </span><span class="number">1111 </span><span class="number">1111 </span><span class="number">1110</span> <span class="string">ï¼ˆæ²¡æœ‰å³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span></span><br><span class="line"><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000      </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0001 </span><span class="number">1111</span></span><br><span class="line"><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000      </span><span class="number">0000 </span><span class="number">0000 </span><span class="number">0000  </span><span class="number">1110</span></span><br><span class="line"><span class="string">å¯ä»¥çœ‹åˆ°è®¡ç®—å‡ºæ¥çš„</span> <span class="string">index</span> <span class="string">å€¼æ˜¯ä¸åŒçš„ï¼Œè¿™å°±æ˜¯å³ç§»å¸¦æ¥çš„è®©é«˜16ä½æœ‰å‚ä¸è¿ç®—çš„æ•ˆæœ</span></span><br></pre></td></tr></table></figure>

<h2 id="ä¸ºä»€ä¹ˆä¸å¯¹é•¿åº¦å–æ¨¡è€Œæ˜¯ä½¿ç”¨ä¸è¿ç®—"><a href="#ä¸ºä»€ä¹ˆä¸å¯¹é•¿åº¦å–æ¨¡è€Œæ˜¯ä½¿ç”¨ä¸è¿ç®—" class="headerlink" title="ä¸ºä»€ä¹ˆä¸å¯¹é•¿åº¦å–æ¨¡è€Œæ˜¯ä½¿ç”¨ä¸è¿ç®—"></a>ä¸ºä»€ä¹ˆä¸å¯¹é•¿åº¦å–æ¨¡è€Œæ˜¯ä½¿ç”¨ä¸è¿ç®—</h2><ol>
<li><code>X % 2^n = X &amp; (2^n â€“ 1)</code>  è¿™ä¸¤ç§è¿ç®—ç­‰ä»·ï¼Œæ‰€ä»¥è¿™ä¹Ÿæ˜¯ <code>HashMap</code> é•¿åº¦å– <code>2^n</code> çš„åŸå› <br>ä¹Ÿå¯ä»¥ä»æ•°æ®è§’åº¦è®°ä½ï¼Œå½“ <code>n</code> æ˜¯ 2 çš„å€æ•°æ—¶ï¼Œ <code>X % 2^n = X &amp; (2^n â€“ 1)</code>  ç­‰ä»·</li>
</ol>
<p><a href="https://www.cnblogs.com/ysocean/p/9054804.html">å…¬å¼è®¡ç®—å‚è€ƒé“¾æ¥</a></p>
<h2 id="HashMapæ˜¯å¦‚ä½•å®ç°æ‰©å®¹çš„"><a href="#HashMapæ˜¯å¦‚ä½•å®ç°æ‰©å®¹çš„" class="headerlink" title="HashMapæ˜¯å¦‚ä½•å®ç°æ‰©å®¹çš„"></a>HashMapæ˜¯å¦‚ä½•å®ç°æ‰©å®¹çš„</h2><p>æ‰©å®¹åç´¢å¼•å…¶å®ä¹Ÿæ˜¯ä½¿ç”¨ <code>hash &amp; ï¼ˆnewLength -1ï¼‰</code>, è¿™æ ·è®¡ç®—å‡ºæ¥çš„ä½ç½®è¦æ˜¯å’ŒåŸæ¥çš„å…ƒç´ åœ¨ç›¸åŒçš„ä½ç½®ï¼Œè¦ä¹ˆæ˜¯ åŸæ¥çš„ä½ç½®+æ—§æ•°ç»„é•¿åº¦&#x3D;æ–°ç´¢å¼•ä½ç½®</p>
<h2 id="HashMapæ˜¯å¦‚ä½•è§£å†³hashå†²çªçš„"><a href="#HashMapæ˜¯å¦‚ä½•è§£å†³hashå†²çªçš„" class="headerlink" title="HashMapæ˜¯å¦‚ä½•è§£å†³hashå†²çªçš„"></a>HashMapæ˜¯å¦‚ä½•è§£å†³hashå†²çªçš„</h2><ol>
<li>å¯¹ <code>hash</code> çš„è®¡ç®—è¿›è¡Œä¼˜åŒ–ï¼Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ <code>hashcode</code>,  è€Œæ˜¯å³ç§»16ä½ï¼Œè®©é«˜16ä½ä¹Ÿå‚ä¸è¿ç®—ï¼Œå‡å°‘<code>hash</code> å†²çª</li>
<li>å¦‚æœé‡åˆ°å†²çªï¼Œä½¿ç”¨æ‹‰é“¾æ³•è§£å†³</li>
</ol>
]]></content>
      <categories>
        <category>java</category>
        <category>javaåŸºç¡€</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>javaçš„ioæ¨¡å‹</title>
    <url>/2023/180f5b629f58/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="BIO"><a href="#BIO" class="headerlink" title="BIO"></a>BIO</h2><ol>
<li><code>bio</code> æ˜¯åŒæ­¥é˜»å¡ <code>io</code>ï¼Œæ¯ä¸€ä¸ªè¿æ¥éƒ½éœ€è¦ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†</li>
<li><code>bio</code> ä¼šæœ‰èµ„æºæµªè´¹é—®é¢˜ï¼Œä¸€ä¸ªçº¿ç¨‹åªèƒ½å¤„ç†ä¸€ä¸ªè¿æ¥ï¼Œå¦‚æœæŸä¸ªå®¢æˆ·ç«¯å¹¶æ²¡æœ‰å‘é€æ•°æ®ï¼Œå¯¹åº”çš„æœåŠ¡ç«¯çº¿ç¨‹ä¹Ÿåªèƒ½é˜»å¡</li>
</ol>
<span id="more"></span>
<h3 id="é˜»å¡çš„å«ä¹‰"><a href="#é˜»å¡çš„å«ä¹‰" class="headerlink" title="é˜»å¡çš„å«ä¹‰"></a>é˜»å¡çš„å«ä¹‰</h3><ol>
<li>æœåŠ¡ç«¯ <code>ServerSocket</code> è°ƒç”¨ <code>accept()</code> æ–¹æ³•ä¼šé˜»å¡ï¼ˆå¦‚æœæ²¡æœ‰å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•åä¸ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼‰</li>
<li>çº¿ç¨‹ä»Socketçš„è¾“å…¥æµè¯»å…¥æ•°æ®æ—¶,å¦‚æœè¾“å…¥æµæ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®ï¼Œå°±ä¼šè¿›å…¥é˜»å¡çŠ¶æ€</li>
</ol>
<h3 id="java-bio-ä»£ç å®ç°"><a href="#java-bio-ä»£ç å®ç°" class="headerlink" title="java bio ä»£ç å®ç°"></a>java bio ä»£ç å®ç°</h3><p><strong>æœåŠ¡ç«¯ä»£ç </strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.demo.socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CusServerSocket</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8080</span>);) &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">                <span class="comment">//è¿æ¥æˆåŠŸåæ–°å¼€ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†è¿™ä¸ªè¿æ¥</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">// read() æ–¹æ³•ä¸Šçš„æ³¨é‡Š If no byte is available because the stream is at the end of the file, the value -1 is returned</span></span><br><span class="line">                            <span class="keyword">while</span> ((length = socket.getInputStream().read(bytes)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                                System.out.println(<span class="string">&quot;thredId:&quot;</span> + Thread.currentThread().getName() + <span class="keyword">new</span> <span class="title class_">String</span>(bytes, <span class="number">0</span>, length));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                        System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>å®¢æˆ·ç«¯å®ç°</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.demo.socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CusClientSocket</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// å¤–å±‚å¾ªç¯ä¼šåˆ›å»ºå¤šä¸ª socketï¼Œç”¨æ¥æ¨¡æ‹Ÿå¤šä¸ª socket å®¢æˆ·ç«¯</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">3</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">8080</span>)) &#123;</span><br><span class="line">                <span class="comment">// å†…å­˜å¾ªç¯ç”¨æ¥æ¨¡æ‹Ÿä¸€ä¸ªå®¢æˆ·ç«¯çš„å¤šæ¬¡é€šä¿¡</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">20</span>);</span><br><span class="line">                    socket.getOutputStream().write((<span class="string">&quot;å®¢æˆ·ç«¯&quot;</span> + j + <span class="string">&quot;ç¬¬&quot;</span> + i + <span class="string">&quot;æ¬¡é€šä¿¡&quot;</span>).getBytes());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ‰§è¡Œç»“æœ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">thredId:Thread-<span class="number">0</span>å®¢æˆ·ç«¯<span class="number">0</span>ç¬¬<span class="number">1</span>æ¬¡é€šä¿¡</span><br><span class="line">thredId:Thread-<span class="number">0</span>å®¢æˆ·ç«¯<span class="number">0</span>ç¬¬<span class="number">2</span>æ¬¡é€šä¿¡</span><br><span class="line">å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:Thread-<span class="number">0</span></span><br><span class="line">thredId:Thread-<span class="number">1</span>å®¢æˆ·ç«¯<span class="number">1</span>ç¬¬<span class="number">1</span>æ¬¡é€šä¿¡</span><br><span class="line">thredId:Thread-<span class="number">1</span>å®¢æˆ·ç«¯<span class="number">1</span>ç¬¬<span class="number">2</span>æ¬¡é€šä¿¡</span><br><span class="line">å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:Thread-<span class="number">1</span></span><br><span class="line">thredId:Thread-<span class="number">2</span>å®¢æˆ·ç«¯<span class="number">2</span>ç¬¬<span class="number">1</span>æ¬¡é€šä¿¡</span><br><span class="line">thredId:Thread-<span class="number">2</span>å®¢æˆ·ç«¯<span class="number">2</span>ç¬¬<span class="number">2</span>æ¬¡é€šä¿¡</span><br><span class="line">å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:Thread-<span class="number">2</span></span><br></pre></td></tr></table></figure>
<ol>
<li>æ‰§è¡Œå®Œæˆä¹‹åï¼ŒæœåŠ¡ç«¯ç¨‹åºå¹¶ä¸ä¼šå…³é—­ï¼Œä¼šä¸€ç›´åœ¨è¿è¡Œ</li>
<li>ä»ä¸Šé¢ç»“æœçœ‹ï¼Œä¸€å…±åˆ›å»ºäº†ä¸‰ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œ</li>
</ol>
<h3 id="ä½¿ç”¨çº¿ç¨‹æ± ä¼˜åŒ–-bio-å®ç°"><a href="#ä½¿ç”¨çº¿ç¨‹æ± ä¼˜åŒ–-bio-å®ç°" class="headerlink" title="ä½¿ç”¨çº¿ç¨‹æ± ä¼˜åŒ– bio å®ç°"></a>ä½¿ç”¨çº¿ç¨‹æ± ä¼˜åŒ– bio å®ç°</h3><p>å®¢æˆ·ç«¯ä»£ç ä¸éœ€è¦æ”¹åŠ¨ï¼Œåªéœ€è¦æ›´æ”¹æœåŠ¡ç«¯ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.demo.socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CusServerSocket</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8080</span>);) &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">                <span class="comment">//è¿æ¥æˆåŠŸåæ–°å¼€ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†è¿™ä¸ªè¿æ¥</span></span><br><span class="line">                executorService.execute(<span class="keyword">new</span> <span class="title class_">ClientTask</span>(socket));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ClientTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Socket socket;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ClientTask</span><span class="params">(Socket socket)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.socket = socket;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// read() æ–¹æ³•ä¸Šçš„æ³¨é‡Š If no byte is available because the stream is at the end of the file, the value -1 is returned</span></span><br><span class="line">                <span class="keyword">while</span> ((length = socket.getInputStream().read(bytes)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;thredId:&quot;</span> + Thread.currentThread().getName() + <span class="keyword">new</span> <span class="title class_">String</span>(bytes, <span class="number">0</span>, length));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">thredId:pool-<span class="number">1</span>-thread-<span class="number">1</span>å®¢æˆ·ç«¯<span class="number">0</span>ç¬¬<span class="number">1</span>æ¬¡é€šä¿¡</span><br><span class="line">thredId:pool-<span class="number">1</span>-thread-<span class="number">1</span>å®¢æˆ·ç«¯<span class="number">0</span>ç¬¬<span class="number">2</span>æ¬¡é€šä¿¡</span><br><span class="line">å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:pool-<span class="number">1</span>-thread-<span class="number">1</span></span><br><span class="line">thredId:pool-<span class="number">1</span>-thread-<span class="number">1</span>å®¢æˆ·ç«¯<span class="number">1</span>ç¬¬<span class="number">1</span>æ¬¡é€šä¿¡</span><br><span class="line">thredId:pool-<span class="number">1</span>-thread-<span class="number">1</span>å®¢æˆ·ç«¯<span class="number">1</span>ç¬¬<span class="number">2</span>æ¬¡é€šä¿¡</span><br><span class="line">å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:pool-<span class="number">1</span>-thread-<span class="number">1</span></span><br><span class="line">thredId:pool-<span class="number">1</span>-thread-<span class="number">1</span>å®¢æˆ·ç«¯<span class="number">2</span>ç¬¬<span class="number">1</span>æ¬¡é€šä¿¡</span><br><span class="line">thredId:pool-<span class="number">1</span>-thread-<span class="number">1</span>å®¢æˆ·ç«¯<span class="number">2</span>ç¬¬<span class="number">2</span>æ¬¡é€šä¿¡</span><br><span class="line">å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:pool-<span class="number">1</span>-thread-<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>å³ä½¿ä½¿ç”¨çº¿ç¨‹æ± è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæœ¬åœ°è¿˜æ˜¯é˜»å¡ioï¼Œåªæœ‰å½“ä¸€ä¸ªå®¢æˆ·ç«¯é€šä¿¡å®Œæˆï¼ˆsocketå…³é—­äº†ï¼‰ï¼Œå¦å¤–ä¸€ä¸ª socket æ‰å¯ä»¥å¼€å§‹è¿›è¡Œé€šä¿¡</p>
<h2 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h2><ol>
<li>nio æ˜¯éé˜»å¡ ioï¼ˆNon-block ioï¼‰</li>
<li>éé˜»å¡ io çš„é‡ç‚¹æ˜¯ <strong>äº‹ä»¶</strong> å’Œ <strong>é€šçŸ¥æˆ–è½®è¯¢</strong></li>
<li><code>java.nio.channerls</code> åŒ…æä¾›äº†æ”¯æŒéé˜»å¡é€šä¿¡çš„ç±»<ol>
<li><code>ServerSocketChannel</code>: <code>ServerSocket</code> çš„æ›¿ä»£ç±»ï¼Œæ”¯æŒé˜»å¡é€šä¿¡ä¸éé˜»å¡é€šä¿¡</li>
<li><code>SocketChannerl</code>ï¼š <code>Socket</code> çš„æ›¿ä»£ç±»ï¼Œæ”¯æŒé˜»å¡é€šä¿¡ä¸éé˜»å¡é€šä¿¡</li>
<li><code>Selector</code>ï¼š ä¸º<code>ServerSocketChannel</code>ç›‘æ§æ¥æ”¶è¿æ¥å°±ç»ªäº‹ä»¶ï¼Œä¸º<code>SocketChannel</code>ç›‘æ§è¿æ¥å°±ç»ªã€è¯»å°±ç»ªå’Œå†™å°±ç»ªäº‹ä»¶</li>
<li><code>SelectionKey</code>ï¼šä»£è¡¨<code>ServerSocketChannel</code>ä»¥åŠ<code>SocketChannel</code>å‘<code>Selector</code>æ³¨å†Œäº‹ä»¶çš„å¥æŸ„ã€‚å½“ä¸€ä¸ª<code>SelectionKey</code>å¯¹è±¡ä½äº<code>Selector</code>å¯¹è±¡çš„<code>selected-keys</code>é›†åˆä¸­ï¼Œå°±è¡¨ç¤ºä¸è¿™ä¸ª<code>SelectionKey</code>å¯¹è±¡ç›¸å…³çš„äº‹ä»¶å‘ç”Ÿäº†</li>
</ol>
</li>
</ol>
<h3 id="NIO-æ‰§è¡Œæµç¨‹"><a href="#NIO-æ‰§è¡Œæµç¨‹" class="headerlink" title="NIO æ‰§è¡Œæµç¨‹"></a>NIO æ‰§è¡Œæµç¨‹</h3><pre class="mermaid">sequenceDiagram
    participant A as ServerSocketChannel
    participant B as Selector
    participant C as socketChannel
    A->>A: open()
    B-->>B: open()
    A-->>B: register(SelectionKey.OP_ACCEPT)
    C-->>C: open()
    C-->>B: register(SelectionKey.OP_CONNECT)
    B-->>A: selectionKey.isAcceptable()==true
    A-->>A: accept()
    A-->>B: register(SelectionKey.OP_READ)
    C-->>B: write(byte[])
    B-->>A: selectionKey.isReadable()==true
    A-->>A: read()
    A-->>B: register(SelectionKey.OP_WRITE)</pre>


<h2 id="ä»£ç ç¤ºä¾‹"><a href="#ä»£ç ç¤ºä¾‹" class="headerlink" title="ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h2><p>ä»£ç æ‰§è¡Œæµç¨‹</p>
<ol>
<li>æœåŠ¡ç«¯å¯åŠ¨</li>
<li>å®¢æˆ·ç«¯å¯åŠ¨è¿æ¥æœåŠ¡ç«¯ï¼ˆæ³¨å†Œ <strong>å¯è¯»</strong>å’Œ <strong>å¯å†™</strong>äº‹ä»¶ï¼‰</li>
<li>å®¢æˆ·ç«¯å‘ç”Ÿå¯å†™äº‹ä»¶ï¼Œå¼€å§‹å†™æ•°æ®åˆ°æœåŠ¡ç«¯å¹¶ä¸” <strong>å–æ¶ˆå¯å†™äº‹ä»¶</strong></li>
<li>æœåŠ¡ç«¯å‘ç”Ÿå¯è¯»äº‹ä»¶ï¼Œè¯»å–æ•°æ®å¹¶æ³¨å†Œå¯å†™äº‹ä»¶</li>
<li>æœåŠ¡ç«¯å†™æ•°æ®åˆ°ç”¨æˆ·ç«¯å¹¶ <strong>å–æ¶ˆå¯å†™äº‹ä»¶</strong></li>
<li>å®¢æˆ·ç«¯å‘ç”Ÿå¯è¯»äº‹ä»¶ï¼Œè¯»å–æ•°æ®åæ³¨å†Œå¯å†™äº‹ä»¶</li>
<li>é‡å¤3-6æ­¥éª¤</li>
</ol>
<p>ä¸Šé¢æœ‰ä¸€ä¸ªæ ¸å¿ƒçš„æ­¥éª¤æ˜¯ï¼Œä¸è®ºæ˜¯ç®¡ç†ç«¯è¿˜æ˜¯æœåŠ¡ç«¯ï¼Œåœ¨å†™å®Œæ•°æ®ä¹‹åéƒ½è¦å–æ¶ˆå¯å†™äº‹ä»¶ï¼Œå½“æƒ³è¦å†™æ•°æ®çš„æ—¶å€™ï¼Œå†è¿›è¡Œæ³¨å†Œå†™äº‹ä»¶å³å¯</p>
<ol>
<li>å¦‚æœæ³¨å†Œå®Œå†™äº‹ä»¶å¹¶ä¸”å†™å®Œæ•°æ®ä¹‹åï¼Œæ²¡æœ‰è¿›è¡Œå–æ¶ˆï¼Œé‚£ä¹ˆ <code>selectionKey.isWritable()</code> ä¼šä¸€ç›´è¿”å›trueï¼Œ åŸå› è¯·çœ‹ç¬¬äºŒç‚¹</li>
<li><code>SocketChannel</code> åœ¨å¦‚ä¸‹æƒ…å†µä¸‹éƒ½æ˜¯å¯å†™çš„çŠ¶æ€<ol>
<li>å½“è¿æ¥å»ºç«‹åï¼Œå¯ä»¥å‘ <code>SocketChannel</code> ä¸­å†™å…¥æ•°æ®</li>
<li>å½“ <code>SocketChannel</code> ä¸­çš„è¾“å‡ºç¼“å†²åŒºæœ‰ç©ºé—´æ—¶ï¼Œå¯ä»¥å†™å…¥æ•°æ®, æ‰€å¤„åªè¦ç¼“å†²åŒºæœ‰ç©ºé—´ï¼Œå°±ä¼šä¸€ç›´å¯å†™</li>
</ol>
</li>
</ol>
<h3 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CusServerSocket</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*ç¼“å†²åŒºå¤§å°*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">BLOCK</span> <span class="operator">=</span> <span class="number">1024</span>;</span><br><span class="line">    <span class="comment">/*æ¥å—æ•°æ®ç¼“å†²åŒº*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ByteBuffer</span> <span class="variable">sendBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(BLOCK);</span><br><span class="line">    <span class="comment">/*å‘é€æ•°æ®ç¼“å†²åŒº*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ByteBuffer</span> <span class="variable">receiveBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(BLOCK);</span><br><span class="line">    <span class="keyword">private</span> Selector selector;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CusServerSocket</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// æ‰“å¼€æœåŠ¡å™¨å¥—æ¥å­—é€šé“</span></span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        <span class="comment">// æœåŠ¡å™¨é…ç½®ä¸ºéé˜»å¡</span></span><br><span class="line">        serverSocketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        serverSocketChannel.socket().bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port));</span><br><span class="line">        selector = Selector.open();</span><br><span class="line">        <span class="comment">// æ³¨å†Œåˆ°selectorï¼Œç­‰å¾…è¿æ¥</span></span><br><span class="line">        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å¯åŠ¨----8080:&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">listen</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// é€‰æ‹©ä¸€ç»„é”®ï¼Œå¹¶ä¸”ç›¸åº”çš„é€šé“å·²ç»æ‰“å¼€</span></span><br><span class="line">            selector.select();</span><br><span class="line">            <span class="comment">// è¿”å›æ­¤é€‰æ‹©å™¨çš„å·²é€‰æ‹©é”®é›†ã€‚</span></span><br><span class="line">            Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">selectionKey</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                iterator.remove();</span><br><span class="line">                handleEvent(selectionKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleEvent</span><span class="params">(SelectionKey selectionKey)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        String receiveText;</span><br><span class="line">        String sendText;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// å¯è¿æ¥</span></span><br><span class="line">        <span class="keyword">if</span> (selectionKey.isAcceptable()) &#123;</span><br><span class="line">            <span class="type">ServerSocketChannel</span> <span class="variable">server</span> <span class="operator">=</span> (ServerSocketChannel) selectionKey.channel();</span><br><span class="line">            <span class="type">SocketChannel</span> <span class="variable">client</span> <span class="operator">=</span> server.accept();</span><br><span class="line">            <span class="comment">// è®¾ç½®è¯¥é€šé“éé˜»å¡</span></span><br><span class="line">            client.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">            <span class="comment">// æ³¨å†Œå¯è¯»å’Œå¯å†™äº‹ä»¶</span></span><br><span class="line">            client.register(selector, SelectionKey.OP_READ);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (selectionKey.isReadable()) &#123;</span><br><span class="line">            <span class="comment">// è¿”å›ä¸ºä¹‹åˆ›å»ºæ­¤é”®çš„é€šé“ã€‚</span></span><br><span class="line">            <span class="type">SocketChannel</span> <span class="variable">client</span> <span class="operator">=</span> (SocketChannel) selectionKey.channel();</span><br><span class="line">            <span class="comment">//å°†ç¼“å†²åŒºæ¸…ç©ºä»¥å¤‡ä¸‹æ¬¡è¯»å–</span></span><br><span class="line">            receiveBuffer.clear();</span><br><span class="line">            <span class="comment">//è¯»å–æœåŠ¡å™¨å‘é€æ¥çš„æ•°æ®åˆ°ç¼“å†²åŒºä¸­</span></span><br><span class="line">            count = client.read(receiveBuffer);</span><br><span class="line">            <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                receiveText = <span class="keyword">new</span> <span class="title class_">String</span>(receiveBuffer.array(), <span class="number">0</span>, count);</span><br><span class="line">                System.out.println(<span class="string">&quot;æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®--:&quot;</span> + receiveText);</span><br><span class="line">            &#125;</span><br><span class="line">            client.register(selector, SelectionKey.OP_WRITE);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (selectionKey.isWritable()) &#123;</span><br><span class="line">            sendBuffer.clear();</span><br><span class="line">            <span class="type">SocketChannel</span> <span class="variable">client</span> <span class="operator">=</span> (SocketChannel) selectionKey.channel();</span><br><span class="line">            <span class="type">LocalTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalTime.now();</span><br><span class="line">            sendText = <span class="string">&quot;æœåŠ¡ç«¯--ã€‹å®¢æˆ·ç«¯  &quot;</span> + now.getMinute() + <span class="string">&quot;:&quot;</span> + now.getSecond();</span><br><span class="line">            sendBuffer.put(sendText.getBytes());</span><br><span class="line">            <span class="comment">//å°†ç¼“å†²åŒºå„æ ‡å¿—å¤ä½,å› ä¸ºå‘é‡Œé¢putäº†æ•°æ®æ ‡å¿—è¢«æ”¹å˜è¦æƒ³ä»ä¸­è¯»å–æ•°æ®å‘å‘æœåŠ¡å™¨,å°±è¦å¤ä½</span></span><br><span class="line">            sendBuffer.flip();</span><br><span class="line">            <span class="comment">//è¾“å‡ºåˆ°é€šé“</span></span><br><span class="line">            client.write(sendBuffer);</span><br><span class="line">            selectionKey.interestOps(SelectionKey.OP_READ);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">8080</span>;</span><br><span class="line">        <span class="type">CusServerSocket</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CusServerSocket</span>(port);</span><br><span class="line">        server.listen();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç”¨æˆ·ç«¯"><a href="#ç”¨æˆ·ç«¯" class="headerlink" title="ç”¨æˆ·ç«¯"></a>ç”¨æˆ·ç«¯</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CusClientSocket</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*ç¼“å†²åŒºå¤§å°*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">BLOCK</span> <span class="operator">=</span> <span class="number">1024</span>;</span><br><span class="line">    <span class="comment">/*æ¥å—æ•°æ®ç¼“å†²åŒº*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ByteBuffer</span> <span class="variable">sendBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(BLOCK);</span><br><span class="line">    <span class="comment">/*å‘é€æ•°æ®ç¼“å†²åŒº*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ByteBuffer</span> <span class="variable">receiveBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(BLOCK);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> SocketChannel.open();</span><br><span class="line">        socketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">        socketChannel.register(selector, SelectionKey.OP_CONNECT);</span><br><span class="line">        socketChannel.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>));</span><br><span class="line"></span><br><span class="line">        Set&lt;SelectionKey&gt; selectionKeys;</span><br><span class="line">        Iterator&lt;SelectionKey&gt; iterator;</span><br><span class="line">        SelectionKey selectionKey;</span><br><span class="line">        SocketChannel client;</span><br><span class="line">        String receiveText;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            selector.select();</span><br><span class="line">            <span class="comment">//è¿”å›æ­¤é€‰æ‹©å™¨çš„å·²é€‰æ‹©é”®é›†ã€‚</span></span><br><span class="line">            selectionKeys = selector.selectedKeys();</span><br><span class="line">            iterator = selectionKeys.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                selectionKey = iterator.next();</span><br><span class="line">                iterator.remove();</span><br><span class="line">                <span class="keyword">if</span> (selectionKey.isConnectable()) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;client connect&quot;</span>);</span><br><span class="line">                    client = (SocketChannel) selectionKey.channel();</span><br><span class="line">                    <span class="comment">// åˆ¤æ–­æ­¤é€šé“ä¸Šæ˜¯å¦æ­£åœ¨è¿›è¡Œè¿æ¥æ“ä½œã€‚</span></span><br><span class="line">                    <span class="comment">// å®Œæˆå¥—æ¥å­—é€šé“çš„è¿æ¥è¿‡ç¨‹ã€‚</span></span><br><span class="line">                    <span class="keyword">if</span> (client.isConnectionPending()) &#123;</span><br><span class="line">                        client.finishConnect();</span><br><span class="line">                        System.out.println(<span class="string">&quot;å®Œæˆè¿æ¥!&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// è¿æ¥æˆåŠŸä¹‹åæ³¨å†Œå¯è¯»å’Œå¯å†™äº‹ä»¶</span></span><br><span class="line">                    client.register(selector, SelectionKey.OP_READ | SelectionKey.OP_WRITE);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (selectionKey.isReadable()) &#123;</span><br><span class="line">                    client = (SocketChannel) selectionKey.channel();</span><br><span class="line">                    <span class="comment">//å°†ç¼“å†²åŒºæ¸…ç©ºä»¥å¤‡ä¸‹æ¬¡è¯»å–</span></span><br><span class="line">                    receiveBuffer.clear();</span><br><span class="line">                    <span class="comment">//è¯»å–æœåŠ¡å™¨å‘é€æ¥çš„æ•°æ®åˆ°ç¼“å†²åŒºä¸­</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> client.read(receiveBuffer);</span><br><span class="line">                    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        receiveText = <span class="keyword">new</span> <span class="title class_">String</span>(receiveBuffer.array(), <span class="number">0</span>, count);</span><br><span class="line">                        System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®--:&quot;</span> + receiveText);</span><br><span class="line">                    &#125;</span><br><span class="line">                    client.register(selector, SelectionKey.OP_WRITE);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (selectionKey.isWritable()) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                    sendBuffer.clear();</span><br><span class="line">                    client = (SocketChannel) selectionKey.channel();</span><br><span class="line">                    <span class="type">LocalTime</span> <span class="variable">localTime</span> <span class="operator">=</span> LocalTime.now();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">sendText</span> <span class="operator">=</span> <span class="string">&quot;å®¢æˆ·ç«¯å‘é€çš„æ•°æ®--&gt;&quot;</span> + localTime.getMinute() + <span class="string">&quot;:&quot;</span> + localTime.getSecond();</span><br><span class="line">                    sendBuffer.put(sendText.getBytes());</span><br><span class="line">                    <span class="comment">//å°†ç¼“å†²åŒºå„æ ‡å¿—å¤ä½,å› ä¸ºå‘é‡Œé¢putäº†æ•°æ®æ ‡å¿—è¢«æ”¹å˜è¦æƒ³ä»ä¸­è¯»å–æ•°æ®å‘å‘æœåŠ¡å™¨,å°±è¦å¤ä½</span></span><br><span class="line">                    sendBuffer.flip();</span><br><span class="line">                    client.write(sendBuffer);</span><br><span class="line">                    <span class="comment">// å†™å®Œä¹‹åéœ€è¦æ³¨é”€å†™äº‹ä»¶ï¼Œå¦åˆ™ä¼šä¸€ç›´åˆ¤æ–­æˆå¯å†™, è¿™é‡Œè¡¨æ˜¯å¯¹è¯»äº‹ä»¶æ„Ÿå…´è¶£ï¼Œå°±æ˜¯ç§»é™¤å†™äº‹ä»¶çš„æ„æ€</span></span><br><span class="line">                    selectionKey.interestOps(SelectionKey.OP_READ);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="tabs" id="æ‰§è¡Œç»“æœ"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="æ‰§è¡Œç»“æœ-1">æœåŠ¡ç«¯ç»“æœ</button><button type="button" class="tab " data-href="æ‰§è¡Œç»“æœ-2">ç”¨æˆ·ç«¯ç»“æœ</button></ul><div class="tab-contents"><div class="tab-item-content active" id="æ‰§è¡Œç»“æœ-1"><figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">æœåŠ¡å¯åŠ¨</span><span class="literal">----</span><span class="comment">8080:</span></span><br><span class="line"><span class="comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="literal">--</span>&gt;<span class="comment">59:45</span></span><br><span class="line"><span class="comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="literal">--</span>&gt;<span class="comment">59:47</span></span><br><span class="line"><span class="comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="literal">--</span>&gt;<span class="comment">59:49</span></span><br><span class="line"><span class="comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="literal">--</span>&gt;<span class="comment">59:51</span></span><br><span class="line"><span class="comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="literal">--</span>&gt;<span class="comment">59:53</span></span><br><span class="line"><span class="comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="literal">--</span>&gt;<span class="comment">59:55</span></span><br><span class="line"><span class="comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="literal">--</span>&gt;<span class="comment">59:57</span></span><br><span class="line"><span class="comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="literal">--</span>&gt;<span class="comment">59:59</span></span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="æ‰§è¡Œç»“æœ-2"><figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">client connect</span></span><br><span class="line"><span class="comment">å®Œæˆè¿æ¥!</span></span><br><span class="line"><span class="comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:æœåŠ¡ç«¯</span><span class="literal">--</span><span class="comment">ã€‹å®¢æˆ·ç«¯  59:45</span></span><br><span class="line"><span class="comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:æœåŠ¡ç«¯</span><span class="literal">--</span><span class="comment">ã€‹å®¢æˆ·ç«¯  59:47</span></span><br><span class="line"><span class="comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:æœåŠ¡ç«¯</span><span class="literal">--</span><span class="comment">ã€‹å®¢æˆ·ç«¯  59:49</span></span><br><span class="line"><span class="comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:æœåŠ¡ç«¯</span><span class="literal">--</span><span class="comment">ã€‹å®¢æˆ·ç«¯  59:51</span></span><br><span class="line"><span class="comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:æœåŠ¡ç«¯</span><span class="literal">--</span><span class="comment">ã€‹å®¢æˆ·ç«¯  59:53</span></span><br><span class="line"><span class="comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:æœåŠ¡ç«¯</span><span class="literal">--</span><span class="comment">ã€‹å®¢æˆ·ç«¯  59:55</span></span><br><span class="line"><span class="comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:æœåŠ¡ç«¯</span><span class="literal">--</span><span class="comment">ã€‹å®¢æˆ·ç«¯  59:57</span></span><br><span class="line"><span class="comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="literal">--</span><span class="comment">:æœåŠ¡ç«¯</span><span class="literal">--</span><span class="comment">ã€‹å®¢æˆ·ç«¯  59:59</span></span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>


]]></content>
      <categories>
        <category>java</category>
        <category>javaåŸºç¡€</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>javaè¾“å‡ºè¿è¡Œè¿‡ç¨‹ä¸­çš„ä»£ç†ç±»</title>
    <url>/2023/d513f5c497bd/index.html</url>
    <content><![CDATA[<h2 id="è¾“å‡º-jdk-åŠ¨æ€ä»£ç†ç±»åˆ°æ–‡ä»¶"><a href="#è¾“å‡º-jdk-åŠ¨æ€ä»£ç†ç±»åˆ°æ–‡ä»¶" class="headerlink" title="è¾“å‡º jdk åŠ¨æ€ä»£ç†ç±»åˆ°æ–‡ä»¶"></a>è¾“å‡º jdk åŠ¨æ€ä»£ç†ç±»åˆ°æ–‡ä»¶</h2><p>åœ¨æµ‹è¯•ä»£ç çš„ç¬¬ä¸€è¡Œå¢åŠ ä¸‹é¢è¿™æ®µä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.getProperties().put(<span class="string">&quot;jdk.proxy.ProxyGenerator.saveGeneratedFiles&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>ä¸åŒ <code>jdk</code> ç‰ˆæœ¬çš„ä½¿ç”¨ <code>key</code> å¯èƒ½ä¸åŒï¼Œå…·ä½“çš„ <code>key</code> æ˜¯ä»€ä¹ˆå¯ä»¥æŸ¥çœ‹ <code>ProxyGenerator</code> ç±»çš„ <code>saveGeneratedFiles</code> å±æ€§ï¼Œ æ¯”å¦‚ <code>jdk17</code> ç‰ˆæœ¬ <code>ProxyGenerator</code> ç±»çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ProxyGenerator</span> <span class="keyword">extends</span> <span class="title class_">ClassWriter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">saveGeneratedFiles</span> <span class="operator">=</span></span><br><span class="line">            java.security.AccessController.doPrivileged(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">GetBooleanAction</span>(</span><br><span class="line">                            <span class="string">&quot;jdk.proxy.ProxyGenerator.saveGeneratedFiles&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œå®Œä»£ç ååœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¼šè¾“å‡ºåŠ¨æ€ä»£ç†ç±»</p>
<p><a href="https://arthas.aliyun.com/doc/">arthaså®˜æ–¹æ–‡æ¡£</a></p>
<h2 id="ä½¿ç”¨-arthas-è¾“å‡º-javaassist-ç”Ÿæˆçš„ä»£ç†ç±»"><a href="#ä½¿ç”¨-arthas-è¾“å‡º-javaassist-ç”Ÿæˆçš„ä»£ç†ç±»" class="headerlink" title="ä½¿ç”¨ arthas è¾“å‡º javaassist ç”Ÿæˆçš„ä»£ç†ç±»"></a>ä½¿ç”¨ arthas è¾“å‡º javaassist ç”Ÿæˆçš„ä»£ç†ç±»</h2><ol>
<li>å…ˆæ‰“ç«¯ç‚¹ï¼Œç¡®å®šä»£ç†ç±»çš„åç§°ï¼Œæ¯”å¦‚æœ‰ä¸€ä¸ªä»£ç†ç±»åç§°æ˜¯ <code>Hello$Adaptive</code></li>
<li>æ‰“å¼€ <code>arthas</code> é€‰æ‹©å¯¹åº”çš„è¿›ç¨‹è¿›å…¥åï¼Œä½¿ç”¨ä¸‹é¢å‘½ä»¤è¾“å‡ºä»£ç†ç±»</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸‹é¢å‘½ä»¤æ‰¾åˆ°å¯¹åº”ä»£ç†ç±»çš„å…¨è·¯å¾„ï¼Œ æ¯”å¦‚è¾“å‡ºç»“æœæ˜¯ com.example.dubbodemo.spi.Hello$Adaptive</span></span><br><span class="line">sc *Hello$Adaptive*</span><br><span class="line"><span class="comment">// æ ¹æ®ä¸Šé¢æ‰¾åˆ°çš„ä»£ç†ç±»çš„å…¨è·¯å¾„ï¼Œè§£æå‡ºæºä»£ç å…µè¾“å‡ºåˆ°ç‰¹å®šçš„æ–‡ä»¶</span></span><br><span class="line">jad com.example.dubbodemo.spi.Hello$Adaptive &gt; D:\\Hello$Adaptive.java</span><br></pre></td></tr></table></figure>

<h2 id="è¾“å‡º-cglib-ä»£ç†ç±»åˆ°æ–‡ä»¶"><a href="#è¾“å‡º-cglib-ä»£ç†ç±»åˆ°æ–‡ä»¶" class="headerlink" title="è¾“å‡º cglib ä»£ç†ç±»åˆ°æ–‡ä»¶"></a>è¾“å‡º cglib ä»£ç†ç±»åˆ°æ–‡ä»¶</h2><p>åœ¨æµ‹è¯•æ–¹æ³•çš„ç¬¬ä¸€è¡ŒåŠ ä¸Šå¦‚ä¸‹ä»£ç , ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯æŒ‡å®šè¾“å‡ºçš„æ–‡ä»¶å¤¹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, <span class="string">&quot;D:\\temp\\cglib&quot;</span>);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>java</category>
        <category>javaåŸºç¡€</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>javaå†…å­˜æ¨¡å‹</title>
    <url>/2023/08549388833c/index.html</url>
    <content><![CDATA[<h2 id="ä¸»è¦å†…å®¹"><a href="#ä¸»è¦å†…å®¹" class="headerlink" title="ä¸»è¦å†…å®¹"></a>ä¸»è¦å†…å®¹</h2><p><code>java</code>å†…å­˜æ¨¡å‹å®é™…ä¸Šæ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œæ˜¯ä¸€å¥—è§„èŒƒï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå®é™…çš„ä¸œè¥¿ï¼Œè€Œ<code>java</code>å†…å­˜ç»“æ„å°±æ˜¯æ ¹æ®è¿™ä¸€å¥—è§„èŒƒæ¥è¿›è¡Œåˆ’åˆ†çš„ã€‚</p>
<span id="more"></span>

<p>å¯¹äº<code>java</code>å†…å­˜æ¨¡å‹æˆ‘ä»¬ä¸»è¦éœ€è¦äº†è§£ä»¥ä¸‹å‡ ä¸ªå†…å®¹ï¼š</p>
<ul>
<li>ç¡¬ä»¶å†…å­˜æ¶æ„</li>
<li>çº¿ç¨‹å’Œ<code>jvm</code></li>
<li><code>java</code>å†…å­˜æ¨¡å‹</li>
<li><code>java</code>å†…å­˜æ¨¡å‹å¯¹å¹¶å‘ç¼–ç¨‹çš„æ”¯æŒ</li>
</ul>
<h2 id="ç¡¬ä»¶å†…å­˜æ¶æ„"><a href="#ç¡¬ä»¶å†…å­˜æ¶æ„" class="headerlink" title="ç¡¬ä»¶å†…å­˜æ¶æ„"></a>ç¡¬ä»¶å†…å­˜æ¶æ„</h2><blockquote>
<p>ç‰©ç†æœºé‡åˆ°çš„å¹¶å‘é—®é¢˜ä¸è™šæ‹Ÿæœºä¸­çš„æƒ…å†µæœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„ï¼Œç‰©ç†æœºå¯¹å¹¶å‘çš„å¤„ç†æ–¹æ¡ˆå¯¹è™šæ‹Ÿæœºçš„å®ç°ä¹Ÿæœ‰ç›¸å½“å¤§çš„å‚è€ƒæ„ä¹‰</p>
</blockquote>
<p>åœ¨è®¡ç®—æœºæ¨¡å‹ä¸­ä¸»è¦æ˜¯æœ‰äº”ä¸ªéƒ¨åˆ†æ¥ç»„æˆçš„</p>
<ol>
<li>è¾“å…¥</li>
<li>å¯„å­˜å™¨</li>
<li>cpu<ol>
<li>å¤„ç†å™¨</li>
<li>æ§åˆ¶å™¨</li>
</ol>
</li>
<li>è¾“å‡º</li>
</ol>
<p>å…¶ä¸­<strong>å¤„ç†å™¨</strong>å’Œ<strong>æ§åˆ¶å™¨</strong>åˆèµ·æ¥å°±æ˜¯æˆ‘ä»¬æ‰€ç¤ºçš„<code>cpu</code></p>
<p>è¿ç®—å™¨çš„è¿ç®—é€Ÿåº¦éƒ½æ˜¯å¾ˆå¿«çš„ï¼Œä½†æ˜¯æˆ‘ä»¬çš„æ•°æ®å­˜å‚¨ä¸å¯èƒ½æ‰€æœ‰æ•°æ®éƒ½å­˜æ”¾åœ¨å¯„å­˜å™¨ä¸­ï¼Œæ‰€ä»¥æ•°æ®çš„<code>io</code>æ“ä½œéƒ½æ˜¯å¾ˆæœ‰å¿…è¦ çš„ï¼Œè¿™æ ·å°±ä¸èƒ½å……åˆ†åˆ©ç”¨<code>cpu</code>çš„è¿ç®—èƒ½åŠ›ï¼Œæ­¤æ—¶å°±éœ€è¦<strong>åŠ ä¸Šè¯»å†™é€Ÿåº¦å’Œå¤„ç†å™¨è¿ç®—é€Ÿåº¦å·®ä¸å¤šçš„çš„é«˜é€Ÿç¼“å­˜</strong>æ¥ä½œä¸º<strong>å†…å­˜å’Œå¤„ç†å™¨ä¹‹é—´</strong>çš„ç¼“å†²ã€‚å°†è¿ç®—éœ€è¦ä½¿ç”¨çš„æ•°æ®å¤åˆ¶åˆ°ç¼“å­˜ä¸­ï¼Œè®©è¿ç®—èƒ½å¿«é€Ÿè¿›è¡Œï¼Œå½“è¿ç®—ç»“æŸåå†ä»ç¼“å­˜åŒæ­¥å›å†…å­˜ä¹‹ä¸­ï¼Œè¿™æ ·å¤„ç†å™¨å°±æ— é¡»ç­‰å¾…ç¼“æ…¢çš„å†…å­˜è¯»å†™äº†ã€‚</p>
<h3 id="ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜"><a href="#ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜"></a>ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜</h3><p>ä¸Šé¢åŠ ä¸Šäº†ç¼“å­˜å¯ä»¥è§£å†³å†…å­˜çš„è¯»å†™é€Ÿåº¦èµ¶ä¸ä¸Šå¤„ç†å™¨çš„è¿ç®—é€Ÿåº¦é—®é¢˜ï¼Œä½†æ˜¯åˆå‡ºç°äº†å¦å¤–ä¸€ä¸ªé—®é¢˜ã€‚<strong>ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜</strong></p>
<p>å› ä¸º åœ¨å¤šå¤„ç†å™¨ä¸­ï¼Œæ¯ä¸€ä¸ªå¤„ç†å™¨éƒ½æœ‰è‡ªå·±çš„é«˜é€Ÿç¼“å­˜ï¼Œä½†æ˜¯å†…å­˜æ˜¯åªæœ‰ä¸€ä¸ªã€‚å¯¹äºç¼“å­˜ä¸€è‡´æ€§é—®é¢˜åœ¨ç¡¬ä»¶å±‚é¢ä¸»è¦æœ‰ä¸¤ä¸ªè§£å†³æ–¹å¼</p>
<ul>
<li><p>æ€»çº¿åŠ é”</p>
<ul>
<li>æ‰€è°“çš„æ€»çº¿åŠ é”å°±æ¯ä¸€æ¬¡éƒ½ä¼šé”å®šä¸€ä¸ª<code>cpu</code>ï¼Œåªæœ‰è¿™ä¸ªé”å®šçš„<code>cpu</code>æ‰å¯ä»¥æ‰§è¡Œï¼Œå…¶ä½™çš„<code>cpu</code>æ˜¯ä¸èƒ½æ‰§è¡Œçš„ã€‚è¿™ç§æ–¹å¼ä¼šé™ä½<code>cpu</code>çš„ååé‡ã€‚</li>
</ul>
</li>
<li><p>ä½¿ç”¨ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œæ‰€è°“ä½¿ç”¨ç¼“å­˜ä¸€è‡´æ€§åè®®ä¹Ÿå°±æ˜¯åœ¨ç¼“å­˜å’Œä¸»å†…å­˜ä¹‹é—´åŠ ä¸Šä¸€ä¸ªè®¿é—®è§„åˆ™ï¼Œé€šè¿‡è¿™ç§è§„åˆ™æ¥è§£å†³ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚</p>
</li>
</ul>
<pre class="mermaid">graph LR
  A-->B
  subgraph A[å¤„ç†å™¨]
    direction TB
    A1[å¤„ç†å™¨1]~~~A2[å¤„ç†å™¨2]~~~A3[å¤„ç†å™¨3]
  end
  subgraph B[é«˜é€Ÿç¼“å­˜]
    direction TB
    B1[ç¼“å­˜1]~~~B2[ç¼“å­˜2]~~~B3[ç¼“å­˜3]
  end
  B-->C
  C[ç¼“å­˜ä¸€è‡´æ€§]-->D[ä¸»å†…å­˜]</pre>
<p>è¿™é‡Œçš„<strong>ç¼“å­˜ä¸€è‡´æ€§å…¶å®æ˜¯ä¸€ä¸ªåè®®</strong>ï¼Œæ˜¯å¤„ç†ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜çš„ä¸€ä¸ªåè®®(ä¹Ÿå¯ä»¥ä»»è®¤ä¸ºæ˜¯å¤„ç†ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜çš„ä¸€ä¸ªç†è®ºåŸºç¡€)ã€‚</p>
<h2 id="javaå†…å­˜æ¨¡å‹-java-memory-mode"><a href="#javaå†…å­˜æ¨¡å‹-java-memory-mode" class="headerlink" title="javaå†…å­˜æ¨¡å‹(java memory mode)"></a>javaå†…å­˜æ¨¡å‹(java memory mode)</h2><h3 id="ä»€ä¹ˆæ˜¯javaå†…å­˜æ¨¡å‹-JMMè§„èŒƒ"><a href="#ä»€ä¹ˆæ˜¯javaå†…å­˜æ¨¡å‹-JMMè§„èŒƒ" class="headerlink" title="ä»€ä¹ˆæ˜¯javaå†…å­˜æ¨¡å‹(JMMè§„èŒƒ)"></a>ä»€ä¹ˆæ˜¯<code>java</code>å†…å­˜æ¨¡å‹(JMMè§„èŒƒ)</h3><p><strong><code>java</code>å†…å­˜æ¨¡å‹å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªç†è®ºä¸Šçš„ä¸œè¥¿ï¼Œæ˜¯ä¸€ä¸ªè§„èŒƒï¼Œè¿™ä¸ªè§„èŒƒçš„ä¸»è¦ç›®çš„æ˜¯å®šä¹‰ç¨‹åºä¸­å„ç§å˜é‡çš„è®¿é—®è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯å…³æ³¨çš„æ˜¯è™šæ‹Ÿæœºä¸­æŠŠå˜é‡å€¼å­˜å‚¨åˆ°å†…å­˜å’Œä»å†…å­˜ä¸­å–å‡ºå˜é‡å€¼è¿™æ ·çš„åº•å±‚ç»†èŠ‚ã€‚</strong>æ­¤å¤„çš„å˜é‡å’Œ<code>java</code>ç¼–ç¨‹ä¸­çš„å˜é‡æ˜¯ä¸åŒçš„ï¼Œè¿™é‡Œçš„å˜é‡åŒ…å«äº†å®ä¾‹å­—æ®µï¼Œé™æ€å­—æ®µå’Œæ„æˆæ•°ç»„å¯¹è±¡çš„å…ƒç´ ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬å±€éƒ¨å˜é‡å’Œæ–¹æ³•å‚æ•°ã€‚ï¼ˆä¸Šé¢è¿™æ®µè¯æ˜¯ã€Šæ·±å…¥ç†è§£javaè™šæ‹Ÿæœºã€‹è¿™æœ¬ä¹¦ä¸­çš„ï¼‰</p>
<p><code>jvm</code>å°†å†…å­˜ç»„ç»‡ç»“æ„ä¸»è¦åˆ’åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†</p>
<ul>
<li>ä¸»å†…å­˜</li>
<li>å·¥ä½œå†…å­˜</li>
</ul>
<pre class="mermaid">graph LR
  A-->B
  subgraph A[javaçº¿ç¨‹]
    direction TB
    A1[çº¿ç¨‹1]~~~A2[çº¿ç¨‹2]~~~A3[çº¿ç¨‹3]
  end
  subgraph B[å·¥ä½œå†…å­˜]
    direction TB
    B1[å·¥ä½œå†…å­˜1]~~~B2[å·¥ä½œå†…å­˜2]~~~B3[å·¥ä½œå†…å­˜3]
  end
  B-->C
  C[saveå’Œloadæ“ä½œ]-->D[ä¸»å†…å­˜]</pre>

<h4 id="ä¸»å†…å­˜"><a href="#ä¸»å†…å­˜" class="headerlink" title="ä¸»å†…å­˜"></a>ä¸»å†…å­˜</h4><ul>
<li>ä¸»è¦åŒ…å«æœ¬åœ°æ–¹æ³•åŒºå’Œå †</li>
<li>æ‰€æœ‰å˜é‡éƒ½è¦å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼Œè¿™äº›å˜é‡å¯¹äºæ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯å…±äº«çš„</li>
</ul>
<h4 id="å·¥ä½œå†…å­˜"><a href="#å·¥ä½œå†…å­˜" class="headerlink" title="å·¥ä½œå†…å­˜"></a>å·¥ä½œå†…å­˜</h4><ul>
<li>æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹å·¥ä½œçš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯å·¥ä½œå†…å­˜</li>
<li>å·¥ä½œå†…å­˜ä¸­ä¿å­˜çš„æ˜¯ä¸»å†…å­˜ä¸­æŸäº›å˜é‡çš„æ‹·è´ï¼Œçº¿ç¨‹å †å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œä¸èƒ½ç›´æ¥æ“ä½œä¸»å†…å­˜</li>
<li><strong>å¦‚æœæ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œé‚£ä¹ˆç›´æ¥åˆ†é…åˆ°å·¥ä½œå†…å­˜ï¼Œå¦‚æœæ˜¯å¼•ç”¨ç±»å‹ï¼Œå¼•ç”¨çš„åœ°å€å­˜åœ¨åœ¨å·¥ä½œç©ºé—´ä¸­ï¼Œä½†æ˜¯å…·ä½“çš„å¯¹è±¡æ˜¯å­˜åœ¨åœ¨å †ä¸­(ä¹Ÿå°±æ˜¯ä¸»å†…å­˜ä¸­)ï¼Œæ˜¯å¯ä»¥å…±äº«çš„</strong></li>
</ul>
<pre class="mermaid">graph LR
  subgraph B[javaçº¿ç¨‹]
    direction BT
    B1[çº¿ç¨‹2]-->B2[å·¥ä½œå†…å­˜2]
    B2-->B1
  end
  subgraph A[javaçº¿ç¨‹]
    direction BT
    A1[çº¿ç¨‹1]-->A2[å·¥ä½œå†…å­˜1]
    A2-->A1
  end
  C[ä¸»å†…å­˜]
  A & B --> C
  C --> A & B</pre>

<p>çœ‹ä¸Šå›¾ï¼Œä¹‹æ‰€ä»¥å­˜åœ¨<code>java</code>å†…å­˜æ¨¡å‹ä¸€è¯´æ˜¯å› ä¸º<code>java</code>è™šæ‹Ÿæœºçš„å·¥ä½œæœºåˆ¶ã€‚å½“æœ‰å¤šä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ“ä½œçš„æ•°æ®æœ‰ä¸¤ç§ç±»å‹</p>
<ul>
<li>çº¿ç¨‹ç§æœ‰çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªæ•°æ®å°±ç®—æ”¹å˜äº†ä¹Ÿä¸ä¼šå½±å“å…¶ä½™çº¿ç¨‹ï¼Œæ¯”å¦‚è¯´å±€éƒ¨å˜é‡å°±æ˜¯çº¿ç¨‹ç§æœ‰çš„æ•°æ®</li>
<li>çº¿ç¨‹å…±äº«çš„æ•°æ®ï¼Œè¿™æ ·çš„æ•°æ®å¤šä¸ªçº¿ç¨‹éƒ½å¯ä»¥è®¿é—®ï¼Œå°±ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨çš„é—®é¢˜</li>
</ul>
<p>å› ä¸ºçº¿ç¨‹æ“ä½œçš„æ•°æ®æœ‰ä¸åŒç±»å‹ï¼Œæ‰€ä»¥åœ¨<code>java</code>ä¸­ä¸€ä¸ªçº¿ç¨‹å»æ“ä½œæ•°æ®çš„æ—¶å€™ä¸æ˜¯åœ¨ä¸»å†…å­˜ä¸­ç›´æ¥æ“ä½œï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªå±äºçº¿ç¨‹è‡ªå·±çš„å†…å­˜(å·¥ä½œå†…å­˜)ï¼Œå½“æ“ä½œçº¿ç¨‹ç§æœ‰çš„æ•°æ®æ¯”è¾ƒå¥½ç†è§£ï¼Œç›´æ¥åœ¨å·¥ä½œå†…å­˜ä¸­å®Œæˆå°±å¯ä»¥å’¯ï¼Œå¦‚æœæ˜¯æ“ä½œå…±äº«çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±åœ¨ä¸»å†…å­˜ä¸­æ‹¿ä¸€ä»½æ•°æ®åˆ°è‡ªå·±å·¥ä½œå†…å­˜ä¸­æ“ä½œï¼Œæ“ä½œå®Œäº†å†å°†æ•°æ®ç»™åˆ°ä¸»å†…å­˜ä¸­ã€‚</p>
<h3 id="å†…å­˜ç»“æ„å’Œå†…å­˜æ¨¡å‹çš„å…³ç³»"><a href="#å†…å­˜ç»“æ„å’Œå†…å­˜æ¨¡å‹çš„å…³ç³»" class="headerlink" title="å†…å­˜ç»“æ„å’Œå†…å­˜æ¨¡å‹çš„å…³ç³»"></a>å†…å­˜ç»“æ„å’Œå†…å­˜æ¨¡å‹çš„å…³ç³»</h3><p>ä¸Šé¢è¯´äº†ä»€ä¹ˆæ˜¯<code>java</code>çš„å†…å­˜æ¨¡å‹ï¼ŒçŸ¥é“<code>java</code>å†…å­˜æ¨¡å‹æ˜¯ä¸€ä¸ªè§„èŒƒï¼Œå®šä¹‰çš„æ˜¯ç¨‹åºä¸­å˜é‡çš„è®¿é—®è§„åˆ™ï¼Œé‚£ä¹ˆè¿™ä¸ªå†…å­˜æ¨¡å‹å’Œæˆ‘ä»¬å¹³æ—¶æ‰€æœ‰çš„å†…å­˜ç»“æ„æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿå…ˆçœ‹ä¸€ä¸‹<code>java</code>å†…å­˜ç»“æ„</p>
<h4 id="javaå†…å­˜ç»“æ„"><a href="#javaå†…å­˜ç»“æ„" class="headerlink" title="javaå†…å­˜ç»“æ„"></a>javaå†…å­˜ç»“æ„</h4><p><code>java</code>ä¸­å†…å­˜ç»“æ„ä¸»è¦æ˜¯æœ‰äº”ä¸ªéƒ¨åˆ†</p>
<ul>
<li>ç¨‹åºè®¡æ•°å™¨</li>
<li>å †</li>
<li>è™šæ‹Ÿæœºæ ˆ<ul>
<li>å­˜æ”¾æ–¹æ³•è¿è¡Œæ—¶æ‰€éœ€çš„æ•°æ®ï¼Œæˆä¸ºæ ˆå¸§</li>
</ul>
</li>
<li>æœ¬åœ°æ–¹æ³•æ ˆ</li>
<li>æ–¹æ³•åŒº<ul>
<li>å­˜å‚¨è¿è¡Œæ—¶å¸¸é‡æ± ã€å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ï¼Œå³æ—¶ç¼–è¯‘åçš„ä»£ç ç­‰</li>
</ul>
</li>
</ul>
<p>ä¸Šé¢<code>java</code>çš„äº”ä¸ªéƒ¨åˆ†å…¶å®å°±æ˜¯æ ¹æ®<code>JMM</code>è§„èŒƒ(<code>java</code>å†…å­˜æ¨¡å‹)æ¥åˆ’åˆ†çš„ä¸€ä¸ªå†…å­˜ç»“æ„ã€‚</p>
<h2 id="å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹æ€§"><a href="#å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹æ€§" class="headerlink" title="å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹æ€§"></a>å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹æ€§</h2><h3 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h3><p>æ‰§è¡Œçš„æ“ä½œä¸å¯åˆ†å‰²ï¼Œå¯ä»¥ç†è§£ä¸ºå°±æ˜¯ä¸€æ­¥æ“ä½œï¼Œå› ä¸ºåªæœ‰ä¸€æ­¥æ‰€ä»¥è‚¯å®šæ˜¯ä¸èƒ½åˆ†å‰²çš„</p>
<h3 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h3><p>çº¿ç¨‹éƒ½æ˜¯æœ‰è‡ªå·±çš„å·¥ä½œç©ºé—´çš„ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½åªèƒ½æ“ä½œè‡ªå·±å·¥ä½œç©ºé—´çš„æ•°æ®ï¼Œåˆ«çš„çº¿ç¨‹æ˜¯çœ‹ä¸åˆ°è‡ªå·±çº¿ç¨‹çš„å·¥ä½œç©ºé—´çš„æ•°æ®çš„</p>
<h3 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="headerlink" title="æœ‰åºæ€§"></a>æœ‰åºæ€§</h3><p>ç¨‹åºä¸­ä»£ç çš„é¡ºåºä¸ä¸€å®šå°±æ˜¯åœ¨<code>cpu</code>ä¸­æ‰§è¡Œçš„é¡ºåºï¼Œå› ä¸ºå­˜åœ¨ä¸¤ç§é‡æ’</p>
<ul>
<li>ç¼–è¯‘é‡æ’åº(ç¼–è¯‘æœŸ)</li>
<li>æŒ‡ä»¤é‡æ’åº(è¿è¡ŒæœŸ)</li>
</ul>
<h2 id="JMMè§„èŒƒæ˜¯å¦‚ä½•ä¿è¯å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹å¾çš„å‘¢"><a href="#JMMè§„èŒƒæ˜¯å¦‚ä½•ä¿è¯å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹å¾çš„å‘¢" class="headerlink" title="JMMè§„èŒƒæ˜¯å¦‚ä½•ä¿è¯å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹å¾çš„å‘¢"></a>JMMè§„èŒƒæ˜¯å¦‚ä½•ä¿è¯å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹å¾çš„å‘¢</h2><h3 id="JMMå’ŒåŸå­æ€§"><a href="#JMMå’ŒåŸå­æ€§" class="headerlink" title="JMMå’ŒåŸå­æ€§"></a><code>JMM</code>å’ŒåŸå­æ€§</h3><h4 id="åŸå­æ€§æ¡ˆä¾‹1"><a href="#åŸå­æ€§æ¡ˆä¾‹1" class="headerlink" title="åŸå­æ€§æ¡ˆä¾‹1"></a>åŸå­æ€§æ¡ˆä¾‹1</h4><p><code>X = 10</code>è¿™æ ·ä¸€ä¸ªæ“ä½œå…·æœ‰åŸå­æ€§ä¹ˆï¼Ÿ</p>
<ul>
<li>å¦‚æœ<code>X</code>æ˜¯ç§æœ‰æ•°æ®ï¼Œæ˜¯åˆ†é…åˆ°å·¥ä½œç©ºé—´çš„ï¼Œé‚£ä¹ˆå°±æ˜¯æœ‰åŸå­æ€§çš„ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªå†™çš„æ“ä½œ</li>
<li>å¦‚æœ<code>X</code>æ˜¯å…±äº«çš„æ•°æ®ï¼Œå°±æ˜¯åœ¨ä¸»å†…å­˜ä¸­ï¼Œè¿™æ ·å°±éœ€è¦å…ˆåœ¨ä¸»å†…å­˜ä¸­è¯»å–(å¤åˆ¶)åˆ°å·¥ä½œç©ºé—´ä¸­ï¼Œä¿®æ”¹å®Œæˆåå†å°†æ•°æ®é€šè¿‡åˆ°ä¸»å†…å­˜ä¸­ï¼Œè¿™æ ·å°±æ˜¯ä¸¤æ­¥ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰åŸå­æ€§</li>
</ul>
<h4 id="åŸå­æ€§æ¡ˆä¾‹2"><a href="#åŸå­æ€§æ¡ˆä¾‹2" class="headerlink" title="åŸå­æ€§æ¡ˆä¾‹2"></a>åŸå­æ€§æ¡ˆä¾‹2</h4><p><code>i++</code>è¿™ä¸ªæ“ä½œå…·æœ‰åŸå­æ€§ä¹ˆï¼Ÿ</p>
<p><code>i++</code>è¿™ä¸ªæ“ä½œå…¶å®æ˜¯éœ€è¦åˆ†ä¸ºä¸‹é¢è¿™å‡ ä¸ªæ­¥éª¤çš„</p>
<ul>
<li>è¯»å–<code>i</code>çš„å€¼</li>
<li>å°†<code>i</code>çš„å€¼åŠ ä¸€</li>
<li>å°†ä¿®æ”¹åçš„å€¼èµ‹å€¼ç»™<code>i</code></li>
</ul>
<p>å¯ä»¥çœ‹åˆ°æ¯ä¸€æ­¥éƒ½æ˜¯åŸå­æ“ä½œï¼Œä½†æ˜¯è¿™ä¸‰ä¸ªåŸå­æ“ä½œåˆåœ¨ä¸€èµ·ä¹‹åå»ä¸æ˜¯åŸå­æ“ä½œäº†</p>
<h4 id="JMMå¦‚ä½•ä¿è¯åŸå­æ€§çš„"><a href="#JMMå¦‚ä½•ä¿è¯åŸå­æ€§çš„" class="headerlink" title="JMMå¦‚ä½•ä¿è¯åŸå­æ€§çš„"></a>JMMå¦‚ä½•ä¿è¯åŸå­æ€§çš„</h4><ul>
<li>ä½¿ç”¨<code>Synchronized</code>å…³é”®å­—</li>
<li>ä½¿ç”¨<code>JUC</code>çš„<code>lock</code>å’Œ<code>unlock</code>å…³é”®å­—</li>
</ul>
<h3 id="JMMå’Œå¯è§æ€§"><a href="#JMMå’Œå¯è§æ€§" class="headerlink" title="JMMå’Œå¯è§æ€§"></a><code>JMM</code>å’Œå¯è§æ€§</h3><p>çº¿ç¨‹æ˜¯ä¸èƒ½æ“ä½œä¸»å†…å­˜ä¸­çš„æ•°æ®çš„ï¼Œåªèƒ½æ“ä½œè‡ªå·±çš„å·¥ä½œç©ºé—´çš„æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦æ•°æ®æ—¶ä¼šå…ˆå»å·¥ä½œç©ºé—´æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°äº†å°±ä¼šä½¿ç”¨å·¥ä½œç©ºé—´ä¸­çš„æ•°æ®ï¼Œæ‰¾ä¸åˆ°æ‰ä¼šä»ä¸»å†…å­˜ä¸­æ‰¾ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œç©ºé—´æ‰¾åˆ°äº†ï¼Œä¸è¿‡è¿™ä¸ªæ•°æ®åœ¨åˆ«çš„çº¿ç¨‹ä¸­å·²ç»ä¿®æ”¹äº†ï¼Œå¹¶ä¸”åˆ·æ–°åˆ°ä¸»å†…ä¸­äº†ï¼Œç”±äºå½“å‰çº¿ç¨‹çš„å·¥ä½œç©ºé—´ä¸­æœ‰è¿™ä¸ªæ•°æ®ï¼Œæ²¡æœ‰åœ¨ä¸»å†…å­˜ä¸­æ‹¿ï¼Œè¿™æ ·å½“å‰çº¿ç¨‹æ‹¿åˆ°çš„å°±ä¸æ˜¯æœ€æ–°çš„æ•°æ®ã€‚<code>JMM</code>æ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿ</p>
<h4 id="JMMå¦‚ä½•ä¿è¯å¯è§æ€§çš„"><a href="#JMMå¦‚ä½•ä¿è¯å¯è§æ€§çš„" class="headerlink" title="JMMå¦‚ä½•ä¿è¯å¯è§æ€§çš„"></a><code>JMM</code>å¦‚ä½•ä¿è¯å¯è§æ€§çš„</h4><ul>
<li><code>Volatile</code>å…³é”®å­—ï¼Œä½¿ç”¨è¿™ä¸ªå…³é”®å­—åï¼Œå½“çº¿ç¨‹éœ€è¦ä½¿ç”¨è¿™ä¸ªå…³é”®å­—ä¿®é¥°çš„æ•°æ®æ—¶ï¼Œæ¯ä¸€æ¬¡éƒ½ä¼šä»ä¸»å†…å­˜ä¸­å»æ‰¾æ•°æ®ï¼Œè€Œä¸æ˜¯ä»å·¥ä½œç©ºé—´ä¸­æ‰¾ã€‚</li>
<li><code>JUC</code>  å¯ä»¥ä½¿ç”¨<code>JUC</code>çš„<code>lock</code>å’Œ<code>unlock</code></li>
</ul>
<h3 id="JMMå’Œæœ‰åºæ€§-é‡æ’åº"><a href="#JMMå’Œæœ‰åºæ€§-é‡æ’åº" class="headerlink" title="JMMå’Œæœ‰åºæ€§(é‡æ’åº)"></a><code>JMM</code>å’Œæœ‰åºæ€§(é‡æ’åº)</h3><p>å¯¹äºæœ‰åºæ€§é—®é¢˜å¯ä»¥ä½¿ç”¨ä¸‹é¢ä¸¤ç§æ–¹å¼æ¥è§£å†³</p>
<ul>
<li>ä½¿ç”¨<code>Volatile</code>å…³é”®å­—</li>
<li>ä½¿ç”¨<code>Synchronized</code>æ¥åŠ é”</li>
</ul>
]]></content>
      <categories>
        <category>java</category>
        <category>jvm</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>jvmåƒåœ¾å›æ”¶</title>
    <url>/2023/63d242ce6cb3/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p>ä»¥ä¸‹å†…å®¹å‚è€ƒã€Šå‰‘æŒ‡JVM:è™šæ‹Ÿæœºå®è·µä¸æ€§èƒ½è°ƒä¼˜ã€‹</p>
<blockquote>
<p>Javaä½¿ç”¨çš„æ˜¯è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œæœ‰å†…å­˜åˆ†é…å™¨å’Œåƒåœ¾æ”¶é›†å™¨æ¥ä»£ä¸ºåˆ†é…å’Œå›æ”¶å†…å­˜ã€‚è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ä½¿å¼€å‘äººå‘˜æ— é¡»å‚ä¸å†…å­˜çš„åˆ†é…å’Œå›æ”¶,è‡ªåŠ¨å†…å­˜ç®¡ç†å°±åƒä¸€ä¸ªé»‘åŒ£å­,æ‰€ä»¥äº†è§£JVMçš„è‡ªåŠ¨å†…å­˜åˆ†é…å’Œåƒåœ¾æ”¶é›†æœºåˆ¶å°±æ˜¾å¾—éå¸¸é‡è¦</p>
</blockquote>
<h2 id="å“ªäº›å¯¹è±¡æ˜¯åƒåœ¾"><a href="#å“ªäº›å¯¹è±¡æ˜¯åƒåœ¾" class="headerlink" title="å“ªäº›å¯¹è±¡æ˜¯åƒåœ¾"></a>å“ªäº›å¯¹è±¡æ˜¯åƒåœ¾</h2><p>æ—¢ç„¶æ˜¯è®²è§£åƒåœ¾å›æ”¶ï¼Œè‡ªç„¶éœ€è¦å…ˆå¼„æ¸…æ¥šä»€ä¹ˆæ ·çš„å¯¹è±¡æ‰æ˜¯åƒåœ¾</p>
<h3 id="å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¼•ç”¨è®¡æ•°æ³•"><a href="#å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¼•ç”¨è®¡æ•°æ³•" class="headerlink" title="å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¼•ç”¨è®¡æ•°æ³•"></a>å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¼•ç”¨è®¡æ•°æ³•</h3><ol>
<li>å¼•ç”¨è®¡æ•°ç®—æ³•æ¯”è¾ƒç®€å•ï¼Œå¯¹æ¯ä¸ªå¯¹è±¡ä¿å­˜ä¸€ä¸ªæ•´å‹çš„å¼•ç”¨è®¡æ•°å™¨å±æ€§ï¼Œç”¨äºè®°å½•å¯¹è±¡è¢«å¼•ç”¨çš„æ¬¡æ•°ï¼ˆå®ç°æ–¹å¼ï¼‰</li>
<li>å¼•ç”¨è®¡æ•°ç®—æ³•çš„ä¼˜ç‚¹æ˜¯å®ç°ç®€å•ï¼Œåƒåœ¾å¯¹è±¡ä¾¿äºè¾¨è¯†ï¼Œåˆ¤å®šæ•ˆç‡é«˜ï¼Œå›æ”¶æ²¡æœ‰å»¶è¿Ÿæ€§ï¼ˆä¼˜ç‚¹ï¼‰</li>
<li>æ¯ä¸ªå¯¹è±¡éœ€è¦å•ç‹¬çš„å­—æ®µå­˜å‚¨è®¡æ•°å™¨ï¼Œè¿™æ ·çš„åšæ³•å¢åŠ äº†å­˜å‚¨ç©ºé—´çš„å¼€é”€ï¼ˆç¼ºç‚¹ï¼‰</li>
<li>å¼•ç”¨è®¡æ•°å™¨æœ‰ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œå³æ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨çš„æƒ…å†µï¼ˆä¸¥é‡çš„ç¼ºç‚¹ï¼‰</li>
</ol>
<h4 id="å¾ªç¯å¼•ç”¨ç¤ºä¾‹"><a href="#å¾ªç¯å¼•ç”¨ç¤ºä¾‹" class="headerlink" title="å¾ªç¯å¼•ç”¨ç¤ºä¾‹"></a>å¾ªç¯å¼•ç”¨ç¤ºä¾‹</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObjOne</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> ObjTwo objTwo;</span><br><span class="line">    <span class="comment">// çœç•¥setï¼Œget</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObjTwo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> ObjOne objOne;</span><br><span class="line">    <span class="comment">// çœç•¥setï¼Œget</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> test &#123;</span><br><span class="line">    <span class="type">ObjOne</span> <span class="variable">objOne</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjOne</span>();</span><br><span class="line">    <span class="type">ObjTwo</span> <span class="variable">objTwo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjTwo</span>();</span><br><span class="line">    objOne.setObjTwo(objTwo);</span><br><span class="line">    objTwo.setObjOne(objOne);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç æ‰§è¡Œå®Œæˆå †æ ˆå¦‚æœæ‰€ç¤º</p>
<pre class="mermaid">flowchart LR
  subgraph A[æ ˆ]
    A1["objOne"]
    A2["objTwo"]
  end
  subgraph B[å †]
    subgraph B1["ObjOne"]
      style B1 fill:#70b224
      B11[objTwo]
      style B11 fill:#f9f
    end
    subgraph B2["ObjTwo"]
      style B2 fill:#70b224
      B21[objOne]
      style B21 fill:#f9f
    end
    
    B11-->B21
    B21-->B11
  end
  A1-->B1
  A2-->B2</pre>
<p>å½“æ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼Œå †æ ˆå¼•ç”¨æƒ…å†µä¼šæ”¹å˜</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> test &#123;</span><br><span class="line">    <span class="type">ObjOne</span> <span class="variable">objOne</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjOne</span>();</span><br><span class="line">    <span class="type">ObjTwo</span> <span class="variable">objTwo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjTwo</span>();</span><br><span class="line">    objOne.setObjTwo(objTwo);</span><br><span class="line">    objTwo.setObjOne(objOne);</span><br><span class="line">    objOne = <span class="literal">null</span>;</span><br><span class="line">    objTwo = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre class="mermaid">flowchart LR
  subgraph A[æ ˆ]
    A1["objOne"]
    A2["objTwo"]
  end
  subgraph B[å †]
    subgraph B1["ObjOne"]
      style B1 fill:#70b224
      B11[objTwo]
      style B11 fill:#f9f
    end
    subgraph B2["ObjTwo"]
      style B2 fill:#70b224
      B21[objOne]
      style B21 fill:#f9f
    end
    
    B11-->B21
    B21-->B11
  end
  A1-. "X" .->B1
  A2-. "X" .->B2</pre>
<p>å¯ä»¥çœ‹åˆ°æ ˆåˆ°å †ä¸­çš„å¼•ç”¨è™½ç„¶æ–­å¼€äº†ï¼Œä½†æ˜¯å„è‡ªå¯¹è±¡å±æ€§ä¸Šé¢çš„è¿æ¥ä¾ç„¶æ²¡æœ‰æ–­å¼€</p>
<h3 id="å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¯è¾¾æ€§åˆ†æç®—æ³•"><a href="#å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¯è¾¾æ€§åˆ†æç®—æ³•" class="headerlink" title="å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¯è¾¾æ€§åˆ†æç®—æ³•"></a>å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¯è¾¾æ€§åˆ†æç®—æ³•</h3><ol>
<li>å¯è¾¾æ€§åˆ†æç®—æ³•æ˜¯ä»¥ <code>GC Root</code> ä¸ºèµ·å§‹ç‚¹ï¼Œæš—è—ä»ä¸Šåˆ°ä¸‹çš„æ–¹å¼æœç´¢è¢«è·Ÿå¯¹è±¡é›†åˆæ‰€è¿æ¥çš„å¯¹è±¡æ˜¯å¦å¯è¾¾</li>
</ol>
<h3 id="GC-Root-åŒ…å«ä»¥ä¸‹å†…å®¹"><a href="#GC-Root-åŒ…å«ä»¥ä¸‹å†…å®¹" class="headerlink" title="GC Root åŒ…å«ä»¥ä¸‹å†…å®¹"></a>GC Root åŒ…å«ä»¥ä¸‹å†…å®¹</h3><ol>
<li>è™šæ‹Ÿæœºæ ˆä¸­å¯¹è±¡çš„å¼•ç”¨ï¼Œæ¯”å¦‚ï¼Œå„ä¸ªçº¿ç¨‹è¢«è°ƒç”¨çš„æ–¹æ³•ä¸­ä½¿ç”¨åˆ°çš„å¼•ç”¨æ•°æ®ç±»å‹çš„å‚æ•°ã€å±€éƒ¨å˜é‡ç­‰</li>
<li>æœ¬åœ°æ–¹æ³•æ ˆå†…JNIï¼ˆæœ¬åœ°æ–¹æ³•ï¼‰å¯¹è±¡çš„å¼•ç”¨</li>
<li>æ–¹æ³•åŒºä¸­å¼•ç”¨æ•°æ®ç±»å‹çš„é™æ€å˜é‡</li>
<li>æ–¹æ³•åŒºä¸­å¸¸é‡å¯¹è±¡çš„å¼•ç”¨ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²å¸¸é‡æ± <code>(String Table)</code>é‡Œçš„å¼•ç”¨</li>
<li>æ‰€æœ‰è¢«åŒæ­¥é”<code>synchronized</code>æŒæœ‰çš„å¯¹è±¡å¼•ç”¨</li>
<li><code>JVM</code>å†…éƒ¨çš„å¼•ç”¨ã€‚åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„Classå¯¹è±¡å¼•ç”¨ï¼Œä¸€äº›å¸¸é©»çš„å¼‚å¸¸å¯¹è±¡å¼•ç”¨ï¼ˆå¦‚<code>NullPointerException</code>ã€<code>OutOfMemoryError</code>ï¼‰ï¼Œç³»ç»Ÿç±»åŠ è½½å™¨å¯¹è±¡å¼•ç”¨ç­‰</li>
</ol>
<h2 id="åƒåœ¾å›æ”¶çš„åŒºåŸŸ"><a href="#åƒåœ¾å›æ”¶çš„åŒºåŸŸ" class="headerlink" title="åƒåœ¾å›æ”¶çš„åŒºåŸŸ"></a>åƒåœ¾å›æ”¶çš„åŒºåŸŸ</h2><p>æ ¹æ® <ol><li><a href="/2023/70e7b048ccf4/index.html" title="jvmè¿è¡Œæ—¶å†…å­˜åŒºåŸŸ">jvmè¿è¡Œæ—¶å†…å­˜åŒºåŸŸ</a></li></ol> å¯çŸ¥ï¼Œ<code>jvm</code>è¿è¡Œæ—¶æ•°æ®åŒºä¸»è¦åŒ…å«ä¸¤å¤§ç±»</p>
<ol>
<li>çº¿ç¨‹ç§æœ‰çš„åŒºåŸŸï¼š ç¨‹åºè®¡æ•°å™¨ï¼Œæœ¬åœ°æ–¹æ³•æ ˆï¼Œè™šæ‹Ÿæœºæ ˆ</li>
<li>çº¿ç¨‹å…±äº«çš„åŒºåŸŸï¼š æ–¹æ³•åŒºï¼Œå †<br>å¯¹äºçº¿ç¨‹ç§æœ‰çš„åŒºåŸŸæ˜¯ä¸éœ€è¦åƒåœ¾å›æ”¶çš„ï¼Œå› ä¸ºå½“çº¿ç¨‹æ‰§è¡Œå®Œæˆä¹‹åï¼Œçº¿ç¨‹ä¸­ä½¿ç”¨çš„å†…å­˜ä¼šè‡ªåŠ¨å›æ”¶æ‰ï¼Œ<code>jvm</code>åƒåœ¾å›æ”¶åªéœ€è¦å…³æ³¨ <strong>æ–¹æ³•åŒº</strong>å’Œ <strong>å †</strong>å³å¯ï¼Œé‡ç‚¹æ˜¯ <strong>å †</strong></li>
</ol>
<h2 id="åƒåœ¾æ”¶é›†ç®—æ³•"><a href="#åƒåœ¾æ”¶é›†ç®—æ³•" class="headerlink" title="åƒåœ¾æ”¶é›†ç®—æ³•"></a>åƒåœ¾æ”¶é›†ç®—æ³•</h2><p>åœ¨ <code>jvm</code> ä¸­ï¼Œåƒåœ¾æ”¶é›†ç®—æ³•ä¸»è¦åŒ…å«ä»¥ä¸‹ä¸‰ç§</p>
<ol>
<li>æ ‡è®°-æ¸…é™¤ç®—æ³•</li>
<li>å¤åˆ¶ç®—æ³•</li>
<li>æ ‡è®°å‹ç¼©ç®—æ³•</li>
</ol>
<p>ä¸‰ç§ç®—æ³•ä¸»è¦è§£å†³äº†å°†åƒåœ¾æ ‡è®°å‡ºæ¥ä¹‹åå¦‚ä½•æ¸…é™¤çš„é—®é¢˜ï¼Œä¸‰ç§ç®—æ³•å„æœ‰åˆ©å¼Šï¼Œå•ç‹¬é‡‡ç”¨å…¶ä¸­ä»»ä½•ä¸€ç§ç®—æ³•ï¼Œéƒ½ä¸èƒ½å–å¾—å¾ˆå¥½çš„æ•ˆæœã€‚æ‰€ä»¥åœ¨JVMä¸­ï¼Œä¼šé’ˆå¯¹å†…å­˜çš„ä¸åŒåŒºåŸŸé‡‡ç”¨ä¸åŒçš„åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œè¿™å°±æ˜¯åˆ†ä»£ç®—æ³•</p>
<h3 id="æ ‡è®°-æ¸…é™¤ç®—æ³•"><a href="#æ ‡è®°-æ¸…é™¤ç®—æ³•" class="headerlink" title="æ ‡è®°-æ¸…é™¤ç®—æ³•"></a>æ ‡è®°-æ¸…é™¤ç®—æ³•</h3><ol>
<li>æ ‡è®°ï¼šåƒåœ¾æ”¶é›†å™¨ä»å¼•ç”¨æ ¹èŠ‚ç‚¹å¼€å§‹éå†ï¼Œæ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡</li>
<li>æ¸…é™¤ï¼šåƒåœ¾æ”¶é›†å™¨å¯¹å †å†…å­˜ä»å¤´åˆ°å°¾è¿›è¡Œçº¿æ€§éå†ï¼Œå¦‚æœå‘ç°æŸä¸ªå¯¹è±¡ä¸ºä¸å¯è¾¾å¯¹è±¡ï¼Œåˆ™å°†å…¶å›æ”¶</li>
</ol>
<p>ä¼˜ç‚¹ï¼š</p>
<ol>
<li>æ ‡è®°-æ¸…é™¤ç®—æ³•çš„ä¼˜ç‚¹æ˜¯ç®€å•ã€å®¹æ˜“å®ç°ï¼Œè€Œä¸”ä¸éœ€è¦ç§»åŠ¨å¯¹è±¡</li>
</ol>
<p>ç¼ºç‚¹ï¼š</p>
<ol>
<li>åœ¨è¿›è¡Œ<code>GC</code>çš„æ—¶å€™ï¼Œéœ€è¦åœæ­¢æ•´ä¸ªåº”ç”¨ç¨‹åºï¼Œå¯¼è‡´ç”¨æˆ·ä½“éªŒå·®</li>
<li>è¿™ç§æ–¹å¼æ¸…ç†å‡ºæ¥çš„ç©ºé—²å†…å­˜æ˜¯ä¸è¿ç»­çš„ï¼Œä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡</li>
<li>è¯¥ç®—æ³•æ¸…é™¤å¯¹è±¡å¹¶ä¸æ˜¯çœŸçš„ç½®ç©ºï¼Œè€Œæ˜¯æŠŠéœ€è¦æ¸…é™¤çš„å¯¹è±¡åœ°å€ä¿å­˜åœ¨ç©ºé—²çš„åœ°å€åˆ—è¡¨é‡Œï¼Œä¸‹æ¬¡æœ‰æ–°å¯¹è±¡ç”³è¯·å†…å­˜æ—¶ï¼Œåˆ¤æ–­æŸå—å†…å­˜ç©ºé—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœå……è¶³ï¼Œæ–°çš„å¯¹è±¡å°†ä¼šè¦†ç›–åŸæ¥æ ‡è®°ä¸ºåƒåœ¾çš„å¯¹è±¡ï¼Œä»è€Œå®ç°å†…å­˜çš„é‡å¤ä½¿ç”¨ã€‚ä½†æ˜¯å› ä¸ºå¯ç”¨å†…å­˜ä¸è¿ç»­é—®é¢˜ï¼Œåœ¨å¤§å¯¹è±¡ç”³è¯·å†…å­˜æ—¶ï¼Œéœ€è¦èŠ±è´¹æ›´å¤šæ—¶é—´å»æ‰¾å¯»åˆé€‚çš„ä½ç½®ï¼Œç”šè‡³å¤±è´¥ã€‚æ‰€ä»¥æ ‡è®°-æ¸…é™¤ç®—æ³•æ•ˆç‡ä¸é«˜ï¼Œä¸”å†…å­˜åˆ©ç”¨ç‡ä½ä¸‹ï¼Œç”šè‡³æœ‰äº›å†…å­˜ç¢ç‰‡æ— æ³•é‡å¤åˆ©ç”¨</li>
</ol>
<h3 id="å¤åˆ¶ç®—æ³•"><a href="#å¤åˆ¶ç®—æ³•" class="headerlink" title="å¤åˆ¶ç®—æ³•"></a>å¤åˆ¶ç®—æ³•</h3><ol>
<li>æ ¸å¿ƒæ€æƒ³æ˜¯å°†å†…å­˜ç©ºé—´åˆ†ä¸ºä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­ä¸€å—ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶å°†æ­£åœ¨ä½¿ç”¨çš„å†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æœªè¢«ä½¿ç”¨çš„å†…å­˜å—ä¸­ï¼Œä¹‹åæ¸…é™¤æ­£åœ¨ä½¿ç”¨çš„å†…å­˜å—ä¸­çš„æ‰€æœ‰å¯¹è±¡ã€‚ä¸¤å—å†…å­˜äº¤æ›¿ä½¿ç”¨ï¼Œä»è€Œå®Œæˆåƒåœ¾å¯¹è±¡çš„å›æ”¶</li>
<li>å¤åˆ¶ç®—æ³•æ²¡æœ‰æ ‡è®°å’Œæ¸…é™¤è¿‡ç¨‹ï¼Œå®ç°ç®€å•ï¼Œè¿è¡Œé«˜æ•ˆã€‚å†…å­˜ä»ä¸€å—ç©ºé—´å¤åˆ¶åˆ°å¦ä¸€å—ç©ºé—´å¯ä»¥ä¿è¯ç©ºé—´çš„è¿ç»­æ€§ï¼Œä¸ä¼šå‡ºç°å†…å­˜ç¢ç‰‡é—®é¢˜ã€‚ä½†æ˜¯å¤åˆ¶ç®—æ³•éœ€è¦åŒå€å†…å­˜ç©ºé—´</li>
<li>å¤åˆ¶ç®—æ³•éœ€è¦ç§»åŠ¨å¯¹è±¡ï¼Œè¿™å°±æ¶‰åŠä¿®æ”¹å¯¹è±¡å¼•ç”¨åœ°å€å€¼çš„é—®é¢˜</li>
<li>å¦‚æœç³»ç»Ÿä¸­çš„åƒåœ¾å¯¹è±¡å¾ˆå°‘ï¼Œå¤åˆ¶ç®—æ³•ä¸ä¼šå¾ˆç†æƒ³ã€‚å› ä¸ºå¤åˆ¶ç®—æ³•éœ€è¦å¤åˆ¶çš„å­˜æ´»å¯¹è±¡æ•°é‡å˜å¤§ï¼Œä½¿å¾—åƒåœ¾å›æ”¶å™¨çš„è¿è¡Œæ•ˆç‡å˜ä½</li>
</ol>
<h3 id="æ ‡è®°-å‹ç¼©ç®—æ³•"><a href="#æ ‡è®°-å‹ç¼©ç®—æ³•" class="headerlink" title="æ ‡è®°-å‹ç¼©ç®—æ³•"></a>æ ‡è®°-å‹ç¼©ç®—æ³•</h3><p>æ ‡è®°-å‹ç¼©ç®—æ³•æ¸…é™¤åƒåœ¾å¯¹è±¡çš„è¿‡ç¨‹</p>
<ol>
<li>ç¬¬ä¸€é˜¶æ®µå’Œæ ‡è®°â€“æ¸…é™¤ç®—æ³•ä¸€æ ·ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹æ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨å¯¹è±¡</li>
<li>ç¬¬äºŒé˜¶æ®µå°†æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡å‹ç¼©åˆ°å†…å­˜çš„ä¸€ç«¯ï¼ŒæŒ‰é¡ºåºæ’æ”¾</li>
<li>ç¬¬ä¸‰é˜¶æ®µæ¸…ç†è¾¹ç•Œå¤–æ‰€æœ‰çš„ç©ºé—´</li>
</ol>
<p>æ ‡è®°â€“å‹ç¼©ç®—æ³•çš„æœ€ç»ˆæ•ˆæœç­‰åŒäºæ ‡è®°â€“æ¸…é™¤ç®—æ³•æ‰§è¡Œå®Œæˆåï¼Œå†è¿›è¡Œä¸€æ¬¡å†…å­˜ç¢ç‰‡æ•´ç†</p>
<h2 id="åˆ†ä»£æ”¶é›†ç®—æ³•"><a href="#åˆ†ä»£æ”¶é›†ç®—æ³•" class="headerlink" title="åˆ†ä»£æ”¶é›†ç®—æ³•"></a>åˆ†ä»£æ”¶é›†ç®—æ³•</h2><ol>
<li>åœ¨ç¨‹åºä¸­ï¼Œä¸åŒçš„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸åŒçš„ï¼Œæœ‰äº›å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå¾ˆé•¿ï¼Œæœ‰äº›å¯¹è±¡æ˜¯æœç”Ÿå¤•æ­»çš„ï¼Œå› æ­¤åœ¨ <code>HotSpot</code> çš„ <code>jvm</code> ä¸­ï¼Œå°† <code>Java</code> å †åˆ†ä¸º <strong>æ–°ç”Ÿä»£</strong> å’Œ <strong>è€å¹´ä»£</strong>ï¼Œç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£ï¼Œç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„ä¸€èˆ¬æ”¾å…¥æ–°ç”Ÿä»£</li>
</ol>
<h3 id="æ–°ç”Ÿä»£"><a href="#æ–°ç”Ÿä»£" class="headerlink" title="æ–°ç”Ÿä»£"></a>æ–°ç”Ÿä»£</h3><ol>
<li>æ–°ç”Ÿä»£ç‰¹ç‚¹æ˜¯åŒºåŸŸç›¸å¯¹è€å¹´ä»£è¾ƒå°ï¼Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸçŸ­ã€å­˜æ´»ç‡ä½ã€å›æ”¶é¢‘ç¹</li>
<li>å¤åˆ¶ç®—æ³•çš„æ•ˆç‡åªå’Œå½“å‰å­˜æ´»å¯¹è±¡æ•°é‡å¤§å°æœ‰å…³ï¼Œç»“åˆæ–°ç”Ÿä»£çš„ç‰¹ç‚¹ï¼Œæ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œé€Ÿåº¦æœ€å¿«ã€æ•ˆç‡ä¹Ÿæœ€é«˜</li>
<li><code>HotSpot</code> å°†æ–°ç”Ÿä»£ç©ºé—´åˆ†æˆä¸‰ä¸ªåŒºåŸŸ<ol>
<li>Eden(é»˜è®¤å 80%)</li>
<li>From(é»˜è®¤å 10%)</li>
<li>To(é»˜è®¤å 10%)</li>
</ol>
</li>
</ol>
<p>æ¯æ¬¡æ–°ç”Ÿä»£å‘ç”Ÿ<code>GC</code>æ—¶ï¼ŒæŠŠ<code>Eden</code>åŒºå’Œä¸Šæ¬¡å¹¸å­˜åŒºä¸­åœ¨æœ¬æ¬¡<code>GC</code>ä»ç„¶å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€ä¸ªå¹¸å­˜åŒºï¼Œå¹¸å­˜åŒºåœ¨<code>From</code>åŒºå’Œ<code>To</code>åŒºä¹‹é—´åˆ‡æ¢ï¼Œæ€»æœ‰ä¸€å—ç©ºé—´ä¸ºç©ºï¼Œä»è€Œè§£å†³å†…å­˜åˆ©ç”¨ç‡ä½çš„é—®é¢˜</p>
<h3 id="è€å¹´ä»£"><a href="#è€å¹´ä»£" class="headerlink" title="è€å¹´ä»£"></a>è€å¹´ä»£</h3><ol>
<li>è€å¹´ä»£ç‰¹ç‚¹æ˜¯åŒºåŸŸè¾ƒå¤§ï¼Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸé•¿ã€å­˜æ´»ç‡é«˜ï¼Œå›æ”¶ä¸åŠæ–°ç”Ÿä»£é¢‘ç¹ã€‚å› ä¸ºå­˜åœ¨å¤§é‡å­˜æ´»ç‡é«˜çš„å¯¹è±¡ï¼Œå¤åˆ¶ç®—æ³•æ˜æ˜¾å˜å¾—ä¸åˆé€‚ã€‚ä¸€èˆ¬æ˜¯ç”±æ ‡è®°â€“æ¸…é™¤æˆ–è€…æ ‡è®°â€“æ¸…é™¤ä¸æ ‡è®°â€“å‹ç¼©çš„æ··åˆå®ç°</li>
</ol>
<h2 id="å¢é‡æ”¶é›†ç®—æ³•"><a href="#å¢é‡æ”¶é›†ç®—æ³•" class="headerlink" title="å¢é‡æ”¶é›†ç®—æ³•"></a>å¢é‡æ”¶é›†ç®—æ³•</h2><ol>
<li>ä¸Šè¿°ç°æœ‰çš„ç®—æ³•ï¼Œåœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨è½¯ä»¶å°†å¤„äºä¸€ç§<code>STW(Stop The World)</code>çš„çŠ¶æ€ã€‚åœ¨<code>STW</code>çŠ¶æ€ä¸‹ï¼Œåº”ç”¨ç¨‹åºæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šæŒ‚èµ·ï¼Œæš‚åœä¸€åˆ‡æ­£å¸¸çš„å·¥ä½œï¼Œç­‰å¾…åƒåœ¾å›æ”¶çš„å®Œæˆã€‚å¦‚æœåƒåœ¾å›æ”¶æ—¶é—´è¿‡é•¿ï¼Œåº”ç”¨ç¨‹åºä¼šè¢«æŒ‚èµ·å¾ˆä¹…ï¼Œå°†ä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒæˆ–è€…ç³»ç»Ÿçš„ç¨³å®šæ€§</li>
<li>å¢é‡æ”¶é›†åŸºæœ¬æ€æƒ³æ˜¯å¦‚æœä¸€æ¬¡æ€§å°†æ‰€æœ‰çš„åƒåœ¾è¿›è¡Œå¤„ç†ï¼Œä¼šé€ æˆç³»ç»Ÿé•¿æ—¶é—´çš„åœé¡¿ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®©åƒåœ¾æ”¶é›†çº¿ç¨‹å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹äº¤æ›¿æ‰§è¡Œã€‚æ¯æ¬¡åƒåœ¾æ”¶é›†çº¿ç¨‹åªæ”¶é›†ä¸€å°ç‰‡åŒºåŸŸçš„å†…å­˜ç©ºé—´ï¼Œæ¥ç€åˆ‡æ¢åˆ°åº”ç”¨ç¨‹åºçº¿ç¨‹ã€‚ä¾æ¬¡åå¤ï¼Œç›´åˆ°åƒåœ¾æ”¶é›†å®Œæˆ</li>
<li>å¢é‡æ”¶é›†ç®—æ³•çš„åŸºç¡€ä»æ˜¯ä¼ ç»Ÿçš„æ ‡è®°â€“æ¸…é™¤å’Œå¤åˆ¶ç®—æ³•ã€‚å¢é‡æ”¶é›†ç®—æ³•é€šè¿‡å¯¹çº¿ç¨‹é—´å†²çªçš„å¦¥å–„å¤„ç†ï¼Œå…</li>
<li>è®¸åƒåœ¾æ”¶é›†çº¿ç¨‹ä»¥åˆ†é˜¶æ®µçš„æ–¹å¼å®Œæˆæ ‡è®°ã€æ¸…ç†æˆ–å¤åˆ¶å·¥ä½œ</li>
</ol>
<h2 id="åˆ†åŒºæ”¶é›†ç®—æ³•"><a href="#åˆ†åŒºæ”¶é›†ç®—æ³•" class="headerlink" title="åˆ†åŒºæ”¶é›†ç®—æ³•"></a>åˆ†åŒºæ”¶é›†ç®—æ³•</h2><ol>
<li>åˆ†ä»£ç®—æ³•æŒ‰ç…§å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸé•¿çŸ­å°†å †ç©ºé—´åˆ’åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åŒºç®—æ³•å°†æ•´ä¸ªå †ç©ºé—´åˆ’åˆ†æˆè¿ç»­çš„ä¸åŒå°åŒºé—´(<code>region</code>)</li>
<li>åœ¨ç›¸åŒæ¡ä»¶ä¸‹ï¼Œå †ç©ºé—´è¶Šå¤§ï¼Œä¸€æ¬¡<code>GC</code>æ‰€éœ€è¦çš„æ—¶é—´å°±è¶Šé•¿ï¼Œæœ‰å…³<code>GC</code>äº§ç”Ÿçš„åœé¡¿ä¹Ÿå°±è¶Šé•¿ã€‚ä¸ºäº†æ›´å¥½åœ°æ§åˆ¶<code>GC</code>äº§ç”Ÿçš„åœé¡¿æ—¶é—´ï¼Œå°†ä¸€å—å¤§çš„å†…å­˜åŒºåŸŸåˆ†å‰²æˆå¤šä¸ªå°å—ï¼Œæ ¹æ®ç›®æ ‡çš„åœé¡¿æ—¶é—´ï¼Œæ¯æ¬¡åˆç†åœ°å›æ”¶è‹¥å¹²ä¸ªå°åŒºé—´ï¼Œè€Œä¸æ˜¯æ•´ä¸ªå †ç©ºé—´ï¼Œä»è€Œå‡å°‘ä¸€æ¬¡<code>GC</code>æ‰€äº§ç”Ÿçš„åœé¡¿</li>
</ol>
<h2 id="åƒåœ¾å›æ”¶ç›¸å…³æ¦‚å¿µç†è§£"><a href="#åƒåœ¾å›æ”¶ç›¸å…³æ¦‚å¿µç†è§£" class="headerlink" title="åƒåœ¾å›æ”¶ç›¸å…³æ¦‚å¿µç†è§£"></a>åƒåœ¾å›æ”¶ç›¸å…³æ¦‚å¿µç†è§£</h2><h3 id="STW-Stop-the-world"><a href="#STW-Stop-the-world" class="headerlink" title="STW(Stop the world)"></a>STW(Stop the world)</h3><ol>
<li>åœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œæ•´ä¸ªåº”ç”¨ç¨‹åºéƒ½ä¼šæš‚åœï¼Œæ²¡æœ‰ä»»ä½•å“åº”ï¼Œæ‰€ä»¥è¢«å½¢è±¡åœ°ç§°ä¸º<code>â€œStop-The-Worldâ€</code>ï¼Œç®€ç§°<code>STW</code></li>
<li>å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­æšä¸¾æ ¹èŠ‚ç‚¹(<code>GC Roots</code>)é€ æˆ<code>STW</code>ï¼ŒåŸå› æ˜¯å¦‚æœå‡ºç°åˆ†æè¿‡ç¨‹ä¸­å¯¹è±¡å¼•ç”¨å…³ç³»è¿˜åœ¨ä¸æ–­å˜åŒ–ï¼Œåˆ™åˆ†æç»“æœçš„å‡†ç¡®æ€§æ— æ³•ä¿è¯ã€‚æ‰€ä»¥åˆ†æå·¥ä½œå¿…é¡»åœ¨ä¸€ä¸ªèƒ½ç¡®ä¿ä¸€è‡´æ€§çš„å¿«ç…§ä¸­è¿›è¡Œ</li>
</ol>
<h3 id="å®‰å…¨ç‚¹"><a href="#å®‰å…¨ç‚¹" class="headerlink" title="å®‰å…¨ç‚¹"></a>å®‰å…¨ç‚¹</h3><ol>
<li>åœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨ç¨‹åºä¼šå‘ç”Ÿ <code>STW</code> ç°è±¡, ä½†æ˜¯åº”ç”¨ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¹¶ä¸æ˜¯åœ¨ä»»æ„ä½ç½®éƒ½é€‚åˆåœé¡¿ä¸‹æ¥è¿›è¡Œ<code>GC</code>çš„ï¼Œåªæœ‰åœ¨ç‰¹å®šçš„ä½ç½®æ‰èƒ½åœé¡¿ä¸‹æ¥è¿›è¡Œ<code>GC</code>æ“ä½œï¼Œè¿™äº›ç‰¹å®šçš„ä½ç½®è¢«ç§°ä¸ºå®‰å…¨ç‚¹(<code>Safe Point</code>)</li>
</ol>
<h4 id="å“ªäº›ä½ç½®æ˜¯å®‰å…¨ç‚¹"><a href="#å“ªäº›ä½ç½®æ˜¯å®‰å…¨ç‚¹" class="headerlink" title="å“ªäº›ä½ç½®æ˜¯å®‰å…¨ç‚¹"></a>å“ªäº›ä½ç½®æ˜¯å®‰å…¨ç‚¹</h4><ol>
<li>å®‰å…¨ç‚¹å¤ªå°‘å¯èƒ½å¯¼è‡´<code>GC</code>ç­‰å¾…çš„æ—¶é—´å¤ªé•¿ï¼Œå¦‚æœå®‰å…¨ç‚¹å¤ªå¯†å¯èƒ½å¯¼è‡´è¿è¡Œæ—¶çš„æ€§èƒ½é—®é¢˜</li>
<li>é€šå¸¸é€‰æ‹©ä¸€äº›è¿è¡Œæ—¶é—´è¾ƒé•¿çš„æŒ‡ä»¤ä½ç½®ä½œä¸ºå®‰å…¨ç‚¹ï¼Œä¾‹å¦‚æ–¹æ³•è°ƒç”¨ã€å¾ªç¯è·³è½¬ç­‰</li>
</ol>
<h4 id="GC-å‘ç”Ÿæ—¶å¦‚ä½•ä¿è¯åº”ç”¨çº¿ç¨‹éƒ½åœ¨å®‰å…¨ç‚¹ä¸Š"><a href="#GC-å‘ç”Ÿæ—¶å¦‚ä½•ä¿è¯åº”ç”¨çº¿ç¨‹éƒ½åœ¨å®‰å…¨ç‚¹ä¸Š" class="headerlink" title="GC å‘ç”Ÿæ—¶å¦‚ä½•ä¿è¯åº”ç”¨çº¿ç¨‹éƒ½åœ¨å®‰å…¨ç‚¹ä¸Š"></a>GC å‘ç”Ÿæ—¶å¦‚ä½•ä¿è¯åº”ç”¨çº¿ç¨‹éƒ½åœ¨å®‰å…¨ç‚¹ä¸Š</h4><p><strong>æŠ¢å…ˆå¼ä¸­æ–­</strong><br><code>GC</code>æŠ¢å…ˆä¸­æ–­æ‰€æœ‰çº¿ç¨‹ã€‚å¦‚æœå‘ç°æŸä¸ªçº¿ç¨‹ä¸åœ¨å®‰å…¨ç‚¹ï¼Œå°±é‡æ–°æ¢å¤è¯¥çº¿ç¨‹ï¼Œè®©çº¿ç¨‹è·‘åˆ°å®‰å…¨ç‚¹ã€è¿™ç§æ–¹å¼ä¸æ˜¯åº”ç”¨ç¨‹åºä¸»å¯¼ï¼Œè€Œæ˜¯ <code>GC</code> çº¿ç¨‹ä¸»å¯¼ï¼Œæ‰€ä»¥æ²¡æœ‰ä½¿ç”¨ã€‘</p>
<p><strong>ä¸»åŠ¨å¼ä¸­æ–­</strong><br><code>GC</code>çº¿ç¨‹ç»™è‡ªå·±è®¾ç½®ä¸€ä¸ªä¸­æ–­æ ‡å¿—ï¼Œå„ä¸ªåº”ç”¨çº¿ç¨‹è¿è¡Œåˆ°å®‰å…¨ç‚¹çš„æ—¶å€™ä¸»åŠ¨è½®è¯¢è¿™ä¸ªæ ‡å¿—ï¼Œå¦‚æœæ­¤æ—¶<code>GC</code>çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä¸ºçœŸï¼Œåˆ™å°†è‡ªå·±ä¸­æ–­æŒ‚èµ·ã€‚è¿™ç§æ–¹å¼çš„å¥½å¤„æ˜¯ç”±åº”ç”¨ç¨‹åºåœ¨å®‰å…¨ç‚¹ä¸»åŠ¨å‘èµ·ä¸­æ–­ï¼Œè€Œä¸ä¼šå‡ºç°è¢«è¿«åœ¨éå®‰å…¨ç‚¹çš„ä½ç½®å…ˆä¸­æ–­çš„æƒ…å†µ</p>
<h3 id="å®‰å…¨åŒºåŸŸ"><a href="#å®‰å…¨åŒºåŸŸ" class="headerlink" title="å®‰å…¨åŒºåŸŸ"></a>å®‰å…¨åŒºåŸŸ</h3><ol>
<li>å®‰å…¨ç‚¹æœºåˆ¶ä¿è¯äº†ç¨‹åºæ‰§è¡Œæ—¶ï¼Œåœ¨ä¸å¤ªé•¿çš„æ—¶é—´å†…å°±ä¼šé‡åˆ°å¯è¿›å…¥<code>GC</code>çš„å®‰å…¨ç‚¹, å¦‚æœåº”ç”¨çº¿ç¨‹è¢«é˜»å¡äº†åˆè¯¥å¦‚ä½•å¤„ç†ï¼Ÿâ€”è¿™å°±éœ€è¦é€šè¿‡å¼•å…¥ <strong>å®‰å…¨åŒºåŸŸ</strong> æ¥è§£å†³</li>
<li>å®‰å…¨åŒºåŸŸæ˜¯æŒ‡åœ¨ä¸€æ®µä»£ç ç‰‡æ®µä¸­ï¼Œå¯¹è±¡çš„å¼•ç”¨å…³ç³»ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåœ¨è¿™ä¸ªåŒºåŸŸä¸­çš„ä»»ä½•ä½ç½®å¼€å§‹<code>GC</code>éƒ½æ˜¯å®‰å…¨çš„</li>
<li>å½“çº¿ç¨‹è¿è¡Œå®‰å…¨åŒºåŸŸçš„ä»£ç æ—¶ï¼Œé¦–å…ˆæ ‡è¯†å·²ç»è¿›å…¥äº†å®‰å…¨åŒºåŸŸï¼Œå¦‚æœè¿™æ®µæ—¶é—´å†…å‘ç”Ÿ<code>GC</code>,<code>JVM</code>ä¼šå¿½ç•¥æ ‡è¯†ä¸ºå®‰å…¨åŒºåŸŸçŠ¶æ€çš„çº¿ç¨‹</li>
<li>å½“çº¿ç¨‹å³å°†ç¦»å¼€å®‰å…¨åŒºåŸŸæ—¶ï¼Œä¼šæ£€æŸ¥<code>JVM</code>æ˜¯å¦å·²ç»å®Œæˆ<code>GC</code>ï¼Œå¦‚æœå®Œæˆäº†ï¼Œåˆ™ç»§ç»­è¿è¡Œï¼Œå¦åˆ™çº¿ç¨‹å¿…é¡»ç­‰å¾…ç›´åˆ°æ”¶åˆ°å¯ä»¥å®‰å…¨ç¦»å¼€å®‰å…¨åŒºåŸŸçš„ä¿¡å·ä¸ºæ­¢</li>
</ol>
<h2 id="åƒåœ¾æ”¶é›†å™¨"><a href="#åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="åƒåœ¾æ”¶é›†å™¨"></a>åƒåœ¾æ”¶é›†å™¨</h2><h3 id="åƒåœ¾æ”¶é›†å™¨çš„åˆ†ç±»"><a href="#åƒåœ¾æ”¶é›†å™¨çš„åˆ†ç±»" class="headerlink" title="åƒåœ¾æ”¶é›†å™¨çš„åˆ†ç±»"></a>åƒåœ¾æ”¶é›†å™¨çš„åˆ†ç±»</h3><p>å‰é¢è®²è§£åƒåœ¾æ”¶é›†ç®—æ³•æ—¶æåˆ° <code>HotSpot</code> è™šæ‹Ÿæœºä¸­ä½¿ç”¨äº†åˆ†ä»£åƒåœ¾æ”¶é›†æ€æƒ³ï¼Œå¯¹åº”çš„æ ¹æ®åƒåœ¾æ”¶é›†å™¨å·¥ä½œçš„å†…å­˜åŒºé—´ä¸åŒï¼Œå¯åˆ†ä¸ºæ–°ç”Ÿä»£åƒåœ¾æ”¶é›†å™¨ï¼Œè€å¹´ä»£åƒåœ¾æ”¶é›†å™¨å’Œæ•´å †åƒåœ¾æ”¶é›†å™¨</p>
<pre class="mermaid">flowchart LR
    subgraph A["æ–°ç”Ÿä»£"]
        A1["Serial GC"]
        A2["Parallel Scavenge GC"]
        A3["ParNew GC"]
        A4["G1 GC"]
    end
    subgraph B["æ–°ç”Ÿä»£"]
        B1["Serial Old GC"]
        B2["Parallel Old GC"]
        B3["CMS GC"]
        B4["G1 GC"]
    end</pre>

<h3 id="Serial"><a href="#Serial" class="headerlink" title="Serial"></a>Serial</h3><ol>
<li><code>Serial</code> é‡‡ç”¨çš„æ˜¯<strong>å¤åˆ¶ç®—æ³•</strong>ã€<strong>ä¸²è¡Œå›æ”¶</strong>å’Œ<code>STW</code>æœºåˆ¶çš„æ–¹å¼æ‰§è¡Œå†…å­˜å›æ”¶</li>
<li><code>Serial</code> ç”¨äºå›æ”¶ <strong>æ–°ç”Ÿä»£</strong></li>
<li><code>Serial</code>æ”¶é›†å™¨ä½œä¸º<code>HotSpot</code>ä¸­<code>Client</code>æ¨¡å¼ä¸‹çš„é»˜è®¤æ–°ç”Ÿä»£åƒåœ¾æ”¶é›†å™¨</li>
</ol>
<h3 id="Serial-Old"><a href="#Serial-Old" class="headerlink" title="Serial Old"></a>Serial Old</h3><ol>
<li><code>Serial Old</code> ç”¨äºå›æ”¶ <strong>è€å¹´ä»£</strong></li>
<li><code>Serial Old</code>æ”¶é›†å™¨åŒæ ·é‡‡ç”¨äº†<strong>ä¸²è¡Œå›æ”¶</strong>å’Œ<code>STW</code>æœºåˆ¶ï¼Œåªä¸è¿‡å†…å­˜å›æ”¶ç®—æ³•ä½¿ç”¨çš„æ˜¯<strong>æ ‡è®°â€”å‹ç¼©ç®—æ³•</strong></li>
<li><code>Serial Old</code>æ˜¯è¿è¡Œåœ¨<code>Client</code>æ¨¡å¼ä¸‹é»˜è®¤çš„è€å¹´ä»£çš„åƒåœ¾æ”¶é›†å™¨</li>
<li><code>Serial Old</code>åœ¨<code>Server</code>æ¨¡å¼ä¸‹ä¸»è¦æœ‰ä¸¤ä¸ªç”¨é€”<ol>
<li>ä¸æ–°ç”Ÿä»£çš„<code>Parallel Scavenge</code>åƒåœ¾æ”¶é›†å™¨æ­é…</li>
<li>ä½œä¸ºè€å¹´ä»£<code>CMS</code>æ”¶é›†å™¨çš„åå¤‡æ–¹æ¡ˆ</li>
</ol>
</li>
</ol>
<h3 id="Serial-Serial-Oldåƒåœ¾æ”¶é›†å™¨è¿‡ç¨‹å›¾"><a href="#Serial-Serial-Oldåƒåœ¾æ”¶é›†å™¨è¿‡ç¨‹å›¾" class="headerlink" title="Serial&#x2F;Serial Oldåƒåœ¾æ”¶é›†å™¨è¿‡ç¨‹å›¾"></a>Serial&#x2F;Serial Oldåƒåœ¾æ”¶é›†å™¨è¿‡ç¨‹å›¾</h3><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311262309313.webp" alt="Serial"></p>
<h3 id="CMS"><a href="#CMS" class="headerlink" title="CMS"></a>CMS</h3><ol>
<li><code>CMS</code>ä¸»è¦é€‚åˆåœºæ™¯æ˜¯å¯¹å“åº”æ—¶é—´çš„éœ€æ±‚å¤§äºå¯¹ååé‡çš„è¦æ±‚ã€‚å®ƒæ˜¯HotSpotè™šæ‹Ÿæœºä¸­ç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘æ”¶é›†å™¨ï¼Œç¬¬ä¸€æ¬¡å®ç°äº†è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶å·¥ä½œ</li>
<li><code>CMS</code>çš„åƒåœ¾æ”¶é›†ç®—æ³•é‡‡ç”¨<strong>æ ‡è®°â€“æ¸…é™¤ç®—æ³•</strong>ï¼Œä¹Ÿä¼š<code>STW</code></li>
<li><code>CMS</code>ä½œä¸ºè€å¹´ä»£çš„æ”¶é›†å™¨ï¼Œæ— æ³•ä¸æ–°ç”Ÿä»£æ”¶é›†å™¨<code>Parallel Scavenge</code>é…åˆå·¥ä½œï¼Œæ‰€ä»¥ä½¿ç”¨<code>CMS</code>æ”¶é›†è€å¹´ä»£æ—¶ï¼Œæ–°ç”Ÿä»£åªèƒ½é€‰æ‹©<code>ParNew</code>æˆ–è€…<code>Serial</code>æ”¶é›†å™¨ä¸­çš„ä¸€ä¸ª</li>
<li><code>JDK9</code> ä¸­ <code>G1</code> å˜æˆäº†é»˜è®¤çš„åƒåœ¾æ”¶é›†å™¨ï¼Œæ›¿æ¢äº† <code>CMS</code></li>
<li><code>JDK14</code> ä¸­ï¼Œå½»åº•ç§»é™¤äº† <code>CMS</code> åƒåœ¾æ”¶é›†å™¨</li>
</ol>
<h3 id="CMS-åƒåœ¾å›æ”¶è¿‡ç¨‹"><a href="#CMS-åƒåœ¾å›æ”¶è¿‡ç¨‹" class="headerlink" title="CMS åƒåœ¾å›æ”¶è¿‡ç¨‹"></a>CMS åƒåœ¾å›æ”¶è¿‡ç¨‹</h3><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311262316564.webp" alt="CMSåƒåœ¾å›æ”¶è¿‡ç¨‹"></p>
<ol>
<li>åˆå§‹æ ‡è®°ï¼š è¯¥é˜¶æ®µçš„ä¸»è¦ä»»åŠ¡ä»…ä»…åªæ˜¯æ ‡è®°å‡º<code>GC Roots</code>èƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ã€‚ä¸€æ—¦æ ‡è®°å®Œæˆä¹‹åå°±ä¼šæ¢å¤ä¹‹å‰è¢«æš‚åœçš„æ‰€æœ‰åº”ç”¨çº¿ç¨‹ã€‚ç”±äºç›´æ¥å…³è”å¯¹è±¡æ¯”è¾ƒå°ï¼Œæ‰€ä»¥è¿™é‡Œçš„é€Ÿåº¦éå¸¸å¿«</li>
<li>å¹¶å‘æ ‡è®°ï¼š ä»<code>GC Roots</code>çš„ç›´æ¥å…³è”å¯¹è±¡å¼€å§‹éå†æ•´ä¸ªå¯¹è±¡å›¾çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹è€—æ—¶è¾ƒé•¿ä½†æ˜¯ä¸éœ€è¦åœé¡¿ç”¨æˆ·çº¿ç¨‹ï¼Œå¯ä»¥ä¸åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸€èµ·å¹¶å‘è¿è¡Œ</li>
<li>é‡æ–°æ ‡è®°(<code>Remark</code>): ç”±äºåœ¨å¹¶å‘æ ‡è®°é˜¶æ®µä¸­ï¼Œç¨‹åºçš„å·¥ä½œçº¿ç¨‹ä¼šå’Œåƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶è¿è¡Œæˆ–è€…äº¤å‰è¿è¡Œï¼Œä¸ºäº†ä¿®æ­£åœ¨å¹¶å‘æ ‡è®°æœŸé—´å› ç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼Œéœ€è¦ä¸€æ¬¡é‡æ–°æ ‡è®°æ“ä½œ</li>
<li>å¹¶å‘æ¸…é™¤ï¼š æ­¤é˜¶æ®µæ¸…ç†å·²ç»è¢«æ ‡è®°ä¸ºæ­»äº¡çš„å¯¹è±¡ï¼Œé‡Šæ”¾å†…å­˜ç©ºé—´ã€‚ç”±äºä¸éœ€è¦ç§»åŠ¨å­˜æ´»å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¸ªé˜¶æ®µä¹Ÿæ˜¯å¯ä»¥ä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶å¹¶å‘çš„</li>
</ol>
<h3 id="CMS-åƒåœ¾æ”¶é›†å™¨çš„ç¼ºç‚¹"><a href="#CMS-åƒåœ¾æ”¶é›†å™¨çš„ç¼ºç‚¹" class="headerlink" title="CMS åƒåœ¾æ”¶é›†å™¨çš„ç¼ºç‚¹"></a>CMS åƒåœ¾æ”¶é›†å™¨çš„ç¼ºç‚¹</h3><ol>
<li>ç”±äºä½¿ç”¨çš„æ˜¯æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼Œå› æ­¤ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼ˆä¸ºä»€ä¹ˆä¸ä½¿ç”¨æ•´ç†ç®—æ³•å‘¢â€“å› ä¸ºè¦ä¿è¯åƒåœ¾æ”¶é›†å’Œç”¨æˆ·çº¿ç¨‹åŒæ—¶è¿è¡Œï¼Œæ‰€ä»¥ç”¨æˆ·çº¿ç¨‹æ‰€éœ€çš„èµ„æºå°±ä¸èƒ½ç§»åŠ¨ä½ç½®ï¼Œæ ‡è®°æ•´ç†ç®—æ³•éœ€è¦ç§»åŠ¨å¯¹è±¡ä½ç½®ï¼‰</li>
<li>å¯¹<code>CPU</code>èµ„æºéå¸¸æ•æ„Ÿã€‚åœ¨å¹¶å‘é˜¶æ®µï¼Œå®ƒè™½ç„¶ä¸ä¼šå¯¼è‡´ç”¨æˆ·åœé¡¿ï¼Œä½†æ˜¯ä¼šå› ä¸ºå ç”¨äº†ä¸€éƒ¨åˆ†çº¿ç¨‹è€Œå¯¼è‡´åº”ç”¨ç¨‹åºå˜æ…¢ï¼Œæ€»ååé‡ä¼šé™ä½</li>
<li>ç”±äºåœ¨åƒåœ¾æ”¶é›†é˜¶æ®µç”¨æˆ·çº¿ç¨‹æ²¡æœ‰ä¸­æ–­ï¼Œè¦æ˜¯<code>CMS</code>è¿è¡ŒæœŸé—´é¢„ç•™çš„å†…å­˜æ— æ³•æ»¡è¶³ç¨‹åºéœ€è¦ï¼Œå°±ä¼šå‡ºç°ä¸€æ¬¡<code>â€œConcurrent Mode Failureâ€</code>å¤±è´¥è€Œå¯¼è‡´å¦ä¸€æ¬¡<code>Full GC</code>çš„äº§ç”Ÿ</li>
<li>æ— æ³•å¤„ç†<strong>æµ®åŠ¨åƒåœ¾</strong>,åœ¨å¹¶å‘æ¸…é™¤é˜¶æ®µç”±äºç¨‹åºçš„å·¥ä½œçº¿ç¨‹å’Œåƒåœ¾æ”¶é›†çº¿ç¨‹æ˜¯åŒæ—¶è¿è¡Œæˆ–è€…äº¤å‰è¿è¡Œçš„ï¼Œé‚£ä¹ˆåœ¨å¹¶å‘æ¸…é™¤é˜¶æ®µå¦‚æœäº§ç”Ÿæ–°çš„åƒåœ¾å¯¹è±¡ï¼Œ<code>CMS</code>å°†æ— æ³•å¯¹è¿™äº›åƒåœ¾å¯¹è±¡è¿›è¡Œæ ‡è®°ï¼Œæœ€ç»ˆä¼šå¯¼è‡´è¿™äº›æ–°äº§ç”Ÿçš„åƒåœ¾å¯¹è±¡æ²¡æœ‰è¢«åŠæ—¶å›æ”¶</li>
</ol>
<h3 id="G1-æ”¶é›†å™¨"><a href="#G1-æ”¶é›†å™¨" class="headerlink" title="G1 æ”¶é›†å™¨"></a>G1 æ”¶é›†å™¨</h3><p><strong>ä¸ºä»€ä¹ˆéœ€è¦ G1 åƒåœ¾æ”¶é›†å™¨</strong><br>ä¸ºäº†å®ç°åœ¨åº”ç”¨ç¨‹åºè¿è¡Œç¯å¢ƒå†…å­˜ä¸æ–­æ‰©å¤§ï¼Œå¤„ç†å™¨æ•°é‡ä¸æ–­å¢åŠ çš„æƒ…å†µä¸‹ï¼Œè¿›ä¸€æ­¥é™ä½åœé¡¿æ—¶é—´ï¼ŒåŒæ—¶è¿˜èƒ½å…¼é¡¾è‰¯å¥½çš„ååé‡çš„ç›®æ ‡</p>
<p><strong>G1 åƒåœ¾æ”¶é›†å™¨çš„å·¥ä½œæ–¹å¼</strong><br><code>G1</code>æœ‰è®¡åˆ’åœ°é¿å…åœ¨æ•´ä¸ª<code>Java</code>å †ä¸­è¿›è¡Œå…¨åŒºåŸŸçš„åƒåœ¾æ”¶é›†ã€‚<code>G1</code>è·Ÿè¸ªå„ä¸ª<code>Region</code>é‡Œé¢çš„åƒåœ¾å †ç§¯çš„ä»·å€¼å¤§å°ï¼ˆå›æ”¶æ‰€è·å¾—çš„ç©ºé—´å¤§å°ä»¥åŠå›æ”¶æ‰€éœ€æ—¶é—´çš„ç»éªŒå€¼ï¼‰ï¼Œåœ¨åå°ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆå›æ”¶ä»·å€¼æœ€å¤§çš„<code>Region</code></p>
<p><strong>G1 åƒåœ¾æ”¶é›†å™¨çš„ä½¿ç”¨åœºæ™¯</strong><br><code>G1</code>æ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡ç«¯åº”ç”¨çš„åƒåœ¾æ”¶é›†å™¨ï¼Œä¸»è¦é’ˆå¯¹é…å¤‡å¤šæ ¸<code>CPU</code>åŠå¤§å®¹é‡å†…å­˜çš„æœºå™¨ï¼Œæå¤§å¯èƒ½é™ä½åƒåœ¾å›æ”¶åœé¡¿æ—¶é—´çš„åŒæ—¶ï¼Œè¿˜å…¼å…·é«˜ååé‡çš„æ€§èƒ½ç‰¹å¾</p>
<h3 id="G1-åƒåœ¾æ”¶é›†å™¨æ”¶é›†åƒåœ¾è¿‡ç¨‹"><a href="#G1-åƒåœ¾æ”¶é›†å™¨æ”¶é›†åƒåœ¾è¿‡ç¨‹" class="headerlink" title="G1 åƒåœ¾æ”¶é›†å™¨æ”¶é›†åƒåœ¾è¿‡ç¨‹"></a>G1 åƒåœ¾æ”¶é›†å™¨æ”¶é›†åƒåœ¾è¿‡ç¨‹</h3><p><code>G1</code> å¯ä»¥ä½œç”¨äºæ•´ä¸ªæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œåƒåœ¾å›æ”¶è¿‡ç¨‹å¦‚ä¸‹</p>
<ol>
<li>æ–°ç”Ÿä»£GC</li>
<li>è€å¹´ä»£å¹¶å‘æ ‡è®°</li>
<li>æ··åˆå›æ”¶</li>
</ol>
]]></content>
      <categories>
        <category>java</category>
        <category>jvm</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>jvmæ‰§è¡Œå¼•æ“</title>
    <url>/2023/a18206d79e08/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="æ‰§è¡Œå¼•æ“çš„ä½œç”¨"><a href="#æ‰§è¡Œå¼•æ“çš„ä½œç”¨" class="headerlink" title="æ‰§è¡Œå¼•æ“çš„ä½œç”¨"></a>æ‰§è¡Œå¼•æ“çš„ä½œç”¨</h2><pre class="mermaid">flowchart TB
    A["javaæºä»£ç (.javaæ–‡ä»¶)"]
    B["classå­—èŠ‚ç æ–‡ä»¶"]
    C["å†…å­˜(æ”¾å…¥jvmæ–¹æ³•åŒº)"]
        subgraph D["æ‰§è¡Œå¼•æ“"]
            subgraph D1["ç¼–è¯‘å™¨"]
                D11["Client Compiler"]
                D12["Server Compiler"]
            end
        end
    E["æœºå™¨ç "]

    A--"javacç¼–è¯‘å™¨"-->B
    B--"ç±»åŠ è½½å™¨"-->C
    C-->D
    D--è§£é‡Šæ‰§è¡Œ-->E
    D--"ç¼–è¯‘æ‰§è¡Œ(JIT)"-->E</pre>
<h3 id="å­—èŠ‚ç "><a href="#å­—èŠ‚ç " class="headerlink" title="å­—èŠ‚ç "></a>å­—èŠ‚ç </h3><ol>
<li><code>Java</code>ç¨‹åºå¯ä»¥é€šè¿‡ç¼–è¯‘å™¨å°†æºç ç¼–è¯‘æˆ<code>Java</code>å­—èŠ‚ç ï¼Œç‰¹å®šå¹³å°ä¸Šçš„è™šæ‹Ÿæœºå°†å­—èŠ‚ç è½¬è¯‘ä¸ºå¯ä»¥ç›´æ¥æ‰§è¡Œçš„æœºå™¨ç ï¼Œä¹Ÿå°±å®ç°äº†è·¨å¹³å°æ€§</li>
<li>å­—èŠ‚ç ä¸»è¦ä¸ºäº†å®ç°ç‰¹å®šè½¯ä»¶è¿è¡Œå’Œè½¯ä»¶ç¯å¢ƒï¼Œä¸ç¡¬ä»¶ç¯å¢ƒæ— å…³</li>
</ol>
<h2 id="å³æ—¶ç¼–è¯‘å™¨-JIT-çš„ä½œç”¨"><a href="#å³æ—¶ç¼–è¯‘å™¨-JIT-çš„ä½œç”¨" class="headerlink" title="å³æ—¶ç¼–è¯‘å™¨(JIT)çš„ä½œç”¨"></a>å³æ—¶ç¼–è¯‘å™¨(JIT)çš„ä½œç”¨</h2><ol>
<li>å³æ—¶ç¼–è¯‘å™¨åœ¨æœ€åˆçš„ <code>jvm</code> ä¸­æ˜¯æ²¡æœ‰çš„ï¼Œæ²¡æœ‰çš„åŸå› å°±æ˜¯ <code>jvm</code> è®¾è®¡çš„åˆè¡·æ˜¯ä¸ºäº†æ»¡è¶³ <code>Java</code> ç¨‹åºå®ç°è·¨å¹³å°çš„ç‰¹æ€§ï¼Œæ‰€ä»¥é¿å…é‡‡ç”¨é™æ€ç¼–è¯‘çš„æ–¹å¼ç›´æ¥ç”Ÿæˆæœºå™¨ç ï¼Œæ‰€ä»¥é‡‡ç”¨äº†è§£é‡Šå™¨åœ¨è¿è¡Œæ—¶é€è¡Œè§£é‡Šå­—èŠ‚ç æ‰§è¡Œç¨‹åº</li>
<li><code>JIT</code>ç¼–è¯‘å™¨çš„ä½œç”¨å°±æ˜¯è™šæ‹Ÿæœºå°†å­—èŠ‚ç ç›´æ¥ç¼–è¯‘æˆæœºå™¨ç </li>
<li><strong>æ— è®ºæ˜¯é‡‡ç”¨è§£é‡Šå™¨è¿›è¡Œè§£é‡Šæ‰§è¡Œï¼Œè¿˜æ˜¯é‡‡ç”¨å³æ—¶ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘æ‰§è¡Œï¼Œæœ€ç»ˆå­—èŠ‚ç éƒ½æ˜¯éœ€è¦è¢«è½¬æ¢æˆå¯¹åº”å¹³å°çš„æœºå™¨ç </strong></li>
</ol>
<h2 id="ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦ä½¿ç”¨è§£é‡Šå™¨ä¸ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„"><a href="#ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦ä½¿ç”¨è§£é‡Šå™¨ä¸ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„" class="headerlink" title="ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦ä½¿ç”¨è§£é‡Šå™¨ä¸ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„"></a>ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦ä½¿ç”¨è§£é‡Šå™¨ä¸ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„</h2><p>å› ä¸ºè§£é‡Šå™¨å’Œç¼–è¯‘å™¨å„æœ‰ä¼˜åŠ¿</p>
<ol>
<li>ç¨‹åºå¯åŠ¨åï¼Œè§£é‡Šå™¨å¯ä»¥ç«‹å³å‘æŒ¥ä½œç”¨ï¼Œçœå»ç¼–è¯‘çš„æ—¶é—´ï¼Œç«‹å³æ‰§è¡Œã€‚ç¼–è¯‘å™¨æƒ³è¦å‘æŒ¥ä½œç”¨ï¼Œå°†ä»£ç ç¼–è¯‘æˆæœºå™¨ç ï¼Œéœ€è¦ä¸€å®šçš„æ‰§è¡Œæ—¶é—´ï¼Œä½†æ˜¯ç¼–è¯‘ä¸ºæœºå™¨ç ä¹‹åï¼Œæ‰§è¡Œæ•ˆç‡æ›´é«˜</li>
<li>å½“ç¨‹åºçš„è¿è¡Œç¯å¢ƒä¸­å†…å­˜èµ„æºè¾ƒå¤§(æ¯”å¦‚åµŒå…¥å¼ç³»ç»Ÿ)æ—¶ï¼Œè§£é‡Šæ‰§è¡Œå¯ä»¥æ›´èŠ‚çº¦å†…å­˜</li>
</ol>
<h2 id="ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦å®ç°ä¸¤ä¸ªä¸åŒçš„å³æ—¶ç¼–è¯‘å™¨"><a href="#ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦å®ç°ä¸¤ä¸ªä¸åŒçš„å³æ—¶ç¼–è¯‘å™¨" class="headerlink" title="ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦å®ç°ä¸¤ä¸ªä¸åŒçš„å³æ—¶ç¼–è¯‘å™¨"></a>ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦å®ç°ä¸¤ä¸ªä¸åŒçš„å³æ—¶ç¼–è¯‘å™¨</h2><p><code>HotSpot</code> è™šæ‹ŸæœºåŒ…å«ä¸¤ä¸ªå³æ—¶ç¼–è¯‘å™¨</p>
<ol>
<li><code>Client Compile</code>ï¼Œ ä¹Ÿå«åš <code>c1</code> ç¼–è¯‘å™¨</li>
<li><code>Server Compile</code>ï¼Œä¹Ÿå«åš <code>c2</code> ç¼–è¯‘å™¨</li>
</ol>
<p><code>HotSpot</code> è™šæ‹Ÿæœºé»˜è®¤é‡‡ç”¨è§£é‡Šå™¨å’Œå…¶ä¸­ä¸€ä¸ªç¼–è¯‘å™¨é…åˆçš„æ–¹å¼å·¥ä½œï¼Œç¨‹åºä½¿ç”¨å“ªä¸ªç¼–è¯‘å™¨ï¼Œå–å†³äºè™šæ‹Ÿæœºè¿è¡Œçš„æ¨¡å¼</p>
<p>é€šè¿‡ <code>-client</code> å‚æ•°å¯ä»¥æŒ‡å®š <code>jvm</code> è¿è¡Œåœ¨ <code>Client</code> æ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨ <code>c1</code> ç¼–è¯‘å™¨ï¼Œ<code>c1</code> ç¼–è¯‘å™¨ä¼šå¯¹å­—èŠ‚ç è¿›è¡Œç®€å•å’Œå¯é çš„ä¼˜åŒ–ï¼Œè€—æ—¶çŸ­ï¼Œè¾¾åˆ°æ›´å¿«çš„ç¼–è¯‘é€Ÿåº¦</p>
<p>é€šè¿‡ <code>-server</code> å‚æ•°å¯ä»¥æŒ‡å®š <code>jvm</code> è¿è¡Œåœ¨ <code>Server</code> æ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨ <code>c2</code> ç¼–è¯‘å™¨ï¼Œ<code>c2</code> ä¼šè¿›è¡Œè€—æ—¶è¾ƒé•¿çš„ä¼˜åŒ–ï¼Œä»¥åŠæ¿€è¿›ä¼˜åŒ–ï¼Œä½†ä¼˜åŒ–çš„ä»£ç æ‰§è¡Œæ•ˆç‡æ›´é«˜</p>
<p>å®æ–½åˆ†å±‚ç¼–è¯‘åï¼Œ<code>Client Compiler</code>å’Œ<code>Server Compiler</code>å°†ä¼šåŒæ—¶å·¥ä½œï¼Œè®¸å¤šä»£ç éƒ½å¯èƒ½ä¼šè¢«å¤šæ¬¡ç¼–è¯‘ï¼Œç”¨<code>Client Compiler</code>è·å–æ›´é«˜çš„ç¼–è¯‘é€Ÿåº¦ï¼Œç”¨<code>Server Compiler</code>æ¥è·å–æ›´å¥½çš„ç¼–è¯‘è´¨é‡ï¼Œåœ¨è§£é‡Šæ‰§è¡Œçš„æ—¶å€™ä¹Ÿæ— é¡»å†æ‰¿æ‹…æ”¶é›†æ€§èƒ½ç›‘æ§ä¿¡æ¯çš„ä»»åŠ¡</p>
<h2 id="ç¨‹åºä½•æ—¶ä½¿ç”¨è§£é‡Šå™¨æ‰§è¡Œï¼Ÿä½•æ—¶ä½¿ç”¨ç¼–è¯‘å™¨æ‰§è¡Œï¼Ÿ"><a href="#ç¨‹åºä½•æ—¶ä½¿ç”¨è§£é‡Šå™¨æ‰§è¡Œï¼Ÿä½•æ—¶ä½¿ç”¨ç¼–è¯‘å™¨æ‰§è¡Œï¼Ÿ" class="headerlink" title="ç¨‹åºä½•æ—¶ä½¿ç”¨è§£é‡Šå™¨æ‰§è¡Œï¼Ÿä½•æ—¶ä½¿ç”¨ç¼–è¯‘å™¨æ‰§è¡Œï¼Ÿ"></a>ç¨‹åºä½•æ—¶ä½¿ç”¨è§£é‡Šå™¨æ‰§è¡Œï¼Ÿä½•æ—¶ä½¿ç”¨ç¼–è¯‘å™¨æ‰§è¡Œï¼Ÿ</h2><p>åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¼šè¢«å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘çš„ <strong>çƒ­ç‚¹ä»£ç </strong>åŒ…å«ä¸¤ç±»</p>
<ol>
<li>è¢«<strong>å¤šæ¬¡</strong>è°ƒç”¨çš„æ–¹æ³•</li>
<li>è¢«<strong>å¤šæ¬¡</strong>æ‰§è¡Œçš„å¾ªç¯ä½“</li>
</ol>
<h3 id="çƒ­ç‚¹æ¢æµ‹"><a href="#çƒ­ç‚¹æ¢æµ‹" class="headerlink" title="çƒ­ç‚¹æ¢æµ‹"></a>çƒ­ç‚¹æ¢æµ‹</h3><p>æ— è®ºæ˜¯åŸºäºå¤šæ¬¡è°ƒç”¨çš„æ–¹æ³•è¿˜æ˜¯å¤šæ¬¡æ‰§è¡Œçš„å¾ªç¯ä½“ï¼Œéƒ½å¼ºè°ƒå¤šæ¬¡ï¼Œå…·ä½“å¤šå°‘æ¬¡ç®—å¤šæ¬¡å‘¢ï¼Ÿ åœ¨ <code>HotSpot</code> ä¸­æ˜¯ä½¿ç”¨ <strong>åŸºäºè®¡æ•°å™¨çš„çƒ­ç‚¹æ¢æµ‹</strong> æ–¹å¼æ¥åˆ¤æ–­æ‰§è¡Œçš„æ¬¡æ•°çš„ï¼Œåœ¨ <code>HotSpot</code> è™šæ‹Ÿæœºä¸­ä¸ºæ¯ä¸ªæ–¹æ³•å‡†å¤‡äº†ä¸¤ç±»è®¡æ•°å™¨ï¼Œè¿™ä¸¤ç±»è®¡æ•°å™¨éƒ½æœ‰ç¡®å®šçš„é˜ˆå€¼ï¼Œå½“æŠ€æœ¯å™¨è¶…è¿‡é˜ˆå€¼äº†ï¼Œå°±ä¼šè§¦å‘ <code>JIT</code> ç¼–è¯‘</p>
<ol>
<li>æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ï¼š ç”¨æ¥ç»Ÿè®¡æ–¹æ³•è°ƒç”¨çš„æ¬¡æ•°ï¼Œå¯ä»¥é€šè¿‡å‚æ•° <code>-XX:CompileThreshold</code> æ¥è®¤ä¸ºè®¾ç½®é˜ˆå€¼</li>
<li>å›è¾¹è®¡æ•°å™¨ï¼š ç”¨æ¥ç»Ÿè®¡ä¸€ä¸ªæ–¹æ³•ä¸­å¾ªç¯ä½“ä»£ç æ‰§è¡Œçš„æ¬¡æ•°ï¼Œåœ¨å­—èŠ‚ç ä¸­é‡åˆ°æ§åˆ¶æµå‘åè·³è½¬çš„æŒ‡ä»¤ç§°ä¸º <strong>å›è¾¹</strong></li>
</ol>
]]></content>
      <categories>
        <category>java</category>
        <category>jvm</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>jvmè¿è¡Œæ—¶å†…å­˜åŒºåŸŸ</title>
    <url>/2023/70e7b048ccf4/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>
ä»¥ä¸‹å†…å®¹å‚è€ƒã€Šå‰‘æŒ‡JVM:è™šæ‹Ÿæœºå®è·µä¸æ€§èƒ½è°ƒä¼˜ã€‹

<h2 id="JVM-æ•´ä½“ç»“æ„"><a href="#JVM-æ•´ä½“ç»“æ„" class="headerlink" title="JVM æ•´ä½“ç»“æ„"></a>JVM æ•´ä½“ç»“æ„</h2><ol>
<li><code>JVM</code> åœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´æŠŠå®ƒæ‰€ç®¡ç†çš„å†…å­˜åˆ†ä¸ºè‹¥å¹²ä¸ªä¸åŒçš„æ•°æ®åŒºåŸŸ</li>
<li><code>JVM</code> å†…å­˜å¸ƒå±€è§„å®šäº† <code>Java</code> åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å†…å­˜ç”³è¯·ã€åˆ†é…ã€ç®¡ç†çš„ç­–ç•¥ï¼Œä¿è¯äº†JVMçš„é«˜æ•ˆç¨³å®šè¿è¡Œ</li>
<li>çº¿ç¨‹ç§æœ‰åŒºåŸŸï¼š è™šæ‹Ÿæœºæ ˆï¼Œæœ¬åœ°æ–¹æ³•æ ˆï¼Œç¨‹åºè®¡æ•°å™¨</li>
<li>çº¿ç¨‹å…±äº«åŒºåŸŸï¼š å †ï¼Œæ–¹æ³•åŒº</li>
</ol>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311222254661.png" alt="jvm æ•´ä½“ç»“æ„"></p>
<h2 id="ç¨‹åºè®¡æ•°å™¨"><a href="#ç¨‹åºè®¡æ•°å™¨" class="headerlink" title="ç¨‹åºè®¡æ•°å™¨"></a>ç¨‹åºè®¡æ•°å™¨</h2><h3 id="ç¨‹åºè®¡æ•°å™¨ç›¸å…³æ¦‚å¿µ"><a href="#ç¨‹åºè®¡æ•°å™¨ç›¸å…³æ¦‚å¿µ" class="headerlink" title="ç¨‹åºè®¡æ•°å™¨ç›¸å…³æ¦‚å¿µ"></a>ç¨‹åºè®¡æ•°å™¨ç›¸å…³æ¦‚å¿µ</h3><ol>
<li>ç¨‹åºè®¡æ•°å™¨ä¸­çš„å¯„å­˜å™¨å¹¶éæ˜¯å¹¿ä¹‰ä¸Šæ‰€æŒ‡çš„ç‰©ç†å¯„å­˜å™¨ï¼ŒJVMä¸­çš„ç¨‹åºè®¡æ•°å™¨æ˜¯å¯¹ç‰©ç†å¯„å­˜å™¨çš„ä¸€ç§æŠ½è±¡æ¨¡æ‹Ÿ</li>
<li>JVMä¸­çš„ç¨‹åºè®¡æ•°å™¨è‹±æ–‡å…¨ç§°æ˜¯ Program Counter Register</li>
<li>ç¨‹åºè®¡æ•°å™¨æ—¢æ²¡æœ‰åƒåœ¾å›æ”¶ä¹Ÿæ²¡æœ‰å†…å­˜æº¢å‡º</li>
<li>å¦‚æœçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªJavaæ–¹æ³•ï¼Œè¿™ä¸ªè®¡æ•°å™¨è®°å½•çš„æ˜¯æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼›å¦‚æœæ­£åœ¨æ‰§è¡Œçš„æ˜¯æœ¬åœ°(Native)æ–¹æ³•ï¼Œè¿™ä¸ªè®¡æ•°å™¨å€¼åˆ™åº”ä¸ºç©º(Undefined)</li>
<li>æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç¨‹åºè®¡æ•°å™¨ï¼ˆç¨‹åºè®¡æ•°å™¨å’Œå¯„å­˜å™¨æ˜¯ä¸¤ä¸ªæ¦‚å¿µï¼‰</li>
</ol>
<h3 id="ä¸ºä»€ä¹ˆéœ€è¦ç¨‹åºè®¡æ•°å™¨"><a href="#ä¸ºä»€ä¹ˆéœ€è¦ç¨‹åºè®¡æ•°å™¨" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦ç¨‹åºè®¡æ•°å™¨"></a>ä¸ºä»€ä¹ˆéœ€è¦ç¨‹åºè®¡æ•°å™¨</h3><p>å› ä¸ºCPUéœ€è¦ä¸åœåœ°åˆ‡æ¢å„ä¸ªçº¿ç¨‹ï¼Œåˆ‡æ¢å›æ¥ä»¥åï¼Œå°±éœ€è¦çŸ¥é“æ¥ç€ä»å“ªé‡Œå¼€å§‹ç»§ç»­æ‰§è¡Œã€‚JVMçš„å­—èŠ‚ç è§£é‡Šå™¨é€šè¿‡æ”¹å˜ç¨‹åºè®¡æ•°å™¨çš„å€¼ï¼Œæ¥æ˜ç¡®ä¸‹ä¸€æ¡åº”è¯¥æ‰§è¡Œä»€ä¹ˆæ ·çš„å­—èŠ‚ç æŒ‡ä»¤</p>
<h2 id="è™šæ‹Ÿæœºæ ˆ"><a href="#è™šæ‹Ÿæœºæ ˆ" class="headerlink" title="è™šæ‹Ÿæœºæ ˆ"></a>è™šæ‹Ÿæœºæ ˆ</h2><ol>
<li>æ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ ˆï¼Œå…¶å†…éƒ¨ç”±è®¸å¤šæ ˆå¸§(Stack Frame)æ„æˆï¼Œæ¯ä¸ªæ ˆå¸§å¯¹åº”ç€ä¸€ä¸ªJavaæ–¹æ³•çš„è°ƒç”¨</li>
<li>æ¯ä¸ªæ–¹æ³•è¢«æ‰§è¡Œçš„æ—¶å€™ï¼ŒJVMéƒ½ä¼šåŒæ­¥åˆ›å»ºä¸€ä¸ªæ ˆå¸§ç”¨äºå­˜å‚¨<strong>å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£</strong>ç­‰ä¿¡æ¯</li>
</ol>
<h3 id="æ ˆå¸§-æ ˆçš„å­˜å‚¨å•ä½"><a href="#æ ˆå¸§-æ ˆçš„å­˜å‚¨å•ä½" class="headerlink" title="æ ˆå¸§-æ ˆçš„å­˜å‚¨å•ä½"></a>æ ˆå¸§-æ ˆçš„å­˜å‚¨å•ä½</h3><ol>
<li>æ¯ä¸ªçº¿ç¨‹ä¸Šæ­£åœ¨æ‰§è¡Œçš„æ¯ä¸ªæ–¹æ³•éƒ½å„è‡ªå¯¹åº”ä¸€ä¸ªæ ˆå¸§</li>
</ol>
<h3 id="æ ˆå¸§ä¸­å­˜å‚¨çš„å†…å®¹"><a href="#æ ˆå¸§ä¸­å­˜å‚¨çš„å†…å®¹" class="headerlink" title="æ ˆå¸§ä¸­å­˜å‚¨çš„å†…å®¹"></a>æ ˆå¸§ä¸­å­˜å‚¨çš„å†…å®¹</h3><pre class="mermaid">flowchart TB
  subgraph A[æ ˆ]
    subgraph B[æ ˆå¸§]
      direction LR
        B1[å±€éƒ¨å˜é‡è¡¨]
        B2[æ–¹æ³•è¿”å›å€¼]
        B3[æ“ä½œæ•°æ ˆ]
        B4[åŠ¨æ€é“¾æ¥]
        B5["é™„åŠ ä¿¡æ¯\næ¯”å¦‚å¯¹ç¨‹åºè°ƒè¯•ç›¸å…³ä¿¡æ¯"]
        B1~~~B2~~~B3~~~B4~~~B5
    end
    subgraph C[æ ˆå¸§]
      direction LR
        C1[å±€éƒ¨å˜é‡è¡¨]
        C2[æ–¹æ³•è¿”å›å€¼]
        C3[æ“ä½œæ•°æ ˆ]
        C4[åŠ¨æ€é“¾æ¥]
        C5["é™„åŠ ä¿¡æ¯\næ¯”å¦‚å¯¹ç¨‹åºè°ƒè¯•ç›¸å…³ä¿¡æ¯"]
        C1~~~C2~~~C3~~~C4~~~C5
    end
  end</pre>
<h4 id="å±€éƒ¨å˜é‡è¡¨"><a href="#å±€éƒ¨å˜é‡è¡¨" class="headerlink" title="å±€éƒ¨å˜é‡è¡¨"></a>å±€éƒ¨å˜é‡è¡¨</h4><ol>
<li>å±€éƒ¨å˜é‡è¡¨æ˜¯ä¸€ä¸ªæ•°ç»„</li>
<li>å±€éƒ¨å˜é‡è¡¨çš„ä½œç”¨æ˜¯å­˜å‚¨æ–¹æ³•å‚æ•°å’Œå®šä¹‰åœ¨æ–¹æ³•ä½“å†…çš„å±€éƒ¨å˜é‡<ol>
<li>å±€éƒ¨å˜é‡æ•°æ®ç±»å‹å¯ä»¥æ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå¯¹è±¡å¼•ç”¨(å­˜å‚¨çš„æ˜¯æŒ‡å‘å¯¹è±¡çš„å¼•ç”¨)</li>
</ol>
</li>
<li>å±€éƒ¨å˜é‡è¡¨çš„å¤§å°åœ¨ç¼–è¯‘å™¨ç¡®å®šï¼Œæ–¹æ³•è¿è¡ŒæœŸé—´ä¸ä¼šå¤§æ¦‚å±€éƒ¨å˜é‡è¡¨çš„å¤§å°</li>
</ol>
<h5 id="slot"><a href="#slot" class="headerlink" title="slot"></a>slot</h5><ol>
<li>å±€éƒ¨å˜é‡è¡¨è¾¾å­˜å‚¨å•å…ƒæ˜¯ <code>slot</code></li>
<li>32 ä½ä»¥å†…çš„ç±»å‹åªå ç”¨ä¸€ä¸ª <code>slot</code>ï¼Œ 64 ä½çš„ç±»å‹ï¼ˆ<code>long</code> å’Œ <code>double</code> ï¼‰å ç”¨ä¸¤ä¸ª <code>slot</code></li>
<li><code>byteï¼Œshortï¼Œchar</code> åœ¨å­˜å‚¨å‰ä¼šè¢«è½¬æ¢æˆ <code>int</code></li>
<li><code>JVM</code> ä¼šä¸ºå±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ª <code>slot</code> éƒ½åˆ†é…ä¸€ä¸ªè®¿é—®ç´¢å¼•ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å³å¯æˆåŠŸè®¿é—®åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­æŒ‡å®šçš„å±€éƒ¨å˜é‡å€¼</li>
</ol>
<h4 id="æ“ä½œæ•°æ ˆ"><a href="#æ“ä½œæ•°æ ˆ" class="headerlink" title="æ“ä½œæ•°æ ˆ"></a>æ“ä½œæ•°æ ˆ</h4><ol>
<li>æ“ä½œæ•°æ ˆä¸»è¦ç”¨äºä¿å­˜è®¡ç®—è¿‡ç¨‹çš„ä¸­é—´ç»“æœï¼ŒåŒæ—¶ä½œä¸ºè®¡ç®—è¿‡ç¨‹ä¸­å˜é‡ä¸´æ—¶çš„å­˜å‚¨ç©ºé—´</li>
<li>æ¯ä¸€ä¸ªæ“ä½œæ•°æ ˆéƒ½æ‹¥æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ ˆæ·±åº¦ç”¨äºå­˜å‚¨æ•°å€¼ï¼Œå…¶æ‰€éœ€çš„æœ€å¤§æ·±åº¦åœ¨ç¼–è¯‘æœŸå°±å®šä¹‰å¥½äº†ï¼Œä¿å­˜åœ¨æ–¹æ³•çš„ <code>Code</code> å±æ€§ä¸­çš„<code>Maximum stack size</code>æ•°æ®é¡¹ä¸­</li>
<li>æ“ä½œæ•°æ ˆåªèƒ½é€šè¿‡å…¥æ ˆ(<code>push</code>)å’Œå‡ºæ ˆ(<code>pop</code>)æ“ä½œæ¥å®Œæˆä¸€æ¬¡æ•°æ®è®¿é—®</li>
</ol>
<h4 id="åŠ¨æ€é“¾æ¥"><a href="#åŠ¨æ€é“¾æ¥" class="headerlink" title="åŠ¨æ€é“¾æ¥"></a>åŠ¨æ€é“¾æ¥</h4><ol>
<li>æ¯ä¸€ä¸ªæ ˆå¸§å†…éƒ¨éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­è¯¥æ ˆå¸§æ‰€å±æ–¹æ³•çš„å¼•ç”¨ã€‚åŒ…å«è¿™ä¸ªå¼•ç”¨çš„ç›®çš„å°±æ˜¯ä¸ºäº†æ”¯æŒå½“å‰æ–¹æ³•çš„ä»£ç èƒ½å¤Ÿå®ç°åŠ¨æ€é“¾æ¥</li>
<li>åŠ¨æ€é“¾æ¥çš„ç›®çš„æ˜¯åœ¨ <code>jvm</code> åŠ è½½äº†å­—èŠ‚ç æ–‡ä»¶ï¼Œå°†ç±»æ•°æ®åŠ è½½åˆ°å†…å­˜ä¹‹åï¼Œå¯ä»¥å°†å­—èŠ‚ç æ–‡ä»¶ä¸­è®°å½•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä½ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨</li>
</ol>
<h4 id="æ–¹æ³•è¿”å›åœ°å€"><a href="#æ–¹æ³•è¿”å›åœ°å€" class="headerlink" title="æ–¹æ³•è¿”å›åœ°å€"></a>æ–¹æ³•è¿”å›åœ°å€</h4><ol>
<li>æ–¹æ³•è¿”å›åœ°å€å­˜å‚¨çš„æ˜¯è°ƒç”¨è¯¥æ–¹æ³•çš„ç¨‹åºè®¡æ•°å™¨çš„å€¼</li>
<li>æ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œè°ƒç”¨è€…çš„ç¨‹åºè®¡æ•°å™¨çš„å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€</li>
<li>æ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œè°ƒç”¨è€…çš„ç¨‹åºè®¡æ•°å™¨çš„å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€</li>
</ol>
<h2 id="å †åŒº"><a href="#å †åŒº" class="headerlink" title="å †åŒº"></a>å †åŒº</h2><ol>
<li>å‰é¢è®²è§£çš„ <strong>æ ˆ</strong> è§£å†³çš„æ˜¯ç¨‹åºçš„è¿è¡Œé—®é¢˜ï¼Œå³ç¨‹åºæ˜¯å¦‚ä½•è¿è¡Œï¼Œå¦‚ä½•å¤„ç†æ•°æ®çš„ï¼Œä½†æ˜¯æ•°æ®ä»å“ªé‡Œæ¥å‘¢ï¼Ÿ è¿™å°±æ¶‰åŠåˆ°ä¸‹é¢è¦è®²çš„å †</li>
<li>å †æ˜¯å­˜å‚¨çš„å•ä½ï¼Œå †è§£å†³çš„æ˜¯æ•°æ®å­˜å‚¨çš„é—®é¢˜ï¼Œå³æ•°æ®æ€ä¹ˆæ”¾ã€æ”¾åœ¨å“ªå„¿</li>
</ol>
<h3 id="å †ç©ºé—´çš„åˆ’åˆ†"><a href="#å †ç©ºé—´çš„åˆ’åˆ†" class="headerlink" title="å †ç©ºé—´çš„åˆ’åˆ†"></a>å †ç©ºé—´çš„åˆ’åˆ†</h3><pre class="mermaid">flowchart LR
  subgraph A[å †]
    subgraph B[æ–°ç”Ÿä»£]
      B1["\nEden\n\n"]
      B2["\nfrom\n\n"]
      B3["\nto\n\n"]
      B1~~~B2~~~B3
    end
    subgraph C["\n\n\n &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspè€å¹´ä»£&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp\n\n\n\n"]
    end
  end</pre>

<ol>
<li>å †ç©ºé—´å¯ä»¥é€šè¿‡å‚æ•° <code>-Xms</code>(ä»£è¡¨å †æœ€å°å€¼) å’Œ <code>-Xmx</code> ï¼ˆä»£è¡¨å †ç©ºé—´æœ€å¤§å€¼ï¼‰æ¥è®¾ç½®</li>
<li>æ–°ç”Ÿä»£ä¸è€å¹´ä»£çš„ç©ºé—´æ¯”ä¾‹å¯ä»¥é€šè¿‡ <code>-XX:NewRatio=4</code> å‚æ•°æ¥è®¾ç½®ï¼Œè¿™ä¸ªæ¡ˆä¾‹ä»£è¡¨ï¼Œæ–°ç”Ÿä»£å æ¯”1ï¼Œè€å¹´ä»£å æ¯”4ï¼Œæ–°ç”Ÿä»£å æ•´ä¸ªå †çš„ 1&#x2F;5</li>
<li><code>Eden</code> åŒºå’Œä¸¤ä¸ª <code>Survivor</code> åŒºé»˜è®¤çš„æ¯”ä¾‹æ˜¯ 8:1:1, å¯ä»¥é€šè¿‡å‚æ•° <code>-XX:SurvivorRatio=8</code> æ¥æ˜¾ç¤ºè®¾ç½®æ¯”ä¾‹ï¼Œ å¦‚æœ <code>-XX:SurvivorRatio=5</code> ä»£è¡¨ <code>Eden</code> å’Œä¸¤ä¸ª <code>Survivor</code> åŒºå æ¯”ä¸º 5:1:1</li>
</ol>
<h3 id="å¯¹è±¡å†…å­˜åˆ†é…è¿‡ç¨‹"><a href="#å¯¹è±¡å†…å­˜åˆ†é…è¿‡ç¨‹" class="headerlink" title="å¯¹è±¡å†…å­˜åˆ†é…è¿‡ç¨‹"></a>å¯¹è±¡å†…å­˜åˆ†é…è¿‡ç¨‹</h3><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311232258657.png" alt="å¯¹è±¡å†…å­˜åˆ†é…è¿‡ç¨‹"></p>
<h3 id="TLAB"><a href="#TLAB" class="headerlink" title="TLAB"></a>TLAB</h3><ol>
<li>å †ä¸­è¿˜æœ‰ä¸€éƒ¨åˆ†åŒºåŸŸæ˜¯çº¿ç¨‹ç§æœ‰ï¼Œè¿™éƒ¨åˆ†åŒºåŸŸç§°ä¸ºçº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å­˜åŒº(<code>Thread Local Allocation Buffer,TLAB</code>)</li>
<li><code>TLAB</code> è¡¨ç¤º<code>JVM</code>ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ä¸ªç§æœ‰ç¼“å­˜åŒºåŸŸï¼Œè¿™å—ç¼“å­˜åŒºåŸŸåŒ…å«åœ¨<code>Eden</code>åŒºå†…</li>
<li>å¯ä»¥é€šè¿‡å‚æ•°  <code>-XX:+/-UseTLAB</code> æ¥è®¾ç½®æ˜¯å¦å¼€å¯ <code>TLAB</code> åŠŸèƒ½</li>
<li>å¯ä»¥é€šè¿‡å‚æ•° <code>-XX:TLABWasteTargetPercent</code> å¼€è®¾ç½® <code>TLAB</code> å ç”¨ <code>Eden</code> åŒºåŸŸçš„å¤§å°ï¼Œé»˜è®¤æ˜¯å ç”¨ 1%</li>
<li>å¯¹è±¡åœ¨<code>TLAB</code>ç©ºé—´åˆ†é…å†…å­˜å¤±è´¥æ—¶ï¼Œ<code>JVM</code>å°±ä¼šå°è¯•ç€é€šè¿‡ä½¿ç”¨åŠ é”æœºåˆ¶ç¡®ä¿æ•°æ®æ“ä½œçš„åŸå­æ€§ï¼Œä»è€Œç›´æ¥åœ¨<code>Eden</code>åŒºä¸­åˆ†é…å†…å­˜</li>
</ol>
<h4 id="ä½¿ç”¨-TLAB-çš„åŸå› "><a href="#ä½¿ç”¨-TLAB-çš„åŸå› " class="headerlink" title="ä½¿ç”¨ TLAB çš„åŸå› "></a>ä½¿ç”¨ TLAB çš„åŸå› </h4><ol>
<li>å †åŒºæ˜¯çº¿ç¨‹å…±äº«åŒºåŸŸï¼Œå¯¹è±¡å®ä¾‹çš„åˆ›å»ºåœ¨<code>JVM</code>ä¸­éå¸¸é¢‘ç¹ï¼Œå› æ­¤åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä»å †åŒºä¸­åˆ’åˆ†å†…å­˜ç©ºé—´æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„</li>
<li>é¿å…å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€åœ°å€ï¼Œå°±éœ€è¦ä½¿ç”¨åŠ é”ç­‰æœºåˆ¶ï¼Œä½†æ˜¯åŠ é”ä¼šå½±å“åˆ†é…é€Ÿåº¦</li>
</ol>
<h3 id="é€ƒé€¸åˆ†æ"><a href="#é€ƒé€¸åˆ†æ" class="headerlink" title="é€ƒé€¸åˆ†æ"></a>é€ƒé€¸åˆ†æ</h3><p>é€ƒé€¸åˆ†ææ˜¯æŒ‡ï¼šå½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­åˆ›å»ºåï¼Œè‹¥å¯¹è±¡åªæ˜¯åœ¨æ–¹æ³•å†…éƒ¨ä½¿ç”¨ï¼Œåˆ™è®¤ä¸ºå¯¹è±¡æ²¡æœ‰å‘ç”Ÿé€ƒé€¸ï¼Œè‹¥è¿™ä¸ªå¯¹è±¡è¢«æ–¹æ³•å¤–éƒ¨ä½¿ç”¨ï¼Œåˆ™è®¤ä¸ºå‘ç”Ÿäº†é€ƒé€¸</p>
<h4 id="é€ƒé€¸åˆ†æä¹‹åŒæ­¥çœç•¥"><a href="#é€ƒé€¸åˆ†æä¹‹åŒæ­¥çœç•¥" class="headerlink" title="é€ƒé€¸åˆ†æä¹‹åŒæ­¥çœç•¥"></a>é€ƒé€¸åˆ†æä¹‹åŒæ­¥çœç•¥</h4><p>é‡åˆ°åŒæ­¥ä»£ç å—æ—¶ï¼Œ<code>JIT</code>ç¼–è¯‘å™¨å¯ä»¥å€ŸåŠ©é€ƒé€¸åˆ†æï¼Œæ¥åˆ¤æ–­åŒæ­¥å—æ‰€ä½¿ç”¨çš„é”å¯¹è±¡æ˜¯å¦åªèƒ½å¤Ÿè¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®è€Œæ²¡æœ‰è¢«å‘å¸ƒåˆ°å…¶ä»–çº¿ç¨‹, å¦‚æœæ²¡æœ‰è¢«å‘å¸ƒåˆ°å…¶å®ƒçº¿ç¨‹ï¼Œ<code>JIT</code> ç¼–è¯‘å™¨åœ¨ç¼–è¯‘åŒæ­¥ä»£ç å—æ—¶ä¼šå–æ¶ˆå †è¿™éƒ¨åˆ†ä»£ç çš„åŒæ­¥</p>
<h4 id="é€ƒé€¸åˆ†æä¹‹æ ˆä¸Šåˆ†é…"><a href="#é€ƒé€¸åˆ†æä¹‹æ ˆä¸Šåˆ†é…" class="headerlink" title="é€ƒé€¸åˆ†æä¹‹æ ˆä¸Šåˆ†é…"></a>é€ƒé€¸åˆ†æä¹‹æ ˆä¸Šåˆ†é…</h4><p><code>JIT(Just In Time)</code>ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´æ ¹æ®é€ƒé€¸åˆ†æçš„ç»“æœï¼Œå‘ç°å¦‚æœä¸€ä¸ªå¯¹è±¡æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œå°±å¯èƒ½è¢«ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…</p>
<h4 id="é€ƒé€¸åˆ†æä¹‹æ ‡é‡æ›¿æ¢"><a href="#é€ƒé€¸åˆ†æä¹‹æ ‡é‡æ›¿æ¢" class="headerlink" title="é€ƒé€¸åˆ†æä¹‹æ ‡é‡æ›¿æ¢"></a>é€ƒé€¸åˆ†æä¹‹æ ‡é‡æ›¿æ¢</h4><p>æ ‡é‡<code>(Scalar)</code>æ˜¯æŒ‡ä¸€ä¸ªæ— æ³•å†åˆ†è§£æˆæ›´å°æ•°æ®çš„æ•°æ®ã€‚<code>Java</code>ä¸­çš„åŸå§‹æ•°æ®ç±»å‹å°±æ˜¯æ ‡é‡ã€‚ç›¸å¯¹çš„ï¼Œé‚£äº›è¿˜å¯ä»¥åˆ†è§£çš„æ•°æ®å«ä½œèšåˆé‡<code>(Aggregate)</code>ï¼Œ<code>Java</code>ä¸­çš„å¯¹è±¡å°±æ˜¯èšåˆé‡ï¼Œå› ä¸ºå®ƒå¯ä»¥åˆ†è§£æˆå…¶ä»–èšåˆé‡å’Œæ ‡é‡ã€‚åœ¨<code>JIT</code>ç¼–è¯‘å™¨çš„ç¼–è¯‘é˜¶æ®µï¼Œå¦‚æœç»è¿‡é€ƒé€¸åˆ†æï¼Œå‘ç°ä¸€ä¸ªå¯¹è±¡ä¸ä¼šè¢«å¤–ç•Œè®¿é—®çš„è¯ï¼Œé‚£ä¹ˆç»è¿‡<code>JIT</code>ä¼˜åŒ–ï¼Œå°±ä¼šæŠŠè¿™ä¸ªå¯¹è±¡æ‹†è§£æˆè‹¥å¹²ä¸ªæˆå‘˜å˜é‡ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ ‡é‡æ›¿æ¢</p>
<h1 id="æ–¹æ³•åŒº"><a href="#æ–¹æ³•åŒº" class="headerlink" title="æ–¹æ³•åŒº"></a>æ–¹æ³•åŒº</h1><h3 id="æ–¹æ³•åŒº-æ ˆå’Œå †ä¸‰è€…ä¹‹é—´çš„å…³ç³»"><a href="#æ–¹æ³•åŒº-æ ˆå’Œå †ä¸‰è€…ä¹‹é—´çš„å…³ç³»" class="headerlink" title="æ–¹æ³•åŒº, æ ˆå’Œå †ä¸‰è€…ä¹‹é—´çš„å…³ç³»"></a>æ–¹æ³•åŒº, æ ˆå’Œå †ä¸‰è€…ä¹‹é—´çš„å…³ç³»</h3><p>ä»¥ä¸‹é¢ä»£ç ä¸ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br></pre></td></tr></table></figure>
<ol>
<li><code>Student</code> è¿™ä¸ª <code>class</code> è¿è¡Œæ—¶ä¼šå­˜å‚¨åˆ°æ–¹æ³•åŒº</li>
<li><code>student</code> å¼•ç”¨å˜é‡ä¼šå­˜å‚¨åœ¨æ ˆåŒº</li>
<li><code>new Student()</code> å¯¹è±¡æ˜¯å­˜æ”¾åœ¨å †åŒº</li>
</ol>
<h3 id="jdk-ä¸­æ–¹æ³•åŒºçš„å˜åŒ–"><a href="#jdk-ä¸­æ–¹æ³•åŒºçš„å˜åŒ–" class="headerlink" title="jdk ä¸­æ–¹æ³•åŒºçš„å˜åŒ–"></a>jdk ä¸­æ–¹æ³•åŒºçš„å˜åŒ–</h3><ol>
<li>åœ¨ <code>jdk7</code> ä¹‹å‰ï¼Œå°†æ–¹æ³•åŒºç§°ä¸ºæ°¸ä¹…ä»£ï¼Œåœ¨ <code>jdk8</code> ä¸­ï¼Œæ–¹æ³•åŒºå˜æˆäº† <strong>å…ƒç©ºé—´</strong></li>
<li>æ°¸ä¹…ä»£åœ¨é€»è¾‘ä¸Šå±äºå †çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ç‰©ç†å­˜å‚¨ä¸Šä¸æ˜¯åœ¨å †ä¸­ï¼Œæ‰€ä»¥æ°¸ä¹…ä»£ä¹Ÿå«åš <strong>éå †</strong><ol>
<li>é€šè¿‡<code>-XX:PermSize</code>å‚æ•°è®¾ç½®æ°¸ä¹…ä»£åˆå§‹åˆ†é…ç©ºé—´</li>
<li>é€šè¿‡<code>-XX:MaxPermSize</code>å‚æ•°è®¾ç½®æ°¸ä¹…ä»£æœ€å¤§å¯åˆ†é…ç©ºé—´ã€‚32ä½æœºå™¨é»˜è®¤æ˜¯64MB,64ä½æœºå™¨æ¨¡å¼æ˜¯82MB</li>
<li>å½“ç©ºé—´ä¸è¶³æ—¶ä¼šå‡ºç° <code>java.lang.OutOfMemoryError:PermGen space</code></li>
</ol>
</li>
<li>å…ƒç©ºé—´æ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜å®ç°ï¼Œåªè¦ç‰©ç†å†…å­˜è¿˜æœ‰å®¹é‡ï¼Œå°±ä¸ä¼šæœ‰å†…å­˜æº¢å‡ºçš„é—®é¢˜<ol>
<li>å…ƒç©ºé—´å¤§å°å¯ä»¥ä½¿ç”¨å‚æ•°<code>-XX:MetaspaceSize</code>å’Œ<code>-XX:MaxMetaspaceSize</code>æŒ‡å®šï¼Œæ›¿ä»£<code>JDK7</code>ä¸­çš„æ°¸ä¹…ä»£çš„åˆå§‹å€¼å’Œæœ€å¤§å€¼</li>
<li>å½“ç©ºé—´ä¸è¶³æ—¶ä¼šå‡ºç° <code>java.lang.OutOfMemoryError:Metaspace</code></li>
</ol>
</li>
</ol>
<h3 id="æ–¹æ³•åŒºä¸­å­˜å‚¨çš„å†…å®¹"><a href="#æ–¹æ³•åŒºä¸­å­˜å‚¨çš„å†…å®¹" class="headerlink" title="æ–¹æ³•åŒºä¸­å­˜å‚¨çš„å†…å®¹"></a>æ–¹æ³•åŒºä¸­å­˜å‚¨çš„å†…å®¹</h3><ol>
<li><code>java</code> æºä»£ç ç¼–è¯‘ä¹‹åä¼šç”Ÿæˆ <code>class</code> æ–‡ä»¶ï¼Œç»è¿‡ç±»åŠ è½½å™¨æŠŠ <code>class</code> æ–‡ä»¶ä¸­å†…å®¹åŠ è½½åˆ° <code>jvm</code> è¿è¡Œæ—¶æ•°æ®åŒº</li>
<li><code>class</code> æ–‡ä»¶ä¸­çš„ä¸€éƒ¨åˆ†ä¿¡æ¯ä¼šåŠ è½½åˆ°æ–¹æ³•åŒºï¼Œä¸»è¦åŒ…å«çš„å†…å®¹å¦‚ä¸‹å›¾</li>
</ol>
<pre class="mermaid">flowchart TB
  subgraph A[æ–¹æ³•åŒºå­˜å‚¨çš„å†…å®¹]
    A1[ç±»å‹ä¿¡æ¯]
    A11["ç±»classï¼Œæ¥å£interface,æšä¸¾enmuï¼Œannotaion"]
    A1-->A11

    A2[è¿è¡Œæ—¶å¸¸é‡æ± ]
    A21["classæ–‡ä»¶ä¸­æœ‰ä¸ªconstant pool,\nå½“classæ–‡ä»¶è¢«åŠ è½½åˆ°å†…å­˜ä¹‹åï¼Œæ–¹æ³•åŒºä¹Ÿ\nä¼šå­˜æ”¾classæ–‡ä»¶çš„å¸¸é‡æ± ç›¸å…³ä¿¡æ¯ï¼Œ\næ­¤æ—¶classæ–‡ä»¶çš„å¸¸é‡æ± å°±å˜æˆäº†æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± "]
    A22["è¿è¡Œæ—¶å¸¸é‡æ± ç›¸å¯¹äºclassæ–‡ä»¶å¸¸é‡æ± çš„\nå¦å¤–ä¸€ä¸ªé‡è¦ç‰¹å¾æ˜¯å…·å¤‡åŠ¨æ€æ€§,\nè¿è¡ŒæœŸé—´ä¹Ÿå¯ä»¥å°†æ–°çš„å¸¸é‡ä½¿ç”¨intern()æ”¾å…¥æ± ä¸­"]
    A2-->A21 & A22

    A3[é™æ€å˜é‡]
    A31["jdk7ä¹‹å‰ç±»å˜é‡ä¹Ÿæ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†"]
    A32["jdk7åŠä»¥åç±»å˜é‡æ”¾åœ¨äº†å †ç©ºé—´"]
    A3-->A31 & A32

    A4[JITä»£ç ç¼“å­˜]

    A5[åŸŸä¿¡æ¯]
    A51["åŸŸç›¸å…³ä¿¡æ¯åŒ…å«åŸŸåç§°ï¼Œç±»å‹ï¼Œ\nåŸŸä¿®é¥°ç¬¦(publicï¼Œprivateï¼Œproteced,static,final,volatile)"]
    A5-->A51

    A6["æ–¹æ³•ä¿¡æ¯,åŒ…å«ä»¥ä¸‹å†…å®¹"]
    A61["æ–¹æ³•çš„è¿”å›ç±»å‹ï¼ˆæˆ–voidï¼‰"]
    A62["æ–¹æ³•å‚æ•°çš„æ•°é‡å’Œç±»å‹"]
    A63["æ–¹æ³•çš„ä¿®é¥°ç¬¦(publicï¼Œprivateç­‰)"]
    A64["æ–¹æ³•çš„å­—èŠ‚ç ï¼Œæ“ä½œæ•°æ ˆæ·±åº¦ï¼Œå±€éƒ¨å˜é‡è¡¨å¤§å°"]
    A65["å¼‚å¸¸è¡¨"]
    A6-->A61 & A62 & A63 & A64 & A65
  end</pre>
<h3 id="ä¸åŒç‰ˆæœ¬jdkæ–¹æ³•åŒºçš„å†…å®¹"><a href="#ä¸åŒç‰ˆæœ¬jdkæ–¹æ³•åŒºçš„å†…å®¹" class="headerlink" title="ä¸åŒç‰ˆæœ¬jdkæ–¹æ³•åŒºçš„å†…å®¹"></a>ä¸åŒç‰ˆæœ¬jdkæ–¹æ³•åŒºçš„å†…å®¹</h3><h4 id="jdk6-æ–¹æ³•åŒº"><a href="#jdk6-æ–¹æ³•åŒº" class="headerlink" title="jdk6 æ–¹æ³•åŒº"></a>jdk6 æ–¹æ³•åŒº</h4><pre class="mermaid">flowchart LR
    subgraph A[æ–¹æ³•åŒºå’Œå †]
        subgraph A1["æ–¹æ³•åŒº(æ°¸ä¹…ä»£PermGenå®ç°)"]
            subgraph A11["è¿è¡Œæ—¶å¸¸é‡æ± "]
                A111["å­—ç¬¦ä¸²å¸¸é‡æ± "]
            end
            A12["ç±»å‹ä¿¡æ¯"]
            A13["åŸŸä¿¡æ¯"]
            A14["æ–¹æ³•ä¿¡æ¯"]
            A15["JITä»£ç ç¼“å­˜"]
            A16["é™æ€å˜é‡"]
            A11~~~A12~~~A13~~~A14~~~A15~~~A16
        end
        A2["\n\n\n &nbsp;&nbsp; å † &nbsp;&nbsp; \n\n\n"]
    end</pre>

<h4 id="jdk7-æ–¹æ³•åŒº"><a href="#jdk7-æ–¹æ³•åŒº" class="headerlink" title="jdk7 æ–¹æ³•åŒº"></a>jdk7 æ–¹æ³•åŒº</h4><pre class="mermaid">flowchart LR
    subgraph A[æ–¹æ³•åŒºå’Œå †]
        subgraph A1["æ–¹æ³•åŒº(æ°¸ä¹…ä»£PermGenå®ç°)"]
            A11["è¿è¡Œæ—¶å¸¸é‡æ± "]
            A12["ç±»å‹ä¿¡æ¯"]
            A13["åŸŸä¿¡æ¯"]
            A14["æ–¹æ³•ä¿¡æ¯"]
            A15["JITä»£ç ç¼“å­˜"]
            A11~~~A12~~~A13~~~A14~~~A15
        end
        subgraph A2["å †"]
            A21["å­—ç¬¦ä¸²å¸¸é‡æ± "]
            A22["é™æ€å˜é‡"]
            A21~~~A22
        end
    end</pre>
<h4 id="jdk8-æ–¹æ³•åŒº"><a href="#jdk8-æ–¹æ³•åŒº" class="headerlink" title="jdk8 æ–¹æ³•åŒº"></a>jdk8 æ–¹æ³•åŒº</h4><pre class="mermaid">flowchart LR
    subgraph A[æ–¹æ³•åŒºå’Œå †]
        subgraph A1["æ–¹æ³•åŒº(å…ƒç©ºé—´Metaspaceå®ç°)"]
            A11["è¿è¡Œæ—¶å¸¸é‡æ± "]
            A12["ç±»å‹ä¿¡æ¯"]
            A13["åŸŸä¿¡æ¯"]
            A14["æ–¹æ³•ä¿¡æ¯"]
            A15["JITä»£ç ç¼“å­˜"]
            A11~~~A12~~~A13~~~A14~~~A15
        end
        subgraph A2[å †]
            A21["æ–¹æ³•åŒº(é€»è¾‘ä¸Š\næ˜¯å †çš„ä¸€éƒ¨åˆ†ï¼Œ\nå®é™…ä¸åœ¨å †é‡Œé¢)"]
            subgraph A22[å®é™…å †]
                A221["é™æ€å˜é‡"]
                A222["å­—ç¬¦ä¸²å¸¸é‡æ± "]
            end
            A21~~~A22
        end
        A21-->A1
    end</pre>

<h3 id="æ–¹æ³•åŒºä¸­ä¸ºä»€ä¹ˆä½¿ç”¨å…ƒç©ºé—´æ›¿ä»£æ°¸ä¹…ä»£"><a href="#æ–¹æ³•åŒºä¸­ä¸ºä»€ä¹ˆä½¿ç”¨å…ƒç©ºé—´æ›¿ä»£æ°¸ä¹…ä»£" class="headerlink" title="æ–¹æ³•åŒºä¸­ä¸ºä»€ä¹ˆä½¿ç”¨å…ƒç©ºé—´æ›¿ä»£æ°¸ä¹…ä»£"></a>æ–¹æ³•åŒºä¸­ä¸ºä»€ä¹ˆä½¿ç”¨å…ƒç©ºé—´æ›¿ä»£æ°¸ä¹…ä»£</h3><ol>
<li><code>JRockit</code> è™šæ‹Ÿæœºå’Œ<code>HotSpot</code>è™šæ‹Ÿæœºjè¿›è¡Œèåˆï¼Œè€Œ<code>JRockit</code>ä¸éœ€è¦é…ç½®æ°¸ä¹…ä»£</li>
<li>ä¸ºæ°¸ä¹…ä»£è®¾ç½®ç©ºé—´å¤§å°æ˜¯å¾ˆéš¾ç¡®å®šçš„,å¦‚æœåŠ¨æ€åŠ è½½ç±»è¿‡å¤šï¼Œå®¹æ˜“äº§ç”Ÿæ°¸ä¹…ä»£çš„<code>OOM</code></li>
<li>å…ƒç©ºé—´å’Œæ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶</li>
<li><code>JDK7</code>ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œ<code>HotSpot</code>è™šæ‹Ÿæœºå°†ç±»å‹ä¿¡æ¯ã€å†…éƒ¨å­—ç¬¦ä¸²å’Œç±»é™æ€å˜é‡å­˜å‚¨åœ¨æ°¸ä¹…ä»£ä¸­ï¼Œåƒåœ¾æ”¶é›†å™¨ä¹Ÿä¼šå¯¹è¯¥åŒºåŸŸè¿›è¡Œåƒåœ¾å›æ”¶ã€‚<code>JDK7</code>å°†<code>HotSpot</code>è™šæ‹Ÿæœºä¸­æ°¸ä¹…ä»£å†…éƒ¨å­—ç¬¦ä¸²å’Œç±»é™æ€å˜é‡æ•°æ®ç§»åŠ¨åˆ°<code>Java</code>å †ä¸­ï¼Œä½†æ˜¯ä¾ç„¶å­˜åœ¨æ°¸ä¹…ä»£,å°†å…ƒæ•°æ®ä»æ°¸ä¹…ä»£å‰¥ç¦»å‡ºæ¥æ”¾åˆ°å…ƒç©ºé—´ä¸­ï¼Œä¸ä»…å®ç°äº†å¯¹å…ƒæ•°æ®çš„æ— ç¼ç®¡ç†ï¼Œè€Œä¸”å› ä¸ºå…ƒç©ºé—´å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶ï¼Œä¹Ÿç®€åŒ–äº†<code>Full GC</code>ï¼Œå¹¶ä¸”å¯ä»¥åœ¨<code>GC</code>ä¸æš‚åœçš„æƒ…å†µä¸‹å¹¶å‘åœ°é‡Šæ”¾å…ƒæ•°æ®</li>
</ol>
<h3 id="æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶"><a href="#æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶" class="headerlink" title="æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶"></a>æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶</h3><p>æ–¹æ³•åŒºä¸»è¦å›æ”¶ä¸¤éƒ¨åˆ†å†…å®¹</p>
<ol>
<li>å¸¸é‡æ± ä¸­åºŸå¼ƒçš„å¸¸é‡<ol>
<li>å¸¸é‡æ± ä¸­çš„å­—é¢é‡ï¼šæ¯”å¦‚æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œè¢«å£°æ˜ä¸º <code>final</code>çš„å¸¸é‡å€¼ç­‰</li>
<li>ç¬¦å·å¼•ç”¨ï¼šç±»å’Œæ¥å£çš„å…¨é™å®šåï¼Œå­—æ®µçš„åç§°å’Œæè¿°ç¬¦ï¼Œæ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦</li>
</ol>
</li>
<li>ä¸å†ä½¿ç”¨çš„ç±»å‹ä¿¡æ¯</li>
</ol>
<p>å¸¸é‡æ± ä¸­åˆ¤æ–­å­—é¢é‡æ˜¯å¦ä¸å†ä½¿ç”¨ç®€å•ä¸€äº›ï¼Œä½†æ˜¯åˆ¤æ–­ä¸€ä¸ªç±»å‹æ˜¯å¦å±äºä¸å†è¢«ä½¿ç”¨çš„ç±»ï¼Œåˆ™éœ€è¦æ»¡è¶³ä¸‹é¢çš„æ¡ä»¶</p>
<ol>
<li>è¯¥ç±»çš„æ‰€æœ‰ç¤ºä¾‹éƒ½å·²ç»è¢«å›æ”¶</li>
<li>åŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨å·²ç»è¢«å›æ”¶</li>
<li>è¯¥ç±»çš„ <code>java.lang.Class</code> å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨</li>
</ol>
<p><strong>æ»¡è¶³äº†ä¸Šé¢çš„æ¡ä»¶åªæ˜¯ä»£è¡¨å¯ä»¥ä¼šå›æ”¶ï¼Œå¹¶ä¸æ˜¯ä¸€å®šä¼šè¢«å›æ”¶</strong></p>
]]></content>
      <categories>
        <category>java</category>
        <category>jvm</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>BeanFacotryçš„åç½®å¤„ç†å™¨è¯¦è§£</title>
    <url>/2023/e7d5d1305e5d/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p><strong>Spring ç‰ˆæœ¬ï¼š 6.0.6</strong></p>
<h2 id="BeanFactory-çš„åç½®å¤„ç†å™¨çš„ä½œç”¨"><a href="#BeanFactory-çš„åç½®å¤„ç†å™¨çš„ä½œç”¨" class="headerlink" title="BeanFactory çš„åç½®å¤„ç†å™¨çš„ä½œç”¨"></a>BeanFactory çš„åç½®å¤„ç†å™¨çš„ä½œç”¨</h2><p><code>BeanFactory</code> çš„åç½®å¤„ç†å™¨ï¼ˆ<code>PostProcessor</code>ï¼‰æ˜¯ç”¨äºåœ¨ <code>BeanFactory</code> åŠ è½½å’Œåˆ›å»º <code>bean</code> è¿‡ç¨‹ä¸­å¯¹ <code>bean</code> è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†çš„æ¥å£ã€‚å®ƒæä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥åœ¨ <code>Spring</code> å®¹å™¨å®ä¾‹åŒ– <code>bean</code> ä¹‹å‰å¯¹ <code>bean</code> è¿›è¡Œå®šåˆ¶ã€ä¿®æ”¹æˆ–æ‰©å±•</p>
<h2 id="ä¸¤ç§-BeanFactory-çš„æ¥å£ç±»å‹"><a href="#ä¸¤ç§-BeanFactory-çš„æ¥å£ç±»å‹" class="headerlink" title="ä¸¤ç§ BeanFactory çš„æ¥å£ç±»å‹"></a>ä¸¤ç§ BeanFactory çš„æ¥å£ç±»å‹</h2><h3 id="BeanFactoryPostProcessor"><a href="#BeanFactoryPostProcessor" class="headerlink" title="BeanFactoryPostProcessor"></a>BeanFactoryPostProcessor</h3><p>å¯ä»¥é€šè¿‡ <code>ConfigurableListableBeanFactory</code> å¯¹ <code>BeanDefinition</code> è¿›è¡Œä¿®æ”¹ï¼Œè¿™æ ·å°±ä¼šæ”¹å˜ <code>bean</code> çš„å®šä¹‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BeanDefinitionRegistryPostProcessor"><a href="#BeanDefinitionRegistryPostProcessor" class="headerlink" title="BeanDefinitionRegistryPostProcessor"></a>BeanDefinitionRegistryPostProcessor</h3><p><code>BeanDefinitionRegistryPostProcessor</code> ç»§æ‰¿äº† <code>BeanFactoryPostProcessor</code> æ¥å£ï¼ŒåŒæ—¶å¢åŠ äº†ä¸€ä¸ªæ¥å£ï¼Œè¯¥æ¥å£æä¾›äº† <code>BeanDefinitionRegistry</code> å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åŠ¨æ€æ³¨å…¥ä¸€äº› <code>BeanDefinition</code>ï¼Œ åœ¨ <code>Spring</code> ä¸­å…¸å‹çš„åº”ç”¨æ˜¯ <code>ConfigurationClassPostProcessor</code>ï¼Œåé¢ä¼šåˆ†æè¿™ä¸ªç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanDefinitionRegistryPostProcessor</span> <span class="keyword">extends</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="BeanFactory-åç½®å¤„ç†å™¨çš„ä½¿ç”¨ç¤ºä¾‹"><a href="#BeanFactory-åç½®å¤„ç†å™¨çš„ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="BeanFactory åç½®å¤„ç†å™¨çš„ä½¿ç”¨ç¤ºä¾‹"></a>BeanFactory åç½®å¤„ç†å™¨çš„ä½¿ç”¨ç¤ºä¾‹</h2><h3 id="ä½¿ç”¨ç¤ºä¾‹ç±»è¯´æ˜"><a href="#ä½¿ç”¨ç¤ºä¾‹ç±»è¯´æ˜" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹ç±»è¯´æ˜"></a>ä½¿ç”¨ç¤ºä¾‹ç±»è¯´æ˜</h3><ol>
<li><code>CusBeanFactoryPostProcessor</code> è¯¥ç±»å®ç°äº† <code>BeanFactoryPostProcessor</code> æ¥å£å¹¶ä¸”æ ‡æœ‰ <code>@Component</code> æ³¨è§£</li>
<li><code>CusBeanDefinitionRegistryPostProcessor</code> è¯¥ç±»å®ç°äº† <code>BeanDefinitionRegistryPostProcessor</code> æ¥å£å¹¶ä¸”æ ‡æœ‰ <code>@Component</code> æ³¨è§£</li>
<li><code>RegisterComponent</code> æ™®é€šç±»ï¼Œä¼šé€šè¿‡ <code>CusBeanDefinitionRegistryPostProcessor</code> æ³¨å…¥åˆ° <code>Spring</code> å®¹å™¨</li>
<li><code>ScanComponent</code> æ ‡æœ‰ <code>@Component</code> å’Œ <code>@Scope(&quot;prototype&quot;)</code>, ä¼šé€šè¿‡ <code>CusBeanFactoryPostProcessor</code> å°† <code>scope</code> ä» <code>prototype</code> æ”¹ä¸º <code>singleton</code></li>
<li><code>BeanFactoryPostProcessMain</code> ä¸»ç±»ï¼Œæ ‡æœ‰ <code>@Configuration</code> å’Œ <code>@ComponentScan</code></li>
</ol>
<p>ä¸Šè¿°æ‰€æœ‰ç±»éƒ½æ”¾åœ¨åŒä¸€ä¸ªåŒ…ä¸­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  æ™®é€šç±»ï¼Œå¹¶æ²¡æœ‰å¢åŠ springæ³¨è§£ï¼Œä¼šé€šè¿‡ CusBeanDefinitionRegistryPostProcessor æ³¨å…¥åˆ° Spring å®¹å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegisterComponent</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;RegisterComponent.sayHello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°äº†BeanDefinitionRegistryPostProcessoræ¥å£ï¼Œä¼šè¢«springæ‰«æï¼Œå¹¶ä¸”æ³¨å…¥äº†æ™®é€šç±» RegisterComponent</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CusBeanDefinitionRegistryPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanDefinitionRegistryPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">AbstractBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(RegisterComponent.class).getBeanDefinition();</span><br><span class="line">        registry.registerBeanDefinition(<span class="string">&quot;registerComponent&quot;</span>, beanDefinition);</span><br><span class="line">        System.out.println(<span class="string">&quot;CusBeanDefinitionRegistryPostProcessor postProcessBeanDefinitionRegistry&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CusBeanDefinitionRegistryPostProcessor postProcessBeanFactory&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  è¢«springç®¡ç†çš„ç±»ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•å¤„ç†ä¼šæ˜¯ prototype ä½œç”¨åŸŸï¼Œ è¿™é‡Œä¼šé€šè¿‡ CusBeanFactoryPostProcessor å°† scope æ”¹ä¸º singleton</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Scope(&quot;prototype&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScanComponent</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BeanFactoryDemo1 sayHello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°äº†BeanFactoryPostProcessoræ¥å£ï¼Œä¼šå°†scanComponentç±»çš„scopeä»prototypeæ”¹ä¸ºsingleton</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CusBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">scanComponent</span> <span class="operator">=</span> beanFactory.getBeanDefinition(<span class="string">&quot;scanComponent&quot;</span>);</span><br><span class="line">        scanComponent.setScope(<span class="string">&quot;singleton&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;CusBeanFactoryPostProcessor postProcessBeanFactory&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é…ç½®ä¸»ç±»</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanFactoryPostProcessMain</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(BeanFactoryPostProcessMain.class);</span><br><span class="line">        <span class="comment">// BeanFactoryPostProcessor çš„æµ‹è¯•ï¼ˆä¿®æ”¹äº† ScanComponent ç±»çš„ scope å±æ€§ï¼‰</span></span><br><span class="line">        <span class="type">ScanComponent</span> <span class="variable">bean</span> <span class="operator">=</span> context.getBean(ScanComponent.class);</span><br><span class="line">        System.out.println(bean);</span><br><span class="line">        <span class="type">ScanComponent</span> <span class="variable">bean2</span> <span class="operator">=</span> context.getBean(ScanComponent.class);</span><br><span class="line">        System.out.println(bean2);</span><br><span class="line"></span><br><span class="line">        <span class="type">RegisterComponent</span> <span class="variable">registerComponent</span> <span class="operator">=</span> context.getBean(RegisterComponent.class);</span><br><span class="line">        registerComponent.sayHello(); <span class="comment">// ä¼šæ‰“å° &quot;RegisterComponent.sayHello&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CusBeanDefinitionRegistryPostProcessor postProcessBeanDefinitionRegistry</span><br><span class="line">CusBeanDefinitionRegistryPostProcessor postProcessBeanFactory</span><br><span class="line">CusBeanFactoryPostProcessor postProcessBeanFactory</span><br><span class="line">org.example.beanfactorypost.ScanComponent@5e1fa5b1</span><br><span class="line">org.example.beanfactorypost.ScanComponent@5e1fa5b1</span><br><span class="line">RegisterComponent.sayHello</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢æ‰§è¡Œç»“æœå¯ä»¥å¾—å‡ºå¦‚ä¸‹å‡ ä¸ªç»“è®ºï¼š</p>
<ol>
<li>å…ˆæ‰§è¡Œå®ç°äº† <code>BeanDefinitionRegistryPostProcessor</code> æ¥å£çš„ç±»ï¼Œç„¶åæ‰æ˜¯æ‰§è¡Œçš„ <code>BeanFactoryPostProcessor</code> æ¥å£å®ç°ç±»</li>
<li><code>BeanDefinitionRegistryPostProcessor</code> å®ç°ç±»ç¡®å®å¯ä»¥æ³¨å†Œæ™®é€šå¯¹è±¡æˆä¸º <code>bean</code>, æ¯”å¦‚ä¸Šé¢æ³¨å†Œäº†æ™®é€šå¯¹è±¡ <code>RegisterComponent</code></li>
<li><code>CusBeanFactoryPostProcessor</code> ç±»å·²ç»å°† <code>ScanComponent</code> çš„ <code>scope</code> å±æ€§æ”¹æˆ <code>singleton</code>, å› ä¸ºä¸¤æ¬¡ <code>getBean</code> è·å–çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡</li>
</ol>
<h2 id="BeanFactory-åç½®å¤„ç†å™¨çš„æ‰§è¡Œæ—¶æœº"><a href="#BeanFactory-åç½®å¤„ç†å™¨çš„æ‰§è¡Œæ—¶æœº" class="headerlink" title="BeanFactory åç½®å¤„ç†å™¨çš„æ‰§è¡Œæ—¶æœº"></a>BeanFactory åç½®å¤„ç†å™¨çš„æ‰§è¡Œæ—¶æœº</h2><p>å‚è€ƒ <ol><li><a href="/2023/b93a520f6ddc/index.html" title="Springä¸Šä¸‹æ–‡refreshæ–¹æ³•è§£æ">Springä¸Šä¸‹æ–‡refreshæ–¹æ³•è§£æ</a></li></ol> ä¸­å†™åˆ°çš„ <code>refresh()</code> æ–¹æ³•çš„ç¬¬äº”æ­¥ï¼Œå°±æ˜¯æ‰§è¡Œåç½®å¤„ç†å™¨</p>
<p>æ‰§è¡Œæµç¨‹å¦‚ä¸‹</p>
<pre class="mermaid">sequenceDiagram
    participant A as AnnotationConfigApplicationContext
    participant B as AbstractApplicationContext
    participant C as PostProcessorRegistrationDelegate
    A->>A: new AnnotationConfigApplicationContext(classes)
    A->>B: refresh()
    B->>C: invokeBeanFactoryPostProcessors()
    C->>C: invokeBeanFactoryPostProcessors()</pre>

<p>æ‰€ä»¥æœ€ç»ˆæ˜¯æ‰§è¡Œåˆ° <code>public PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors()</code> æ–¹æ³• ï¼Œ ä»£ç è¿™é‡Œå°±ä¸è´´äº†ï¼Œè¿™é‡Œæ€»ç»“ä¸€ä¸‹</p>
<ol>
<li>æ‰§è¡Œå®ç°äº† <code>BeanDefinitionRegistryPostProcessors</code> å’Œ <code>PriorityOrdered</code> çš„ç±»çš„<code>postProcessBeanDefinitionRegistry()</code> æ–¹æ³•</li>
<li>æ‰§è¡Œå®ç°äº† <code>BeanDefinitionRegistryPostProcessors</code> å’Œ <code>Ordered</code> çš„ç±»çš„<code>postProcessBeanDefinitionRegistry()</code> æ–¹æ³•</li>
<li>æ‰§è¡Œå®ç°äº† <code>BeanDefinitionRegistryPostProcessors</code> å¹¶ä¸”åœ¨ <strong>å‰é¢ä¸¤æ­¥ä¸­æ²¡æœ‰æ‰§è¡Œè¿‡çš„ç±»</strong></li>
<li>å¯¹äºå®ç°äº† <code>BeanFactoryPostProcessor</code> çš„ç±»ï¼Œè°ƒç”¨æµç¨‹ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œæ‰§è¡Œå®ç°äº† <code>PriorityOrdered</code> çš„ç±» -&gt; æ‰§è¡Œå®ç°äº† <code>Ordered</code> çš„ç±» -&gt; æ‰§è¡Œå‰©ä¸‹çš„ç±»</li>
</ol>
<h2 id="BeanDefinitionRegistryPostProcessor-å…¸å‹å®ç°ç±»-ConfigurationClassPostProcessor"><a href="#BeanDefinitionRegistryPostProcessor-å…¸å‹å®ç°ç±»-ConfigurationClassPostProcessor" class="headerlink" title="BeanDefinitionRegistryPostProcessor å…¸å‹å®ç°ç±» ConfigurationClassPostProcessor"></a>BeanDefinitionRegistryPostProcessor å…¸å‹å®ç°ç±» ConfigurationClassPostProcessor</h2><p>åœ¨ <code>Spring</code> å†…éƒ¨ä¹Ÿæ˜¯æœ‰å¾ˆå¤šå®ç°äº† <code>BeanDefinitionRegistryPostProcessor</code> æ¥å£çš„ç±»ï¼Œæ¯”å¦‚ <code>ConfigurationClassPostProcessor</code> ç±»ï¼Œä¸‹é¢å°±æ¥çœ‹çœ‹è¿™ä¸ªç±»</p>
<ol>
<li>å…ˆè¯´æ˜ä¸€ä¸‹ <code>ConfigurationClassPostProcessor</code> è¿™ä¸ªç±»åšçš„äº‹æƒ…ï¼Œåœ¨ <code>Spring</code> ä¸­ <code>@ComponentScan</code> æ³¨è§£å¯ä»¥æ‰¹é‡æ‰«æç±»è¢« <code>Spring</code> ç®¡ç†ï¼Œä½†æ˜¯æ³¨è§£åªæ˜¯èµ·åˆ°ä¸€ä¸ªæ ‡è®°çš„ä½œç”¨ï¼Œéœ€è¦æœ‰åœ°æ–¹æ¥è§£æè¿™ä¸ªæ³¨è§£æ‰è¡Œï¼Œè€Œè¿™ä¸ªè§£æçš„æºå¤´å°±æ˜¯ <code>ConfigurationClassPostProcessor</code>ï¼ŒçœŸæ­£è§£ææ˜¯åœ¨ <code>ConfigurationClassParser</code> ä¸­</li>
<li>å‰é¢æœ‰è¯´è¿‡ <code>BeanDefinitionRegistryPostProcessors</code> æ¥å£çš„å®ç°ç±»å¯ä»¥æ‰¹é‡æ³¨å†Œ <code>BeanDefinition</code> è¢« <code>Spring</code> ç®¡ç†ï¼Œåœ¨ <code>ConfigurationClassParser</code> ä¸­å°† <code>@ComponentScan</code> æ¶‰åŠåˆ°çš„ç±»éƒ½è§£æå‡ºæ¥ä¹‹åï¼Œåˆšå¥½å°±å¯ä»¥æ³¨å†Œåˆ° <code>Spring</code> å®¹å™¨ä¸­</li>
</ol>
<p>ä»£ç æ‰§è¡Œæµç¨‹å¦‚ä¸‹</p>
<figure class="highlight axapta"><table><tr><td class="code"><pre><span class="line">AbstractApplicationContext<span class="meta">#refresh</span></span><br><span class="line">    AbstractApplicationContext<span class="meta">#invokeBeanFactoryPostProcessors</span></span><br><span class="line">        <span class="keyword">public</span> PostProcessorRegistrationDelegate<span class="meta">#invokeBeanFactoryPostProcessors</span></span><br><span class="line">            <span class="keyword">private</span> PostProcessorRegistrationDelegate<span class="meta">#invokeBeanDefinitionRegistryPostProcessors</span></span><br><span class="line">                ConfigurationClassPostProcessor<span class="meta">#postProcessBeanDefinitionRegistry</span></span><br><span class="line">                    ConfigurationClassPostProcessor<span class="meta">#processConfigBeanDefinitions</span></span><br><span class="line">                        ConfigurationClassParser<span class="meta">#parse</span></span><br><span class="line">                            ComponentScanAnnotationParser<span class="meta">#parse</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯ä»£ç çš„æ•´ä½“æ‰§è¡Œæµç¨‹ï¼Œ æœ€ç»ˆæ˜¯é€šè¿‡ <code>ComponentScanAnnotationParser</code> æ¥è¿›è¡Œè§£æ <code>@ComponentScan</code> æ³¨è§£çš„</p>
<h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3><p>ä¸Šé¢ä»£ç æ‰§è¡Œæµç¨‹ä¸­ï¼Œåœ¨ <code>PostProcessorRegistrationDelegate#invokeBeanDefinitionRegistryPostProcessors</code> ä¸­å¯ä»¥å¾—åˆ° <code>ConfigurationClassPostProcessor</code> ç±»ï¼Œä½†æ˜¯è¿™ä¸ªç±»æˆ‘ä»¬å¹¶æ²¡æœ‰æ‰‹åŠ¨è¿›è¡Œæ³¨å†Œã€‚</p>
<p>åœ¨ <code>AbstractApplicationContext</code> ä¸­æœ‰ <code>addBeanFactoryPostProcessor()</code> å¯ä»¥æ‰‹åŠ¨æ³¨å†Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractApplicationContext</span> <span class="keyword">extends</span> <span class="title class_">DefaultResourceLoader</span></span><br><span class="line">		<span class="keyword">implements</span> <span class="title class_">ConfigurableApplicationContext</span> &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBeanFactoryPostProcessor</span><span class="params">(BeanFactoryPostProcessor postProcessor)</span> &#123;</span><br><span class="line">		Assert.notNull(postProcessor, <span class="string">&quot;BeanFactoryPostProcessor must not be null&quot;</span>);</span><br><span class="line">		<span class="built_in">this</span>.beanFactoryPostProcessors.add(postProcessor);</span><br><span class="line">	&#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥è‚¯å®šæ˜¯ <code>Spring</code> åœ¨å“ªä¸ªæ­¥éª¤ä¸­è‡ªå·±æ³¨å†Œäº†ï¼Œè¦æƒ³æ‰¾åˆ°åœ¨å“ªé‡Œæ³¨å†Œçš„ä¹Ÿä¸éš¾ï¼Œé‚£å°±æ˜¯åœ¨ <code>ConfigurationClassPostProcessor</code> ç±»çš„ <code>postProcessBeanDefinitionRegistry()</code> æ–¹æ³•ä¸­æ‰“æ–­ç‚¹ï¼Œç„¶åçœ‹è°ƒç”¨æ ˆï¼Œå°±å¯ä»¥çŸ¥é“ <code>ConfigurationClassPostProcessor</code> å¯¹è±¡æ˜¯ä»å“ªé‡Œè·å–çš„ï¼Œä¸åŒçš„ä¸Šä¸‹æ–‡è®¾ç½®çš„æ–¹å¼å¯èƒ½ä¸åŒï¼Œåœ¨ç»™å‡ºç»“è®ºä¹‹å‰å†çœ‹ä¸€ä¸‹æˆ‘ä»¬çš„ä¸»ç±»æµ‹è¯•ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanFactoryPostProcessMain</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(BeanFactoryPostProcessMain.class);</span><br><span class="line">        <span class="comment">// BeanFactoryPostProcessor çš„æµ‹è¯•ï¼ˆä¿®æ”¹äº† ScanComponent ç±»çš„ scope å±æ€§ï¼‰</span></span><br><span class="line">        <span class="type">ScanComponent</span> <span class="variable">bean</span> <span class="operator">=</span> context.getBean(ScanComponent.class);</span><br><span class="line">        System.out.println(bean);</span><br><span class="line">        <span class="type">ScanComponent</span> <span class="variable">bean2</span> <span class="operator">=</span> context.getBean(ScanComponent.class);</span><br><span class="line">        System.out.println(bean2);</span><br><span class="line"></span><br><span class="line">        <span class="type">RegisterComponent</span> <span class="variable">registerComponent</span> <span class="operator">=</span> context.getBean(RegisterComponent.class);</span><br><span class="line">        registerComponent.sayHello(); <span class="comment">// ä¼šæ‰“å° &quot;RegisterComponent.sayHello&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»æµ‹è¯•ä»£ç ä¸­çœ‹åˆ°ä¸Šä¸‹æ–‡å¯¹è±¡æ˜¯ <code>AnnotationConfigApplicationContext</code>, æ‰€ä»¥ä¸‹é¢ç»™å‡ºçš„ç»“è®ºä¹Ÿæ˜¯åŸºäºè¿™ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡, ä¸‹é¢ä»£ç æ‰§è¡Œæµç¨‹ä½¿ç”¨åºå·è¿›è¡Œæ ‡è®°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// new AnnotationConfigApplicationContext(classes) </span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AnnotationConfigApplicationContext</span><span class="params">(Class&lt;?&gt;... componentClasses)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>();  <span class="comment">// 1</span></span><br><span class="line">    register(componentClasses);</span><br><span class="line">    refresh();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AnnotationConfigApplicationContext ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AnnotationConfigApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">StartupStep</span> <span class="variable">createAnnotatedBeanDefReader</span> <span class="operator">=</span> <span class="built_in">this</span>.getApplicationStartup().start(<span class="string">&quot;spring.context.annotated-bean-reader.create&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.reader = <span class="keyword">new</span> <span class="title class_">AnnotatedBeanDefinitionReader</span>(<span class="built_in">this</span>); <span class="comment">// 2</span></span><br><span class="line">    createAnnotatedBeanDefReader.end();</span><br><span class="line">    <span class="built_in">this</span>.scanner = <span class="keyword">new</span> <span class="title class_">ClassPathBeanDefinitionScanner</span>(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AnnotatedBeanDefinitionReader ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AnnotatedBeanDefinitionReader</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(registry, getOrCreateEnvironment(registry)); <span class="comment">// 3</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// AnnotatedBeanDefinitionReader ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AnnotatedBeanDefinitionReader</span><span class="params">(BeanDefinitionRegistry registry, Environment environment)</span> &#123;</span><br><span class="line">    Assert.notNull(registry, <span class="string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);</span><br><span class="line">    Assert.notNull(environment, <span class="string">&quot;Environment must not be null&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.registry = registry;</span><br><span class="line">    <span class="built_in">this</span>.conditionEvaluator = <span class="keyword">new</span> <span class="title class_">ConditionEvaluator</span>(registry, environment, <span class="literal">null</span>);</span><br><span class="line">    AnnotationConfigUtils.registerAnnotationConfigProcessors(<span class="built_in">this</span>.registry); <span class="comment">// 4</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AnnotationConfigUtils ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerAnnotationConfigProcessors</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    registerAnnotationConfigProcessors(registry, <span class="literal">null</span>); <span class="comment">// 5</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AnnotationConfigUtils ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;BeanDefinitionHolder&gt; <span class="title function_">registerAnnotationConfigProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">			BeanDefinitionRegistry registry, <span class="meta">@Nullable</span> Object source)</span> &#123;</span><br><span class="line">    <span class="comment">// public static final String CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME = &quot;org.springframework.context.annotation.internalConfigurationAnnotationProcessor&quot;;</span></span><br><span class="line">    <span class="comment">// çœç•¥</span></span><br><span class="line">    <span class="keyword">if</span> (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        <span class="type">RootBeanDefinition</span> <span class="variable">def</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(ConfigurationClassPostProcessor.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)); <span class="comment">// 6</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// çœç•¥</span></span><br><span class="line">    <span class="keyword">return</span> beanDefs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AnnotationConfigUtils ç±»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> BeanDefinitionHolder <span class="title function_">registerPostProcessor</span><span class="params">(</span></span><br><span class="line"><span class="params">			BeanDefinitionRegistry registry, RootBeanDefinition definition, String beanName)</span> &#123;</span><br><span class="line">    definition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    registry.registerBeanDefinition(beanName, definition); <span class="comment">// 7</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(definition, beanName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GenericApplicationContext ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span><br><span class="line">        <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line">    <span class="built_in">this</span>.beanFactory.registerBeanDefinition(beanName, beanDefinition); <span class="comment">// 8</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// DefaultListableBeanFactory ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span><br><span class="line">			<span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line">    <span class="comment">// çœç•¥</span></span><br><span class="line">    <span class="built_in">this</span>.beanDefinitionNames.add(beanName); <span class="comment">// 9 </span></span><br><span class="line">    <span class="comment">// çœç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤å·²ç»çŸ¥é“ <code>ConfigurationClassPostProcessor</code> æ˜¯åœ¨ä½•å¤„æ·»åŠ çš„ï¼Œè€Œä¸” <code>ConfigurationClassPostProcessor</code> ç±»å¯¹åº”çš„ <code>beanName</code> æ˜¯ <code>org.springframework.context.annotation.internalConfigurationAnnotationProcessor</code></p>
]]></content>
      <categories>
        <category>java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Springä¸Šä¸‹æ–‡refreshæ–¹æ³•è§£æ</title>
    <url>/2023/b93a520f6ddc/index.html</url>
    <content><![CDATA[<p>æœ¬æ–‡ä¸»è¦è®°å½• <code>AbstractApplicationContext#refresh()</code> æ–¹æ³•ä¸­æ¯ä¸ªæ­¥éª¤çš„ä½œç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">        <span class="type">StartupStep</span> <span class="variable">contextRefresh</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.refresh&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** </span></span><br><span class="line"><span class="comment">         * 1. å‡†å¤‡åˆ·æ–°ä¸Šä¸‹æ–‡æ–¹æ³•,ç”¨äºè®¾ç½®å‡†å¤‡åˆ·æ–°å‰çš„ä¸€äº›å‚æ•°:</span></span><br><span class="line"><span class="comment">		 * ç¨‹åºå¯åŠ¨æ ‡å¿—ä½/ä¸Šä¸‹æ–‡æ‹“å±•èµ„æºåŠ è½½/ä¸Šä¸‹æ–‡ç¯å¢ƒå‡†å¤‡æƒ…å†µéªŒè¯/ç›‘å¬å™¨ç›‘å¬äº‹ä»¶å®¹å™¨åˆå§‹åŒ–å‡†å¤‡</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        prepareRefresh();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 2. æ„å»º BeanFactory å®¹å™¨, é»˜è®¤ä½¿ç”¨çš„ DefaultListableBeanFactory</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 3. å‡†å¤‡ BeanFactory å®¹å™¨, ä¸»è¦æ˜¯å¯¹ BeanFactory è¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 4. åå¤„ç† BeanFactory å®¹å™¨, ä¸»è¦æ˜¯å¯¹ BeanFactory è¿›è¡Œä¸€äº›åå¤„ç†æ“ä½œ</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="type">StartupStep</span> <span class="variable">beanPostProcess</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.beans.post-process&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 5. æ‰§è¡ŒBeanFactoryåç½®å¤„ç†. <span class="doctag">@ComponentScan</span> çš„è§£æå°±æ˜¯é€šè¿‡åç½®å¤„ç†å™¨ ConfigurationClassPostProcessor å®Œæˆ</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 6. æ³¨å†Œ BeanPostProcessor åˆ° bean å·¥å‚ä¸­</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line">            beanPostProcess.end();</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 7. åˆå§‹åŒ– MessageSource èµ„æºï¼Œå›½é™…åŒ–ç›¸å…³çš„å¤„ç†</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            initMessageSource();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * 8. åˆå§‹åŒ– ApplicationEventMulticaster äº‹ä»¶å¹¿æ’­å™¨</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 9. å­ç±»å®ç°,springbootstarterwebåœ¨æ­¤åˆ›å»ºwebå®¹å™¨,å¹¶æå‰ç”Ÿæˆå®¹å™¨æ‰€éœ€çš„BeanåŠå…¶å¯¹åº”ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            onRefresh();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 10. ç»™å¹¿æ’­å™¨ä¸­æ³¨å†Œç›‘å¬å™¨,æ‰§è¡ŒåˆæœŸäº‹ä»¶</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            registerListeners();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 11. åˆå§‹åŒ–æ‰€æœ‰éæ‡’åŠ è½½å•ä¾‹Bean</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 12. å®Œæˆåˆ·æ–°,å‘å¸ƒä¸Šä¸‹æ–‡åˆ·æ–°å®Œæ¯•äº‹ä»¶</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">            <span class="comment">// çœç•¥</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            resetCommonCaches();</span><br><span class="line">            contextRefresh.end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Springä¸­Beançš„ç”Ÿå‘½å‘¨æœŸè¯¦è§£</title>
    <url>/2023/160e87d42e42/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p>springç‰ˆæœ¬ 6.x</p>
<h2 id="Spring-çš„-Bean-ç”Ÿå‘½å‘¨æœŸæœ‰å“ªå‡ ä¸ªé˜¶æ®µ"><a href="#Spring-çš„-Bean-ç”Ÿå‘½å‘¨æœŸæœ‰å“ªå‡ ä¸ªé˜¶æ®µ" class="headerlink" title="Spring çš„ Bean ç”Ÿå‘½å‘¨æœŸæœ‰å“ªå‡ ä¸ªé˜¶æ®µ"></a>Spring çš„ Bean ç”Ÿå‘½å‘¨æœŸæœ‰å“ªå‡ ä¸ªé˜¶æ®µ</h2><p>æ‰€è°“çš„ Bean çš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯ Bean åœ¨æ•´ä¸ªåº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸­æ‰€ç»å†çš„å„ç§çŠ¶æ€ï¼Œä»åˆ›å»ºã€åˆå§‹åŒ–ã€ä½¿ç”¨ã€é”€æ¯ç­‰å„ä¸ªé˜¶æ®µã€‚</p>
<pre class="mermaid">flowchart LR
    subgraph A["åˆ›å»º"]
        style A fill:#f9f
        direction LR
        A1["å®ä¾‹åŒ–Bean[createBeanInstance()æ–¹æ³•]"]
        subgraph A2["åˆå§‹åŒ–è¿‡ç¨‹"]
            style A2 fill:#8ff600
            direction TB
            A21["è®¾ç½®å±æ€§å€¼ populateBean() æ–¹æ³•"]
            A22["è°ƒç”¨å¯¹åº”çš„ Aware æ¥å£ "]
            A23[" BeanPostProcessor å‰ç½®å¤„ç† "]
            A24[" InitializingBean çš„ afterPropertiesSet() æ–¹æ³• "]
            A25[" è‡ªå®šä¹‰ init-method æ–¹æ³• "]
            A26[" BeanPostProcessor åç½®å¤„ç† "]
            A21-->A22-->A23-->A24-->A25-->A26
        end
        A3["æ³¨å†Œ Destruction å›è°ƒ"]
        A1-->A2-->A3
    end
    B[" \nä½¿ç”¨ \n\n"]
    subgraph C["é”€æ¯"]
        direction TB
        C1["DisposableBean#destroy()"]
        C2["è‡ªå®šä¹‰destroy-method"]
        C1-->C2
    end
    A-->B-->C</pre>

<h2 id="Bean-ç”Ÿå‘½å‘¨æœŸä»£ç ç¤ºä¾‹"><a href="#Bean-ç”Ÿå‘½å‘¨æœŸä»£ç ç¤ºä¾‹" class="headerlink" title="Bean ç”Ÿå‘½å‘¨æœŸä»£ç ç¤ºä¾‹"></a>Bean ç”Ÿå‘½å‘¨æœŸä»£ç ç¤ºä¾‹</h2><p>ç¤ºä¾‹ä»£ç åŒ…å«ä»¥ä¸‹å‡ ä¸ªç±»</p>
<ol>
<li><code>LifeCycleBean</code> ä¸»è¦æ˜¯è§‚å¯Ÿè¯¥ç±»åˆ›å»º Bean çš„è¿‡ç¨‹ï¼Œè¯¥ç±»å®ç°äº† <code>ApplicationContextAware</code>, <code>InitializingBean</code>, <code>DisposableBean</code> æ¥å£</li>
<li><code>CusBeanPostProcessor</code> è¯¥ç±»å®ç°äº† <code>BeanPostProcessor</code> æ¥å£</li>
<li><code>LifeCycleMain</code> æµ‹è¯•ä¸»ç±»</li>
</ol>
<figure class="highlight java"><figcaption><span>LifeCycleBeanç±»</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LifeCycleBean</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span>, InitializingBean, DisposableBean &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LifeCycleBean</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œæ„é€ æ–¹æ³• &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@PostConstruct init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DisposableBean -- destroy &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;InitializingBean afterPropertiesSet &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ApplicationContextAware setApplicationContext&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>CusBeanPostProcessorç±»</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CusBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CusBeanPostProcessor before, current beanName:&quot;</span> + beanName);</span><br><span class="line">        <span class="keyword">return</span> BeanPostProcessor.<span class="built_in">super</span>.postProcessBeforeInitialization(bean, beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CusBeanPostProcessor after, current beanName:&quot;</span> + beanName);</span><br><span class="line">        <span class="keyword">return</span> BeanPostProcessor.<span class="built_in">super</span>.postProcessAfterInitialization(bean, beanName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>LifeCycleMainæµ‹è¯•ä¸»ç±»</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LifeCycleMain</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(LifeCycleMain.class);</span><br><span class="line">        <span class="type">LifeCycleBean</span> <span class="variable">bean</span> <span class="operator">=</span> context.getBean(LifeCycleBean.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">æ‰§è¡Œæ„é€ æ–¹æ³• </span><br><span class="line">ApplicationContextAware setApplicationContext</span><br><span class="line">CusBeanPostProcessor <span class="keyword">before</span>, <span class="keyword">current</span> beanName:lifeCycleBean</span><br><span class="line">@PostConstruct init</span><br><span class="line">InitializingBean afterPropertiesSet </span><br><span class="line">CusBeanPostProcessor <span class="keyword">after</span>, <span class="keyword">current</span> beanName:lifeCycleBean</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šè¿°æµ‹è¯•ä»£ç æ¥çœ‹ï¼Œåœ¨åˆ›å»º <code>LifeCycleBean</code> è¿™ä¸ª Bean è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œé¡ºåºæ˜¯</p>
<ol>
<li>æ‰§è¡Œå¯¹åº”ç±»çš„æ„é€ æ–¹æ³•</li>
<li>æ‰§è¡Œå¯¹åº” Aware æ¥å£çš„æ–¹æ³•</li>
<li>æ‰§è¡Œ BeanPostProcessor å‰ç½®å¤„ç†æ–¹æ³•</li>
<li>æ‰§è¡Œ <code>@PostConstruct</code> æ³¨è§£å®šä¹‰çš„æ–¹æ³•</li>
<li>æ‰§è¡Œ InitializingBean ä¸­çš„ afterPropertiesSet æ–¹æ³•</li>
<li>æ‰§è¡Œ BeanPostProcessor åç½®å¤„ç†æ–¹æ³•</li>
</ol>
<h2 id="Spring-Bean-ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œæµç¨‹"><a href="#Spring-Bean-ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œæµç¨‹" class="headerlink" title="Spring Bean ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œæµç¨‹"></a>Spring Bean ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œæµç¨‹</h2><figure class="highlight leaf"><table><tr><td class="code"><pre><span class="line">AbstractApplicationContext<span class="punctuation">#</span><span class="keyword">refresh</span></span><br><span class="line">    AbstractApplicationContext<span class="punctuation">#</span><span class="keyword">finishBeanFactoryInitialization</span></span><br><span class="line">        DefaultListableBeanFactory<span class="punctuation">#</span><span class="keyword">preInstantiateSingletons</span></span><br><span class="line">            AbstractBeanFactory<span class="punctuation">#</span><span class="keyword">getBean</span><span class="params">(<span class="variable">java</span>.<span class="variable">lang</span>.<span class="variable">String</span>)</span></span><br><span class="line">                AbstractBeanFactory<span class="punctuation">#</span><span class="keyword">doGetBean</span></span><br><span class="line">                    DefaultSingletonBeanRegistry<span class="punctuation">#</span><span class="keyword">getSingleton</span><span class="params">(<span class="variable">ObjectFactory</span><span class="operator">&lt;</span>?<span class="operator">&gt;</span>)</span></span><br><span class="line">                        AbstractAutowireCapableBeanFactory<span class="punctuation">#</span><span class="keyword">createBean</span><span class="params">(<span class="variable">String</span> <span class="variable">beanName</span>, <span class="variable">RootBeanDefinition</span>, <span class="variable">java</span>.<span class="variable">lang</span>.<span class="variable">Object</span>[])</span></span><br><span class="line">                            AbstractAutowireCapableBeanFactory<span class="punctuation">#</span><span class="keyword">doCreateBean</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°æµç¨‹æ˜¯åˆ›å»º Bean çš„è°ƒç”¨è¿‡ç¨‹ï¼Œæœ€ç»ˆæ˜¯åœ¨ <code>AbstractAutowireCapableBeanFactory</code> ä¸­è°ƒç”¨ <code>doCreateBean</code> æ–¹æ³•æ¥åˆ›å»ºï¼Œæ‰€ä»¥ç›´æ¥çœ‹ä¸‹è¿™éƒ¨åˆ†ä»£ç ï¼ˆçœç•¥å’Œæ­¤æ¬¡æµç¨‹æ— å…³ä»£ç ï¼‰</p>
<figure class="highlight java"><figcaption><span>AbstractAutowireCapableBeanFactoryç±»</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">doCreateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span><br><span class="line">        <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instantiate the bean.</span></span><br><span class="line">    <span class="type">BeanWrapper</span> <span class="variable">instanceWrapper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (instanceWrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ­¥éª¤1ï¼š å®ä¾‹åŒ– Bean</span></span><br><span class="line">        instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> instanceWrapper.getWrappedInstance();</span><br><span class="line">    Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();</span><br><span class="line">    <span class="keyword">if</span> (beanType != NullBean.class) &#123;</span><br><span class="line">        mbd.resolvedTargetType = beanType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize the bean instance.</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">exposedObject</span> <span class="operator">=</span> bean;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ­¥éª¤2ï¼š è®¾ç½®å±æ€§</span></span><br><span class="line">        populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">        <span class="comment">// æ­¥éª¤3ï¼š è°ƒç”¨ aware æ¥å£ -ã€‹è°ƒç”¨ BeanPostProcessor å‰ç½®æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// -ã€‹ è°ƒç”¨  InitializingBean çš„ afterPropertiesSet æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// -ã€‹ è°ƒç”¨  è‡ªå®šä¹‰çš„ init-method æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// -ã€‹ è°ƒç”¨  è‡ªå®šä¹‰çš„ init-method æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// -ã€‹ è°ƒç”¨ BeanPostProcessor åç½®æ–¹æ³•</span></span><br><span class="line">        exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register bean as disposable.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ­¥éª¤4ï¼š æ³¨å†Œé”€æ¯æ–¹æ³•</span></span><br><span class="line">        registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> exposedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ä¾‹åŒ–(<strong>æ­¥éª¤1</strong>)å’Œè®¾ç½®å±æ€§å€¼(<strong>æ­¥éª¤2</strong>) å°±ä¸çœ‹äº†ï¼Œä¸»è¦çœ‹ä¸€ä¸‹ <strong>æ­¥éª¤3</strong>ï¼Œè¿™ä¸ªæ­¥éª¤åŒ…å«äº† Bean ç”Ÿå‘½å‘¨æœŸä¸­æ•´ä¸ªåˆå§‹åŒ–è¿‡ç¨‹</p>
<figure class="highlight java"><figcaption><span>AbstractAutowireCapableBeanFactoryç±»</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">initializeBean</span><span class="params">(String beanName, Object bean, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span> &#123;</span><br><span class="line">    <span class="comment">// æ­¥éª¤3.1 è°ƒç”¨å¯¹åº”çš„ Aware æ¥å£</span></span><br><span class="line">    invokeAwareMethods(beanName, bean);</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">wrappedBean</span> <span class="operator">=</span> bean;</span><br><span class="line">    <span class="keyword">if</span> (mbd == <span class="literal">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">        <span class="comment">// æ­¥éª¤3.2 è°ƒç”¨ BeanPostProcessor å‰ç½®æ–¹æ³•</span></span><br><span class="line">        wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ­¥éª¤3.3 è°ƒç”¨ InitializingBean çš„ afterPropertiesSet æ–¹æ³• å’Œ è‡ªå®šä¹‰çš„ init-method æ–¹æ³•</span></span><br><span class="line">        invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">                (mbd != <span class="literal">null</span> ? mbd.getResourceDescription() : <span class="literal">null</span>), beanName, ex.getMessage(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mbd == <span class="literal">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">        <span class="comment">// æ­¥éª¤3.4 è°ƒç”¨ BeanPostProcessor åç½®æ–¹æ³•</span></span><br><span class="line">        wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrappedBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ­¥éª¤3.3</strong> ä¸­æ˜¯è°ƒç”¨ <code>InitializingBean</code> çš„ <code>afterPropertiesSet</code> æ–¹æ³• å’Œ è‡ªå®šä¹‰çš„ <code>init-method</code> æ–¹æ³•ï¼Œ è°ƒç”¨ <code>InitializingBean</code> æ¥å£çš„æ–¹æ³•è¿˜æ¯”è¾ƒå¥½è¯´ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯è‡ªå®šä¹‰çš„ <code>init-method</code> æ–¹æ³•å‘¢ï¼Ÿçœ‹å¦‚ä¸‹ç¤ºä¾‹ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  è¿™æ˜¯ä¸€ä¸ª æ™®é€š ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LifeCycleBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;LifeCycleBean initMethod&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroyMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;LifeCycleBean destroyMethod&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;LifeCycleBean sayHello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LifeCycleMain</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ @Bean æ³¨å…¥ LifeCycleBean ç±»ï¼ŒåŒæ—¶æ·»åŠ äº† initMethod å’Œ destroyMethod æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Bean(initMethod = &quot;initMethod&quot;, destroyMethod=&quot;destroyMethod&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> LifeCycleBean <span class="title function_">lifeCycleBean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LifeCycleBean</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(LifeCycleMain.class);</span><br><span class="line">        context.getBean(LifeCycleBean.class).sayHello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">LifeCycleBean initMethod</span></span><br><span class="line"><span class="attribute">LifeCycleBean sayHello</span></span><br></pre></td></tr></table></figure>

<p>é‡ç‚¹æ‰§è¡Œæµç¨‹å¯¼è‡´å°±ç»“æŸäº†</p>
]]></content>
      <categories>
        <category>java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Springä¸­DeferredImportSelectoræºç è§£æ</title>
    <url>/2023/55186be8f39b/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p>Springç‰ˆæœ¬: 6.0.6</p>
<p><code>DeferredImportSelector</code> æ˜¯ <code>ImportSelector</code> çš„å­æ¥å£ï¼Œæ‰€ä»¥éœ€è¦å…ˆäº†è§£ <code>ImportSelector</code> çš„ä½œç”¨ï¼Œå¯ä»¥å‚è€ƒ <ol><li><a href="/2023/73d35f59945c/index.html" title="Springä¸­Importæ³¨è§£æºç è§£æ">Springä¸­Importæ³¨è§£æºç è§£æ</a></li></ol></p>
<h2 id="ç®€è¿°-ImportSelector-çš„ä½œç”¨"><a href="#ç®€è¿°-ImportSelector-çš„ä½œç”¨" class="headerlink" title="ç®€è¿° ImportSelector çš„ä½œç”¨"></a>ç®€è¿° ImportSelector çš„ä½œç”¨</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ImportSelector</span> &#123;</span><br><span class="line"></span><br><span class="line">	String[] selectImports(AnnotationMetadata importingClassMetadata);</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">default</span> Predicate&lt;String&gt; <span class="title function_">getExclusionFilter</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç›´æ¥æ€»ç»“ä¸€ä¸‹ <code>ImportSelector</code> çš„ä½œç”¨ï¼Œ<code>selectImports()</code> æ–¹æ³•è¿”å›å€¼æ˜¯éœ€è¦å¯¼å…¥çš„ç±»çš„å…¨é™å®šç±»åç»„æˆçš„æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æ‰¹é‡æ³¨å†Œæ™®é€šç±»ç»™ <code>Spring</code> è¿›è¡Œç®¡ç†ï¼Œ <code>getExclusionFilter()</code> åˆ™æ˜¯å¯ä»¥è¿‡æ»¤æ‰ä¸æƒ³è¦æ³¨å†Œçš„ç±»</p>
<h2 id="DeferredImportSelector-å’Œ-ImportSelector-çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ"><a href="#DeferredImportSelector-å’Œ-ImportSelector-çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ" class="headerlink" title="DeferredImportSelector å’Œ ImportSelector çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ"></a>DeferredImportSelector å’Œ ImportSelector çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ</h2><p>å…ˆçœ‹ä¸€ä¸‹ <code>DeferredImportSelector</code> æ¥å£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeferredImportSelector</span> <span class="keyword">extends</span> <span class="title class_">ImportSelector</span> &#123;</span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">default</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">Group</span>&gt; getImportGroup() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">interface</span> <span class="title class_">Group</span> &#123;</span><br><span class="line">        <span class="comment">// ç¬¬äºŒä¸ªå‚æ•° selector å°±æ˜¯å¯¹åº” DeferredImportSelector å®ç°ç±»</span></span><br><span class="line">		<span class="keyword">void</span> <span class="title function_">process</span><span class="params">(AnnotationMetadata metadata, DeferredImportSelector selector)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿”å›éœ€è¦è¢«å¯¼å…¥çš„ç±»å…¨é™å®šç±»åï¼Œå°±å’Œ ImportSelector æ¥å£ä¸­çš„ selectImports æ–¹æ³•ç±»ä¼¼</span></span><br><span class="line">		Iterable&lt;Entry&gt; <span class="title function_">selectImports</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Entry å°±æ˜¯ç”¨æ¥ä¿å­˜éœ€è¦å¯¼å…¥çš„ç±»çš„å…¨é™å®šç±»åå’Œ å…ƒæ•°æ®ä¿¡æ¯</span></span><br><span class="line">		<span class="keyword">class</span> <span class="title class_">Entry</span> &#123;</span><br><span class="line">			<span class="keyword">private</span> <span class="keyword">final</span> AnnotationMetadata metadata;</span><br><span class="line">			<span class="keyword">private</span> <span class="keyword">final</span> String importClassName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>è¡¨é¢ä¸Šçœ‹æ¥ <code>DeferredImportSelector</code> ä¸ <code>ImportSelector</code> çš„åŒºåˆ«æ˜¯ <code>DeferredImportSelector</code> ä¸­å¤šäº†ä¸€ä¸ªå†…éƒ¨æ¥å£</p>
</li>
<li><p>å®é™…æ˜¯æ˜¯ <code>DeferredImportSelector</code> å’Œ <code>ImportSelector</code> çš„æ‰§è¡Œæ—¶æœºä¸ä¸€æ ·</p>
<ol>
<li><code>ImportSelector</code> æ˜¯åœ¨è§£æå¯¹åº”çš„å®ç°ç±»æ—¶å°±ä¼šç›´æ¥å¤„ç†éœ€è¦å¯¼å…¥çš„ç±»</li>
<li><code>DeferredImportSelector</code> æ˜¯æä¾›äº†ä¸€ç§å»¶è¿Ÿå¯¼å…¥é…ç½®ç±»çš„æœºåˆ¶ï¼Œ<code>SpringBoot</code> çš„è‡ªåŠ¨è£…é…å°±æ˜¯ç”¨åˆ°äº† <code>DeferredImportSelector</code> å»¶è¿Ÿå¯¼å…¥çš„åŠŸèƒ½ï¼Œè¿™ä¸ªå»¶è¿Ÿçš„æ„æ€æ˜¯ï¼Œéè‡ªåŠ¨è£…é…çš„ç±»éƒ½è§£æå®Œæˆä¹‹åæ‰ä¼šå»å¯¼å…¥è‡ªåŠ¨è£…é…çš„ç±»ï¼Œå…·ä½“æºç ä¼šåœ¨ä¸‹é¢è¯´æ˜</li>
</ol>
</li>
<li><p>é™¤äº†å»¶è¿Ÿå¯¼å…¥æœºåˆ¶ï¼Œå¦‚æœ <code>DeferredImportSelector</code> å®ç°ç±»æ²¡æœ‰å®ç° <code>Group</code> æ¥å£çš„è¯ï¼Œå…¶ä»–æ–¹æ³•å’Œ <code>ImportSelector</code> ä¸€æ ·ï¼Œå› ä¸ºå½“æ²¡æœ‰å®ç° <code>Group</code> æ¥å£æ—¶ä¼šä½¿ç”¨ <code>Spring</code> æä¾›çš„é»˜è®¤çš„å®ç°ç±» <code>DefaultDeferredImportSelectorGroup</code>, å¯ä»¥ä»ä¸‹é¢ä»£ç çœ‹åˆ°é»˜è®¤çš„å®ç°ä¸­ <code>process()</code> æ–¹æ³•ç›´æ¥è°ƒç”¨çš„å°±æ˜¯ <code>selector.selectImports()</code> æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯ç›´æ¥è°ƒç”¨çš„å°±æ˜¯ <code>ImportSelector</code> æ¥å£çš„ <code>selectImports()</code> æ–¹æ³•ï¼Œå› æ­¤æ­¤æ—¶å’Œ <code>ImportSelector</code> æ¥å£åœ¨åŠŸèƒ½ä¸Šæ˜¯ä¸€è‡´çš„ã€å½“ç„¶ï¼Œæ‰§è¡Œæ—¶æœºè¿˜æ˜¯ä¸åŒã€‘</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DefaultDeferredImportSelectorGroup</span> <span class="keyword">implements</span> <span class="title class_">Group</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Entry&gt; imports = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(AnnotationMetadata metadata, DeferredImportSelector selector)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (String importClassName : selector.selectImports(metadata)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.imports.add(<span class="keyword">new</span> <span class="title class_">Entry</span>(metadata, importClassName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Iterable&lt;Entry&gt; <span class="title function_">selectImports</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.imports;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DeferredImportSelector-ä½¿ç”¨ç¤ºä¾‹"><a href="#DeferredImportSelector-ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="DeferredImportSelector ä½¿ç”¨ç¤ºä¾‹"></a>DeferredImportSelector ä½¿ç”¨ç¤ºä¾‹</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ™®é€šçš„ç±»ï¼Œè¿™ä¸ªç±»æ²¡æœ‰ä»»ä½•æ³¨è§£ï¼Œå°±æ˜¯ä¸ºäº†è®© DeferredImportSelector æ¥å¯¼å…¥çš„</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefImportBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DefImportBean sayHello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°äº† DeferredImportSelector æ¥å£çš„ç±»ï¼Œè¿™ä¸ªç±»çš„ä½œç”¨æ˜¯ä¸ºäº†å¯¼å…¥ DefImportBean ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CusDeferredImportSelector</span> <span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å®é™…å¯¼å…¥ --- 2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;DefImportBean.class.getName()&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰å¯¼å…¥åˆ†ç»„ï¼Œè¿™ä»£è¡¨ä¸ä½¿ç”¨é»˜è®¤çš„DefaultDeferredImportSelectorGroupï¼Œ å¦‚æœæ²¡æœ‰å¯¼å…¥å°±ç®—å†™äº† Group å®ç°ç±»ä¹Ÿä¸ä¼šä½¿ç”¨çš„</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">Group</span>&gt; getImportGroup() &#123;</span><br><span class="line">        <span class="keyword">return</span> CusImportSelectorBeanGroup.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CusImportSelectorBeanGroup</span> <span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span>.Group &#123;</span><br><span class="line">        <span class="comment">// ç”¨æ¥ä¿å­˜éœ€è¦å¯¼å…¥çš„ç±»</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Entry&gt; instanceImports = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(AnnotationMetadata metadata, DeferredImportSelector selector)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ä½¿ç”¨äº†è‡ªå®šä¹‰çš„åˆ†ç»„ ----  1&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (String importClassName : selector.selectImports(metadata)) &#123;</span><br><span class="line">                <span class="built_in">this</span>.instanceImports.add(<span class="keyword">new</span> <span class="title class_">Entry</span>(metadata, importClassName));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Iterable&lt;Entry&gt; <span class="title function_">selectImports</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;çœŸæ­£è¿”å› -- 3&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> instanceImports;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸»ç±»ï¼Œä½¿ç”¨äº† Import å¯¼å…¥äº† å®ç°äº† CusDeferredImportSelector æ¥å£çš„ç±»</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(CusDeferredImportSelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefImportMain</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(DefImportMain.class);</span><br><span class="line">        <span class="type">DefImportBean</span> <span class="variable">defImportBean</span> <span class="operator">=</span> context.getBean(DefImportBean.class);</span><br><span class="line">        defImportBean.sayHello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœï¼š</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">ä½¿ç”¨äº†è‡ªå®šä¹‰çš„åˆ†ç»„ <span class="comment">----  1</span></span><br><span class="line">å®é™…å¯¼å…¥ <span class="comment">--- 2</span></span><br><span class="line">çœŸæ­£è¿”å› <span class="comment">-- 3</span></span><br><span class="line">DefImportBean sayHello</span><br></pre></td></tr></table></figure>

<p>ä»æ‰“å°ç»“æœä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°å®ç°äº† <code>DeferredImportSelector</code> æ¥å£çš„ç±»çš„æ‰§è¡Œé¡ºåºå¦‚ä¸‹</p>
<pre class="mermaid">flowchart TB
    A["Groupå®ç°ç±»ä¸­çš„ process() æ–¹æ³•"]
    B["DeferredImportSelectorå®ç°ç±» 
     ä¸­çš„ selectImports() æ–¹æ³• 
     ï¼ˆè¯¥æ–¹æ³•ä¸ä¸€å®šæ‰§è¡Œï¼Œå½“ Group å®ç°ç±»ä¸­
     æœ‰è°ƒç”¨çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œï¼Œæ²¡æœ‰è°ƒç”¨å°±æ²¡æœ‰æ‰§è¡Œ
     SpringBootè‡ªåŠ¨è£…é…æ—¶å°±æ²¡æœ‰æ‰§è¡Œ selectImports() æ–¹æ³•ï¼‰"]
    C["Groupå®ç°ç±»ä¸­çš„ selectImports() æ–¹æ³•
    è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼æ‰æ˜¯çœŸæ­£è¦è¢«
    å¯¼å…¥çš„ç±»"]
    A-->B-->C</pre>

<h2 id="DeferredImportSelector-æ‰§è¡Œæµç¨‹æºç è§£æ"><a href="#DeferredImportSelector-æ‰§è¡Œæµç¨‹æºç è§£æ" class="headerlink" title="DeferredImportSelector æ‰§è¡Œæµç¨‹æºç è§£æ"></a>DeferredImportSelector æ‰§è¡Œæµç¨‹æºç è§£æ</h2><p>åœ¨æºç åˆ†æä¹‹å‰å…ˆç†Ÿæ‚‰ä¸€ä¸‹ä¼šæ¶‰åŠåˆ°çš„å‡ ä¸ªç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DeferredImportSelectorHolder</span> &#123;</span><br><span class="line">    <span class="comment">// é…ç½®ä¸»ç±»ï¼Œåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­å°±æ˜¯ DefImportMain å¯¹åº”çš„ ConfigurationClass</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ConfigurationClass configurationClass;</span><br><span class="line">    <span class="comment">// ä¿å­˜çš„å°±æ˜¯ DeferredImportSelector å®ç°ç±»</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> DeferredImportSelector importSelector;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‰é¢æœ‰è¯´è¿‡ DeferredImportSelector æ˜¯ä¼šå»¶è¿Ÿæ³¨å…¥çš„ï¼Œæ—¢ç„¶è¦å»¶è¿Ÿï¼Œé‚£å°±éœ€è¦å…ˆå°†å…¶å­˜åœ¨ä¸€ä¸ªåœ°æ–¹ï¼ŒDeferredImportSelectorHandler ç±»å°±æ˜¯ä¿å­˜æ‰€æœ‰çš„ DeferredImportSelector å®ç°ç±»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">DeferredImportSelectorHandler</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> List&lt;DeferredImportSelectorHolder&gt; deferredImportSelectors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DeferredImportSelector</code> çš„è§£æå…¶å®æ˜¯é€šè¿‡ <code>BeanFactory</code> çš„åç½®å¤„ç†å™¨å®ç°çš„ï¼Œå¯¹åº”çš„ <code>BeanFactory</code> åç½®å¤„ç†å™¨ç±»æ˜¯ <code>ConfigurationClassPostProcessor</code>ï¼Œè€Œè§£æ <code>Import</code> æ³¨è§£çš„ç±»åˆ™æ˜¯ <code>ConfigurationClassParser</code>ï¼Œè¿™é‡Œå†ç®€å•å†™ä¸€ä¸‹è§£æé¡ºåºæµç¨‹</p>
<figure class="highlight leaf"><table><tr><td class="code"><pre><span class="line">AbstractApplicationContext<span class="punctuation">#</span><span class="keyword">refresh</span></span><br><span class="line">    AbstractApplicationContext<span class="punctuation">#</span><span class="keyword">invokeBeanFactoryPostProcessors</span></span><br><span class="line">        public PostProcessorRegistrationDelegate<span class="punctuation">#</span><span class="keyword">invokeBeanFactoryPostProcessors</span></span><br><span class="line">            private PostProcessorRegistrationDelegate<span class="punctuation">#</span><span class="keyword">invokeBeanDefinitionRegistryPostProcessors</span></span><br><span class="line">                ConfigurationClassPostProcessor<span class="punctuation">#</span><span class="keyword">postProcessBeanDefinitionRegistry</span></span><br><span class="line">                    ConfigurationClassPostProcessor<span class="punctuation">#</span><span class="keyword">processConfigBeanDefinitions</span></span><br><span class="line">                        ConfigurationClassParser<span class="punctuation">#</span><span class="keyword">parse</span></span><br><span class="line">                            for å¾ªç¯ start[è§£æå•ä¸ªç±»]</span><br><span class="line">                                ConfigurationClassParser<span class="punctuation">#</span><span class="keyword">parse</span><span class="params">(<span class="variable">AnnotationMetadata</span>, <span class="variable">java</span>.<span class="variable">lang</span>.<span class="variable">String</span>)</span></span><br><span class="line">                                    ConfigurationClassParser<span class="punctuation">#</span><span class="keyword">processImports</span>    (1)</span><br><span class="line">                            for å¾ªç¯ç»“æŸ</span><br><span class="line">                            DeferredImportSelectorHandler<span class="punctuation">#</span><span class="keyword">process</span>              (2)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  ConfigurationClassParser ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">(Set&lt;BeanDefinitionHolder&gt; configCandidates)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (BeanDefinitionHolder holder : configCandidates) &#123;</span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">bd</span> <span class="operator">=</span> holder.getBeanDefinition();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (bd <span class="keyword">instanceof</span> AnnotatedBeanDefinition annotatedBeanDef) &#123;</span><br><span class="line">                <span class="comment">// è¿™é‡Œä¼šå¯¹ DeferredImportSelector è¿›è¡Œç¼“å­˜ï¼Œç¼“å­˜åœ¨ DeferredImportSelectorHandler ç±»ä¸­</span></span><br><span class="line">                parse(annotatedBeanDef.getMetadata(), holder.getBeanName());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (bd <span class="keyword">instanceof</span> AbstractBeanDefinition abstractBeanDef &amp;&amp; abstractBeanDef.hasBeanClass()) &#123;</span><br><span class="line">                parse(abstractBeanDef.getBeanClass(), holder.getBeanName());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                parse(bd.getBeanClassName(), holder.getBeanName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(</span><br><span class="line">                    <span class="string">&quot;Failed to parse configuration class [&quot;</span> + bd.getBeanClassName() + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯å¯¹ DeferredImportSelector çš„å®é™…å¤„ç†</span></span><br><span class="line">    <span class="built_in">this</span>.deferredImportSelectorHandler.process();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>å…ˆç®€å•æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ol>
<li>ä¸Šè¿°æµç¨‹ä¸­ <code>(1)</code> ä½ç½®å°±æ˜¯å¤„ç† <code>ImportSelector</code> çš„åœ°æ–¹ï¼Œ åŒæ—¶ä¹Ÿæ˜¯ç¼“å­˜ <code>DeferredImportSelector</code> å®ç°ç±»çš„åœ°æ–¹</li>
<li>ä¸Šè¿°æµç¨‹ä¸­ <code>(2)</code> ä½ç½®å°±æ˜¯å®é™…å¤„ç† <code>DeferredImportSelector</code> çš„åœ°æ–¹ï¼Œ å¯ä»¥çœ‹åˆ° <code>(2)</code> ä½ç½®æ˜¯åœ¨å¾ªç¯å¤–é¢ï¼Œä¹Ÿå°±æ˜¯ç­‰æ‰€æœ‰çš„ <code>BeanDefinition</code> éƒ½è§£æå®Œæˆä¹‹åå†å¤„ç†çš„ï¼Œæ‰€ä»¥æ‰è¯´ <code>DeferredImportSelector</code> å®ç°æ¥å£æœ‰å»¶è¿Ÿå¯¼å…¥çš„åŠŸèƒ½</li>
</ol>
<p>æ¥ä¸‹æ¥å°±ç›´æ¥çœ‹ <code>processImports</code> æ–¹æ³•ã€ä¸‹é¢æ‰€æœ‰åˆ—å‡ºä»£ç éƒ½çœç•¥äº†å’Œæœ¬æ¬¡åˆ†ææ— å…³çš„ä»£ç ã€‘</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processImports</span><span class="params">(ConfigurationClass configClass, SourceClass currentSourceClass,</span></span><br><span class="line"><span class="params">			Collection&lt;SourceClass&gt; importCandidates, Predicate&lt;String&gt; exclusionFilter,</span></span><br><span class="line"><span class="params">			<span class="type">boolean</span> checkForCircularImports)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (SourceClass candidate : importCandidates) &#123;</span><br><span class="line">        <span class="keyword">if</span> (candidate.isAssignable(ImportSelector.class)) &#123;</span><br><span class="line">            <span class="comment">// Candidate class is an ImportSelector -&gt; delegate to it to determine imports</span></span><br><span class="line">            Class&lt;?&gt; candidateClass = candidate.loadClass();</span><br><span class="line">            <span class="type">ImportSelector</span> <span class="variable">selector</span> <span class="operator">=</span> ParserStrategyUtils.instantiateClass(candidateClass, ImportSelector.class,</span><br><span class="line">                    <span class="built_in">this</span>.environment, <span class="built_in">this</span>.resourceLoader, <span class="built_in">this</span>.registry);</span><br><span class="line">            <span class="comment">// è¿™é‡Œå°±æ˜¯å¤„ç† DeferredImportSelector çš„é€»è¾‘</span></span><br><span class="line">            <span class="keyword">if</span> (selector <span class="keyword">instanceof</span> DeferredImportSelector deferredImportSelector) &#123;</span><br><span class="line">                <span class="comment">// è¿™é‡Œå¹¶æ²¡æœ‰çœŸæ­£çš„å¤„ç†ï¼Œåªæ˜¯å°†å…¶å­˜åœ¨ DeferredImportSelectorHandler å¯¹è±¡ä¸­</span></span><br><span class="line">                <span class="built_in">this</span>.deferredImportSelectorHandler.handle(configClass, deferredImportSelector);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢ä»£ç å°±æ˜¯ç¼“å­˜ <code>DeferredImportSelector</code> å®ç°ç±»çš„å¤„ç†é€»è¾‘ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¤„ç† <code>DeferredImportSelector</code> å®ç°ç±»çš„é€»è¾‘äº†ï¼Œä»å‰é¢ä»£ç å·²ç»çŸ¥é“äº†ï¼Œæ˜¯ä¼šåœ¨ <code>DeferredImportSelectorHandler</code> ä¸­è¿›è¡Œå¤„ç†, å¤„ç†è¿‡ç¨‹ä¸­ä¼šæ¶‰åŠåˆ° <code>Group</code> ç›¸å…³çš„ç±»ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆçœ‹ä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DeferredImportSelectorGrouping</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œå°±ä¿å­˜äº† Group å®ç°ç±»</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> DeferredImportSelector.Group group;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;DeferredImportSelectorHolder&gt; deferredImports = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">DeferredImportSelectorGroupingHandler</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, DeferredImportSelectorGrouping&gt; groupings = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥çœ‹  <code>this.deferredImportSelectorHandler.process();</code> è¿™ä¸ªå¤„ç†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DeferredImportSelectorHandler ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;DeferredImportSelectorHolder&gt; deferredImports = <span class="built_in">this</span>.deferredImportSelectors;</span><br><span class="line">    <span class="built_in">this</span>.deferredImportSelectors = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (deferredImports != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">DeferredImportSelectorGroupingHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeferredImportSelectorGroupingHandler</span>();</span><br><span class="line">            deferredImports.sort(DEFERRED_IMPORT_COMPARATOR);</span><br><span class="line">            <span class="comment">// è¿™é‡Œæ¶‰åŠåˆ° Group çš„æ³¨å†Œ   (1)</span></span><br><span class="line">            deferredImports.forEach(handler::register);</span><br><span class="line">            <span class="comment">// çœŸæ­£çš„å¤„ç† å¯¼å…¥é€»è¾‘       (2)</span></span><br><span class="line">            handler.processGroupImports();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.deferredImportSelectors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆçœ‹ä¸€ä¸‹ <code>Group</code> æ³¨å†Œçš„ç›¸å…³é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯ <code>(1)</code> ä¸­çš„ç›¸å…³é€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">DeferredImportSelectorGroupingHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, DeferredImportSelectorGrouping&gt; groupings = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;AnnotationMetadata, ConfigurationClass&gt; configurationClasses = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(DeferredImportSelectorHolder deferredImport)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *  deferredImport.getImportSelector() è·å–çš„å°±æ˜¯ DeferredImportSelector å®ç°ç±»ï¼Œå†è°ƒç”¨ getImportGroup() å°±æ˜¯æƒ³è¦è·å–æˆ‘ä»¬è‡ªå·±å®ç°äº† Group çš„ç±»</span></span><br><span class="line"><span class="comment">         * è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå‰é¢è¯´å¦‚æœå•çº¯å®ç°äº† Group ç±»æ˜¯æ²¡æœ‰ç”¨çš„ï¼Œè¿˜éœ€è¦ä½¿ç”¨ getImportGroup() æ–¹æ³•è¿”å›æ‰è¡Œï¼Œå°±æ˜¯å› ä¸ºè¿™é‡Œä¼šè°ƒç”¨ getImportGroup() æ–¹æ³•è·å–æˆ‘ä»¬è‡ªå·±å®ç°äº† Group çš„ç±»</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">Group</span>&gt; group = deferredImport.getImportSelector().getImportGroup();</span><br><span class="line">        <span class="type">DeferredImportSelectorGrouping</span> <span class="variable">grouping</span> <span class="operator">=</span> <span class="built_in">this</span>.groupings.computeIfAbsent(</span><br><span class="line">                (group != <span class="literal">null</span> ? group : deferredImport),</span><br><span class="line">                <span class="comment">// è¿™é‡Œæ˜¯åˆ›å»º Group, å¦‚æœæ²¡æœ‰åˆ›å»ºåˆ›å»ºå°±æ˜¯ä½¿ç”¨é»˜è®¤çš„ï¼Œå…·ä½“çœ‹ä¸‹é¢ createGroup æ–¹æ³•</span></span><br><span class="line">                key -&gt; <span class="keyword">new</span> <span class="title class_">DeferredImportSelectorGrouping</span>(createGroup(group)));</span><br><span class="line">        grouping.add(deferredImport);</span><br><span class="line">        <span class="built_in">this</span>.configurationClasses.put(deferredImport.getConfigurationClass().getMetadata(),</span><br><span class="line">                deferredImport.getConfigurationClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Group <span class="title function_">createGroup</span><span class="params">(<span class="meta">@Nullable</span> Class&lt;? extends Group&gt; type)</span> &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡Œæ˜¯åˆ›å»º Group, å¦‚æœæˆ‘ä»¬è‡ªå·±æ²¡æœ‰åˆ›å»ºï¼Œé‚£ä¹ˆ type å°±ä¼šæ˜¯ nullï¼Œ ä¹Ÿå°±ä¼šä½¿ç”¨é»˜è®¤çš„ DefaultDeferredImportSelectorGroup ç±»</span></span><br><span class="line">			Class&lt;? <span class="keyword">extends</span> <span class="title class_">Group</span>&gt; effectiveType = (type != <span class="literal">null</span> ? type : DefaultDeferredImportSelectorGroup.class);</span><br><span class="line">        <span class="keyword">return</span> ParserStrategyUtils.instantiateClass(effectiveType, Group.class,</span><br><span class="line">                ConfigurationClassParser.<span class="built_in">this</span>.environment,</span><br><span class="line">                ConfigurationClassParser.<span class="built_in">this</span>.resourceLoader,</span><br><span class="line">                ConfigurationClassParser.<span class="built_in">this</span>.registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°±æ˜¯çœ‹ <code>processGroupImports()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  DeferredImportSelectorGroupingHandler ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processGroupImports</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (DeferredImportSelectorGrouping grouping : <span class="built_in">this</span>.groupings.values()) &#123;</span><br><span class="line">        Predicate&lt;String&gt; exclusionFilter = grouping.getCandidateFilter();</span><br><span class="line">        <span class="comment">// grouping.getImports() ä¸­å°±ä¼šå®é™…è°ƒç”¨ Group ç±»çš„ process() æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// å¦‚æœä½¿ç”¨çš„æ˜¯é»˜è®¤çš„ Group å®ç°ç±»ï¼Œå®é™…å°±ä¼šè°ƒç”¨ ImportSelector ä¸­çš„ selectImports æ–¹æ³•ï¼Œ </span></span><br><span class="line">        <span class="comment">//getImports() æ–¹æ³•çš„è¿”å›å€¼å°±æ˜¯æˆ‘ä»¬è‡ªå·±å®ç°äº† Group ç±»çš„ selectImports æ–¹æ³•çš„è¿”å›å€¼</span></span><br><span class="line">        grouping.getImports().forEach(entry -&gt; &#123;</span><br><span class="line">            <span class="type">ConfigurationClass</span> <span class="variable">configurationClass</span> <span class="operator">=</span> <span class="built_in">this</span>.configurationClasses.get(entry.getMetadata());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ‹¿åˆ° æ‰«æåˆ°çš„ç±»çš„å…¨é™å®šç±»åï¼Œç„¶åå°±æŒ‰ç…§ Import æ™®é€šç±»æ¥å¤„ç†ï¼Œä¹Ÿå°±æ˜¯å½“ä½œ @Configuration æ³¨è§£çš„ç±»æ¥å¤„ç†</span></span><br><span class="line">                processImports(configurationClass, asSourceClass(configurationClass, exclusionFilter),</span><br><span class="line">                        Collections.singleton(asSourceClass(entry.getImportClassName(), exclusionFilter)),</span><br><span class="line">                        exclusionFilter, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(</span><br><span class="line">                        <span class="string">&quot;Failed to process import candidates for configuration class [&quot;</span> +</span><br><span class="line">                                configurationClass.getMetadata().getClassName() + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Iterable&lt;Group.Entry&gt; getImports() &#123;</span><br><span class="line">    <span class="keyword">for</span> (DeferredImportSelectorHolder deferredImport : <span class="built_in">this</span>.deferredImports) &#123;</span><br><span class="line">        <span class="comment">// åœ¨è¿™é‡Œå¼€å§‹è°ƒç”¨ Group çš„ process() æ–¹æ³•</span></span><br><span class="line">        <span class="built_in">this</span>.group.process(deferredImport.getConfigurationClass().getMetadata(),</span><br><span class="line">                deferredImport.getImportSelector());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.group.selectImports();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤å°±è§£æå®Œäº† <code>Spring</code> ä¸­ <code>DeferredImportSelectory</code> çš„æ•´ä½“è°ƒç”¨æµç¨‹</p>
]]></content>
      <categories>
        <category>java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>å¦‚ä½•è®©è‡ªå®šä¹‰çš„æŸä¸ªbeanåœ¨æ‰€æœ‰beanä¹‹å‰åŠ è½½</title>
    <url>/2023/5cb19cbceeb7/index.html</url>
    <content><![CDATA[<p>å¯ä»¥é€šè¿‡ <code>@DependsOn</code> æ³¨è§£æ¥æ§åˆ¶æŸä¸ª <code>bean</code> çš„åŠ è½½é¡ºåºï¼Œä½†æ˜¯å¦‚æœæœ‰æ§åˆ¶é¡¹ç›®ä¸­è®©æŸä¸ª <code>Bean</code> å…ˆäºå…¶ä»–çš„ <code>Bean</code> åŠ è½½ï¼Œè¿™ç§æ–¹å¼å°±ä¸å¯è¡Œï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦ä» <code>Spring</code> ä¸­åŠ è½½ <code>Bean</code> çš„æœºåˆ¶å…¥æ‰‹</p>
<ol>
<li>é€šè¿‡ <code>BeanFacotry.getBean()</code> æ–¹æ³•ä¸»åŠ¨å»åŠ è½½ <code>Bean</code></li>
<li>æ‰€æœ‰éæ‡’åŠ è½½çš„ <code>Bean</code> ä¼šåœ¨ <code>AbstractApplicationContext#finishBeanFactoryInitialization()</code> æ–¹æ³•ä¸­è¿›è¡ŒåŠ è½½</li>
</ol>
<p>å¦‚æœæ˜¯é€šè¿‡ç¬¬äºŒç§æ–¹å¼(è‡ªåŠ¨åŠ è½½)ï¼Œé‚£ä¹ˆ <code>Bean</code> åŠ è½½æ—¶æœºå°±ä¸æ˜¯å¯æ§çš„ï¼Œæ‰€ä»¥åªèƒ½ä½¿ç”¨ç¬¬ä¸€ç§æ–¹å¼ï¼Œè¿›è¡Œä¸»åŠ¨åŠ è½½</p>
<p>ä½¿ç”¨ä¸»åŠ¨åŠ è½½çš„æ–¹æ³•éœ€è¦è·å–åˆ° <code>BeanFactory</code>ï¼Œè€Œ <code>BeanFactoryPostProcessor</code> æ–¹æ³•å°±å¯ä»¥æä¾› <code>beanFactory</code>ï¼Œ è€Œä¸” <code>BeanFactoryPostProcessor</code> çš„æ‰§è¡Œæ—¶æœºæ˜¯æ‰€æœ‰ <code>Bean</code> åŠ è½½ä¹‹å‰</p>
<p><strong>ç¤ºä¾‹ä»£ç </strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CusBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="comment">// ä¸»åŠ¨è·å– FirstDemo</span></span><br><span class="line">        beanFactory.getBean(FirstDemo.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;FirstDemo Hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Springä¸­Importæ³¨è§£æºç è§£æ</title>
    <url>/2023/73d35f59945c/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p><code>@Import</code> æ³¨è§£å¯ä»¥å¯¼å…¥ä¸‰ç§ç±»å‹çš„ç±»</p>
<ol>
<li>å¯¼å…¥æ™®é€šç±»ï¼Œæ­¤æ—¶ç›´æ¥å°†æ™®é€šç±»äº¤ç»™ <code>Spring</code> ç®¡ç†</li>
<li>å¯¼å…¥ <code>ImportSelector</code> å®ç°ç±»ä¸­ <code>String[] selectImports(AnnotationMetadata importingClassMetadata);</code> æ–¹æ³•è¿”å›çš„ç±»</li>
<li>å¯¼å…¥ <code>ImportBeanDefinitionRegistrar</code> å®ç°ç±»ä¸­ <code>registerBeanDefinitions</code> æ–¹æ³•æ³¨å…¥çš„ç±»</li>
</ol>
<h2 id="ä»£ç ç¤ºä¾‹"><a href="#ä»£ç ç¤ºä¾‹" class="headerlink" title="ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h2><p>ä»¥ä¸‹ä»£ç æ¯ç§æ–¹å¼ä½¿ç”¨çš„ç±»éƒ½åœ¨åŒä¸€ä¸ªåŒ…ä¸‹( <code>@Configuration</code> é»˜è®¤ä¼šæ‰«æå½“å‰åŒ…å’Œå­åŒ… )ã€‚</p>
<div class="tabs" id="importçš„ä¸‰ç§ä½¿ç”¨æ–¹å¼"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="importçš„ä¸‰ç§ä½¿ç”¨æ–¹å¼-1">å¼•å…¥æ™®é€šç±»</button><button type="button" class="tab " data-href="importçš„ä¸‰ç§ä½¿ç”¨æ–¹å¼-2">ç»“åˆ ImportSelector</button><button type="button" class="tab " data-href="importçš„ä¸‰ç§ä½¿ç”¨æ–¹å¼-3">ç»“åˆ ImportBeanDefinitionRegistrar</button></ul><div class="tab-contents"><div class="tab-item-content active" id="importçš„ä¸‰ç§ä½¿ç”¨æ–¹å¼-1"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ™®é€šç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  é…ç½®ç±»</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(Student.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImportConfig</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  ä¸»ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImportMain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(ImportConfig.class);</span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> context.getBean(Student.class);</span><br><span class="line">        student.sayHello();  <span class="comment">// ä¼šæ‰“å° &quot;test hello&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="importçš„ä¸‰ç§ä½¿ç”¨æ–¹å¼-2"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ™®é€šç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  é…ç½®ç±»</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(CusImportSelector.class)</span>  <span class="comment">// è¿™é‡Œå¯¼å…¥çš„æ˜¯å®ç°äº† ImportSelector æ¥å£çš„ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImportConfig</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰å®ç° ImportSelector æ¥å£çš„ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CusImportSelector</span> <span class="keyword">implements</span> <span class="title class_">ImportSelector</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        <span class="comment">// è¿”å›çš„æ•°ç»„å°±æ˜¯éœ€è¦å¯¼å…¥çš„ç±»å…¨é™å®šå</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;org.example.imports.Student&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  ä¸»ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImportMain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(ImportConfig.class);</span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> context.getBean(Student.class);</span><br><span class="line">        student.sayHello();  <span class="comment">// ä¼šæ‰“å° &quot;test hello&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="importçš„ä¸‰ç§ä½¿ç”¨æ–¹å¼-3"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ™®é€šç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  é…ç½®ç±»</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(CusImportBeanDefinitionRegistrar.class)</span>  <span class="comment">// è¿™é‡Œå¯¼å…¥çš„æ˜¯å®ç°äº† ImportSelector æ¥å£çš„ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImportConfig</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰å®ç° ImportBeanDefinitionRegistrar æ¥å£çš„ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CusImportBeanDefinitionRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry, BeanNameGenerator importBeanNameGenerator)</span> &#123;</span><br><span class="line">        <span class="type">BeanDefinitionBuilder</span> <span class="variable">beanDefinitionBuilder</span> <span class="operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(Student.class);</span><br><span class="line">        <span class="type">AbstractBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> beanDefinitionBuilder.getBeanDefinition();</span><br><span class="line">        <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> importBeanNameGenerator.generateBeanName(beanDefinition, registry);</span><br><span class="line">        registry.registerBeanDefinition(beanName, beanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  ä¸»ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImportMain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(ImportConfig.class);</span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> context.getBean(Student.class);</span><br><span class="line">        student.sayHello();  <span class="comment">// ä¼šæ‰“å° &quot;test hello&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h2 id="æºç æµç¨‹è§£æ"><a href="#æºç æµç¨‹è§£æ" class="headerlink" title="æºç æµç¨‹è§£æ"></a>æºç æµç¨‹è§£æ</h2><p><code>@Import</code> çš„è§£æå®é™…æ˜¯é€šè¿‡ <code>BeanFactoryPostProcessor</code> å®ç°çš„ï¼Œ åœ¨ <ol><li><a href="/2023/e7d5d1305e5d/index.html" title="BeanFacotryçš„åç½®å¤„ç†å™¨è¯¦è§£">BeanFacotryçš„åç½®å¤„ç†å™¨è¯¦è§£</a></li></ol> æåˆ° <code>@ComponentScan</code> æ˜¯é€šè¿‡ <code>ConfigurationClassPostProcessor</code> å¤„ç†çš„ï¼Œå¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight leaf"><table><tr><td class="code"><pre><span class="line">AbstractApplicationContext<span class="punctuation">#</span><span class="keyword">refresh</span></span><br><span class="line">    AbstractApplicationContext<span class="punctuation">#</span><span class="keyword">invokeBeanFactoryPostProcessors</span></span><br><span class="line">        PostProcessorRegistrationDelegate<span class="punctuation">#</span><span class="keyword">invokeBeanDefinitionRegistryPostProcessors</span></span><br><span class="line">            ConfigurationClassPostProcessor<span class="punctuation">#</span><span class="keyword">postProcessBeanDefinitionRegistry</span></span><br><span class="line">                ConfigurationClassParser<span class="punctuation">#</span><span class="keyword">parse</span><span class="params">(<span class="variable">Set</span><span class="operator">&lt;</span><span class="variable">BeanDefinitionHolder</span><span class="operator">&gt;</span>)</span></span><br><span class="line">                    ConfigurationClassParser<span class="punctuation">#</span><span class="keyword">doProcessConfigurationClass</span></span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆæ˜¯ä¼šè°ƒç”¨åˆ° <code>ConfigurationClassParser#doProcessConfigurationClass</code> æ–¹æ³•ï¼Œæ¥ä¸‹æ¥å°±çœ‹çœ‹è¿™ä¸ªæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> SourceClass <span class="title function_">doProcessConfigurationClass</span><span class="params">(</span></span><br><span class="line"><span class="params">			ConfigurationClass configClass, SourceClass sourceClass, Predicate&lt;String&gt; filter)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çœç•¥</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process any @PropertySource annotations</span></span><br><span class="line">    <span class="keyword">for</span> (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">            sourceClass.getMetadata(), PropertySources.class,</span><br><span class="line">            org.springframework.context.annotation.PropertySource.class)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.propertySourceRegistry != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.propertySourceRegistry.processPropertySource(propertySource);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;Ignoring @PropertySource annotation on [&quot;</span> + sourceClass.getMetadata().getClassName() +</span><br><span class="line">                    <span class="string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  è¿™é‡Œæ˜¯å¤„ç† @ComponentScan  Process any @ComponentScan annotations</span></span><br><span class="line">    Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">            sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);</span><br><span class="line">    <span class="keyword">if</span> (!componentScans.isEmpty() &amp;&amp;</span><br><span class="line">            !<span class="built_in">this</span>.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">        <span class="comment">// çœç•¥</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç† @Import Process any @Import annotations</span></span><br><span class="line">    processImports(configClass, sourceClass, getImports(sourceClass), filter, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çœç•¥  å¤„ç† @ImportResource ç­‰  Process any @ImportResource annotations</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>processImports</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationClassParser ç±»ï¼Œ è¯¥æ–¹æ³•åªåˆ—å‡ºäº†é‡è¦æ–¹æ³•</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processImports</span><span class="params">(ConfigurationClass configClass, SourceClass currentSourceClass,</span></span><br><span class="line"><span class="params">			Collection&lt;SourceClass&gt; importCandidates, Predicate&lt;String&gt; exclusionFilter,</span></span><br><span class="line"><span class="params">			<span class="type">boolean</span> checkForCircularImports)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (SourceClass candidate : importCandidates) &#123;</span><br><span class="line">        <span class="comment">// å¯¼å…¥çš„æ˜¯ ImportSelector ç±»å‹çš„å¤„ç†æµç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (candidate.isAssignable(ImportSelector.class)) &#123;</span><br><span class="line">            <span class="comment">// Candidate class is an ImportSelector -&gt; delegate to it to determine imports</span></span><br><span class="line">            Class&lt;?&gt; candidateClass = candidate.loadClass();</span><br><span class="line">            <span class="type">ImportSelector</span> <span class="variable">selector</span> <span class="operator">=</span> ParserStrategyUtils.instantiateClass(candidateClass, ImportSelector.class,</span><br><span class="line">                    <span class="built_in">this</span>.environment, <span class="built_in">this</span>.resourceLoader, <span class="built_in">this</span>.registry);</span><br><span class="line">            Predicate&lt;String&gt; selectorFilter = selector.getExclusionFilter();</span><br><span class="line">            <span class="keyword">if</span> (selectorFilter != <span class="literal">null</span>) &#123;</span><br><span class="line">                exclusionFilter = exclusionFilter.or(selectorFilter);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (selector <span class="keyword">instanceof</span> DeferredImportSelector deferredImportSelector) &#123;</span><br><span class="line">                <span class="built_in">this</span>.deferredImportSelectorHandler.handle(configClass, deferredImportSelector);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                String[] importClassNames = selector.selectImports(currentSourceClass.getMetadata());</span><br><span class="line">                Collection&lt;SourceClass&gt; importSourceClasses = asSourceClasses(importClassNames, exclusionFilter);</span><br><span class="line">                processImports(configClass, currentSourceClass, importSourceClasses, exclusionFilter, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¯¼å…¥çš„æ˜¯ ImportBeanDefinitionRegistrar ç±»å‹çš„å¤„ç†æµç¨‹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (candidate.isAssignable(ImportBeanDefinitionRegistrar.class)) &#123;</span><br><span class="line">            <span class="comment">// Candidate class is an ImportBeanDefinitionRegistrar -&gt;</span></span><br><span class="line">            <span class="comment">// delegate to it to register additional bean definitions</span></span><br><span class="line">            Class&lt;?&gt; candidateClass = candidate.loadClass();</span><br><span class="line">            <span class="type">ImportBeanDefinitionRegistrar</span> <span class="variable">registrar</span> <span class="operator">=</span></span><br><span class="line">                    ParserStrategyUtils.instantiateClass(candidateClass, ImportBeanDefinitionRegistrar.class,</span><br><span class="line">                            <span class="built_in">this</span>.environment, <span class="built_in">this</span>.resourceLoader, <span class="built_in">this</span>.registry);</span><br><span class="line">            configClass.addImportBeanDefinitionRegistrar(registrar, currentSourceClass.getMetadata());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ—¢ä¸æ˜¯ ImportSelector ä¹Ÿä¸æ˜¯ ImportBeanDefinitionRegistrar ç±»å‹çš„å¤„ç†æµç¨‹ï¼Œå½“ä½œ æ™®é€šçš„ @Configuration ç±»å¤„ç†</span></span><br><span class="line">            <span class="built_in">this</span>.importStack.registerImport(</span><br><span class="line">                    currentSourceClass.getMetadata(), candidate.getMetadata().getClassName());</span><br><span class="line">            processConfigurationClass(candidate.asConfigClass(configClass), exclusionFilter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å¯¼å…¥çš„æ˜¯æ™®é€šç±»æ˜¯çš„å¤„ç†æµç¨‹</strong></p>
<p>ä»ä¸Šé¢æºç å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœå¯¼å…¥çš„æ˜¯æ™®é€šçš„ç±»ï¼ˆä¸æ˜¯ <code>ImportSelector</code> ä¹Ÿä¸æ˜¯ <code>ImportBeanDefinitionRegistrar</code> ç±»å‹ï¼‰åˆ™å°†è¿™ä¸ªæ™®é€šç±»æŒ‰ç…§å«æœ‰ <code>@Configuration</code> æ³¨è§£çš„ç±»ä¸€æ ·è¿›è¡Œå¤„ç†, å¦‚æœæ˜¯æŒ‰ç…§ <code>@Configuration</code> æ³¨è§£çš„ç±»è¿›è¡Œå¤„ç†ï¼Œä¼šå°†æ™®é€šç±»å˜æˆ <code>ConfigurationClass</code> ç±»å‹</p>
<p><strong>å¯¼å…¥çš„æ˜¯ <code>ImportSelector</code> ç±»å‹</strong></p>
<p>å¯¹äºå¯¼å…¥çš„æ˜¯ <code>ImportSelector</code> ç±»å‹å¤„ç†ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (candidate.isAssignable(ImportSelector.class)) &#123;</span><br><span class="line">    <span class="comment">// Candidate class is an ImportSelector -&gt; delegate to it to determine imports</span></span><br><span class="line">    Class&lt;?&gt; candidateClass = candidate.loadClass();</span><br><span class="line">    <span class="type">ImportSelector</span> <span class="variable">selector</span> <span class="operator">=</span> ParserStrategyUtils.instantiateClass(candidateClass, ImportSelector.class,</span><br><span class="line">            <span class="built_in">this</span>.environment, <span class="built_in">this</span>.resourceLoader, <span class="built_in">this</span>.registry);</span><br><span class="line">    Predicate&lt;String&gt; selectorFilter = selector.getExclusionFilter();</span><br><span class="line">    <span class="keyword">if</span> (selectorFilter != <span class="literal">null</span>) &#123;</span><br><span class="line">        exclusionFilter = exclusionFilter.or(selectorFilter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (selector <span class="keyword">instanceof</span> DeferredImportSelector deferredImportSelector) &#123;</span><br><span class="line">        <span class="built_in">this</span>.deferredImportSelectorHandler.handle(configClass, deferredImportSelector);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        String[] importClassNames = selector.selectImports(currentSourceClass.getMetadata());</span><br><span class="line">        Collection&lt;SourceClass&gt; importSourceClasses = asSourceClasses(importClassNames, exclusionFilter);</span><br><span class="line">        processImports(configClass, currentSourceClass, importSourceClasses, exclusionFilter, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>å…ˆè°ƒç”¨ <code>selectImports</code> æ–¹æ³•è·å–å¯¼å…¥çš„ç±»åæ•°ç»„</li>
<li>è°ƒç”¨ <code>asSourceClasses</code> æ–¹æ³•å°†ç±»åæ•°ç»„è½¬æ¢ä¸º <code>SourceClass</code> é›†åˆ</li>
<li>è°ƒç”¨ <code>processImports</code> æ–¹æ³•å¤„ç† <code>SourceClass</code> æ•°ç»„ï¼Œ è¿™é‡Œå°±æ˜¯é€’å½’è°ƒç”¨äº†ï¼Œé€’å½’çš„ç¬¬ä¸€å±‚æ˜¯ <code>ImportSelector</code> ç±»å‹çš„ç±»ï¼Œé€’å½’çš„ç¬¬äºŒå±‚å°±æ˜¯ <code>selectImports</code> æ–¹æ³•ä¸­è¿”å›çš„æ™®é€šçš„ç±»äº†ï¼Œè¿™ä¸ªå°±å’Œ <code>Import</code> å¯¼å…¥çš„æ˜¯æ™®é€šç±»ä¸€æ ·çš„å¤„ç†æµç¨‹ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆæ˜¯æŒ‰ç…§ <code>@Configuration</code> æ³¨è§£çš„ç±»å¤„ç†</li>
</ol>
<p><strong>å¯¼å…¥çš„æ˜¯ <code>ImportBeanDefinitionRegistrar</code> ç±»å‹</strong></p>
<p>å¯¹äºå¯¼å…¥çš„æ˜¯ <code>ImportBeanDefinitionRegistrar</code> ç±»å‹å¤„ç†ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (candidate.isAssignable(ImportBeanDefinitionRegistrar.class)) &#123;</span><br><span class="line">    <span class="comment">// Candidate class is an ImportBeanDefinitionRegistrar -&gt;</span></span><br><span class="line">    <span class="comment">// delegate to it to register additional bean definitions</span></span><br><span class="line">    Class&lt;?&gt; candidateClass = candidate.loadClass();</span><br><span class="line">    <span class="type">ImportBeanDefinitionRegistrar</span> <span class="variable">registrar</span> <span class="operator">=</span></span><br><span class="line">            ParserStrategyUtils.instantiateClass(candidateClass, ImportBeanDefinitionRegistrar.class,</span><br><span class="line">                    <span class="built_in">this</span>.environment, <span class="built_in">this</span>.resourceLoader, <span class="built_in">this</span>.registry);</span><br><span class="line">    <span class="comment">// configClass å°±æ˜¯ ConfigurationClass</span></span><br><span class="line">    configClass.addImportBeanDefinitionRegistrar(registrar, currentSourceClass.getMetadata()); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *   ConfigurationClass ç±»</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *  private final Map&lt;ImportBeanDefinitionRegistrar, AnnotationMetadata&gt; importBeanDefinitionRegistrars = new LinkedHashMap&lt;&gt;();</span></span><br><span class="line"><span class="comment"> * /</span></span><br><span class="line"><span class="comment">void addImportBeanDefinitionRegistrar(ImportBeanDefinitionRegistrar registrar, AnnotationMetadata importingClassMetadata) &#123;</span></span><br><span class="line"><span class="comment">    this.importBeanDefinitionRegistrars.put(registrar, importingClassMetadata);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆæ˜¯å°† <code>ImportBeanDefinitionRegistrar</code> å®ç°ç±»æ”¾å…¥äº† <code>ConfigurationClass</code> ç±»ä¸­çš„ <code>importBeanDefinitionRegistrars</code> å±æ€§ä¸­ï¼Œé‚£ä¹ˆæœ€ç»ˆæ˜¯ä»€ä¹ˆæ—¶å€™æ³¨å†Œæˆ <code>BeanDefinition</code> çš„å‘¢ï¼Ÿ</p>
<p>è¿™ä¸ªå°±å¾—å›åˆ° <code>org.springframework.context.annotation.ConfigurationClassPostProcessor#processConfigBeanDefinitions</code> æ–¹æ³•ä¸­äº†ï¼Œ è¿™é‡Œé€šè¿‡æµç¨‹å›¾æ¢³ç†ä¸€ä¸‹è§£æå’Œæ³¨å†Œä¸¤ä¸ªæ­¥éª¤çš„æµç¨‹</p>
<pre class="mermaid">sequenceDiagram
    autonumber
    participant A as ConfigurationClassPostProcessor
    participant B as ConfigurationClassParser
    participant C as ConfigurationClassBeanDefinitionReader
    activate A
    A->>A: processConfigBeanDefinitions()
    A->>B: parse()
    B->>B: doProcessConfigurationClassï¼ˆï¼‰
    A->>C: loadBeanDefinitions()
    C->>C: loadBeanDefinitionsFromRegistrars()
    deactivate  A</pre>

<ol>
<li>æ•´ä½“é€»è¾‘æ˜¯åœ¨ <code>ConfigurationClassPostProcessor</code> çš„ <code>processConfigBeanDefinitions()</code> æ–¹æ³•ä¸­æ‰§è¡Œçš„</li>
<li>å¯¹äº <code>@ComponentScan</code>, <code>@Import</code> ç­‰è§£ææ˜¯åœ¨ <code>ConfiguraionClassParser</code> çš„ <code>doProcessConfigurationClass()</code> æ–¹æ³•ä¸­è§£æçš„</li>
<li>å¯¹äº <code>ImportBeanDefinitionRegistrar</code> ç±»å‹çš„ç±»åœ¨ç¬¬äºŒæ­¥è§£æå®Œæˆä¹‹åæ”¾å…¥äº† <code>ConfigurationClass</code> ç±»å‹ï¼ˆå°±æ˜¯å°† <code>ImportBeanDefinitionRegistrar</code> ç±»å‹çš„å®ç°ç±»è½¬æ¢æˆ <code>ConfigurationClass</code> ç±»å‹è€Œå·²ï¼‰ä¸­çš„ <code>importBeanDefinitionRegistrars</code> å±æ€§ä¸­</li>
<li>æœ€ååœ¨ <code>ConfigurationClassBeanDefinitionReader</code> ç±»çš„ <code>loadBeanDefinitionsFromRegistrars()</code> æ–¹æ³•ä¸­ä¼šè¿›è¡Œ <code>BeanDefinition</code> çš„æ³¨å†Œ</li>
</ol>
<p>è‡³æ­¤ï¼Œè§£æå’Œæ³¨å†Œä¸¤ä¸ªæ­¥éª¤çš„æµç¨‹å°±è§£æå®Œäº†</p>
]]></content>
      <categories>
        <category>java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot3è‡ªåŠ¨è£…é…åŸç†</title>
    <url>/2023/8e23a1d3d97d/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p>SpringBootç‰ˆæœ¬: 3.2.0</p>
<h2 id="ä»€ä¹ˆæ˜¯è‡ªåŠ¨è£…é…"><a href="#ä»€ä¹ˆæ˜¯è‡ªåŠ¨è£…é…" class="headerlink" title="ä»€ä¹ˆæ˜¯è‡ªåŠ¨è£…é…"></a>ä»€ä¹ˆæ˜¯è‡ªåŠ¨è£…é…</h2><p><strong>è£…é…çš„æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<p>è£…é…çš„å°±æ˜¯ <code>bean</code>, ä¹Ÿå°±æ˜¯å¯ä»¥å°†ä¸€ä¸ª å¯¹è±¡äº¤ç»™ <code>Spring</code> å®¹å™¨ç®¡ç†</p>
<p><strong>ä¸ºä»€ä¹ˆå¯ä»¥è‡ªåŠ¨ï¼Ÿ</strong></p>
<p><code>SpringBoot</code> ç§‰æŒçš„å°±æ˜¯ <strong>çº¦å®šä¼˜äºé…ç½®</strong>ï¼Œæ‰€ä»¥è¦æƒ³åšåˆ°å°±å¾—æœ‰ä¸€å®šçš„è§„åˆ™ï¼Œæ¯”å¦‚</p>
<ul>
<li>æ€»å¾—è¦å‘Šè¯‰ <code>Spring</code> æˆ‘ä»¬æƒ³è¦è£…é…çš„æ˜¯ä»€ä¹ˆç±»ï¼Œé€šè¿‡ä»€ä¹ˆæ–¹å¼å‘Šè¯‰å‘¢ï¼Ÿ å°±æ˜¯å°†æƒ³è¦æ³¨å…¥çš„ç±»é›†ä¸­å†™åœ¨ä¸€ä¸ªå›ºå®šä½ç½®çš„é…ç½®æ–‡ä»¶ä¸­<ul>
<li>åœ¨ 2.7.0 ä¹‹å‰ä½¿ç”¨çš„é…ç½®æ–‡ä»¶åç§°æ˜¯ <code>spring.factories</code>, è¿™ä¸ªæ–‡ä»¶çš„ä½ç½®æ˜¯  <code>META-INF/spring.factories</code></li>
<li>åœ¨ 2.7.0 ä¹‹åä½¿ç”¨çš„é…ç½®æ–‡ä»¶åç§°æ˜¯ <code>org.springframework.boot.autoconfigure.AutoConfiguration.imports</code>, è¿™ä¸ªæ–‡ä»¶çš„ä½ç½®æ˜¯  <code>META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</code></li>
</ul>
</li>
<li>å¯ä»¥è®¤ä¸ºé…ç½®æ–‡ä»¶æ˜¯å¼€å‘è€…éœ€è¦æä¾›çš„ï¼Œå½“ç„¶ <code>SpringBoot</code> å†…éƒ¨ä¹Ÿä½¿ç”¨äº†è¿™ç§æœºåˆ¶ï¼Œæ—¢ç„¶æä¾›äº†é…ç½®æ–‡ä»¶ï¼Œé‚£ä¹ˆ <code>Spring</code> æ¡†æ¶å°±éœ€è¦æŒ‰ç…§çº¦å®šçš„ä½ç½®å»æ‰¾è¿™äº›ç±»äº†ï¼Œè¿™ä¸ªåœ¨ <code>SpringBoot</code> ä¸­æ˜¯é€šè¿‡ <code>@Import</code> æ³¨è§£å¯¼å…¥äº†ä¸€ä¸ª <code>DeferredImportSelector</code> å®ç°ç±»æ¥å®ç°çš„ï¼Œè¿™ä¸ªå®ç°ç±»æ˜¯ <code>AutoConfigurationImportSelector</code></li>
<li>åœ¨ <code>SpringBoot</code> ä¸­è¿˜æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå°±æ˜¯é€šè¿‡ä¸€ç³»åˆ—çš„æ¡ä»¶åˆ¤æ–­æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å†™çš„è¿™äº›ç±»æ˜¯å¦çœŸçš„å¯ä»¥å¯¼å…¥ï¼Œè¿™ä¸€ç³»åˆ—æ¡ä»¶æ˜¯é€šè¿‡ <code>@ConditionalOnxxxx</code> æ³¨è§£æ¥å®ç°</li>
</ul>
<p>æ¥ä¸‹æ¥ç®€å•æ€»ç»“ä¸€ä¸‹ <code>SpringBoot3</code> çš„è‡ªåŠ¨è£…é…åŸç†</p>
<ol>
<li>é€šè¿‡ <code>@Import</code> å¯¼å…¥ <code>AutoConfigurationImportSelector</code> ç±»ï¼Œ å¯ä»¥å‚è€ƒ <ol><li><a href="/2023/73d35f59945c/index.html" title="Springä¸­Importæ³¨è§£æºç è§£æ">Springä¸­Importæ³¨è§£æºç è§£æ</a></li></ol></li>
<li><code>AutoConfigurationImportSelector</code> ä¼šå»æ‰¾æ‰€æœ‰ <code>classpath</code> ä¸‹æ‰€æœ‰ <code>jar</code> ä¸‹çš„ <code>META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</code> æ–‡ä»¶ï¼Œå°†æ–‡ä»¶é‡Œé¢çš„å…¨é™å®šç±»ååŠ è½½è¿›æ¥</li>
<li>å¯¹åŠ è½½åŠ æ¥çš„ç±»è¿›è¡Œä¸€ç³»åˆ—çš„æ¡ä»¶åˆ¤æ–­ï¼Œç¬¦åˆæ¡ä»¶çš„æ‰ä¼šçœŸçš„è¿›è¡ŒåŠ è½½åˆ° <code>Spring</code> å®¹å™¨ä¸­</li>
</ol>
<h2 id="è‡ªåŠ¨è£…é…çš„ç¤ºä¾‹"><a href="#è‡ªåŠ¨è£…é…çš„ç¤ºä¾‹" class="headerlink" title="è‡ªåŠ¨è£…é…çš„ç¤ºä¾‹"></a>è‡ªåŠ¨è£…é…çš„ç¤ºä¾‹</h2><ol><li><a href="/2023/ee343b448bf4/index.html" title="SpringBoot3è‡ªåŠ¨è£…é…æ¡ˆä¾‹">SpringBoot3è‡ªåŠ¨è£…é…æ¡ˆä¾‹</a></li></ol>

<h2 id="SpringBoot3-è‡ªåŠ¨è£…é…çš„æµç¨‹"><a href="#SpringBoot3-è‡ªåŠ¨è£…é…çš„æµç¨‹" class="headerlink" title="SpringBoot3 è‡ªåŠ¨è£…é…çš„æµç¨‹"></a>SpringBoot3 è‡ªåŠ¨è£…é…çš„æµç¨‹</h2><p><code>SpringBoot</code> é¡¹ç›®å¯åŠ¨ä¸»ç±»ä¸Šåªæœ‰ä¸€ä¸ª <code>SpringBootApplication</code> æ³¨è§£ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªæ³¨è§£çš„ä½“ç³»</p>
<pre class="mermaid">flowchart LR
    A["@SpringBootApplication"]
    style A fill:#8ff600
    B["@ComponentScan"]
    C["@EnableAutoConfiguration"]
    style C fill:#8ff600
    D["@SpringBootConfiguration"]

    A--> B & C & D

    E["@Configuration"]
    D-->E

    F["@AutoConfigurationPackage"]
    G["@Import(AutoConfigurationPackages.Registrar.class)"]
    C-->F
    F-->G

    H["@Import(AutoConfigurationImportSelector.class)"]
    style H fill:#8ff600
    C-->H</pre>

<p>æ¶‰åŠåˆ°è‡ªåŠ¨æ³¨å…¥çš„æ³¨è§£ä½¿ç”¨ç»¿è‰²æ ‡è®°å‡ºæ¥äº†ï¼Œæ‰€ä»¥æœ€ç»ˆéœ€è¦çœ‹çš„å°±æ˜¯ <code>AutoConfigurationImportSelector</code>ï¼Œ è€Œè¿™ä¸ªç±»æ˜¯ä¸€ä¸ª <code>DeferredImportSelector</code> æ¥å£çš„å®ç°ç±»ï¼Œå…·ä½“å‚è€ƒ <ol><li><a href="/2023/55186be8f39b/index.html" title="Springä¸­DeferredImportSelectoræºç è§£æ">Springä¸­DeferredImportSelectoræºç è§£æ</a></li></ol>ï¼Œ è¿™é‡Œå°±ç›´æ¥ç»™å‡º <code>DeferredImportSelector</code> æ¥å£çš„æ‰§è¡Œæµç¨‹</p>
<pre class="mermaid">flowchart TB
    A["Groupå®ç°ç±»ä¸­çš„ process() æ–¹æ³•"]
    B["DeferredImportSelectorå®ç°ç±» 
     ä¸­çš„ selectImports() æ–¹æ³• 
     ï¼ˆè¯¥æ–¹æ³•ä¸ä¸€å®šæ‰§è¡Œï¼Œå½“ Group å®ç°ç±»ä¸­
     æœ‰è°ƒç”¨çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œï¼Œæ²¡æœ‰è°ƒç”¨å°±æ²¡æœ‰æ‰§è¡Œ
     SpringBootè‡ªåŠ¨è£…é…æ—¶å°±æ²¡æœ‰æ‰§è¡Œ selectImports() æ–¹æ³•ï¼‰"]
    C["Groupå®ç°ç±»ä¸­çš„ selectImports() æ–¹æ³•
    è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼æ‰æ˜¯çœŸæ­£è¦è¢«
    å¯¼å…¥çš„ç±»"]
    A-->B-->C</pre>

<p>å…ˆçœ‹ä¸€ä¸‹ <code>AutoConfigurationImportSelector</code> è¿™ä¸ªç±»ä¸­ç›¸å…³çš„ä»£ç ï¼ˆåªå±•ç¤ºä¸»æµç¨‹éƒ¨åˆ†ï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span>, BeanClassLoaderAware,</span><br><span class="line">		ResourceLoaderAware, BeanFactoryAware, EnvironmentAware, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®è¿™ä¸ªæ–¹æ³•å¯ä»¥çŸ¥é“å½“å‰ DeferredImportSelector å®ç°ç±»å¯¹åº”çš„ Group ç±»æ˜¯ AutoConfigurationGroup</span></span><br><span class="line">    <span class="comment">// æ­¥éª¤1ï¼š æ ¹æ®è¿™ä¸ªæ–¹æ³•å¾—åˆ°å…·ä½“çš„ Group å®ç°ç±»</span></span><br><span class="line">	<span class="keyword">public</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">Group</span>&gt; getImportGroup() &#123;</span><br><span class="line">		<span class="keyword">return</span> AutoConfigurationGroup.class;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¥éª¤4ï¼š è¿™ä¸ªæ–¹æ³•æ˜¯ä» Group å®ç°ç±»ä¸­çš„ process() æ–¹æ³•è°ƒç”¨è¿‡æ¥çš„</span></span><br><span class="line">    <span class="keyword">protected</span> AutoConfigurationEntry <span class="title function_">getAutoConfigurationEntry</span><span class="params">(AnnotationMetadata annotationMetadata)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">			<span class="keyword">return</span> EMPTY_ENTRY;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">AnnotationAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> getAttributes(annotationMetadata);</span><br><span class="line">        <span class="comment">// æ­¥éª¤5ï¼š getCandidateConfigurations æ–¹æ³•ä¼šä»é…ç½®æ–‡ä»¶åŠ è½½ç±»</span></span><br><span class="line">		List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">		configurations = removeDuplicates(configurations);</span><br><span class="line">        <span class="comment">// è·å–æ‰‹åŠ¨æ’é™¤æ‰çš„ç±»ï¼Œæ¯”å¦‚æˆ‘ä»¬é…ç½®äº† exclude ç›¸å…³çš„é…ç½®</span></span><br><span class="line">		Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);</span><br><span class="line">		checkExcludedClasses(configurations, exclusions);</span><br><span class="line">		configurations.removeAll(exclusions);</span><br><span class="line">        <span class="comment">// æ­¥éª¤6ï¼š è¿™é‡Œå°±æ˜¯æ ¹æ®æ¡ä»¶åˆ¤æ–­ï¼Œè¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„ç±»</span></span><br><span class="line">		configurations = getConfigurationClassFilter().filter(configurations);</span><br><span class="line">		fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AutoConfigurationEntry</span>(configurations, exclusions);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AutoConfigurationGroup</span></span><br><span class="line">			<span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span>.Group, BeanClassLoaderAware, BeanFactoryAware, ResourceLoaderAware &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ­¥éª¤2ï¼š è°ƒç”¨ Group å®ç°ç±»ä¸­çš„ process() æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(AnnotationMetadata annotationMetadata, DeferredImportSelector deferredImportSelector)</span> &#123;</span><br><span class="line">            <span class="comment">// æ­¥éª¤3ï¼š è°ƒç”¨ AutoConfigurationImportSelector ç±»çš„ getAutoConfigurationEntry() æ–¹æ³•</span></span><br><span class="line">            <span class="comment">// æ‰€ä»¥è¿™é‡Œå¹¶æ²¡æœ‰è°ƒç”¨ AutoConfigurationImportSelector ç±»çš„ selectImports() æ–¹æ³•</span></span><br><span class="line">			<span class="type">AutoConfigurationEntry</span> <span class="variable">autoConfigurationEntry</span> <span class="operator">=</span> ((AutoConfigurationImportSelector) deferredImportSelector)</span><br><span class="line">				.getAutoConfigurationEntry(annotationMetadata);</span><br><span class="line">			<span class="built_in">this</span>.autoConfigurationEntries.add(autoConfigurationEntry);</span><br><span class="line">			<span class="keyword">for</span> (String importClassName : autoConfigurationEntry.getConfigurations()) &#123;</span><br><span class="line">				<span class="built_in">this</span>.entries.putIfAbsent(importClassName, annotationMetadata);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ­¥éª¤1</strong> å’Œ <strong>æ­¥éª¤2</strong> çš„è°ƒç”¨åœ¨è®²è§£ <code>DeferredImportSelector</code> æ¥å£çš„æ—¶å€™å·²ç»è®²è¿‡äº†ï¼Œè¿™é‡Œç®€å•è´´ä¸€ä¸‹è°ƒç”¨è¿‡ç¨‹</p>
<figure class="highlight leaf"><table><tr><td class="code"><pre><span class="line">AbstractApplicationContext<span class="punctuation">#</span><span class="keyword">refresh</span></span><br><span class="line">    AbstractApplicationContext<span class="punctuation">#</span><span class="keyword">invokeBeanFactoryPostProcessors</span></span><br><span class="line">        public PostProcessorRegistrationDelegate<span class="punctuation">#</span><span class="keyword">invokeBeanFactoryPostProcessors</span></span><br><span class="line">            private PostProcessorRegistrationDelegate<span class="punctuation">#</span><span class="keyword">invokeBeanDefinitionRegistryPostProcessors</span></span><br><span class="line">                ConfigurationClassPostProcessor<span class="punctuation">#</span><span class="keyword">postProcessBeanDefinitionRegistry</span></span><br><span class="line">                    ConfigurationClassPostProcessor<span class="punctuation">#</span><span class="keyword">processConfigBeanDefinitions</span></span><br><span class="line">                        ConfigurationClassParser<span class="punctuation">#</span><span class="keyword">parse</span></span><br><span class="line">                            for å¾ªç¯ start[è§£æå•ä¸ªç±»]</span><br><span class="line">                                ConfigurationClassParser<span class="punctuation">#</span><span class="keyword">parse</span><span class="params">(<span class="variable">AnnotationMetadata</span>, <span class="variable">java</span>.<span class="variable">lang</span>.<span class="variable">String</span>)</span></span><br><span class="line">                                    ConfigurationClassParser<span class="punctuation">#</span><span class="keyword">processImports</span>    (1)</span><br><span class="line">                            for å¾ªç¯ç»“æŸ</span><br><span class="line">                            DeferredImportSelectorHandler<span class="punctuation">#</span><span class="keyword">process</span>              (2)</span><br><span class="line">                                DeferredImportSelectorGroupingHandler<span class="punctuation">#</span><span class="keyword">processGroupImports</span></span><br></pre></td></tr></table></figure>
<ol>
<li>åœ¨ <code>(1)</code> ä½ç½®ä¼šæ‰¾åˆ° <code>DeferredImportSelector</code> ç±»å‹çš„ç±»ï¼Œç„¶åç¼“å­˜èµ·æ¥ï¼Œè¿™ä¸ªæ˜¯åœ¨ <code>ConfigurationClassParser</code> çš„ <code>processImports()</code> æ–¹æ³•ä¸­å¤„ç†çš„</li>
<li>æ‰€ä»¥è‡ªå®šä¹‰çš„ç±»éƒ½è§£ææˆ <code>BeanDefiniton</code> ä¹‹å(ä¸Šé¢æµç¨‹ä¸­çš„ <code>for</code> å¾ªç¯ä¹‹å)ï¼Œå¼€å§‹æ‰§è¡Œ <code>DeferredImportSelectorHandler</code> ç±»çš„ <code>process()</code> æ–¹æ³•ï¼Œè¿™æ˜¯å› ä¸º <code>(1)</code> ä¸­ç¼“å­˜çš„ <code>DeferredImportSelector</code> å°±æ˜¯å­˜æ”¾åœ¨ <code>DeferredImportSelectorHandler</code> ç±»ä¸­ï¼Œä¹Ÿå°±æ˜¯åœ¨ <code>(2)</code> ä¸­è°ƒç”¨åˆ° <code>Group</code> ç±»çš„ <code>process()</code> æ–¹æ³•</li>
</ol>
<p>æ¥ä¸‹æ¥ç›´æ¥ä» <strong>æ­¥éª¤3</strong> å¼€å§‹çœ‹,</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  AutoConfigurationGroupç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(AnnotationMetadata annotationMetadata, DeferredImportSelector deferredImportSelector)</span> &#123;</span><br><span class="line">    <span class="comment">// æ­¥éª¤3</span></span><br><span class="line">	<span class="type">AutoConfigurationEntry</span> <span class="variable">autoConfigurationEntry</span> <span class="operator">=</span> ((AutoConfigurationImportSelector) deferredImportSelector)</span><br><span class="line">	.getAutoConfigurationEntry(annotationMetadata);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  AutoConfigurationImportSelectorç±»</span></span><br><span class="line"><span class="comment">// æ­¥éª¤4ï¼š è¿™ä¸ªæ–¹æ³•æ˜¯ä» Group å®ç°ç±»ä¸­çš„ process() æ–¹æ³•è°ƒç”¨è¿‡æ¥çš„</span></span><br><span class="line"><span class="keyword">protected</span> AutoConfigurationEntry <span class="title function_">getAutoConfigurationEntry</span><span class="params">(AnnotationMetadata annotationMetadata)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">        <span class="keyword">return</span> EMPTY_ENTRY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">AnnotationAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> getAttributes(annotationMetadata);</span><br><span class="line">    <span class="comment">// æ­¥éª¤5ï¼š getCandidateConfigurations æ–¹æ³•ä¼šä»é…ç½®æ–‡ä»¶åŠ è½½ç±»</span></span><br><span class="line">    List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">    configurations = removeDuplicates(configurations);</span><br><span class="line">    <span class="comment">// è·å–æ‰‹åŠ¨æ’é™¤æ‰çš„ç±»ï¼Œæ¯”å¦‚æˆ‘ä»¬é…ç½®äº† exclude ç›¸å…³çš„é…ç½®</span></span><br><span class="line">    Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);</span><br><span class="line">    checkExcludedClasses(configurations, exclusions);</span><br><span class="line">    configurations.removeAll(exclusions);</span><br><span class="line">    <span class="comment">// æ­¥éª¤6ï¼š è¿™é‡Œå°±æ˜¯æ ¹æ®æ¡ä»¶åˆ¤æ–­ï¼Œè¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„ç±»</span></span><br><span class="line">    configurations = getConfigurationClassFilter().filter(configurations);</span><br><span class="line">    fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AutoConfigurationEntry</span>(configurations, exclusions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ­¥éª¤5</strong> å®Œæˆçš„äº‹æƒ…â€“ä»é…ç½®æ–‡ä»¶è·å–æ•°æ®ï¼Œå¾—åˆ°çš„æ˜¯é…ç½®çš„å…¨é™å®šç±»å</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  AutoConfigurationImportSelector ç±»</span></span><br><span class="line"><span class="keyword">protected</span> List&lt;String&gt; <span class="title function_">getCandidateConfigurations</span><span class="params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> &#123;</span><br><span class="line">    List&lt;String&gt; configurations = ImportCandidates.load(AutoConfiguration.class, getBeanClassLoader())</span><br><span class="line">        .getCandidates();</span><br><span class="line">    <span class="keyword">return</span> configurations;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ImportCandidates ç±»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOCATION</span> <span class="operator">=</span> <span class="string">&quot;META-INF/spring/%s.imports&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ImportCandidates <span class="title function_">load</span><span class="params">(Class&lt;?&gt; annotation, ClassLoader classLoader)</span> &#123;</span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">classLoaderToUse</span> <span class="operator">=</span> decideClassloader(classLoader);</span><br><span class="line">    <span class="comment">//  location = META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">location</span> <span class="operator">=</span> String.format(LOCATION, annotation.getName());</span><br><span class="line">    <span class="comment">//  é€šè¿‡ ClassLoader è¯»å– META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</span></span><br><span class="line">    <span class="comment">// æ–‡ä»¶, è¿™ä¸ªä¸æ˜¯æŸä¸ª jar åŒ…ï¼Œè€Œæ˜¯ classpath ä¸‹çš„æ‰€æœ‰jar åŒ…å¯¹åº”è·¯å¾„çš„æ–‡ä»¶</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥è¿”å›çš„æ˜¯ url çš„é›†åˆ</span></span><br><span class="line">    Enumeration&lt;URL&gt; urls = findUrlsInClasspath(classLoaderToUse, location);</span><br><span class="line">    List&lt;String&gt; importCandidates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> urls.nextElement();</span><br><span class="line">        <span class="comment">// éå†æ¯ä¸ª urlï¼Œ è¯»å–å¯¹åº”çš„æ–‡ä»¶å†…å®¹ï¼Œ ç„¶åå°†æ–‡ä»¶å†…å®¹ä¸­çš„å†…å®¹æ·»åŠ åˆ° importCandidates ä¸­</span></span><br><span class="line">        importCandidates.addAll(readCandidateConfigurations(url));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ImportCandidates</span>(importCandidates);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æˆªå– <code>spring-boot-autoconfigure</code> è¿™ä¸ªåŒ…ä¸‹ <code>org.springframework.boot.autoconfigure.AutoConfiguration.imports</code> æ–‡ä»¶çš„ä¸€éƒ¨åˆ†å†…å®¹çœ‹çœ‹</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.autoconfigure</span><span class="selector-class">.admin</span><span class="selector-class">.SpringApplicationAdminJmxAutoConfiguration</span></span><br><span class="line">org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.autoconfigure</span><span class="selector-class">.aop</span><span class="selector-class">.AopAutoConfiguration</span></span><br><span class="line">org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.autoconfigure</span><span class="selector-class">.amqp</span><span class="selector-class">.RabbitAutoConfiguration</span></span><br><span class="line">org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.autoconfigure</span><span class="selector-class">.batch</span><span class="selector-class">.BatchAutoConfiguration</span></span><br><span class="line">â€¦â€¦</span><br></pre></td></tr></table></figure>

<p>å°±æ˜¯ä¸€è¡Œä¸€ä¸ªå…¨é™å®šç±»åè€Œå·²ï¼Œå’Œ <code>SpringBoot2.7</code> ä¹‹å‰çš„ <code>spring.factories</code> æ–‡ä»¶æ˜¯ä¸åŒçš„ï¼Œè¿™é‡Œä¹Ÿæ‹¿ä¸€ä¸ª <code>spring.factories</code> æ–‡ä»¶å†…å®¹å¯¹æ¯”ä¸€ä¸‹</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è¿™æ˜¯ä¸€ä¸ª key</span></span><br><span class="line"><span class="keyword">org.springframework.boot.autoconfigure.AutoConfigurationImportFilter=\</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">org.springframework.boot.autoconfigure.condition.OnBeanCondition,\</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">org.springframework.boot.autoconfigure.condition.OnClassCondition,\</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">org.springframework.boot.autoconfigure.condition.OnWebApplicationCondition</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="comment"># Auto Configure</span></span><br><span class="line"><span class="comment"># è¿™æ˜¯è‡ªåŠ¨è£…é…çš„ key</span></span><br><span class="line"><span class="keyword">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span></span><br><span class="line"><span class="keyword"></span>â€¦â€¦</span><br></pre></td></tr></table></figure>

<p><strong>æ­¥éª¤6</strong>å®Œæˆçš„äº‹æƒ…ï¼Œå¯¹ <strong>æ­¥éª¤5</strong>ä¸­è·å–çš„å…¨é™å®šç±»åè¿›è¡Œè¿‡æ»¤</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  AutoConfigurationImportSelectorç±»</span></span><br><span class="line"><span class="comment">// æ­¥éª¤4ï¼š è¿™ä¸ªæ–¹æ³•æ˜¯ä» Group å®ç°ç±»ä¸­çš„ process() æ–¹æ³•è°ƒç”¨è¿‡æ¥çš„</span></span><br><span class="line"><span class="keyword">protected</span> AutoConfigurationEntry <span class="title function_">getAutoConfigurationEntry</span><span class="params">(AnnotationMetadata annotationMetadata)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">        <span class="keyword">return</span> EMPTY_ENTRY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">AnnotationAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> getAttributes(annotationMetadata);</span><br><span class="line">    <span class="comment">// æ­¥éª¤5ï¼š getCandidateConfigurations æ–¹æ³•ä¼šä»é…ç½®æ–‡ä»¶åŠ è½½ç±»</span></span><br><span class="line">    List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">    configurations = removeDuplicates(configurations);</span><br><span class="line">    <span class="comment">// è·å–æ‰‹åŠ¨æ’é™¤æ‰çš„ç±»ï¼Œæ¯”å¦‚æˆ‘ä»¬é…ç½®äº† exclude ç›¸å…³çš„é…ç½®</span></span><br><span class="line">    Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);</span><br><span class="line">    checkExcludedClasses(configurations, exclusions);</span><br><span class="line">    configurations.removeAll(exclusions);</span><br><span class="line">    <span class="comment">// æ­¥éª¤6ï¼š è¿™é‡Œå°±æ˜¯æ ¹æ®æ¡ä»¶åˆ¤æ–­ï¼Œè¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„ç±»</span></span><br><span class="line">    configurations = getConfigurationClassFilter().filter(configurations);</span><br><span class="line">    fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AutoConfigurationEntry</span>(configurations, exclusions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>è°ƒç”¨ <code>getConfigurationClassFilter()</code> æ–¹æ³•è·å– <code>classFilter</code>, è¿™ä¸ªä¸è·Ÿä¸‹å»äº†ï¼Œç›´æ¥è¯´ç»“è®ºï¼Œå…¶å®ä¹Ÿæ˜¯æ ¹æ® <code>spi</code> æœºåˆ¶ä» <code>spring.factories</code> æ–‡ä»¶ä¸­è·å–çš„ï¼Œä»ä¸Šé¢åˆ—å‡ºçš„ <code>spring.factories</code> æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯ <code>key=values</code> çš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª <code>key</code> å¯ä»¥é…ç½®å¤šä¸ªå€¼ï¼Œè€Œè·å– <code>classFilter</code> çš„ <code>key</code> æ˜¯ <code>AutoConfigurationImportFilter</code>ï¼Œ å†çœ‹çœ‹ <code>spring.factories</code> æ–‡ä»¶ä¸­å…³äº <code>AutoConfigurationImportFilter</code> çš„é…ç½®</li>
</ol>
<figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è¿™ä¸ªé…ç½®æ–‡ä»¶ä¹Ÿæ˜¯åœ¨ spring-boot-autoconfigure åŒ…ä¸‹é¢</span></span><br><span class="line"><span class="comment"># Auto Configuration Import Filters</span></span><br><span class="line">org.springframework.boot.autoconfigure.AutoConfigurationImportFilter=<span class="string">\</span></span><br><span class="line">org.springframework.boot.autoconfigure.condition.OnBeanCondition,<span class="string">\</span></span><br><span class="line">org.springframework.boot.autoconfigure.condition.OnClassCondition,<span class="string">\</span></span><br><span class="line">org.springframework.boot.autoconfigure.condition.OnWebApplicationCondition</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><code>getConfigurationClassFilter()</code> æ–¹æ³•çš„è¿”å›å€¼æ˜¯ <code>ConfigurationClassFilter</code>ï¼Œ çœ‹çœ‹è¿™ä¸ªç±»ï¼Œå…·ä½“çš„è¿‡æ»¤é€»è¾‘è¿™é‡Œå°±ä¸å†åˆ†æ</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ConfigurationClassFilter</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AutoConfigurationMetadata autoConfigurationMetadata;</span><br><span class="line">    <span class="comment">// ä¸Šé¢è®²åˆ°ä¼šä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½åˆ°ä¸‰ä¸ª AutoConfigurationImportFilter å®ç°ç±»ï¼Œä¼šä¿å­˜åœ¨è¿™é‡Œç„¶åè°ƒç”¨è¿‡æ»¤æ–¹æ³•</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;AutoConfigurationImportFilter&gt; filters;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è§£ææ–‡ä»¶å’Œè¿‡æ»¤åçš„å¤„ç†"><a href="#è§£ææ–‡ä»¶å’Œè¿‡æ»¤åçš„å¤„ç†" class="headerlink" title="è§£ææ–‡ä»¶å’Œè¿‡æ»¤åçš„å¤„ç†"></a>è§£ææ–‡ä»¶å’Œè¿‡æ»¤åçš„å¤„ç†</h3><p>é…ç½®æ–‡ä»¶ä¹Ÿè§£æäº†ï¼Œè¿‡æ»¤ä¹Ÿè¿‡æ»¤å®Œäº†ï¼Œå›è¿‡å¤´å†çœ‹çœ‹ <code>Group</code> ç±»çš„ <code>process()</code> æ–¹æ³•æ˜¯ä»å“ªé‡Œè°ƒç”¨è¿‡æ¥çš„ï¼Œå‰é¢æœ‰ï¼Œè¿™é‡Œå†è´´ä¸€ä¸‹æµç¨‹</p>
<figure class="highlight leaf"><table><tr><td class="code"><pre><span class="line">AbstractApplicationContext<span class="punctuation">#</span><span class="keyword">refresh</span></span><br><span class="line">    AbstractApplicationContext<span class="punctuation">#</span><span class="keyword">invokeBeanFactoryPostProcessors</span></span><br><span class="line">        public PostProcessorRegistrationDelegate<span class="punctuation">#</span><span class="keyword">invokeBeanFactoryPostProcessors</span></span><br><span class="line">            private PostProcessorRegistrationDelegate<span class="punctuation">#</span><span class="keyword">invokeBeanDefinitionRegistryPostProcessors</span></span><br><span class="line">                ConfigurationClassPostProcessor<span class="punctuation">#</span><span class="keyword">postProcessBeanDefinitionRegistry</span></span><br><span class="line">                    ConfigurationClassPostProcessor<span class="punctuation">#</span><span class="keyword">processConfigBeanDefinitions</span></span><br><span class="line">                        ConfigurationClassParser<span class="punctuation">#</span><span class="keyword">parse</span></span><br><span class="line">                            for å¾ªç¯ start[è§£æå•ä¸ªç±»]</span><br><span class="line">                                ConfigurationClassParser<span class="punctuation">#</span><span class="keyword">parse</span><span class="params">(<span class="variable">AnnotationMetadata</span>, <span class="variable">java</span>.<span class="variable">lang</span>.<span class="variable">String</span>)</span></span><br><span class="line">                                    ConfigurationClassParser<span class="punctuation">#</span><span class="keyword">processImports</span></span><br><span class="line">                            for å¾ªç¯ç»“æŸ</span><br><span class="line">                            DeferredImportSelectorHandler<span class="punctuation">#</span><span class="keyword">process</span></span><br><span class="line">                                DeferredImportSelectorGroupingHandler<span class="punctuation">#</span><span class="keyword">processGroupImports</span></span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æ˜¯åœ¨ <strong>DeferredImportSelectorHandler</strong> çš„ç±» <code>process()</code> æ–¹æ³•ä¸­å¤„ç†çš„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  ConfigurationClassParser</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processGroupImports</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (DeferredImportSelectorGrouping grouping : <span class="built_in">this</span>.groupings.values()) &#123;</span><br><span class="line">        Predicate&lt;String&gt; exclusionFilter = grouping.getCandidateFilter();</span><br><span class="line">        <span class="comment">// å°±æ˜¯åœ¨ getImport() æ–¹æ³•ä¸­è°ƒç”¨åˆ° Group å®ç°ç±»çš„ process() æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// è¿”å›å€¼ Group å®ç°ç±»çš„ selectImports æ–¹æ³•</span></span><br><span class="line">        grouping.getImports().forEach(entry -&gt; &#123;</span><br><span class="line">            <span class="type">ConfigurationClass</span> <span class="variable">configurationClass</span> <span class="operator">=</span> <span class="built_in">this</span>.configurationClasses.get(entry.getMetadata());</span><br><span class="line">            <span class="comment">// æ‹¿åˆ°ç»“æœä¹‹åè°ƒç”¨çš„åˆæ˜¯  processImportsæ–¹æ³•ï¼Œ è¿™ä¸ªå°±æ˜¯å’Œ</span></span><br><span class="line">            <span class="comment">// @Import å¯¼å…¥çš„æ˜¯ä¸€ä¸ªæ™®é€šç±»çš„æµç¨‹ä¸€è‡´çš„</span></span><br><span class="line">            processImports(configurationClass, asSourceClass(configurationClass, exclusionFilter),</span><br><span class="line">                        Collections.singleton(asSourceClass(entry.getImportClassName(), exclusionFilter)),</span><br><span class="line">                        exclusionFilter, <span class="literal">false</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  ConfigurationClassParser</span></span><br><span class="line"><span class="keyword">public</span> Iterable&lt;Group.Entry&gt; getImports() &#123;</span><br><span class="line">    <span class="keyword">for</span> (DeferredImportSelectorHolder deferredImport : <span class="built_in">this</span>.deferredImports) &#123;</span><br><span class="line">        <span class="comment">//  å°±æ˜¯åœ¨è¿™é‡Œè°ƒç”¨åˆ° Group å®ç°ç±»çš„ process() æ–¹æ³•</span></span><br><span class="line">        <span class="built_in">this</span>.group.process(deferredImport.getConfigurationClass().getMetadata(),</span><br><span class="line">                deferredImport.getImportSelector());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.group.selectImports();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢ä»£ç çœ‹åˆ°ï¼Œæ‹¿åˆ°è§£æå’Œç»“æœçš„ç»“æœä¹‹åï¼Œé€šè¿‡ <code>foreach</code> è°ƒç”¨ <code>processImports()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å¤„ç†å•ä¸ª <code>@Import</code> å¯¼å…¥çš„ç±»çš„æ–¹æ³•ï¼Œè‡³æ­¤æ•´ä¸ªæµç¨‹å°±ä¸²èµ·æ¥äº†</p>
]]></content>
      <categories>
        <category>java</category>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot3è‡ªåŠ¨è£…é…æ¡ˆä¾‹</title>
    <url>/2023/ee343b448bf4/index.html</url>
    <content><![CDATA[<p>åˆ›å»ºä¸¤ä¸ª <code>module</code></p>
<ol>
<li><code>demo-starter</code>, è¿™ä¸ª <code>module</code> æ˜¯ä¸ºäº†è®©åˆ«çš„ <code>module</code> å¼•å…¥çš„ <code>starter</code> åŒ…</li>
<li><code>demo-main</code>, è¿™ä¸ª <code>module</code> ä¼šå¼•å…¥ <code>demo-starter</code> åŒ…</li>
</ol>
<p>ä¸¤ä¸ª <code>module</code> çš„åŒ…ç»“æ„å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">demo-starter</span><br><span class="line">â”‚  â”œâ”€<span class="attribute">src</span></span><br><span class="line">â”‚  â”‚  â”œâ”€<span class="selector-tag">main</span></span><br><span class="line">â”‚  â”‚  â”‚  â”œâ”€java</span><br><span class="line">â”‚  â”‚  â”‚  â”‚  â””â”€com</span><br><span class="line">â”‚  â”‚  â”‚  â”‚      â””â”€example</span><br><span class="line">â”‚  â”‚  â”‚  â”‚          â””â”€demostarter åŒ…ä¸‹æœ‰ StarterDemo ç±»</span><br><span class="line">â”‚  â”‚  â”‚  â””â”€resources</span><br><span class="line">â”‚  â”‚  â”‚      â””â”€META-INF</span><br><span class="line">â”‚  â”‚  â”‚          â””â”€spring  æ–‡ä»¶å¤¹ä¸‹æœ‰ org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.autoconfigure</span><span class="selector-class">.AutoConfiguration</span><span class="selector-class">.imports</span> æ–‡ä»¶</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>StarterDemo</code> ç±»å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StarterDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">starterDemo</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;StarterDemo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>org.springframework.boot.autoconfigure.AutoConfiguration.imports</code> æ–‡ä»¶å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">com<span class="selector-class">.example</span><span class="selector-class">.demostarter</span>.StarterDemo</span><br></pre></td></tr></table></figure>

<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">demo-main</span><br><span class="line">â”‚  â”œâ”€.mvn</span><br><span class="line">â”‚  â”‚  â””â”€<span class="keyword">wrapper</span></span><br><span class="line">â”‚  â”œâ”€src</span><br><span class="line">â”‚  â”‚  â”œâ”€main</span><br><span class="line">â”‚  â”‚  â”‚  â”œâ”€java</span><br><span class="line">â”‚  â”‚  â”‚  â”‚  â””â”€com</span><br><span class="line">â”‚  â”‚  â”‚  â”‚      â””â”€example</span><br><span class="line">â”‚  â”‚  â”‚  â”‚          â””â”€demomain åŒ…ä¸‹æœ‰ DemoMainApplication ç±»</span><br><span class="line">â”‚  â”‚  â”‚  â””â”€resources</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>DemoMainApplication</code> ç±»å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoMainApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DemoMainApplication.class, args);</span><br><span class="line">        <span class="comment">// åªæ˜¯å¼•å…¥äº†ä¾èµ–è€Œå·²ï¼Œå¹¶æ²¡æœ‰æ‰‹åŠ¨æ³¨å…¥ StarterDemo ç±»</span></span><br><span class="line">        <span class="comment">// ä½†æ˜¯è¿™ä¸ªç±»ä¹Ÿåœ¨ spring å®¹å™¨ä¸­ï¼Œå°±æ˜¯å› ä¸ºè‡ªåŠ¨è£…é…</span></span><br><span class="line">        context.getBean(StarterDemo.class).starterDemo(); <span class="comment">// ä¼šè¾“å‡º â€œStarterDemoâ€</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        context = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>demo-main</code> çš„ <code>pom.xml</code> ä¾èµ–å¦‚ä¸‹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>demo-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBootç¼–å†™æµ‹è¯•ç±»</title>
    <url>/2023/9cd70dc15320/index.html</url>
    <content><![CDATA[<p>ç‰ˆæœ¬è¯´æ˜ï¼š</p>
<ol>
<li>SpringBoot3.x</li>
</ol>
<h2 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="ç¼–å†™æµ‹è¯•ç±»"><a href="#ç¼–å†™æµ‹è¯•ç±»" class="headerlink" title="ç¼–å†™æµ‹è¯•ç±»"></a>ç¼–å†™æµ‹è¯•ç±»</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestRedis</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testOne</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æµ‹è¯•ç±»&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ³¨æ„ç‚¹"><a href="#æ³¨æ„ç‚¹" class="headerlink" title="æ³¨æ„ç‚¹"></a>æ³¨æ„ç‚¹</h3><ol>
<li><code>SpringBoot2.5</code> ä¹‹åæµ‹è¯•ç±»ä¸­å·²ç»ä¸éœ€è¦æ·»åŠ  <code>RunWith</code> æ³¨è§£ï¼Œåªéœ€è¦ä¸€ä¸ª <code>SpringBootTest</code></li>
<li>éœ€è¦ä¿è¯æµ‹è¯•ç±»æ‰€åœ¨çš„åŒ…å’Œé¡¹ç›®ä¸»é…ç½®ç±»åŒ…ä¸€è‡´ï¼ˆé¡¹ç›® <code>main</code> æ–¹æ³•æ‰€åœ¨çš„åŒ…ï¼‰ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œåˆ™å¯ä»¥æŒ‰ç…§ä¸‹é¢æ–¹å¼é…ç½®</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(classes = TestApplication.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestRedis</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testOne</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æµ‹è¯•ç±»&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloudAlibabaå’ŒSpringCloudå’ŒSpringBootä¹‹é—´ç‰ˆæœ¬å¯¹åº”å…³ç³»</title>
    <url>/2023/742b64bccf7c/index.html</url>
    <content><![CDATA[<h2 id="SpringClound-å’Œ-SpringBoot-çš„ç‰ˆæœ¬å¯¹åº”"><a href="#SpringClound-å’Œ-SpringBoot-çš„ç‰ˆæœ¬å¯¹åº”" class="headerlink" title="SpringClound å’Œ SpringBoot çš„ç‰ˆæœ¬å¯¹åº”"></a>SpringClound å’Œ SpringBoot çš„ç‰ˆæœ¬å¯¹åº”</h2><p><a href="https://spring.io/projects/spring-cloud">Springå®˜ç½‘ä¹‹SpringCloudé¡¹ç›®</a></p>
<h2 id="SpringCloundAlibaba-å’Œ-SpringCloud-çš„ç‰ˆæœ¬å¯¹åº”"><a href="#SpringCloundAlibaba-å’Œ-SpringCloud-çš„ç‰ˆæœ¬å¯¹åº”" class="headerlink" title="SpringCloundAlibaba å’Œ SpringCloud çš„ç‰ˆæœ¬å¯¹åº”"></a>SpringCloundAlibaba å’Œ SpringCloud çš„ç‰ˆæœ¬å¯¹åº”</h2><p><a href="https://sca.aliyun.com/zh-cn/">SpringCloundAlibabaå®˜ç½‘</a></p>
<p><a href="https://sca.aliyun.com/zh-cn/docs/2022.0.0.0/overview/version-explain">SpringCloundAlibaba2022ç‰ˆæœ¬å¯¹åº”æ–‡æ¡£è¯´æ˜</a></p>
]]></content>
      <categories>
        <category>java</category>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>CompletableFutureçš„ä½¿ç”¨</title>
    <url>/2023/f31e3a7691d6/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p>ä»¥ä¸‹å†…å®¹å‚è€ƒã€ŠJavaå¹¶å‘ç¼–ç¨‹æ·±åº¦è§£æä¸å®æˆ˜ã€‹è°­é”‹ï¼ˆç¬¬11ç« ï¼‰</p>
<h2 id="ä¸ºä»€ä¹ˆè¦ç”¨-CompletableFuture"><a href="#ä¸ºä»€ä¹ˆè¦ç”¨-CompletableFuture" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ç”¨ CompletableFuture"></a>ä¸ºä»€ä¹ˆè¦ç”¨ <code>CompletableFuture</code></h2><p>ä½¿ç”¨ <code>CompletableFuture</code> æ˜¯å› ä¸º <code>Future</code> è™½ç„¶å¯ä»¥è·å–çº¿ç¨‹æ‰§è¡Œç»“æœï¼Œä½†æ˜¯æ— æ³•ä½¿ç”¨å›è°ƒå‡½æ•°ï¼Œåªèƒ½ä¾é é˜»å¡æ–¹æ³• <code>get()</code> æ¥è·å–çº¿ç¨‹ç»“æœï¼Œ<code>CompletableFuture</code> å°±æ˜¯å¯¹ <code>Future</code> çš„ä¼˜åŒ–å’Œå¢å¼ºï¼Œå…·ä½“å¯ä»¥å®ç°ä»¥ä¸‹åŠŸèƒ½</p>
<ol>
<li>æä¾›äº†ç±»ä¼¼ <code>Future</code> çš„é˜»å¡å¼è·å–ç»“æœå’ŒçŠ¶æ€çš„æ–¹æ³•</li>
<li>æä¾› <code>CompletionStage</code> ä»»åŠ¡æ‰§è¡Œä¹‹åå›è°ƒ</li>
<li>å¤šä¸ªå¼‚æ­¥ä»»åŠ¡çš„èšåˆï¼Œä¸²è¡Œï¼Œå¹¶è¡Œç­‰åŠŸèƒ½</li>
</ol>
<h2 id="æ„é€ å¼‚æ­¥æ–¹æ³•"><a href="#æ„é€ å¼‚æ­¥æ–¹æ³•" class="headerlink" title="æ„é€ å¼‚æ­¥æ–¹æ³•"></a>æ„é€ å¼‚æ­¥æ–¹æ³•</h2><p><code>CompletableFuture</code> æä¾›äº† 4 ä¸ªé™æ€æ–¹æ³•æ¥æ„é€ ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å«æœ‰è¿”å›å€¼çš„å¼‚æ­¥æ–¹æ³•ï¼ˆè‡ªå®šä¹‰çº¿ç¨‹æ± å’Œé»˜è®¤çº¿ç¨‹æ± ï¼‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier, Executor executor)</span>;</span><br><span class="line"><span class="comment">// ä¸å«æœ‰è¿”å›å€¼çš„å¼‚æ­¥æ–¹æ³•ï¼ˆè‡ªå®šä¹‰çº¿ç¨‹æ± å’Œé»˜è®¤çº¿ç¨‹æ± ï¼‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable,Executor executor)</span></span><br></pre></td></tr></table></figure>
<div class="tabs" id="ä»£ç ç¤ºä¾‹"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="ä»£ç ç¤ºä¾‹-1">supplyAsync</button><button type="button" class="tab " data-href="ä»£ç ç¤ºä¾‹-2">runAsyncç¤ºä¾‹</button></ul><div class="tab-contents"><div class="tab-item-content active" id="ä»£ç ç¤ºä¾‹-1"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">      CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">          System.out.println(<span class="string">&quot;å½“å‰çº¿ç¨‹ï¼š&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">          <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">      System.out.println(<span class="string">&quot;çº¿ç¨‹æ‰§è¡Œç»“æœï¼š&quot;</span> + future.get());</span><br><span class="line">      System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹:&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>æ‰§è¡Œç»“æœ</span></figcaption><table><tr><td class="code"><pre><span class="line">å½“å‰çº¿ç¨‹ï¼šForkJoinPool.commonPool-worker-<span class="number">1</span></span><br><span class="line">çº¿ç¨‹æ‰§è¡Œç»“æœï¼š<span class="number">1</span></span><br><span class="line">ä¸»çº¿ç¨‹:main</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="ä»£ç ç¤ºä¾‹-2"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">      CompletableFuture&lt;Void&gt; future = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">          System.out.println(<span class="string">&quot;å½“å‰çº¿ç¨‹ï¼š&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">      &#125;);</span><br><span class="line">      System.out.println(<span class="string">&quot;çº¿ç¨‹æ‰§è¡Œç»“æœï¼š&quot;</span> + future.get());</span><br><span class="line">      System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹:&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>æ‰§è¡Œç»“æœ</span></figcaption><table><tr><td class="code"><pre><span class="line">å½“å‰çº¿ç¨‹ï¼šForkJoinPool.commonPool-worker-<span class="number">1</span></span><br><span class="line">çº¿ç¨‹æ‰§è¡Œç»“æœï¼š<span class="literal">null</span></span><br><span class="line">ä¸»çº¿ç¨‹:main</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h2 id="ä»»åŠ¡ä¸å’Œæˆ–çš„é™æ€æ–¹æ³•"><a href="#ä»»åŠ¡ä¸å’Œæˆ–çš„é™æ€æ–¹æ³•" class="headerlink" title="ä»»åŠ¡ä¸å’Œæˆ–çš„é™æ€æ–¹æ³•"></a>ä»»åŠ¡ä¸å’Œæˆ–çš„é™æ€æ–¹æ³•</h2><p><code>CompletableFuture</code> ä¸­è¿˜æœ‰å¦å¤–ä¸¤ä¸ªç‰¹æ®Šçš„é™æ€æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ¥æ”¶å¤šä¸ªCompletableFutureæ— è¿”å›å€¼ä»»åŠ¡ï¼Œå½“æ‰€æœ‰çš„CompletableFutureä»»åŠ¡æ‰§è¡Œç»“æŸåï¼Œè¿”å›ä¸€ä¸ªæ–°çš„CompletableFutureå¯¹è±¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">allOf</span><span class="params">(CompletableFuture&lt;?&gt;... cfs)</span>;</span><br><span class="line"><span class="comment">//æ¥æ”¶å¤šä¸ªCompletableFutureå¸¦æœ‰è¿”å›å€¼ä»»åŠ¡ï¼Œå½“ä»»ä½•ä¸€ä¸ªCompletableFutureä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œè¿”å›ä¸€ä¸ªæ–°çš„CompletableFutureå¯¹è±¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Object&gt; <span class="title function_">anyOf</span><span class="params">(CompletableFuture&lt;?&gt;... cfs)</span>;</span><br></pre></td></tr></table></figure>
<div class="tabs" id="allof()å’Œanyof()"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="allof()å’Œanyof()-1">allOf()</button><button type="button" class="tab " data-href="allof()å’Œanyof()-2">anyOf()</button></ul><div class="tab-contents"><div class="tab-item-content active" id="allof()å’Œanyof()-1"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;Void&gt; future1 = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;å½“å‰çº¿ç¨‹ï¼š&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;);</span><br><span class="line">    CompletableFuture&lt;Void&gt; future2 = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;å½“å‰çº¿ç¨‹ï¼š&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">LocalTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalTime.now();</span><br><span class="line">    System.out.println(<span class="string">&quot;before time:&quot;</span> + now.getMinute() + <span class="string">&quot;:&quot;</span> + now.getSecond());</span><br><span class="line">    CompletableFuture.allOf(future1, future2).join();</span><br><span class="line">    now = LocalTime.now();</span><br><span class="line">    System.out.println(<span class="string">&quot;after time:&quot;</span> + now.getMinute() + <span class="string">&quot;:&quot;</span> + now.getSecond());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœï¼Œç”¨äº†5sæ‰è¿”å›ï¼Œå› ä¸ºè¦æ‰€æœ‰éƒ½æ‰§è¡Œå®Œæˆæ‰è¿”å›ï¼Œå°±éœ€è¦çœ‹è€—æ—¶æœ€é•¿çš„é‚£ä¸ªçº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">before time:<span class="number">50</span>:<span class="number">33</span></span><br><span class="line">å½“å‰çº¿ç¨‹ï¼šForkJoinPool.commonPool-worker-<span class="number">1</span></span><br><span class="line">å½“å‰çº¿ç¨‹ï¼šForkJoinPool.commonPool-worker-<span class="number">2</span></span><br><span class="line">after time:<span class="number">50</span>:<span class="number">38</span></span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="allof()å’Œanyof()-2"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;Void&gt; future1 = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;å½“å‰çº¿ç¨‹ï¼š&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;);</span><br><span class="line">    CompletableFuture&lt;Void&gt; future2 = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;å½“å‰çº¿ç¨‹ï¼š&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">LocalTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalTime.now();</span><br><span class="line">    System.out.println(<span class="string">&quot;before time:&quot;</span> + now.getMinute() + <span class="string">&quot;:&quot;</span> + now.getSecond());</span><br><span class="line">    CompletableFuture.anyOf(future1, future2).join();</span><br><span class="line">    now = LocalTime.now();</span><br><span class="line">    System.out.println(<span class="string">&quot;after time:&quot;</span> + now.getMinute() + <span class="string">&quot;:&quot;</span> + now.getSecond());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœï¼Œåªç”¨äº†3så°±è¿”å›äº†ï¼Œå› ä¸ºæ˜¯å…¶ä¸­ä¸€ä¸ªæ‰§è¡Œå®Œæˆå°±è¡Œï¼Œæ‰€ä»¥çœ‹è€—æ—¶æœ€çŸ­çš„é‚£ä¸ªçº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">before time:<span class="number">53</span>:<span class="number">43</span></span><br><span class="line">å½“å‰çº¿ç¨‹ï¼šForkJoinPool.commonPool-worker-<span class="number">1</span></span><br><span class="line">after time:<span class="number">53</span>:<span class="number">46</span></span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h2 id="CompletionStage-è¯¦è§£"><a href="#CompletionStage-è¯¦è§£" class="headerlink" title="CompletionStage è¯¦è§£"></a><code>CompletionStage</code> è¯¦è§£</h2><ol>
<li><code>CompletionStage</code> è¡¨ç¤ºä»»åŠ¡æ‰§è¡Œçš„ä¸€ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªå¼‚æ­¥ä»»åŠ¡éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ <code>CompletionStage</code> å¯¹è±¡</li>
<li>å¯ä»¥é’ˆå¯¹å¤šä¸ª <code>CompletionStage</code> å¯¹è±¡è¿›è¡Œä¸²è¡Œã€å¹¶è¡Œæˆ–è€…èšåˆæ¥è¿›è¡Œä¸‹ä¸€é˜¶æ®µçš„æ“ä½œ</li>
</ol>
<p><code>CompletionStage</code> ç±»ä¸­æä¾›äº†å¾ˆå¤šæ–¹æ³•æ¥å®ç°å¤šä¸ª <code>CompletionStage</code> çš„ä¸²è¡Œï¼Œå¹¶è¡Œç­‰åŠŸèƒ½ï¼Œå¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹å¼è¿›è¡Œåˆ†ç±»</p>
<pre class="mermaid">flowchart LR
    A[CompletionStage]
    B["çº¯æ¶ˆè´¹æ€§æ–¹æ³• \n (ä¸Šä¸€ä¸ªå¼‚æ­¥ç»“æœ \n ä½œä¸ºå½“å‰æ–¹æ³•çš„å‚æ•°è¿›è¡Œè®¡ç®— \n éƒ½å«æœ‰ Accept å…³é”®å­—)"]
        B1[ä¾èµ–å•ä¸ª CompletionStageä»»åŠ¡å®Œæˆ]
            B11["thenAccept(Consumer)"]
            B12["thenAcceptAsync(Consumer)"]
            B13["thenAcceptAsync(Consumer,Executor)"]
            B1-->B11 & B12 & B13
        B2[ä¾èµ–ä¸¤ä¸ª CompletionStageä»»åŠ¡å®Œæˆ]
            B21["thenAcceptBoth(CompletionStage,Consumer)"]
            B22["thenAcceptBothAsync(CompletionStage,Consumer)"]
            B23["thenAcceptBothAsync(CompletionStage,Consumer,Executor)"]
            B2-->B21 & B22 & B23
        B3[ä¾èµ–ä¸¤ä¸ª CompletionStageä»»åŠ¡ä¸­ä»»ä½•ä¸€ä¸ªå®Œæˆ]
            B31["acceptEither(CompletionStage,Consumer)"]
            B32["acceptEitherAsync(CompletionStage,Consumer)"]
            B33["acceptEitherAsync(CompletionStage,Consumer,Executor)"]
            B3-->B31 & B32 & B33
        B-->B1 & B2 & B3

    C["æœ‰è¿”å›å€¼ç±»å‹çš„æ–¹æ³• \n (ä¸Šä¸€ä¸ªå¼‚æ­¥ç»“æœ \n ä½œä¸ºå½“å‰æ–¹æ³•çš„å‚æ•°è¿›è¡Œè®¡ç®— \n å¹¶ä¸”ä¼šäº§ç”Ÿæ–°çš„æœ‰è¿”å›å€¼\nçš„CompletionStageå¯¹è±¡)"]
        C1[ä¾èµ–å•ä¸ª CompletionStageä»»åŠ¡å®Œæˆ]
            C11["thenApply(Function)"]
            C12["thenApplyAsync(Function)"]
            C13["thenApplyAsync(Function,Executor)"]
            C1-->C11 & C12 & C13
        C2[ä¾èµ–ä¸¤ä¸ª CompletionStageä»»åŠ¡å®Œæˆ]
            C21["thenCombine(CompletionStage,BiFunction)"]
            C22["thenCombineAsync(CompletionStage,BiFunction)"]
            C23["thenCombineAsync(CompletionStage,BiFunction,Executor)"]
            C2-->C21 & C22 & C23
        C3[ä¾èµ–ä¸¤ä¸ª CompletionStageä»»åŠ¡ä¸­ä»»ä½•ä¸€ä¸ªå®Œæˆ]
            C31["acceptToEither(CompletionStage,Function)"]
            C32["acceptToEitherAsync(CompletionStage,Function)"]
            C33["acceptToEitherAsync(CompletionStage,Function,Executor)"]
            C3-->C31 & C32 & C33
        C-->C1 & C2 & C3
    D["ä¸æ¶ˆè´¹ä¹Ÿæ²¡æœ‰è¿”å›å€¼ç±»å‹çš„æ–¹æ³•\nä¸ä¾èµ–ä¸Šä¸ªé˜¶æ®µçš„ç»“æœ\nä¸Šä¸€ä¸ªé˜¶æ®µå®Œæˆå°±æ‰§è¡ŒæŒ‡å®šçš„ä»»åŠ¡\nè¿™ç±»æ–¹æ³•éƒ½åŒ…å« run å…³é”®å­—"]
        D1[ä¾èµ–å•ä¸ª CompletionStageä»»åŠ¡å®Œæˆ]
            D11["thenRun(Runnable)"]
            D12["thenRunAsync(Runnable)"]
            D13["thenRunAsync(FuncRunnabletion,Executor)"]
            D1-->D11 & D12 & D13
        D2[ä¾èµ–ä¸¤ä¸ª CompletionStageä»»åŠ¡å®Œæˆ]
            D21["runAfterBoth(CompletionStage,Runnable)"]
            D22["runAfterBothAsync(CompletionStage,Runnable)"]
            D23["runAfterBothAsync(CompletionStage,Runnable,Executor)"]
            D2-->D21 & D22 & D23
        D3[ä¾èµ–ä¸¤ä¸ª CompletionStageä»»åŠ¡ä¸­ä»»ä½•ä¸€ä¸ªå®Œæˆ]
            D31["runAfterEither(CompletionStage,Runnable)"]
            D32["runAfterEitherAsync(CompletionStage,Runnable)"]
            D33["runAfterEitherAsync(CompletionStage,Runnable,Executor)"]
            D3-->D31 & D32 & D33
        D-->D1 & D2 & D3
    E[ç»„åˆç±»å‹çš„æ–¹æ³•]
        E1["thenCompose(Function,CompletionStage)"]
        E2["thenComposeAsync(Function,CompletionStage)"]
        E3["thenComposeAsync(Function,CompletionStage,Executor)"]
        E-->E1 & E2 & E3
    A-->B & C & D & E</pre>

<div class="tabs" id="ä»£ç ç¤ºä¾‹"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="ä»£ç ç¤ºä¾‹-1">çº¯æ¶ˆè´¹å‹</button><button type="button" class="tab " data-href="ä»£ç ç¤ºä¾‹-2">æœ‰è¿”å›å€¼ç±»å‹</button><button type="button" class="tab " data-href="ä»£ç ç¤ºä¾‹-3">ä¸æ¶ˆè´¹ä¹Ÿæ²¡æœ‰è¿”å›å€¼ç±»å‹</button><button type="button" class="tab " data-href="ä»£ç ç¤ºä¾‹-4">ç»„åˆç±»å‹</button></ul><div class="tab-contents"><div class="tab-item-content active" id="ä»£ç ç¤ºä¾‹-1"><figure class="highlight java"><figcaption><span>thenAccept</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;thread main:&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    CompletableFuture.supplyAsync(()-&gt;&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;first stage:&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;).thenAccept((Integer v)-&gt; &#123;</span><br><span class="line">        <span class="comment">// v å°±æ˜¯ç¬¬ä¸€æ­¥è¿”å›çš„ç»“æœ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;then accept thread:&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        System.out.println(v + <span class="number">1</span>); <span class="comment">// 2</span></span><br><span class="line">    &#125;).join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>æ‰§è¡Œç»“æœ</span></figcaption><table><tr><td class="code"><pre><span class="line">thread main:main</span><br><span class="line">first stage:ForkJoinPool.commonPool-worker-<span class="number">1</span></span><br><span class="line">then accept thread:main</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç è°ƒç”¨ <code>thenAccept()</code> ä½¿ç”¨çš„æ˜¯ <code>main</code> çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ä½¿ç”¨ <code>thenAcceptAsync()</code>, è°ƒç”¨ç»“æœå¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">thread main:main</span><br><span class="line">first stage:ForkJoinPool.commonPool-worker-<span class="number">1</span></span><br><span class="line">then accept thread:ForkJoinPool.commonPool-worker-<span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="ä»£ç ç¤ºä¾‹-2"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;thread main:&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    CompletableFuture&lt;String&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€ä¸ªé˜¶æ®µä»»åŠ¡è¿”å›çš„æ˜¯ int ç±»å‹</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;).thenCombineAsync(CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// ç¬¬äºŒä¸ªé˜¶æ®µä»»åŠ¡è¿”å›çš„æ˜¯ String ç±»å‹</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;2&quot;</span>;</span><br><span class="line">    &#125;), (Integer i1, String s1) -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> i1 + s1;</span><br><span class="line">    &#125;);</span><br><span class="line">    System.out.println(completableFuture.get()); <span class="comment">// 12</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="ä»£ç ç¤ºä¾‹-3"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">DateTimeFormatter</span> <span class="variable">formatter</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">    CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// ç¬¬ä¸€ä¸ªé˜¶æ®µä»»åŠ¡ç­‰å¾…4s</span></span><br><span class="line">            Thread.sleep(<span class="number">4000</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;ç¬¬ä¸€ä¸ªé˜¶æ®µ:&quot;</span> + LocalDateTime.now().format(formatter));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;).runAfterEitherAsync(CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// ç¬¬äºŒä¸ªé˜¶æ®µä»»åŠ¡ç­‰å¾…2s</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;ç¬¬äºŒä¸ªé˜¶æ®µï¼š&quot;</span> + LocalDateTime.now().format(formatter));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;2&quot;</span>;</span><br><span class="line">    &#125;), () -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æœ€ç»ˆ:&quot;</span> + LocalDateTime.now().format(formatter));</span><br><span class="line">        System.out.println(<span class="string">&quot;æœ€ç»ˆæ‰§è¡Œçš„ä»»åŠ¡&quot;</span>);</span><br><span class="line">    &#125;).join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ç¬¬äºŒä¸ªé˜¶æ®µï¼š<span class="number">2023</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">56</span>:<span class="number">32</span></span><br><span class="line">æœ€ç»ˆ:<span class="number">2023</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">23</span>:<span class="number">56</span>:<span class="number">32</span></span><br><span class="line">æœ€ç»ˆæ‰§è¡Œçš„ä»»åŠ¡</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="ä»£ç ç¤ºä¾‹-4"><ol>
<li><code>thenCompose()</code>æ˜¯å¤šä»»åŠ¡ç»„åˆæ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨æ˜¯æŠŠä¸¤ä¸ª<code>CompletionStage</code>ä»»åŠ¡è¿›è¡Œç»„åˆè¾¾åˆ°ä¸²è¡Œæ‰§è¡Œçš„ç›®çš„ï¼Œä¹Ÿå°±æ˜¯æŠŠç¬¬ä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœä½œä¸ºå‚æ•°ä¼ é€’ç»™ç¬¬äºŒä¸ªä»»åŠ¡æ‰§è¡Œï¼Œå®ƒæœ‰ç‚¹ç±»ä¼¼äºå‰é¢æåˆ°çš„<code>thenCombine()</code>æ–¹æ³•ï¼Œæœ€å¤§çš„ä¸åŒåœ¨äº<code>thenCompose()</code>æ–¹æ³•ä¸­çš„ä»»åŠ¡å­˜åœ¨å…ˆåå…³ç³»ï¼Œè€Œ<code>thenCombine()</code>ä¸­ä¸¤ä¸ªä»»åŠ¡æ˜¯å¹¶è¡Œæ‰§è¡Œçš„</li>
</ol></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h2 id="å¼‚å¸¸å¤„ç†"><a href="#å¼‚å¸¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h2><p><code>CompletionStage</code> æ˜¯é“¾å¼å¤„ç†ï¼Œå½“å‰é¢çš„ä»»åŠ¡å‡ºç°å¼‚å¸¸çš„æ—¶å€™ï¼Œä¼šå¯¼è‡´åé¢çš„ä»»åŠ¡æ— æ³•å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç¬¬ä¸€ä¸ªä»»åŠ¡å‡ºç°å¼‚å¸¸&quot;</span>);</span><br><span class="line">    &#125;).thenRun(()-&gt;&#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œå¹¶ä¸ä¼šæ‰“å°ï¼Œå› ä¸ºå‰é¢ä¸€ä¸ªä»»åŠ¡å‡ºç°äº†å¼‚å¸¸ï¼Œå¯¼è‡´è¯¥ä»»åŠ¡æ— æ³•æ‰§è¡Œ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;ç¬¬äºŒä¸ªä»»åŠ¡&quot;</span>);</span><br><span class="line">    &#125;).join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥åœ¨ <code>CompletionStage</code> ä¸­ä¹Ÿæä¾›äº†å¼‚å¸¸å¤„ç†çš„ç›¸å…³æ–¹æ³•ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç±»</p>
<pre class="mermaid">flowchart LR
    A[CompletionStageå¼‚å¸¸å¤„ç†]
    B["ä»¥whenCompleteå‰ç¼€å¼€å¤´çš„æ–¹æ³•\nä¸è®ºå‰ç½®çš„CompletionStageä»»åŠ¡æ˜¯æ­£å¸¸æ‰§è¡Œç»“æŸ\nè¿˜æ˜¯å‡ºç°å¼‚å¸¸ï¼Œéƒ½èƒ½å¤Ÿè§¦å‘ç‰¹å®šçš„action\nè¿™äº›æ–¹æ³•éƒ½æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œ\nä¸€ä¸ªæ˜¯æ­£å¸¸çš„ç»“æœï¼Œä¸€ä¸ªæ˜¯å¼‚å¸¸\næ²¡æœ‰å¼‚å¸¸æ—¶ç¬¬äºŒä¸ªå°±æ˜¯null"]
        B1["whenComplete(BiConsumer)"]
        B2["whenCompleteAsync(BiConsumer)"]
        B3["whenCompleteAsync(BiConsumer,Executor)"]
        B-->B1 & B2 & B3
    C["ä»¥handleå‰ç¼€å¼€å¤´çš„æ–¹æ³•\nè¡¨ç¤ºå‰ç½®ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œ\nä¸ç®¡å‰ç½®ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€æ˜¯æ­£å¸¸è¿˜æ˜¯å¼‚å¸¸ï¼Œ\néƒ½ä¼šæ‰§è¡Œå…¶ä¸­çš„å‡½æ•°fnï¼Œ\nå®ƒå’ŒwhenCompleteç±»æ–¹æ³•çš„\nä½œç”¨å‡ ä¹ä¸€è‡´ï¼Œä¸åŒç‚¹åœ¨äºï¼Œ\nè¿™ç±»æ–¹æ³•æ˜¯æœ‰è¿”å›å€¼ç±»å‹çš„æ–¹æ³•"]
        C1["handle(BiFunction)"]
        C2["handleAsync(BiFunction)"]
        C3["handleAsync(BiFunction,Executor)"]
        C-->C1 & C2 & C3
    D["exceptionally()"]
        D1["exceptionally()æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå‡½æ•°fnï¼Œ\nå½“ä¸Šä¸€ä¸ªCompletionStageå‡ºç°å¼‚å¸¸æ—¶ï¼Œ\nä¼šæŠŠè¯¥å¼‚å¸¸ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°fnã€‚\nè¯¥æ–¹æ³•æœ‰ä¸€ä¸ªCompletionStageçš„è¿”å›å€¼ï¼Œ\nè¯´æ˜å½“å‰æ–¹æ³•å¯ä»¥åœ¨æ¥æ”¶åˆ°\nä¸Šä¸€ä¸ªé˜¶æ®µçš„å¼‚å¸¸æ—¶è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ï¼Œ\nè¿”å›ä¸€ä¸ªæ–°çš„CompletionStageå¯¹è±¡å®ä¾‹"]
        D-->D1
    A-->B & C & D</pre>

<h3 id="whenCompleteç±»å‹æ–¹æ³•"><a href="#whenCompleteç±»å‹æ–¹æ³•" class="headerlink" title="whenCompleteç±»å‹æ–¹æ³•"></a>whenCompleteç±»å‹æ–¹æ³•</h3><div class="tabs" id="whencompleteç±»å‹å¼‚å¸¸"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="whencompleteç±»å‹å¼‚å¸¸-1">æ²¡æœ‰å¼‚å¸¸çš„æƒ…å†µ</button><button type="button" class="tab " data-href="whencompleteç±»å‹å¼‚å¸¸-2">æœ‰å¼‚å¸¸çš„æƒ…å†µ</button></ul><div class="tab-contents"><div class="tab-item-content active" id="whencompleteç±»å‹å¼‚å¸¸-1"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;).whenCompleteAsync((result, excep)-&gt;&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ä»»åŠ¡ç»“æœ:&quot;</span> + result);</span><br><span class="line">        System.out.println(<span class="string">&quot;ç¬¬ä¸€ä¸ªä»»åŠ¡çš„å¼‚å¸¸:&quot;</span> + excep);</span><br><span class="line">    &#125;).join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ä»»åŠ¡ç»“æœ:<span class="number">1</span></span><br><span class="line">ç¬¬ä¸€ä¸ªä»»åŠ¡çš„å¼‚å¸¸:<span class="literal">null</span></span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="whencompleteç±»å‹å¼‚å¸¸-2"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç¬¬ä¸€ä¸ªä»»åŠ¡å‡ºç°å¼‚å¸¸&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;).whenCompleteAsync((result, excep)-&gt;&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ä»»åŠ¡ç»“æœ:&quot;</span> + result);</span><br><span class="line">        System.out.println(<span class="string">&quot;ç¬¬ä¸€ä¸ªä»»åŠ¡çš„å¼‚å¸¸:&quot;</span> + excep);</span><br><span class="line">    &#125;).join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ä»»åŠ¡ç»“æœ:<span class="literal">null</span></span><br><span class="line">ç¬¬ä¸€ä¸ªä»»åŠ¡çš„å¼‚å¸¸:java.util.concurrent.CompletionException: java.lang.RuntimeException: ç¬¬ä¸€ä¸ªä»»åŠ¡å‡ºç°å¼‚å¸¸</span><br><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.util.concurrent.CompletionException: java.lang.RuntimeException: ç¬¬ä¸€ä¸ªä»»åŠ¡å‡ºç°å¼‚å¸¸</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h3 id="handle-ç±»å‹æ–¹æ³•"><a href="#handle-ç±»å‹æ–¹æ³•" class="headerlink" title="handle ç±»å‹æ–¹æ³•"></a>handle ç±»å‹æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç¬¬ä¸€ä¸ªä»»åŠ¡å‡ºç°å¼‚å¸¸&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;).handle((result, excep) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ä»»åŠ¡ç»“æœ:&quot;</span> + result);</span><br><span class="line">        System.out.println(<span class="string">&quot;ç¬¬ä¸€ä¸ªä»»åŠ¡çš„å¼‚å¸¸:&quot;</span> + excep.toString().substring(<span class="number">1</span>, <span class="number">70</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ç¬¬äºŒä¸ªä»»åŠ¡çš„ç»“æœ&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// æœ€ç»ˆçš„æ‰§è¡Œç»“æœ</span></span><br><span class="line">    System.out.println(completableFuture.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ä»»åŠ¡ç»“æœ:<span class="literal">null</span></span><br><span class="line">ç¬¬ä¸€ä¸ªä»»åŠ¡çš„å¼‚å¸¸:ava.util.concurrent.CompletionException: java.lang.RuntimeException: </span><br><span class="line">ç¬¬äºŒä¸ªä»»åŠ¡çš„ç»“æœ</span><br></pre></td></tr></table></figure>
<h3 id="exceptionally-æ–¹æ³•"><a href="#exceptionally-æ–¹æ³•" class="headerlink" title="exceptionally()æ–¹æ³•"></a>exceptionally()æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    CompletableFuture&lt;Integer&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç¬¬ä¸€ä¸ªä»»åŠ¡å‡ºç°å¼‚å¸¸&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;).exceptionally(exec -&gt; &#123;</span><br><span class="line">        <span class="comment">// exceptionally é‡Œé¢çš„è¿”å›å€¼éœ€è¦å’Œå‰é¢çš„ stage è¿”å›å€¼ä¿æŒä¸€è‡´</span></span><br><span class="line">        <span class="keyword">return</span> Integer.valueOf(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// æœ€ç»ˆçš„æ‰§è¡Œç»“æœ</span></span><br><span class="line">    System.out.println(completableFuture.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>Futureçš„ä½¿ç”¨</title>
    <url>/2023/9f417cc2ea5e/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>java</code> ä¸­å¼‚æ­¥æ‰§è¡Œä»»åŠ¡å¯ä»¥è®©ä»»åŠ¡ç±»å®ç° <code>Runnable</code> æ¥å£å³å¯ï¼Œä½†æ˜¯ä½¿ç”¨ <code>Runnable</code> æ¥å£æ‰§è¡Œçš„ä»»åŠ¡æ— æ³•è·å–è¿”å›å€¼ï¼Œæ‰€ä»¥ <code>java</code> åœ¨ <code>jdk1.5</code> ç‰ˆæœ¬ä¸­å¢åŠ äº† <code>Future</code> æ¥å£å’Œ <code>Callable</code></p>
<span id="more"></span>
<h2 id="å…ˆç»™ç»“è®º"><a href="#å…ˆç»™ç»“è®º" class="headerlink" title="å…ˆç»™ç»“è®º"></a>å…ˆç»™ç»“è®º</h2><ol>
<li><code>Future</code> å¯ä»¥ä½¿ç”¨ <code>get()</code> æ–¹æ³•è·å–çº¿ç¨‹è°ƒç”¨çš„ç»“æœï¼Œè¯¥æ–¹æ³•ä¼šé˜»å¡ä¸»çº¿ç¨‹</li>
<li><code>Future</code> ç±»æœ‰æä¾› <code>isDone()</code> æ–¹æ³•æ¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦æ‰§è¡Œå®Œæˆï¼Œè¯¥æ–¹æ³•ä¸ä¼šé˜»å¡</li>
<li><code>Future</code> å¯ä»¥æ‹¿åˆ°çº¿ç¨‹ç»“æœæ˜¯å› ä¸ºåœ¨çº¿ç¨‹ä»»åŠ¡ç±»ï¼ˆ<code>FutureTask</code>ï¼‰ä¸­æ‰§è¡Œå®Œä»»åŠ¡ä¹‹åå°†ç»“æœè®¾ç½®åˆ°äº† <code>Future</code> ä¸­ã€å…ˆæœ‰ä¸ªæ¦‚å¿µï¼Œä¸‹æ–‡ä¼šåˆ†æã€‘</li>
</ol>
<h2 id="Future-çš„ä½¿ç”¨ç¤ºä¾‹"><a href="#Future-çš„ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="Future çš„ä½¿ç”¨ç¤ºä¾‹"></a>Future çš„ä½¿ç”¨ç¤ºä¾‹</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestThread</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line">        <span class="comment">// è¿™é‡Œsubmit æ–¹æ³•æ˜¯ &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task);</span></span><br><span class="line">        Future&lt;String&gt; future = executorService.submit(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;start execute:&quot;</span> + DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(LocalDateTime.now()));</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// éé˜»å¡è°ƒç”¨ï¼Œä¸æ–­æŸ¥è¯¢ç»“æœæ˜¯å¦å®Œæˆ</span></span><br><span class="line">        <span class="keyword">while</span> (!future.isDone()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;çº¿ç¨‹æœªæ‰§è¡Œå®Œæˆ&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è‹¥ä»»åŠ¡æœªæ‰§è¡Œå®Œæˆï¼Œget æ–¹æ³•ä¼šé˜»å¡ä¸»çº¿ç¨‹</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> future.get();</span><br><span class="line">        System.out.println(<span class="string">&quot;after execute Time:&quot;</span> +  DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(LocalDateTime.now()));</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        <span class="comment">// å…³é—­çº¿ç¨‹æ± ï¼Œå¦åˆ™jvmè¿›ç¨‹ä¼šä¸€ç›´åœ¨è¿è¡Œ</span></span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">çº¿ç¨‹æœªæ‰§è¡Œå®Œæˆ</span><br><span class="line">start execute:<span class="number">2023</span>-<span class="number">11</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">14</span>:<span class="number">35</span></span><br><span class="line">çº¿ç¨‹æœªæ‰§è¡Œå®Œæˆ</span><br><span class="line">çº¿ç¨‹æœªæ‰§è¡Œå®Œæˆ</span><br><span class="line">çº¿ç¨‹æœªæ‰§è¡Œå®Œæˆ</span><br><span class="line">after execute Time:<span class="number">2023</span>-<span class="number">11</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">14</span>:<span class="number">39</span></span><br><span class="line">hello</span><br></pre></td></tr></table></figure>
<h2 id="æ ¸å¿ƒç±»"><a href="#æ ¸å¿ƒç±»" class="headerlink" title="æ ¸å¿ƒç±»"></a>æ ¸å¿ƒç±»</h2><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311172311584.png" alt="FutureTaskæ ¸å¿ƒç±»"></p>
<h3 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h3><p>ä»ä¸Šé¢ç±»å›¾çœ‹åˆ°æ ¸å¿ƒç±»æ˜¯ <code>FutureTask</code>, è¿™ä¸ªç±»å®ç°äº† <code>Future</code> å’Œ <code>Runnable</code>, å¹¶ä¸”åœ¨æ„é€ å‡½æ•°ä¸­éœ€è¦ä¼ å…¥ <code>Callable</code></p>
<ol>
<li><code>FutureTask</code> å’Œ <code>Runnable</code> æ¥å£çš„å…³ç³»æ˜¯å®ç°ï¼Œç›®çš„æ˜¯ä¾¿äºå‘ä¸Šè½¬å‹ä¼ å‚ï¼Œçº¿ç¨‹æ± ä¸­æ¥æ”¶ä»»åŠ¡çš„é¡¶å±‚æ¥å£å°±æ˜¯ <code>Runnable</code></li>
<li><code>FutureTask</code> ç±»å’Œ <code>Callable</code> å®ç°ç±»çš„å…³ç³»æ˜¯ <strong>ç»„åˆ</strong>ï¼Œä¸‹é¢æ˜¯ <code>FutureTask</code> çš„æ„é€ æ–¹æ³•</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">FutureTask</span><span class="params">(Callable&lt;V&gt; callable)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (callable == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="built_in">this</span>.callable = callable;</span><br><span class="line">    <span class="built_in">this</span>.state = NEW;       <span class="comment">// ensure visibility of callable</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æè¿°ä¸Šé¢ä¸¤ç‚¹æ˜¯å› ä¸ºå…ˆå¼„æ¸…æ¥š <code>FutureTask</code> å’Œ <code>Callable</code> å’Œ <code>Runnable</code> ä¸‰è€…ä¹‹é—´çš„å…³ç³»ï¼Œè¿™æ ·æ‰èƒ½çŸ¥é“æœ€ç»ˆçš„ä»»åŠ¡ç±»æ˜¯å“ªä¸ªï¼ˆä»»åŠ¡ç±»çš„ <code>run()</code> æ–¹æ³•å°±æ˜¯é‡ç‚¹äº†ï¼‰</p>
<pre class="mermaid">sequenceDiagram
    participant A as ExecutorService
    participant B as AbstractExecutorService
    participant C as ThreadPoolExecutor
    A->>B: submit(Callable)
    Note over A,B: å°†Callableè½¬æ¢æˆFutureTask
    B->>B: RunnableFuture = new FutureTask<T>(callable)
    Note over B,C: å°†FutureTaskè½¬æ¢æˆRunnableFuture
    B->>C: execute(Runnable command) {
    B->>A: return RunnableFuture</T></pre>
<p>ä¸‹é¢å†è·Ÿç€ä»£ç çœ‹ä¸€éè¿™ä¸ªè¿‡ç¨‹</p>
<ol>
<li><code>TestThread#main</code> ä¸­åˆ›å»ºçº¿ç¨‹æ± å¹¶è°ƒç”¨ <code>submit()</code> æ–¹æ³•<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"><span class="comment">// æ¥ä¸‹æ¥çœ‹submit(Callable) æ–¹æ³•</span></span><br><span class="line">Future&lt;String&gt; future = executorService.submit(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start execute:&quot;</span> + DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(LocalDateTime.now()));</span><br><span class="line">    Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li><code>submit()</code> æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>java.util.concurrent.AbstractExecutorService#submit(java.util.concurrent.Callable&lt;T&gt;)</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;T&gt; task)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// è¿™é‡Œå°±æ˜¯æ ¹æ® Callable ç”Ÿæˆ FutureTask ç±»</span></span><br><span class="line">    RunnableFuture&lt;T&gt; ftask = newTaskFor(task);</span><br><span class="line">    <span class="comment">// æ¥ä¸‹æ¥çœ‹ execute æ–¹æ³•ï¼Œè¿™ä¸ªå°±æ˜¯ ThreadPoolExecutor ä¸­çš„ execute() æ–¹æ³•</span></span><br><span class="line">    execute(ftask);</span><br><span class="line">    <span class="keyword">return</span> ftask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; RunnableFuture&lt;T&gt; <span class="title function_">newTaskFor</span><span class="params">(Callable&lt;T&gt; callable)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;T&gt;(callable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><code>java.util.concurrent.ThreadPoolExecutor#execute(Runnable)</code> è¿™ä¸ªå°±æ˜¯çº¿ç¨‹æ± çš„æ‰§è¡Œé€»è¾‘ï¼Œå‚è€ƒ</li>
</ol>
<p><code>&#123;% post_path çº¿ç¨‹æ± å®ç°åŸç† %&#125;</code><br>é€šè¿‡ä¸Šé¢çš„æ­¥éª¤å·²ç»çŸ¥é“çº¿ç¨‹æ± ä¸­ä½¿ç”¨çš„ <strong>ä»»åŠ¡ç±»</strong> æ˜¯ <code>FutureTask</code>ï¼Œé‚£ä¹ˆå°±ä¸€å®šä¼šè°ƒç”¨ <code>FutureTask</code> ç±»ä¸­çš„ <code>run()</code> æ–¹æ³•</p>
<h2 id="FutureTask-ç±»ä¸­é‡è¦å±æ€§"><a href="#FutureTask-ç±»ä¸­é‡è¦å±æ€§" class="headerlink" title="FutureTask ç±»ä¸­é‡è¦å±æ€§"></a>FutureTask ç±»ä¸­é‡è¦å±æ€§</h2><p>ä½†æ˜¯åœ¨çœ‹ <code>run()</code> æ–¹æ³•ä¹‹å‰å…ˆçœ‹ä¸€ä¸‹ <code>FutureTask</code> ç±»ä¸­æ¯”è¾ƒé‡è¦çš„ä¸¤ä¸ªå±æ€§ï¼Œåœ¨åé¢çš„æ–¹æ³•ä¸­ä¼šé‡åˆ°</p>
<ol>
<li>æè¿°ä»»åŠ¡çŠ¶æ€çš„å­—æ®µ <code>state</code></li>
<li>ç»“æœä¿å­˜å­—æ®µ <code>Object outcome</code></li>
<li>ç­‰å¾…é˜Ÿåˆ— <code>volatile WaitNode waiters;</code></li>
</ol>
<h3 id="FutureTask-ä»»åŠ¡çŠ¶æ€å­—æ®µ-state"><a href="#FutureTask-ä»»åŠ¡çŠ¶æ€å­—æ®µ-state" class="headerlink" title="FutureTask ä»»åŠ¡çŠ¶æ€å­—æ®µ state"></a>FutureTask ä»»åŠ¡çŠ¶æ€å­—æ®µ state</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> state;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NEW</span>          <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COMPLETING</span>   <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NORMAL</span>       <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">EXCEPTIONAL</span>  <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CANCELLED</span>    <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INTERRUPTING</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INTERRUPTED</span>  <span class="operator">=</span> <span class="number">6</span>;</span><br></pre></td></tr></table></figure>
<h4 id="state-çŠ¶æ€è½¬æ¢æµç¨‹"><a href="#state-çŠ¶æ€è½¬æ¢æµç¨‹" class="headerlink" title="state çŠ¶æ€è½¬æ¢æµç¨‹"></a>state çŠ¶æ€è½¬æ¢æµç¨‹</h4><pre class="mermaid">graph LR
    A[new]
    B[COMPLETING]
    C[NORMAL]
    D[EXCEPTIONAL]
    E[CANCELLED]
    F[INTERRUPTING]
    G[INTERRUPTED]
    A--"set() or setException()"-->B-->C & D
    A--"cancel(false)"-->E
    A--"cancel(true)"-->F-->G</pre>
<h3 id="Object-outcome"><a href="#Object-outcome" class="headerlink" title="Object outcome"></a><code>Object outcome</code></h3><p><code>outcome</code> å­—æ®µå°±æ˜¯ç”¨æ¥ä¿å­˜çº¿ç¨‹æ‰§è¡Œçš„ç»“æœçš„</p>
<h3 id="ç­‰å¾…é˜Ÿåˆ—-WaitNode-waiters"><a href="#ç­‰å¾…é˜Ÿåˆ—-WaitNode-waiters" class="headerlink" title="ç­‰å¾…é˜Ÿåˆ— WaitNode waiters"></a>ç­‰å¾…é˜Ÿåˆ— <code>WaitNode waiters</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">WaitNode</span> &#123;</span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line">    <span class="keyword">volatile</span> WaitNode next;</span><br><span class="line">    WaitNode() &#123; thread = Thread.currentThread(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>waiters æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œwaiters å­—æ®µå°±æ˜¯è¿™ä¸ªé“¾è¡¨çš„å¤´éƒ¨</li>
<li>å› ä¸ºå¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹å»è°ƒç”¨ <code>Future.get()</code> æ–¹æ³•ï¼Œå½“æ²¡æœ‰è·å–åˆ°ç»“æœæ—¶ï¼Œæ‰€æœ‰è°ƒç”¨ <code>get()</code> æ–¹æ³•çš„çº¿ç¨‹éƒ½æ˜¯éœ€è¦é˜»å¡çš„</li>
</ol>
<h2 id="FutureTask-çš„-run-æ–¹æ³•"><a href="#FutureTask-çš„-run-æ–¹æ³•" class="headerlink" title="FutureTask çš„ run() æ–¹æ³•"></a>FutureTask çš„ run() æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1. state è®°å½•çš„æ˜¯å½“å‰ä»»åŠ¡çš„çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (state != NEW ||</span><br><span class="line">        !RUNNER.compareAndSet(<span class="built_in">this</span>, <span class="literal">null</span>, Thread.currentThread()))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Callable&lt;V&gt; c = callable;</span><br><span class="line">        <span class="keyword">if</span> (c != <span class="literal">null</span> &amp;&amp; state == NEW) &#123;</span><br><span class="line">            V result;</span><br><span class="line">            <span class="type">boolean</span> ran;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 2. æ„é€  FutureTask æ—¶å°† Callable ä¼ é€’è¿›æ¥äº†ï¼Œåœ¨è¿™é‡Œè¿›è¡Œè°ƒç”¨</span></span><br><span class="line">                result = c.call();</span><br><span class="line">                <span class="comment">// è®¾ç½®è°ƒç”¨å®Œæˆçš„æ ‡è¯†</span></span><br><span class="line">                ran = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                result = <span class="literal">null</span>;</span><br><span class="line">                ran = <span class="literal">false</span>;</span><br><span class="line">                setException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ran)</span><br><span class="line">                <span class="comment">// 3. è°ƒç”¨å®Œæˆä¹‹åè®¾ç½®ç»“æœ</span></span><br><span class="line">                set(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        runner = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> state;</span><br><span class="line">        <span class="keyword">if</span> (s &gt;= INTERRUPTING)</span><br><span class="line">            handlePossibleCancellationInterrupt(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥çœ‹çœ‹æ³¨é‡Šä¸­çš„ç¬¬ <code>3</code> æ­¥ï¼Œ è°ƒç”¨å®Œæˆä¹‹åè®¾ç½®ç»“æœ</p>
<h3 id="set-V-v-æ–¹æ³•"><a href="#set-V-v-æ–¹æ³•" class="headerlink" title="set(V v) æ–¹æ³•"></a>set(V v) æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(V v)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (STATE.compareAndSet(<span class="built_in">this</span>, NEW, COMPLETING)) &#123;</span><br><span class="line">        <span class="comment">// 1. å°†æ‰§è¡Œçš„ç»“æœèµ‹å€¼ç»™ outcome</span></span><br><span class="line">        outcome = v;</span><br><span class="line">        STATE.setRelease(<span class="built_in">this</span>, NORMAL); <span class="comment">// final state</span></span><br><span class="line">        <span class="comment">// 2. é€šçŸ¥é˜»å¡çš„çº¿ç¨‹ï¼ˆå”¤é†’ï¼‰</span></span><br><span class="line">        finishCompletion();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°†ç»“æœèµ‹å€¼ç»™ <code>outcome</code> å±æ€§ä¹‹åï¼Œè¿˜è°ƒç”¨äº† <code>finishCompletion()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¸ªå…¶å®å°±æ˜¯ <strong>ç”Ÿäº§è€…æ¶ˆè´¹è€…</strong> æ¨¡å‹çš„åº”ç”¨</p>
<h2 id="Future-ä¸­ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"><a href="#Future-ä¸­ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹" class="headerlink" title="Future ä¸­ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"></a>Future ä¸­ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</h2><ol>
<li>è°ƒç”¨ <code>Future.get()</code> æ–¹æ³•è‹¥çº¿ç¨‹è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæˆï¼Œä¸»çº¿ç¨‹ä¼š <strong>é˜»å¡</strong>ï¼Œå½“ä»»åŠ¡å®Œæˆåä¼šä»»åŠ¡ç±»ä¸­ä¼š <strong>å”¤é†’</strong> é˜»å¡çš„çº¿ç¨‹</li>
<li>é˜»å¡æ˜¯é˜»å¡åœ¨ <code>get()</code> æ–¹æ³•ï¼Œé‚£å”¤é†’å‘¢ï¼Ÿ å…¶å®å°±æ˜¯ä¸Šé¢çš„ <code>finishCompletion()</code> çŸ¥é“äº†æ–¹æ³•çš„ä½œç”¨ä¹‹åï¼Œæˆ‘ä»¬å†çœ‹çœ‹çœ‹ <code>get()</code> æ–¹æ³•å’Œ <code>finishCompletion()</code> æ–¹æ³•</li>
</ol>
<h3 id="get-æ–¹æ³•"><a href="#get-æ–¹æ³•" class="headerlink" title="get() æ–¹æ³•"></a>get() æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> state;</span><br><span class="line">    <span class="comment">// å…ˆè·å–ä»»åŠ¡çŠ¶æ€ï¼Œä»»åŠ¡æ²¡æœ‰å®Œæˆï¼Œå°±è¿›è¡Œé˜»å¡ç­‰å¾…</span></span><br><span class="line">    <span class="keyword">if</span> (s &lt;= COMPLETING)</span><br><span class="line">        s = awaitDone(<span class="literal">false</span>, <span class="number">0L</span>);</span><br><span class="line">    <span class="keyword">return</span> report(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é˜»å¡ç­‰å¾…æ˜¯è°ƒç”¨çš„ <code>awaitDone()</code> æ–¹æ³•, è¿˜æ˜¯å…ˆæ€»ç»“ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å†çœ‹æºç </p>
<ol>
<li>ä»»åŠ¡æœªå®Œæˆæ—¶ï¼Œå°†å½“å‰çº¿ç¨‹å°è£…æˆä¸€ä¸ª <code>WaitNode</code> å¯¹è±¡ï¼Œæ·»åŠ åˆ° <code>WaitNode waiters</code> æ•°å±æ€§çš„åé¢</li>
<li>ä¿å­˜åˆ°ç­‰å¾…é“¾è¡¨ä¹‹åï¼Œå°±ä½¿ç”¨ <code>LockSupport.park(this)</code> æ¥é˜»å¡å½“å‰çº¿ç¨‹</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">awaitDone</span><span class="params">(<span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> <span class="number">0L</span>;    <span class="comment">// Special value 0L means not yet parked</span></span><br><span class="line">    <span class="type">WaitNode</span> <span class="variable">q</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">queued</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> state;</span><br><span class="line">        <span class="keyword">if</span> (s &gt; COMPLETING) &#123;</span><br><span class="line">            <span class="keyword">if</span> (q != <span class="literal">null</span>)</span><br><span class="line">                q.thread = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s == COMPLETING)</span><br><span class="line">            Thread.<span class="keyword">yield</span>();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            removeWaiter(q);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (q == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="number">0L</span>)</span><br><span class="line">                <span class="keyword">return</span> s;</span><br><span class="line">            <span class="comment">// ç”±å½“å‰çº¿ç¨‹æ„æˆä¸€ä¸ª WaitNode å¯¹è±¡</span></span><br><span class="line">            q = <span class="keyword">new</span> <span class="title class_">WaitNode</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!queued)</span><br><span class="line">            <span class="comment">// å°†æ„é€ çš„ waitNode å¯¹è±¡æ·»åŠ åˆ° waiters é“¾è¡¨ä¸­ã€å¯èƒ½æœ‰äººæœ‰ç‚¹ç–‘æƒ‘ï¼Œè¿™ä¸¤ä¸ªé€»è¾‘å¤„åœ¨ä¸åŒ else if æ¡ä»¶ä¸­ï¼Œä¸ºä»€ä¹ˆä¼šåŒæ—¶æ‰§è¡Œåˆ°ï¼Œå…¶å®è¿™é‡Œä¸æ˜¯åŒæ—¶æ‰§è¡Œåˆ°ï¼Œè€Œæ˜¯ä¸²è¡Œçš„ï¼Œå› ä¸ºè¿™æ•´å—ä»£ç åœ¨ä¸€ä¸ªforå¾ªç¯ä¸­ï¼Œå‰é¢è¿›è¡Œä¸€ä¸ªelseåˆ†æ”¯åï¼Œä¸‹ä¸€æ¬¡å¾ªç¯æ¡ä»¶å°±æ”¹å˜äº†ï¼Œå¯¼è‡´è¿›å…¥åˆ°äº†ä¸åŒçš„elseåˆ†æ”¯ä¸­ã€‘</span></span><br><span class="line">            queued = WAITERS.weakCompareAndSet(<span class="built_in">this</span>, q.next = waiters, q);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (timed) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> parkNanos;</span><br><span class="line">            <span class="keyword">if</span> (startTime == <span class="number">0L</span>) &#123; <span class="comment">// first time</span></span><br><span class="line">                startTime = System.nanoTime();</span><br><span class="line">                <span class="keyword">if</span> (startTime == <span class="number">0L</span>)</span><br><span class="line">                    startTime = <span class="number">1L</span>;</span><br><span class="line">                parkNanos = nanos;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">elapsed</span> <span class="operator">=</span> System.nanoTime() - startTime;</span><br><span class="line">                <span class="keyword">if</span> (elapsed &gt;= nanos) &#123;</span><br><span class="line">                    removeWaiter(q);</span><br><span class="line">                    <span class="keyword">return</span> state;</span><br><span class="line">                &#125;</span><br><span class="line">                parkNanos = nanos - elapsed;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (state &lt; COMPLETING)</span><br><span class="line">                LockSupport.parkNanos(<span class="built_in">this</span>, parkNanos);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// é˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="finishCompletion-æ–¹æ³•"><a href="#finishCompletion-æ–¹æ³•" class="headerlink" title="finishCompletion() æ–¹æ³•"></a><code>finishCompletion()</code> æ–¹æ³•</h3><p>çœ‹å®Œäº† <code>get()</code> é˜»å¡æ–¹æ³•ï¼Œå°±å¯ä»¥æ¥çœ‹çœ‹å”¤é†’é˜»å¡çš„çº¿ç¨‹æ–¹æ³• <code>finishCompletion()</code> äº†, åŒæ ·çš„å…ˆç®€å•æ€»ç»“ä¸€ä¸‹è¯¥æ–¹æ³•åšçš„äº‹æƒ…</p>
<ol>
<li>éå† <code>waiters</code> ä»é‡Œé¢è·å–é˜»å¡çš„çº¿ç¨‹</li>
<li>è·å–åˆ°é˜»å¡çš„çº¿ç¨‹ä¹‹åï¼Œè°ƒç”¨ <code>LockSupport.unpark(thread)</code> æ¥å”¤é†’å¯¹åº”çš„çº¿ç¨‹<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">finishCompletion</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (WaitNode q; (q = waiters) != <span class="literal">null</span>;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (WAITERS.weakCompareAndSet(<span class="built_in">this</span>, q, <span class="literal">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> q.thread;</span><br><span class="line">                <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">                    q.thread = <span class="literal">null</span>;</span><br><span class="line">                    <span class="comment">// å”¤é†’çº¿ç¨‹</span></span><br><span class="line">                    LockSupport.unpark(t);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">WaitNode</span> <span class="variable">next</span> <span class="operator">=</span> q.next;</span><br><span class="line">                <span class="keyword">if</span> (next == <span class="literal">null</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                q.next = <span class="literal">null</span>; <span class="comment">// unlink to help gc</span></span><br><span class="line">                q = next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    done();</span><br><span class="line">    callable = <span class="literal">null</span>;        <span class="comment">// to reduce footprint</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>Semaphoreä½¿ç”¨å’ŒåŸç†</title>
    <url>/2023/1dbf4f386c66/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p><code>Semaphore</code> çš„ä¸»è¦åŠŸèƒ½æ˜¯ç”¨æ¥é™åˆ¶å¯¹æŸä¸ªèµ„æºåŒæ—¶è®¿é—®çš„çº¿ç¨‹æ•°é‡ï¼Œå®ƒæœ‰ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•</p>
<ol>
<li><code>acquire()</code>ï¼šè·å–ä¸€ä¸ªè®¸å¯ï¼Œå¦‚æœæ²¡æœ‰å°±é˜»å¡</li>
<li><code>release()</code>ï¼šé‡Šæ”¾ä¸€ä¸ªè®¸å¯ ç„¶åå”¤é†’ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹</li>
</ol>
<h2 id="Semaphore-å¸¸ç”¨æ–¹æ³•"><a href="#Semaphore-å¸¸ç”¨æ–¹æ³•" class="headerlink" title="Semaphore å¸¸ç”¨æ–¹æ³•"></a>Semaphore å¸¸ç”¨æ–¹æ³•</h2><ol>
<li><code>Semaphore(permits,fair)</code>ï¼Œ<code>permits</code> è¡¨ç¤ºä»¤ç‰Œæ•°ï¼Œ<code>fair</code> è¡¨ç¤ºå…¬å¹³æ€§</li>
<li><code>acquire(permits)</code>ï¼Œè·å–æŒ‡å®š <code>permits</code> æ•°é‡çš„ä»¤ç‰Œï¼Œå¦‚æœè®¸å¯è¯æ•°é‡ä¸è¶³ï¼Œåˆ™ä¼šé˜»å¡å½“å‰çº¿ç¨‹</li>
<li><code>tryAcquire(permits)</code>ï¼Œå°è¯•è·å–æŒ‡å®š <code>permits</code> æ•°é‡çš„ä»¤ç‰Œï¼Œæ­¤è¿‡ç¨‹æ˜¯éé˜»å¡çš„ï¼Œå¦‚æœä»¤ç‰Œæ•°ä¸å¤Ÿï¼Œåˆ™è¿”å› <code>false</code>ï¼Œå¦åˆ™è¿”å› <code>true</code></li>
<li><code>release(permits)</code>ï¼Œé‡Šæ”¾æŒ‡å®š <code>permits</code> æ•°é‡çš„ä»¤ç‰Œ</li>
<li><code>drainPermits()</code>ï¼Œå½“å‰çº¿ç¨‹è·å¾—å‰©ä¸‹çš„æ‰€æœ‰å¯ç”¨ä»¤ç‰Œã€‚</li>
<li><code>hasQueuedThread()</code>ï¼Œåˆ¤æ–­å½“å‰ <code>Semaphore</code> å®ä¾‹ä¸Šæ˜¯å¦å­˜åœ¨æ­£åœ¨ç­‰å¾…ä»¤ç‰Œçš„çº¿ç¨‹ã€‚</li>
</ol>
<h2 id="Semaphoreçš„ä½¿ç”¨åŸç†å›¾"><a href="#Semaphoreçš„ä½¿ç”¨åŸç†å›¾" class="headerlink" title="Semaphoreçš„ä½¿ç”¨åŸç†å›¾"></a>Semaphoreçš„ä½¿ç”¨åŸç†å›¾</h2><pre class="mermaid">flowchart TB
    subgraph A["Threads"]
        direction LR
        A1["thread"]
        A2["thread"]
        A3["......"]
        A4["thread"]
        A1~~~A2~~~A3~~~A4
    end
    subgraph B["Semaphore"]
        B1["1 (permits=2)"]
        B2["2 (permits=2)"]
        B1~~~B2
    end
    C[resources]
    A--"acquire()"-->B
    A--"acquire()"-->B
    A--"......"-->B
    A--"acquire()"-->B
    B--"åŒæ—¶åªå…è®¸ä¸¤ä¸ªçº¿ç¨‹è®¿é—®"-->C
    B--"åŒæ—¶åªå…è®¸ä¸¤ä¸ªçº¿ç¨‹è®¿é—®"-->C</pre>

<h2 id="Semaphoreçš„ä½¿ç”¨åœºæ™¯"><a href="#Semaphoreçš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="Semaphoreçš„ä½¿ç”¨åœºæ™¯"></a>Semaphoreçš„ä½¿ç”¨åœºæ™¯</h2><ol>
<li>é™æµï¼Œé™åˆ¶åŒæ—¶è®¿é—®æŸä¸ªèµ„æºçš„çº¿ç¨‹æ•°é‡</li>
<li>å¹¶å‘æ§åˆ¶ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥æ± ï¼Œé™åˆ¶åŒæ—¶è®¿é—®æ•°æ®åº“çš„çº¿ç¨‹æ•°é‡</li>
<li>ä¿¡å·é‡ï¼Œç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®æŸä¸ªèµ„æºçš„çº¿ç¨‹æ•°é‡</li>
</ol>
<h2 id="Semaphore-ä½¿ç”¨æ¡ˆä¾‹"><a href="#Semaphore-ä½¿ç”¨æ¡ˆä¾‹" class="headerlink" title="Semaphore ä½¿ç”¨æ¡ˆä¾‹"></a>Semaphore ä½¿ç”¨æ¡ˆä¾‹</h2><p>å¦‚ä¸‹ä»£ç ï¼Œåˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæäº¤äº†20ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡ä¸­éƒ½ç­‰å¾…1sï¼Œæ¨¡æ‹Ÿæ–¹æ³•è°ƒç”¨è€—æ—¶ï¼Œæ­£å¸¸æ¥è¯´å¯ä»¥20ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œä½†æ˜¯ç°åœ¨åªå…è®¸2ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œå¯ä»¥çœ‹åˆ°æ‰“å°çš„ç»“æœæ˜¯2ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œå‰©ä¸‹çš„ä»»åŠ¡éƒ½è¢«é˜»å¡äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestSemaphore</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        <span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            executorService.submit(<span class="keyword">new</span> <span class="title class_">SemaphoreThread</span>(semaphore));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SemaphoreThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Semaphore semaphore;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SemaphoreThread</span><span class="params">(Semaphore semaphore)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.semaphore = semaphore;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                semaphore.acquire();</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; è¿›å…¥&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; ç¦»å¼€&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                semaphore.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœï¼š</p>
<figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line">pool<span class="string">-1</span>-thread<span class="string">-4</span> è¿›å…¥</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-1</span> è¿›å…¥</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-1</span> ç¦»å¼€</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-4</span> ç¦»å¼€</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-3</span> è¿›å…¥</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-8</span> è¿›å…¥</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-3</span> ç¦»å¼€</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-7</span> è¿›å…¥</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-8</span> ç¦»å¼€</span><br><span class="line">â€¦â€¦</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æœ€å¤šå…è®¸ä¸¤ä¸ªçº¿ç¨‹è¿›å…¥æ‰§è¡Œï¼Œå‰©ä¸‹çš„çº¿ç¨‹éƒ½è¢«é˜»å¡äº†ã€‚</p>
<h2 id="Semaphore-å®ç°åŸç†"><a href="#Semaphore-å®ç°åŸç†" class="headerlink" title="Semaphore å®ç°åŸç†"></a>Semaphore å®ç°åŸç†</h2><ol>
<li><code>Semaphore</code> å®é™…ä¸Šä¹Ÿæ˜¯åŸºäº <code>AQS</code> ä¸­çš„å…±äº«é”æ¥å®ç°çš„</li>
<li>åœ¨ <code>Semaphore</code> ä¸­å…è®¸å¤šä¸ªçº¿ç¨‹è·å¾—ä»¤ç‰Œè¢«å”¤é†’<br>ä»¥ä¸‹é¢ä»£ç ä¸ºä¾‹</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  ä½¿ç”¨éƒ¨åˆ†</span></span><br><span class="line"><span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">2</span>);</span><br><span class="line">semaphore.acquire();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æºç éƒ¨åˆ†ï¼Œ new Semaphore å®é™…åˆ›å»ºäº†ä¸€ä¸ª NonfairSync ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Semaphore</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123;</span><br><span class="line">    sync = <span class="keyword">new</span> <span class="title class_">NonfairSync</span>(<span class="keyword">permits</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">2694183684443567898L</span>;</span><br><span class="line"></span><br><span class="line">    NonfairSync(<span class="type">int</span> <span class="keyword">permits</span>) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œå®é™…æ˜¯è®¾ç½® AQS çš„ state å˜é‡çš„å€¼</span></span><br><span class="line">        <span class="built_in">super</span>(<span class="keyword">permits</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯é‡å†™äº†è·å–éå…±äº«é”çš„é€»è¾‘</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nonfairTryAcquireShared(acquires);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Sync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1192457210091910933L</span>;</span><br><span class="line"></span><br><span class="line">    Sync(<span class="type">int</span> <span class="keyword">permits</span>) &#123;</span><br><span class="line">        setState(<span class="keyword">permits</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getPermits</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getState();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  è·å–éå…±äº«é”å®é™…å°±æ˜¯è·å– AQS ä¸­å˜é‡çš„å€¼ï¼Œç„¶åå‡å»æ­¤æ¬¡éœ€è¦è·å–åˆ°  permits æ•°é‡ï¼Œ å¦‚æœè¿™ä¸ªæ•°é‡&lt;0 ä»£è¡¨è·å–ä»¤ç‰Œå¤±è´¥</span></span><br><span class="line">    <span class="comment">//  å¦åˆ™å°±æ˜¯è®¾ç½®ä»¤ç‰ŒæˆåŠŸï¼ŒåŒæ—¶å°†å‰©ä½™ä»¤ç‰Œæ•°é‡ä½¿ç”¨ cas æ–¹å¼æ›´æ–°çš„ state å˜é‡ä¸­</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">nonfairTryAcquireShared</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">available</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="type">int</span> <span class="variable">remaining</span> <span class="operator">=</span> available - acquires;</span><br><span class="line">            <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> ||</span><br><span class="line">                compareAndSetState(available, remaining))</span><br><span class="line">                <span class="keyword">return</span> remaining;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  è¯¥æ–¹æ³•æ˜¯é‡Šæ”¾ä»¤ç‰Œçš„é€»è¾‘ï¼Œå’Œè·å–é”æ˜¯ç±»ä¼¼çš„ï¼Œä¹Ÿæ˜¯å…ˆè·å– AQS ä¸­ state å˜é‡çš„å€¼ï¼Œç„¶ååŠ ä¸Šé‡Šæ”¾çš„ä»¤ç‰Œæ•°é‡</span></span><br><span class="line">    <span class="comment">//  ç„¶åå†ä½¿ç”¨ cas æ–¹å¼æ›´æ–° state å˜é‡çš„å€¼å³å¯</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryReleaseShared</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> current + releases;</span><br><span class="line">            <span class="keyword">if</span> (next &lt; current) <span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum permit count exceeded&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(current, next))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>ThreadLocalçš„ä½¿ç”¨å’ŒåŸç†</title>
    <url>/2023/15c7fbcaf228/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="ThreadLocalçš„ä½¿ç”¨åœºæ™¯"><a href="#ThreadLocalçš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="ThreadLocalçš„ä½¿ç”¨åœºæ™¯"></a>ThreadLocalçš„ä½¿ç”¨åœºæ™¯</h2><ul>
<li>è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå› ä¸º <code>ThreadLocal</code> å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª <code>ThreadLocalMap</code>ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥å°†è‡ªå·±çš„å˜é‡å­˜å‚¨åˆ° <code>ThreadLocalMap</code> ä¸­ï¼Œä»è€Œå®ç°äº†çº¿ç¨‹é—´çš„å˜é‡å…±äº«ã€‚</li>
<li>è§£å†³èµ„æºå…±äº«é—®é¢˜</li>
<li>è§£å†³çº¿ç¨‹é—´æ•°æ®ä¼ é€’é—®é¢˜</li>
</ul>
<h2 id="2-ThreadLocalçš„ä½¿ç”¨"><a href="#2-ThreadLocalçš„ä½¿ç”¨" class="headerlink" title="2. ThreadLocalçš„ä½¿ç”¨"></a>2. ThreadLocalçš„ä½¿ç”¨</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalDemo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;Integer&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            threadLocal.set(<span class="number">100</span>);</span><br><span class="line">            System.out.println(threadLocal.get());</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            threadLocal.set(<span class="number">200</span>);</span><br><span class="line">            System.out.println(threadLocal.get());</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç ä¸­å®šä¹‰çš„ <code>threadLocal</code> æ˜¯ä¸€ä¸ªé™æ€å˜é‡ï¼Œå¹¶ä¸”ä¸¤ä¸ªçº¿ç¨‹éƒ½ä½¿ç”¨äº†ï¼Œä½†æ˜¯ä¸åŒçº¿ç¨‹ä¸­ä½¿ç”¨çš„ <code>threadLocal</code> è¿›è¡Œ <code>set</code> å’Œ <code>get</code> çš„éƒ½æ˜¯å¯¹åº”çº¿ç¨‹çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹æ“ä½œ <code>threadLocal</code> ä¸ä¼šå½±å“åˆ°å½“å‰çº¿ç¨‹çš„å€¼ã€‚</p>
<h2 id="ThreadLocal-ç›¸å…³å¯¹è±¡çš„å…³è”å…³ç³»"><a href="#ThreadLocal-ç›¸å…³å¯¹è±¡çš„å…³è”å…³ç³»" class="headerlink" title="ThreadLocal ç›¸å…³å¯¹è±¡çš„å…³è”å…³ç³»"></a>ThreadLocal ç›¸å…³å¯¹è±¡çš„å…³è”å…³ç³»</h2><pre class="mermaid">graph LR
    subgraph A[" Thread å¯¹è±¡"]
        subgraph B1["ThreadLocalMap æˆå‘˜å˜é‡"]
            subgraph C["Entry å¯¹è±¡"]
                C1["key å¼•ç”¨"]
                C2["value å¼•ç”¨"]
            end
        end
    end
    B["ThreadLocal å¯¹è±¡"]
    C1-. "è™šå¼•ç”¨" .->B
    C2--"å¼ºå¼•ç”¨"-->D
    D["value å€¼"]</pre>

<p>æ ¹æ®ä¸Šè¿°å¯¹è±¡å…³è”å›¾æˆ‘ä»¬å†æ¥çœ‹çœ‹ <code>ThreadLocal</code> æºç </p>
<h2 id="ThreadLocal-æºç "><a href="#ThreadLocal-æºç " class="headerlink" title="ThreadLocal æºç "></a>ThreadLocal æºç </h2><p>ä»ä¸Šé¢ ThreadLocal çš„ä½¿ç”¨ç¤ºä¾‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ¶‰åŠçš„å‡ ä¸ªé‡è¦çš„æ–¹æ³•å¦‚ä¸‹</p>
<ol>
<li>new ThreadLocal()</li>
<li>ThreadLocal.set()</li>
<li>ThreadLocal.get()</li>
<li>ThreadLocal.remove()</li>
</ol>
<p>å…ˆçœ‹åˆ›å»º set æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">        <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">            map.set(<span class="built_in">this</span>, value);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ç¬¬ä¸€æ¬¡ä½¿ç”¨æ˜¯èµ°è¿™ä¸ªåˆ†æ”¯ï¼Œåˆ›å»º ThreadLocalMap å¯¹è±¡</span></span><br><span class="line">            createMap(t, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ Thread å¯¹è±¡ï¼Œè¿™é‡Œæ˜¯å°† åˆ›å»ºçš„ ThreadLocalMap å¯¹è±¡èµ‹å€¼ç»™ Thread å¯¹è±¡ä¸­çš„ threadLocals å±æ€§</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">(Thread t, T firstValue)</span> &#123;</span><br><span class="line">        t.threadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(<span class="built_in">this</span>, firstValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥å†çœ‹çœ‹åˆ›å»º ThreadLocalMap æ–¹æ³•, ä»ä¸Šé¢å¯¹è±¡å…³è”å›¾å¯çŸ¥ï¼ŒThreadLocalMap ç±»æ˜¯ ThreadLocal çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼ŒEntry åˆæ˜¯ä¸€ä¸ª ThreadLocalMap çš„ä¸€ä¸ªå†…éƒ¨ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalMap</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Entry[] table;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         Entry æœ‰ä¸¤ä¸ªå±æ€§ï¼Œä¸€ä¸ªç”¨æ¥å­˜å‚¨ key, ä¸€ä¸ªç”¨æ¥å­˜å‚¨ value,è¿™ä¸ªkeyå°±æ˜¯ ThreadLocal å¯¹è±¡ï¼Œ</span></span><br><span class="line"><span class="comment">         value å°±æ˜¯ ThreadLocal å¯¹è±¡ä¸­å­˜å‚¨çš„å€¼, ä»ä¸‹é¢çœ‹ Entry ä¸­åªæœ‰ä¸€ä¸ª value å±æ€§ï¼Œ</span></span><br><span class="line"><span class="comment">         æ˜¯å› ä¸º Entry ç»§æ‰¿äº† WeakReferenceï¼Œ æ‰€ä»¥åœ¨çˆ¶ç±»ä¸­æœ€ç»ˆè¿˜æœ‰ä¸€ä¸ª private T referent;  å±æ€§ï¼Œkey å°±æ˜¯å­˜åœ¨è¿™ä¸ªå±æ€§ä¸­</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> <span class="keyword">extends</span> <span class="title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; &#123;</span><br><span class="line">            Object value;</span><br><span class="line"></span><br><span class="line">            Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">                <span class="built_in">super</span>(k);</span><br><span class="line">                value = v;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* åˆ›å»º ThreadLocalMap ç›¸å…³çš„é€»è¾‘ï¼Œ å…¶å®å°±æ˜¯å°† key å’Œ value ç»„åˆèµ·æ¥å˜æˆä¸€ä¸ª Entry å¯¹è±¡,</span></span><br><span class="line"><span class="comment">         ç„¶åå°†è¿™ä¸ª Entry å¯¹è±¡æ”¾åˆ°ä¸€ä¸ª ThreadLocalMap çš„æ•°ç»„ä¸­</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;</span><br><span class="line">            table = <span class="keyword">new</span> <span class="title class_">Entry</span>[INITIAL_CAPACITY];</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="number">1</span>);</span><br><span class="line">            table[i] = <span class="keyword">new</span> <span class="title class_">Entry</span>(firstKey, firstValue);</span><br><span class="line">            size = <span class="number">1</span>;</span><br><span class="line">            setThreshold(INITIAL_CAPACITY);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ThreadLocal-çš„å†…å­˜æ³„éœ²é—®é¢˜"><a href="#ThreadLocal-çš„å†…å­˜æ³„éœ²é—®é¢˜" class="headerlink" title="ThreadLocal çš„å†…å­˜æ³„éœ²é—®é¢˜"></a>ThreadLocal çš„å†…å­˜æ³„éœ²é—®é¢˜</h2><p>æ‰§è¡Œå®Œä¸‹é¢çš„ä»£ç ä¹‹åæœ‰å †ä¸­çš„ ThreadLocal æœ‰å‡ ä¸ªå¼•ç”¨å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> ThreadLocal&lt;Integer&gt; tl = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">tl.set(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>è¡¨é¢çœ‹åªæœ‰æ ˆä¸­çš„ <code>tl</code>å˜é‡æŒ‡å‘äº† <code>ThreadLocal</code> å®ä¾‹ï¼Œå…¶å®ä¸æ˜¯çš„ï¼Œä»ä¸Šé¢å¯¹è±¡å…³è”å›¾ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œ<code>Entry</code> å¯¹è±¡çš„ <code>key</code> å°±æ˜¯ä¸€ä¸ª <code>ThreadLocal</code> å®ä¾‹çš„å¼•ç”¨ï¼Œæ‰€ä»¥å³ä½¿æ ˆä¸­çš„å¼•ç”¨æ–­å¼€äº†ï¼Œä½†æ˜¯ <code>Entry</code> ä¸­çš„å¼•ç”¨è¿˜åœ¨ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ <code>Entry</code> ä¸­çš„ <code>key</code> è¦ä½¿ç”¨å¼±å¼•ç”¨çš„åŸå› ã€‚</p>
<p>å³ä½¿ <code>Entry</code> ä¸­çš„ <code>key</code> ä½¿ç”¨äº†å¼±å¼•ç”¨ï¼Œå¯ä»¥è®© <code>Key</code> è¢«å›æ”¶ï¼Œä½†æ˜¯ <code>Entry</code> ä¸­çš„ <code>value</code> æ˜¯ä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œä¾ç„¶ä¸ä¼šè¢«å›æ”¶ï¼Œè¿™ä¸ªåº”è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ</p>
<p>åœ¨ <code>ThreadLocal</code> ä¸­æä¾›äº† <code>remove()</code> æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬åœ¨ä½¿ç”¨å®Œ <code>ThreadLocal</code> ä¹‹åè°ƒç”¨ <code>remove()</code> æ–¹æ³•</p>
<h2 id="çº¿ç¨‹æ± ä½¿ç”¨-ThreadLocal-çš„å‘"><a href="#çº¿ç¨‹æ± ä½¿ç”¨-ThreadLocal-çš„å‘" class="headerlink" title="çº¿ç¨‹æ± ä½¿ç”¨ ThreadLocal çš„å‘"></a>çº¿ç¨‹æ± ä½¿ç”¨ ThreadLocal çš„å‘</h2><p>å¦‚æœåœ¨çº¿ç¨‹ä¸­ä½¿ç”¨äº† <code>ThreadLocal</code> é‚£ä¹ˆä¸€å®šè¦åœ¨ä½¿ç”¨å®Œä¹‹åï¼ˆä¹Ÿå°±æ˜¯åœ¨æ­¤æ¬¡å¤„ç†ä¸å†éœ€è¦ä» <code>ThreadLocal</code> ä¸­è°ƒç”¨ <code>get()</code> æ–¹æ³•è·å–å€¼äº†ï¼‰è°ƒç”¨ <code>remove()</code> æ–¹æ³•ï¼Œ å› ä¸ºçº¿ç¨‹æ± ä¸­çº¿ç¨‹æ˜¯å¤ç”¨çš„ï¼Œå¦‚æœæ²¡æœ‰è°ƒç”¨ <code>remove()</code> æ–¹æ³•å½“ä¸‹æ¬¡å¤ç”¨åˆ°ä¹‹å‰çš„çº¿ç¨‹æ—¶ä» <code>ThreadLocal</code> ä¸­è·å–çš„å°±å¯èƒ½æ˜¯ä¹‹å‰è®¾ç½®çš„å€¼</p>
]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>synchronizedçš„ä½œç”¨å’Œå®ç°åŸç†</title>
    <url>/2023/138a9fb1d57d/index.html</url>
    <content><![CDATA[<p>å‚è€ƒ ã€ŠJavaå¹¶å‘ç¼–ç¨‹æ·±åº¦è§£æä¸å®æˆ˜ã€‹</p>
<h2 id="ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸å®‰å…¨"><a href="#ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸å®‰å…¨" class="headerlink" title="ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸å®‰å…¨"></a>ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸å®‰å…¨</h2><p>å°±æ˜¯å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æŸä¸ªæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•æ— æ³•æŒ‰ç…§æˆ‘ä»¬é¢„æœŸçš„è¡Œä¸ºæ¥æ‰§è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬è®¤ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„</p>
<h2 id="å¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨çš„åŸå› "><a href="#å¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨çš„åŸå› " class="headerlink" title="å¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨çš„åŸå› "></a>å¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨çš„åŸå› </h2><ol>
<li>åŸå­æ€§</li>
<li>æœ‰åºæ€§</li>
<li>å¯è§æ€§</li>
</ol>
<h2 id="åŸå­æ€§é—®é¢˜"><a href="#åŸå­æ€§é—®é¢˜" class="headerlink" title="åŸå­æ€§é—®é¢˜"></a>åŸå­æ€§é—®é¢˜</h2><blockquote>
<p>åŸå­æ€§æ˜¯æŒ‡ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡ä»¤æ“ä½œåœ¨CPUæ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­</p>
</blockquote>
<h3 id="åŸå­æ€§é—®é¢˜çš„æœ¬è´¨"><a href="#åŸå­æ€§é—®é¢˜çš„æœ¬è´¨" class="headerlink" title="åŸå­æ€§é—®é¢˜çš„æœ¬è´¨"></a>åŸå­æ€§é—®é¢˜çš„æœ¬è´¨</h3><ol>
<li><code>cpu</code> æ—¶é—´ç‰‡åˆ‡æ¢</li>
<li>æ‰§è¡ŒæŒ‡ä»¤çš„åŸå­æ€§ï¼Œå³çº¿ç¨‹è¿è¡Œçš„ç¨‹åºæˆ–æŒ‡ä»¤æ˜¯å¦å…·å¤‡åŸå­æ€§</li>
</ol>
<h3 id="åŸå­æ€§é—®é¢˜çš„è§£å†³"><a href="#åŸå­æ€§é—®é¢˜çš„è§£å†³" class="headerlink" title="åŸå­æ€§é—®é¢˜çš„è§£å†³"></a>åŸå­æ€§é—®é¢˜çš„è§£å†³</h3><ol>
<li>ä¸å…è®¸å½“å‰éåŸå­æŒ‡ä»¤åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«ä¸­æ–­ã€‚æ¯”å¦‚ä¿è¯ <code>i++</code> æ“ä½œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å­˜åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
<li>å¤šçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œå¯¼è‡´çš„åŸå­æ€§é—®é¢˜å¯ä»¥é€šè¿‡äº’æ–¥æ¡ä»¶æ¥å®ç°ä¸²è¡Œæ‰§è¡Œ</li>
</ol>
<h2 id="åŒæ­¥é”ä¹‹-synchronized"><a href="#åŒæ­¥é”ä¹‹-synchronized" class="headerlink" title="åŒæ­¥é”ä¹‹ synchronized"></a>åŒæ­¥é”ä¹‹ synchronized</h2><h3 id="synchronized-å…³é”®å­—çš„ä½œç”¨"><a href="#synchronized-å…³é”®å­—çš„ä½œç”¨" class="headerlink" title="synchronized å…³é”®å­—çš„ä½œç”¨"></a>synchronized å…³é”®å­—çš„ä½œç”¨</h3><ol>
<li>ä½œç”¨åœ¨æ–¹æ³•çº§åˆ«ï¼šé”å®šçš„æ˜¯å½“å‰ <code>class</code></li>
<li>ä½œç”¨åœ¨ä»£ç å—ï¼šé”å®šæŸä¸ªå¯¹è±¡å®ä¾‹</li>
</ol>
<h3 id="synchronized-éœ€è¦å®ç°çš„åŠŸèƒ½"><a href="#synchronized-éœ€è¦å®ç°çš„åŠŸèƒ½" class="headerlink" title="synchronized éœ€è¦å®ç°çš„åŠŸèƒ½"></a>synchronized éœ€è¦å®ç°çš„åŠŸèƒ½</h3><ol>
<li><code>synchronized</code> æ˜¯åŒæ­¥æ’ä»–é”ï¼Œè¦æƒ³è¾¾åˆ°æ’ä»–ï¼Œå°±éœ€è¦å¤šä¸ªçº¿ç¨‹æŠ¢å¤ºåŒä¸€ä¸ªèµ„æº</li>
<li>åŒä¸€ä¸ªæ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŠ¢åˆ°é”ï¼Œå…¶ä»–æ²¡æœ‰æŠ¢åˆ°é”çš„çº¿ç¨‹å°±éœ€è¦ç­‰å¾…</li>
<li>å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ä¸èƒ½ä¸€ç›´å ç”¨ <code>cpu</code>, æ‰€ä»¥éœ€è¦é˜»å¡èµ·æ¥ï¼Œå¹¶ä¸”é‡Šæ”¾ <code>cpu</code> èµ„æº</li>
<li>å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è¢«é˜»å¡ï¼Œå°±è¿˜éœ€è¦ä¸€ä¸ªå®¹å™¨æ¥å­˜å‚¨è¿™äº›è¢«é˜»å¡çš„çº¿ç¨‹ï¼Œå½“è·å¾—é”çš„çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡å¹¶é‡Šæ”¾é”ä¹‹åï¼Œå°±éœ€è¦ä»å®¹å™¨ä¸­å”¤é†’é˜»å¡çš„çº¿ç¨‹ï¼Œè¢«å”¤é†’çš„çº¿ç¨‹å†æ¬¡å°è¯•è·å–é”</li>
</ol>
<h3 id="synchronized-ä¹‹é”èµ„æº"><a href="#synchronized-ä¹‹é”èµ„æº" class="headerlink" title="synchronized ä¹‹é”èµ„æº"></a>synchronized ä¹‹é”èµ„æº</h3><p>å‰é¢è®²åˆ° <code>synchronized</code> å¯ä»¥ä¿®é¥°æ–¹æ³•å’Œä¿®é¥°ä»£ç å—</p>
<ol>
<li>ä¿®é¥°æ–¹æ³•æ—¶ï¼Œå¯¹åº”çš„èµ„æºå°±æ˜¯å½“å‰ <code>class</code> ï¼ˆé™æ€æ–¹æ³•ï¼‰æˆ–å½“å‰å¯¹è±¡å®ä¾‹</li>
<li>ä¿®é¥°ä»£ç å—æ—¶ï¼Œæ˜¯ <code>synchronized(lock)</code> ä¸­çš„ <code>lock</code> å°±æ˜¯èµ„æº</li>
</ol>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœå¤šä¸ªçº¿ç¨‹è®¿é—®å¤šä¸ªé”èµ„æºï¼Œå°±ä¸å­˜åœ¨ç«äº‰å…³ç³»ï¼Œä¹Ÿå°±è¾¾ä¸åˆ°äº’æ–¥çš„æ•ˆæœ</strong></p>
<h3 id="æŠ¢åˆ°é”çš„æ ‡è®°ä¹‹-Mark-Word"><a href="#æŠ¢åˆ°é”çš„æ ‡è®°ä¹‹-Mark-Word" class="headerlink" title="æŠ¢åˆ°é”çš„æ ‡è®°ä¹‹ Mark Word"></a>æŠ¢åˆ°é”çš„æ ‡è®°ä¹‹ Mark Word</h3><p>å‰é¢è®²åˆ° <strong>åŒä¸€ä¸ªæ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŠ¢åˆ°é”</strong>ï¼Œ å¯¹äºæŠ¢åˆ°é”çš„çº¿ç¨‹å°±éœ€è¦è¿›è¡Œæ ‡è®°åˆ°åº•æ˜¯é‚£ä¸ªçº¿ç¨‹æŠ¢åˆ°äº†é”ï¼Œè¿™ä¸ªæ ‡è®°å°±æ˜¯å­˜å‚¨åœ¨<strong>å¯¹è±¡å¤´</strong>ä¸­çš„</p>
<h4 id="java-å¯¹è±¡å­˜å‚¨ç»“æ„"><a href="#java-å¯¹è±¡å­˜å‚¨ç»“æ„" class="headerlink" title="java å¯¹è±¡å­˜å‚¨ç»“æ„"></a>java å¯¹è±¡å­˜å‚¨ç»“æ„</h4><p><code>java</code> å¯¹è±¡å­˜å‚¨ç»“æ„åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†</p>
<ol>
<li>å¯¹è±¡å¤´</li>
<li>å®ä¾‹æ•°æ®</li>
<li>å¯¹å…¶å¡«å……</li>
</ol>
<p>æ¯”å¦‚åˆ›å»ºä¸€ä¸ªå¯¹è±¡ <code>Object lock = new Object();</code>ï¼Œ åœ¨å †ä¸­ <code>lock</code> å®ä¾‹æœ€ç»ˆçš„å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311282221986.webp" alt="å¯¹è±¡å­˜å‚¨ç»“æ„"></p>
<h4 id="å¯¹è±¡å¤´"><a href="#å¯¹è±¡å¤´" class="headerlink" title="å¯¹è±¡å¤´"></a>å¯¹è±¡å¤´</h4><p>å¯¹è±¡å¤´åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†</p>
<ol>
<li><code>Mark Word</code></li>
<li><code>Klass Pointer</code></li>
<li><code>Lenght</code></li>
</ol>
<p><strong>Mark Word</strong><br><code>Mark Word</code> è®°å½•äº†ä¸å¯¹è±¡å’Œé”ç›¸å…³çš„ä¿¡æ¯ï¼Œå½“è¿™ä¸ªå¯¹è±¡ä½œä¸ºé”å¯¹è±¡æ¥å®ç°<code>synchronized</code> çš„åŒæ­¥æ“ä½œæ—¶ï¼Œé”æ ‡è®°å’Œç›¸å…³ä¿¡æ¯éƒ½æ˜¯å­˜å‚¨åœ¨ <code>Mark Word</code>ä¸­çš„</p>
<div class="tabs" id="mark-wordå­˜å‚¨ç»“æ„"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="mark-wordå­˜å‚¨ç»“æ„-1">32ä½Mark</button><button type="button" class="tab " data-href="mark-wordå­˜å‚¨ç»“æ„-2">64ä½Mark Wordå­˜å‚¨ç»“æ„</button></ul><div class="tab-contents"><div class="tab-item-content active" id="mark-wordå­˜å‚¨ç»“æ„-1"><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311282227201.webp" alt="32ä½Mark Wordå­˜å‚¨ç»“æ„"></p></div><div class="tab-item-content" id="mark-wordå­˜å‚¨ç»“æ„-2"><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311282225221.webp" alt="64ä½Mark Wordå­˜å‚¨ç»“æ„"></p></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<ol>
<li>ä¸ç®¡åœ¨32ä½è¿˜æ˜¯64ä½ç³»ç»Ÿä¸­ï¼Œ<code>Mark Word</code>ä¸­éƒ½ä¼šåŒ…å«<code>GC</code>åˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡è®°</li>
<li>é”çŠ¶æ€çš„å­—æ®µï¼Œå®ƒåŒ…å«äº”ç§çŠ¶æ€åˆ†åˆ«æ˜¯æ— é”ã€åå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”ã€GCæ ‡è®°</li>
<li>æ— é”å’Œåå‘é”çš„ é”æ ‡è®°ä½éƒ½æ˜¯ 01ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå•ç‹¬çš„ <code>bit</code> å­˜å‚¨ <strong>æ˜¯å¦åå‘é”</strong></li>
</ol>
<p><strong>Klass Pointer</strong><br><code>Klass Pointer</code> è®°å½•äº†å¯¹è±¡æ‰€å±çš„ <code>class</code> ä¿¡æ¯ï¼Œå½“å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œä¼šå°† <code>Klass Pointer</code> æŒ‡å‘ <code>class</code> ä¿¡æ¯</p>
<p><strong>Length</strong><br>è¡¨ç¤ºæ•°ç»„é•¿åº¦ï¼Œåªæœ‰æ„å»ºå¯¹è±¡æ•°ç»„æ—¶æ‰ä¼šæœ‰æ•°ç»„é•¿åº¦å±æ€§</p>
<h4 id="å†…å­˜ä¸­å¯¹è±¡å­˜å‚¨ç¤ºä¾‹"><a href="#å†…å­˜ä¸­å¯¹è±¡å­˜å‚¨ç¤ºä¾‹" class="headerlink" title="å†…å­˜ä¸­å¯¹è±¡å­˜å‚¨ç¤ºä¾‹"></a>å†…å­˜ä¸­å¯¹è±¡å­˜å‚¨ç¤ºä¾‹</h4><p>æ¯”å¦‚ä¸‹é¢ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MarkWordExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MarkWordExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MarkWordExample</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>jvm</code> è¿è¡Œæ—¶å†…å­˜ä¸­ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311282236608.webp" alt="å¯¹è±¡ç»“æ„ç¤ºä¾‹"></p>
<h2 id="é”å‡çº§è¿‡ç¨‹"><a href="#é”å‡çº§è¿‡ç¨‹" class="headerlink" title="é”å‡çº§è¿‡ç¨‹"></a>é”å‡çº§è¿‡ç¨‹</h2><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311282252724.webp" alt="é”å‡çº§"></p>
<div class="tabs" id="é”å‡çº§è¿‡ç¨‹"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="é”å‡çº§è¿‡ç¨‹-1">åå‘é”</button><button type="button" class="tab " data-href="é”å‡çº§è¿‡ç¨‹-2">åå‘é”çš„æ‰¹é‡é‡åå‘</button><button type="button" class="tab " data-href="é”å‡çº§è¿‡ç¨‹-3">è½»é‡çº§é”</button><button type="button" class="tab " data-href="é”å‡çº§è¿‡ç¨‹-4">é‡é‡çº§é”</button></ul><div class="tab-contents"><div class="tab-item-content active" id="é”å‡çº§è¿‡ç¨‹-1"><p>åå‘é”å…¶å®å¯ä»¥è®¤ä¸ºæ˜¯åœ¨æ²¡æœ‰å¤šçº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹è®¿é—®<code>synchronized</code>ä¿®é¥°çš„ä»£ç å—çš„åŠ é”åœºæ™¯ï¼Œä¹Ÿå°±æ˜¯åœ¨å•çº¿ç¨‹æ‰§è¡Œçš„æƒ…å†µä¸‹</p>
<p>çº¿ç¨‹åœ¨æ²¡æœ‰çº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹å»è®¿é—®synchronizedåŒæ­¥ä»£ç å—æ—¶ï¼Œä¼šå°è¯•å…ˆé€šè¿‡åå‘é”æ¥æŠ¢å è®¿é—®èµ„æ ¼ï¼Œè¿™ä¸ªæŠ¢å è¿‡ç¨‹æ˜¯åŸºäºCASæ¥å®Œæˆçš„ï¼Œå¦‚æœæŠ¢å é”æˆåŠŸï¼Œåˆ™ç›´æ¥ä¿®æ”¹å¯¹è±¡å¤´ä¸­çš„é”æ ‡è®°ã€‚å…¶ä¸­ï¼Œåå‘é”æ ‡è®°ä¸º1ï¼Œé”æ ‡è®°ä¸º01ï¼Œä»¥åŠå­˜å‚¨å½“å‰è·å¾—é”çš„çº¿ç¨‹IDã€‚è€Œåå‘çš„æ„æ€å°±æ˜¯ï¼Œå¦‚æœçº¿ç¨‹Xè·å¾—äº†åå‘é”ï¼Œé‚£ä¹ˆå½“çº¿ç¨‹Xåç»­å†è®¿é—®è¿™ä¸ªåŒæ­¥æ–¹æ³•æ—¶ï¼Œåªéœ€è¦åˆ¤æ–­å¯¹è±¡å¤´ä¸­çš„çº¿ç¨‹IDå’Œçº¿ç¨‹Xæ˜¯å¦ç›¸ç­‰å³å¯ã€‚å¦‚æœç›¸ç­‰ï¼Œå°±ä¸éœ€è¦å†æ¬¡å»æŠ¢å é”ï¼Œç›´æ¥è·å¾—è®¿é—®èµ„æ ¼å³å¯</p></div><div class="tab-item-content" id="é”å‡çº§è¿‡ç¨‹-2"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BiasedLock</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;BiasedLock&gt; locks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">BiasedLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BiasedLock</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                <span class="type">BiasedLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BiasedLock</span>();</span><br><span class="line">                <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                    locks.add(lock);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        thread.start();</span><br><span class="line">        thead.join();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">                <span class="type">BiasedLock</span> <span class="variable">lock2</span> <span class="operator">=</span> locks.get(i);</span><br><span class="line">                <span class="keyword">synchronized</span> (lock2) &#123;</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ä¸Šé¢ä»£ç åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºäº† <span class="number">100</span>ä¸ªé”å¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæˆä¹‹åï¼Œç¬¬äºŒä¸ªçº¿ç¨‹è·å– <span class="number">100</span>ä¸ªé”å¯¹è±¡ä¸­çš„å‰é¢<span class="number">20</span>ä¸ªè¿›è¡ŒåŠ é”ï¼Œè¿™æ—¶ä¼šè§¦å‘è¿™äº›é”å¯¹è±¡çš„å‡çº§è¿‡ç¨‹ï¼Œä¼šä»åå‘é”å‡çº§åˆ°è½»é‡çº§é”ï¼Œ ä½†æ˜¯å½“æ‰§è¡Œåˆ°<span class="number">20</span>å¾ªç¯åï¼Œè¿™ä¸ªé”å¯¹è±¡åˆä¼šå˜æˆåå‘é”</span><br><span class="line"></span><br><span class="line">åœ¨`JVM`ä¸­ï¼Œä»¥`class`ï¼ˆè¿™é‡ŒæŒ‡ `BiasedLock`ï¼‰ä¸ºå•ä½ï¼Œä¸ºæ¯ä¸ª`class`ç»´æŠ¤äº†ä¸€ä¸ªåå‘é”æ’¤é”€çš„è®¡æ•°å™¨ï¼Œå½“è¿™ä¸ª`class`çš„å¯¹è±¡å‘ç”Ÿåå‘æ’¤é”€æ“ä½œæ—¶ï¼Œè®¡æ•°å™¨ä¼šè¿›è¡Œç´¯åŠ ï¼Œå½“ç´¯åŠ çš„å€¼è¾¾åˆ°é‡åå‘çš„é˜ˆå€¼æ—¶ï¼Œ`JVM`ä¼šè®¤ä¸ºè¿™ä¸ª`class`çš„åå‘é”æœ‰é—®é¢˜ï¼Œéœ€è¦é‡æ–°åå‘</span><br><span class="line"></span><br><span class="line">åå‘é”æ’¤é”€å¹¶æ‰¹é‡é‡åå‘çš„è§¦å‘é˜ˆå€¼å¯ä»¥é€šè¿‡`XX:BiasedLockingBulkRebiasThreshold = <span class="number">20</span>`æ¥é…ç½®ï¼Œé»˜è®¤æ˜¯<span class="number">20</span></span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="é”å‡çº§è¿‡ç¨‹-3"><p>è½»é‡çº§é”å°±æ˜¯æ²¡æœ‰æŠ¢å åˆ°é”çš„çº¿ç¨‹ï¼Œè¿›è¡Œä¸€å®šæ¬¡æ•°çš„é‡è¯•ï¼ˆè‡ªæ—‹ï¼‰ã€‚æ¯”å¦‚çº¿ç¨‹ç¬¬ä¸€æ¬¡æ²¡æŠ¢åˆ°é”åˆ™é‡è¯•å‡ æ¬¡ï¼Œå¦‚æœåœ¨é‡è¯•çš„è¿‡ç¨‹ä¸­æŠ¢å åˆ°äº†é”ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±ä¸éœ€è¦é˜»å¡ï¼Œè¿™ç§å®ç°æ–¹å¼æˆ‘ä»¬ç§°ä¸ºè‡ªæ—‹é”</p>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311282243489.webp" alt="è½»é‡çº§é”"></p>
<p>è·å¾—è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­å¯èƒ½éœ€è¦ä¸æ–­è‡ªæ—‹æ“ä½œï¼Œè¿™ä¹Ÿæ˜¯æœ‰ä»£ä»·çš„ï¼Œæ‰€ä»¥ä¹Ÿä¸å¯èƒ½ä¸€ç›´è‡ªæ—‹ä¸‹å»</p>
<p>åœ¨<code>JDK 1.6</code>ä¸­é»˜è®¤çš„è‡ªæ—‹æ¬¡æ•°æ˜¯10æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>-XX:PreBlockSpin</code>å‚æ•°æ¥è°ƒæ•´è‡ªæ—‹æ¬¡æ•°ã€‚åŒæ—¶å¼€å‘è€…åœ¨<code>JDK 1.6</code>ä¸­è¿˜å¯¹è‡ªæ—‹é”åšäº†ä¼˜åŒ–ï¼Œå¼•å…¥äº†è‡ªé€‚åº”è‡ªæ—‹é”ï¼Œè‡ªé€‚åº”è‡ªæ—‹é”çš„è‡ªæ—‹æ¬¡æ•°ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯æ ¹æ®å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹æ¬¡æ•°åŠé”æŒæœ‰è€…çš„çŠ¶æ€æ¥å†³å®šçš„ã€‚å¦‚æœåœ¨åŒä¸€ä¸ªé”å¯¹è±¡ä¸Šï¼Œé€šè¿‡è‡ªæ—‹ç­‰å¾…æˆåŠŸè·å¾—è¿‡é”ï¼Œå¹¶ä¸”æŒæœ‰é”çš„çº¿ç¨‹æ­£åœ¨è¿è¡Œä¸­ï¼Œé‚£ä¹ˆ<code>JVM</code>ä¼šè®¤ä¸ºæ­¤æ¬¡è‡ªæ—‹ä¹Ÿæœ‰å¾ˆå¤§çš„æœºä¼šè·å¾—é”ï¼Œå› æ­¤ä¼šå°†è¿™ä¸ªçº¿ç¨‹çš„è‡ªæ—‹æ—¶é—´ç›¸å¯¹å»¶é•¿ã€‚åä¹‹ï¼Œå¦‚æœåœ¨ä¸€ä¸ªé”å¯¹è±¡ä¸­ï¼Œé€šè¿‡è‡ªæ—‹é”è·å¾—é”å¾ˆå°‘æˆåŠŸï¼Œé‚£ä¹ˆ<code>JVM</code>ä¼šç¼©çŸ­è‡ªæ—‹æ¬¡æ•°</p></div><div class="tab-item-content" id="é”å‡çº§è¿‡ç¨‹-4"><p>è½»é‡çº§é”èƒ½å¤Ÿé€šè¿‡ä¸€å®šæ¬¡æ•°çš„é‡è¯•è®©æ²¡æœ‰è·å¾—é”çš„çº¿ç¨‹æœ‰å¯èƒ½æŠ¢å åˆ°é”èµ„æºï¼Œä½†æ˜¯è½»é‡çº§é”åªæœ‰åœ¨è·å¾—é”çš„çº¿ç¨‹æŒæœ‰é”çš„æ—¶é—´è¾ƒçŸ­çš„æƒ…å†µä¸‹æ‰èƒ½èµ·åˆ°æå‡åŒæ­¥é”æ€§èƒ½çš„æ•ˆæœï¼Œå¦‚æœæ²¡æŠ¢å åˆ°é”èµ„æºçš„çº¿ç¨‹é€šè¿‡ä¸€å®šæ¬¡æ•°çš„è‡ªæ—‹åï¼Œå‘ç°ä»ç„¶æ²¡æœ‰è·å¾—é”ï¼Œå°±åªèƒ½é˜»å¡ç­‰å¾…äº†ï¼Œæ‰€ä»¥æœ€ç»ˆä¼šå‡çº§åˆ°é‡é‡çº§é”ï¼Œé€šè¿‡ç³»ç»Ÿå±‚é¢çš„äº’æ–¥é‡æ¥æŠ¢å é”èµ„æº</p></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h2 id="CASåŸç†"><a href="#CASåŸç†" class="headerlink" title="CASåŸç†"></a>CASåŸç†</h2><p>å‰é¢ä»‹ç» <code>synchronized</code> çš„ è½»é‡çº§é”å°±æ˜¯é€šè¿‡ <code>cas</code> å®ç°çš„ï¼Œ<code>cas</code> æ˜¯ä¸€ç§æ— é”ç®—æ³•ï¼Œå®ƒæ˜¯é€šè¿‡ CPU æŒ‡ä»¤å®ç°çš„ï¼Œ<code>cas</code> æŒ‡ä»¤æ˜¯ä¸€æ¡ CPU æŒ‡ä»¤ï¼Œå®ƒåŒ…å«ä¸‰ä¸ªæ“ä½œæ•°ï¼Œåˆ†åˆ«æ˜¯å†…å­˜åœ°å€ã€é¢„æœŸçš„å€¼ã€æ›´æ–°çš„å€¼ï¼Œå½“ä¸”ä»…å½“å†…å­˜åœ°å€çš„å€¼ä¸é¢„æœŸçš„å€¼ç›¸åŒæ—¶ï¼Œå°†è¯¥å€¼æ›´æ–°ä¸ºæ›´æ–°å€¼ï¼Œå¦åˆ™ä¸åšä»»ä½•æ“ä½œã€‚</p>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311282249030.webp" alt="casæ“ä½œè¿‡ç¨‹"></p>
]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>volatileè§£å†³å¯è§æ€§å’Œæœ‰åºæ€§</title>
    <url>/2023/d41d7b790ebc/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="ä»€ä¹ˆæ˜¯å¯è§æ€§"><a href="#ä»€ä¹ˆæ˜¯å¯è§æ€§" class="headerlink" title="ä»€ä¹ˆæ˜¯å¯è§æ€§"></a>ä»€ä¹ˆæ˜¯å¯è§æ€§</h2><blockquote>
<p>å¦‚æœä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªå…±äº«å˜é‡è¿›è¡Œäº†ä¿®æ”¹ï¼Œè€Œå…¶ä»–çº¿ç¨‹ä¸èƒ½åŠæ—¶åœ°è¯»å–ä¿®æ”¹ä¹‹åçš„å€¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬è®¤ä¸ºåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è¯¥å…±äº«å˜é‡å­˜åœ¨å¯è§æ€§é—®é¢˜</p>
</blockquote>
<h2 id="å¯è§æ€§é—®é¢˜çš„æ ¹æº"><a href="#å¯è§æ€§é—®é¢˜çš„æ ¹æº" class="headerlink" title="å¯è§æ€§é—®é¢˜çš„æ ¹æº"></a>å¯è§æ€§é—®é¢˜çš„æ ¹æº</h2><p><code>cpu</code> çš„é€Ÿåº¦è¿œè¿œé«˜äºå†…å­˜ï¼Œä½†æ˜¯<code>cpu</code> æ‰§è¡Œçš„æŒ‡ä»¤å’Œæ•°æ®éƒ½æ˜¯æ¥æºäºå†…å­˜ï¼Œæ‰€ä»¥åœ¨ <code>cpu</code> åœ¨ç­‰å¾…å†…å­˜çš„æ•°æ®æ—¶ï¼Œä¸€ç›´å¤„äºç©ºé—²çŠ¶æ€ï¼Œè¿™ä¸ªè¿‡ç¨‹å¾ˆæ˜¾ç„¶ä¼šå¯¼è‡´<code>CPU</code>èµ„æºçš„æµªè´¹ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼€å‘è€…åœ¨ç¡¬ä»¶è®¾å¤‡ã€æ“ä½œç³»ç»ŸåŠç¼–è¯‘å™¨å±‚é¢åšäº†å¾ˆå¤šä¼˜åŒ–</p>
<ul>
<li>åœ¨<code>CPU</code>å±‚é¢å¢åŠ äº†å¯„å­˜å™¨ï¼Œæ¥ä¿å­˜ä¸€äº›å…³é”®å˜é‡å’Œä¸´æ—¶æ•°æ®ï¼Œè¿˜å¢åŠ äº†<code>CPU</code>é«˜é€Ÿç¼“å­˜ï¼Œä»¥å‡å°‘<code>CPU</code>å’Œå†…å­˜çš„I&#x2F;Oç­‰å¾…æ—¶é—´</li>
<li>åœ¨æ“ä½œç³»ç»Ÿå±‚é¢å¼•å…¥äº†è¿›ç¨‹å’Œçº¿ç¨‹ï¼Œåœ¨å½“å‰è¿›ç¨‹æˆ–çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€æ—¶ï¼Œ<code>CPU</code>ä¼šæŠŠè‡ªå·±çš„æ—¶é—´ç‰‡åˆ†é…ç»™å…¶ä»–çº¿ç¨‹æˆ–è¿›ç¨‹ä½¿ç”¨ï¼Œä»è€Œå‡å°‘<code>CPU</code>çš„ç©ºé—²æ—¶é—´ï¼Œæœ€å¤§åŒ–åœ°æå‡<code>CPU</code>çš„ä½¿ç”¨ç‡</li>
<li>åœ¨ç¼–è¯‘å™¨å±‚é¢å¢åŠ æŒ‡ä»¤ä¼˜åŒ–ï¼Œå‡å°‘ä¸å†…å­˜çš„äº¤äº’æ¬¡æ•°</li>
</ul>
<p>ä¸Šè¿°ä¼˜åŒ–éƒ½æ˜¯ä¸ºäº†æå‡ <code>cpu</code> åˆ©ç”¨ç‡ï¼Œä½†æ˜¯è¿™äº›ä¼˜åŒ–ä¹Ÿä¼šå¯¼è‡´å¯è§æ€§é—®é¢˜</p>
<h2 id="cpu-ç¼“å­˜"><a href="#cpu-ç¼“å­˜" class="headerlink" title="cpu ç¼“å­˜"></a>cpu ç¼“å­˜</h2><h3 id="cpu-ç¼“å­˜ä¼ªå…±äº«é—®é¢˜"><a href="#cpu-ç¼“å­˜ä¼ªå…±äº«é—®é¢˜" class="headerlink" title="cpu ç¼“å­˜ä¼ªå…±äº«é—®é¢˜"></a>cpu ç¼“å­˜ä¼ªå…±äº«é—®é¢˜</h3><ol>
<li><code>cpu</code> çš„ç¼“å­˜æ˜¯ä»¥ç¼“å­˜è¡Œä¸ºå•ä½è¿›è¡Œç¼“å­˜çš„ï¼Œåœ¨ 32 ä½å’Œ 64 ä½æ¶æ„ä¸­ <code>cpu</code> ç¼“å­˜è¡Œçš„å¤§å°éƒ½æ˜¯ 64 å­—èŠ‚</li>
<li>å‡è®¾æœ‰ä¸¤ä¸ª å­—æ®µ <code>int x = 0, int y =0</code> ç°åœ¨æœ‰ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«ä¿®æ”¹ <code>x</code> å’Œ ä¿®æ”¹ <code>y</code>ï¼Œå‡è®¾è¿™ä¸¤ä¸ªçº¿ç¨‹æ˜¯åœ¨ä¸åŒçš„ <code>cpu</code> æ‰§è¡Œï¼Œé‚£ä¹ˆæ¯ä¸ª <code>cpu</code> éƒ½ä¼šåŠ è½½å¯¹åº”çš„å˜é‡åˆ°è‡ªå·±çš„ <code>cpu</code> ç¼“å­˜ä¸­ï¼Œä½†æ˜¯ <code>x</code> å’Œ <code>y</code> åŠ èµ·æ¥æ‰ 8 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå˜é‡ä¸€å®šæ˜¯åœ¨åŒä¸€ä¸ªç¼“å­˜è¡Œä¸­ï¼Œ å½“çº¿ç¨‹1ï¼ˆä¿®æ”¹ <code>x</code> çš„çº¿ç¨‹ï¼‰ä¿®æ”¹äº†<code>x</code> åï¼Œå› ä¸ºç¼“å­˜ä¸€è‡´æ€§åŸç†ï¼Œå¯¼è‡´ç¬¬äºŒä¸ª <code>cpu</code> ä¸­çš„ <code>x</code> éœ€è¦å¤±æ•ˆï¼Œé—´æ¥å¯¼è‡´ ç¬¬äºŒä¸ª <code>cpu</code> ä¸­çš„ <code>y</code> çš„ç¼“å­˜ä¹Ÿå¤±æ•ˆäº†ï¼Œè¿™å°±æ˜¯ç¼“å­˜ä¼ªå…±äº«é—®é¢˜</li>
<li>åœ¨ <code>java</code> ä¸­å¯ä»¥å¯¹å­—æ®µæˆ–ç±»æ·»åŠ  <code>@Contented</code> æ³¨è§£è®©æ¯ä¸ªå­—æ®µç‹¬è‡ªå ç”¨ä¸€ä¸ªç¼“å­˜è¡Œ</li>
</ol>
<h3 id="cpu-é«˜é€Ÿç¼“å­˜"><a href="#cpu-é«˜é€Ÿç¼“å­˜" class="headerlink" title="cpu é«˜é€Ÿç¼“å­˜"></a>cpu é«˜é€Ÿç¼“å­˜</h3><p>ç°ä»£ <code>cpu</code> ä¸€èˆ¬éƒ½æœ‰ä¸‰çº§ç¼“å­˜</p>
<ol>
<li>1ï¼Œ2 çº§ç¼“å­˜æ˜¯åœ¨ <code>cpu</code> å†…éƒ¨</li>
<li>ä¸‰çº§ç¼“å­˜æ˜¯æ‰€æœ‰ <code>cpu</code> å…±äº«</li>
<li>ä¸€çº§ç¼“å­˜åŒ…å« <code>L1D</code>ï¼ˆæ•°æ®ç¼“å­˜ï¼‰å’Œ <code>L1I</code>(æŒ‡ä»¤ç¼“å­˜)</li>
</ol>
<h3 id="ç¼“å­˜ä¸€è‡´æ€§çš„è§£å†³æ–¹æ¡ˆ"><a href="#ç¼“å­˜ä¸€è‡´æ€§çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ç¼“å­˜ä¸€è‡´æ€§çš„è§£å†³æ–¹æ¡ˆ"></a>ç¼“å­˜ä¸€è‡´æ€§çš„è§£å†³æ–¹æ¡ˆ</h3><ol>
<li>æ‰€è°“çš„ç¼“å­˜ä¸€è‡´æ€§æ˜¯æŒ‡ä¸åŒçš„çº¿ç¨‹åŠ è½½åŒä¸€ä¸ªå…±äº«å˜é‡åˆ°ä¸åŒçš„ <code>cpu</code> è¿›è¡Œä¿®æ”¹ï¼Œè¿™å°±ä¼šå¯¼è‡´ä¸åŒ <code>cpu</code> ç¼“å­˜ä¸­ç›¸åŒå˜é‡çš„ç¼“å­˜å€¼å†…å®¹ä¸åŒ</li>
<li>ä¸ºäº†è§£å†³ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ åœ¨ <code>cpu</code> å±‚é¢å¼•å…¥äº† <strong>æ€»çº¿é”</strong> å’Œ <strong>ç¼“å­˜é”æœºåˆ¶</strong></li>
</ol>
<blockquote>
<p>ä¸ºäº†è§£å†³ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼Œå¼€å‘è€…åœ¨ CPU å±‚é¢å¼•å…¥äº†æ€»çº¿é”å’Œç¼“å­˜é”æœºåˆ¶ã€‚</p>
<p>åœ¨äº†è§£é”ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸‹æ€»çº¿ã€‚æ‰€è°“çš„æ€»çº¿ï¼Œå°±æ˜¯ CPU ä¸å†…å­˜ã€è¾“å…¥&#x2F;è¾“å‡ºè®¾å¤‡ä¼ ä¸“é€’ä¿¡æ¯çš„å…¬å…±é€šé“ï¼ˆä¹Ÿå«å‰ç«¯æ€»çº¿ï¼‰ï¼Œå½“CPUè®¿é—®å†…å­˜è¿›è¡Œæ•°æ®äº¤äº’æ—¶ï¼Œå¿…é¡»ç»è¿‡æ€»çº¿æ¥ä¼ è¾“ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯æ€»çº¿é”å‘¢ï¼Ÿ</p>
<p>ç®€å•æ¥è¯´ï¼Œæ€»çº¿é”å°±æ˜¯åœ¨æ€»çº¿ä¸Šå£°æ˜ä¸€ä¸ª L0ck# ä¿¡å·ï¼Œè¿™ä¸ªä¿¡å·èƒ½å¤Ÿç¡®ä¿å…±äº«å†…å­˜åªæœ‰å½“å‰ CPU å¯ä»¥è®¿é—®ï¼Œå…¶ä»–çš„å¤„ç†å™¨è¯·æ±‚ä¼šè¢«é˜»å¡ï¼Œè¿™å°±ä½¿å¾—åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªå¤„ç†èƒ½å¤Ÿè®¿é—®å…±äº«å†…å­˜ï¼Œä»è€Œè§£å†³äº†ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ä½†æ˜¯è¿™ç§åšæ³•äº§ç”Ÿçš„ä»£ä»·æ˜¯ï¼ŒCPU çš„åˆ©ç”¨ç‡ç›´çº¿ä¸‹é™ï¼Œå¾ˆæ˜¾ç„¶è¿™æ˜¯æ— æ³•è®©äººæ¥å—çš„ï¼Œäºæ˜¯ä» P6 ç³»åˆ—çš„å¤„ç†å™¨å¼€å§‹å¢åŠ äº†ç¼“å­˜é”çš„æœºåˆ¶ã€‚</p>
<p>ç¼“å­˜é”æŒ‡çš„æ˜¯ï¼Œå¦‚æœå½“å‰ CPU è®¿é—®çš„æ•°æ®å·²ç»ç¼“å­˜åœ¨å…¶ä»– CPU çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œé‚£ä¹ˆ CPU ä¸ä¼šåœ¨æ€»çº¿ä¸Šå‘å‡º Lock# ä¿¡å·ï¼Œè€Œæ˜¯é‡‡ç”¨<strong>ç¼“å­˜ä¸€è‡´æ€§åè®®</strong>æ¥ä¿è¯å¤šä¸ª CPU çš„ç¼“å­˜ä¸€è‡´æ€§ã€‚</p>
<p>CPU æœ€ç»ˆç”¨å“ªç§é”æ¥è§£å†³ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼Œå–å†³äºå½“å‰ CPU æ˜¯å¦æ”¯æŒç¼“å­˜é”ï¼Œå¦‚æœä¸æ”¯æŒï¼Œå°±ä¼šé‡‡ç”¨æ€»çº¿é”ã€‚è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯ï¼Œå½“å‰æ“ä½œçš„æ•°æ®ä¸èƒ½è¢«ç¼“å­˜åœ¨å¤„ç†å™¨å†…éƒ¨ï¼Œæˆ–è€…æ“ä½œçš„æ•°æ®è·¨å¤šä¸ªç¼“å­˜è¡Œæ—¶ï¼Œä¹Ÿä¼šä½¿ç”¨æ€»çº¿é”ã€‚</p>
</blockquote>
<h3 id="ç¼“å­˜ä¸€è‡´æ€§åè®®"><a href="#ç¼“å­˜ä¸€è‡´æ€§åè®®" class="headerlink" title="ç¼“å­˜ä¸€è‡´æ€§åè®®"></a>ç¼“å­˜ä¸€è‡´æ€§åè®®</h3><ol>
<li>ç¼“å­˜é”é€šè¿‡ç¼“å­˜ä¸€è‡´æ€§åè®®æ¥ä¿è¯ç¼“å­˜çš„ä¸€è‡´æ€§ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯ç¼“å­˜ä¸€è‡´æ€§åè®®å‘¢</li>
<li>ä¸åŒçš„ <code>CPU</code> ç±»å‹æ”¯æŒçš„ç¼“å­˜ä¸€è‡´æ€§åè®®ä¹Ÿæœ‰åŒºåˆ«ï¼Œæ¯”å¦‚<code>MSIã€MESIã€MOSIã€MESIF</code>åè®®ç­‰ï¼Œæ¯”è¾ƒå¸¸è§çš„æ˜¯MESIï¼ˆ<code>Modified Exclusive Shared Or Invalid</code>ï¼‰åè®®</li>
</ol>
<h4 id="MESI-ç¼“å­˜ä¸€è‡´æ€§åè®®å®šä¹‰çš„-cpu-ç¼“å­˜è¡Œçš„å››ç§çŠ¶æ€"><a href="#MESI-ç¼“å­˜ä¸€è‡´æ€§åè®®å®šä¹‰çš„-cpu-ç¼“å­˜è¡Œçš„å››ç§çŠ¶æ€" class="headerlink" title="MESI ç¼“å­˜ä¸€è‡´æ€§åè®®å®šä¹‰çš„ cpu ç¼“å­˜è¡Œçš„å››ç§çŠ¶æ€"></a>MESI ç¼“å­˜ä¸€è‡´æ€§åè®®å®šä¹‰çš„ cpu ç¼“å­˜è¡Œçš„å››ç§çŠ¶æ€</h4><ol>
<li><code>M (Modified)</code>: åªæœ‰å½“å‰ <code>cpu</code> å«æœ‰æ•°æ®çš„ç¼“å­˜ï¼Œå¹¶ä¸”ç¼“å­˜æ•°æ®å·²ç»è¢«ä¿®æ”¹äº†ï¼Œå’Œä¸»å†…å­˜æ•°æ®ä¸ä¸€è‡´ </li>
<li><code>E (Exclusive)</code>: åªæœ‰å½“å‰ <code>cpu</code> å«æœ‰æ•°æ®çš„ç¼“å­˜, ç¼“å­˜è¿˜æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œå’Œä¸»å†…å­˜æ•°æ®ä¸€è‡´</li>
<li><code>S (Shared)</code>: å¤šä¸ª <code>cpu</code> éƒ½å«æœ‰åŒä¸€ä»½æ•°æ®çš„ç¼“å­˜ï¼Œæ‰€æœ‰ <code>cpu</code> ä¸Šçš„ç¼“å­˜éƒ½æ²¡æœ‰è¢«ä¿®æ”¹</li>
<li><code>I (Invalid)</code>: ç¼“å­˜å·²å¤±æ•ˆ</li>
</ol>
<h4 id="MESI-åè®®é’ˆå¯¹ç¼“å­˜è¡Œçš„äº‹ä»¶ç›‘å¬"><a href="#MESI-åè®®é’ˆå¯¹ç¼“å­˜è¡Œçš„äº‹ä»¶ç›‘å¬" class="headerlink" title="MESI åè®®é’ˆå¯¹ç¼“å­˜è¡Œçš„äº‹ä»¶ç›‘å¬"></a>MESI åè®®é’ˆå¯¹ç¼“å­˜è¡Œçš„äº‹ä»¶ç›‘å¬</h4><p>éšç€ <code>cpu</code> å¯¹ç¼“å­˜è¡Œçš„æ“ä½œï¼Œç¼“å­˜è¡Œä¼šå‘ç”ŸçŠ¶æ€è½¬ç§»ï¼Œä¹Ÿå°±æ˜¯ä»ä¸€ç§çŠ¶æ€åˆ°å¦å¤–ä¸€ç§çŠ¶æ€ï¼Œæ‰€ä»¥ <code>MESI</code> åè®®å¯¹ç¼“å­˜è¡Œçš„ä¸åŒçŠ¶æ€æœ‰ä¸åŒçš„äº‹ä»¶ç›‘å¬</p>
<ol>
<li><code>M</code> çŠ¶æ€çš„ç›‘å¬ï¼š å¦‚æœä¸€ä¸ªç¼“å­˜è¡Œå¤„äº <code>M</code> çŠ¶æ€ï¼Œåˆ™å¿…é¡»ç›‘å¬æ‰€æœ‰è¯•å›¾è¯»å–è¯¥ç¼“å­˜è¡Œå¯¹åº”çš„ä¸»å†…å­˜åœ°å€çš„æ“ä½œï¼Œå¦‚æœç›‘å¬åˆ°æœ‰è¿™ç±»æ“ä½œçš„å‘ç”Ÿï¼Œåˆ™å¿…é¡»åœ¨è¯¥æ“ä½œæ‰§è¡Œä¹‹å‰æŠŠç¼“å­˜è¡Œä¸­çš„æ•°æ®å†™å›ä¸»å†…å­˜</li>
<li><code>S</code> çŠ¶æ€çš„ç›‘å¬ï¼š å¦‚æœä¸€ä¸ªç¼“å­˜è¡Œå¤„äº <code>S</code> çŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒå¿…é¡»è¦ç›‘å¬ä½¿è¯¥ç¼“å­˜è¡ŒçŠ¶æ€è®¾ç½®ä¸º <code>Invalid</code> æˆ–è€…å¯¹ç¼“å­˜è¡Œæ‰§è¡Œ <code>Exclusive</code> æ“ä½œçš„è¯·æ±‚ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å¿…é¡»è¦æŠŠå½“å‰ç¼“å­˜è¡ŒçŠ¶æ€è®¾ç½®ä¸º <code>Invalid</code></li>
<li><code>E</code> çŠ¶æ€çš„ç›‘å¬ï¼š å¦‚æœä¸€ä¸ªç¼“å­˜è¡Œå¤„äº <code>E</code> çŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒå¿…é¡»è¦ç›‘å¬å…¶ä»–è¯•å›¾è¯»å–è¯¥ç¼“å­˜è¡Œå¯¹åº”çš„ä¸»å†…å­˜åœ°å€çš„æ“ä½œï¼Œä¸€æ—¦æœ‰è¿™ç§æ“ä½œï¼Œé‚£ä¹ˆè¯¥ç¼“å­˜è¡Œéœ€è¦è®¾ç½®ä¸º <code>Shared</code></li>
</ol>
<h4 id="ç¼“å­˜è¡Œäº‹ä»¶ç›‘å¬çš„å®ç°åŸç†"><a href="#ç¼“å­˜è¡Œäº‹ä»¶ç›‘å¬çš„å®ç°åŸç†" class="headerlink" title="ç¼“å­˜è¡Œäº‹ä»¶ç›‘å¬çš„å®ç°åŸç†"></a>ç¼“å­˜è¡Œäº‹ä»¶ç›‘å¬çš„å®ç°åŸç†</h4><ol>
<li>ç›‘å¬è¿‡ç¨‹æ˜¯åŸºäº <code>CPU</code> ä¸­çš„ <code>Snoopy</code> å—…æ¢åè®®æ¥å®Œæˆçš„ï¼Œè¯¥åè®®è¦æ±‚æ¯ä¸ª <code>CPU</code> ç¼“å­˜éƒ½å¯ä»¥ç›‘å¬åˆ°æ€»çº¿ä¸Šçš„æ•°æ®äº‹ä»¶å¹¶åšå‡ºç›¸åº”çš„ååº”</li>
<li>æ‰€æœ‰ <code>CPU</code> éƒ½ä¼šç›‘å¬åœ°å€æ€»çº¿ä¸Šçš„äº‹ä»¶ï¼Œå½“æŸä¸ªå¤„ç†å™¨å‘å‡ºè¯·æ±‚æ—¶ï¼Œå…¶ä»– <code>CPU</code> ä¼šç›‘å¬åˆ°åœ°å€æ€»çº¿çš„è¯·æ±‚ï¼Œæ ¹æ®å½“å‰ç¼“å­˜è¡Œçš„çŠ¶æ€åŠç›‘å¬çš„è¯·æ±‚ç±»å‹å¯¹ç¼“å­˜è¡ŒçŠ¶æ€è¿›è¡Œæ›´æ–°</li>
</ol>
<h4 id="MESI-çŠ¶æ€å˜åŒ–ç¤ºä¾‹"><a href="#MESI-çŠ¶æ€å˜åŒ–ç¤ºä¾‹" class="headerlink" title="MESI çŠ¶æ€å˜åŒ–ç¤ºä¾‹"></a>MESI çŠ¶æ€å˜åŒ–ç¤ºä¾‹</h4><p>å‚è€ƒ ã€ŠJavaå¹¶å‘ç¼–ç¨‹æ·±åº¦è§£æä¸å®æˆ˜ã€‹â€“ è°­å³° 3.2 èŠ‚ï¼ˆæ·±åº¦ç†è§£å¯è§æ€§é—®é¢˜çš„æœ¬è´¨ï¼‰</p>
<h2 id="volatile-å®ç°åŸç†"><a href="#volatile-å®ç°åŸç†" class="headerlink" title="volatile å®ç°åŸç†"></a>volatile å®ç°åŸç†</h2><ol>
<li><code>volatile</code> å¯ä»¥è§£å†³å†…å­˜å¯è§æ€§é—®é¢˜å°±æ˜¯åŸºäº<strong>ç¼“å­˜é”&#x2F;æ€»çº¿é”</strong>çš„æ–¹å¼è¾¾åˆ°çš„ä¸€è‡´æ€§</li>
<li>æ€»çº¿é”å’Œç¼“å­˜é”é€šè¿‡ <code>Lock#</code> ä¿¡å·è§¦å‘ï¼Œå¦‚æœå½“å‰<code>CPU</code>æ”¯æŒç¼“å­˜é”ï¼Œåˆ™ä¸ä¼šåœ¨æ€»çº¿ä¸Šå£°æ˜<code>Lock#</code>ä¿¡å·ï¼Œè€Œæ˜¯åŸºäºç¼“å­˜ä¸€è‡´æ€§åè®®æ¥ä¿è¯ç¼“å­˜çš„ä¸€è‡´æ€§ã€‚å¦‚æœ<code>CPU</code>ä¸æ”¯æŒç¼“å­˜é”ï¼Œåˆ™ä¼šåœ¨æ€»çº¿ä¸Šå£°æ˜<code>Lock#</code>ä¿¡å·é”å®šæ€»çº¿ï¼Œä»è€Œä¿è¯åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ª<code>CPU</code>å¯¹å…±äº«å†…å­˜çš„è¯»å†™æ“ä½œ</li>
</ol>
<h2 id="å†…å­˜å±éšœ-è§£å†³cpuå±‚é¢çš„æŒ‡ä»¤é‡æ’"><a href="#å†…å­˜å±éšœ-è§£å†³cpuå±‚é¢çš„æŒ‡ä»¤é‡æ’" class="headerlink" title="å†…å­˜å±éšœ-è§£å†³cpuå±‚é¢çš„æŒ‡ä»¤é‡æ’"></a>å†…å­˜å±éšœ-è§£å†³cpuå±‚é¢çš„æŒ‡ä»¤é‡æ’</h2><blockquote>
<p>CPU æœ¬èº«åªæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå®ƒä¸»è¦ç”¨äºæ¥æ”¶å’Œæ‰§è¡ŒæŒ‡ä»¤ï¼Œå¹¶ä¸æ¸…æ¥šä»€ä¹ˆæ—¶å€™åº”è¯¥ä¼˜åŒ–ï¼Œä»€ä¹ˆæ—¶å€™ä¸åº”è¯¥ä¼˜åŒ–ï¼Œå› æ­¤ CPU è®¾è®¡è€…ä»¬æä¾›äº†ä¸€ä¸ªå†…å­˜å±éšœæŒ‡ä»¤ï¼Œå¼€å‘è€…å¯ä»¥åœ¨åˆé€‚çš„ä½ç½®æ’å…¥å†…å­˜å±éšœæŒ‡ä»¤ï¼Œç›¸å½“äºå‘Šè¯‰ CPUæŒ‡ä»¤ä¹‹é—´çš„å…³ç³»ï¼Œé¿å… CPU å†…å­˜ç³»ç»Ÿé‡æ’åºé—®é¢˜çš„å‘ç”Ÿã€‚</p>
</blockquote>
<h3 id="ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’"><a href="#ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’" class="headerlink" title="ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’"></a>ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’</h3><p>æŒ‡ä»¤é‡æ’åºæ˜¯æŒ‡ç¼–è¯‘å™¨æˆ–<code>CPU</code>ä¸ºäº†ä¼˜åŒ–ç¨‹åºçš„æ‰§è¡Œæ€§èƒ½è€Œå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ–°æ’åºçš„ä¸€ç§æ‰‹æ®µï¼Œé‡æ’åºä¼šå¸¦æ¥å¯è§æ€§é—®é¢˜ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹å¼€å‘ä¸­å¿…é¡»è¦å…³æ³¨å¹¶è§„é¿é‡æ’åºï¼Œ<code>java</code> ä»æºä»£ç åˆ°è¿è¡Œä¼šç»è¿‡ä¸¤ä¸ªé˜¶æ®µçš„é‡æ’</p>
<ol>
<li>ç¼–è¯‘å™¨é‡æ’åºï¼Œå°±æ˜¯åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨æ ¹æ®ä¸Šä¸‹æ–‡åˆ†æå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œç›®çš„æ˜¯å‡å°‘<code>CPU</code>å’Œå†…å­˜çš„äº¤äº’ï¼Œé‡æ’åºä¹‹åå°½å¯èƒ½ä¿è¯<code>CPU</code>ä»å¯„å­˜å™¨æˆ–ç¼“å­˜è¡Œä¸­è¯»å–æ•°æ®</li>
<li>å¤„ç†å™¨é‡æ’åºï¼Œå¤„ç†å™¨é‡æ’åºåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†</li>
<li>å¹¶è¡ŒæŒ‡ä»¤é›†é‡æ’åºï¼Œè¿™æ˜¯å¤„ç†å™¨ä¼˜åŒ–çš„ä¸€ç§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåº</li>
<li>å†…å­˜ç³»ç»Ÿé‡æ’åºï¼Œè¿™æ˜¯å¤„ç†å™¨å¼•å…¥<code>Store Buffer</code>ç¼“å†²åŒºå»¶æ—¶å†™å…¥äº§ç”Ÿçš„æŒ‡ä»¤æ‰§è¡Œé¡ºåºä¸ä¸€è‡´çš„é—®é¢˜</li>
</ol>
<h3 id="æŒ‡ä»¤é‡æ’éœ€è¦éµå¾ª-as-if-serialè¯­ä¹‰"><a href="#æŒ‡ä»¤é‡æ’éœ€è¦éµå¾ª-as-if-serialè¯­ä¹‰" class="headerlink" title="æŒ‡ä»¤é‡æ’éœ€è¦éµå¾ª as-if-serialè¯­ä¹‰"></a>æŒ‡ä»¤é‡æ’éœ€è¦éµå¾ª as-if-serialè¯­ä¹‰</h3><p><code>as-if-serial</code> è¡¨ç¤ºæ‰€æœ‰çš„ç¨‹åºæŒ‡ä»¤éƒ½å¯ä»¥å› ä¸ºä¼˜åŒ–è€Œè¢«é‡æ’åºï¼Œä½†æ˜¯åœ¨ä¼˜åŒ–çš„è¿‡ç¨‹ä¸­å¿…é¡»è¦ä¿è¯æ˜¯åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œé‡æ’åºä¹‹åçš„è¿è¡Œç»“æœå’Œç¨‹åºä»£ç æœ¬èº«é¢„æœŸçš„æ‰§è¡Œç»“æœä¸€è‡´ï¼Œ<code>Java</code> ç¼–è¯‘å™¨ã€<code>CPU</code> æŒ‡ä»¤é‡æ’åºéƒ½éœ€è¦ä¿è¯åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹çš„ <code>as-if-serial</code> è¯­ä¹‰æ˜¯æ­£ç¡®çš„</p>
<p><code>as-if-serial</code>è¯­ä¹‰å…è®¸é‡æ’åºï¼Œ<code>CPU</code>å±‚é¢çš„æŒ‡ä»¤ä¼˜åŒ–ä¾ç„¶å­˜åœ¨ã€‚åœ¨å•çº¿ç¨‹ä¸­ï¼Œè¿™äº›ä¼˜åŒ–å¹¶ä¸ä¼šå½±å“æ•´ä½“çš„æ‰§è¡Œç»“æœï¼Œåœ¨å¤šçº¿ç¨‹ä¸­ï¼Œé‡æ’åºä¼šå¸¦æ¥å¯è§æ€§é—®é¢˜</p>
<h3 id="é‡è°ˆ-MESI-è¿‡ç¨‹"><a href="#é‡è°ˆ-MESI-è¿‡ç¨‹" class="headerlink" title="é‡è°ˆ MESI è¿‡ç¨‹"></a>é‡è°ˆ MESI è¿‡ç¨‹</h3><p>å‡è®¾å­˜åœ¨ä¸€ä¸ª <code>S</code> çŠ¶æ€çš„ç¼“å­˜è¡Œï¼ˆå°±æ˜¯è¯´ <code>CPU0</code> å’Œ <code>CPU1</code> å…±äº«åŒä¸€ä¸ªç¼“å­˜è¡Œï¼‰ï¼Œå¦‚æœ <code>CPU0</code> å¯¹è¿™ä¸ªç¼“å­˜è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆ <code>CPU0</code> éœ€è¦å‘é€ä¸€ä¸ª <code>Invalidate</code> æ¶ˆæ¯åˆ° <code>CPU1</code>ï¼Œåœ¨ç­‰å¾… <code>CPU1</code> è¿”å›<code>Acknowledgement</code> æ¶ˆæ¯ä¹‹å‰ï¼Œ<code>CPU0</code> ä¸€ç›´å¤„äºç©ºé—²çŠ¶æ€</p>
<pre class="mermaid">sequenceDiagram
    participant A as CPU0
    participant B as CPU1
    A->>A: "åŠ è½½å˜é‡, ç¼“å­˜è¡ŒçŠ¶æ€S"
    B->>B: "åŠ è½½å˜é‡ï¼Œç¼“å­˜è¡ŒçŠ¶æ€S"
    A->>A: "ä¿®æ”¹å…±äº«så˜é‡"
    A->>B: "Invalidate"
    A->>A: "ç©ºé—²ç­‰å¾…"
    B->>A: "Acknowledgement"</pre>

<h4 id="Store-Buffers"><a href="#Store-Buffers" class="headerlink" title="Store Buffers"></a>Store Buffers</h4><ol>
<li><p>ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œå½“ä¸€ä¸ª <code>cpu</code> ä»å‘å‡º <code>Invalidate</code> æŒ‡ä»¤åˆ°æ”¶åˆ° <code>Acknowledgement</code> æŒ‡ä»¤ä¹‹é—´ï¼Œè¿™ä¸ª <code>cpu</code> æ˜¯éœ€è¦é˜»å¡çš„</p>
</li>
<li><p><code>Store Buffer</code> æ˜¯ä¸€ä¸ªå­˜å‚¨å™¨ï¼Œå®ƒå­˜å‚¨ç€é‚£äº›è¢«ä¿®æ”¹è¿‡çš„ç¼“å­˜è¡Œã€‚å½“ä¸€ä¸ª <code>cpu</code> è¦ä¿®æ”¹ä¸€ä¸ªç¼“å­˜è¡Œï¼Œå®ƒä¼šå°†è¿™ä¸ªç¼“å­˜è¡Œçš„å‰¯æœ¬æ”¾åˆ° <code>Store Buffer</code> ä¸­ï¼Œç„¶åå‘å‡ºä¸€ä¸ª <code>Invalidate</code> æŒ‡ä»¤ï¼Œè®©å…¶ä»– <code>cpu</code> çŸ¥é“è¿™ä¸ªç¼“å­˜è¡Œ</p>
</li>
</ol>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311292320073.webp" alt="Store Buffers"></p>
<p>åœ¨ <code>CPU</code> ä¸­å¼•å…¥<code>Store Buffers</code>çš„è®¾è®¡åï¼Œ<code>CPU0</code>ä¼šå…ˆå‘é€ä¸€ä¸ª<code>Invalidate</code>æ¶ˆæ¯ç»™å…¶ä»–åŒ…å«è¯¥ç¼“å­˜è¡Œçš„<code>CPU1</code>ï¼Œå¹¶æŠŠå½“å‰ä¿®æ”¹çš„æ•°æ®å†™å…¥<code>Store Buffers</code>ä¸­ï¼Œç„¶åç»§ç»­æ‰§è¡Œåç»­çš„æŒ‡ä»¤ã€‚ç­‰æ”¶åˆ°<code>CPU1</code>çš„<code>Acknowledgement</code>æ¶ˆæ¯åï¼Œ<code>CPU0</code>å†æŠŠ<code>Store Buffers</code>ç§»åˆ°ç¼“å­˜è¡Œä¸­, å› ä¸ºåŠ å…¥äº† <code>Store Buffers</code>ï¼Œå°±ä¼šå¯¼è‡´å†…å­˜å¯è§æ€§é—®é¢˜</p>
<h4 id="ä½¿ç”¨-Store-Forwarding-ä¼˜åŒ–-Store-Buffers-é—®é¢˜"><a href="#ä½¿ç”¨-Store-Forwarding-ä¼˜åŒ–-Store-Buffers-é—®é¢˜" class="headerlink" title="ä½¿ç”¨ Store Forwarding ä¼˜åŒ– Store Buffers é—®é¢˜"></a>ä½¿ç”¨ Store Forwarding ä¼˜åŒ– Store Buffers é—®é¢˜</h4><ol>
<li><p><code>Store Buffers</code> ä¹‹æ‰€ä»¥å­˜åœ¨é—®é¢˜æ˜¯å› ä¸ºï¼Œåœ¨ å…¶ä»– <code>cpu</code> è¿”å› <code>Acknowledgement</code> ä¹‹å‰ï¼Œæ•°æ®æ˜¯å­˜æ”¾åœ¨ <code>Store Buffer</code> ä¸­çš„ï¼Œ<code>cpu</code> ç¼“å­˜è¡Œä¸­å¹¶æ²¡æœ‰æœ€æ–°çš„æ•°æ®ï¼Œ<code>cpu</code> æ‰§è¡ŒæŒ‡ä»¤æ—¶å°±ä¼šç”¨åˆ°ç¼“å­˜è¡Œä¸­çš„æ—§æ•°æ®</p>
</li>
<li><p><code>Store Forwarding</code> æ˜¯æŒ‡æ¯ä¸ª <code>CPU</code> åœ¨åŠ è½½æ•°æ®ä¹‹å‰ï¼Œä¼šå…ˆå¼•ç”¨å½“å‰ <code>CPU</code> çš„ <code>Store Buffers</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æ”¯æŒå°† <code>CPU</code> å­˜å…¥<code>Store Buffers</code> çš„æ•°æ®ä¼ é€’ç»™åç»­çš„åŠ è½½æ“ä½œï¼Œè€Œä¸éœ€è¦ç»è¿‡ <code>Cache</code></p>
</li>
</ol>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311292327246.webp" alt="Store Forwarding"></p>
<h4 id="ä½¿ç”¨-Invalidate-Queues-ä¼˜åŒ–-Store-Buffers-é—®é¢˜"><a href="#ä½¿ç”¨-Invalidate-Queues-ä¼˜åŒ–-Store-Buffers-é—®é¢˜" class="headerlink" title="ä½¿ç”¨ Invalidate Queues ä¼˜åŒ– Store Buffers é—®é¢˜"></a>ä½¿ç”¨ Invalidate Queues ä¼˜åŒ– Store Buffers é—®é¢˜</h4><ol>
<li><p>å‰é¢è®²åˆ°çš„ <code>Store Forwarding</code> é’ˆå¯¹çš„æ—¶å‘å‡º <code>Invalidate</code> æŒ‡ä»¤çš„ <code>cpu</code>ï¼Œè€Œæ¥ä¸‹æ¥è¦è®²è§£çš„ <code>Invalidate Queues</code> åˆ™æ˜¯é’ˆå¯¹æ¥æ”¶åˆ° <code>Invalidate</code> æŒ‡ä»¤å¹¶ä¸”è¦å“åº” <code>Acknowledgement</code> æŒ‡ä»¤çš„ <code>cpu</code>ï¼Œ å…·ä½“åŸå› å¦‚ä¸‹</p>
</li>
<li><p><code>Store Buffers</code>æœ¬èº«çš„å­˜å‚¨å®¹é‡æ˜¯æœ‰é™çš„ï¼Œåœ¨å½“å‰<code>CPU</code>çš„æ‰€æœ‰å†™å…¥æ“ä½œéƒ½å­˜åœ¨ç¼“å­˜æœªå‘½ä¸­çš„æƒ…å†µæ—¶ï¼Œå°±ä¼šå¯¼è‡´<code>Store Buffers</code>å¾ˆå®¹æ˜“è¢«å¡«å……æ»¡ã€‚è¢«å¡«æ»¡ä¹‹åï¼Œå¿…é¡»è¦ç­‰åˆ°<code>CPU</code>è¿”å›<code>Invalidate Acknowledge</code>æ¶ˆæ¯ï¼Œ<code>Store Buffers</code>ä¸­å¯¹åº”çš„æŒ‡ä»¤æ‰èƒ½è¢«æ¸…ç†ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹<code>CPU</code>å¿…é¡»è¦ç­‰å¾…ï¼Œæ— è®ºè¯¥<code>CPU</code>ä¸­åç»­æŒ‡ä»¤æ˜¯å¦å­˜åœ¨ç¼“å­˜æœªå‘½ä¸­çš„æƒ…å†µ</p>
</li>
<li><p>å¦‚æœæ”¶åˆ°<code>Invalidate</code>æ¶ˆæ¯çš„<code>CPU</code>æ­¤æ—¶å¤„äºç¹å¿™çŠ¶æ€ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´<code>Invalidate Acknowledge</code>æ¶ˆæ¯è¿”å›å»¶è¿Ÿ</p>
</li>
<li><p>å¢åŠ ä¸€ä¸ª<code>Invalidate Queues</code>ï¼Œç”¨äºå­˜å‚¨è®©ç¼“å­˜è¡Œå¤±æ•ˆçš„æ¶ˆæ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>CPU</code>æ”¶åˆ°<code>Invalidate</code>æ¶ˆæ¯æ—¶ï¼ŒæŠŠè®©è¯¥ç¼“å­˜è¡Œå¤±æ•ˆçš„æ¶ˆæ¯æ”¾å…¥<code>Invalidate Queues</code>ï¼Œç„¶ååŒæ­¥è¿”å›ä¸€ä¸ª<code>Invalidate Acknowledge</code>æ¶ˆæ¯ã€‚è¿™æ ·å°±å¤§å¤§ç¼©çŸ­äº†å“åº”çš„æ—¶é—´</p>
</li>
</ol>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311292336827.webp" alt="Invalidate Queues"></p>
<h3 id="å†…å­˜å±éšœæŒ‡ä»¤"><a href="#å†…å­˜å±éšœæŒ‡ä»¤" class="headerlink" title="å†…å­˜å±éšœæŒ‡ä»¤"></a>å†…å­˜å±éšœæŒ‡ä»¤</h3><ol>
<li>è¯»å±éšœæŒ‡ä»¤(Ifence)</li>
<li>å°† <code>Invalidate Queues</code>ä¸­çš„æŒ‡ä»¤ç«‹å³å¤„ç†ï¼Œå¹¶ä¸”å¼ºåˆ¶è¯»å–<code>CPU</code>çš„ç¼“å­˜è¡Œ, æ‰§è¡Œ<code>lfence</code>æŒ‡ä»¤ä¹‹åçš„è¯»æ“ä½œä¸ä¼šè¢«é‡æ’åºåˆ°æ‰§è¡Œ<code>lfence</code>æŒ‡ä»¤ä¹‹å‰ï¼Œè¿™æ„å‘³ç€å…¶ä»–<code>CPU</code>æš´éœ²å‡ºæ¥çš„ç¼“å­˜è¡ŒçŠ¶æ€å¯¹å½“å‰<code>CPU</code>å¯è§</li>
<li>å†™å±éšœæŒ‡ä»¤(sfence)</li>
<li>å®ƒä¼šæŠŠ<code>Store Buffers</code>ä¸­çš„ä¿®æ”¹åˆ·æ–°åˆ°æœ¬åœ°ç¼“å­˜ä¸­ï¼Œä½¿å¾—å…¶ä»–<code>CPU</code>èƒ½å¤Ÿçœ‹åˆ°è¿™äº›ä¿®æ”¹ï¼Œè€Œä¸”åœ¨æ‰§è¡Œ<code>sfence</code>æŒ‡ä»¤ä¹‹åçš„å†™æ“ä½œä¸ä¼šè¢«é‡æ’åºåˆ°æ‰§è¡Œ<code>sfence</code>æŒ‡ä»¤ä¹‹å‰ï¼Œè¿™æ„å‘³ç€æ‰§è¡Œ<code>sfence</code>æŒ‡ä»¤ä¹‹å‰çš„å†™æ“ä½œä¸€å®šè¦å…¨å±€å¯è§ï¼ˆå†…å­˜å¯è§æ€§åŠç¦æ­¢é‡æ’åºï¼‰</li>
<li>è¯»å†™å±éšœæŒ‡ä»¤(mfenceï¼‰</li>
<li>ç›¸å½“äº<code>lfence</code>å’Œ<code>sfence</code>çš„æ··åˆä½“ï¼Œä¿è¯<code>mfence</code>æŒ‡ä»¤æ‰§è¡Œå‰åçš„è¯»å†™æ“ä½œçš„é¡ºåºï¼ŒåŒæ—¶è¦æ±‚æ‰§è¡Œ<code>mfence</code>æŒ‡ä»¤ä¹‹åçš„å†™æ“ä½œçš„ç»“æœå…¨å±€å¯è§ï¼Œæ‰§è¡Œ<code>mfence</code>æŒ‡ä»¤ä¹‹å‰çš„å†™æ“ä½œç»“æœå…¨å±€å¯è§</li>
</ol>
<h3 id="JVM-å†…å­˜å±éšœæŒ‡ä»¤"><a href="#JVM-å†…å­˜å±éšœæŒ‡ä»¤" class="headerlink" title="JVM å†…å­˜å±éšœæŒ‡ä»¤"></a>JVM å†…å­˜å±éšœæŒ‡ä»¤</h3><p>å‰é¢è®²åˆ°çš„å†…å­˜å±éšœæŒ‡ä»¤æ˜¯ <code>cpu</code> å¯ä»¥æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œä½†æ˜¯è¿™äº›æŒ‡ä»¤æ˜¯éœ€è¦åº”ç”¨æ¥è°ƒç”¨çš„ï¼ŒåŒæ ·çš„åº”ç”¨ä¹Ÿéœ€è¦æä¾›ç›¸åº”çš„æŒ‡ä»¤ç»™å¼€å‘è€…è°ƒç”¨ï¼Œå¯¹åº”åˆ° <code>JVM</code> ä¸­ï¼Œæä¾›äº†å¦‚ä¸‹å‡ ç§æŒ‡ä»¤</p>
<ol>
<li>loadload</li>
<li>storestore</li>
<li>loadstore</li>
<li>storeload</li>
</ol>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311292348303.webp" alt="å†…å­˜å±éšœ"></p>
]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>çº¿ç¨‹æ± å®ç°åŸç†</title>
    <url>/2023/63b6d22fbd8f/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="1-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± "><a href="#1-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± " class="headerlink" title="1. ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± "></a>1. ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± </h2><ol>
<li>çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯éƒ½éœ€è¦æ¶ˆè€—èµ„æºï¼ˆcpuï¼Œå†…å­˜ï¼‰</li>
<li>ä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥é¢„å…ˆåˆ›å»ºå¥½çº¿ç¨‹ï¼Œå¼€å§‹ä½¿ç”¨æ—¶é€Ÿåº¦æ›´å¿«<span id="more"></span></li>
</ol>
<h2 id="2-çº¿ç¨‹æ± çš„è®¾è®¡æ€æƒ³"><a href="#2-çº¿ç¨‹æ± çš„è®¾è®¡æ€æƒ³" class="headerlink" title="2. çº¿ç¨‹æ± çš„è®¾è®¡æ€æƒ³"></a>2. çº¿ç¨‹æ± çš„è®¾è®¡æ€æƒ³</h2><h3 id="2-1-å¦‚ä½•åšåˆ°çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»»åŠ¡åä¸å›æ”¶"><a href="#2-1-å¦‚ä½•åšåˆ°çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»»åŠ¡åä¸å›æ”¶" class="headerlink" title="2.1. å¦‚ä½•åšåˆ°çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»»åŠ¡åä¸å›æ”¶"></a>2.1. å¦‚ä½•åšåˆ°çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»»åŠ¡åä¸å›æ”¶</h3><p>çº¿ç¨‹æ± å°±æ˜¯è¦ç¼“å­˜çº¿ç¨‹ï¼Œå½“ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åï¼Œæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹å¯ä»¥ä¸ç”¨å›æ”¶ï¼Œå½“æœ‰æ–°çš„ä»»åŠ¡æ¥åˆ°æ—¶å¤ç”¨å½“å‰çº¿ç¨‹æ¥æ‰§è¡Œï¼Œå¹³æ—¶çº¿ç¨‹æ‰§è¡Œçš„ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯å®é™…æ˜¯åº•å±‚çš„æ“ä½œç³»ç»Ÿæ¥å®ç°çš„ï¼Œå½“å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œ<code>run()</code> æ–¹æ³•å°±ä¼šæ‰§è¡Œï¼Œå½“ <code>run()</code> æ‰§è¡Œå®Œæˆä¹‹åå½“å‰çš„çº¿ç¨‹ä¼šè‡ªåŠ¨é”€æ¯<br>é‚£ä¹ˆå¦‚ä½•åšåˆ°çº¿ç¨‹ä¸è¢«é”€æ¯å‘¢ï¼Ÿå…¶å®åªè¦è®© <code>run()</code> æ–¹æ³•ä¸€ç›´åœ¨æ‰§è¡Œå°±å¥½äº†ï¼Œæ¯”å¦‚åŠ ä¸ª <code>while</code> å¾ªç¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-çº¿ç¨‹ç©ºé—²æ—¶ä¹Ÿæ¶ˆè€—èµ„æºæ€ä¹ˆå¤„ç†"><a href="#2-2-çº¿ç¨‹ç©ºé—²æ—¶ä¹Ÿæ¶ˆè€—èµ„æºæ€ä¹ˆå¤„ç†" class="headerlink" title="2.2. çº¿ç¨‹ç©ºé—²æ—¶ä¹Ÿæ¶ˆè€—èµ„æºæ€ä¹ˆå¤„ç†"></a>2.2. çº¿ç¨‹ç©ºé—²æ—¶ä¹Ÿæ¶ˆè€—èµ„æºæ€ä¹ˆå¤„ç†</h3><ol>
<li>ä¸ºäº†åšåˆ°å°†çº¿ç¨‹ä¸å›æ”¶ï¼Œä¸€ç›´æ‰§è¡Œï¼Œæ‰€ä»¥ä½¿ç”¨å°†ä»»åŠ¡ä»£ç æ”¾åœ¨ <code>while(true)</code> é‡Œé¢ï¼Œä½†æ˜¯è¿™æ ·åšä¼šå‡ºç°å³ä½¿æ²¡æœ‰ä»»åŠ¡æ—¶ï¼Œè¿™ä¸ªçº¿ç¨‹ä¹Ÿä¼šä¸€ç›´æ¶ˆè€— cpu èµ„æºï¼Œæ‰€ä»¥éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–</li>
<li>ä¼˜åŒ–æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æ²¡æœ‰ä»»åŠ¡æ—¶å°±é˜»å¡å½“å‰çº¿ç¨‹å°±å¥½äº†ï¼Œå½“æœ‰ä»»åŠ¡æ¥åˆ°æ—¶å†å”¤èµ·å½“å‰çº¿ç¨‹è¿›è¡Œæ‰§è¡Œ</li>
<li>æ‰€ä»¥çº¿ç¨‹æ± å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ª <code>ç”Ÿäº§è€…--æ¶ˆè´¹è€…</code> æ¨¡å‹ï¼Œæäº¤ä»»åŠ¡çš„çº¿ç¨‹å°±æ˜¯ç”Ÿäº§è€…ï¼Œçº¿ç¨‹æ± è‡ªèº«å°±æ˜¯æ¶ˆè´¹è€…ï¼Œçº¿ç¨‹æ± ä»é˜»å¡é˜Ÿåˆ—ä¸­ä¸æ–­è·å–ä»»åŠ¡ï¼Œæœ‰ä»»åŠ¡å°±æ‰§è¡Œï¼Œæ²¡æœ‰ä»»åŠ¡å°±é˜»å¡è‡ªå·±</li>
</ol>
<h2 id="3-çº¿ç¨‹æ± åˆ›å»ºæ–¹å¼"><a href="#3-çº¿ç¨‹æ± åˆ›å»ºæ–¹å¼" class="headerlink" title="3. çº¿ç¨‹æ± åˆ›å»ºæ–¹å¼"></a>3. çº¿ç¨‹æ± åˆ›å»ºæ–¹å¼</h2><h3 id="3-1-Executors-ç±»"><a href="#3-1-Executors-ç±»" class="headerlink" title="3.1. Executors ç±»"></a>3.1. Executors ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Executors</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå›ºå®šæ•°é‡çº¿ç¨‹çš„çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads,</span><br><span class="line">                                      <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                      <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå•ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ±  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">(ThreadFactory threadFactory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FinalizableDelegatedExecutorService</span></span><br><span class="line">            (<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                    <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(),</span><br><span class="line">                                    threadFactory));</span><br><span class="line">    &#125;</span><br><span class="line">    â€¦â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-ThreadPoolExecutor"><a href="#3-2-ThreadPoolExecutor" class="headerlink" title="3.2. ThreadPoolExecutor"></a>3.2. ThreadPoolExecutor</h3><p>é€šè¿‡ä¸Šé¢ <code>Executors</code> ç±»åˆ›å»ºçš„çº¿ç¨‹æ± å¯ä»¥çœ‹åˆ°æœ€ç»ˆè¿˜æ˜¯ <code>new ThreadPoolExecutor</code>, ä½†æ˜¯ç›´æ¥ä½¿ç”¨ <code>Executors</code> åˆ›å»ºçš„çº¿ç¨‹æ± å­˜åœ¨çš„é—®é¢˜æ—¶ï¼Œè¦ä¹ˆçº¿ç¨‹æ•°é‡æ²¡æœ‰é™åˆ¶ï¼Œè¦ä¹ˆæ˜¯é˜Ÿåˆ—çš„å¤§å°æ²¡æœ‰é™åˆ¶ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹éƒ½ä¸æ¨èä½¿ç”¨ <code>Executors</code> æ¥ç›´æ¥åˆ›å»ºçº¿ç¨‹æ± ï¼Œè€Œæ˜¯æ‰‹åŠ¨é€šè¿‡ <code>ThreadPoolExecutor</code> æ¥åˆ›å»ºï¼Œ æ¯”å¦‚ä¸‹é¢è¿™ç§æ–¹å¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">        <span class="number">5</span>,  <span class="comment">// çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line">        <span class="number">10</span>,  <span class="comment">// çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°</span></span><br><span class="line">        <span class="number">1000</span>,  <span class="comment">// çº¿ç¨‹æ± ä¸­è¶…è¿‡corePoolSizeæ•°ç›®çš„ç©ºé—²çº¿ç¨‹æœ€å¤§å­˜æ´»æ—¶é—´</span></span><br><span class="line">        TimeUnit.MILLISECONDS,  <span class="comment">// æ—¶é—´å•ä½ï¼Œæ¯«ç§’</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="number">50</span>),  <span class="comment">// å·¥ä½œçº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">        Executors.defaultThreadFactory(),  <span class="comment">// è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy());  <span class="comment">// çº¿ç¨‹æ± æ»¡æ—¶çš„æ‹’ç»ç­–ç•¥</span></span><br></pre></td></tr></table></figure>

<h2 id="çº¿ç¨‹æ± çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#çº¿ç¨‹æ± çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="çº¿ç¨‹æ± çš„ç”Ÿå‘½å‘¨æœŸ"></a>çº¿ç¨‹æ± çš„ç”Ÿå‘½å‘¨æœŸ</h2><pre class="mermaid">flowchart LR
    A[running]-- "æ‰§è¡Œshutdown()æ–¹æ³•"--> B[Shutdown]
    A-- "æ‰§è¡ŒshutdonwNow() æ–¹æ³•"--> C[Stop]
    B--"ä»»åŠ¡åˆ—è¡¨ä¸ºç©ºï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆ"-->D[TIDYING]
    B--"shutdownNow()"-->C
    C--æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆ-->D
    D--"æ‰§è¡Œ terminated() æ–¹æ³•"-->E[TERMINATED]</pre>
<ul>
<li>RUNNINGï¼šèƒ½æ¥å—æ–°ä»»åŠ¡ï¼Œå¹¶å¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</li>
<li>SHUTDOWNï¼šä¸æ¥å—æ–°ä»»åŠ¡ï¼Œä½†æ˜¯å¯ä»¥å¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</li>
<li>STOPï¼šæ‰€æœ‰ä»»åŠ¡éƒ½ä¸å¤„ç†ï¼ˆæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹å‡†å¤‡ä¸­æ–­ï¼Œé˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸å†å¤„ç†ï¼Œæ–°çš„ä»»åŠ¡ä¸ä¼šå†æ¥æ”¶ï¼‰</li>
<li>TIDYINGï¼šæ‰€æœ‰ä»»åŠ¡éƒ½ç»ˆæ­¢ï¼Œå¹¶ä¸”å·¥ä½œçº¿ç¨‹ä¹Ÿä¸º0ï¼Œå¤„äºå…³é—­ä¹‹å‰çš„çŠ¶æ€</li>
<li>TERMINATEDï¼šå·²å…³é—­ã€‚</li>
</ul>
<h2 id="çº¿ç¨‹æ± çš„å¤„ç†æµç¨‹"><a href="#çº¿ç¨‹æ± çš„å¤„ç†æµç¨‹" class="headerlink" title="çº¿ç¨‹æ± çš„å¤„ç†æµç¨‹"></a>çº¿ç¨‹æ± çš„å¤„ç†æµç¨‹</h2><pre class="mermaid">flowchart LR
    A[æäº¤ä»»åŠ¡] --> B{æ ¸å¿ƒçº¿ç¨‹æ± æ˜¯å¦å·²æ»¡}
    B --å¦--> C[åˆ›å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡]
    B --æ˜¯--> D{é˜Ÿåˆ—æ˜¯å¦å·²æ»¡}
    D --å¦--> E[å°†ä»»åŠ¡å­˜å‚¨åœ¨é˜Ÿåˆ—ä¸­]
    D --æ˜¯--> F{æ˜¯å¦è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ± }
    F --å¦--> G[åˆ›å»ºçº¿ç¨‹æ‰§è¡Œ]
    F --æ˜¯--> J[æ‰§è¡Œæ‹’ç»ç­–ç•¥]</pre>

<h3 id="çº¿ç¨‹æ± ç›¸å…³æ ¸å¿ƒå˜é‡"><a href="#çº¿ç¨‹æ± ç›¸å…³æ ¸å¿ƒå˜é‡" class="headerlink" title="çº¿ç¨‹æ± ç›¸å…³æ ¸å¿ƒå˜é‡"></a>çº¿ç¨‹æ± ç›¸å…³æ ¸å¿ƒå˜é‡</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title class_">AbstractExecutorService</span> &#123;</span><br><span class="line">    <span class="comment">// ctl å˜é‡ä¿å­˜äº†ä¸¤ä¸ªä¿¡æ¯ï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€ï¼ˆé«˜3ä½ï¼‰å’Œçº¿ç¨‹æ•°é‡ï¼ˆä½29ä½ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line">    <span class="comment">// ç»Ÿè®¡çº¿ç¨‹æ•°é‡çš„ä½æ•°ï¼Œè¿™é‡Œè¡¨ç¤ºä½¿ç”¨32-3 = 29 ä½æ¥è¡¨ç¤ºçº¿ç¨‹çš„æ•°é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> Integer.SIZE - <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_MASK</span> <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ± çš„å‡ ç§çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RUNNING</span>    <span class="operator">=</span> -<span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHUTDOWN</span>   <span class="operator">=</span>  <span class="number">0</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">STOP</span>       <span class="operator">=</span>  <span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TIDYING</span>    <span class="operator">=</span>  <span class="number">2</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TERMINATED</span> <span class="operator">=</span>  <span class="number">3</span> &lt;&lt; COUNT_BITS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢é‡ç‚¹çœ‹ä¸€ä¸‹ ctl å˜é‡æ˜¯å¦‚ä½•é€šè¿‡ä¸€ä¸ªå˜é‡å­˜å‚¨ä¸¤ç§ä¿¡æ¯çš„</p>
<h3 id="çº¿ç¨‹æ•°é‡"><a href="#çº¿ç¨‹æ•°é‡" class="headerlink" title="çº¿ç¨‹æ•°é‡"></a>çº¿ç¨‹æ•°é‡</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> Integer.SIZE - <span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>å…¶ä¸­ <code>Integer.SIZE</code> &#x3D; 32, æ‰€ä»¥ <code>COUNT_BITS</code> å°±æ˜¯29ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ 29 ä½æ¥è¡¨ç¤ºçº¿ç¨‹çš„æ•°é‡<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_MASK</span> <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">     <span class="number">1</span> &lt;&lt; COUNT_BITS</span><br><span class="line">      â€‹</span><br><span class="line">      <span class="number">1</span>çš„<span class="number">32</span>ä½<span class="number">2</span>è¿›åˆ¶æ˜¯</span><br><span class="line">      <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0001</span></span><br><span class="line">      â€‹</span><br><span class="line">      å·¦ç§»<span class="number">29</span>ä½</span><br><span class="line">      <span class="number">0010</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span></span><br><span class="line">      â€‹</span><br><span class="line">      å†è¿›è¡Œå‡ä¸€</span><br><span class="line">      <span class="number">000</span> <span class="number">11111</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span></span><br><span class="line">      â€‹</span><br><span class="line">      æ‰€ä»¥çº¿ç¨‹æ± æœ€å¤§æ•°ç›®å°±æ˜¯</span><br><span class="line">      <span class="number">000</span> <span class="number">11111</span> <span class="number">11111111</span> <span class="number">11111111</span> <span class="number">11111111</span></span><br></pre></td></tr></table></figure></li>
<li>é‚£æ€ä¹ˆé€šè¿‡è¿™ 29 ä½æ¥è·å–çº¿ç¨‹çš„æ•°é‡å‘¢ï¼Œé€šè¿‡ <code>workderCountOf(int c)</code> æ–¹æ³•å¯ä»¥çœ‹åˆ°å®é™…æ˜¯é€šè¿‡ä½è¿ç®—ä¸­çš„ <code>ä¸</code> æ“ä½œæ¥å»é™¤æœ€é«˜ä½æ¥è¿›è¡Œè·å–çš„</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">workerCountOf</span><span class="params">(<span class="type">int</span> c)</span>  &#123; </span><br><span class="line">    <span class="keyword">return</span> c &amp; COUNT_MASK; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="çº¿ç¨‹æ± çš„çŠ¶æ€"><a href="#çº¿ç¨‹æ± çš„çŠ¶æ€" class="headerlink" title="çº¿ç¨‹æ± çš„çŠ¶æ€"></a>çº¿ç¨‹æ± çš„çŠ¶æ€</h3><p>è·å–çº¿ç¨‹æ± çŠ¶æ€çš„æ–¹æ³•æ˜¯ <code>runStateOf()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">runStateOf</span><span class="params">(<span class="type">int</span> c)</span>     &#123;</span><br><span class="line">     <span class="keyword">return</span> c &amp; ~COUNT_MASK; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°åˆ†æˆäº†ä¸¤æ­¥</p>
<ol>
<li>å¯¹ <code>COUNT_MASK</code> å–åï¼Œå‰é¢å·²ç»çŸ¥é“ <code>COUNT_MASK</code> å‰é¢ä¸‰ä½æ˜¯0ï¼Œæœ€å29ä½æ˜¯1ï¼Œ å–ååˆ™æ˜¯å‰é¢ä¸‰ä½æ˜¯1ï¼Œæœ€å29ä½æ˜¯0</li>
<li><code>ä¸</code> æ“ä½œå’Œè®¡ç®—çº¿ç¨‹æ•°é‡æ—¶æ˜¯ä¸€æ ·çš„ï¼Œæ˜¯ä¸ºäº†å»é™¤åé¢29ä½æ•°ï¼Œåªéœ€è¦è®¡ç®—å‰é¢ä¸‰ä½çš„æ•°å³å¯</li>
</ol>
<h2 id="çº¿ç¨‹æ± æ ¸å¿ƒé—®é¢˜"><a href="#çº¿ç¨‹æ± æ ¸å¿ƒé—®é¢˜" class="headerlink" title="çº¿ç¨‹æ± æ ¸å¿ƒé—®é¢˜"></a>çº¿ç¨‹æ± æ ¸å¿ƒé—®é¢˜</h2><h3 id="çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹ä»€ä¹ˆæ—¶å€™åˆ›å»º"><a href="#çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹ä»€ä¹ˆæ—¶å€™åˆ›å»º" class="headerlink" title="çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹ä»€ä¹ˆæ—¶å€™åˆ›å»º"></a>çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹ä»€ä¹ˆæ—¶å€™åˆ›å»º</h3><ol>
<li>é»˜è®¤æƒ…å†µä¸‹ä¸ä¼šé¢„å…ˆåˆ›å»ºçº¿ç¨‹ï¼Œæ‰€ä»¥æ ¸å¿ƒçº¿ç¨‹ä¹Ÿæ˜¯åœ¨æœ‰ä»»åŠ¡æ¥çš„æ—¶å€™æ‰ä¼šåˆ›å»º</li>
<li>åœ¨ <code>ThreadPoolExecutor</code> ç±»ä¸­æä¾›äº†ä¸¤ä¸ªæ–¹æ³•</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title class_">AbstractExecutorService</span> &#123;</span><br><span class="line">    <span class="comment">// é¢„å…ˆå¯åŠ¨ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">prestartCoreThread</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> workerCountOf(ctl.get()) &lt; corePoolSize &amp;&amp;</span><br><span class="line">            addWorker(<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¢„å…ˆå¯åŠ¨æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">prestartAllCoreThreads</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (addWorker(<span class="literal">null</span>, <span class="literal">true</span>))</span><br><span class="line">            ++n;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•å¯çŸ¥ï¼Œåœ¨åˆ›å»ºçº¿ç¨‹æ± ä¹‹åï¼ˆæäº¤ä»»åŠ¡ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ execute ä¹‹å‰ï¼‰æ˜¯å¯ä»¥è°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•æ¥é¢„å…ˆåˆ›å»ºæ ¸å¿ƒçº¿ç¨‹çš„</p>
<h3 id="çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦ä¼šè¢«å›æ”¶"><a href="#çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦ä¼šè¢«å›æ”¶" class="headerlink" title="çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦ä¼šè¢«å›æ”¶"></a>çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦ä¼šè¢«å›æ”¶</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title class_">AbstractExecutorService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">allowCoreThreadTimeOut</span><span class="params">(<span class="type">boolean</span> value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value &amp;&amp; keepAliveTime &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Core threads must have nonzero keep alive times&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (value != allowCoreThreadTimeOut) &#123;</span><br><span class="line">            allowCoreThreadTimeOut = value;</span><br><span class="line">            <span class="keyword">if</span> (value)</span><br><span class="line">                interruptIdleWorkers();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>ThreadPoolExecutor</code> ç±»ä¸­æœ‰æä¾› <code>allowCoreThreadTimeOut(boolean)</code> æ–¹æ³•æ¥è®¾ç½®å½“è¾¾åˆ°è¶…æ—¶æ—¶é—´æ—¶ï¼Œæ ¸å¿ƒçº¿ç¨‹ä¹Ÿå¯ä»¥è¢«å›æ”¶æ‰</p>
<h3 id="æ ¸å¿ƒçº¿ç¨‹æ•°é‡å’Œæœ€å¤§å…ˆåƒæ•°é‡åŠ¨æ€ä¿®æ”¹"><a href="#æ ¸å¿ƒçº¿ç¨‹æ•°é‡å’Œæœ€å¤§å…ˆåƒæ•°é‡åŠ¨æ€ä¿®æ”¹" class="headerlink" title="æ ¸å¿ƒçº¿ç¨‹æ•°é‡å’Œæœ€å¤§å…ˆåƒæ•°é‡åŠ¨æ€ä¿®æ”¹"></a>æ ¸å¿ƒçº¿ç¨‹æ•°é‡å’Œæœ€å¤§å…ˆåƒæ•°é‡åŠ¨æ€ä¿®æ”¹</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åŠ¨æ€ä¿®æ”¹æ ¸å¿ƒçº¿ç¨‹æ•°é‡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCorePoolSize</span><span class="params">(<span class="type">int</span> corePoolSize)</span> &#123;</span><br><span class="line">    â€¦â€¦</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ¨æ€ä¿®æ”¹æœ€å¤§çº¿ç¨‹æ•°é‡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMaximumPoolSize</span><span class="params">(<span class="type">int</span> maximumPoolSize)</span> &#123;</span><br><span class="line">    â€¦â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æœ‰å†™åˆ°å¯ä»¥åŠ¨æ€ä¿®æ”¹çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹å’Œæœ€å¤§çº¿ç¨‹æ•°é‡ï¼Œé‚£ä¹ˆè¿™ä¹ˆè®¾è®¡çš„åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¯´åˆ°è¿™ä¸ªé—®é¢˜å°±ç‰µæ‰¯åˆ°å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•åˆç†è®¾ç½®çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡å¤§å°ï¼Ÿå¯¹äºçº¿ç¨‹æ± æ•°é‡å¤§å°çš„è®¾ç½®é—®é¢˜æœ‰å¤šç§å»ºè®®ï¼Œæ¯”å¦‚</p>
<ol>
<li>CPUå¯†é›†å‹ï¼Œçº¿ç¨‹æ± å¤§å°è®¾ç½®ä¸ºN+1ï¼Œ IOå¯†é›†å‹ï¼Œçº¿ç¨‹æ± å¤§å°è®¾ç½®ä¸º2N+1ï¼ˆNæŒ‡çš„æ˜¯cpuæ ¸å¿ƒæ•°ï¼‰</li>
<li>çº¿ç¨‹æ•°&#x3D;CPUæ ¸æ•° *ï¼ˆ1+çº¿ç¨‹ç­‰å¾…æ—¶é—´ &#x2F; çº¿ç¨‹æ—¶é—´è¿è¡Œæ—¶é—´ï¼‰</li>
</ol>
<p>å¯¹äºæ–¹å¼2æ˜¯ç»“åˆäº†å®é™…çš„ä¸šåŠ¡ï¼Œä½†æ˜¯çº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼Œçº¿ç¨‹è¿è¡Œæ—¶é—´éƒ½æ˜¯éœ€è¦ <code>ç›‘æ§</code> çº¿ç¨‹ç¯å¢ƒæ‰å¯ä»¥å¾—çŸ¥çš„ï¼Œæ—¢ç„¶æ¶‰åŠåˆ° <code>ç›‘æ§</code> å°±è¯´æ˜è¿™ä¸ªå€¼æ˜¯éœ€è¦åŠ¨æ€å»ä¿®æ”¹çš„ï¼Œæ‰€ä»¥æ‰ä¼šéœ€è¦æä¾›è¿™æ ·ä¸¤ä¸ªä¿®æ”¹çº¿ç¨‹æ•°é‡çš„æ–¹æ³•</p>
<h3 id="ç›¸åŒçš„ä»»åŠ¡å¦‚ä½•èˆå¼ƒ"><a href="#ç›¸åŒçš„ä»»åŠ¡å¦‚ä½•èˆå¼ƒ" class="headerlink" title="ç›¸åŒçš„ä»»åŠ¡å¦‚ä½•èˆå¼ƒ"></a>ç›¸åŒçš„ä»»åŠ¡å¦‚ä½•èˆå¼ƒ</h3><ol>
<li>åœ¨æŸäº›åœºæ™¯ä¸‹ä¼šæœ‰ä»»åŠ¡ä¸æ–­çš„å¾€çº¿ç¨‹æ± ä¸­æ·»åŠ ï¼Œä½†æ˜¯å¯¹äºæ·»åŠ çš„ç›¸åŒçš„ä»»åŠ¡å¦‚æœä¹‹å‰è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæˆï¼Œåç»­æ·»åŠ çš„ä»»åŠ¡å¯ä»¥ç›´æ¥èˆå¼ƒï¼Œè¿™é‡Œæ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹æ˜¯ <code>é˜Ÿåˆ—</code> å’Œ <code>å¯¹è±¡ç›¸ç­‰çš„åˆ¤æ–­</code></li>
<li>å¦‚æœæ¯æ¬¡æ·»åŠ æ–°ä»»åŠ¡ä¹‹å‰æ—§çš„ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæˆï¼Œå°±ä¸å­˜åœ¨ç›¸åŒçš„ä»»åŠ¡èˆå¼ƒè¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œçš„åœºæ™¯æ˜¯æäº¤çš„ä»»åŠ¡å¤ªå¤šï¼Œçº¿ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œæˆçš„ä»»åŠ¡ä¿ç•™åœ¨é˜Ÿåˆ—ä¸­</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String account;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        doSomething();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡å†™ equals æ–¹æ³•ï¼Œè¿™ä¸ªå°±æ˜¯åˆ¤æ–­ä»»åŠ¡ç›¸åŒçš„å…³é”®</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == o) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="literal">null</span> || getClass() != o.getClass()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">MyTask</span> <span class="variable">that</span> <span class="operator">=</span> (MyTask) o;</span><br><span class="line">        <span class="comment">// è¿™é‡Œæ˜¯ç”¨è´¦å·æ¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦ç›¸åŒ</span></span><br><span class="line">        <span class="keyword">return</span> account.equals(that.account);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>æäº¤ä»»åŠ¡ä¹‹å‰å…ˆè·å–é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œçœ‹æ˜¯å¦æœ‰æ­£åœ¨æ’é˜Ÿçš„ç›¸åŒè´¦å·çš„ä»»åŠ¡</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">BlockingQueue&lt;Runnable&gt; queue = threadPoolExecutor.getQueue();</span><br><span class="line"><span class="comment">// æ„å»ºå½“å‰ä»»åŠ¡</span></span><br><span class="line"><span class="type">MyTask</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyTask</span>(<span class="string">&quot;currentTaskAccount&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (queue.size() &gt; <span class="number">0</span> &amp;&amp; queue.contains(authSymbolTask)) &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;é˜Ÿåˆ—ä¸­å«æœ‰:&#123;&#125;çš„ä»»åŠ¡,å½“å‰ä»»åŠ¡è¢«ä¸¢å¼ƒ&quot;</span>, task.getAccount());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// é˜Ÿåˆ—ä¸­ä¸åŒ…å«å½“å‰è´¦å·çš„ä»»åŠ¡å°±æäº¤å½“å‰ä»»åŠ¡</span></span><br><span class="line">    threadPoolExecutor.execute(task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹"><a href="#çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹" class="headerlink" title="çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹"></a>çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹</h3><p>ä¸‹é¢ä»£ç æ˜¯ <code>ThreadPoolExecutor</code> ç±»</p>
<figure class="highlight java"><figcaption><span>executeæ–¹æ³•</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">        <span class="comment">// 1. åˆ›å»ºçº¿ç¨‹çš„æ ¸å¿ƒæ–¹æ³•</span></span><br><span class="line">        <span class="keyword">if</span> (addWorker(command, <span class="literal">true</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        c = ctl.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ•°é‡å¤§äºæ ¸å¿ƒæ•°é‡ï¼Œåˆ™å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">recheck</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">// å†æ¬¡æ£€æŸ¥å¦‚æœçº¿ç¨‹æ± ä¸æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œåˆ™å°†æ·»åŠ åˆ°é˜Ÿåˆ—çš„ä»»åŠ¡ç§»é™¤æ‰ï¼Œå¹¶ä¸”æ‰§è¡Œæ‹’ç»ç­–ç•¥</span></span><br><span class="line">        <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">            reject(command);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">            addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="literal">false</span>))</span><br><span class="line">        reject(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ·»åŠ çº¿ç¨‹è¿›è¡Œæ‰§è¡Œä¸»è¦æ˜¯åœ¨ <code>addWorker()</code> æ–¹æ³•ä¸­ï¼Œæ‰€ä»¥ç»§ç»­çœ‹ <code>addWorkder()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">addWorker</span><span class="params">(Runnable firstTask, <span class="type">boolean</span> core)</span> &#123;</span><br><span class="line">    retry:</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();;) &#123;</span><br><span class="line">        <span class="comment">// çº¿ç¨‹æ± æ­£åœ¨å…³é—­æˆ–å·²ç»å…³é—­æ—¶å°±ä¸è¿è¡Œæ·»åŠ æ–°ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (runStateAtLeast(c, SHUTDOWN)</span><br><span class="line">            &amp;&amp; (runStateAtLeast(c, STOP)</span><br><span class="line">                || firstTask != <span class="literal">null</span></span><br><span class="line">                || workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">if</span> (workerCountOf(c)</span><br><span class="line">                &gt;= ((core ? corePoolSize : maximumPoolSize) &amp; COUNT_MASK))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">break</span> retry;</span><br><span class="line">            c = ctl.get();  <span class="comment">// Re-read ctl</span></span><br><span class="line">            <span class="keyword">if</span> (runStateAtLeast(c, SHUTDOWN))</span><br><span class="line">                <span class="keyword">continue</span> retry;</span><br><span class="line">            <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerStarted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerAdded</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">Worker</span> <span class="variable">w</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// workerç±»åŒ…å«Thread å’Œ Runnable Task</span></span><br><span class="line">        w = <span class="keyword">new</span> <span class="title class_">Worker</span>(firstTask);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> w.thread;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">                <span class="comment">// çº¿ç¨‹æ± è¿˜åœ¨è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">                <span class="keyword">if</span> (isRunning(c) ||</span><br><span class="line">                    (runStateLessThan(c, STOP) &amp;&amp; firstTask == <span class="literal">null</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (t.getState() != Thread.State.NEW)</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalThreadStateException</span>();</span><br><span class="line">                    workers.add(w);</span><br><span class="line">                    workerAdded = <span class="literal">true</span>;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> workers.size();</span><br><span class="line">                    <span class="keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                        largestPoolSize = s;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (workerAdded) &#123;</span><br><span class="line">                <span class="comment">// æ·»åŠ æˆåŠŸå°±å¯åŠ¨çº¿ç¨‹å¼€å§‹æ‰§è¡Œ</span></span><br><span class="line">                t.start();</span><br><span class="line">                workerStarted = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">            addWorkerFailed(w);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workerStarted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Worker ç±»ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Worker(Runnable firstTask) &#123;</span><br><span class="line">    setState(-<span class="number">1</span>); <span class="comment">// inhibit interrupts until runWorker</span></span><br><span class="line">    <span class="built_in">this</span>.firstTask = firstTask;</span><br><span class="line">    <span class="built_in">this</span>.thread = getThreadFactory().newThread(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Delegates main run loop to outer runWorker. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    runWorker(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">runWorker</span><span class="params">(Worker w)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">wt</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> w.firstTask;</span><br><span class="line">    w.firstTask = <span class="literal">null</span>;</span><br><span class="line">    w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">completedAbruptly</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚ä½•ä¿è¯çº¿ç¨‹ä¸ä¼šè¢«å›æ”¶å‘¢ï¼Ÿå°±æ˜¯é€šè¿‡ä¸€ä¸ª while å¾ªç¯ï¼Œä¸è®©çº¿ç¨‹é€€å‡º run æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// å¦‚ä½•ä¿è¯çº¿ç¨‹åœ¨ç©ºé—²æ—¶ä¸å ç”¨cpuå‘¢ï¼Œå®ç°é€»è¾‘å°±æ˜¯åœ¨ getTask() æ–¹æ³•é‡Œé¢ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ä»»åŠ¡å°±é˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line">        <span class="comment">// å¦‚ä½•å®ç°çº¿ç¨‹çš„å›æ”¶å‘¢ï¼Ÿè¿™ä¸ªå…³é”®ç‚¹å°±æ˜¯ while æ¡ä»¶çš„åˆ¤æ–­ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶å°±ä¼šé€€å‡º while å¾ªç¯ï¼Œå½“å‰çº¿ç¨‹æ‰§è¡Œå®Œäº†ï¼Œçº¿ç¨‹å°±ä¼šè¢«jvmå›æ”¶æ‰</span></span><br><span class="line">        <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = getTask()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            w.lock();</span><br><span class="line">            <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                    (Thread.interrupted() &amp;&amp;</span><br><span class="line">                    runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                !wt.isInterrupted())</span><br><span class="line">                wt.interrupt();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                beforeExecute(wt, task);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    task.run();</span><br><span class="line">                    afterExecute(task, <span class="literal">null</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                    afterExecute(task, ex);</span><br><span class="line">                    <span class="keyword">throw</span> ex;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                task = <span class="literal">null</span>;</span><br><span class="line">                w.completedTasks++;</span><br><span class="line">                w.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        completedAbruptly = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// çº¿ç¨‹æ± ä¸­çº¿ç¨‹è¢«å›æ”¶çš„é€»è¾‘</span></span><br><span class="line">        processWorkerExit(w, completedAbruptly);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«å›æ”¶çš„"><a href="#çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«å›æ”¶çš„" class="headerlink" title="çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«å›æ”¶çš„"></a>çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«å›æ”¶çš„</h3><pre class="mermaid">sequenceDiagram
    participant A as ThreadPoolExecutor[A]
    participant B as ThreadPoolExecutor[B]
    participant C as Worker[C]
    participant D as Worker[D]
    participant E as Worker[E]
    A->>B: execute()
    B->>C: addWorker(Runnable firstTask, boolean core)
    Note over B,C: Workerç±»åŒ…å«Threadå’ŒTask
    C->>D: runWorker(Worker)
    Note over C,D: runWorker()ä¸­æœ‰whileï¼Œä¿è¯çº¿ç¨‹çš„å¤ç”¨
    D->>E: getTask()
    Note over D,E: è·å–ä¸åˆ°ä»»åŠ¡ä¼šé˜»å¡</pre>
<p>åœ¨ä¸Šé¢æ—¶åºå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ <code>Worker.runWorker()</code>  æ–¹æ³•ä¸­ä¼šä¸æ–­çš„å¾ªç¯ï¼Œä¿è¯çº¿ç¨‹å¯ä»¥å¤ç”¨ï¼ŒåŒæ—¶åœ¨ <code>getTask()</code> ä¸­åšæ˜¯å¦è¦é€€å‡ºå¾ªç¯çš„æ¡ä»¶çš„åˆ¤æ–­</p>
<ol>
<li>é˜»å¡é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡äº†</li>
<li>å·²ç»è¶…è¿‡äº†è®¾ç½®çš„ç©ºé—²æ—¶é—´</li>
</ol>
<p>è¿™æ ·å°±å¯ä»¥é€€å‡ºè®© Thread çš„run æ–¹æ³•æµç¨‹èµ°å®Œï¼Œé€€å‡º run æ–¹æ³•ä¹‹åç›¸å½“äºè¿™ä¸ªçº¿ç¨‹å°±è¢«å›æ”¶äº†</p>
]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>å¤šçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢åŒ…å«å“ªäº›å†…å®¹</title>
    <url>/2023/c51368ba5d47/index.html</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>cpu</code> ä¸çŸ¥é“ä»€ä¹ˆæ˜¯è¿›ç¨‹å’Œçº¿ç¨‹ï¼Œ<code>cpu</code> åªçŸ¥é“ä¸¤ä»¶äº‹æƒ…</p>
<ol>
<li>ä»å†…å­˜ä¸­å–å‡ºæŒ‡ä»¤</li>
<li>æ‰§è¡ŒæŒ‡ä»¤</li>
<li>ä¸€ç›´é‡å¤ä¸Šé¢ä¸¤ä¸ªæ­¥éª¤ï¼Œæ‰€ä»¥ <strong>å–æŒ‡ä»¤</strong>-&gt; <strong>æ‰§è¡ŒæŒ‡ä»¤</strong> å°±æ˜¯ <code>cpu</code> æ‰€èƒ½åšçš„æ‰€æœ‰äº‹æƒ…</li>
</ol>
<h2 id="cpu-è·å–æŒ‡ä»¤æ‰§è¡Œçš„æµç¨‹"><a href="#cpu-è·å–æŒ‡ä»¤æ‰§è¡Œçš„æµç¨‹" class="headerlink" title="cpu è·å–æŒ‡ä»¤æ‰§è¡Œçš„æµç¨‹"></a>cpu è·å–æŒ‡ä»¤æ‰§è¡Œçš„æµç¨‹</h2><ol>
<li>ç¼–å†™æºä»£ç ï¼Œæºä»£ç ä¸­éƒ½ä¼šæœ‰ main å‡½æ•°ï¼Œè¿™ä¸ª main å‡½æ•°å°±æ˜¯æ‰§è¡Œå…¥å£</li>
<li>ç¨‹åºå¯åŠ¨åï¼Œä¼šå°† main å‡½æ•°çš„ç¬¬ä¸€æ¡æœºå™¨æŒ‡ä»¤æ”¾å…¥ pc å¯„å­˜å™¨ä¸­ï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰</li>
<li>pc å¯„å­˜å™¨çš„åœ°å€é»˜è®¤æ˜¯è‡ªåŠ¨ +1ï¼Œ åˆå§‹åœ°å€å°±æ˜¯ main å‡½æ•°çš„æŒ‡ä»¤åœ°å€</li>
<li>å½“é‡åˆ° if else ç­‰è¯­å¥æ—¶ç¨‹åºä¼šæ ¹æ®è®¡ç®—ç»“æœæˆ–è€…æŒ‡ä»¤ä¸­æŒ‡å®šçš„è·³è½¬åœ°å€æ¥åŠ¨æ€æ”¹å˜ pc å¯„å­˜å™¨ä¸­çš„å€¼</li>
</ol>
<h2 id="è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«"><a href="#è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«" class="headerlink" title="è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«"></a>è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«</h2><ol>
<li>è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿåˆ†é…èµ„æºçš„æœ€å°å•ä½</li>
<li>çº¿ç¨‹æ˜¯è°ƒç”¨çš„åŸºæœ¬å•ä½ï¼Œçº¿ç¨‹ä¹‹é—´å…±äº«è¿›ç¨‹èµ„æº<ol>
<li>çº¿ç¨‹ä¹‹é—´å…±äº«äº†å“ªäº›èµ„æº<ol>
<li>å †åŒº</li>
<li>ä»£ç åŒº</li>
<li>æ•°æ®åŒºï¼šå­˜æ”¾çš„å°±æ˜¯å…¨å±€å˜é‡</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡"><a href="#ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡" class="headerlink" title="ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡"></a>ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡</h2><ol>
<li>çº¿ç¨‹ä¸Šä¸‹æ–‡å°±æ˜¯æŒ‡çº¿ç¨‹åœ¨æŸä¸ªæ—¶åˆ»çš„çŠ¶æ€ï¼Œæˆ–è€…è¯´æŸä¸ªæ—¶åˆ»çš„æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®æ˜¯çº¿ç¨‹ç§æœ‰çš„æ‰èƒ½ç§°ä¸ºæ˜¯çº¿ç¨‹çš„ä¸Šä¸‹æ–‡</li>
<li>è¦çœ‹çº¿ç¨‹ä¸Šä¸‹æ–‡åŒ…å«å“ªäº›ä¿¡æ¯ï¼Œå°±éœ€è¦çœ‹å“ªäº›æ•°æ®éƒ½æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œè¿™äº›çº¿ç¨‹ç§æœ‰çš„æ•°æ®æ•´ä½“å°±æ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡</li>
</ol>
<h3 id="çº¿ç¨‹çš„ç§æœ‰æ•°æ®æœ‰å“ªäº›"><a href="#çº¿ç¨‹çš„ç§æœ‰æ•°æ®æœ‰å“ªäº›" class="headerlink" title="çº¿ç¨‹çš„ç§æœ‰æ•°æ®æœ‰å“ªäº›"></a>çº¿ç¨‹çš„ç§æœ‰æ•°æ®æœ‰å“ªäº›</h3><p>çº¿ç¨‹æœ¬è´¨å°±æ˜¯å‡½æ•°çš„æ‰§è¡Œï¼Œå‡½æ•°æ‰§è¡Œçš„ä¿¡æ¯éƒ½æ˜¯æ”¾åœ¨æ ˆå¸§ä¸­ï¼Œæ ˆå¸§ä¸»è¦åŒ…å«å¦‚ä¸‹å†…å®¹</p>
<ol>
<li>å½“å‰å‡½æ•°çš„è¿”å›å€¼</li>
<li>è°ƒç”¨å…¶ä»–å‡½æ•°çš„å‚æ•°ï¼ˆå¯„å­˜å™¨ä¸å¤Ÿæ—¶å‚æ•°æ˜¯ä¼šæ”¾åœ¨æ ˆå¸§ä¸­çš„ï¼‰</li>
<li>å‡½æ•°ä½¿ç”¨çš„å±€éƒ¨å˜é‡</li>
<li>å‡½æ•°ä½¿ç”¨çš„å¯„å­˜å™¨ä¿¡æ¯</li>
<li>ç¨‹åºè®¡æ•°å™¨æ˜¯çº¿ç¨‹ç§æœ‰çš„</li>
<li>æ ˆæŒ‡é’ˆï¼ˆè¯¥çº¿ç¨‹æ ˆåŒºçš„æ ˆé¡¶ä½ç½®ï¼‰</li>
<li>æ‰§è¡Œå‡½æ•°æ—¶æ‰€ä½¿ç”¨çš„å¯„å­˜å™¨ä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„</li>
</ol>
<p>æ‰€æœ‰ä¸Šé¢è¿™äº›ä¿¡æ¯åŒ…å«åœ¨ä¸€èµ·å°±æ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡</p>
<h2 id="å¸¸ç”¨çš„å‡ ç§å¯„å­˜å™¨"><a href="#å¸¸ç”¨çš„å‡ ç§å¯„å­˜å™¨" class="headerlink" title="å¸¸ç”¨çš„å‡ ç§å¯„å­˜å™¨"></a>å¸¸ç”¨çš„å‡ ç§å¯„å­˜å™¨</h2><ol>
<li>æ ˆå¯„å­˜å™¨<ol>
<li>å‡½æ•°è¿è¡Œæ—¶éƒ½æœ‰ä¸€ä¸ªæ ˆå¸§ï¼Œå¯¹äºæ ˆæ¥è¯´é‡è¦çš„ä¿¡æ¯ä¹‹ä¸€å°±æ˜¯æ ˆé¡¶ï¼Œæ ˆå¯„å­˜å™¨å°±æ˜¯ä¿å­˜æ ˆé¡¶ä¿¡æ¯çš„</li>
</ol>
</li>
<li>æŒ‡ä»¤å¯„å­˜å™¨ï¼ˆpcå¯„å­˜å™¨ï¼‰</li>
<li>çŠ¶æ€å¯„å­˜å™¨ï¼Œçº¿ç¨‹æ˜¯è¿è¡Œåœ¨å†…æ ¸æ€è¿˜æ˜¯ç”¨æˆ·æ€çš„ä¿¡æ¯ä¿å­˜åœ¨çŠ¶æ€å¯„å­˜å™¨ä¸­</li>
</ol>
]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu23.04å®‰è£…jdkå’Œmaven</title>
    <url>/2023/e6e83576f25e/index.html</url>
    <content><![CDATA[<h2 id="å®‰è£…-jdk17"><a href="#å®‰è£…-jdk17" class="headerlink" title="å®‰è£… jdk17"></a>å®‰è£… jdk17</h2><p><a href="http://www.codebaoku.com/jdk/jdk-index.html">jdké•œåƒä¸‹è½½åœ°å€</a></p>
<ul>
<li>ä¸‹è½½ <code>jdk-17.0.7_linux-x64_bin.tar.gz</code></li>
<li>å°†åŒ…ä¸Šä¼ åˆ° <code>Ubuntu</code> ä¸­ï¼Œæ¯”å¦‚è¿™é‡Œä¸Šä¼ åˆ°äº† <code>/opt/software</code> ç›®å½•ä¸‹<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/software</span><br><span class="line">tar -zxvf jdk-17.0.7_linux-x64_bin.tar.gz</span><br><span class="line">sudo vim /etc/profile</span><br></pre></td></tr></table></figure>
ç„¶åå°†ä¸‹é¢å†…å®¹å¤åˆ¶åˆ° <code>/etc/profile</code> ä¸­<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /opt/software/jdk-17.0.7 å°±æ˜¯ä¸Šé¢è§£å‹çš„ jdk ç›®å½•</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/software/jdk-17.0.7</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br></pre></td></tr></table></figure>
ä¿å­˜é€€å‡ºï¼Œæ‰§è¡Œ <code>source /etc/profile</code> </li>
<li>éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -version</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="å®‰è£…-maven"><a href="#å®‰è£…-maven" class="headerlink" title="å®‰è£… maven"></a>å®‰è£… maven</h2><p><a href="https://mirrors.aliyun.com/apache/maven/">é˜¿é‡Œäº‘mavneé•œåƒç«™</a><br><a href="https://maven.apache.org/download.cgi">mavenå®˜ç½‘ä¸‹è½½</a></p>
<ul>
<li>ä¸‹è½½ <code>apache-maven-3.9.6-bin.tar.gz</code></li>
<li>ä¸Šä¼ åˆ° <code>Ubuntu</code> ä¸­ï¼Œè¿™é‡Œæ˜¯ä¸Šä¼ åˆ° <code>/opt/software</code> ç›®å½•ä¸‹<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/software</span><br><span class="line">tar -zxvf apache-maven-3.9.6-bin.tar.gz</span><br><span class="line">sudo vim /etc/profile</span><br></pre></td></tr></table></figure>
ç„¶åå°†ä¸‹é¢å†…å®¹å¤åˆ¶åˆ° <code>/etc/profile</code> æœ«å°¾<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> MAVEN_HOME=/opt/software/apache-maven-3.9.6</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$MAVEN_HOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>
éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn -v</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntuä¸­è®¾ç½®ç¯å¢ƒå˜é‡çš„å‡ ç§æ–¹å¼</title>
    <url>/2023/1f7648c2ff11/index.html</url>
    <content><![CDATA[<h2 id="å½“å‰ç»ˆç«¯æœ‰æ•ˆ"><a href="#å½“å‰ç»ˆç«¯æœ‰æ•ˆ" class="headerlink" title="å½“å‰ç»ˆç«¯æœ‰æ•ˆ"></a>å½“å‰ç»ˆç«¯æœ‰æ•ˆ</h2> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  ç›´æ¥åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œï¼Œåˆ™å¯ä»¥åœ¨å½“å‰ç»ˆç«¯çš„ä»»æ„ç›®å½•ä½¿ç”¨ mysql å‘½ä»¤</span></span><br><span class="line"><span class="built_in">export</span> PATH=/opt/mysql/bin:PATH</span><br></pre></td></tr></table></figure>

<h2 id="å½“å‰ç”¨æˆ·æœ‰æ•ˆ"><a href="#å½“å‰ç”¨æˆ·æœ‰æ•ˆ" class="headerlink" title="å½“å‰ç”¨æˆ·æœ‰æ•ˆ"></a>å½“å‰ç”¨æˆ·æœ‰æ•ˆ</h2><h3 id="ä¿®æ”¹-bashrc-æ–‡ä»¶"><a href="#ä¿®æ”¹-bashrc-æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ ~/.bashrc æ–‡ä»¶"></a>ä¿®æ”¹ <code>~/.bashrc</code> æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim ~/.bashrc</span><br><span class="line"><span class="built_in">export</span> PATH=/opt/mysql/bin:PATH</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿å­˜é€€å‡ºåï¼Œæ‰§è¡Œ source ~/.bashrc å‘½ä»¤ä½¿å…¶ç«‹å³ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹å¼æ°¸ä¹…ç”Ÿæ•ˆ</p>
<h2 id="ç³»ç»Ÿçº§åˆ«æœ‰æ•ˆ"><a href="#ç³»ç»Ÿçº§åˆ«æœ‰æ•ˆ" class="headerlink" title="ç³»ç»Ÿçº§åˆ«æœ‰æ•ˆ"></a>ç³»ç»Ÿçº§åˆ«æœ‰æ•ˆ</h2><h3 id="ä¿®æ”¹-etc-profile-æ–‡ä»¶"><a href="#ä¿®æ”¹-etc-profile-æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ /etc/profile æ–‡ä»¶"></a>ä¿®æ”¹ <code>/etc/profile</code> æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"><span class="built_in">export</span> PATH=/opt/mysql/bin:PATH</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿å­˜é€€å‡ºåï¼Œæ‰§è¡Œ source /etc/profile å‘½ä»¤ä½¿å…¶ç«‹å³ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹å¼æ°¸ä¹…ç”Ÿæ•ˆï¼Œå¹¶ä¸”å¯¹æ‰€æœ‰ç”¨æˆ·æœ‰æ•ˆ</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>vmwareä¸­Ubuntu23.04è®¾ç½®é™æ€ip</title>
    <url>/2023/928cb00f8073/index.html</url>
    <content><![CDATA[<h2 id="æŸ¥çœ‹ç½‘å¡åç§°"><a href="#æŸ¥çœ‹ç½‘å¡åç§°" class="headerlink" title="æŸ¥çœ‹ç½‘å¡åç§°"></a>æŸ¥çœ‹ç½‘å¡åç§°</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ip a</span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚æŸ¥è¯¢çš„ç»“æœæ˜¯ <code>ens33</code></p>
<h2 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lg@lg:~$ <span class="built_in">cd</span> /etc/netplan/</span><br><span class="line">lg@lg:/etc/netplan$ ll</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x  2 root root 4096 Dec 13 15:56 ./</span><br><span class="line">drwxr-xr-x 98 root root 4096 Dec 13 15:32 ../</span><br><span class="line">-rw-r--r--  1 root root  301 Dec 13 15:56 00-installer-config.yaml</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>/etc/netplan</code> ç›®å½•ä¸‹ï¼Œçœ‹åˆ°æœ‰ä¸€ä¸ª <code>00-installer-config.yaml</code> æ–‡ä»¶ï¼Œé…ç½®é™æ€ <code>ip</code> å°±æ˜¯è¦ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶</p>
<p>åˆ é™¤è¿™ä¸ªæ–‡ä»¶å†…å®¹ï¼Œç„¶åå°†ä¸‹é¢å†…å®¹å¤åˆ¶åˆ°æ–‡ä»¶ä¸­, éœ€è¦</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="comment"># è¿™é‡Œçš„ ens33 æ˜¯ç½‘å¡åç§°ï¼Œå°±æ˜¯ç¬¬ä¸€æ­¥ä¸­ä½¿ç”¨ ip a æŸ¥çœ‹çš„ç»“æœ</span></span><br><span class="line">    <span class="attr">ens33:</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">no</span></span><br><span class="line">      <span class="attr">dhcp6:</span> <span class="literal">no</span></span><br><span class="line">      <span class="attr">addresses:</span></span><br><span class="line">        <span class="comment"># è¿™é‡Œçš„ 192.168.119.129 æ˜¯é™æ€ ip åœ°å€ï¼Œå¯¹åº”çš„ç½‘æ®µæ˜¯æ ¹æ®ç½‘å…³æ¥è®¾ç½®çš„ï¼Œç½‘å…³åœ°å€æ˜¯åœ¨ vmwareä¸­æŸ¥çœ‹</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.119</span><span class="number">.129</span><span class="string">/24</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">default</span></span><br><span class="line">          <span class="comment"># è¿™ä¸ªæ˜¯ç½‘å…³çš„åœ°å€ï¼Œéœ€è¦åˆ° vmware ä¸­å»æŸ¥çœ‹</span></span><br><span class="line">          <span class="attr">via:</span> <span class="number">192.168</span><span class="number">.119</span><span class="number">.2</span></span><br><span class="line">      <span class="attr">nameservers:</span></span><br><span class="line">        <span class="attr">addresses:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">180.76</span><span class="number">.76</span><span class="number">.76</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">renderer:</span> <span class="string">networkd</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu23.04ä¸­è®¾ç½®å…¶ä»–ç”¨æˆ·ä½¿ç”¨sudoæ— éœ€è¾“å…¥å¯†ç </title>
    <url>/2023/a60a9dfd0dd7/index.html</url>
    <content><![CDATA[<p>ç»™ <code>/etc/sudoers</code> æ·»åŠ å†™å…¥æƒé™</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> +w /etc/sudoers</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/sudoers</span><br><span class="line"><span class="comment"># Allow members of group sudo to execute any command, è¿™é‡Œçš„lgå°±æ˜¯å½“å‰éœ€è¦å…è¾“å…¥å¯†ç çš„ç”¨æˆ·</span></span><br><span class="line">%lg ALL=(ALL:ALL) NOPASSWD:ALL</span><br></pre></td></tr></table></figure>

<p>å»é™¤å†™å…¥æƒé™</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> -w /etc/sudoers</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>è§£å†³vscodeæ‰¾ä¸åˆ°Pythonè‡ªå®šä¹‰æ¨¡å—æŠ¥é”™no module named</title>
    <url>/2023/05b28e23ee5b/index.html</url>
    <content><![CDATA[<p>åœ¨ <code>.vscode</code> ç›®å½•ä¸‹ï¼ˆè‹¥æ²¡æœ‰åˆ™æ–°å»ºï¼‰çš„ <code>launch.json</code> ä¸­æ·»åŠ  <code>env</code> ç›¸å…³å†…å®¹ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;0.2.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;configurations&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;update_package&quot;</span>,</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;python&quot;</span>,</span><br><span class="line">            <span class="string">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">            <span class="string">&quot;program&quot;</span>: <span class="string">&quot;timeline\\ssh\\win_command.py&quot;</span>,</span><br><span class="line">            <span class="string">&quot;console&quot;</span>: <span class="string">&quot;integratedTerminal&quot;</span>,</span><br><span class="line">            <span class="string">&quot;justMyCode&quot;</span>: true,</span><br><span class="line">            <span class="comment"># ä¸‹é¢è¿™éƒ¨åˆ†æ˜¯æ–°å¢çš„å†…å®¹</span></span><br><span class="line">            <span class="string">&quot;env&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;PYTHONPATH&quot;</span>: <span class="string">&quot;$&#123;workspaceRoot&#125;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBootä¸­ä½¿ç”¨Redis</title>
    <url>/2023/5ef02c37afab/index.html</url>
    <content><![CDATA[<p>ç‰ˆæœ¬è¯´æ˜ï¼š</p>
<ol>
<li>SpringBoot 3.x</li>
</ol>
<h2 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- springboot ç‰ˆæœ¬ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- å¼•å…¥redisä¾èµ– --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="redis-é…ç½®"><a href="#redis-é…ç½®" class="headerlink" title="redis é…ç½®"></a>redis é…ç½®</h2><ol>
<li>ä¸‹é¢ <code>redis</code> é…ç½®çš„å‰ç¼€éƒ½æ˜¯ <code>spring.data.redis</code>, å¦‚æœä½¿ç”¨çš„æ˜¯ <code>SpringBoot2.x</code> ç‰ˆæœ¬ï¼Œå‰ç¼€æ˜¯ <code>spring.redis</code><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#é»˜è®¤æ˜¯0å·åº“</span></span><br><span class="line"><span class="attr">spring.data.redis.database</span>=<span class="string">3</span></span><br><span class="line"><span class="comment"># RedisæœåŠ¡å™¨åœ°å€</span></span><br><span class="line"><span class="attr">spring.data.redis.host</span>=<span class="string">192.168.0.236</span></span><br><span class="line"><span class="comment"># RedisæœåŠ¡å™¨è¿æ¥ç«¯å£</span></span><br><span class="line"><span class="attr">spring.data.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="attr">spring.data.redis.username</span>=<span class="string">default</span></span><br><span class="line"><span class="comment"># RedisæœåŠ¡å™¨è¿æ¥å¯†ç ,é»˜è®¤ä¸ºç©º</span></span><br><span class="line"><span class="attr">spring.data.redis.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment"># è¿æ¥æ± æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line"><span class="attr">spring.data.redis.lettuce.pool.max-active</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"># è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´,é»˜è®¤-1è¡¨ç¤ºæ²¡æœ‰é™åˆ¶</span></span><br><span class="line"><span class="attr">spring.data.redis.lettuce.pool.max-wait</span>=<span class="string">-1</span></span><br><span class="line"><span class="comment"># è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥</span></span><br><span class="line"><span class="attr">spring.data.redis.lettuce.pool.max-idle</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"># è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥,é»˜è®¤æ˜¯0</span></span><br><span class="line"><span class="attr">spring.data.redis.lettuce.pool.min-idle</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="ç¼–å†™æµ‹è¯•ç±»"><a href="#ç¼–å†™æµ‹è¯•ç±»" class="headerlink" title="ç¼–å†™æµ‹è¯•ç±»"></a>ç¼–å†™æµ‹è¯•ç±»</h2><ol><li><a href="/2023/9cd70dc15320/index.html" title="SpringBootç¼–å†™æµ‹è¯•ç±»">SpringBootç¼–å†™æµ‹è¯•ç±»</a></li></ol>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(classes = TestApplication.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestRedis</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedis</span><span class="params">()</span>&#123;</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;key1&quot;</span>, <span class="string">&quot;value1&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;è·å–redis key1 çš„ç»“æœ:&quot;</span> + o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ <code>redis</code> å®¢æˆ·ç«¯çœ‹ä¸€ä¸‹è¿™ä¸ª <code>key</code> å’Œ <code>value</code></p>
<figure class="highlight wren"><table><tr><td class="code"><pre><span class="line">[<span class="variable">db3</span>] <span class="operator">&gt;</span> <span class="variable">get</span> <span class="title function_">key1</span></span><br><span class="line">(<span class="variable">nil</span>)</span><br><span class="line"></span><br><span class="line">[<span class="variable">db3</span>] <span class="operator">&gt;</span> <span class="variable">keys</span> <span class="operator">*</span><span class="variable">key1</span><span class="operator">*</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;\xac\xed<span class="char escape_">\x00</span><span class="char escape_">\x05</span>t<span class="char escape_">\x00</span><span class="char escape_">\x04</span>key1&quot;</span></span><br><span class="line"></span><br><span class="line">[<span class="variable">db3</span>] <span class="operator">&gt;</span> <span class="variable">keys</span> <span class="operator">*</span><span class="variable">key1</span><span class="operator">*</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;\xac\xed<span class="char escape_">\x00</span><span class="char escape_">\x05</span>t<span class="char escape_">\x00</span><span class="char escape_">\x04</span>key1&quot;</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ç›´æ¥ä½¿ç”¨ <code>key1</code> ç«Ÿç„¶è·å–ä¸åˆ°æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹ŸåŒ¹é…åèƒ½çœ‹åˆ°ï¼Œå‘ç°éƒ½æ˜¯è¿›è¡Œäº†ç¼–ç ï¼Œè¿™æ˜¯å› ä¸º <code>RedisTemplate</code> é»˜è®¤ä½¿ç”¨ <code>jdk</code> çš„åºåˆ—åŒ–æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡è‡ªå®šä¹‰ <code>RedisTemplate</code> æ–¹å¼æ¥ä¿®æ”¹åºåˆ—åŒ–æ–¹å¼</p>
<h2 id="è‡ªå®šä¹‰-RedisTemplate"><a href="#è‡ªå®šä¹‰-RedisTemplate" class="headerlink" title="è‡ªå®šä¹‰ RedisTemplate"></a>è‡ªå®šä¹‰ RedisTemplate</h2><p>ä¸‹é¢ä»£ç å°† <code>RedisTemplate</code> ä¿®æ”¹æˆä½¿ç”¨ <code>json</code> æ–¹å¼è¿›è¡Œåºåˆ—åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CusConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory factory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        template.setConnectionFactory(factory);</span><br><span class="line">        <span class="type">Jackson2JsonRedisSerializer</span> <span class="variable">jackson2JsonRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>(Object.class);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">om</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.activateDefaultTyping(LaissezFaireSubTypeValidator.instance , ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        om.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="literal">false</span>);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line">        <span class="type">StringRedisSerializer</span> <span class="variable">stringRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        <span class="comment">// keyé‡‡ç”¨Stringçš„åºåˆ—åŒ–æ–¹å¼</span></span><br><span class="line">        template.setKeySerializer(stringRedisSerializer);</span><br><span class="line">        <span class="comment">// hashçš„keyä¹Ÿé‡‡ç”¨Stringçš„åºåˆ—åŒ–æ–¹å¼</span></span><br><span class="line">        template.setHashKeySerializer(stringRedisSerializer);</span><br><span class="line">        <span class="comment">// valueåºåˆ—åŒ–æ–¹å¼é‡‡ç”¨jackson</span></span><br><span class="line">        template.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        <span class="comment">// hashçš„valueåºåˆ—åŒ–æ–¹å¼é‡‡ç”¨jackson</span></span><br><span class="line">        template.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œæµ‹è¯•ä»£ç åå†æ¬¡æŸ¥çœ‹ç»“æœ</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">[db3] <span class="operator">&gt;</span> <span class="keyword">get</span> key1</span><br><span class="line"><span class="string">&quot;<span class="subst">\&quot;</span>value1<span class="subst">\&quot;</span>&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>redisåˆ†å¸ƒå¼é”</title>
    <url>/2023/c21b41047d75/index.html</url>
    <content><![CDATA[<h2 id="redis-åˆ†å¸ƒå¼é”è¦åšåˆ°çš„äº‹æƒ…"><a href="#redis-åˆ†å¸ƒå¼é”è¦åšåˆ°çš„äº‹æƒ…" class="headerlink" title="redis åˆ†å¸ƒå¼é”è¦åšåˆ°çš„äº‹æƒ…"></a>redis åˆ†å¸ƒå¼é”è¦åšåˆ°çš„äº‹æƒ…</h2><ol>
<li>ç‹¬å æ€§ï¼š ä»»ä½•æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰</li>
<li>é«˜å¯ç”¨ï¼š è‹¥åœ¨ <code>redis</code> é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œä¸èƒ½å› ä¸ºæŸä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†è€Œå‡ºç°è·å–é”å’Œé‡Šæ”¾é”å¤±è´¥çš„æƒ…å†µ</li>
<li>é˜²æ­¢æ­»é”ï¼š è¦æœ‰è¶…æ—¶æ§åˆ¶æœºåˆ¶æˆ–è€…æ’¤é”€æ“ä½œ</li>
<li>æ­£ç¡®æ€§ï¼š ä¸èƒ½ <code>unlock</code> åˆ«äººçš„é”ï¼Œè‡ªå·±çš„é”åªèƒ½è‡ªå·±é‡Šæ”¾</li>
<li>å¯é‡å…¥</li>
</ol>
<h2 id="åˆ†å¸ƒå¼é”çš„å®ç°"><a href="#åˆ†å¸ƒå¼é”çš„å®ç°" class="headerlink" title="åˆ†å¸ƒå¼é”çš„å®ç°"></a>åˆ†å¸ƒå¼é”çš„å®ç°</h2><p><a href="https://redis.io/docs/manual/patterns/distributed-locks/">redisåˆ†å¸ƒå¼é”å®˜æ–¹æ–‡æ¡£</a><br>ä¸‹é¢ä¸€æ®µæ˜¯å®˜ç½‘å¯¹ <code>redis</code> åˆ†å¸ƒå¼é”çš„ç©†æè¿°</p>
<ol>
<li>ä½¿ç”¨çš„ç®—æ³•æ˜¯ <code>Redlock</code></li>
<li><code>Java</code> ç‰ˆæœ¬å¯¹ <code>Redlock</code> çš„å®ç°æ˜¯ <code>Redisson</code><blockquote>
<p>This page describes a more canonical algorithm to implement distributed locks with Redis. We propose an algorithm, called Redlock, which implements a DLM which we believe to be safer than the vanilla single instance approach. We hope that the community will analyze it, provide feedback, and use it as a starting point for the implementations or more complex or alternative designs.</p>
</blockquote>
</li>
</ol>
<p><a href="https://github.com/redisson/redisson">å®˜ç½‘æè¿°çš„redissonåˆ†å¸ƒå¼å®ç°</a><br>è¿™é‡Œé¢æœ‰å¾ˆå¤šå®ç°ï¼Œæ¯”å¦‚ <code>Spring Data Redis</code>, <code>Spring Boot Starter</code> ç­‰ï¼Œæˆ‘ä»¬é€‰æ‹©<a href="https://github.com/redisson/redisson/tree/master/redisson-spring-boot-starter">Spring Boot Starter</a> è¿™ä¸ª</p>
<h3 id="æ·»åŠ ä¾èµ–"><a href="#æ·»åŠ ä¾èµ–" class="headerlink" title="æ·»åŠ ä¾èµ–"></a>æ·»åŠ ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.24.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="rediså‚æ•°é…ç½®"><a href="#rediså‚æ•°é…ç½®" class="headerlink" title="rediså‚æ•°é…ç½®"></a>rediså‚æ•°é…ç½®</h3><div class="tabs" id="rediså‚æ•°é…ç½®"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="rediså‚æ•°é…ç½®-1">SpringBoot3.xç‰ˆæœ¬</button><button type="button" class="tab " data-href="rediså‚æ•°é…ç½®-2">SpringBoot2.xç‰ˆæœ¬</button></ul><div class="tab-contents"><div class="tab-item-content active" id="rediså‚æ•°é…ç½®-1"><ol>
<li><p>redis å‚æ•°é…ç½®</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring.data.redis.database</span>=<span class="string">3</span></span><br><span class="line"><span class="attr">spring.data.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="attr">spring.data.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="attr">spring.data.redis.username</span>=<span class="string">default</span></span><br><span class="line"><span class="attr">spring.data.redis.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="attr">spring.data.redis.lettuce.pool.max-active</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">spring.data.redis.lettuce.pool.max-wait</span>=<span class="string">-1</span></span><br><span class="line"><span class="attr">spring.data.redis.lettuce.pool.max-idle</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">spring.data.redis.lettuce.pool.min-idle</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>redisson é…ç½®</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring.data.redis.redisson.singleServerConfig.pool.max-active</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">spring.data.redis.redisson.singleServerConfig.pool.max-wait</span>=<span class="string">-1</span></span><br><span class="line"><span class="attr">spring.data.redis.redisson.singleServerConfig.pool.max-idle</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">spring.data.redis.redisson.singleServerConfig.pool.min-idle</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">spring.data.redis.redisson.singleServerConfig.address</span>=<span class="string">&quot;redis://127.0.0.1:6379&quot;</span></span><br><span class="line"><span class="attr">spring.data.redis.redisson.singleServerConfig.databse</span>=<span class="string">3</span></span><br><span class="line"><span class="attr">spring.data.redis.redisson.singleServerConfig.password</span>=<span class="string">123456</span></span><br></pre></td></tr></table></figure></li>
</ol></div><div class="tab-item-content" id="rediså‚æ•°é…ç½®-2"><ol>
<li><p>redis å‚æ•°é…ç½®</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring.data.redis.database</span>=<span class="string">3</span></span><br><span class="line"><span class="attr">spring.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="attr">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="attr">spring.redis.username</span>=<span class="string">default</span></span><br><span class="line"><span class="attr">spring.redis.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.max-active</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.max-wait</span>=<span class="string">-1</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.max-idle</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.min-idle</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>redisson é…ç½®</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring.redis.redisson.singleServerConfig.pool.max-active</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">spring.redis.redisson.singleServerConfig.pool.max-wait</span>=<span class="string">-1</span></span><br><span class="line"><span class="attr">spring.redis.redisson.singleServerConfig.pool.max-idle</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">spring.redis.redisson.singleServerConfig.pool.min-idle</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">spring.redis.redisson.singleServerConfig.address</span>=<span class="string">&quot;redis://127.0.0.1:6379&quot;</span></span><br><span class="line"><span class="attr">spring.redis.redisson.singleServerConfig.databse</span>=<span class="string">3</span></span><br><span class="line"><span class="attr">spring.redis.redisson.singleServerConfig.password</span>=<span class="string">123456</span></span><br></pre></td></tr></table></figure></li>
</ol></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<p>ä½¿ç”¨ä¸Šè¿°é…ç½®ä¹‹åï¼Œåœ¨ <code>Spring Boot</code> ç¯å¢ƒä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨å¦‚ä¸‹çš„å‡ ä¸ª <code>Bean</code> </p>
<ul>
<li><code>RedissonClient</code></li>
<li><code>RedissonRxClient</code></li>
<li><code>RedissonReactiveClient</code></li>
<li><code>RedisTemplate</code></li>
<li><code>ReactiveRedisTemplate</code></li>
</ul>
<h3 id="åˆ†å¸ƒå¼é”ä»£ç ç¤ºä¾‹"><a href="#åˆ†å¸ƒå¼é”ä»£ç ç¤ºä¾‹" class="headerlink" title="åˆ†å¸ƒå¼é”ä»£ç ç¤ºä¾‹"></a>åˆ†å¸ƒå¼é”ä»£ç ç¤ºä¾‹</h3><p>ä¸‹é¢ä»£ç å®é™…ä½¿ç”¨çš„è¿˜æ˜¯å•æœºä¸­çš„ç¨‹åºï¼Œä¸è¿‡ç”¨æ¥æµ‹è¯•åˆ†å¸ƒå¼é”çš„ä½¿ç”¨å·²ç»è¶³å¤Ÿäº†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestRedis</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redisson;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisLock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        List&lt;Thread&gt; threads = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; <span class="number">100</span>; k++) &#123;</span><br><span class="line">                  <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        lock = redisson.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">                        Thread.sleep(<span class="number">10</span>);</span><br><span class="line">                        lock.lock();</span><br><span class="line">                        i++;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (lock!= <span class="literal">null</span>) &#123;</span><br><span class="line">                            lock.unlock();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">            thread.start();</span><br><span class="line">            threads.add(thread);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line">            thread.join();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;æœ€ç»ˆç»“æœ:&quot;</span> + i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>rediså‘å¸ƒè®¢é˜…</title>
    <url>/2023/2d9e56a00163/index.html</url>
    <content><![CDATA[<p>å‚è€ƒ <a href="https://docs.spring.io/spring-data/redis/reference/redis/pubsub.html">Springå®˜ç½‘å¯¹rediså‘å¸ƒè®¢é˜…çš„ä»£ç å®ç°</a><br>è¯´æ˜ï¼š</p>
<ol>
<li><code>SpringBoot3.x</code> ä½¿ç”¨ <code>Redis</code> å¯ä»¥å…ˆå‚è€ƒä¸‹é¢çš„æ–‡ç« </li>
</ol>
<ol><li><a href="/2023/5ef02c37afab/index.html" title="SpringBootä¸­ä½¿ç”¨Redis">SpringBootä¸­ä½¿ç”¨Redis</a></li></ol>
<ol start="2">
<li>æ•´ä½“ä»£ç åˆ†ä¸ºä¸‰éƒ¨åˆ†</li>
<li>æ¶ˆæ¯ç›‘å¬è€… (è¿™éƒ¨åˆ†æ˜¯ä¸šåŠ¡ä»£ç ä¸­éœ€è¦ç¼–å†™çš„æ¶ˆæ¯æ¥æ”¶çš„é€»è¾‘)</li>
<li>æ³¨å†Œæ¶ˆæ¯ç›‘å¬è€… ï¼ˆè¿™éƒ¨åˆ†æ˜¯å°†è‡ªå·±ç¼–å†™çš„æ¶ˆæ¯ç›‘å¬è€…æ³¨å†Œåˆ° redis ä¸­ï¼Œä¾¿äº redis å¯ä»¥è°ƒç”¨åˆ°æˆ‘ä»¬çš„æ¶ˆæ¯ç›‘å¬ç±»ï¼‰</li>
<li>æ¶ˆæ¯å‘é€è€…</li>
</ol>
<h2 id="æ¶ˆæ¯ç›‘å¬è€…"><a href="#æ¶ˆæ¯ç›‘å¬è€…" class="headerlink" title="æ¶ˆæ¯ç›‘å¬è€…"></a>æ¶ˆæ¯ç›‘å¬è€…</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisMessageListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç›‘å¬åˆ°çš„æ¶ˆæ¯:&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ³¨å†Œæ¶ˆæ¯ç›‘å¬"><a href="#æ³¨å†Œæ¶ˆæ¯ç›‘å¬" class="headerlink" title="æ³¨å†Œæ¶ˆæ¯ç›‘å¬"></a>æ³¨å†Œæ¶ˆæ¯ç›‘å¬</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisMessageListener</span> &#123;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_SUBSCRIBE_CHANNEL</span> <span class="operator">=</span> <span class="string">&quot;redis.subscribe.channel&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisMessageListenerContainer <span class="title function_">listenerContainer</span><span class="params">(RedisConnectionFactory factory,</span></span><br><span class="line"><span class="params">                                                           MessageListenerAdapter messageListenerAdapter)</span>&#123;</span><br><span class="line">        <span class="type">RedisMessageListenerContainer</span> <span class="variable">container</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisMessageListenerContainer</span>();</span><br><span class="line">        container.setConnectionFactory(factory);</span><br><span class="line">        <span class="comment">//redis.subscribe.channel æ˜¯é…ç½®çš„è®¢é˜…çš„ channel, å‘é€æ—¶ä¹Ÿéœ€è¦å¾€è¿™ä¸ª channel ä¸­å‘é€</span></span><br><span class="line">        container.addMessageListener(messageListenerAdapter, <span class="keyword">new</span> <span class="title class_">PatternTopic</span>(REDIS_SUBSCRIBE_CHANNEL));</span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageListenerAdapter <span class="title function_">messageListenerAdapter</span><span class="params">(RedisMessageListener listener)</span>&#123;</span><br><span class="line">        <span class="type">MessageListenerAdapter</span> <span class="variable">messageListenerAdapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageListenerAdapter</span>(listener,</span><br><span class="line">                <span class="string">&quot;onMessage&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> messageListenerAdapter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢ä»£ç ä¸­çœ‹åˆ°å¾€ <code>RedisMessageListenerContainer</code> ç±»ä¸­æ³¨å†Œçš„å¹¶ä¸æ˜¯æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„ <code>RedisMessageListener</code>ï¼Œ è€Œæ˜¯ <code>MessageListenerAdapter</code>ï¼ˆ<code>MessageListenerAdapter</code> åŒ…è£¹äº† <code>RedisMessageListener</code>ï¼‰ï¼Œè¿™æ˜¯å› ä¸ºéœ€è¦é€šè¿‡ <code>MessageListenerAdapter</code> æ¥åšæ¶ˆæ¯é€‚é…ï¼Œæ¯”å¦‚æˆ‘ä»¬ç¼–å†™çš„ <code>RedisMessageListener</code> ç±»ä¸­ <code>onMessage(String)</code> æ–¹æ³•æ¥æ”¶ <code>String</code> ç±»å‹å‚æ•°ï¼Œä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥æ¥æ”¶ <code>String</code> ç±»å‹å‚æ•°å‘¢ï¼Ÿ å°±æ˜¯ <code>MessageListenerAdapter</code> åšäº†è½¬æ¢</p>
<h2 id="æ¶ˆæ¯å‘é€è€…"><a href="#æ¶ˆæ¯å‘é€è€…" class="headerlink" title="æ¶ˆæ¯å‘é€è€…"></a>æ¶ˆæ¯å‘é€è€…</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisPublish</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™é‡Œä½¿ç”¨convertAndSendæ–¹æ³•ï¼Œå‚æ•°ä¸º channel é€šé“å’Œå†…å®¹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(String channel, String msg)</span> &#123;</span><br><span class="line">        stringRedisTemplate.convertAndSend(channel, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¸»ç±»å¯åŠ¨å¹¶æµ‹è¯•"><a href="#ä¸»ç±»å¯åŠ¨å¹¶æµ‹è¯•" class="headerlink" title="ä¸»ç±»å¯åŠ¨å¹¶æµ‹è¯•"></a>ä¸»ç±»å¯åŠ¨å¹¶æµ‹è¯•</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> SpringApplication.run(TestApplication.class, args);</span><br><span class="line">        <span class="comment">// ä¸ºäº†è®©æ—¥å¿—åœ¨æœ€åæ‰“å°ï¼Œä¾¿äºå±•ç¤ºæ‰€ä»¥å»¶è¿Ÿ5så†å‘é€</span></span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        <span class="type">RedisPublish</span> <span class="variable">redisPublish</span> <span class="operator">=</span> applicationContext.getBean(RedisPublish.class);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            redisPublish.sendMsg(RedisConfig.REDIS_SUBSCRIBE_CHANNEL, <span class="string">&quot;æµ‹è¯•å‘é€æ•°æ®&quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ç›‘å¬åˆ°çš„æ¶ˆæ¯:<span class="string">&quot;æµ‹è¯•å‘é€æ•°æ®1&quot;</span></span><br><span class="line">ç›‘å¬åˆ°çš„æ¶ˆæ¯:<span class="string">&quot;æµ‹è¯•å‘é€æ•°æ®2&quot;</span></span><br><span class="line">ç›‘å¬åˆ°çš„æ¶ˆæ¯:<span class="string">&quot;æµ‹è¯•å‘é€æ•°æ®3&quot;</span></span><br><span class="line">ç›‘å¬åˆ°çš„æ¶ˆæ¯:<span class="string">&quot;æµ‹è¯•å‘é€æ•°æ®4&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>rediså’ŒmysqlåŒå†™ä¸€è‡´æ€§é—®é¢˜</title>
    <url>/2023/68d7307921af/index.html</url>
    <content><![CDATA[<p>å½“æ•°æ®æœ‰æ›´æ–°æ—¶ï¼Œæ˜¯å…ˆæ›´æ–°ç¼“å­˜è¿˜æ˜¯å…ˆæ›´æ–°æ•°æ®åº“ï¼Ÿæˆ–è€…æ˜¯å…¶ä»–çš„æ“ä½œï¼Ÿå¯¹äºç¼“å­˜å’Œæ•°æ®åº“çš„æ›´æ–°ç»„åˆæœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼</p>
<h2 id="å…ˆæ›´æ–°ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“"><a href="#å…ˆæ›´æ–°ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“" class="headerlink" title="å…ˆæ›´æ–°ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“"></a>å…ˆæ›´æ–°ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“</h2><p>å‡è®¾æ›´æ–°ç¼“å­˜æˆåŠŸï¼Œä½†æ˜¯æ›´æ–°æ•°æ®åº“å¤±è´¥ï¼Œç¼“å­˜ä¸­æ•°æ®å°±æ˜¯é”™è¯¯ï¼Œè€Œä¸” redis æ˜¯ä¸æ”¯æŒäº‹åŠ¡å›æ»šï¼Œæ‰€ä»¥è¿™ç§æ–¹æ¡ˆæœ‰æ¯”è¾ƒå¤§çš„ç¼ºé™·</p>
<h2 id="å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“"><a href="#å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“" class="headerlink" title="å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“"></a>å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“</h2><ol>
<li>ä½¿ç”¨è¿™ç§æ–¹æ¡ˆï¼Œå³ä½¿æ›´æ–°æ•°æ®åº“å¤±è´¥äº†ä¹Ÿä¸éœ€è¦å›æ»šç¼“å­˜ã€‚è¿™ç§åšæ³•è™½ç„¶å·§å¦™è§„é¿äº†å¤±è´¥å›æ»šçš„é—®é¢˜ï¼Œä½†æ˜¯ä¼šæœ‰å…¶ä»–çš„é—®é¢˜</li>
<li>å‡è®¾çº¿ç¨‹Aå…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“ã€‚åœ¨çº¿ç¨‹Aå®Œæˆæ›´æ–°æ•°æ®åº“ä¹‹å‰ï¼Œåæ‰§è¡Œçš„çº¿ç¨‹Båè€Œè¶…å‰å®Œæˆäº†æ“ä½œï¼Œè¯»å–Keyå‘ç°æ²¡æœ‰æ•°æ®åï¼Œå°†æ•°æ®åº“ä¸­çš„æ—§å€¼å­˜æ”¾åˆ°äº†ç¼“å­˜ä¸­ã€‚çº¿ç¨‹Aåœ¨çº¿ç¨‹Béƒ½å®Œæˆåå†æ›´æ–°æ•°æ®åº“ï¼Œè¿™æ ·å°±ä¼šå‡ºç°ç¼“å­˜ï¼ˆæ—§å€¼ï¼‰ä¸æ•°æ®åº“çš„å€¼ï¼ˆæ–°å€¼ï¼‰ä¸ä¸€è‡´çš„é—®é¢˜</li>
</ol>
<h2 id="å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜"><a href="#å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜" class="headerlink" title="å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜"></a>å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜</h2><ol>
<li>å½“æ›´æ–°æ•°æ®åº“æˆåŠŸï¼Œæ›´æ–°ç¼“å­˜å¤±è´¥æ—¶ï¼Œå¯ä»¥é‡‡å–é‡è¯•çš„ç­–ç•¥ï¼Œä½†é‡è¯•æœºåˆ¶å¦‚æœå­˜åœ¨å»¶æ—¶è¿˜æ˜¯ä¼šå‡ºç°æ•°æ®åº“ä¸ç¼“å­˜ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä¸å¥½å¤„ç†</li>
<li>å‡è®¾ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ›´æ–°åŒä¸€ä¸ªæ•°æ®ï¼Œçº¿ç¨‹Aå…ˆå®Œæˆäº†ç¬¬ä¸€æ­¥ï¼Œçº¿ç¨‹Bå…ˆå®Œæˆäº†ç¬¬äºŒæ­¥æ€ä¹ˆåŠï¼Ÿçº¿ç¨‹AæŠŠå€¼æ›´æ–°æˆaï¼Œçº¿ç¨‹BæŠŠå€¼æ›´æ–°æˆbï¼Œæ­¤æ—¶æ•°æ®åº“ä¸­çš„æœ€æ–°å€¼æ˜¯bï¼Œå› ä¸ºçº¿ç¨‹Aå…ˆå®Œæˆäº†ç¬¬ä¸€æ­¥ï¼Œåå®Œæˆç¬¬äºŒæ­¥ï¼Œæ‰€ä»¥ç¼“å­˜ä¸­çš„æœ€æ–°å€¼æ˜¯aï¼Œæ•°æ®åº“ä¸ç¼“å­˜çš„å€¼è¿˜æ˜¯ä¸ä¸€è‡´ï¼Œè¿™ä¸ªé€»è¾‘è¿˜æ˜¯æœ‰é—®é¢˜çš„</li>
</ol>
<h2 id="å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜"><a href="#å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜" class="headerlink" title="å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜"></a>å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</h2><ol>
<li>å› ä¸ºæ›´æ–°æ•°æ®åº“ä¹‹åæ˜¯åˆ é™¤ç¼“å­˜ï¼Œæ‰€ä»¥å¯ä»¥è§£å†³ <strong>å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜</strong> å¸¦æ¥çš„ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜</li>
<li>å‡è®¾çº¿ç¨‹Aè¦æ›´æ–°æ•°æ®ï¼Œå…ˆå®Œæˆç¬¬ä¸€æ­¥æ›´æ–°æ•°æ®åº“ï¼Œåœ¨çº¿ç¨‹Aåˆ é™¤ç¼“å­˜ä¹‹å‰ï¼Œçº¿ç¨‹Bè¦è®¿é—®ç¼“å­˜ï¼Œé‚£ä¹ˆå–å¾—çš„å°±æ˜¯æ—§æ•°æ®ï¼Œ ä¸è¿‡è¿™ç§æƒ…å†µå‡ºç°çš„æ¦‚ç‡æ¯”è¾ƒä½</li>
</ol>
<h2 id="å…ˆåˆ é™¤ç¼“å­˜ï¼Œæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜"><a href="#å…ˆåˆ é™¤ç¼“å­˜ï¼Œæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜" class="headerlink" title="å…ˆåˆ é™¤ç¼“å­˜ï¼Œæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜"></a>å…ˆåˆ é™¤ç¼“å­˜ï¼Œæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</h2><ol>
<li>å’Œ <strong>å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</strong> å¤„ç†æ–¹å¼ç±»ä¼¼ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¼šå‡ºç°ç±»ä¼¼çš„é—®é¢˜ï¼Œå‡è®¾çº¿ç¨‹Aè¦æ›´æ–°æ•°æ®åº“ï¼Œå…ˆåˆ é™¤äº†ç¼“å­˜ï¼Œè¿™ä¸€ç¬é—´çº¿ç¨‹Cè¦è¯»ç¼“å­˜ï¼Œå…ˆæŠŠæ•°æ®è¿ç§»åˆ°ç¼“å­˜ï¼›ç„¶åçº¿ç¨‹Aå®Œæˆäº†æ›´æ–°æ•°æ®åº“çš„æ“ä½œï¼Œè¿™ä¸€ç¬é—´çº¿ç¨‹Bä¹Ÿè¦è®¿é—®ç¼“å­˜ï¼Œæ­¤æ—¶å®ƒè®¿é—®åˆ°çš„å°±æ˜¯çº¿ç¨‹Cæ”¾åˆ°ç¼“å­˜é‡Œé¢çš„æ—§æ•°æ®ï¼Œ ä¸è¿‡è¿™ç§æƒ…å†µå‡ºç°çš„æ¦‚ç‡æ›´ä½ï¼Œè¿™æ˜¯éœ€è¦ä¸‰ä¸ªçº¿ç¨‹é…åˆæ‰å¯èƒ½ä¼šå‡ºç°çš„é—®é¢˜</li>
</ol>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œæ¯ä¸€ç§æ–¹æ¡ˆéƒ½æ˜¯æœ‰ä¸€å®šçš„ç¼ºé™·çš„ï¼Œåªæ˜¯æœ€åä¸€ç§æ–¹å¼å¯ä»¥è®©ç¼ºé™·å‘ç”Ÿçš„æœºç‡æ›´ä½è€Œå·²</p>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>redisåº•å±‚æ•°æ®ç»“æ„</title>
    <url>/2023/19e21a188fd0/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="redis-å¯¹è±¡"><a href="#redis-å¯¹è±¡" class="headerlink" title="redis å¯¹è±¡"></a>redis å¯¹è±¡</h2><p><code>redis</code> ä¸­æ‰€æœ‰æ•°æ®ç±»å‹éƒ½æ˜¯ä½¿ç”¨ <code>RedisObject</code> å¯¹è±¡å½¢å¼æ¥è¡¨ç¤ºï¼Œ<code>RedisObject</code> ä¸»è¦åŒ…å«ä¸‰ä¸ªå­—æ®µ</p>
<span id="more"></span>

<pre class="mermaid">graph LR
    A[RedisObject]
    A-->B["type (è®°å½•å¯¹è±¡çš„ç±»å‹) \n å¸¸ç”¨5ç§åŸºæœ¬ç±»å‹ï¼Œå®é™…è¿˜æœ‰BitMapï¼ˆ2.2 ç‰ˆæ–°å¢ï¼‰\nã€HyperLogLogï¼ˆ2.8 ç‰ˆæ–°å¢ï¼‰ã€\n GEOï¼ˆ3.2 ç‰ˆæ–°å¢ï¼‰ã€Streamï¼ˆ5.0 ç‰ˆæ–°å¢ï¼‰"]

    B1[String å­—ç¬¦ä¸²å¯¹è±¡]
    B2[List åˆ—è¡¨é›†åˆ]
    B3[Hash å“ˆå¸Œå¯¹è±¡]
    B4[Set é›†åˆå¯¹è±¡]
    B5[Zset æœ‰åºé›†åˆå¯¹è±¡]
    B--> B1 & B2 & B3 & B4 & B5

    A-->C["encoding (è®°å½•å¯¹è±¡çš„ç¼–ç )"]
    C1[Intset æ•´æ•°é›†åˆ]
    C2[embstr embstrç¼–ç çš„ç®€å•åŠ¨æ€å­—ç¬¦ä¸²]
    C3[raw ç®€å•åŠ¨æ€å­—ç¬¦ä¸²]
    C4[HT å­—å…¸]
    C5[Linkedlist åŒç«¯åˆ—è¡¨]
    C6[ziplist å‹ç¼©åˆ—è¡¨]
    C7[skiplist è·³è·ƒè¡¨å’Œå­—å…¸]
    C8[quicklist å¿«é€Ÿåˆ—è¡¨]
    C-->C1 & C2 & C3 & C4 & C5 & C6 & C7 & C8

    A-->D["*ptr (æŒ‡å‘å…·ä½“çš„ç±»å‹)"]</pre>

<h3 id="ä¸ºä»€ä¹ˆä¸€ä¸ªå¯¹è±¡éœ€è¦åŒ…å«-type-å’Œ-encoding"><a href="#ä¸ºä»€ä¹ˆä¸€ä¸ªå¯¹è±¡éœ€è¦åŒ…å«-type-å’Œ-encoding" class="headerlink" title="ä¸ºä»€ä¹ˆä¸€ä¸ªå¯¹è±¡éœ€è¦åŒ…å« type å’Œ encoding"></a>ä¸ºä»€ä¹ˆä¸€ä¸ªå¯¹è±¡éœ€è¦åŒ…å« <code>type</code> å’Œ <code>encoding</code></h3><ol>
<li>å› ä¸º <code>type</code> åªæ˜¯è®°å½•å¯¹è±¡çš„ç±»å‹</li>
<li>æ¯ä¸€ä¸ª <code>type</code> å¯ä»¥ä½¿ç”¨ä¸åŒçš„åº•å±‚æ•°æ®ç»“æ„æ¥å®ç°ï¼Œæ‰€ä»¥è¿˜éœ€è¦å…·ä½“çš„ <code>encoding</code> æ¥æŒ‡æ˜è¿™ä¸ª <code>type</code> çš„å®ç°æ˜¯ä»€ä¹ˆï¼Œ ä¸‹å›¾å°±åˆ—å‡ºæ¯ä¸€ä¸ª <code>type</code> æœ‰å“ªå‡ ç§åº•å±‚æ•°æ®ç»“æ„</li>
</ol>
<h2 id="5-ç§åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„åº•å±‚å®ç°"><a href="#5-ç§åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„åº•å±‚å®ç°" class="headerlink" title="5 ç§åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„åº•å±‚å®ç°"></a>5 ç§åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„åº•å±‚å®ç°</h2><h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><ol>
<li><code>String</code> ç±»å‹çš„åº•å±‚çš„æ•°æ®ç»“æ„å®ç°ä¸»è¦æ˜¯ <code>int</code> å’Œ <code>SDS</code>ï¼ˆç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼‰<ol>
<li>å¦‚æœå­˜å‚¨çš„æ˜¯æ•°å­—ï¼Œåˆ™ç¼–ç ä½¿ç”¨ <code>int</code> ç±»å‹</li>
</ol>
</li>
<li><code>sds</code> çš„å®é™…ç¼–ç åˆåŒ…å« <code>raw</code> å’Œ <code>embstr</code><ol>
<li>å­—ç¬¦ä¸²é•¿åº¦å°äº 32ä½æ—¶ä½¿ç”¨ <code>embstr</code>(<code>embstr</code> çš„ç©ºé—´æŒ¨ç€ <code>RedisObjectï¼ŒRedisObject</code> å’Œ <code>embstr</code> çš„å†…å­˜æ˜¯ä¸€æ¬¡æ€§åˆ†é…çš„)</li>
<li>å­—ç¬¦ä¸²é•¿åº¦å¤§äº 32ä½æ—¶ä½¿ç”¨ <code>raw</code> ç¼–ç (<code>RedisObject</code> çš„å†…å­˜åˆ†åŒºå’Œ <code>raw</code> ç¼–ç ç±»å‹çš„ç©ºé—´åˆ†é…æ˜¯åˆ†å¼€çš„ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ä¸¤æ¬¡å†…å­˜åˆ†é…)</li>
</ol>
</li>
</ol>
<h4 id="SDS-å’Œ-C-åŸç”Ÿå­—ç¬¦ä¸²çš„åŒºåˆ«"><a href="#SDS-å’Œ-C-åŸç”Ÿå­—ç¬¦ä¸²çš„åŒºåˆ«" class="headerlink" title="SDS å’Œ C åŸç”Ÿå­—ç¬¦ä¸²çš„åŒºåˆ«"></a>SDS å’Œ C åŸç”Ÿå­—ç¬¦ä¸²çš„åŒºåˆ«</h4><ol>
<li><code>sds</code> å¯ä»¥ä¿å­˜æ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ•°æ®ï¼Œå› ä¸º <code>sds</code> æœ‰ <code>length</code> å­—æ®µæ¥åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç»“æŸï¼Œc ä½¿ç”¨ â€˜\0â€™ ä½œä¸ºç»“æŸç¬¦</li>
<li><code>sds</code> çš„ <code>api</code> å®‰å…¨ï¼Œä¸ä¼šå‡ºç°ç¼“å†²åŒºæº¢å‡ºï¼Œå› ä¸º <code>sds</code> æ‹¼æ¥å­—ç¬¦ä¸²å‰æœ‰åšå®¹é‡æ£€æŸ¥</li>
</ol>
<h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><ol>
<li><code>List</code> ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ç”±åŒå‘é“¾è¡¨æˆ–å‹ç¼©åˆ—è¡¨å®ç°çš„<ol>
<li>å…ƒç´ ä¸ªæ•°å°äº 512 ä¸ªï¼ˆé»˜è®¤å€¼ï¼Œå¯ç”± <code>list-max-ziplist-entries</code> é…ç½®ï¼‰ï¼Œåˆ—è¡¨æ¯ä¸ªå…ƒç´ çš„å€¼éƒ½å°äº 64 å­—èŠ‚ï¼ˆé»˜è®¤å€¼ï¼Œå¯ç”± <code>list-max-ziplist-value</code> <code>é…ç½®ï¼‰ï¼ŒRedis</code> ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸º <code>List</code> ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›</li>
</ol>
</li>
<li>åœ¨ <code>Redis3.2</code> ç‰ˆæœ¬ä¹‹åï¼Œ<code>List</code> ç±»å‹åº•å±‚æ•°æ®ç»“æ„åªæœ‰ <code>quicklist</code> ä¸€ç§</li>
</ol>
<h3 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h3><ol>
<li><code>Hash</code> ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ç”±å‹ç¼©åˆ—è¡¨æˆ–å“ˆå¸Œè¡¨å®ç°çš„<ol>
<li>å…ƒç´ ä¸ªæ•°å°äº 512 ä¸ªï¼ˆå¯é€šè¿‡ <code>hash-max-ziplist-entries</code> ä¿®æ”¹ï¼‰ï¼Œæ‰€æœ‰å€¼å°äº 64 å­—èŠ‚ï¼ˆå¯é€šè¿‡ <code>hash-max-ziplist-value</code> ä¿®æ”¹ï¼‰æ—¶ï¼Œ<code>Redis</code> ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸º <code>Hash</code> ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„</li>
</ol>
</li>
<li>åœ¨ <code>Redis7.0</code> ä¸­ï¼Œå‹ç¼©åˆ—è¡¨æ•°æ®ç»“æ„è¢«åºŸå¼ƒï¼Œç”± <code>listpack</code> æ•°æ®ç»“æ„æ¥å®ç°</li>
</ol>
<h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h3><ol>
<li><code>Set</code> ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ç”±å“ˆå¸Œè¡¨æˆ–æ•´æ•°é›†åˆå®ç°çš„<ol>
<li>å¦‚æœé›†åˆä¸­çš„å…ƒç´ éƒ½æ˜¯æ•´æ•°ä¸”å…ƒç´ ä¸ªæ•°å°äº 512 ï¼ˆå¯é€šè¿‡ <code>set-maxintset-entries</code> ä¿®æ”¹ï¼‰ä¸ªï¼Œ<code>Redis</code> ä¼šä½¿ç”¨æ•´æ•°é›†åˆä½œä¸º Set ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„</li>
</ol>
</li>
</ol>
<h3 id="Zset"><a href="#Zset" class="headerlink" title="Zset"></a>Zset</h3><ol>
<li><p>Zset ç±»å‹åº•å±‚æ•°æ®ç»“æ„æ˜¯ç”±å‹ç¼©åˆ—è¡¨æˆ–è·³è¡¨å®ç°</p>
<ol>
<li>è‹¥æœ‰åºé›†åˆçš„å…ƒç´ ä¸ªæ•°å°äº 128 ä¸ªä¸”æ¯ä¸ªå…ƒç´ çš„å€¼å°äº 64 å­—èŠ‚ï¼Œ<code>Redis</code> ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸º <code>Zset</code> ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„</li>
</ol>
</li>
<li><p><code>Redis 7.0</code> ä¸­ï¼Œå‹ç¼©åˆ—è¡¨æ•°æ®ç»“æ„è¢«åºŸå¼ƒï¼Œäº¤ç”± <code>listpack</code> æ•°æ®ç»“æ„æ¥å®ç°</p>
</li>
</ol>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>redisçº¿ç¨‹æ¨¡å‹</title>
    <url>/2023/e4db3f95ceb5/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p>æ€»ç»“ï¼š<code>redis</code> æ•´ä½“æ˜¯å¤šçº¿ç¨‹çš„ï¼Œè‡³äºå¹³æ—¶æ‰€è¯´çš„ <code>redis</code> å•çº¿ç¨‹æ˜¯æŒ‡ <strong>redisçš„ç½‘ç»œio å’Œ é”®å€¼å¯¹è¯»å†™</strong> æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆ</p>
<h2 id="ä¸€æ¬¡-redis-è¯·æ±‚è¿‡ç¨‹"><a href="#ä¸€æ¬¡-redis-è¯·æ±‚è¿‡ç¨‹" class="headerlink" title="ä¸€æ¬¡ redis è¯·æ±‚è¿‡ç¨‹"></a>ä¸€æ¬¡ redis è¯·æ±‚è¿‡ç¨‹</h2><ol>
<li>ç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚ï¼ˆ<code>bind/listen</code>ï¼‰</li>
<li>ç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ï¼ˆ<code>accept</code>ï¼‰</li>
<li>ä» <code>socket</code> ä¸­è¯»å–æ•°æ®ï¼ˆ<code>recv</code>ï¼‰</li>
<li>è§£æå®¢æˆ·ç«¯å‘é€çš„å†…å®¹ï¼ˆ<code>parse</code>ï¼‰</li>
<li>æ ¹æ®è§£æå‡ºæ¥çš„å†…å®¹è¿›è¡Œå†…å­˜æ“ä½œï¼ˆ<code>get/set</code>ï¼‰</li>
<li>æ‰§è¡Œå®Œæˆå‘½ä»¤ä¹‹åç»™å®¢æˆ·ç«¯å“åº”ç»“æœï¼Œå³å‘ <code>socket</code> ä¸­å†™æ•°æ®ï¼ˆ<code>send</code>ï¼‰</li>
</ol>
<pre class="mermaid">graph TB
    subgraph A[redisçº¿ç¨‹]
        subgraph B[ç½‘ç»œIOå¤„ç†]
            B1[bind/listen]
            B2[accept]
            B3[recv]
            B4[parse]
        end
        subgraph C[é”®å€¼å¯¹è¯»å†™]
            C1[get/set]
        end
        subgraph D[ç½‘ç»œIOå¤„ç†]
            D1[send]
        end
    end
    B-->C-->D</pre>
<ul>
<li>ç½‘ç»œ io å¤„ç†è¿‡ç¨‹ä¸­ï¼Œ <code>listen</code> å’Œ <code>recv</code> è¿™ä¸¤ä¸ªæ­¥éª¤æ˜¯å¯èƒ½é˜»å¡çš„ï¼Œå³å½“æ²¡æœ‰é“¾æ¥æˆ–å®¢æˆ·ç«¯æ²¡æœ‰å‘é€å‘½ä»¤æ—¶ï¼ŒæœåŠ¡å™¨å¤„ç†è¿™ä¸¤ä¸ªç¯èŠ‚æ—¶ä¼šé˜»å¡ï¼Œ<strong>ä½†æ˜¯socketç½‘ç»œæ¨¡å‹è‡ªèº«å°±æ”¯æŒéé˜»å¡çš„å½¢å¼</strong></li>
</ul>
<h2 id="redis4-ç‰ˆæœ¬ä¸­çš„å¤šçº¿ç¨‹"><a href="#redis4-ç‰ˆæœ¬ä¸­çš„å¤šçº¿ç¨‹" class="headerlink" title="redis4 ç‰ˆæœ¬ä¸­çš„å¤šçº¿ç¨‹"></a>redis4 ç‰ˆæœ¬ä¸­çš„å¤šçº¿ç¨‹</h2><ol>
<li>åœ¨ <code>redis4</code> ä¸­ä¸»è¦æ˜¯å¢åŠ äº†å¼‚æ­¥åˆ é™¤æœºåˆ¶ï¼Œæ¯”å¦‚ <code>UNLINKã€FLUSHALL ASYNCã€FLUSHDB ASYNC</code> ç­‰éé˜»å¡çš„åˆ é™¤æ“ä½œã€‚</li>
<li>å¼•å…¥å¼‚æ­¥åˆ é™¤çš„åŸå› æ˜¯ç°åœ¨æœåŠ¡å™¨çš„å†…å­˜åŸæ¥è¶Šå¤§ï¼Œ<code>redis</code> ä¸­å¯èƒ½ä¼šå­˜åœ¨ <code>bigKey</code>, å¯¹äºè¿™äº› <code>bigKey</code> çš„åˆ é™¤å¦‚æœä½¿ç”¨é˜»å¡çš„æ–¹å¼ï¼Œä¼šå¯¼è‡´æœåŠ¡å™¨çš„å“åº”æ—¶é—´å˜é•¿ï¼Œæ‰€ä»¥å¼•å…¥äº†å¼‚æ­¥åˆ é™¤çš„æœºåˆ¶ï¼Œå³å½“åˆ é™¤ <code>bigKey</code> çš„æ—¶å€™ï¼Œä¼šå°†åˆ é™¤æ“ä½œæ”¾å…¥ä¸€ä¸ªå¼‚æ­¥é˜Ÿåˆ—ä¸­ï¼Œç”±ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥è´Ÿè´£å¼‚æ­¥åˆ é™¤ï¼Œè¿™æ ·å°±å¯ä»¥æé«˜æœåŠ¡å™¨çš„å“åº”æ—¶é—´</li>
</ol>
<h2 id="redis6-ç‰ˆæœ¬çš„å¤šçº¿ç¨‹"><a href="#redis6-ç‰ˆæœ¬çš„å¤šçº¿ç¨‹" class="headerlink" title="redis6 ç‰ˆæœ¬çš„å¤šçº¿ç¨‹"></a>redis6 ç‰ˆæœ¬çš„å¤šçº¿ç¨‹</h2><p>åœ¨ <code>redis6</code> ä¸­æœ‰å‡ ä¸ªé‡è¦ç‰¹æ€§ï¼Œæ¯”å¦‚</p>
<ol>
<li>é¢å‘<strong>ç½‘ç»œå¤„ç†</strong>çš„å¤š <code>IO</code> çº¿ç¨‹</li>
<li>å®¢æˆ·ç«¯ç¼“å­˜</li>
<li>ç»†ç²’åº¦çš„æƒé™æ§åˆ¶</li>
</ol>
<p>æœ¬èŠ‚ä¸»è¦è®²è§£ <code>redis6</code> ä¸­çš„å¤šçº¿ç¨‹æ¨¡å‹ï¼Œåœ¨ <code>redis6</code> ä¹‹å‰ï¼Œ<strong>ä»ç½‘ç»œioå¤„ç†åˆ°é”®å€¼å¯¹è¯»å†™éƒ½æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆçš„</strong>ï¼Œ éšç€ç½‘ç»œç¡¬ä»¶çš„æ€§èƒ½æå‡ï¼Œ<code>redis</code> çš„æ€§èƒ½ç“¶é¢ˆæœ‰æ—¶ä¼šå‡ºç°åœ¨ç½‘ç»œ<code>io</code>çš„å¤„ç†ä¸Šï¼Œå³ <strong>å•ä¸ªä¸»çº¿ç¨‹å¤„ç†ç½‘ç»œè¯·æ±‚çš„é€Ÿåº¦è·Ÿä¸ä¸Šåº•å±‚ç½‘ç»œç¡¬ä»¶çš„é€Ÿåº¦</strong>ï¼Œæ‰€ä»¥åœ¨ <code>redis6</code> ä¸­ä½¿ç”¨å¤šä¸ªç½‘ç»œ<code>io</code>çº¿ç¨‹æ¥å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œæé«˜ç½‘ç»œè¯·æ±‚å¤„ç†å¹¶è¡Œçš„èƒ½åŠ›, éœ€è¦æ³¨æ„çš„æ˜¯ <strong>redis6çš„å¤šçº¿ç¨‹æ¨¡å‹åªæ˜¯é’ˆå¯¹ç½‘ç»œioéƒ¨åˆ†ï¼Œredisçš„æ•°æ®è¯»å†™ä¾ç„¶æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆçš„</strong></p>
<h3 id="redis6ä¸­ä¸»çº¿ç¨‹å’Œioçº¿ç¨‹åä½œæµç¨‹"><a href="#redis6ä¸­ä¸»çº¿ç¨‹å’Œioçº¿ç¨‹åä½œæµç¨‹" class="headerlink" title="redis6ä¸­ä¸»çº¿ç¨‹å’Œioçº¿ç¨‹åä½œæµç¨‹"></a>redis6ä¸­ä¸»çº¿ç¨‹å’Œioçº¿ç¨‹åä½œæµç¨‹</h3><pre class="mermaid">graph TB
    subgraph A["redisä¸»çº¿ç¨‹(æ¥æ”¶è¯·æ±‚)"]
        direction TB
        style A fill:#f9f
        A1["æ¥æ”¶å»ºç«‹è¿æ¥è¯·æ±‚ï¼Œè·å–socket"]
        A2["å°†socketæ”¾å…¥å…¨å±€ç­‰å¾…é˜Ÿåˆ—"]
        A3["ä»¥è½®è¯¢æ–¹å¼å°†socketè¿æ¥åˆ†é…ç»™IOçº¿ç¨‹, ä¸»çº¿ç¨‹å¼€å§‹é˜»å¡-----"]
        A1-->A2-->A3
    end
    subgraph B["redisç½‘ç»œIOçº¿ç¨‹(è§£æè¯·æ±‚)"]
        direction TB
        B1["å°†socketå’Œçº¿ç¨‹ç»‘å®š"]
        B2["è¯»å–socketä¸­çš„è¯·æ±‚å¹¶è§£æ"]
        B3["è¯·æ±‚è§£æå®Œæˆ"]
        B1-->B2-->B3
    end
    subgraph BB["redisç½‘ç»œIOçº¿ç¨‹(è§£æè¯·æ±‚)"]
        direction TB
        BB1["å°†socketå’Œçº¿ç¨‹ç»‘å®š"]
        BB2["è¯»å–socketä¸­çš„è¯·æ±‚å¹¶è§£æ"]
        BB3["è¯·æ±‚è§£æå®Œæˆ"]
        BB1-->BB2-->BB3
    end
    A--"ioçº¿ç¨‹å¼€å§‹æ‰§è¡Œ"-->B & BB
    subgraph C["redisä¸»çº¿ç¨‹(å‘½ä»¤è¯»å†™)"]
        direction TB
        style C fill:#f9f
        C1["æ‰§è¡Œè¯·æ±‚çš„å‘½ä»¤æ“ä½œ"]
        C2["è¯·æ±‚çš„å‘½ä»¤æ“ä½œæ‰§è¡Œå®Œæˆ"]
        C3["å°†ç»“æœæ•°æ®å†™å…¥ç¼“å†²åŒº"]
        C4["ç­‰å¾…ioçº¿ç¨‹å®Œæˆæ•°æ®å›å†™socketï¼Œä¸»çº¿ç¨‹é˜»å¡---"]
        C1-->C2-->C3-->C4
    end
    B-->C
    BB-->C
    subgraph D["redisç½‘ç»œIOçº¿ç¨‹(ç»“æœå“åº”)"]
        direction TB
        D1["å°†ç»“æœæ•°æ®å›å†™socket(è¿™ä¸€æ­¥æ˜¯å¹¶è¡Œå¤„ç†)"]
        D2["socketå›å†™å®Œæˆ"]
        D1-->D2
    end
    subgraph DD["redisç½‘ç»œIOçº¿ç¨‹(ç»“æœå“åº”)"]
        direction TB
        DD1["å°†ç»“æœæ•°æ®å›å†™socket(è¿™ä¸€æ­¥æ˜¯å¹¶è¡Œå¤„ç†)"]
        DD2["socketå›å†™å®Œæˆ"]
        DD1-->DD2
    end
    C-->D & DD
    D-->E["ä¸»çº¿ç¨‹æ¸…ç©ºç­‰å¾…é˜Ÿåˆ—ï¼Œç­‰å¾…åç»­è¯·æ±‚"]
    DD-->E["ä¸»çº¿ç¨‹æ¸…ç©ºç­‰å¾…é˜Ÿåˆ—ï¼Œç­‰å¾…åç»­è¯·æ±‚"]
    style E fill:#f9f</pre>
<h3 id="é˜¶æ®µ1"><a href="#é˜¶æ®µ1" class="headerlink" title="é˜¶æ®µ1"></a>é˜¶æ®µ1</h3><ol>
<li>æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯è¿æ¥ <code>socket</code> è¿æ¥ï¼Œå¹¶å°† <code>socket</code> æ”¾å…¥å…¨å±€ç­‰å¾…é˜Ÿåˆ—</li>
<li>ä¸»çº¿ç¨‹é€šè¿‡è½®è¯¢çš„æ–¹å¼ï¼Œå°† <code>socket</code> è¿æ¥åˆ†é…ç»™ <code>io</code> çº¿ç¨‹</li>
<li>ä¸»çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€</li>
</ol>
<h3 id="é˜¶æ®µ2"><a href="#é˜¶æ®µ2" class="headerlink" title="é˜¶æ®µ2"></a>é˜¶æ®µ2</h3><ol>
<li><code>io</code> çº¿ç¨‹å®Œæˆå®¢æˆ·ç«¯è¯·æ±‚è¯»å–å’Œè§£æ</li>
<li><code>io</code> çº¿ç¨‹æœ‰å¤šä¸ªï¼Œæ˜¯å¹¶å‘æ“ä½œçš„, æ‰€ä»¥ä¼šå¾ˆå¿«</li>
</ol>
<h3 id="é˜¶æ®µ3"><a href="#é˜¶æ®µ3" class="headerlink" title="é˜¶æ®µ3"></a>é˜¶æ®µ3</h3><ol>
<li>ç­‰å¾… <code>io</code> xçº¿ç¨‹å°†å‘½ä»¤è§£æå®Œæˆåï¼Œ<strong>ä¸»çº¿ç¨‹ä¼šä»¥å•çº¿ç¨‹çš„æ–¹å¼æ‰§è¡Œè¿™ä¸ªå‘½ä»¤æ“ä½œ</strong></li>
</ol>
<h3 id="é˜¶æ®µ4"><a href="#é˜¶æ®µ4" class="headerlink" title="é˜¶æ®µ4"></a>é˜¶æ®µ4</h3><ol>
<li>ä¸»çº¿ç¨‹æ‰§è¡Œå®Œè¯·æ±‚æ“ä½œåï¼Œå°†éœ€è¦è¿”å›çš„ç»“æœå†™å…¥ç¼“å†²åŒºï¼Œç„¶ä¼šï¼Œä¸»çº¿ç¨‹ä¼šé˜»å¡ç­‰å¾… <code>io</code> çº¿ç¨‹æŠŠè¿™äº›ç»“æœå†™å›åˆ° <code>socket</code> ä¸­ï¼Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯</li>
<li><code>io</code> çº¿ç¨‹å›å†™ <code>socket</code> ä¹‹åï¼Œä¸»çº¿ç¨‹ä¼šæ¸…ç©ºå…¨å±€é˜Ÿåˆ—ï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„åç»­è¯·æ±‚</li>
</ol>
<h2 id="redis6-å¤šçº¿ç¨‹æ¨¡å‹çš„å¯ç”¨"><a href="#redis6-å¤šçº¿ç¨‹æ¨¡å‹çš„å¯ç”¨" class="headerlink" title="redis6 å¤šçº¿ç¨‹æ¨¡å‹çš„å¯ç”¨"></a>redis6 å¤šçº¿ç¨‹æ¨¡å‹çš„å¯ç”¨</h2><ol>
<li>åœ¨ <code>redis6</code> ä¸­ï¼Œå¤šçº¿ç¨‹æ¨¡å—é»˜è®¤æ˜¯å…³é—­çš„</li>
<li>å¯ä»¥åœ¨ <code>redis.conf</code> ä¸­è®¾ç½® <code>io-threads-do-reads yes</code> æ¥å¼€å¯å¤šçº¿ç¨‹</li>
<li>å¯ä»¥åœ¨ <code>redis.conf</code> ä¸­è®¾ç½®çº¿ç¨‹ä¸ªæ•°ï¼Œæ¯”å¦‚ <code>io-threads 4</code>, ä¸€èˆ¬å»ºè®®çº¿ç¨‹ä¸ªæ•°å°äº <code>redis</code> å®ä¾‹æ‰€åœ¨æœºå™¨çš„ <code>cpu</code> æ ¸ä¸ªæ•°</li>
</ol>
<h2 id="ç–‘é—®è§£ç­”"><a href="#ç–‘é—®è§£ç­”" class="headerlink" title="ç–‘é—®è§£ç­”"></a>ç–‘é—®è§£ç­”</h2><ol>
<li><code>Redis6.0</code>å¢åŠ äº†<code>IO</code>çº¿ç¨‹æ¥å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œå¦‚æœå®¢æˆ·ç«¯å…ˆå‘é€äº†ä¸€ä¸ª<code>set key1 val1</code>å†™å‘½ä»¤ï¼Œç´§æ¥ç€å‘é€ä¸€ä¸ª<code>get key1</code>è¯»å‘½ä»¤ã€‚ç”±äºIOçº¿ç¨‹æ˜¯å¤šçº¿ç¨‹å¤„ç†çš„ï¼Œæ˜¯å¦ä¼šå¯¼è‡´<code>get key1</code>è¯»å‘½ä»¤ å…ˆäº <code>set key1 val1</code>å†™å‘½ä»¤æ‰§è¡Œå‘¢ï¼Ÿç»“æœå®¢æˆ·ç«¯è¯»åˆ°äº†<code>key1</code>çš„æ—§å€¼çš„æƒ…å†µå‘ç”Ÿï¼Ÿ</li>
</ol>
<blockquote>
<p>å¦‚æœè¿™ä¸¤æ¡å‘½ä»¤æ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯å‘é€çš„ï¼Œæœ‰æ˜æ˜¾çš„å…ˆåé¡ºåºï¼Œå°±ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œå› ä¸ºæ¥æ”¶è¯·æ±‚çš„è¿˜æ˜¯ä¸»çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹æ¥æ”¶è¯·æ±‚åä¼šå°†å‘½ä»¤å…¥é˜Ÿåˆ—ï¼Œè¿™ä¸ªæ˜¯å¯ä»¥ä¿è¯é¡ºåºçš„ï¼Œè™½ç„¶åç»­æ˜¯äº¤ç»™å¤šçº¿ç¨‹æ¥è§£æè¯·æ±‚ï¼Œä½†æ˜¯å‘½ä»¤è¯»å†™çš„é¡ºåºè¿˜æ˜¯ä¼šæŒ‰ç…§é˜Ÿåˆ—ä¸­å‘½ä»¤å…ˆåå‡ºç°çš„é¡ºåºï¼Œè€Œä¸”å‘½ä»¤è¯»å†™æ˜¯é€šè¿‡ä¸»çº¿ç¨‹å•çº¿ç¨‹æ“ä½œçš„ã€‚</p>
<p>å¦‚æœè¿™é‡Œè¯´çš„æ˜¯å¤šä¸ªå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤ï¼Œé‚£å°±éœ€è¦çœ‹å“ªä¸ªå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚å…ˆåˆ°è¾¾æœåŠ¡ç«¯ï¼Œå…ˆåˆ°è¾¾çš„å‘½ä»¤ä¼šå…ˆæ‰§è¡Œ</p>
</blockquote>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¼“å­˜é›ªå´©ç¼“å­˜å‡»ç©¿ç¼“å­˜ç©¿é€</title>
    <url>/2023/90567821a93b/index.html</url>
    <content><![CDATA[<h2 id="ç¼“å­˜é›ªå´©"><a href="#ç¼“å­˜é›ªå´©" class="headerlink" title="ç¼“å­˜é›ªå´©"></a>ç¼“å­˜é›ªå´©</h2><h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨ç¼“å­˜æœåŠ¡å™¨é‡å¯æˆ–è€…å¤§é‡ <code>key</code> é›†ä¸­åœ¨æŸä¸€æ—¶åˆ»åŒæ—¶å¤±æ•ˆï¼Œè€Œè¿™äº›ç¼“å­˜åœ¨åŒä¸€æ—¶åˆ»è¢«å¤§é‡çš„è¯·æ±‚æ‰€è®¿é—®ï¼Œä»è€Œå¼•èµ·å¤§é‡çš„ç¼“å­˜é›†ä¸­å¤±æ•ˆï¼Œå¼•èµ·è¯·æ±‚çš„æ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚</p>
<h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><ol>
<li>é¿å…ç¼“å­˜è®¾ç½®ç›¸è¿‘çš„æœ‰æ•ˆæœŸ</li>
<li>å¯¹æ•°æ®è¿›è¡Œé¢„çƒ­</li>
</ol>
<h2 id="ç¼“å­˜å‡»ç©¿"><a href="#ç¼“å­˜å‡»ç©¿" class="headerlink" title="ç¼“å­˜å‡»ç©¿"></a>ç¼“å­˜å‡»ç©¿</h2><h3 id="æ¦‚å¿µ-1"><a href="#æ¦‚å¿µ-1" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><p>ç¼“å­˜å‡»ç©¿æ˜¯æŒ‡ä¸€ä¸ªçƒ­ç‚¹ <code>key</code>åœ¨ç¼“å­˜å¤±æ•ˆçš„æ—¶å€™ï¼ŒåŒæ—¶å¤§é‡çš„è¯·æ±‚éƒ½åœ¨è®¿é—®è¿™ä¸ª<code>key</code>ï¼Œè€Œè¿™äº›è¯·æ±‚éƒ½åœ¨åŒæ—¶å¤±æ•ˆï¼Œä»è€Œå¼•èµ·å¤§é‡çš„è¯·æ±‚é›†ä¸­åˆ°è¾¾æ•°æ®åº“ï¼Œä»è€Œå¼•èµ·æ•°æ®åº“çš„å‹åŠ›ã€‚</p>
<h3 id="è§£å†³æ–¹æ¡ˆ-1"><a href="#è§£å†³æ–¹æ¡ˆ-1" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><ol>
<li>çƒ­ç‚¹æ•°æ®æ°¸è¿œä¸è¿‡æœŸï¼Œå³åœ¨æ•°æ®è¿‡æœŸä¹‹é—´å¯ä»¥å…ˆè¿›è¡Œæ›´æ–°</li>
<li>ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œåªè®©ä¸€ä¸ªçº¿ç¨‹å»æŸ¥è¯¢ <code>db</code> å¹¶è¿”å›ç»“æœï¼Œä¸è¿‡è¿™ç§æ–¹å¼åœ¨é«˜å¹¶å‘ä¸‹æ¯”è¾ƒå½±å“æ€§èƒ½</li>
</ol>
<h2 id="ç¼“å­˜ç©¿é€"><a href="#ç¼“å­˜ç©¿é€" class="headerlink" title="ç¼“å­˜ç©¿é€"></a>ç¼“å­˜ç©¿é€</h2><h3 id="æ¦‚å¿µ-2"><a href="#æ¦‚å¿µ-2" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><p>ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½æ²¡æœ‰çš„æ•°æ®ï¼Œè¿˜æ˜¯æœ‰æºæºä¸æ–­çš„è¯·æ±‚åˆ°è¾¾ï¼Œå¯¼è‡´æ¯æ¬¡è¯·æ±‚éƒ½ä¼šåˆ°æ•°æ®åº“ï¼Œä»è€Œå‹å®æ•°æ®åº“</p>
<h3 id="è§£å†³æ–¹æ¡ˆ-2"><a href="#è§£å†³æ–¹æ¡ˆ-2" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><ol>
<li>å¯¹äºæŸ¥è¯¢æ•°æ®åº“ä¹Ÿä¸å­˜åœ¨çš„æ•°æ®ï¼Œä¾ç„¶å¯ä»¥å­˜æ”¾åœ¨ <code>redis</code> ä¸­ï¼Œå¹¶ä¸”è®¾ç½®ä¸€ä¸ªè¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´</li>
<li>ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨</li>
</ol>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>InnoDBå­˜å‚¨å¼•æ“è¯¦è§£</title>
    <url>/2023/a421bfc0bf81/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="InnoDB-å­˜å‚¨å¼•æ“æ•°æ®æ“ä½œè¿‡ç¨‹"><a href="#InnoDB-å­˜å‚¨å¼•æ“æ•°æ®æ“ä½œè¿‡ç¨‹" class="headerlink" title="InnoDB å­˜å‚¨å¼•æ“æ•°æ®æ“ä½œè¿‡ç¨‹"></a>InnoDB å­˜å‚¨å¼•æ“æ•°æ®æ“ä½œè¿‡ç¨‹</h2><ol>
<li><code>InnoDB</code> å­˜å‚¨å¼•æ“æ˜¯åŸºäºç£ç›˜å­˜å‚¨çš„ï¼Œå¹¶å°†å…¶ä¸­çš„è®°å½•æŒ‰ç…§é¡µçš„æ–¹å¼è¿›è¡Œç®¡ç†, é¡µå¤§å°é»˜è®¤æ—¶ <code>16KB</code></li>
<li>ä»æ•°æ®åº“ä¸­è¯»å–æ•°æ®ï¼Œæ˜¯ä¼šå…ˆä»ç£ç›˜è¯»å–åˆ°ä¹Ÿæ”¾å…¥ç¼“å†²æ± ä¸­ï¼Œè¯¥è¿‡ç¨‹ç§°ä¸ºå°†é¡µ <code>Fix</code> åœ¨ç¼“å†²æ± ä¸­</li>
<li>å¯¹äºæ•°æ®åº“ä¸­é¡µçš„ä¿®æ”¹æ“ä½œï¼Œæ˜¯å…ˆä¿®æ”¹ç¼“å†²åŒºä¸­çš„é¡µ(å¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨æ­¥éª¤2è¿›è¡ŒåŠ è½½)ï¼Œç„¶åä½¿ç”¨ä¸€å®šçš„é¢‘ç‡åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œåˆ·æ–°æ•°æ®åˆ°ç£ç›˜æ˜¯é€šè¿‡ <code>Checkpoint</code> æœºåˆ¶å®ç°</li>
</ol>
<h2 id="ç¼“å†²æ± å†…å­˜æ•°æ®å¯¹è±¡"><a href="#ç¼“å†²æ± å†…å­˜æ•°æ®å¯¹è±¡" class="headerlink" title="ç¼“å†²æ± å†…å­˜æ•°æ®å¯¹è±¡"></a>ç¼“å†²æ± å†…å­˜æ•°æ®å¯¹è±¡</h2><pre class="mermaid">flowchart TB
  subgraph A["InnoDBå†…å­˜ç»“æ„"]
    B["é‡åšæ—¥å¿—ç¼“å†² \n(redo log buffer)"]
    C["é¢å¤–å†…å­˜"]
    subgraph D["ç¼“å†²æ± (innodb_buffer_pool)"]
      style D fill:green
      D1["æ•°æ®é¡µ"]
      D2["ç´¢å¼•é¡µ"]
      D3["æ’å…¥ç¼“å†²"]
      D4["é”ä¿¡æ¯"]
      D5["è‡ªé€‚åº”hashç´¢å¼•"]
      D6["æ•°æ®å­—å…¸ä¿¡æ¯"]
    end
    subgraph E["ç¼“å†²æ± (innodb_buffer_pool)"]
      style E fill:green
      E1["æ•°æ®é¡µ"]
      E2["ç´¢å¼•é¡µ"]
      E3["æ’å…¥ç¼“å†²"]
      E4["é”ä¿¡æ¯"]
      E5["è‡ªé€‚åº”hashç´¢å¼•"]
      E6["æ•°æ®å­—å…¸ä¿¡æ¯"]
    end
  end</pre>
<ol>
<li><code>InnoDB</code> å¼•æ“å…è®¸æœ‰å¤šä¸ª <code>Buffer Pool</code> å¯¹è±¡ï¼Œ æ¯ä¸ªé¡µå¯ä»¥æ ¹æ®å“ˆå¸Œå€¼å¹³å‡åˆ†é…åˆ°ä¸ç®—çš„ç¼“å†²æ± ä¸­ï¼Œè¿™æ ·å¯ä»¥æ£€æµ‹æ•°æ®åº“å†…éƒ¨çš„èµ„æºç«äº‰ï¼Œå¢åŠ æ•°æ®åº“çš„å¹¶å‘èƒ½åŠ›ï¼Œ å¯ä»¥é€šè¿‡ <code>innodb_buffer_pool_instances</code> æ¥è¿›è¡Œè®¾ç½®ï¼Œé»˜è®¤æ˜¯1</li>
</ol>
<h2 id="LRU-Listï¼ŒFree-List-å’Œ-Flush-List"><a href="#LRU-Listï¼ŒFree-List-å’Œ-Flush-List" class="headerlink" title="LRU Listï¼ŒFree List å’Œ Flush List"></a>LRU Listï¼ŒFree List å’Œ Flush List</h2><h3 id="Free-List-ç©ºé—²é“¾è¡¨"><a href="#Free-List-ç©ºé—²é“¾è¡¨" class="headerlink" title="Free List ç©ºé—²é“¾è¡¨"></a>Free List ç©ºé—²é“¾è¡¨</h3><ol>
<li><code>Free List</code> æ˜¯ <code>InnoDB</code> å­˜å‚¨å¼•æ“ä¸­ä¸€ä¸ªé‡è¦çš„æ•°æ®ç»“æ„ï¼Œå®ƒç”¨äºç®¡ç† <code>Buffer Pool</code> ä¸­çš„ç©ºé—²é¡µï¼Œå½“éœ€è¦ä½¿ç”¨ä¸€ä¸ªæ–°çš„é¡µçš„æ—¶å€™ï¼Œä¼šä»ç©ºé—²é“¾è¡¨ä¸­è·å–ä¸€ä¸ªé¡µï¼Œåœ¨æ•°æ®åº“åˆšè¿è¡Œæ—¶ï¼Œæ‰€æœ‰çš„é¡µéƒ½æ˜¯ç©ºé—²é¡µ</li>
</ol>
<h3 id="LRU-List-Latest-Recent-Used-æœ€è¿‘æœ€å°‘ä½¿ç”¨"><a href="#LRU-List-Latest-Recent-Used-æœ€è¿‘æœ€å°‘ä½¿ç”¨" class="headerlink" title="LRU List(Latest Recent Used) æœ€è¿‘æœ€å°‘ä½¿ç”¨"></a>LRU List(Latest Recent Used) æœ€è¿‘æœ€å°‘ä½¿ç”¨</h3><ol>
<li>æ•°æ®åº“ä¸­çš„ç¼“å†²æ± æ˜¯é€šè¿‡<code>LRU</code>ï¼ˆ<code>Latest Recent Used</code>ï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç®—æ³•æ¥ç®¡ç†ç¼“å­˜é¡µçš„ã€‚å³æœ€é¢‘ç¹ä½¿ç”¨çš„é¡µåœ¨ <code>LRU</code> åˆ—è¡¨çš„å‰ç«¯ï¼Œè€Œæœ€å°‘ä½¿ç”¨çš„é¡µåœ¨ <code>LRU</code> åˆ—è¡¨çš„å°¾ç«¯</li>
<li>å¯¹äº <code>InnoDB</code> è€Œè¨€ï¼Œæ•°æ®æ”¾åœ¨ç£ç›˜ä¸­å°±æ˜¯æ•°æ®é¡µï¼Œå½“æ•°æ®é¡µåŠ è½½åˆ°ç¼“å†²åŒºä¸­åå°±å˜æˆäº†ç¼“å­˜é¡µï¼ŒäºŒè€…å¤§å°æ˜¯ç›¸åŒçš„</li>
<li><code>InnoDB</code> ä¸­æ ¹æ® <strong>æ•°æ®å†·çƒ­åˆ†ç¦»æ€æƒ³</strong> å¯¹ <code>LRU</code> é“¾è¡¨è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä»ç£ç›˜ä¸­åŠ è½½çš„æ•°æ®é¡µé»˜è®¤å…ˆæ”¾åœ¨ <code>LRU</code> çš„å†·æ•°æ®åŒºåŸŸï¼Œæ»¡è¶³ä¸€å®šæ¡ä»¶åæ‰ä¼šå°†ç§»åŠ¨åˆ°çƒ­å–æ•°æ®åŒºåŸŸï¼ˆå†·æ•°æ®åŒºåŸŸé»˜è®¤å  3&#x2F;8ï¼‰ï¼Œå¯ä»¥é€šè¿‡ <code>innodb_old_blocks_pct</code> å‚æ•°ä¿®æ”¹</li>
<li><code>Mysql</code> çš„é¢„è¯»æœºåˆ¶å¯èƒ½ä¼šåŠ è½½å®é™…ä¸ä¼šä½¿ç”¨åˆ°çš„æ•°æ®åˆ°ç¼“å†²æ± ä¸­ï¼Œä¼šå ç”¨ç¼“å†²æ± çš„ç©ºé—´</li>
<li>é‡åˆ°ç±»ä¼¼ <code>select * from table</code> è¿™ç§å…¨è¡¨æ‰«æçš„è¯­å¥ï¼Œä¼šåŠ è½½å¤§é‡çš„ç£ç›˜ä¸­çš„æ•°æ®é¡µåˆ°ç¼“å†²åŒºä¸­ï¼Œä½†æ˜¯è¿™äº›æ•°æ®å¯èƒ½åªç”¨ä¸€æ¬¡å°±ä¸ç”¨äº†ï¼Œå¦‚æœç›´æ¥æ”¾åœ¨ <code>LRU</code> é“¾è¡¨å¤´éƒ¨å¯èƒ½ä¼šå°†å…¶ä»–å¸¸ç”¨çš„æ•°æ®æŒ¤å‡ºç¼“å†²åŒº</li>
</ol>
<h3 id="Flush-åˆ—è¡¨"><a href="#Flush-åˆ—è¡¨" class="headerlink" title="Flush åˆ—è¡¨"></a>Flush åˆ—è¡¨</h3><ol>
<li><code>LRU</code> é“¾è¡¨ä¸­ç®¡ç†çš„ç¼“å­˜é¡µè¢«ä¿®æ”¹ä¹‹åå°±ä¼šå˜æˆ <strong>è„é¡µ</strong>ï¼Œ è¿™äº›è„é¡µæœ€ç»ˆæ˜¯éœ€è¦å°†å…¶åˆ·æ–°åˆ°ç£ç›˜ä¸­çš„ï¼Œæ‰€ä»¥éœ€è¦å°†æ‰€æœ‰çš„è„é¡µæ”¾åœ¨ä¸€èµ·è¿›è¡Œç®¡ç†ï¼Œäºæ˜¯ <code>Flush List</code> å°±è¯ç”Ÿäº†</li>
<li><code>LRU</code> åˆ—è¡¨ç”¨æ¥ç®¡ç†ç¼“å†²æ± ä¸­é¡µçš„å¯ç”¨æ€§ï¼Œ<code>Flush</code>åˆ—è¡¨ç”¨æ¥ç®¡ç†å°†é¡µåˆ·æ–°å›ç£ç›˜ï¼ŒäºŒè€…äº’ä¸å½±å“</li>
</ol>
<h2 id="é‡åšæ—¥å¿—ç¼“å†²"><a href="#é‡åšæ—¥å¿—ç¼“å†²" class="headerlink" title="é‡åšæ—¥å¿—ç¼“å†²"></a>é‡åšæ—¥å¿—ç¼“å†²</h2><blockquote>
<p>InnoDB å­˜å‚¨å¼•æ“çš„å†…å­˜åŒºåŸŸé™¤äº†æœ‰ç¼“å†²æ± å¤–ï¼Œè¿˜æœ‰é‡åšæ—¥å¿—ç¼“å†²ï¼ˆredo log bufferï¼‰ã€‚InnoDBå­˜å‚¨å¼•æ“é¦–å…ˆå°†é‡åšæ—¥å¿—ä¿¡æ¯å…ˆæ”¾å…¥åˆ°è¿™ä¸ªç¼“å†²åŒºï¼Œç„¶åæŒ‰ä¸€å®šé¢‘ç‡å°†å…¶åˆ·æ–°åˆ°é‡åšæ—¥å¿—æ–‡ä»¶ã€‚é‡åšæ—¥å¿—ç¼“å†²ä¸€èˆ¬ä¸éœ€è¦è®¾ç½®å¾—å¾ˆå¤§ï¼Œå› ä¸ºä¸€èˆ¬æƒ…å†µä¸‹æ¯ä¸€ç§’é’Ÿä¼šå°†é‡åšæ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œå› æ­¤ç”¨æˆ·åªéœ€è¦ä¿è¯æ¯ç§’äº§ç”Ÿçš„äº‹åŠ¡é‡åœ¨è¿™ä¸ªç¼“å†²å¤§å°ä¹‹å†…å³å¯ã€‚è¯¥å€¼å¯ç”±é…ç½®å‚æ•°innodb_log_buffer_sizeæ§åˆ¶ï¼Œé»˜è®¤ä¸º8MB</p>
</blockquote>
<h3 id="é‡åšæ—¥å¿—ç¼“å†²åˆ·ç›˜æ—¶æœº"><a href="#é‡åšæ—¥å¿—ç¼“å†²åˆ·ç›˜æ—¶æœº" class="headerlink" title="é‡åšæ—¥å¿—ç¼“å†²åˆ·ç›˜æ—¶æœº"></a>é‡åšæ—¥å¿—ç¼“å†²åˆ·ç›˜æ—¶æœº</h3><ol>
<li><code>Master Thread</code> æ¯ä¸€ç§’å°†é‡åšæ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°é‡åšæ—¥å¿—æ–‡ä»¶ï¼›</li>
<li>æ¯ä¸ªäº‹åŠ¡æäº¤æ—¶ä¼šå°†é‡åšæ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°é‡åšæ—¥å¿—æ–‡ä»¶ï¼›</li>
<li>å½“é‡åšæ—¥å¿—ç¼“å†²æ± å‰©ä½™ç©ºé—´å°äº1&#x2F;2æ—¶ï¼Œé‡åšæ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°é‡åšæ—¥å¿—æ–‡ä»¶ã€‚</li>
</ol>
<h2 id="Checkpoint-æŠ€æœ¯"><a href="#Checkpoint-æŠ€æœ¯" class="headerlink" title="Checkpoint æŠ€æœ¯"></a>Checkpoint æŠ€æœ¯</h2><h3 id="redo-äº§ç”ŸèƒŒæ™¯"><a href="#redo-äº§ç”ŸèƒŒæ™¯" class="headerlink" title="redo äº§ç”ŸèƒŒæ™¯"></a>redo äº§ç”ŸèƒŒæ™¯</h3><ol>
<li>æ•°æ®é¡µåŠ è½½åˆ°ç¼“å†²åŒºå˜æˆç¼“å­˜é¡µï¼Œç¼“å­˜é¡µè¢«ä¿®æ”¹åå°±å˜æˆè„é¡µï¼Œè„é¡µæœ€ç»ˆæ˜¯è¦åˆ·å›ç£ç›˜ï¼Œå¦‚æœç¼“å­˜é¡µæœ‰å˜åŒ–å°±åˆ·ç›˜é‚£ä¹ˆæ€§èƒ½å¾ˆå·®ï¼ˆç£ç›˜éšæœºè¯»å†™ï¼‰ï¼Œå¦‚æœå¾ˆä¹…éƒ½ä¸åˆ·ç›˜ï¼Œå¯èƒ½ä¼šæœ‰æ•°æ®ä¸¢å¤±çš„æƒ…å†µ</li>
<li>ä¸ºäº†é¿å…æ•°æ®ä¸¢å¤±ï¼Œå¾ˆå¤šç³»ç»Ÿæ™®é <code>Write Ahead Log</code> ç­–ç•¥ï¼Œå³å½“äº‹åŠ¡æäº¤æ—¶ï¼Œå…ˆå†™é‡åšæ—¥å¿—ï¼Œå†ä¿®æ”¹é¡µã€‚å½“ç”±äºå‘ç”Ÿå®•æœºè€Œå¯¼è‡´æ•°æ®ä¸¢å¤±æ—¶ï¼Œé€šè¿‡é‡åšæ—¥å¿—æ¥å®Œæˆæ•°æ®çš„æ¢å¤ï¼ˆæ—¥å¿—æ˜¯ç£ç›˜é¡ºåºå†™ï¼‰</li>
</ol>
<h3 id="checkpoint-ä½œç”¨"><a href="#checkpoint-ä½œç”¨" class="headerlink" title="checkpoint ä½œç”¨"></a>checkpoint ä½œç”¨</h3><p>ä»ä¸Šé¢ä¸¤ç‚¹å¯ä»¥çŸ¥é“ <code>redo</code> æ—¥å¿—çš„ä½œç”¨ï¼Œä½†æ˜¯ <code>redo</code> æ—¥å¿—æ–‡ä»¶ä¹Ÿä¸å¯èƒ½æ— é™å¤§ï¼Œå³ä½¿å¯ä»¥æ— é™å¤§ï¼Œæœ€ç»ˆæ•°æ®æ¢å¤æ—¶é—´ä¹Ÿå¾ˆæ¼«é•¿ï¼Œæ‰€ä»¥æ‰å¼•å…¥ <code>checkpoint</code> æŠ€æœ¯ï¼Œä¸»è¦è§£å†³ä»¥ä¸‹å‡ ä¸ªé—®é¢˜</p>
<ol>
<li>ç¼©çŸ­æ•°æ®åº“çš„æ¢å¤æ—¶é—´</li>
<li>ç¼“å†²åŒºä¸å¤Ÿç”¨æ—¶ï¼Œå°†è„é¡µåˆ·æ–°åˆ°ç£ç›˜</li>
<li>é‡åšæ—¥å¿—ä¸å¯ç”¨æ—¶ï¼Œåˆ·æ–°è„é¡µ</li>
<li>å› ä¸ºé‡åšæ—¥å¿—ä¸æ˜¯æ— é™å¤§ï¼Œè€Œæ˜¯å¾ªç¯ä½¿ç”¨ï¼Œæ‰€ä»¥å½“è®¾ç½®çš„å¤§å°éƒ½è¢«å ç”¨äº†ï¼Œå°±éœ€è¦å°†è„é¡µæ•°æ®åˆ·ç›˜</li>
</ol>
<p>å¯ä»¥è®¤ä¸º <code>checkpoint</code> å°±æ˜¯ä¸€ä¸ªä¸´ç•Œç‚¹ï¼Œåœ¨ <code>checkpoint</code> ä¹‹å‰çš„æ•°æ®éƒ½å·²ç»å­˜åœ¨ç£ç›˜ä¸Šäº†ï¼Œåœ¨ <code>checkpoint</code> ä¹‹åçš„æ•°æ®å­˜åœ¨ <code>redo</code> æ—¥å¿—å’Œç¼“å­˜é¡µä¸­</p>
<h3 id="checkpoint-å®ç°"><a href="#checkpoint-å®ç°" class="headerlink" title="checkpoint å®ç°"></a>checkpoint å®ç°</h3><ol>
<li>å¯¹äº <code>InnoDB</code> å­˜å‚¨å¼•æ“è€Œè¨€ï¼Œå…¶æ˜¯é€šè¿‡<code>LSNï¼ˆLog Sequence Numberï¼‰</code>æ¥æ ‡è®°ç‰ˆæœ¬çš„ï¼Œ <code>LSN</code> æ˜¯8å­—èŠ‚çš„æ•°å­—ï¼Œ æ¯ä¸ªæ•°æ®é¡µéƒ½æœ‰ <code>LSN</code></li>
<li>é‡åšæ—¥å¿—å’Œ <code>Checkpoint</code> éƒ½ä¼š <code>LSN</code>, å¯ä»¥é€šè¿‡å‘½ä»¤ <code>show engine innodb status\G</code> æŸ¥çœ‹ <code>innodb</code> å¼•æ“ä¿¡æ¯ï¼Œå…¶ä¸­å°±åŒ…å« <code>LSN</code>ï¼Œ æ¯”å¦‚å¦‚ä¸‹æ‰€ç¤º<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Log</span> <span class="keyword">sequence</span> number <span class="number">92561351052</span> </span><br><span class="line"><span class="keyword">Log</span> flushed up <span class="keyword">to</span> <span class="number">92561351052</span> </span><br><span class="line">Last <span class="keyword">checkpoint</span> at <span class="number">92561351052</span></span><br></pre></td></tr></table></figure></li>
<li>åœ¨ <code>InnoDB</code> å­˜å‚¨å¼•æ“å†…éƒ¨ï¼Œæœ‰ä¸¤ç§ <code>Checkpoint</code></li>
<li><strong>Sharp Checkpoint</strong>: å‘ç”Ÿåœ¨æ•°æ®åº“å…³é—­æ—¶ï¼Œéœ€è¦å°†æ‰€æœ‰çš„è„é¡µéƒ½åˆ·æ–°ä¼šç£ç›˜ï¼Œå¯¹åº”çš„æ˜¯ <code>innodb_fast_shutdown=1</code>, ä¹Ÿæ˜¯é»˜è®¤çš„è¡Œä¸º</li>
<li><strong>Fuzzy Checkpoint</strong>ï¼š <code>InnoDB</code> å­˜å‚¨å¼•æ“å†…éƒ¨ä½¿ç”¨ <code>Fuzzy Checkpoint</code>è¿›è¡Œé¡µçš„åˆ·æ–°ï¼Œå³åªåˆ·æ–°ä¸€éƒ¨åˆ†è„é¡µï¼Œè€Œä¸æ˜¯åˆ·æ–°æ‰€æœ‰çš„è„é¡µå›ç£ç›˜</li>
</ol>
<h4 id="Fuzzy-Checkpoint-åˆ·ç›˜æ—¶æœº"><a href="#Fuzzy-Checkpoint-åˆ·ç›˜æ—¶æœº" class="headerlink" title="Fuzzy Checkpoint åˆ·ç›˜æ—¶æœº"></a>Fuzzy Checkpoint åˆ·ç›˜æ—¶æœº</h4><ol>
<li>Master Thread Checkpoint</li>
<li>å·®ä¸å¤šä»¥æ¯ç§’æˆ–æ¯åç§’çš„é€Ÿåº¦ä»ç¼“å†²æ± çš„è„é¡µåˆ—è¡¨ä¸­åˆ·æ–°ä¸€å®šæ¯”ä¾‹çš„é¡µå›ç£ç›˜ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯å¼‚æ­¥çš„</li>
<li>FLUSH_LRU_LIST Checkpoint</li>
<li><code>InnoDB</code> å­˜å‚¨å¼•æ“éœ€è¦ä¿è¯ <code>LRU</code> åˆ—è¡¨ä¸­éœ€è¦æœ‰å·®ä¸å¤š100ä¸ªç©ºé—²é¡µå¯ä¾›ä½¿ç”¨, å…·ä½“å¤šå°‘ä¸ªå¯ä»¥é€šè¿‡å‚æ•° <code>innodb_lru_scan_depth</code> æ§åˆ¶</li>
<li>å½“å‘ç° <code>LRU</code> åˆ—è¡¨ä¸­æ²¡æœ‰é‚£ä¹ˆå¤šç©ºé—²é¡µæ—¶ï¼Œå°±éœ€è¦å°† <code>LRU</code> å°¾ç«¯çš„é¡µç§»é™¤ï¼Œå¦‚æœè¿™äº›é¡µæœ‰è„é¡µï¼Œå°±éœ€è¦è¿›è¡Œ <code>checkpoint</code></li>
<li>Async&#x2F;Sync Flush Checkpoint</li>
<li>å½“é‡åšæ—¥å¿—ä¸å¯ç”¨æ—¶ï¼Œéœ€è¦ä»è„é¡µä¸­å¼ºåˆ¶å°†ä¸€äº›é¡µè¿›è¡Œåˆ·ç›˜</li>
<li>Dirty Page too much Checkpoint</li>
<li>å½“è„é¡µçš„æ•°é‡å¤ªå¤šæ—¶ï¼Œä¸ºäº†ä¿è¯ç¼“å†²åŒºä»æœ‰ç©ºé—´å¯ç”¨ï¼Œä¹Ÿä¼šå¼ºåˆ¶å°†ä¸€äº›è„é¡µåˆ·ç›˜ï¼Œ å¯ä»¥é€šè¿‡å‚æ•° <code>innodb_max_dirty_pages_pct</code> æ§åˆ¶è„é¡µå æ¯”ï¼Œé»˜è®¤æ˜¯ <code>75%</code>ï¼Œ å³å½“ç¼“å†²æ± ä¸­è„é¡µæ•°é‡å åˆ°äº† <code>75%</code> ä¼šå¼ºåˆ¶ <code>checkpoint</code></li>
</ol>
<h2 id="Master-çº¿ç¨‹"><a href="#Master-çº¿ç¨‹" class="headerlink" title="Master çº¿ç¨‹"></a>Master çº¿ç¨‹</h2><ol>
<li><p><code>Master Thread</code> å…·æœ‰æœ€é«˜çš„çº¿ç¨‹ä¼˜å…ˆçº§åˆ«ã€‚å†…éƒ¨ç”±å¤šä¸ªå¾ªç¯ï¼ˆ<code>loop</code>ï¼‰ç»„æˆ</p>
</li>
<li><p><code>Master Thread</code> ä¼šæ ¹æ®æ•°æ®åº“è¿è¡Œçš„çŠ¶æ€åœ¨ <code>loop</code>ã€<code>background loop</code>ã€<code>flush loop</code>å’Œ<code>suspend loop</code>ä¸­è¿›è¡Œåˆ‡æ¢</p>
</li>
</ol>
<p><strong>ä¸»å¾ªç¯ï¼ˆloopï¼‰</strong></p>
<ul>
<li>æ¯ <code>1s</code> çš„æ“ä½œ<ol>
<li>æ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°ç£ç›˜ï¼Œå³ä½¿è¿™ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰æï¼ˆæ€»æ˜¯ï¼‰</li>
<li>åˆå¹¶æ’å…¥ç¼“å†²ï¼ˆå¯èƒ½ï¼‰</li>
<li>è‡³å¤šåˆ·æ–°100ä¸ª <code>InnoDB</code> çš„ç¼“å†²æ± ä¸­çš„è„é¡µç£ç›˜ï¼ˆå¯èƒ½ï¼‰</li>
<li>å¦‚æœå½“å‰æ²¡æœ‰ç”¨æˆ·æ´»åŠ¨ï¼Œåˆ™åˆ‡æ¢åˆ°<code>background loop</code>ï¼ˆå¯èƒ½ï¼‰</li>
</ol>
</li>
<li>æ¯ <code>10s</code> çš„æ“ä½œ<ol>
<li>åˆ·æ–°100ä¸ªè„é¡µåˆ°ç£ç›˜ï¼ˆå¯èƒ½ï¼‰</li>
<li>åˆå¹¶è‡³å¤š5ä¸ªæ’å…¥ç¼“å†²ï¼ˆæ€»æ˜¯ï¼‰</li>
<li>å°†æ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°ç£ç›˜ï¼ˆæ€»æ˜¯ï¼‰</li>
<li>åˆ é™¤æ— ç”¨çš„ <code>Undo</code> é¡µï¼ˆæ€»æ˜¯ï¼‰</li>
</ol>
</li>
</ul>
<p><strong>åå°å¾ªç¯ï¼ˆbackgroup loopï¼‰</strong></p>
<p>è‹¥å½“å‰æ²¡æœ‰ç”¨æˆ·æ´»åŠ¨ï¼ˆæ•°æ®åº“ç©ºé—²æ—¶ï¼‰æˆ–è€…æ•°æ®åº“å…³é—­ï¼ˆ<code>shutdown</code>ï¼‰ï¼Œå°±ä¼šåˆ‡æ¢åˆ°è¿™ä¸ªå¾ªç¯, ä¼šå­˜åœ¨ä»¥ä¸‹æ“ä½œ</p>
<ul>
<li>åˆ é™¤æ— ç”¨çš„ <code>Undo</code> é¡µï¼ˆæ€»æ˜¯ï¼‰</li>
<li>åˆå¹¶20ä¸ªæ’å…¥ç¼“å†²ï¼ˆæ€»æ˜¯ï¼‰</li>
<li>è·³å›åˆ°ä¸»å¾ªç¯ï¼ˆæ€»æ˜¯ï¼‰</li>
<li>ä¸æ–­åˆ·æ–°100ä¸ªé¡µç›´åˆ°ç¬¦åˆæ¡ä»¶ï¼ˆå¯èƒ½ï¼Œè·³è½¬åˆ°<code>flush loop</code>ä¸­å®Œæˆï¼‰</li>
</ul>
<p><strong>åˆ·æ–°å¾ªç¯ï¼ˆflush loopï¼‰</strong> </p>
<p>ä¸»è¦æ˜¯å°†ç¼“å†²åŒºè„é¡µæ•°æ®åˆ·æ–°åˆ°ç£ç›˜</p>
<p><strong>æš‚åœå¾ªç¯ï¼ˆsuspend loopï¼‰</strong><br>è‹¥ <code>flush loop</code> ä¸­ä¹Ÿæ²¡æœ‰ä»€ä¹ˆäº‹æƒ…å¯ä»¥åšäº†ï¼Œ<code>InnoDB</code>å­˜å‚¨å¼•æ“ä¼šåˆ‡æ¢åˆ°<code>suspend loop</code>ï¼Œå°†<code>Master Thread</code>æŒ‚èµ·ï¼Œç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿ</p>
<p>åœ¨ <code>InnoDB1.2.x</code>ç‰ˆæœ¬ä¸­ä» <code>Master Thread</code> çº¿ç¨‹åˆ†ç¦»åˆ°ä¸€ä¸ªå•ç‹¬çš„<code> Page Cleaner Thread</code>ï¼Œä»è€Œå‡è½»äº†<code>Master Thread</code>çš„å·¥ä½œï¼ŒåŒæ—¶è¿›ä¸€æ­¥æé«˜äº†ç³»ç»Ÿçš„å¹¶å‘æ€§</p>
<h2 id="æ’å…¥ç¼“å†²-Insert-Buffer"><a href="#æ’å…¥ç¼“å†²-Insert-Buffer" class="headerlink" title="æ’å…¥ç¼“å†² Insert Buffer"></a>æ’å…¥ç¼“å†² Insert Buffer</h2><h3 id="Insert-Buffer-åœ¨å“ªé‡Œ"><a href="#Insert-Buffer-åœ¨å“ªé‡Œ" class="headerlink" title="Insert Buffer åœ¨å“ªé‡Œ"></a>Insert Buffer åœ¨å“ªé‡Œ</h3><p><code>Insert Buffer</code>å’Œæ•°æ®é¡µä¸€æ ·ï¼Œä¹Ÿæ˜¯ç‰©ç†é¡µçš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼ˆç¼“å†²åŒºä¸­ä¹Ÿæœ‰ <code>Insert Buffer</code>, å«ä¹‰ä¸åŒï¼‰</p>
<h3 id="ä¸ºä»€ä¹ˆè¦æœ‰-Insert-Buffer"><a href="#ä¸ºä»€ä¹ˆè¦æœ‰-Insert-Buffer" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æœ‰ Insert Buffer"></a>ä¸ºä»€ä¹ˆè¦æœ‰ Insert Buffer</h3><ol>
<li>æ¯ä¸ªè¡¨éƒ½æœ‰ä¸€ä¸ªä¸»é”®ï¼Œå¦‚æœæ˜¯è‡ªå¢çš„é‚£ä¹ˆæ•°æ®æ˜¯æŒ‰ç…§ä¸»é”®é¡ºåºå­˜å‚¨çš„ï¼Œè¿™ç§æƒ…å†µä¸‹æ•°æ®æ–°å¢æ˜¯å¾ˆå¿«çš„ï¼Œå› ä¸ºæ˜¯æœ‰é¡ºåºçš„</li>
<li>å¦‚æœä¸»é”®ä¸æ˜¯è‡ªå¢çš„ï¼Œæˆ–è€…å…¶ä»–éèšé›†ç´¢å¼•ï¼ˆå…ˆç†è§£æˆéä¸»é”®ç´¢å¼•ï¼‰éƒ½å¯èƒ½ä¸æ˜¯è‡ªå¢çš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®é¡µçš„å­˜æ”¾è¿˜æ˜¯æŒ‰ä¸»é”®è¿›è¡Œé¡ºåºå­˜æ”¾çš„ï¼Œä½†æ˜¯å¯¹äºéèšé›†ç´¢å¼•å¶å­èŠ‚ç‚¹çš„æ’å…¥ä¸å†æ˜¯é¡ºåºçš„äº†ï¼Œè¿™æ—¶å°±éœ€è¦ç¦»æ•£åœ°è®¿é—®éèšé›†ç´¢å¼•é¡µï¼Œç”±äºéšæœºè¯»å–çš„å­˜åœ¨è€Œå¯¼è‡´äº†æ’å…¥æ“ä½œæ€§èƒ½ä¸‹é™</li>
<li><code>Insert Buffer</code> çš„ä½œç”¨å°±æ˜¯å¯¹äºéèšé›†ç´¢å¼•çš„æ’å…¥æˆ–æ›´æ–°æ“ä½œï¼Œä¸æ˜¯æ¯ä¸€æ¬¡ç›´æ¥æ’å…¥åˆ°ç´¢å¼•é¡µä¸­ï¼Œè€Œæ˜¯å…ˆåˆ¤æ–­æ’å…¥çš„éèšé›†ç´¢å¼•é¡µæ˜¯å¦åœ¨ç¼“å†²æ± ä¸­ï¼Œè‹¥åœ¨ï¼Œåˆ™ç›´æ¥æ’å…¥ï¼›è‹¥ä¸åœ¨ï¼Œåˆ™å…ˆæ”¾å…¥åˆ°ä¸€ä¸ª<code>Insert Buffer</code>å¯¹è±¡ä¸­ï¼Œ ç„¶åå†ä»¥ä¸€å®šçš„é¢‘ç‡å’Œæƒ…å†µè¿›è¡Œ<code>Insert Buffer</code>å’Œè¾…åŠ©ç´¢å¼•é¡µå­èŠ‚ç‚¹çš„<code>merge</code>ï¼ˆåˆå¹¶ï¼‰æ“ä½œï¼Œè¿™æ—¶é€šå¸¸èƒ½å°†å¤šä¸ªæ’å…¥åˆå¹¶åˆ°ä¸€ä¸ªæ“ä½œä¸­ï¼ˆå› ä¸ºåœ¨ä¸€ä¸ªç´¢å¼•é¡µä¸­ï¼‰ï¼Œè¿™å°±å¤§å¤§æé«˜äº†å¯¹äºéèšé›†ç´¢å¼•æ’å…¥çš„æ€§èƒ½</li>
</ol>
<h3 id="ä½¿ç”¨-Insert-Buffer-éœ€è¦æ»¡è¶³çš„æ¡ä»¶"><a href="#ä½¿ç”¨-Insert-Buffer-éœ€è¦æ»¡è¶³çš„æ¡ä»¶" class="headerlink" title="ä½¿ç”¨ Insert Buffer éœ€è¦æ»¡è¶³çš„æ¡ä»¶"></a>ä½¿ç”¨ Insert Buffer éœ€è¦æ»¡è¶³çš„æ¡ä»¶</h3><ol>
<li>ç´¢å¼•æ˜¯è¾…åŠ©ç´¢å¼•</li>
<li>ç´¢å¼•ä¸æ˜¯å”¯ä¸€çš„ï¼š å¦‚æœç´¢å¼•å”¯ä¸€ï¼Œå°±è¿˜éœ€è¦æŸ¥æ‰¾åˆ¤æ–­æ“ä½œï¼Œæ­¤æ—¶ä½¿ç”¨ <code>Insert Buffer</code> å°±ä¸èƒ½æå‡æ€§èƒ½äº†</li>
</ol>
<p>æ‰€ä»¥ <code>Insert Buffer</code> ä¸»è¦æ˜¯ä¸ºäº†æé«˜ç´¢å¼•é¡µæ•°æ®æ’å…¥çš„æ€§èƒ½</p>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>InnoDBå­˜å‚¨å¼•æ“ä¹‹MVCCè¯¦è§£</title>
    <url>/2023/7aa9bac70e9b/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>


<h2 id="mysql8-æŸ¥çœ‹äº‹åŠ¡çš„éš”ç¦»çº§åˆ«"><a href="#mysql8-æŸ¥çœ‹äº‹åŠ¡çš„éš”ç¦»çº§åˆ«" class="headerlink" title="mysql8 æŸ¥çœ‹äº‹åŠ¡çš„éš”ç¦»çº§åˆ«"></a>mysql8 æŸ¥çœ‹äº‹åŠ¡çš„éš”ç¦»çº§åˆ«</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æŸ¥çœ‹å½“å‰ä¼šè¯çš„éš”ç¦»çº§åˆ«</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction_isolation</span>;</span><br><span class="line"><span class="comment">-- æŸ¥çœ‹å…¨å±€çš„éš”ç¦»çº§åˆ«</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@global</span>.transaction_isolation;</span><br></pre></td></tr></table></figure>

<h2 id="undo-log-ç‰ˆæœ¬é“¾"><a href="#undo-log-ç‰ˆæœ¬é“¾" class="headerlink" title="undo log ç‰ˆæœ¬é“¾"></a>undo log ç‰ˆæœ¬é“¾</h2><ul>
<li>æ¯ä¸€æ¡æ•°æ®éƒ½æœ‰ä¸¤ä¸ªéšè—å­—æ®µ<ul>
<li><code>trx_id</code>: äº‹åŠ¡id</li>
<li><code>roll_pointer</code>: æŒ‡å‘äº†æ›´æ–°è¿™ä¸ªäº‹åŠ¡ä¹‹å‰çš„ <code>undo log</code></li>
</ul>
</li>
</ul>
<h3 id="trx-id-çš„ä½œç”¨"><a href="#trx-id-çš„ä½œç”¨" class="headerlink" title="trx_id çš„ä½œç”¨"></a>trx_id çš„ä½œç”¨</h3><p>åœ¨ <code>InnoDB</code> å­˜å‚¨å¼•æ“ä¸­ï¼Œ<code>trx_id</code> æ˜¯ä¸€ä¸ªç”¨äº<strong>æ ‡è¯†äº‹åŠ¡çš„å”¯ä¸€æ ‡è¯†ç¬¦</strong>ã€‚<code>trx_id</code> çš„ç”Ÿæˆæ—¶æœºæ˜¯åœ¨äº‹åŠ¡å¼€å§‹æ—¶ç”Ÿæˆçš„</p>
<p>ä¸‹é¢ä¸¾ä¾‹è¯´æ˜ï¼Œæ¯”å¦‚æ–°å¢ä¸€æ¡æ•°æ®ï¼Œäº‹åŠ¡ id ä¸º10ï¼Œå› ä¸ºä¹‹å‰æ²¡æœ‰æ•°æ®ï¼Œæ‰€ä»¥ <code>roll_pointer</code> æŒ‡å‘ <code>null</code></p>
<pre class="mermaid">graph LR
    subgraph A["äº‹åŠ¡A"]
        direction LR
        A1["å€¼A"]
        A2["trx_id=10"]
        A3["roll_pointer"]
        A1~~~A2~~~A3
    end</pre>

<p>æ¥ä¸‹æ¥å¦å¤–ä¸€ä¸ªäº‹åŠ¡å¯åŠ¨ï¼Œæ›´æ–°åŒä¸€æ¡æ•°æ®ï¼Œå°†å€¼ä» A æ”¹ä¸º B, æ­¤æ—¶å¯¹åº”æ•°æ®çŠ¶æ€ä¸º</p>
<pre class="mermaid">graph LR
    subgraph A["äº‹åŠ¡A"]
        direction LR
        A1["å€¼A"]
        A2["trx_id=10"]
        A3["roll_pointer"]
        A1~~~A2~~~A3
    end
    subgraph B["äº‹åŠ¡B"]
        direction LR
        B1["å€¼B"]
        B2["trx_id=15"]
        B3["roll_pointer"]
        B1~~~B2~~~B3
    end
    B3-.->A3
    style B3 fill:#8ff600
    style A3 fill:#8ff600</pre>

<p>åå¯åŠ¨çš„äº‹åŠ¡çš„ <code>roll_pointer</code> æŒ‡å‘äº†å‰é¢çš„æ•°æ®</p>
<p>å½“è¿˜æœ‰å…¶ä»–äº‹åŠ¡æ¥ä¿®æ”¹è¿™æ¡æ•°æ®æ—¶ï¼Œå¯¹åº”çš„æ•°æ®çŠ¶æ€ä¸º</p>
<pre class="mermaid">graph LR
    subgraph A["äº‹åŠ¡A"]
        direction LR
        A1["å€¼A"]
        A2["trx_id=10"]
        A3["roll_pointer"]
        A1~~~A2~~~A3
    end
    subgraph B["äº‹åŠ¡B"]
        direction LR
        B1["å€¼B"]
        B2["trx_id=15"]
        B3["roll_pointer"]
        B1~~~B2~~~B3
    end
    subgraph C["äº‹åŠ¡C"]
        direction LR
        C1["å€¼C"]
        C2["trx_id=20"]
        C3["roll_pointer"]
        C1~~~C2~~~C3
    end
    C3-.->B3-.->A3
    style B3 fill:#8ff600
    style A3 fill:#8ff600
    style C3 fill:#8ff600</pre>

<p>è¿™å°±æ˜¯ <code>undo log</code> ç‰ˆæœ¬é“¾ï¼Œä¹Ÿæ˜¯ <code>MVCC</code> çš„å®ç°åŸºç¡€ï¼Œ å¦å¤–ä¸€ä¸ªå®ç°åŸºç¡€æ˜¯ <code>ReadView</code> æœºåˆ¶</p>
<h2 id="ReadView-æœºåˆ¶"><a href="#ReadView-æœºåˆ¶" class="headerlink" title="ReadView æœºåˆ¶"></a>ReadView æœºåˆ¶</h2><p>å½“æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡çš„æ—¶å€™ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ª <code>ReadView</code>ï¼Œ <code>ReadView</code> ä¸­æ¯”è¾ƒé‡è¦çš„æœ‰å››ä¸ªå­—æ®µ</p>
<ol>
<li><code>m_ids</code>: å½“å‰äº‹åŠ¡å¼€å§‹æ—¶ï¼Œè¿˜æœ‰å“ªäº›äº‹åŠ¡ä¹Ÿæ­£åœ¨æ‰§è¡Œï¼ˆå³è¿˜æäº¤çš„äº‹åŠ¡ï¼‰</li>
<li><code>min_trx_id</code>: <code>m_ids</code> ä¸­æœ€å°çš„å€¼</li>
<li><code>max_trx_id</code>: <code>Mysql</code> ä¸‹ä¸€ä¸ªè¦ç”Ÿæˆçš„äº‹åŠ¡id</li>
<li><code>creator_trx_id</code>: å½“å‰äº‹åŠ¡çš„id</li>
</ol>
<h3 id="ReadView-ç”Ÿæˆæ—¶æœº"><a href="#ReadView-ç”Ÿæˆæ—¶æœº" class="headerlink" title="ReadView ç”Ÿæˆæ—¶æœº"></a>ReadView ç”Ÿæˆæ—¶æœº</h3><p>å‰é¢æœ‰æåˆ° <code>trx_id</code> çš„ç”Ÿæˆæ—¶æœºæ˜¯åœ¨äº‹åŠ¡å¼€å§‹æ—¶ç”Ÿæˆçš„ï¼Œè€Œ <code>ReadView</code> å¹¶ä¸æ˜¯åœ¨äº‹åŠ¡å¼€å§‹æ—¶ç”Ÿæˆçš„ï¼Œè€Œæ˜¯åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œè¯»æ“ä½œæ“ä½œæ—¶æ‰ä¼šç”Ÿæˆ <code>ReadView</code></p>
<p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨å½“å‰äº‹åŠ¡çš„ <code>ReadView</code> ä¸­å¯èƒ½ä¼šå­˜åœ¨äº‹åŠ¡id æ¯”å½“å‰äº‹åŠ¡id å¤§çš„äº‹åŠ¡å­˜åœ¨</p>
<h2 id="RCï¼ˆRead-Commitedï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†"><a href="#RCï¼ˆRead-Commitedï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†" class="headerlink" title="RCï¼ˆRead Commitedï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†"></a>RCï¼ˆRead Commitedï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†</h2><p><code>RC</code> éš”ç¦»çº§åˆ«æŒ‡çš„æ˜¯ä¸€ä¸ªäº‹åŠ¡ä¸­å¯ä»¥è¯»å–åˆ°å…¶ä»–äº‹åŠ¡æäº¤çš„æ•°æ®ï¼Œå…¶ä»–äº‹åŠ¡æœªæäº¤æ•°æ®æ— æ³•è¯»å–åˆ°</p>
<p>ä¸‹é¢ä¸¾ä¾‹è¯´æ˜å¦‚ä½•åŸºäº <code>undo log</code> å’Œ <code>ReadView</code> æœºåˆ¶å®ç° <code>RC</code> éš”ç¦»çº§åˆ«</p>
<p>db ä¸­æŸæ¡æ•°æ®çš„åˆå§‹å€¼ <code>trx_id=10</code><br>åœ¨æŸä¸ªæ—¶åˆ»æœ‰äº‹åŠ¡ A å’Œ äº‹åŠ¡ B åŒæ—¶æ“ä½œè¿™æ¡æ•°æ®ï¼Œäº‹åŠ¡A æ˜¯æŸ¥è¯¢ï¼Œäº‹åŠ¡Bæ˜¯ä¿®æ”¹ï¼Œæˆ‘ä»¬çš„è§‚å¯Ÿè§’åº¦æ˜¯äº‹åŠ¡A</p>
<p><strong>äº‹åŠ¡Bä¿®æ”¹äº†æ•°æ®ä½†æœªæäº¤</strong><br>å› ä¸ºäº‹åŠ¡B ä¿®æ”¹äº†æ•°æ®ï¼Œæ­¤æ—¶ <code>undo log</code> ç‰ˆæœ¬é“¾å¦‚ä¸‹æ‰€ç¤º</p>
<pre class="mermaid">graph LR
    subgraph A["åˆå§‹æ•°æ®"]
        direction LR
        A1["åˆå§‹å€¼"]
        A2["trx_id=10"]
        A3["roll_pointer"]
        A1~~~A2~~~A3
    end
    subgraph B["äº‹åŠ¡B"]
        direction LR
        B1["å€¼B"]
        B2["trx_id=15"]
        B3["roll_pointer"]
        B1~~~B2~~~B3
    end
    B3-.->A3
    style B3 fill:#8ff600
    style A3 fill:#8ff600</pre>

<p><strong>äº‹åŠ¡Aè¯»å–æ•°æ®</strong><br>äº‹åŠ¡A æ‰§è¡Œ <code>select</code> æ“ä½œæ—¶ï¼Œå°±ä¼šç”Ÿæˆ <code>ReadView</code>ï¼Œ æ­¤æ—¶ <code>ReadView</code> æ¶‰åŠåˆ°çš„å€¼å¦‚ä¸‹æ‰€ç¤º<br>äº‹åŠ¡A(trx_id&#x3D;15), äº‹åŠ¡B(trx_id&#x3D;20)<br><code>m_ids</code>: [15, 20]<br><code>min_trx_id</code>: 15<br><code>max_trx_id</code>: 21<br><code>creator_trx_id</code>: 15</p>
<p>è¯»å–åˆ°æ•°æ®B, è¿™æ¡æ•°æ®çš„ <code>trx_id=20</code>, <code>trx_id</code> æ¯”è‡ªå·±çš„äº‹åŠ¡idå¤§ï¼Œä½†æ˜¯<strong>åœ¨</strong> <code>m_ids</code> ä¸­ï¼Œè¯´æ˜è¿™æ¡æ•°æ®æ˜¯å’Œäº‹åŠ¡A å·®ä¸å¤šåŒæ—¶å¯åŠ¨çš„äº‹åŠ¡æ“ä½œçš„ï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰æäº¤ï¼Œé‚£ä¹ˆäº‹åŠ¡A å°±ä¸èƒ½è¿›è¡Œè¯»å–ï¼Œéœ€è¦é¡ºç€ <code>undo log</code> ç‰ˆæœ¬é“¾ç»§ç»­å¯»æ‰¾ï¼Œ<code>undo log</code> çš„ä¸‹ä¸€æ¡æ•°æ®çš„ <code>trx_id=10</code>, æ¯” <code>creator_trx_id=15</code> å°ï¼Œè¯´æ˜æ˜¯åœ¨äº‹åŠ¡A å¼€å¯ä¹‹å‰å°±å·²ç»æäº¤çš„ï¼Œå¯ä»¥è¯»å–ï¼Œæ‰€ä»¥è¯»å–åˆ°çš„æ˜¯ <strong>åˆå§‹å€¼</strong> è€Œä¸æ˜¯ <strong>æ•°æ®B</strong></p>
<p><strong>äº‹åŠ¡Bæäº¤æ•°æ®åäº‹åŠ¡Aå†è¯»å–</strong><br>å¯¹äº <code>RC</code> éš”ç¦»çº§åˆ«ï¼Œæ˜¯æ¯æ¬¡è¯»å–æ•°æ®æ—¶éƒ½ä¼šç”Ÿæˆ <code>ReadView</code>ï¼Œ æ‰€ä»¥äº‹åŠ¡B æäº¤æ•°æ®åï¼Œäº‹åŠ¡A å†è¯»å–æ—¶ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ <code>ReadView</code>ï¼Œæ­¤æ—¶ <code>ReadView</code> æ¶‰åŠåˆ°çš„å€¼å¦‚ä¸‹æ‰€ç¤º<br>äº‹åŠ¡A(trx_id&#x3D;15)<br><code>m_ids</code>: [15]<br><code>min_trx_id</code>: 15<br><code>max_trx_id</code>: 21<br><code>creator_trx_id</code>: 15</p>
<p>è¯»å–åˆ°æ•°æ®B, è¿™æ¡æ•°æ®çš„ <code>trx_id=20</code>, <code>trx_id</code> æ¯”è‡ªå·±çš„äº‹åŠ¡idå¤§ï¼Œä½†æ˜¯<strong>ä¸åœ¨</strong> <code>m_ids</code> ä¸­ï¼Œè¯´æ˜è¿™æ¡æ•°æ®æ˜¯å’Œäº‹åŠ¡A å·®ä¸å¤šåŒæ—¶å¯åŠ¨çš„äº‹åŠ¡æ“ä½œçš„ï¼Œå¹¶ä¸”å·²ç»æäº¤ï¼Œé‚£ä¹ˆäº‹åŠ¡A å°±å¯ä»¥è¿›è¡Œè¯»å–ï¼Œè¯»å–åˆ°çš„å°±æ˜¯ <strong>æ•°æ®B</strong></p>
<p><strong>æ€»ç»“ï¼šRC éš”ç¦»çº§åˆ«å¯ä»¥å®ç°è¯»å–åˆ°å…¶ä»–äº‹åŠ¡æäº¤çš„æ•°æ®çš„æ ¸å¿ƒæ˜¯åœ¨å½“å‰äº‹åŠ¡ä¸­æ¯æ¬¡æ‰§è¡Œ <code>select</code> ä¸­éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ <code>ReadView</code></strong></p>
<h2 id="RRï¼ˆRepeatable-Readï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†"><a href="#RRï¼ˆRepeatable-Readï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†" class="headerlink" title="RRï¼ˆRepeatable Readï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†"></a>RRï¼ˆRepeatable Readï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†</h2><p>åœ¨ <code>Mysql</code> ä¸­ <code>RR</code>  éš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢ å¹»è¯»ï¼Œä¸å¯é‡å¤è¯»å’Œå¹»è¯»</p>
<p><code>RR</code> å’Œ <code>RC</code> éš”ç¦»çº§åˆ«å®ç°ä¸Šçš„åŒºåˆ«æ˜¯ï¼š <code>RR</code> éš”ç¦»çº§åˆ«åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­åªä¼šåœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶ç”Ÿæˆ <code>ReadView</code>ï¼Œä¹‹åçš„æŸ¥è¯¢åªä¼šä½¿ç”¨å½“å‰äº‹åŠ¡çš„ <code>ReadView</code></p>
<p>ä¸‹é¢ä¸¾ä¾‹è¯´æ˜å¦‚ä½•åŸºäº <code>undo log</code> å’Œ <code>ReadView</code> æœºåˆ¶å®ç° <code>RR</code> éš”ç¦»çº§åˆ«, ä¾ç„¶ä½¿ç”¨ <code>RC</code> éš”ç¦»çº§åˆ«çš„ä¾‹å­</p>
<p>db ä¸­æŸæ¡æ•°æ®çš„åˆå§‹å€¼ <code>trx_id=10</code><br>åœ¨æŸä¸ªæ—¶åˆ»æœ‰äº‹åŠ¡A å’Œ äº‹åŠ¡B åŒæ—¶æ“ä½œè¿™æ¡æ•°æ®ï¼Œäº‹åŠ¡A æ˜¯æŸ¥è¯¢ï¼Œäº‹åŠ¡Bæ˜¯ä¿®æ”¹ï¼Œæˆ‘ä»¬çš„è§‚å¯Ÿè§’åº¦æ˜¯äº‹åŠ¡A</p>
<p><strong>äº‹åŠ¡Bä¿®æ”¹äº†æ•°æ®ä½†æœªæäº¤</strong><br>å› ä¸ºäº‹åŠ¡ B ä¿®æ”¹äº†æ•°æ®ï¼Œæ­¤æ—¶ <code>undo log</code> ç‰ˆæœ¬é“¾å¦‚ä¸‹æ‰€ç¤º</p>
<pre class="mermaid">graph LR
    subgraph A["åˆå§‹æ•°æ®"]
        direction LR
        A1["åˆå§‹å€¼"]
        A2["trx_id=10"]
        A3["roll_pointer"]
        A1~~~A2~~~A3
    end
    subgraph B["äº‹åŠ¡B"]
        direction LR
        B1["å€¼B"]
        B2["trx_id=15"]
        B3["roll_pointer"]
        B1~~~B2~~~B3
    end
    B3-.->A3
    style B3 fill:#8ff600
    style A3 fill:#8ff600</pre>

<p><strong>äº‹åŠ¡Aè¯»å–æ•°æ®</strong><br>äº‹åŠ¡ A æ‰§è¡Œ <code>select</code> æ“ä½œæ—¶ï¼Œå°±ä¼šç”Ÿæˆ <code>ReadView</code>ï¼Œ æ­¤æ—¶ <code>ReadView</code> æ¶‰åŠåˆ°çš„å€¼å¦‚ä¸‹æ‰€ç¤º<br>äº‹åŠ¡A(trx_id&#x3D;15), äº‹åŠ¡B(trx_id&#x3D;20)<br><code>m_ids</code>: [15, 20]<br><code>min_trx_id</code>: 15<br><code>max_trx_id</code>: 21<br><code>creator_trx_id</code>: 15</p>
<p>è¯»å–åˆ°æ•°æ®B, è¿™æ¡æ•°æ®çš„ <code>trx_id=20</code>, <code>trx_id</code> æ¯”è‡ªå·±çš„äº‹åŠ¡idå¤§ï¼Œä½†æ˜¯<strong>åœ¨</strong> <code>m_ids</code> ä¸­ï¼Œè¯´æ˜è¿™æ¡æ•°æ®æ˜¯å’Œäº‹åŠ¡ A å·®ä¸å¤šåŒæ—¶å¯åŠ¨çš„äº‹åŠ¡æ“ä½œçš„ï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰æäº¤ï¼Œé‚£ä¹ˆäº‹åŠ¡ A å°±ä¸èƒ½è¿›è¡Œè¯»å–ï¼Œéœ€è¦é¡ºç€ <code>undo log</code> ç‰ˆæœ¬é“¾ç»§ç»­å¯»æ‰¾ï¼Œ<code>undo log</code> çš„ä¸‹ä¸€æ¡æ•°æ®çš„ <code>trx_id=10</code>, æ¯” <code>creator_trx_id=15</code> å°ï¼Œè¯´æ˜æ˜¯åœ¨äº‹åŠ¡ A å¼€å¯ä¹‹å‰å°±å·²ç»æäº¤çš„ï¼Œå¯ä»¥è¯»å–ï¼Œæ‰€ä»¥è¯»å–åˆ°çš„æ˜¯ <strong>åˆå§‹å€¼</strong> è€Œä¸æ˜¯ <strong>æ•°æ®B</strong></p>
<p><strong>äº‹åŠ¡Bæäº¤æ•°æ®åäº‹åŠ¡Aå†è¯»å–</strong><br>å¯¹äº <code>RR</code> éš”ç¦»çº§åˆ«ï¼Œåªä¼šåœ¨ç¬¬ä¸€æ¬¡ <code>select</code> æ—¶ç”Ÿæˆ <code>ReadView</code>ï¼Œ æ‰€ä»¥äº‹åŠ¡ B æäº¤æ•°æ®åï¼Œäº‹åŠ¡ A å†è¯»å–æ—¶ï¼Œä½¿ç”¨çš„è¿˜æ˜¯ä¹‹å‰é‚£ä¸ª <code>ReadView</code>ï¼Œæ­¤æ—¶ <code>ReadView</code> æ¶‰åŠåˆ°çš„å€¼å¦‚ä¸‹æ‰€ç¤º<br>äº‹åŠ¡A(trx_id&#x3D;15)<br><code>m_ids</code>: [15, 20]<br><code>min_trx_id</code>: 15<br><code>max_trx_id</code>: 21<br><code>creator_trx_id</code>: 15</p>
<p>è¯»å–åˆ°æ•°æ®B, è¿™æ¡æ•°æ®çš„ <code>trx_id=20</code>, <code>trx_id</code> æ¯”è‡ªå·±çš„äº‹åŠ¡idå¤§ï¼Œå¹¶ä¸”åœ¨ <code>min_trx_id</code> å’Œ <code>max_trx_id</code> ä¹‹é—´ï¼ŒåŒæ—¶è¿˜åœ¨ <code>m_ids</code> ä¸­ï¼Œè¯´æ˜è¿™æ¡æ•°æ®æ˜¯å’Œäº‹åŠ¡ A å·®ä¸å¤šåŒæ—¶å¯åŠ¨çš„äº‹åŠ¡æ“ä½œçš„ï¼Œäº‹åŠ¡ A ä¸å¯ä»¥è¯»å–ï¼Œæ‰€ä»¥é¡ºç€ <code>undo log</code> ç‰ˆæœ¬é“¾ç»§ç»­å¾€å‰æ‰¾ï¼Œæ‰¾åˆ° <code>trx_id=10</code>, è¯´æ˜æ˜¯åœ¨äº‹åŠ¡ A å¼€å¯ä¹‹å‰å°±å·²ç»æäº¤çš„ï¼Œå¯ä»¥è¯»å–ï¼Œæ‰€ä»¥è¯»å–åˆ°çš„æ˜¯ <strong>åˆå§‹å€¼</strong></p>
<h3 id="ä¸ºä»€ä¹ˆ-Mysql-çš„-RR-éš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢å¹»è¯»"><a href="#ä¸ºä»€ä¹ˆ-Mysql-çš„-RR-éš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢å¹»è¯»" class="headerlink" title="ä¸ºä»€ä¹ˆ Mysql çš„ RR éš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢å¹»è¯»"></a>ä¸ºä»€ä¹ˆ Mysql çš„ RR éš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢å¹»è¯»</h3><p>åœ¨ <ol><li><a href="/2023/ba87d5c56893/index.html" title="Mysqläº‹åŠ¡éš”ç¦»çº§åˆ«">Mysqläº‹åŠ¡éš”ç¦»çº§åˆ«</a></li></ol> ä¸­æœ‰æåˆ°åœ¨ <code>Sql</code> æ ‡å‡†ä¸­ï¼Œ<code>RR</code> éš”ç¦»çº§åˆ«ä¸‹ä¸èƒ½é˜²æ­¢å¹»è¯»ï¼Œä½†æ˜¯åœ¨ <code>Mysql</code> ä¸­ï¼Œ<code>RR</code> éš”ç¦»çº§åˆ«ä¸‹å¯ä»¥è®¿é—®å¹»è¯»ï¼Œä¸‹é¢ä¸¾ä¾‹è¯´æ˜</p>
<p>æ¯”å¦‚ä¸‹é¢çš„ <code>sql</code> è¯­å¥å¯ä»¥æŸ¥è¯¢å‡ºä¸¤æ¡æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>æ•°æ®åˆå§‹å€¼ä¸º</p>
<table>
<thead>
<tr>
<th>trx_idï¼ˆéšè—å­—æ®µï¼‰</th>
<th>id</th>
</tr>
</thead>
<tbody><tr>
<td>10</td>
<td>11</td>
</tr>
<tr>
<td>15</td>
<td>12</td>
</tr>
</tbody></table>
<p>ç°åœ¨æœ‰äº‹åŠ¡ Aï¼Œ B åŒæ—¶æ“ä½œï¼Œäº‹åŠ¡ A æ˜¯æŸ¥è¯¢ï¼Œäº‹åŠ¡ B æ˜¯æ–°å¢æ•°æ®</p>
<p><strong>äº‹åŠ¡A ç¬¬ä¸€æ¬¡æŸ¥è¯¢</strong><br>æ­¤æ—¶å‡è®¾äº‹åŠ¡ A çš„ <code>ReadView</code> å¦‚ä¸‹<br>äº‹åŠ¡A(trx_id&#x3D;16), äº‹åŠ¡B(trx_id&#x3D;17)<br><code>m_ids</code>: [16, 17]<br><code>min_trx_id</code>: 16<br><code>max_trx_id</code>: 18<br><code>creator_trx_id</code>: 16</p>
<p>å› ä¸ºäº‹åŠ¡ B è¿˜æ²¡æœ‰çœŸæ­£æ’å…¥æ•°æ®ï¼Œæ‰€ä»¥äº‹åŠ¡ A æŸ¥è¯¢çš„å°±æ˜¯ä¸Šé¢å±•ç¤ºçš„ä¸¤æ¡æ•°æ®</p>
<p><strong>äº‹åŠ¡B æ–°å¢æ•°æ®å¹¶æäº¤</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student(id) <span class="keyword">values</span>(<span class="number">13</span>);</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶æ•°æ®åº“ä¸­æœ‰ä¸‰æ¡æ•°æ®</p>
<table>
<thead>
<tr>
<th>trx_idï¼ˆéšè—å­—æ®µï¼‰</th>
<th>id</th>
</tr>
</thead>
<tbody><tr>
<td>10</td>
<td>11</td>
</tr>
<tr>
<td>15</td>
<td>12</td>
</tr>
<tr>
<td>17</td>
<td>13</td>
</tr>
</tbody></table>
<p><strong>äº‹åŠ¡A ç¬¬äºŒæ¬¡æŸ¥è¯¢</strong><br>æ­¤æ—¶äº‹åŠ¡ A çš„ <code>ReadVew</code> è¿˜æ˜¯å’Œä¹‹å‰ä¸€æ ·ï¼Œå¹¶ä¸ä¼šæ”¹å˜<br><code>m_ids</code>: [16, 17]<br><code>min_trx_id</code>: 16<br><code>max_trx_id</code>: 18<br><code>creator_trx_id</code>: 16<br>å½“æ‰§è¡Œä¸‹é¢çš„ <code>sql</code> æ—¶å¯ä»¥æŸ¥è¯¢å‡º 3 æ¡æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯å…¶ä¸­æœ‰ä¸€æ¡æ•°æ®çš„ <code>trx_id=17</code>, 17 åœ¨å½“å‰ <code>ReadView</code> çš„ <code>min_trx_id</code> å’Œ <code>max_trx_id</code> ä¹‹é—´ï¼Œè¯´æ˜æ˜¯åœ¨äº‹åŠ¡ A å¼€å¯ä¹‹åæ‰æ–°å¢çš„æ•°æ®ï¼Œè¿™æ¡æ•°æ®å°±ä¸èƒ½å±•ç¤ºå‡ºæ¥</p>
<p><strong>æ€»ç»“ï¼š<code>RR</code> éš”ç¦»çº§åˆ«åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­åªä¼šåœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶ç”Ÿæˆ <code>ReadView</code>ï¼Œä¹‹åçš„æŸ¥è¯¢åªä¼šä½¿ç”¨å½“å‰äº‹åŠ¡çš„ <code>ReadView</code></strong></p>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysqläº‹åŠ¡éš”ç¦»çº§åˆ«</title>
    <url>/2023/ba87d5c56893/index.html</url>
    <content><![CDATA[<h2 id="äº‹åŠ¡çš„å››ä¸ªç‰¹ç‚¹"><a href="#äº‹åŠ¡çš„å››ä¸ªç‰¹ç‚¹" class="headerlink" title="äº‹åŠ¡çš„å››ä¸ªç‰¹ç‚¹"></a>äº‹åŠ¡çš„å››ä¸ªç‰¹ç‚¹</h2><ol>
<li>åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šäº‹åŠ¡æ˜¯ä¸€ä¸ªåŸå­æ“ä½œå•å…ƒï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œï¼Œä¸ä¼šå‡ºç°éƒ¨åˆ†æ‰§è¡Œçš„æƒ…å†µã€‚</li>
<li>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸæ²¡æœ‰è¢«ç ´åï¼Œå³æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚</li>
<li>éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šå¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œæ¯ä¸ªäº‹åŠ¡çš„æ“ä½œåº”è¯¥ä¸å…¶ä»–äº‹åŠ¡çš„æ“ä½œç›¸äº’éš”ç¦»ï¼Œä¸ä¼šç›¸äº’å¹²æ‰°ã€‚</li>
<li>æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šä¸€æ—¦äº‹åŠ¡æäº¤ï¼Œå…¶æ‰€åšçš„ä¿®æ”¹ä¼šæ°¸ä¹…ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œå³ä½¿ç³»ç»Ÿå‘ç”Ÿæ•…éšœä¹Ÿä¸ä¼šä¸¢å¤±ã€‚</li>
</ol>
<h2 id="å¹¶å‘è¯»å†™æ•°æ®å¸¦æ¥çš„é—®é¢˜"><a href="#å¹¶å‘è¯»å†™æ•°æ®å¸¦æ¥çš„é—®é¢˜" class="headerlink" title="å¹¶å‘è¯»å†™æ•°æ®å¸¦æ¥çš„é—®é¢˜"></a>å¹¶å‘è¯»å†™æ•°æ®å¸¦æ¥çš„é—®é¢˜</h2><ol>
<li>è„å†™</li>
<li>è„è¯»</li>
<li>ä¸å¯é‡å¤è¯»</li>
<li>å¹»è¯»</li>
</ol>
<p><strong>è„å†™</strong></p>
<ol>
<li>äº‹åŠ¡ Aï¼ŒB åŒæ—¶å¼€å§‹å‡†å¤‡æ›´æ–°ä¸€æ¡æ•°æ®</li>
<li>äº‹åŠ¡ A æ›´æ–°</li>
<li>äº‹åŠ¡ B æ›´æ–°</li>
<li>äº‹åŠ¡ A å›æ»šï¼Œå°†äº‹åŠ¡ B æ›´æ–°çš„æ•°æ®ä¹Ÿå›æ»šäº†</li>
</ol>
<p>å¯¹äºäº‹åŠ¡ B æ¥è¯´ï¼Œè‡ªå·±æ›´æ–°äº†ï¼Œä½†æ˜¯çœ‹åˆ°çš„æ˜¯æ²¡æœ‰æ›´æ–°çš„æ•°æ®ï¼Œè¿™å°±æ˜¯è„å†™ã€‚</p>
<p><strong>è„è¯»</strong></p>
<ol>
<li>äº‹åŠ¡ Aï¼ŒB åŒæ—¶å¼€å¯å‡†å¤‡å¤„ç†æ•°æ®</li>
<li>äº‹åŠ¡ B æ›´æ–°äº†æ•°æ®ï¼Œä½†æ˜¯æ²¡æœ‰æäº¤</li>
<li>äº‹åŠ¡ A æ‹¿åˆ°äº‹åŠ¡ B æ›´æ–°çš„æ•°æ®</li>
<li>äº‹åŠ¡ B å›æ»š</li>
<li>äº‹åŠ¡ A å†æ¬¡æŸ¥è¯¢ï¼Œå‘ç°æ•°æ®å˜äº†</li>
</ol>
<p>å¯¹äºäº‹åŠ¡ A æ¥è¯´ï¼Œå› ä¸ºè¯»å–åˆ°äº†äº‹åŠ¡ B è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¯¼è‡´è‡ªå·±å…ˆåä¸¤æ¬¡è¯»å–çš„ç»“æœä¸åŒï¼Œè¿™å°±æ˜¯è„è¯»ã€‚</p>
<p><strong>ä¸å¯é‡å¤è¯»</strong></p>
<ol>
<li>äº‹åŠ¡ Aï¼ŒB åŒæ—¶å¼€å§‹å‡†å¤‡å¤„ç†æ•°æ®</li>
<li>äº‹åŠ¡ A è¯»å–æ•°æ® Aï¼ˆäº‹åŠ¡ A ä¸€ç›´å¼€å¯ç€ï¼‰</li>
<li>äº‹åŠ¡ B å°†æ•°æ® A æ›´æ–°æˆæ•°æ® B</li>
<li>äº‹åŠ¡ A å†æ¬¡è¯»å–ï¼Œç»“æœå˜æˆäº† æ•°æ®B, åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œäº‹åŠ¡ A ä¸¤æ¬¡è¯»å–çš„ç»“æœä¸ä¸€è‡´ï¼Œè¿™å°±æ˜¯ä¸å¯é‡å¤è¯»</li>
</ol>
<p>æ€»ç»“ï¼šä¸€ä¸ªäº‹åŠ¡è¯»å–åˆ°äº†å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¸­<strong>æäº¤</strong>çš„ <code>update</code> çš„æ•°æ®</p>
<p><strong>å¹»è¯»</strong><br>æŒ‡ä¸€ä¸ªäº‹åŠ¡è¯»å–åˆ°äº†å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¸­<strong>æäº¤</strong>çš„ <code>insert</code> çš„æ•°æ®</p>
<h2 id="Sql-éš”ç¦»çº§åˆ«"><a href="#Sql-éš”ç¦»çº§åˆ«" class="headerlink" title="Sql éš”ç¦»çº§åˆ«"></a>Sql éš”ç¦»çº§åˆ«</h2><p>é’ˆå¯¹ä»¥ä¸Šåœ¨å¤šäº‹åŠ¡å¹¶å‘æ—¶å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼Œåœ¨ <code>Sql</code> æ ‡å‡†ä¸­è§„å®šäº†å‡ ç§éš”ç¦»çº§åˆ«ï¼Œç”¨æ¥è§£å†³è¿™äº›é—®é¢˜</p>
<table>
<thead>
<tr>
<th>éš”ç¦»çº§åˆ«</th>
<th>è„è¯»</th>
<th>ä¸å¯é‡å¤è¯»</th>
<th>å¹»è¯»</th>
</tr>
</thead>
<tbody><tr>
<td>è¯»æœªæäº¤ï¼ˆRead uncommittedï¼‰</td>
<td>å¯èƒ½</td>
<td>å¯èƒ½</td>
<td>å¯èƒ½</td>
</tr>
<tr>
<td>è¯»å·²æäº¤ï¼ˆRead committedï¼‰</td>
<td>ä¸å¯èƒ½</td>
<td>å¯èƒ½</td>
<td>å¯èƒ½</td>
</tr>
<tr>
<td>å¯é‡å¤è¯»ï¼ˆRepeatable readï¼‰</td>
<td>ä¸å¯èƒ½</td>
<td>ä¸å¯èƒ½</td>
<td>å¯èƒ½</td>
</tr>
<tr>
<td>ä¸²è¡ŒåŒ–</td>
<td>ä¸å¯èƒ½</td>
<td>ä¸å¯èƒ½</td>
<td>ä¸å¯èƒ½</td>
</tr>
</tbody></table>
<p>åœ¨ <code>Sql</code> æ ‡å‡†çš„éš”ç¦»çº§åˆ«ä¸­ï¼Œ<code>RR</code> éš”ç¦»çº§åˆ«æ˜¯ç”¨æ¥ä¿è¯åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¯¹åŒä¸€è¡Œæ•°æ®çš„å¤šæ¬¡æŸ¥è¯¢ï¼Œä¸ä¼šè¯»å–åˆ°ä¸ä¸€æ ·çš„æ•°æ®ï¼Œä½†æ˜¯é’ˆå¯¹èŒƒå›´æŸ¥è¯¢æ¥è¯´ï¼Œå¦‚æœåœ¨æŸ¥è¯¢èŒƒå›´å†…æ–°å¢äº†æ•°æ®å¹¶ä¸”è¿˜æäº¤äº†ï¼Œä¾ç„¶æ˜¯å¯ä»¥è¢«è¯»å–åˆ°çš„ï¼Œæ‰€ä»¥ <code>RR</code> éš”ç¦»çº§åˆ«è¿˜æ˜¯å¯èƒ½å‘ç”Ÿ <strong>å¹»è¯»</strong></p>
<p>åœ¨ <code>Mysql</code> çš„ <code>RR</code> éš”ç¦»çº§åˆ«ä¸‹ä¸ä¼šå‘ç”Ÿ <strong>å¹»è¯»</strong>ï¼Œå…·ä½“åŸå› å¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/7aa9bac70e9b/index.html" title="InnoDBå­˜å‚¨å¼•æ“ä¹‹MVCCè¯¦è§£">InnoDBå­˜å‚¨å¼•æ“ä¹‹MVCCè¯¦è§£</a></li></ol>

<h2 id="æŸ¥çœ‹-Mysql8-éš”ç¦»çº§åˆ«"><a href="#æŸ¥çœ‹-Mysql8-éš”ç¦»çº§åˆ«" class="headerlink" title="æŸ¥çœ‹ Mysql8 éš”ç¦»çº§åˆ«"></a>æŸ¥çœ‹ Mysql8 éš”ç¦»çº§åˆ«</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction_isolation</span>;</span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysqlæ•´ä½“æ¶æ„</title>
    <url>/2023/fd974035a1b5/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<pre class="mermaid">flowchart LR
    K1["å®¢æˆ·ç«¯è¿æ¥"]
    K2["å®¢æˆ·ç«¯è¿æ¥"]
    K1 & K2--1--->A
    subgraph A["MysqlæœåŠ¡å™¨"]
        direction LR
        subgraph A1["è¿æ¥æ± "]
            direction TB
            A11[è¿æ¥]
            A12[è¿æ¥]
            A13[è¿æ¥]
            A11~~~A12~~~A13
        end
        subgraph A3["çº¿ç¨‹"]
        end
        
        A1--"2(è·å–sqlè¯­å¥)"-->A3

        subgraph A2["sqlç›¸å…³å¤„ç†"]
            direction TB
            A23["3(sqlæ¥å£)"]
            A24["4(sqlè§£æå™¨)"]
            A25["5(æŸ¥è¯¢ä¼˜åŒ–å™¨)"]
            A26["6(æ‰§è¡Œå™¨)"]
            A23-->A24-->A25-->A26
        end

        A3-->A2
        subgraph A4["7(å­˜å‚¨å¼•æ“)"]
        end
        A2-->A4
    end</pre>
<p>ä¸‹é¢æŒ‰ç…§ä¸Šå›¾ä¸­æ ‡çš„æ•°å­—çš„é¡ºåºè¿›è¡Œæ¢³ç†</p>
<h2 id="1-è¿æ¥æ± "><a href="#1-è¿æ¥æ± " class="headerlink" title="1 è¿æ¥æ± "></a>1 è¿æ¥æ± </h2><ol>
<li>æˆ‘ä»¬å¹³æ—¶æ‰€è¯´çš„è¿æ¥æ± ä¸€èˆ¬éƒ½æ˜¯æŒ‡åº”ç”¨ç«¯çš„è¿æ¥æ± ï¼Œæ¯”å¦‚ä¸€ä¸ª <code>Java</code> åº”ç”¨è¿æ¥æ•°æ®åº“æ—¶ï¼Œ<code>Java</code> åº”ç”¨ä¼šæœ‰ä¸€ä¸ªè¿æ¥æ± å»è¿æ¥æ•°æ®åº“</li>
<li><code>Mysql</code> æœåŠ¡å™¨è‡ªèº«ä¹Ÿæ˜¯æœ‰ä¸€ä¸ªè¿æ¥æ± æ¥å’Œå®¢æˆ·ç«¯è¿›è¡Œè¿æ¥ï¼Œè¿™ä¸ªè¿æ¥æ± ç®¡ç†äº†å„ç§ç³»ç»Ÿè·Ÿè¿™å°æ•°æ®åº“æœåŠ¡å™¨å»ºç«‹çš„æ‰€æœ‰è¿æ¥</li>
</ol>
<h2 id="2-çº¿ç¨‹å¤„ç†è¿æ¥"><a href="#2-çº¿ç¨‹å¤„ç†è¿æ¥" class="headerlink" title="2 çº¿ç¨‹å¤„ç†è¿æ¥"></a>2 çº¿ç¨‹å¤„ç†è¿æ¥</h2><p>å¯¹äºç½‘ç»œè¿æ¥ä¸€èˆ¬éƒ½æ˜¯éœ€è¦å•ç‹¬çš„çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ªçº¿ç¨‹æ¥ç›‘å¬è¯·æ±‚ä»¥åŠè·å–è¯·æ±‚æ•°æ®</p>
<h2 id="3-sqlæ¥å£"><a href="#3-sqlæ¥å£" class="headerlink" title="3 sqlæ¥å£"></a>3 sqlæ¥å£</h2><ol>
<li><code>MySQL</code> çš„å·¥ä½œçº¿ç¨‹æ¥æ”¶åˆ°<code>SQL</code>è¯­å¥ä¹‹åï¼Œå°±ä¼šè½¬äº¤ç»™<code>SQL</code>æ¥å£å»æ‰§è¡Œ</li>
<li>è¿™ç§è®¾è®¡å’Œ <code>java</code> ç±»ä¼¼ï¼Œä¹Ÿæ˜¯é¢å‘æ¥å£ç¼–ç¨‹ï¼Œå¤–éƒ¨ä½¿ç”¨åªéœ€è¦å’Œæ¥å£æ‰“äº¤é“ï¼Œå±è”½äº†å†…éƒ¨å¤æ‚çš„å®ç°é€»è¾‘</li>
</ol>
<h2 id="4-sqlè§£æå™¨"><a href="#4-sqlè§£æå™¨" class="headerlink" title="4 sqlè§£æå™¨"></a>4 sqlè§£æå™¨</h2><ol>
<li>æŸ¥è¯¢è§£æå™¨<code>(Parser)</code>å°±æ˜¯è´Ÿè´£å¯¹<code>SQL</code>è¯­å¥è¿›è¡Œè§£æ, è¿™é‡Œçš„è§£æçš„å«ä¹‰å…¶å®å°±æ˜¯æŒ‰ç…§ <code>SQL</code> è¯­æ³•å¯¹ <code>SQL</code> è¿›è¡Œæ‹†è§£ï¼Œ æ¯”å¦‚ä¸‹é¢çš„ä¸€ä¸ª <code>SQL</code></li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™ä¸ª <code>SQL</code> è¯­å¥åªæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²è€Œå·²ï¼Œä½†æ˜¯é€šè¿‡ <strong>æŸ¥è¯¢è§£æå™¨</strong> åï¼Œå°±å¯ä»¥çŸ¥é“ <code>user</code> å¯¹åº”çš„æ˜¯è¡¨ï¼Œ<code>id</code> å¯¹åº”çš„æ˜¯è¡¨é‡Œé¢çš„ä¸€ä¸ªå­—æ®µ</p>
<h2 id="5-æŸ¥è¯¢ä¼˜åŒ–å™¨"><a href="#5-æŸ¥è¯¢ä¼˜åŒ–å™¨" class="headerlink" title="5 æŸ¥è¯¢ä¼˜åŒ–å™¨"></a>5 æŸ¥è¯¢ä¼˜åŒ–å™¨</h2><ol>
<li>æŸ¥è¯¢ä¼˜åŒ–å™¨çš„ä½œç”¨æ˜¯ <strong>é€‰æ‹©æœ€ä¼˜çš„æŸ¥è¯¢è·¯å¾„</strong></li>
<li>ä¸€æ¡ <code>SQL</code> è¯­å¥å¯ä»¥æœ‰å¤šä¸ªæ–¹å¼è¾¾åˆ°æœ€ç»ˆçš„æ•ˆæœï¼Œè¿˜æ˜¯å·² <code>select * from user where id = 1;</code> è¿™ä¸ª <code>SQL</code> è¯­å¥ä¸¾ä¾‹<ol>
<li>ç¬¬ä¸€ç§æ–¹å¼æ˜¯å¯ä»¥å…ˆè·å–åˆ°æ‰€æœ‰æ•°æ®ï¼Œç„¶åæ ¹æ® <code>id=1</code> è¿™ä¸ªæ¡ä»¶å»è¿‡æ»¤ï¼Œå†å°†ç»“æœè¿”å›</li>
<li>ç¬¬äºŒç§æ–¹å¼ä¹Ÿå¯ä»¥æ˜¯å…ˆæ‹¿åˆ° <code>id=1</code> è¿™ä¸ªæ¡ä»¶ï¼Œç„¶åç›´æ¥å®šä½ <code>id=1</code> çš„æ•°æ®ï¼Œå†å°†ç»“æœè¿”å›</li>
</ol>
</li>
</ol>
<h2 id="6-æ‰§è¡Œå™¨"><a href="#6-æ‰§è¡Œå™¨" class="headerlink" title="6 æ‰§è¡Œå™¨"></a>6 æ‰§è¡Œå™¨</h2><ol>
<li>æ‰§è¡Œå™¨æ˜¯æ ¹æ®æ‰§è¡Œè®¡åˆ’è°ƒç”¨å­˜å‚¨å¼•æ“çš„æ¥å£</li>
<li>æ‰§è¡Œå™¨ä¼šæ ¹æ®ä¼˜åŒ–å™¨é€‰æ‹©çš„æ‰§è¡Œæ–¹æ¡ˆï¼ŒæŒ‰ç…§ä¸€å®šçš„é¡ºåºå»è°ƒç”¨å­˜å‚¨å¼•æ“çš„æ¥å£ï¼ŒæŠŠ<code>SQL</code>è¯­å¥çš„é€»è¾‘ç»™æ‰§è¡Œ</li>
</ol>
<h2 id="7-å­˜å‚¨å¼•æ“"><a href="#7-å­˜å‚¨å¼•æ“" class="headerlink" title="7 å­˜å‚¨å¼•æ“"></a>7 å­˜å‚¨å¼•æ“</h2><p>å­˜å‚¨å¼•æ“å…¶å®å°±æ˜¯çœŸæ­£æ‰§è¡Œ<code>SQL</code>è¯­å¥çš„ï¼Œä»–ä¼šæŒ‰ç…§ä¸€å®šçš„æ­¥éª¤å»æŸ¥è¯¢å†…å­˜ç¼“å­˜æ•°æ®ï¼Œæ›´æ–°ç£ç›˜æ•°æ®ï¼ŒæŸ¥è¯¢ç£ç›˜æ•°æ®ç­‰æ“ä½œ</p>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysqlé…ç½®é¡¹å’Œé…ç½®æ–‡ä»¶</title>
    <url>/2023/59d19215016d/index.html</url>
    <content><![CDATA[<p>ä»¥ä¸‹åŸºäº <code>Mysql8</code> ç‰ˆæœ¬</p>
<h2 id="Mysql-ç¨‹åºé€‰é¡¹"><a href="#Mysql-ç¨‹åºé€‰é¡¹" class="headerlink" title="Mysql ç¨‹åºé€‰é¡¹"></a>Mysql ç¨‹åºé€‰é¡¹</h2><p><code>Mysql</code> æ˜¯ä¸€ä¸ª <strong>å®¢æˆ·ç«¯-æœåŠ¡ç«¯</strong> ç¨‹åºï¼Œå®‰è£… <code>Mysql</code> å <code>bin</code> ç›®å½•ä¸‹æœ‰å¾ˆå¤šå¯æ‰§è¡Œç¨‹åºï¼Œæ¯”å¦‚</p>
<ul>
<li>å¯åŠ¨æœåŠ¡ç«¯çš„ <code>Mysqld</code> ç¨‹åº</li>
<li>å¯åŠ¨æœåŠ¡ç«¯çš„ <code>mysqld_safe</code> è„šæœ¬ç¨‹åºï¼Œè¿™ä¸ªè„šæœ¬ä¹Ÿä¼šå¯åŠ¨ <code>Mysqld</code>, ä½†ä¼šåŒ…å«æ›´å¤šåŠŸèƒ½</li>
<li>å¯åŠ¨å®¢æˆ·ç«¯çš„ <code>Mysql</code> ç¨‹åº</li>
</ul>
<p>è¿˜æœ‰å¾ˆå¤šå¯æ‰§è¡Œç¨‹åºï¼Œå…·ä½“å¯ä»¥å‚è€ƒ <a href="https://dev.mysql.com/doc/refman/8.0/en/programs-overview.html">Mysql programs</a></p>
<p>è¿™äº›å¯æ‰§è¡Œç¨‹åºåœ¨å¯åŠ¨æ—¶éƒ½å¯ä»¥æŒ‡å®šå‚æ•°ï¼Œè¿™äº›å‚æ•°æœ‰ä¸¤ç§å½¢å¼</p>
<ul>
<li>é•¿æ ¼å¼<ul>
<li>ä»¥ <code>--</code> å¼€å¤´</li>
<li>å¦‚æœå¯¹åº”çš„å‚æ•°æœ‰å€¼ï¼Œåˆ™æ˜¯ <code>--key=value</code> å½¢å¼ï¼Œæ¯”å¦‚ <code>--port=3306</code>ï¼Œ æ³¨æ„ å¯¹åº”çš„ <code>key</code>, <code>=</code> å’Œ <code>value</code> ä¹‹é—´ä¸è¦æœ‰ç©ºæ ¼ï¼Œ æ¯”å¦‚ <code>--port = 3306</code> å½¢å¼æ˜¯é”™è¯¯çš„</li>
</ul>
</li>
<li>çŸ­æ ¼å¼<ul>
<li>ä»¥ <code>-</code> å¼€å¤´</li>
<li>å¦‚æœå¯¹åº”çš„å‚æ•°æœ‰å€¼ï¼Œåˆ™æ˜¯ <code>-key value</code> å½¢å¼ï¼Œæ¯”å¦‚ <code>-p 3306</code>ï¼Œ å‚æ•°å’Œå€¼ä¹‹é—´ä¸éœ€è¦ <code>=</code></li>
</ul>
</li>
</ul>
<h3 id="å¯æ‰§è¡Œç¨‹åºæ”¯æŒçš„é€‰é¡¹"><a href="#å¯æ‰§è¡Œç¨‹åºæ”¯æŒçš„é€‰é¡¹" class="headerlink" title="å¯æ‰§è¡Œç¨‹åºæ”¯æŒçš„é€‰é¡¹"></a>å¯æ‰§è¡Œç¨‹åºæ”¯æŒçš„é€‰é¡¹</h3><p>å¯ä»¥é€šè¿‡ <code>--help</code> æ¥æŸ¥çœ‹å¯¹åº”å¯æ‰§è¡Œå‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯ï¼Œä¸€èˆ¬ä¼šåœ¨å¸®åŠ©ä¿¡æ¯ä¸­åˆ—å‡ºæ”¯æŒçš„é€‰é¡¹ï¼Œæ¯”å¦‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mysql --<span class="built_in">help</span></span><br><span class="line">mysql  Ver 8.0.35 <span class="keyword">for</span> Linux on x86_64 (MySQL Community Server - GPL)</span><br><span class="line">Copyright (c) 2000, 2023, Oracle and/or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Usage: mysql [OPTIONS] [database]</span><br><span class="line">  -?, --<span class="built_in">help</span>          Display this <span class="built_in">help</span> and <span class="built_in">exit</span>.</span><br><span class="line">  -I, --<span class="built_in">help</span>          Synonym <span class="keyword">for</span> -?</span><br><span class="line">  --auto-rehash       Enable automatic rehashing. One doesn<span class="string">&#x27;t need to use</span></span><br><span class="line"><span class="string">                      &#x27;</span><span class="built_in">rehash</span><span class="string">&#x27; to get table and field completion, but startup</span></span><br><span class="line"><span class="string">                      and reconnecting may take a longer time. Disable with</span></span><br><span class="line"><span class="string">                      --disable-auto-rehash.</span></span><br><span class="line"><span class="string">                      (Defaults to on; use --skip-auto-rehash to disable.)</span></span><br><span class="line"><span class="string">    â€¦â€¦ çœç•¥</span></span><br></pre></td></tr></table></figure>

<h2 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h2><p>é€šè¿‡å‘½ä»¤è¡Œæ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶å¹¶ä¸”åœ¨å‘½ä»¤åé¢å¢åŠ å‚æ•°æ˜¯ä¸€æ¬¡æ€§æœ‰æ•ˆçš„ï¼Œå¦‚æœåœæ­¢äº† <code>Mysql</code> æœåŠ¡ï¼Œå†æ¬¡å¯åŠ¨éœ€è¦é‡æ–°æŒ‡å®šå‚æ•°ï¼Œæ‰€ä»¥å¯ä»¥å°†å‚æ•°å†™åœ¨é…ç½®æ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨æ¯æ¬¡éƒ½æŒ‡å®šå‚æ•°äº†ã€‚</p>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/option-files.html">Mysqlé…ç½®æ–‡ä»¶å®˜æ–¹æ–‡æ¡£è¯´æ˜</a></p>
<h3 id="Unix-å’Œ-ç±»-Unix-ä¸‹é…ç½®æ–‡ä»¶è¯»å–ä½ç½®"><a href="#Unix-å’Œ-ç±»-Unix-ä¸‹é…ç½®æ–‡ä»¶è¯»å–ä½ç½®" class="headerlink" title="Unix å’Œ ç±» Unix ä¸‹é…ç½®æ–‡ä»¶è¯»å–ä½ç½®"></a>Unix å’Œ ç±» Unix ä¸‹é…ç½®æ–‡ä»¶è¯»å–ä½ç½®</h3><table>
<thead>
<tr>
<th>File Name</th>
<th>Purpose</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;etc&#x2F;my.cnf</td>
<td>Global options</td>
</tr>
<tr>
<td>&#x2F;etc&#x2F;mysql&#x2F;my.cnf</td>
<td>Global options</td>
</tr>
<tr>
<td>SYSCONFDIR&#x2F;my.cnf</td>
<td>Global options</td>
</tr>
<tr>
<td>$MYSQL_HOME&#x2F;my.cnf</td>
<td>Server-specific options (server only)</td>
</tr>
<tr>
<td>defaults-extra-file</td>
<td>The file specified with â€“defaults-extra-file, if any</td>
</tr>
<tr>
<td>~&#x2F;.my.cn</td>
<td>User-specific options</td>
</tr>
<tr>
<td>~&#x2F;.mylogin.cnf</td>
<td>User-specific login path options (clients only)</td>
</tr>
<tr>
<td>DATADIR&#x2F;mysqld-auto.cnf</td>
<td>System variables persisted with SET PERSIST or SET PERSIST_ONLY (server only)</td>
</tr>
</tbody></table>
<ul>
<li><code>$MYSQL_HOME</code> æ˜¯ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥è‡ªå·±è®¾ç½®<ol><li><a href="/2023/1f7648c2ff11/index.html" title="Ubuntuä¸­è®¾ç½®ç¯å¢ƒå˜é‡çš„å‡ ç§æ–¹å¼">Ubuntuä¸­è®¾ç½®ç¯å¢ƒå˜é‡çš„å‡ ç§æ–¹å¼</a></li></ol></li>
<li>ä»¥ <code>~</code> å¼€å¤´çš„åˆ™æ˜¯ç”¨æˆ·ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶</li>
<li><code>defaults-extra-file</code> æ˜¯æŒ‡é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚ <code>mysqld --defaults-extra-file=/usr/loca/mysql.cnf</code></li>
</ul>
<h3 id="é…ç½®æ–‡ä»¶åŒ…å«çš„å†…å®¹"><a href="#é…ç½®æ–‡ä»¶åŒ…å«çš„å†…å®¹" class="headerlink" title="é…ç½®æ–‡ä»¶åŒ…å«çš„å†…å®¹"></a>é…ç½®æ–‡ä»¶åŒ…å«çš„å†…å®¹</h3><p>ä¸‹é¢æ˜¯ä¸€ä¸ª <code>my.cnf</code> é…ç½®æ–‡ä»¶çš„ç¤ºä¾‹</p>
<figure class="highlight clean"><table><tr><td class="code"><pre><span class="line">###### [mysql]é…ç½®æ¨¡å— ######</span><br><span class="line">[mysql]</span><br><span class="line"># è®¾ç½®MySQLå®¢æˆ·ç«¯é»˜è®¤å­—ç¬¦é›†</span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">###### [mysqld]é…ç½®æ¨¡å— ######</span><br><span class="line">[mysqld]</span><br><span class="line">port=<span class="number">3306</span></span><br><span class="line">user=root</span><br><span class="line">#skip-grant-tables</span><br><span class="line">sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION</span><br><span class="line"></span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ éƒ¨åˆ†å†…å®¹</p>
<ul>
<li>æ³¨é‡Šå’Œç©ºè¡Œ</li>
<li>[mysql]ï¼Œ [mysqld] è¿™ç§åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ç§°ä¸º  <code>group</code>, ä¹Ÿå°±æ˜¯é…ç½®æ–‡ä»¶è¢«åˆ†ç»„äº†ï¼Œç»„é‡Œé¢çš„å†…å®¹å°±æ˜¯å¯æ‰§è¡Œæ–‡ä»¶å<ul>
<li>ä¸åŒç»„ä¸‹çš„é…ç½®é¡¹æ˜¯ç»™ä¸åŒçš„å¯åŠ¨å‘½ä»¤ä½¿ç”¨çš„ï¼Œå¦‚æœé€‰é¡¹ç»„åç§°ä¸ç¨‹åºåç§°ç›¸åŒï¼Œåˆ™ç»„ä¸­çš„é€‰é¡¹å°†åº”ç”¨äºè¯¥ç¨‹åºï¼Œ æ¯”å¦‚ <code>[mysql]</code> ç»„ä¸‹é¢çš„é€‰é¡¹ä¼šåœ¨ä½¿ç”¨ <code>mysql</code> å‘½ä»¤æ—¶è¯»å–</li>
<li><code>[server]</code> ç»„ä¸‹é…ç½®é¡¹å°†ä½œç”¨äºæ‰€æœ‰çš„æœåŠ¡å™¨ç¨‹åº</li>
<li><code>[client]</code> ç»„ä¸‹é…ç½®é¡¹å°†ä½œç”¨äºæ‰€æœ‰çš„å®¢æˆ·ç«¯ç¨‹åº</li>
<li><code>[mysqld_safe]</code> å’Œ <code>[mysql.server]</code> è¿™ä¸¤ä¸ªç¨‹åºåœ¨å¯åŠ¨æ—¶é™¤äº†è¯»å–è‡ªå·±ç»„ä¸‹çš„é…ç½®è¿˜ä¼šè¯»å– <code>[mysqld]</code> ä¸‹çš„é…ç½®</li>
</ul>
</li>
<li>ç»„ä¸‹é¢çš„å…·ä½“é…ç½®<ul>
<li>é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®é¡¹åªèƒ½æ˜¯é•¿æ ¼å¼ï¼Œè€Œä¸”ä¸éœ€è¦ <code>--</code> å¼€å¤´</li>
</ul>
</li>
</ul>
<h3 id="é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§"><a href="#é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§" class="headerlink" title="é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§"></a>é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§</h3><p><strong>ä¸åŒé…ç½®æ–‡ä»¶çš„ä¼˜å…ˆçº§</strong></p>
<p>ä¸åŒç›®å½•ä¸‹éƒ½æœ‰é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”æœ‰ç›¸åŒçš„é…ç½®é¡¹çš„æƒ…å†µä¸‹ï¼Œä»¥åè¯»å–çš„ä¸ºå‡†ï¼Œä¸Šé¢å·²ç»åˆ—å‡ºäº†è¯»å–çš„ç›®å½•</p>
<table>
<thead>
<tr>
<th>File Name</th>
<th>Purpose</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;etc&#x2F;my.cnf</td>
<td>Global options</td>
</tr>
<tr>
<td>&#x2F;etc&#x2F;mysql&#x2F;my.cnf</td>
<td>Global options</td>
</tr>
<tr>
<td>SYSCONFDIR&#x2F;my.cnf</td>
<td>Global options</td>
</tr>
<tr>
<td>$MYSQL_HOME&#x2F;my.cnf</td>
<td>Server-specific options (server only)</td>
</tr>
<tr>
<td>defaults-extra-file</td>
<td>The file specified with â€“defaults-extra-file, if any</td>
</tr>
<tr>
<td>~&#x2F;.my.cn</td>
<td>User-specific options</td>
</tr>
<tr>
<td>~&#x2F;.mylogin.cnf</td>
<td>User-specific login path options (clients only)</td>
</tr>
<tr>
<td>DATADIR&#x2F;mysqld-auto.cnf</td>
<td>System variables persisted with SET PERSIST or SET PERSIST_ONLY (server only)</td>
</tr>
</tbody></table>
<p>å¦‚æœ <code>/etc/my.cnf </code> å’Œ <code>~/.my.cn</code> ä¸‹éƒ½æœ‰ç›¸åŒçš„é…ç½®ï¼Œåˆ™ä½¿ç”¨çš„æ˜¯ <code> ~/.my.cn</code> é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹</p>
<p><strong>ç›¸åŒé…ç½®æ–‡ä»¶çš„ä¼˜å…ˆçº§</strong></p>
<ol>
<li><code>mysql</code> é…ç½®æ–‡ä»¶æœ‰å¤šä¸ª <code>group</code></li>
<li>è‹¥æ˜¯åœ¨ä¸åŒçš„ <code>group</code> ä¸­å‡ºç°ç›¸åŒçš„é…ç½®åˆ™ä»¥æœ€åä¸€ä¸ª <code>group</code> ä¸­å‡ºç°çš„é…ç½®ä¸ºå‡†ï¼ˆå‰ææ˜¯å¯¹åº”çš„ç¨‹åºä¼šè¯»å–è¿™ä¸ª <code>group</code> çš„é…ç½®ï¼‰</li>
</ol>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysqlé”æœºåˆ¶è¯¦è§£</title>
    <url>/2023/fefcb42b5b82/index.html</url>
    <content><![CDATA[<h2 id="Mysql-ä¸­é”çš„æ¦‚å¿µ"><a href="#Mysql-ä¸­é”çš„æ¦‚å¿µ" class="headerlink" title="Mysql ä¸­é”çš„æ¦‚å¿µ"></a>Mysql ä¸­é”çš„æ¦‚å¿µ</h2><p>é”æ˜¯æ•°æ®åº“ç³»ç»ŸåŒºåˆ«äºæ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªå…³é”®ç‰¹æ€§ã€‚é”æœºåˆ¶ç”¨äºç®¡ç†å¯¹å…±äº«èµ„æºçš„å¹¶å‘è®¿é—®</p>
<h2 id="Mysql-ä¸­ä¸é”ç›¸å…³çš„è¡¨"><a href="#Mysql-ä¸­ä¸é”ç›¸å…³çš„è¡¨" class="headerlink" title="Mysql ä¸­ä¸é”ç›¸å…³çš„è¡¨"></a>Mysql ä¸­ä¸é”ç›¸å…³çš„è¡¨</h2><h3 id="Mysql5-ç‰ˆæœ¬"><a href="#Mysql5-ç‰ˆæœ¬" class="headerlink" title="Mysql5.* ç‰ˆæœ¬"></a>Mysql5.* ç‰ˆæœ¬</h3><ol>
<li><code>information_schema.INNODB_TRX</code></li>
<li><code>information_schema.INNODB_LOCKS</code></li>
<li><code>information_schema.INNODB_LOCK_WAITS</code></li>
</ol>
<h3 id="Mysql8-ç‰ˆæœ¬"><a href="#Mysql8-ç‰ˆæœ¬" class="headerlink" title="Mysql8 ç‰ˆæœ¬"></a>Mysql8 ç‰ˆæœ¬</h3><ol>
<li><code>information_schema.INNODB_TRX</code></li>
<li><code>performance_schema.INNODB_LOCKS</code></li>
<li><code>performance_schema.INNODB_LOCK_WAITS</code></li>
</ol>
<h2 id="å…±äº«é”å’Œäº’æ–¥é”"><a href="#å…±äº«é”å’Œäº’æ–¥é”" class="headerlink" title="å…±äº«é”å’Œäº’æ–¥é”"></a>å…±äº«é”å’Œäº’æ–¥é”</h2><p>å…±äº«é”ç®€å†™ä¸º      S<br>æ„å‘å…±äº«é”ç®€å†™ä¸º  IS<br>æ’ä»–é”ç®€å†™ä¸º      X<br>æ„å‘æ’ä»–é”ç®€å†™ä¸º  IX</p>
<table>
<thead>
<tr>
<th>é”ç±»å‹</th>
<th>ç‹¬å é”</th>
<th>å…±äº«é”</th>
</tr>
</thead>
<tbody><tr>
<td>ç‹¬å é”</td>
<td>äº’æ–¥</td>
<td>äº’æ–¥</td>
</tr>
<tr>
<td>å…±äº«é”</td>
<td>äº’æ–¥</td>
<td>ä¸äº’æ–¥</td>
</tr>
</tbody></table>
<ul>
<li><code>Mysql</code> æŸ¥è¯¢æ“ä½œé»˜è®¤é»˜è®¤ä¸ä¼šåŠ é”</li>
<li><code>Mysql</code> åœ¨è¯»å’Œå†™ä¹‹é—´ä¸ä¼šäº’æ–¥ï¼Œå› ä¸ºå¯¹äºè¯»æ“ä½œæ˜¯ç›´æ¥ä½¿ç”¨ <code>MVCC</code> æ¥å®ç°</li>
<li>æ‰‹åŠ¨ç»™ <code>select</code> å¢åŠ å…±äº«é”çš„æ–¹å¼æ˜¯  <code>select * from table_name lock in share mode;</code></li>
<li>æ‰‹åŠ¨ç»™ <code>select</code> å¢åŠ ç‹¬å é”çš„æ–¹å¼æ˜¯   <code>select * from table_name for update;</code></li>
</ul>
<h2 id="è¡¨çº§é”"><a href="#è¡¨çº§é”" class="headerlink" title="è¡¨çº§é”"></a>è¡¨çº§é”</h2><p>è¡¨çº§é”åˆ†ä¸ºä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯ <strong>è¡¨é”</strong> å’Œ <strong>è¡¨çº§æ„å‘é”</strong></p>
<p><strong>è¡¨é”</strong></p>
<ol>
<li>è¡¨çº§å…±äº«é”ï¼š <code>LOCK TABLES xxx READ</code></li>
<li>è¡¨çº§ç‹¬å é”ï¼š <code>LOCK TABLES xxx WRITE</code></li>
</ol>
<p>å¯ä»¥ä½¿ç”¨ <code>unlock tables;</code> æ¥é‡Šæ”¾æ‰€æœ‰çš„è¡¨çº§é”</p>
<p><strong>è¡¨çº§æ„å‘é”</strong></p>
<ul>
<li>æ›´æ–°æ•°æ®æ—¶ï¼Œé™¤äº†ä¼šå¢åŠ è¡Œçº§é”å¤–ï¼Œè¿˜ä¼šå¢åŠ ä¸€ä¸ª è¡¨çº§æ„å‘ç‹¬å é”</li>
<li>åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå¦‚æœæ‰§è¡Œäº†æŸ¥è¯¢æ“ä½œï¼Œé‚£ä¹ˆä¼šåœ¨å¯¹åº”çš„è¡¨çº§åŠ ä¸€ä¸ªæ„å‘å…±äº«é”</li>
</ul>
<h3 id="ä¸¤ç§è¡¨çº§é”çš„äº’æ–¥å…³ç³»"><a href="#ä¸¤ç§è¡¨çº§é”çš„äº’æ–¥å…³ç³»" class="headerlink" title="ä¸¤ç§è¡¨çº§é”çš„äº’æ–¥å…³ç³»"></a>ä¸¤ç§è¡¨çº§é”çš„äº’æ–¥å…³ç³»</h3><p><strong>æ‰‹åŠ¨æ·»åŠ çš„è¡¨é”</strong>å’Œè¡¨çº§æ„å‘é”æ˜¯å­˜åœ¨äº’æ–¥å…³ç³»çš„ï¼Œå¯¹åº”çš„äº’æ–¥å…³ç³»å¦‚ä¸‹</p>
<table>
<thead>
<tr>
<th align="center">é”ç±»å‹(éƒ½æ˜¯è¡¨çº§)</th>
<th align="center">ç‹¬å é”</th>
<th align="center">æ„å‘ç‹¬å é”</th>
<th align="center">å…±äº«é”</th>
<th align="center">æ„å‘å…±äº«é”</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ç‹¬å é”</td>
<td align="center">äº’æ–¥</td>
<td align="center">äº’æ–¥</td>
<td align="center">äº’æ–¥</td>
<td align="center">äº’æ–¥</td>
</tr>
<tr>
<td align="center">æ„å‘ç‹¬å é”</td>
<td align="center">äº’æ–¥</td>
<td align="center">ä¸äº’æ–¥</td>
<td align="center">äº’æ–¥</td>
<td align="center">ä¸äº’æ–¥</td>
</tr>
<tr>
<td align="center">å…±äº«é”</td>
<td align="center">äº’æ–¥</td>
<td align="center">äº’æ–¥</td>
<td align="center">ä¸äº’æ–¥</td>
<td align="center">ä¸äº’æ–¥</td>
</tr>
<tr>
<td align="center">æ„å‘å…±äº«é”</td>
<td align="center">äº’æ–¥</td>
<td align="center">ä¸äº’æ–¥</td>
<td align="center">ä¸äº’æ–¥</td>
<td align="center">ä¸äº’æ–¥</td>
</tr>
</tbody></table>
<h3 id="è¡¨çº§æ„å‘é”çš„ä½œç”¨"><a href="#è¡¨çº§æ„å‘é”çš„ä½œç”¨" class="headerlink" title="è¡¨çº§æ„å‘é”çš„ä½œç”¨"></a>è¡¨çº§æ„å‘é”çš„ä½œç”¨</h3><ul>
<li><code>InnoDB</code> å­˜å‚¨å¼•æ“å¯¹æ ‡çš„è¡Œè®°å½•æ·»åŠ  <code>S</code> é”ä¹‹å‰ï¼Œä¼šå…ˆåœ¨è¡¨çº§åˆ«æ·»åŠ ä¸€ä¸ª <code>IS</code> é”</li>
<li><code>InnoDB</code> å­˜å‚¨å¼•æ“å¯¹æ ‡çš„è¡Œè®°å½•æ·»åŠ  <code>X</code> é”ä¹‹å‰ï¼Œä¼šå…ˆåœ¨è¡¨çº§åˆ«æ·»åŠ ä¸€ä¸ª <code>IX</code> é” </li>
<li><code>IS</code> é”å’Œ <code>IX</code> é”çš„ä½œç”¨æ˜¯ä¸ºäº†åç»­åœ¨åŠ è¡¨çº§åˆ«çš„ <code>S</code> é”å’Œ <code>X</code> é”æ—¶åˆ¤æ–­è¡¨ä¸­æ˜¯å¦æœ‰å·²ç»è¢«åŠ é”çš„è®°å½•ï¼Œä»¥é¿å…ç”¨éå†çš„æ–¹å¼æ¥æŸ¥çœ‹è¡¨ä¸­æœ‰æ²¡æœ‰ä¸Šé”çš„è®°å½•ï¼Œä¸‹é¢ä¸¾ä¾‹è¯´æ˜</li>
</ul>
<p>äº‹åŠ¡ A ä¿®æ”¹ä¸€æ¡æ•°æ®ï¼Œæ‰€ä»¥äº‹åŠ¡ A ä¼šç»™è¿™æ¡æ•°æ®å¢åŠ  <strong>è¡Œé”</strong>(ä¸‹é¢ä¼šè®²è§£)</p>
<p>äº‹åŠ¡ B æƒ³è¦æ·»åŠ è¡¨çº§æ’ä»–é”ï¼Œå› ä¸ºæ˜¯è¡¨çº§ï¼Œæ‰€ä»¥å¯ä»¥ç†è§£æˆä¼šç»™æ‰€æœ‰è¡Œéƒ½ä¸Šé”ï¼Œå› ä¸ºäº‹åŠ¡ A å·²ç»ä¸Šé”æˆåŠŸï¼Œäº‹åŠ¡ B è‚¯å®šæ˜¯æ— æ³•åŠ é”æˆåŠŸçš„ï¼Œè¿™ç‚¹æ²¡æœ‰ç–‘é—®ï¼Œé—®é¢˜å°±æ˜¯åˆ¤æ–­çš„è¿‡ç¨‹ï¼Œäº‹åŠ¡ B æ€ä¹ˆçŸ¥é“å“ªä¸€è¡ŒåŠ é”äº†å‘¢? é‚£åªèƒ½ä¸€è¡Œä¸€è¡Œå»åˆ¤æ–­äº†ï¼Œè¿™æ ·æ•ˆç‡å°±å¾ˆä½äº†ï¼Œæ‰€ä»¥æ‰æœ‰äº†æ„å‘é”ï¼Œä¹Ÿå°±æ˜¯è¯´å®é™…æƒ…å†µä¼šæ˜¯ä¸‹é¢è¿™æ ·çš„</p>
<p>äº‹åŠ¡ A ä¿®æ”¹ä¸€æ¡æ•°æ®ï¼Œæ‰€ä»¥äº‹åŠ¡ A ä¼šç»™è¿™æ¡æ•°æ®å¢åŠ  <strong>è¡Œé”</strong>(ä¸‹é¢ä¼šè®²è§£)ï¼ŒåŒæ—¶ä¼šç»™è¿™å¼ è¡¨åŠ ä¸€ä¸ªæ„å‘æ’ä»–é”</p>
<p>äº‹åŠ¡ B æƒ³è¦æ·»åŠ è¡¨çº§æ’ä»–é”ï¼Œä¸€çœ‹å‘ç°è¿™ä¸ªè¡¨ä¸Šé¢å·²ç»å­˜åœ¨äº† æ„å‘æ’ä»–é”ï¼Œæ ¹æ®ä¸Šé¢çš„äº’æ–¥å…³ç³»è¡¨ï¼Œå¯ä»¥çŸ¥é“ï¼Œè¡¨çº§æ’ä»–é”å’Œè¡¨çº§æ„å‘æ’ä»–é”æ˜¯äº’æ–¥çš„ï¼Œé‚£äº‹åŠ¡ B å°±ä¸èƒ½åŠ é”æˆåŠŸäº†ï¼Œè¿™æ ·åªéœ€è¦åˆ¤æ–­ä¸€æ¬¡ï¼Œæ•ˆç‡æ˜æ˜¾æé«˜</p>
<h2 id="è¡Œçº§é”"><a href="#è¡Œçº§é”" class="headerlink" title="è¡Œçº§é”"></a>è¡Œçº§é”</h2><ul>
<li>å‰é¢è®²è§£çš„æ˜¯è¡¨çº§é”ï¼Œè¡¨çº§æ„å‘é”æ˜¯ <code>InnoDB</code> è‡ªåŠ¨å¸®æˆ‘ä»¬æ·»åŠ çš„ï¼Œä¿®æ”¹æ•°æ®æ—¶ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æ·»åŠ  <strong>è¡¨çº§æ„å‘ç‹¬å é”</strong>ï¼Œè‡³äºæ‰‹åŠ¨æ·»åŠ çš„æƒ…å†µæ¯”è¾ƒå°‘ï¼Œæ¥ä¸‹æ¥éœ€è¦è®²è§£çš„å°±æ˜¯è¡Œçº§é”äº†</li>
<li>è¡Œçº§é”é”ä½çš„æ˜¯ç´¢å¼•</li>
</ul>
<h3 id="è¡Œçº§é”çš„åˆ†ç±»"><a href="#è¡Œçº§é”çš„åˆ†ç±»" class="headerlink" title="è¡Œçº§é”çš„åˆ†ç±»"></a>è¡Œçº§é”çš„åˆ†ç±»</h3><ul>
<li><code>Record Locks</code>ï¼š è®°å½•é”ï¼Œ å®˜æ–¹æ­£å¼çš„åç§°æ˜¯ <code>LOCK_REC_NOT_GAP</code>ï¼Œå¯¹å¯¹åº”çš„ç´¢å¼•è®°å½•é¡¹åŠ é”ï¼Œ <strong>è¡¨ä¸­å±•ç¤ºçš„æ˜¯ <code>X,REC_NOT_GAP</code></strong></li>
<li><code>Gap Locks</code>ï¼š é—´éš™é”ï¼Œé”ä½çš„æ˜¯ç´¢å¼•ä¹‹é—´çš„é—´éš™ï¼Œ** è¡¨ä¸­å±•ç¤ºçš„æ˜¯ <code>X,GAP</code>**</li>
<li><code>Next-key Lock</code>ï¼š é‚»é”®é” <code>Next-key Lock</code> &#x3D; <code>Gap Locks</code> + <code>Record Locks</code>, <strong>è¡¨ä¸­å±•ç¤ºçš„æ˜¯ <code>X</code></strong></li>
<li><code>Insert Intention Locks</code>ï¼š æ’å…¥æ•°æ®æ—¶éœ€è¦æ’å…¥çš„ä½ç½®æ˜¯å¦è¢«åˆ«çš„äº‹åŠ¡æ·»åŠ äº† <code>Gap</code> é”ï¼ˆä¹Ÿå°±æ˜¯ <code>Gap Locks</code> æˆ– <code>Next-key Lock</code> ï¼‰ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œå½“å‰äº‹åŠ¡çš„æ’å…¥æ“ä½œéœ€è¦ç­‰å¾…ï¼Œç›´åˆ°æ‹¥æœ‰ <code>Gap</code> é”çš„äº‹åŠ¡æäº¤ã€‚æ­¤æ—¶å¯¹äºç­‰å¾…çš„é‚£ä¸ªäº‹åŠ¡å°±ä¼šæ·»åŠ ä¸€ä¸ª <code>Insert Intention Locks</code></li>
</ul>
<h2 id="Mysql8-REPEATABLE-READ-éš”ç¦»çº§åˆ«ä¸‹é”ç¤ºä¾‹"><a href="#Mysql8-REPEATABLE-READ-éš”ç¦»çº§åˆ«ä¸‹é”ç¤ºä¾‹" class="headerlink" title="Mysql8 REPEATABLE-READ éš”ç¦»çº§åˆ«ä¸‹é”ç¤ºä¾‹"></a>Mysql8 REPEATABLE-READ éš”ç¦»çº§åˆ«ä¸‹é”ç¤ºä¾‹</h2><p>åˆ›å»ºæµ‹è¯•è¡¨</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> student</span><br><span class="line">(</span><br><span class="line">    id   <span class="type">int</span>          <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">        <span class="keyword">primary</span> key,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">null</span>,</span><br><span class="line">    id_card <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">) engine <span class="operator">=</span> InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> index s_name <span class="keyword">on</span> student (name);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">unique</span> index s_id_card <span class="keyword">on</span> student(id_card);</span><br></pre></td></tr></table></figure>
<ul>
<li>è¡¨ä¸­æœ‰ä¸‰ä¸ªå­—æ®µï¼Œä¸€ä¸ªæ˜¯ä¸»é”® <code>id</code></li>
<li>é’ˆå¯¹ <code>name</code> å­—æ®µåˆ›å»ºäº†ä¸€ä¸ªæ™®é€šç´¢å¼•</li>
<li>é’ˆå¯¹ <code>id_card</code> å­—æ®µåˆ›å»ºäº†ä¸€ä¸ªå”¯ä¸€ç´¢å¼•</li>
</ul>
<p>æ’å…¥æµ‹è¯•æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student(id, name, id_card) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;name1&#x27;</span>, <span class="string">&#x27;1_card&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student(id, name, id_card) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;name5&#x27;</span>, <span class="string">&#x27;5_card&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student(id, name, id_card) <span class="keyword">values</span> (<span class="number">10</span>, <span class="string">&#x27;name10&#x27;</span>, <span class="string">&#x27;10_card&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>å…ˆåœ¨ <code>student</code> è¡¨é’ˆå¯¹ <code>id</code> å­—æ®µçš„é‚»é”®é”ä¸º</p>
<ul>
<li>ï¼ˆ-âˆï¼Œ 1]</li>
<li>ï¼ˆ1ï¼Œ 5]</li>
<li>ï¼ˆ5ï¼Œ 10]</li>
<li>ï¼ˆ10ï¼Œ +âˆ]  +âˆ ä½¿ç”¨çš„æ˜¯ <code>supremum</code> ä»£æ›¿</li>
</ul>
<h3 id="æµ‹è¯•å‰å…³é—­äº‹åŠ¡çš„è‡ªåŠ¨æäº¤"><a href="#æµ‹è¯•å‰å…³é—­äº‹åŠ¡çš„è‡ªåŠ¨æäº¤" class="headerlink" title="æµ‹è¯•å‰å…³é—­äº‹åŠ¡çš„è‡ªåŠ¨æäº¤"></a>æµ‹è¯•å‰å…³é—­äº‹åŠ¡çš„è‡ªåŠ¨æäº¤</h3><p>æŸ¥çœ‹äº‹åŠ¡è‡ªåŠ¨æäº¤çŠ¶æ€</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;autocommit&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>å…³é—­äº‹åŠ¡è‡ªåŠ¨æäº¤</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> OFF;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥æ˜¾å¼å¼€å¯äº‹åŠ¡ï¼Œå³ä½¿ç”¨ <code>begin</code> å¼€å¯äº‹åŠ¡ï¼Œç„¶åä½¿ç”¨ <code>commit</code> æäº¤äº‹åŠ¡ï¼Œä½¿ç”¨ <code>rollback</code> å›æ»šäº‹åŠ¡</p>
<h3 id="æµ‹è¯•å‰ä¿®æ”¹é”ç­‰å¾…è¶…æ—¶æ—¶é—´"><a href="#æµ‹è¯•å‰ä¿®æ”¹é”ç­‰å¾…è¶…æ—¶æ—¶é—´" class="headerlink" title="æµ‹è¯•å‰ä¿®æ”¹é”ç­‰å¾…è¶…æ—¶æ—¶é—´"></a>æµ‹è¯•å‰ä¿®æ”¹é”ç­‰å¾…è¶…æ—¶æ—¶é—´</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æŸ¥çœ‹é”ç­‰å¾…è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_lock_wait_timeout&#x27;</span>;</span><br><span class="line"><span class="comment">-- è®¾ç½®é”ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤æ˜¯50ï¼Œå•ä½æ˜¯sï¼Œè¿™é‡Œè®¾ç½® 600s, æ²¡æœ‰æ·»åŠ  global å°±æ˜¯å½“å‰ ä¼šè¯æœ‰æ•ˆ</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> innodb_lock_wait_timeout<span class="operator">=</span><span class="number">600</span>;</span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨ä¸»é”®è¿›è¡Œæ“ä½œçš„åœºæ™¯"><a href="#ä½¿ç”¨ä¸»é”®è¿›è¡Œæ“ä½œçš„åœºæ™¯" class="headerlink" title="ä½¿ç”¨ä¸»é”®è¿›è¡Œæ“ä½œçš„åœºæ™¯"></a>ä½¿ç”¨ä¸»é”®è¿›è¡Œæ“ä½œçš„åœºæ™¯</h3><p>éœ€è¦å¼€å¯ä¸‰ä¸ªçª—å£ï¼Œä»¥ä¸‹ç®€ç§°ä¸º <strong>çª—å£1</strong>ï¼Œ<strong>çª—å£2</strong>ï¼Œ<strong>çª—å£3</strong>ï¼Œå…¶ä¸­ç¬¬ä¸‰ä¸ªçª—å£å¯ä»¥ä¸ç”¨å…³é—­è‡ªåŠ¨æäº¤ï¼Œè¿™ä¸ªçª—å£ä¸»è¦æ˜¯æ¥æŸ¥è¯¢ <code>information_schema.INNODB_TRX</code> å’Œ <code>performance_schema.data_locks</code> è§‚å¯Ÿé”çŠ¶æ€</p>
<ol>
<li><p><strong>çª—å£1</strong> æ‰§è¡Œ</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;name5_1&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>çª—å£3</strong> æ‰§è¡Œä¸‹é¢è¯­å¥æŸ¥çœ‹é”çŠ¶æ€</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> ENGINE_LOCK_ID, ENGINE_TRANSACTION_ID, INDEX_NAME,LOCK_TYPE, LOCK_MODE, LOCK_DATA <span class="keyword">from</span> performance_schema.data_locks;</span><br></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹</p>
<table>
<thead>
<tr>
<th align="left">ENGINE_LOCK_ID</th>
<th align="left">ENGINE_TRANSACTION_ID</th>
<th align="left">INDEX_NAME</th>
<th align="left">LOCK_TYPE</th>
<th align="left">LOCK_MODE</th>
<th align="left">LOCK_DATA</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1853609022608:1067:1853614658072</td>
<td align="left">4188</td>
<td align="left">null</td>
<td align="left">TABLE</td>
<td align="left">IX</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">1853609022608:5:4:5:1853598537752</td>
<td align="left">4188</td>
<td align="left">PRIMARY</td>
<td align="left">RECORD</td>
<td align="left">X,REC_NOT_GAP</td>
<td align="left">5</td>
</tr>
</tbody></table>
</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ <code>id</code> æ¡ä»¶æ›´æ–°ï¼Œä¼šç»™è¡¨å¢åŠ  <code>IX</code> é”ï¼Œç»™ <code>id=5</code> è¿™æ¡è®°å½•å¢åŠ  <code>X,REC_NOT_GAP</code> ï¼Œè¿™å°±æ˜¯ <code>Record Lock</code></p>
<ol start="3">
<li><p><strong>çª—å£2</strong> æ‰§è¡Œä¸‹é¢è¯­å¥ï¼ˆåœ¨è¿™é‡Œçª—å£1çš„äº‹åŠ¡å¹¶æ²¡æœ‰æäº¤ï¼‰</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;name5_2&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>çª—å£3</strong> æ‰§è¡Œä¸‹é¢è¯­å¥æŸ¥çœ‹é”çŠ¶æ€</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> ENGINE_LOCK_ID, ENGINE_TRANSACTION_ID, INDEX_NAME,LOCK_TYPE, LOCK_MODE, LOCK_DATA <span class="keyword">from</span> performance_schema.data_locks;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="left">ENGINE_LOCK_ID</th>
<th align="left">ENGINE_TRANSACTION_ID</th>
<th align="left">INDEX_NAME</th>
<th align="left">LOCK_TYPE</th>
<th align="left">LOCK_MODE</th>
<th align="left">LOCK_DATA</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1853609023384:1067:1853614658840</td>
<td align="left">4193</td>
<td align="left">null</td>
<td align="left">TABLE</td>
<td align="left">IX</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">1853609023384:5:4:5:1853598540824</td>
<td align="left">4193</td>
<td align="left">PRIMARY</td>
<td align="left">RECORD</td>
<td align="left">X,REC_NOT_GAP</td>
<td align="left">5</td>
</tr>
<tr>
<td align="left">1853609022608:1067:1853614658072</td>
<td align="left">4188</td>
<td align="left">null</td>
<td align="left">TABLE</td>
<td align="left">IX</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">1853609022608:5:4:5:1853598537752</td>
<td align="left">4188</td>
<td align="left">PRIMARY</td>
<td align="left">RECORD</td>
<td align="left">X,REC_NOT_GAP</td>
<td align="left">5</td>
</tr>
</tbody></table>
</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡ <code>4193</code>(çª—å£1çš„é‚£ä¸ªäº‹åŠ¡ <code>id</code> æ˜¯ <code>4188</code>)ï¼Œ ä¹Ÿæ˜¯ç»™è¡¨å¢åŠ äº† <code>IX</code> é”ï¼Œç»™ <code>id=5</code> é‚£ä¸€è¡Œå¢åŠ äº† <code>X,REC_NOT_GAP</code></p>
<p>æ¥ä¸‹æ¥è¿˜æ˜¯åœ¨çª—å£3æ‰§è¡Œä¸‹é¢ä¸¤æ¡è¯­å¥ï¼Œçœ‹ä¸‹äº‹åŠ¡ç­‰å¾…çŠ¶æ€<br>å…ˆæ‰§è¡Œ</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> trx_id, trx_state, trx_requested_lock_id, trx_wait_started <span class="keyword">from</span> information_schema.INNODB_TRX;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="left">trx_id</th>
<th align="left">trx_state</th>
<th align="left">trx_requested_lock_id</th>
<th align="left">trx_wait_started</th>
</tr>
</thead>
<tbody><tr>
<td align="left">4193</td>
<td align="left">LOCK WAIT</td>
<td align="left">1853609023384:5:4:5:1853598540824</td>
<td align="left">2023-12-14 08:58:05</td>
</tr>
<tr>
<td align="left">4188</td>
<td align="left">RUNNING</td>
<td align="left">null</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">å¯ä»¥çœ‹åˆ° <code>4188</code> è¿™ä¸ªäº‹åŠ¡åœ¨è¿è¡Œä¸­ï¼Œ<code>4193</code>ï¼ˆç¬¬äºŒä¸ªçª—å£çš„äº‹åŠ¡ï¼‰æ˜¯ <code>lock wait</code> çŠ¶æ€ï¼Œ åŒæ—¶å¯ä»¥çœ‹åˆ° <code>4193</code> è¿™ä¸ªäº‹åŠ¡çš„ <code>trx_requested_lock_id=1853609023384:5:4:5:1853598540824</code></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">æ¥ä¸‹æ¥æ‰§è¡Œå¦‚ä¸‹ sql</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> REQUESTING_ENGINE_LOCK_ID,  BLOCKING_ENGINE_TRANSACTION_ID, BLOCKING_THREAD_ID <span class="keyword">from</span> performance_schema.data_lock_waits;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="left">REQUESTING_ENGINE_LOCK_ID</th>
<th align="left">BLOCKING_ENGINE_TRANSACTION_ID</th>
<th align="left">BLOCKING_THREAD_ID</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1853609023384:5:4:5:1853598540824</td>
<td align="left">4188</td>
<td align="left">68</td>
</tr>
</tbody></table>
<p>å¯ä»¥çœ‹åˆ° <code>trx_requested_lock_id=1853609023384:5:4:5:1853598540824</code> å°±æ˜¯è¢« <code>4188</code> è¿™ä¸ªäº‹åŠ¡æ‰€é˜»å¡çš„</p>
<p><strong>æ¥ä¸‹æ¥æ€»ç»“ä¸€ä¸‹ï¼šä½¿ç”¨ä¸»é”®è¿›è¡Œç­‰å€¼æ›´æ–°ï¼Œæ·»åŠ çš„æ˜¯ <code>Record Lock</code></strong></p>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Windowä¸‹å®‰è£…mysql8è§£å‹ç‰ˆ</title>
    <url>/2023/ff432902bea0/index.html</url>
    <content><![CDATA[<ul>
<li><a href="https://dev.mysql.com/downloads/mysql/">ä¸‹è½½Mysql8</a>ï¼Œ é€‰æ‹© <code>Windows (x86, 64-bit), ZIP Archive</code> è¿™ä¸ª</li>
<li>è§£å‹åˆ°æŸä¸ªç›®å½•ï¼Œæ¯”å¦‚ <code>E:\config\mysql-8.2.0-winx64</code>ï¼Œ è¿™å°±æ˜¯ <code>Mysql</code> å®‰è£…ç›®å½•</li>
<li>åœ¨ <code>Mysql</code> å®‰è£…ç›®å½•ä¸‹æ–°å»º <code>data</code> ç›®å½•ç”¨æ¥å­˜æ”¾æ•°æ®ï¼Œå³ <code>data</code> ç›®å½•å…¨è·¯å¾„ä¸º <code>E:\config\mysql-8.2.0-winx64\data</code></li>
<li>åœ¨ <code>Mysql</code> å®‰è£…ç›®å½•ä¸‹æ–°å»ºé…ç½®æ–‡ä»¶ <code>my.cnf</code>, å†…å®¹å¦‚ä¸‹</li>
</ul>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment">#è®¾ç½®æ—¶åŒºä¸ºä¸œå…«åŒºï¼Œæ­¤é¡¹è®¾ç½®åï¼Œåœ¨è¿æ¥MySQLçš„æ—¶å€™å¯ä»¥ä¸ç”¨æ¯æ¬¡éƒ½æ‰‹åŠ¨è®¾ç½®æ—¶åŒº</span></span><br><span class="line"><span class="attr">default-time-zone</span> = <span class="string">&#x27;+8:00&#x27;</span></span><br><span class="line"><span class="comment"># è®¾ç½®3306ç«¯å£</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3306</span></span><br><span class="line"><span class="comment"># è®¾ç½®mysqlçš„å®‰è£…ç›®å½•ï¼Œæ›¿æ¢ä¸ºè‡ªå·±çš„è·¯å¾„</span></span><br><span class="line"><span class="attr">basedir</span>=E:\config\mysql-<span class="number">8.2</span>.<span class="number">0</span>-winx64</span><br><span class="line"><span class="comment"># è®¾ç½®mysqlæ•°æ®åº“çš„æ•°æ®çš„å­˜æ”¾ç›®å½•ï¼Œ æ›¿æ¢ä¸ºè‡ªå·±çš„è·¯å¾„</span></span><br><span class="line"><span class="attr">datadir</span>=E:\config\mysql-<span class="number">8.2</span>.<span class="number">0</span>-winx64\data</span><br><span class="line"><span class="comment"># å…è®¸æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line"><span class="attr">max_connections</span>=<span class="number">200</span></span><br><span class="line"><span class="comment"># å…è®¸è¿æ¥å¤±è´¥çš„æ¬¡æ•°</span></span><br><span class="line"><span class="attr">max_connect_errors</span>=<span class="number">10</span></span><br><span class="line"><span class="comment"># æœåŠ¡ç«¯ä½¿ç”¨çš„å­—ç¬¦é›†é»˜è®¤ä¸ºUTF8</span></span><br><span class="line"><span class="attr">character-set-server</span>=utf8</span><br><span class="line"><span class="comment"># åˆ›å»ºæ–°è¡¨æ—¶å°†ä½¿ç”¨çš„é»˜è®¤å­˜å‚¨å¼•æ“</span></span><br><span class="line"><span class="attr">default-storage-engine</span>=INNODB</span><br><span class="line"><span class="comment"># é»˜è®¤ä½¿ç”¨â€œmysql_native_passwordâ€æ’ä»¶è®¤è¯</span></span><br><span class="line"><span class="attr">default_authentication_plugin</span>=mysql_native_password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="comment"># è®¾ç½®mysqlå®¢æˆ·ç«¯é»˜è®¤å­—ç¬¦é›†</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8</span><br><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="comment"># è®¾ç½®mysqlå®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯æ—¶é»˜è®¤ä½¿ç”¨çš„ç«¯å£</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3306</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8</span><br></pre></td></tr></table></figure>

<ul>
<li>ä½¿ç”¨ç®¡ç†å‘˜èº«ä»½æ‰“å¼€ <code>cmd</code>, è¿›å…¥ <code>Mysql</code> å®‰è£…ç›®å½•ä¸‹çš„ <code>bin</code> ç›®å½•</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> E:\config\mysql-<span class="number">8</span>.<span class="number">2</span>.<span class="number">0</span>-winx64\bin</span><br><span class="line">mysqld --initialize --console</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–å®Œæˆååœ¨ <code>cmd</code> çª—å£ä¼šå‡ºç° <code> A temporary password is generated for root@localhost: ,mDQ&gt;kFHI65w</code> å­—æ ·(å¯†ç ç”Ÿæˆçš„ä¸åŒ)ï¼Œ å¤åˆ¶ä¿å­˜è¿™ä¸ªå¯†ç </p>
<ul>
<li>ç»§ç»­åœ¨å½“å‰ <code>cmd</code> çª—å£æ‰§è¡Œ <code>mysqld --install</code> å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤æ˜¯å°† <code>Mysqld</code> ç¨‹åºä½œä¸ºå®‰è£…ä¸º <code>Windows</code> æœåŠ¡ï¼Œ è¿™æ ·å°±å¯ä»¥åœ¨ç³»ç»ŸæœåŠ¡ä¸­çœ‹åˆ° <code>Mysqld</code> äº†</li>
<li>æ‰§è¡Œ <code>net start MySQL</code> å°±å¯ä»¥å¯åŠ¨ <code>Mysql</code> æœåŠ¡äº†</li>
<li>æ‰§è¡Œ <code>mysql -u root -p</code> å‘½ä»¤ï¼Œç„¶åå¤åˆ¶ä¸Šé¢æ‹·è´å‡ºæ¥çš„ <code>,mDQ&gt;kFHI65w</code> å¯†ç ï¼Œç›´æ¥ç”¨è¿™ä¸ªå¯†ç å»ç™»å½•å°±è¡Œäº†</li>
<li>ä¿®æ”¹å¯†ç ä¸º <code>admin</code>, åç»­å°±å¯ä»¥ä½¿ç”¨ <code>root</code> è´¦å·å’Œ <code>admin</code> å¯†ç ç™»å½•äº†</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;admin&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>é—®é¢˜</strong><br>æ‰§è¡Œ <code>net start mysql</code> æ—¶å‡ºç° <strong>æ— æ³•å¯åŠ¨æœåŠ¡ï¼ŒåŸå› å¯èƒ½æ˜¯å·²è¢«ç¦ç”¨æˆ–ä¸å…¶ç›¸å…³è”çš„è®¾å¤‡æ²¡æœ‰å¯åŠ¨ã€‚</strong><br>æ­¤æ—¶å¯ä»¥å…ˆå¸è½½ <code>Mysql</code> æœåŠ¡å†é‡è¯•å®‰è£…</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">mysqld -remove</span><br><span class="line"><span class="comment">&lt;!-- å¦‚æœä¸Šé¢æ‰§è¡Œä¸æˆåŠŸçš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤å¸è½½è¯•è¯• --&gt;</span></span><br><span class="line">mysqld -nt -remove</span><br><span class="line"><span class="comment">&lt;!-- ç„¶åå†æ¬¡å®‰è£… --&gt;</span></span><br><span class="line">mysqld -install</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>postgreså°†æ¯«ç§’å€¼è½¬æ¢æˆå­—ç¬¦ä¸²</title>
    <url>/2023/3a8e444a3e04/index.html</url>
    <content><![CDATA[<h2 id="åŸºæœ¬ä¿¡æ¯"><a href="#åŸºæœ¬ä¿¡æ¯" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h2><p>æ¯«ç§’å€¼ç±»å‹:  <code>numeric(13)</code></p>
<p>å­—æ®µåç§°: <code>check_time</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> to_char(to_timestamp(check_time <span class="operator">/</span> <span class="number">1000</span>) <span class="keyword">AT</span> <span class="type">TIME</span> ZONE <span class="string">&#x27;Asia/Shanghai&#x27;</span>, <span class="string">&#x27;YYYY-MM-DD HH24:MI:SS.MS&#x27;</span>) <span class="keyword">AS</span> check_time <span class="keyword">from</span> table_neme;</span><br></pre></td></tr></table></figure>

<h2 id="ä½¿ç”¨åˆ°çš„å‡½æ•°"><a href="#ä½¿ç”¨åˆ°çš„å‡½æ•°" class="headerlink" title="ä½¿ç”¨åˆ°çš„å‡½æ•°"></a>ä½¿ç”¨åˆ°çš„å‡½æ•°</h2><p><a href="http://www.postgres.cn/docs/12/functions-formatting.html">postgres12ç‰ˆæœ¬çš„æ—¥æœŸå‡½æ•°å‚è€ƒ</a></p>
<ol>
<li><code>to_timestamp</code>ï¼š å°† <strong>ç§’</strong> å€¼è½¬æ¢æˆ <code>timestamp</code> ç±»å‹ï¼Œ æ‰€ä»¥å¦‚æœæ˜¯æ¯«ç§’å€¼çš„è¯è¿˜éœ€è¦ <code>æ¯«ç§’å€¼/1000</code><ol>
<li><code>AT TIME ZONE &#39;Asia/Shanghai</code> ä»£è¡¨å°†è¿”å›çš„æ—¶é—´æˆ³æŒ‡å®šæ—¶åŒº</li>
</ol>
</li>
<li><code>to_char</code> å°† <code>timestamp</code> ç±»å‹è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œ å…¶ä¸­ <code>YYYY-MM-DD HH24:MI:SS.MS</code> ä»£è¡¨æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²<ol>
<li><code>HH24</code> ä»£è¡¨ 24 å°æ—¶åˆ¶</li>
<li><code>MI</code> è¡¨ç¤ºåˆ†é’Ÿ</li>
</ol>
</li>
</ol>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>PostgreSQL</category>
      </categories>
      <tags>
        <tag>PostgreSQL</tag>
      </tags>
  </entry>
  <entry>
    <title>nacos2.2.3é€šè¿‡æ’ä»¶æœºåˆ¶æ”¯æŒpostgres</title>
    <url>/2023/4c25a01a2388/index.html</url>
    <content><![CDATA[<h2 id="ä½¿ç”¨-nacos2-2-3-ç‰ˆæœ¬"><a href="#ä½¿ç”¨-nacos2-2-3-ç‰ˆæœ¬" class="headerlink" title="ä½¿ç”¨ nacos2.2.3 ç‰ˆæœ¬"></a>ä½¿ç”¨ nacos2.2.3 ç‰ˆæœ¬</h2><ol>
<li>ä» <a href="https://github.com/alibaba/nacos/releases">githubä¸‹è½½nacosæºç </a></li>
<li>åˆ‡æ¢åˆ° 2.2.3 ç‰ˆæœ¬<ol>
<li><code>git checkout -b 2.2.3 2.2.3</code>ï¼Œ <code>nacos</code> æºç ä¸­ 2.2.3 æ˜¯ <code>tag</code>, è¯¥å‘½ä»¤æ˜¯ä»å¯¹åº” <code>tag</code> åˆ›å»ºåˆ†æ”¯</li>
</ol>
</li>
</ol>
<h2 id="æ·»åŠ -postgres-ä¾èµ–"><a href="#æ·»åŠ -postgres-ä¾èµ–" class="headerlink" title="æ·»åŠ  postgres ä¾èµ–"></a>æ·»åŠ  postgres ä¾èµ–</h2><p>åœ¨ <code>nacos</code> çš„æ ¹ç›®å½•ä¸‹çš„ <code>pom.xml</code> ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- æ·»åŠ  postgres ç‰ˆæœ¬çº¦æŸ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">postgresql-version</span>&gt;</span>42.3.8<span class="tag">&lt;/<span class="name">postgresql-version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- é»˜è®¤æ˜¯1.8ï¼Œç›®å‰ä½¿ç”¨ jdk11 ç¼–è¯‘ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>11<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>config</code> æ¨¡å—ä¸‹çš„ <code>pom.xml</code> ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- æ·»åŠ  postgresql ä¾èµ– --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.postgresql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>postgresql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;postgresql-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="é€šè¿‡-spi-æœºåˆ¶æ·»åŠ -postgres-ç›¸å…³æ”¯æŒ"><a href="#é€šè¿‡-spi-æœºåˆ¶æ·»åŠ -postgres-ç›¸å…³æ”¯æŒ" class="headerlink" title="é€šè¿‡ spi æœºåˆ¶æ·»åŠ  postgres ç›¸å…³æ”¯æŒ"></a>é€šè¿‡ spi æœºåˆ¶æ·»åŠ  postgres ç›¸å…³æ”¯æŒ</h2><p>æ‰¾åˆ° <code>plugin</code> æ¨¡å—ï¼Œé‡Œé¢è¿˜åŒ…å«ä¸€ä¸ª <code>datasource</code> æ¨¡å—ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹<br>ã€datasourceã€‘æ¨¡å—çš„ç›®å½•è·¯å¾„ä¸ºï¼š <code>nacosæºç æ‰€åœ¨çš„ç›®å½•ä½ç½®\nacos\plugin\datasource</code></p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">â”œâ”€datasource</span><br><span class="line">â”‚  â”œâ”€src</span><br><span class="line">â”‚  â”‚  â”œâ”€main</span><br><span class="line">â”‚  â”‚  â”‚  â”œâ”€java</span><br><span class="line">â”‚  â”‚  â”‚  â”‚  â””â”€com</span><br><span class="line">â”‚  â”‚  â”‚  â”‚      â””â”€alibaba</span><br><span class="line">â”‚  â”‚  â”‚  â”‚          â””â”€nacos</span><br><span class="line">â”‚  â”‚  â”‚  â”‚              â””â”€<span class="keyword">plugin</span></span><br><span class="line">â”‚  â”‚  â”‚  â”‚                  â””â”€datasource</span><br><span class="line">â”‚  â”‚  â”‚  â”‚                      â”œâ”€constants</span><br><span class="line">â”‚  â”‚  â”‚  â”‚                      â”œâ”€impl</span><br><span class="line">â”‚  â”‚  â”‚  â”‚                      â”‚  â”œâ”€derby</span><br><span class="line">â”‚  â”‚  â”‚  â”‚                      â”‚  â”œâ”€mysql</span><br><span class="line">â”‚  â”‚  â”‚  â”‚                      â”‚  â””â”€postgresqlã€è¿™ä¸ªç›®å½•æ˜¯æ–°å¢çš„ã€‘</span><br><span class="line">â”‚  â”‚  â”‚  â”‚                      â”œâ”€mapper</span><br><span class="line">â”‚  â”‚  â”‚  â”‚                      â””â”€proxy</span><br><span class="line">â”‚  â”‚  â”‚  â””â”€resources</span><br><span class="line">â”‚  â”‚  â”‚      â””â”€<span class="keyword">META</span>-<span class="keyword">INF</span></span><br><span class="line">â”‚  â”‚  â”‚          â””â”€services</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>com.alibaba.nacos.plugin.datasource.impl</code> åŒ…ä¸‹å·²ç»æœ‰çš„ä¸¤ä¸ªå®ç°åŒ…æ˜¯ <code>mysql</code> å’Œ <code>derby</code>, å¯ä»¥æ‹·è´ä¸€ä¸‹ <code>mysql</code> æ•´ä¸ªåŒ…å¤åˆ¶åˆ° <code>mysql</code> åŒçº§ç›®å½•ä¸‹å¹¶ä¸”æ”¹åä¸º <code>postgres</code>, åŒ…é‡Œé¢çš„æ¯ä¸ªç±»çš„åç¼€æ”¹ä¸º <code>Postgres</code>, æ”¹å®Œå <code>postgres</code> ç›®å½•ä¸‹çš„ç±»æœ‰å¦‚ä¸‹ 9 ä¸ª</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ConfigInfoAggrMapperByPostgreSql</span></span><br><span class="line"><span class="attribute">ConfigInfoBetaMapperByPostgreSql</span></span><br><span class="line"><span class="attribute">ConfigInfoMapperByPostgreSql</span></span><br><span class="line"><span class="attribute">ConfigInfoTagMapperByPostgreSql</span></span><br><span class="line"><span class="attribute">ConfigTagsRelationMapperByPostgreSql</span></span><br><span class="line"><span class="attribute">GroupCapacityMapperByPostgreSql</span></span><br><span class="line"><span class="attribute">HistoryConfigInfoMapperByPostgreSql</span></span><br><span class="line"><span class="attribute">TenantCapacityMapperByPostgreSql</span></span><br><span class="line"><span class="attribute">TenantInfoMapperByPostgreSql</span></span><br></pre></td></tr></table></figure>

<p>è¿›è¡Œä¸Šè¿°æ“ä½œååªæ˜¯å°† <code>mysql</code> ç›®å½•æ•´ä¸ªæ‹·è´äº†ä¸€ä»½ä¿®æ”¹ç›®å½•åå’Œç±»åï¼Œä½†æ˜¯é‡Œé¢çš„å†…å®¹å…¶å®æ²¡æœ‰å˜åŒ–ï¼Œæˆ‘ä»¬ä»¥ <code>ConfigInfoMapperByPostgreSql</code>ï¼ˆmysql ç›®å½•ä¸‹ï¼‰ ä¸ºä¾‹ï¼Œçœ‹çœ‹éœ€è¦ä¿®æ”¹ä»€ä¹ˆå†…å®¹</p>
<figure class="highlight java"><figcaption><span>ConfigInfoMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigInfoAggrMapperByMySql</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapper</span> <span class="keyword">implements</span> <span class="title class_">ConfigInfoAggrMapper</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findConfigInfoAggrByPageFetchRows</span><span class="params">(<span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SELECT data_id,group_id,tenant_id,datum_id,app_name,content FROM config_info_aggr WHERE data_id= ? AND &quot;</span></span><br><span class="line">                + <span class="string">&quot;group_id= ? AND tenant_id= ? ORDER BY datum_id LIMIT &quot;</span> + startRow + <span class="string">&quot;,&quot;</span> + pageSize;  <span class="comment">// ä¿®æ”¹ç‚¹1</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceConstant.MYSQL;  <span class="comment">// ä¿®æ”¹ç‚¹2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ä¿®æ”¹ç‚¹1</strong><br>è¿™é‡Œçš„ä¿®æ”¹æ˜¯å› ä¸º <code>mysql</code> å’Œ <code>postgres</code> çš„åˆ†é¡µè¯­æ³•ä¸åŒ<br><code>mysql</code> åˆ†é¡µï¼š<code>LIMIT startRow,pageSize</code><br><code>postgres</code> åˆ†é¡µï¼š<code>LIMIT pageSize OFFSET startRow</code></p>
<p><strong>ä¿®æ”¹ç‚¹2</strong><br><code>getDataSource()</code> æ–¹æ³•è¿”å›çš„æ˜¯æ•°æ®æºç±»å‹ï¼Œ<code>mysql</code> ä¸­è¿”å›çš„æ˜¯ <code>DataSourceConstant.MYSQL</code>ï¼Œçœ‹ä¸€ä¸‹ <code>DataSourceConstant</code>ç±»ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConstant</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MYSQL</span> <span class="operator">=</span> <span class="string">&quot;mysql&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DERBY</span> <span class="operator">=</span> <span class="string">&quot;derby&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é»˜è®¤åªæœ‰ä¸¤ä¸ªï¼Œç°åœ¨æ–°å¢ä¸€ä¸ª <code>postgres</code> ç±»å‹ï¼Œå˜æˆ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConstant</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MYSQL</span> <span class="operator">=</span> <span class="string">&quot;mysql&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DERBY</span> <span class="operator">=</span> <span class="string">&quot;derby&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">POSTGRESQL</span>  <span class="operator">=</span> <span class="string">&quot;postgresql&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸¤å¤„éƒ½ä¿®æ”¹å®Œæˆä¹‹åï¼Œ<code>postgres</code> ç›®å½•ä¸‹å¯¹åº”çš„ <code>ConfigInfoAggrMapperByPostgreSql</code> ç±»ç»è¿‡ä¿®æ”¹åå˜æˆå¦‚ä¸‹å½¢å¼</p>
<figure class="highlight java"><figcaption><span>ConfigInfoAggrMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigInfoAggrMapperByPostgreSql</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapper</span> <span class="keyword">implements</span> <span class="title class_">ConfigInfoAggrMapper</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findConfigInfoAggrByPageFetchRows</span><span class="params">(<span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SELECT data_id,group_id,tenant_id,datum_id,app_name,content FROM config_info_aggr WHERE data_id= ? AND &quot;</span></span><br><span class="line">                + <span class="string">&quot;group_id= ? AND tenant_id= ? ORDER BY datum_id LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceConstant.POSTGRESQL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ·»åŠ spiç±»é…ç½®"><a href="#æ·»åŠ spiç±»é…ç½®" class="headerlink" title="æ·»åŠ spiç±»é…ç½®"></a>æ·»åŠ spiç±»é…ç½®</h2><p>ä¸‹é¢ä¼šåˆ—å‡ºä¿®æ”¹åæ‰€æœ‰ <code>postgres</code> ç›®å½•ä¸‹æ‰€æœ‰ç±»ä»£ç ï¼Œä¸è¿‡è¿™é‡Œå…ˆå°†å…¶ä»–éœ€è¦ä¿®æ”¹çš„é…ç½®æ”¹å®Œ</p>
<p>æ‰¾åˆ° <code>plugin/datasource</code> æ¨¡å—ä¸‹ <code>resources/META-INF/services</code> ç›®å½•ï¼Œè¯¥ç›®å½•ä¸‹æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶åä¸º <code>com.alibaba.nacos.plugin.datasource.mapper.Mapper</code><br>å°†å¦‚ä¸‹å†…å®¹æ·»åŠ åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">com<span class="selector-class">.alibaba</span><span class="selector-class">.nacos</span><span class="selector-class">.plugin</span><span class="selector-class">.datasource</span><span class="selector-class">.impl</span><span class="selector-class">.postgresql</span><span class="selector-class">.ConfigInfoAggrMapperByPostgreSql</span></span><br><span class="line">com<span class="selector-class">.alibaba</span><span class="selector-class">.nacos</span><span class="selector-class">.plugin</span><span class="selector-class">.datasource</span><span class="selector-class">.impl</span><span class="selector-class">.postgresql</span><span class="selector-class">.ConfigInfoBetaMapperByPostgreSql</span></span><br><span class="line">com<span class="selector-class">.alibaba</span><span class="selector-class">.nacos</span><span class="selector-class">.plugin</span><span class="selector-class">.datasource</span><span class="selector-class">.impl</span><span class="selector-class">.postgresql</span><span class="selector-class">.ConfigInfoMapperByPostgreSql</span></span><br><span class="line">com<span class="selector-class">.alibaba</span><span class="selector-class">.nacos</span><span class="selector-class">.plugin</span><span class="selector-class">.datasource</span><span class="selector-class">.impl</span><span class="selector-class">.postgresql</span><span class="selector-class">.ConfigInfoTagMapperByPostgreSql</span></span><br><span class="line">com<span class="selector-class">.alibaba</span><span class="selector-class">.nacos</span><span class="selector-class">.plugin</span><span class="selector-class">.datasource</span><span class="selector-class">.impl</span><span class="selector-class">.postgresql</span><span class="selector-class">.ConfigTagsRelationMapperByPostgreSql</span></span><br><span class="line">com<span class="selector-class">.alibaba</span><span class="selector-class">.nacos</span><span class="selector-class">.plugin</span><span class="selector-class">.datasource</span><span class="selector-class">.impl</span><span class="selector-class">.postgresql</span><span class="selector-class">.HistoryConfigInfoMapperByPostgreSql</span></span><br><span class="line">com<span class="selector-class">.alibaba</span><span class="selector-class">.nacos</span><span class="selector-class">.plugin</span><span class="selector-class">.datasource</span><span class="selector-class">.impl</span><span class="selector-class">.postgresql</span><span class="selector-class">.TenantInfoMapperByPostgreSql</span></span><br><span class="line">com<span class="selector-class">.alibaba</span><span class="selector-class">.nacos</span><span class="selector-class">.plugin</span><span class="selector-class">.datasource</span><span class="selector-class">.impl</span><span class="selector-class">.postgresql</span><span class="selector-class">.TenantCapacityMapperByPostgreSql</span></span><br><span class="line">com<span class="selector-class">.alibaba</span><span class="selector-class">.nacos</span><span class="selector-class">.plugin</span><span class="selector-class">.datasource</span><span class="selector-class">.impl</span><span class="selector-class">.postgresql</span>.GroupCapacityMapperByPostgreSql</span><br></pre></td></tr></table></figure>

<h2 id="ä¿®æ”¹-db-é…ç½®"><a href="#ä¿®æ”¹-db-é…ç½®" class="headerlink" title="ä¿®æ”¹ db é…ç½®"></a>ä¿®æ”¹ db é…ç½®</h2><p>åœ¨ <code>console</code> æ¨¡å—ä¸‹çš„ <code>application.properties</code> æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring.sql.init.platform</span>=<span class="string">postgresql</span></span><br><span class="line"><span class="attr">db.num</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">&lt;!--</span> <span class="string">åœ°å€å’Œç”¨æˆ·åå¯†ç æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ --&gt;</span></span><br><span class="line"><span class="attr">db.url.0</span>=<span class="string">jdbc:postgresql://127.0.0.1:5432/nacos</span></span><br><span class="line"><span class="attr">db.user.0</span>=<span class="string">postgres</span></span><br><span class="line"><span class="attr">db.password.0</span>=<span class="string">postgres</span></span><br><span class="line"><span class="attr">db.pool.config.driverClassName</span>=<span class="string">org.postgresql.Driver</span></span><br></pre></td></tr></table></figure>

<h2 id="postgres-ç›®å½•ä¸‹æ‰€æœ‰ç±»"><a href="#postgres-ç›®å½•ä¸‹æ‰€æœ‰ç±»" class="headerlink" title="postgres ç›®å½•ä¸‹æ‰€æœ‰ç±»"></a>postgres ç›®å½•ä¸‹æ‰€æœ‰ç±»</h2><p>ä¸‹é¢å·²ç»è¯´æ˜äº†æ¯ä¸ªç±»éœ€è¦ä¿®æ”¹çš„ç‚¹ï¼Œä¸‹é¢å°±ç»™å‡ºä¿®æ”¹åæ‰€æœ‰ <code>postgres</code> ç›®å½•ä¸‹æ‰€æœ‰ç±»çš„å†…å®¹<br>ConfigInfoAggrMapperByPostgreSqlç±»</p>
<figure class="highlight java"><figcaption><span>ConfigInfoAggrMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigInfoAggrMapperByPostgreSql</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapper</span> <span class="keyword">implements</span> <span class="title class_">ConfigInfoAggrMapper</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findConfigInfoAggrByPageFetchRows</span><span class="params">(<span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SELECT data_id,group_id,tenant_id,datum_id,app_name,content FROM config_info_aggr WHERE data_id= ? AND &quot;</span></span><br><span class="line">                + <span class="string">&quot;group_id= ? AND tenant_id= ? ORDER BY datum_id LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceConstant.POSTGRESQL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConfigInfoBetaMapperByPostgreSqlç±»</p>
<figure class="highlight java"><figcaption><span>ConfigInfoBetaMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigInfoBetaMapperByPostgreSql</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapper</span> <span class="keyword">implements</span> <span class="title class_">ConfigInfoBetaMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findAllConfigInfoBetaForDumpAllFetchRows</span><span class="params">(<span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot; SELECT t.id,data_id,group_id,tenant_id,app_name,content,md5,gmt_modified,beta_ips,encrypted_data_key &quot;</span></span><br><span class="line">                + <span class="string">&quot; FROM ( SELECT id FROM config_info_beta  ORDER BY id LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow + <span class="string">&quot; )&quot;</span></span><br><span class="line">                + <span class="string">&quot;  g, config_info_beta t WHERE g.id = t.id &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceConstant.POSTGRESQL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConfigInfoMapperByPostgreSqlç±»</p>
<figure class="highlight java"><figcaption><span>ConfigInfoMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigInfoMapperByPostgreSql</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapper</span> <span class="keyword">implements</span> <span class="title class_">ConfigInfoMapper</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DATA_ID</span> <span class="operator">=</span> <span class="string">&quot;dataId&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">GROUP</span> <span class="operator">=</span> <span class="string">&quot;group&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">APP_NAME</span> <span class="operator">=</span> <span class="string">&quot;appName&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONTENT</span> <span class="operator">=</span> <span class="string">&quot;content&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TENANT</span> <span class="operator">=</span> <span class="string">&quot;tenant&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findConfigInfoByAppFetchRows</span><span class="params">(<span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SELECT id,data_id,group_id,tenant_id,app_name,content FROM config_info&quot;</span></span><br><span class="line">                + <span class="string">&quot; WHERE tenant_id LIKE ? AND app_name= ?&quot;</span> + <span class="string">&quot; LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTenantIdList</span><span class="params">(<span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SELECT tenant_id FROM config_info WHERE tenant_id != &#x27;&quot;</span> + NamespaceUtil.getNamespaceDefaultId()</span><br><span class="line">                + <span class="string">&quot;&#x27; GROUP BY tenant_id LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getGroupIdList</span><span class="params">(<span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SELECT group_id FROM config_info WHERE tenant_id =&#x27;&quot;</span> + NamespaceUtil.getNamespaceDefaultId()</span><br><span class="line">                + <span class="string">&quot;&#x27; GROUP BY group_id LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findAllConfigKey</span><span class="params">(<span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot; SELECT data_id,group_id,app_name  FROM ( &quot;</span></span><br><span class="line">                + <span class="string">&quot; SELECT id FROM config_info WHERE tenant_id LIKE ? ORDER BY id LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow</span><br><span class="line">                + <span class="string">&quot; )&quot;</span> + <span class="string">&quot; g, config_info t WHERE g.id = t.id  &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findAllConfigInfoBaseFetchRows</span><span class="params">(<span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SELECT t.id,data_id,group_id,content,md5&quot;</span></span><br><span class="line">                + <span class="string">&quot; FROM ( SELECT id FROM config_info ORDER BY id LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow + <span class="string">&quot;  ) &quot;</span></span><br><span class="line">                + <span class="string">&quot; g, config_info t  WHERE g.id = t.id &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findAllConfigInfoFragment</span><span class="params">(<span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SELECT id,data_id,group_id,tenant_id,app_name,content,md5,gmt_modified,type,encrypted_data_key &quot;</span></span><br><span class="line">                + <span class="string">&quot;FROM config_info WHERE id &gt; ? ORDER BY id ASC LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findChangeConfigFetchRows</span><span class="params">(Map&lt;String, String&gt; params, <span class="keyword">final</span> Timestamp startTime,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> Timestamp endTime, <span class="type">int</span> startRow, <span class="type">int</span> pageSize, <span class="type">long</span> lastMaxId)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">tenant</span> <span class="operator">=</span> params.get(TENANT);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">dataId</span> <span class="operator">=</span> params.get(DATA_ID);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> params.get(GROUP);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">appName</span> <span class="operator">=</span> params.get(APP_NAME);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">tenantTmp</span> <span class="operator">=</span> StringUtils.isBlank(tenant) ? StringUtils.EMPTY : tenant;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">sqlFetchRows</span> <span class="operator">=</span> <span class="string">&quot;SELECT id,data_id,group_id,tenant_id,app_name,content,type,md5,gmt_modified FROM config_info WHERE &quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">where</span> <span class="operator">=</span> <span class="string">&quot; 1=1 &quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(dataId)) &#123;</span><br><span class="line">            where += <span class="string">&quot; AND data_id LIKE ? &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(group)) &#123;</span><br><span class="line">            where += <span class="string">&quot; AND group_id LIKE ? &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(tenantTmp)) &#123;</span><br><span class="line">            where += <span class="string">&quot; AND tenant_id = ? &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(appName)) &#123;</span><br><span class="line">            where += <span class="string">&quot; AND app_name = ? &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (startTime != <span class="literal">null</span>) &#123;</span><br><span class="line">            where += <span class="string">&quot; AND gmt_modified &gt;=? &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (endTime != <span class="literal">null</span>) &#123;</span><br><span class="line">            where += <span class="string">&quot; AND gmt_modified &lt;=? &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sqlFetchRows + where + <span class="string">&quot; AND id &gt; &quot;</span> + lastMaxId + <span class="string">&quot; ORDER BY id ASC&quot;</span> + <span class="string">&quot; LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset 0 &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">listGroupKeyMd5ByPageFetchRows</span><span class="params">(<span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SELECT t.id,data_id,group_id,tenant_id,app_name,md5,type,gmt_modified,encrypted_data_key FROM &quot;</span></span><br><span class="line">                + <span class="string">&quot;( SELECT id FROM config_info ORDER BY id LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow</span><br><span class="line">                + <span class="string">&quot; ) g, config_info t WHERE g.id = t.id&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findConfigInfoBaseLikeFetchRows</span><span class="params">(Map&lt;String, String&gt; params, <span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">sqlFetchRows</span> <span class="operator">=</span> <span class="string">&quot;SELECT id,data_id,group_id,tenant_id,content FROM config_info WHERE &quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">where</span> <span class="operator">=</span> <span class="string">&quot; 1=1 AND tenant_id=&#x27;&quot;</span> + NamespaceUtil.getNamespaceDefaultId() + <span class="string">&quot;&#x27; &quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(params.get(DATA_ID))) &#123;</span><br><span class="line">            where += <span class="string">&quot; AND data_id LIKE ? &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(params.get(GROUP))) &#123;</span><br><span class="line">            where += <span class="string">&quot; AND group_id LIKE &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(params.get(CONTENT))) &#123;</span><br><span class="line">            where += <span class="string">&quot; AND content LIKE ? &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sqlFetchRows + where + <span class="string">&quot; LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findConfigInfo4PageFetchRows</span><span class="params">(Map&lt;String, String&gt; params, <span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">appName</span> <span class="operator">=</span> params.get(APP_NAME);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">dataId</span> <span class="operator">=</span> params.get(DATA_ID);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> params.get(GROUP);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> params.get(CONTENT);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT id,data_id,group_id,tenant_id,app_name,content,type,encrypted_data_key FROM config_info&quot;</span>;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">where</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot; WHERE &quot;</span>);</span><br><span class="line">        where.append(<span class="string">&quot; tenant_id=? &quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(dataId)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND data_id=? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(group)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND group_id=? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(appName)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND app_name=? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(content)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND content LIKE ? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sql + where + <span class="string">&quot; LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findConfigInfoBaseByGroupFetchRows</span><span class="params">(<span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SELECT id,data_id,group_id,content FROM config_info WHERE group_id=? AND tenant_id=?&quot;</span> + <span class="string">&quot; LIMIT &quot;</span></span><br><span class="line">                + pageSize + <span class="string">&quot; offset &quot;</span> + startRow;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findConfigInfoLike4PageFetchRows</span><span class="params">(Map&lt;String, String&gt; params, <span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">dataId</span> <span class="operator">=</span> params.get(DATA_ID);</span><br><span class="line">        <span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> params.get(GROUP);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">appName</span> <span class="operator">=</span> params.get(APP_NAME);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> params.get(CONTENT);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">sqlFetchRows</span> <span class="operator">=</span> <span class="string">&quot;SELECT id,data_id,group_id,tenant_id,app_name,content,encrypted_data_key FROM config_info&quot;</span>;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">where</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot; WHERE &quot;</span>);</span><br><span class="line">        where.append(<span class="string">&quot; tenant_id LIKE ? &quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(dataId)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND data_id LIKE ? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(group)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND group_id LIKE ? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(appName)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND app_name = ? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(content)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND content LIKE ? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sqlFetchRows + where + <span class="string">&quot; LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findAllConfigInfoFetchRows</span><span class="params">(<span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SELECT t.id,data_id,group_id,tenant_id,app_name,content,md5 &quot;</span></span><br><span class="line">                + <span class="string">&quot; FROM (  SELECT id FROM config_info WHERE tenant_id LIKE ? ORDER BY id LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow + <span class="string">&quot; )&quot;</span></span><br><span class="line">                + <span class="string">&quot; g, config_info t  WHERE g.id = t.id &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceConstant.POSTGRESQL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConfigInfoTagMapperByPostgreSqlç±»</p>
<figure class="highlight java"><figcaption><span>ConfigInfoTagMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigInfoTagMapperByPostgreSql</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapper</span> <span class="keyword">implements</span> <span class="title class_">ConfigInfoTagMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findAllConfigInfoTagForDumpAllFetchRows</span><span class="params">(<span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot; SELECT t.id,data_id,group_id,tenant_id,tag_id,app_name,content,md5,gmt_modified &quot;</span></span><br><span class="line">                + <span class="string">&quot; FROM (  SELECT id FROM config_info_tag  ORDER BY id LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow + <span class="string">&quot; ) &quot;</span></span><br><span class="line">                + <span class="string">&quot;g, config_info_tag t  WHERE g.id = t.id  &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceConstant.POSTGRESQL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConfigTagsRelationMapperByPostgreSqlç±»</p>
<figure class="highlight java"><figcaption><span>ConfigTagsRelationMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigTagsRelationMapperByPostgreSql</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapper</span> <span class="keyword">implements</span> <span class="title class_">ConfigTagsRelationMapper</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findConfigInfo4PageFetchRows</span><span class="params">(Map&lt;String, String&gt; params, <span class="type">int</span> tagSize, <span class="type">int</span> startRow, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">appName</span> <span class="operator">=</span> params.get(<span class="string">&quot;appName&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">dataId</span> <span class="operator">=</span> params.get(<span class="string">&quot;dataId&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> params.get(<span class="string">&quot;group&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> params.get(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">where</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot; WHERE &quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;SELECT a.id,a.data_id,a.group_id,a.tenant_id,a.app_name,a.content FROM config_info  a LEFT JOIN &quot;</span></span><br><span class="line">                        + <span class="string">&quot;config_tags_relation b ON a.id=b.id&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        where.append(<span class="string">&quot; a.tenant_id=? &quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(dataId)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND a.data_id=? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(group)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND a.group_id=? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(appName)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND a.app_name=? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(content)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND a.content LIKE ? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        where.append(<span class="string">&quot; AND b.tag_name IN (&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; tagSize; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">                where.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            where.append(<span class="string">&#x27;?&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        where.append(<span class="string">&quot;) &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sql + where + <span class="string">&quot; LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findConfigInfoLike4PageFetchRows</span><span class="params">(<span class="keyword">final</span> Map&lt;String, String&gt; params, <span class="type">int</span> tagSize, <span class="type">int</span> startRow,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">appName</span> <span class="operator">=</span> params.get(<span class="string">&quot;appName&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> params.get(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">dataId</span> <span class="operator">=</span> params.get(<span class="string">&quot;dataId&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> params.get(<span class="string">&quot;group&quot;</span>);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">where</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot; WHERE &quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">sqlFetchRows</span> <span class="operator">=</span> <span class="string">&quot;SELECT a.id,a.data_id,a.group_id,a.tenant_id,a.app_name,a.content &quot;</span></span><br><span class="line">                + <span class="string">&quot;FROM config_info a LEFT JOIN config_tags_relation b ON a.id=b.id &quot;</span>;</span><br><span class="line">        </span><br><span class="line">        where.append(<span class="string">&quot; a.tenant_id LIKE ? &quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(dataId)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND a.data_id LIKE ? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(group)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND a.group_id LIKE ? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(appName)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND a.app_name = ? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(content)) &#123;</span><br><span class="line">            where.append(<span class="string">&quot; AND a.content LIKE ? &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        where.append(<span class="string">&quot; AND b.tag_name IN (&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; tagSize; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">                where.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            where.append(<span class="string">&#x27;?&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        where.append(<span class="string">&quot;) &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sqlFetchRows + where + <span class="string">&quot; LIMIT &quot;</span> + pageSize + <span class="string">&quot; offset &quot;</span> + startRow;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceConstant.POSTGRESQL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GroupCapacityMapperByPostgreSqlç±»</p>
<figure class="highlight java"><figcaption><span>GroupCapacityMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupCapacityMapperByPostgreSql</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapper</span> <span class="keyword">implements</span> <span class="title class_">GroupCapacityMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceConstant.POSTGRESQL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">selectGroupInfoBySize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SELECT id, group_id FROM group_capacity WHERE id &gt; ? LIMIT ?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HistoryConfigInfoMapperByPostgreSqlç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HistoryConfigInfoMapperByPostgreSql</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapper</span> <span class="keyword">implements</span> <span class="title class_">HistoryConfigInfoMapper</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">removeConfigHistory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DELETE FROM his_config_info WHERE gmt_modified &lt; ? LIMIT ?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">pageFindConfigHistoryFetchRows</span><span class="params">(<span class="type">int</span> pageNo, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> (pageNo - <span class="number">1</span>) * pageSize;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">limit</span> <span class="operator">=</span> pageSize;</span><br><span class="line">        <span class="keyword">return</span>  <span class="string">&quot;SELECT nid,data_id,group_id,tenant_id,app_name,src_ip,src_user,op_type,gmt_create,gmt_modified FROM his_config_info &quot;</span></span><br><span class="line">                + <span class="string">&quot;WHERE data_id = ? AND group_id = ? AND tenant_id = ? ORDER BY nid DESC  LIMIT &quot;</span> + limit + <span class="string">&quot; offset &quot;</span> + offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceConstant.POSTGRESQL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TenantCapacityMapperByPostgreSqlç±»</p>
<figure class="highlight java"><figcaption><span>TenantCapacityMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantCapacityMapperByPostgreSql</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapper</span> <span class="keyword">implements</span> <span class="title class_">TenantCapacityMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceConstant.POSTGRESQL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCapacityList4CorrectUsage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SELECT id, tenant_id FROM tenant_capacity WHERE id&gt;? LIMIT ?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TenantInfoMapperByPostgreSqlç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantInfoMapperByPostgreSql</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapper</span> <span class="keyword">implements</span> <span class="title class_">TenantInfoMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceConstant.POSTGRESQL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>nacos</category>
      </categories>
      <tags>
        <tag>nacos</tag>
      </tags>
  </entry>
  <entry>
    <title>dubboçš„spiæœºåˆ¶ä½¿ç”¨æ¡ˆä¾‹</title>
    <url>/2023/30c57ac8b6c7/index.html</url>
    <content><![CDATA[<h2 id="dubboä¸ºä»€ä¹ˆéœ€è¦spiæœºåˆ¶"><a href="#dubboä¸ºä»€ä¹ˆéœ€è¦spiæœºåˆ¶" class="headerlink" title="dubboä¸ºä»€ä¹ˆéœ€è¦spiæœºåˆ¶"></a>dubboä¸ºä»€ä¹ˆéœ€è¦spiæœºåˆ¶</h2><p>ä¸€ä¸ªå¥½çš„ç¨‹åºæ˜¯è¦éµå¾ªä¸€å®šçš„è®¾è®¡è§„èŒƒæ¯”å¦‚è®¾è®¡æ¨¡å¼ä¸­çš„å¼€é—­åŸåˆ™</p>
<ol>
<li><strong>å¯¹æ‰©å±•å¼€æ”¾</strong>ï¼šæŒ‡çš„æ˜¯æˆ‘ä»¬ç³»ç»Ÿä¸­çš„æ¨¡å—ã€ç±»ã€æ–¹æ³•å¯¹å®ƒä»¬çš„æä¾›è€…ï¼ˆå¼€å‘è€…ï¼‰åº”è¯¥æ˜¯å¼€æ”¾çš„ï¼Œæä¾›è€…å¯ä»¥å¯¹ç³»ç»Ÿè¿›è¡Œæ‰©å±•ï¼ˆæ–°å¢ï¼‰æ–°çš„åŠŸèƒ½ã€‚</li>
<li><strong>å¯¹ä¿®æ”¹å…³é—­</strong>ï¼šæŒ‡çš„æ˜¯ç³»ç»Ÿä¸­çš„æ¨¡å—ã€ç±»ã€æ–¹æ³•å¯¹å®ƒä»¬çš„ä½¿ç”¨è€…ï¼ˆè°ƒç”¨è€…ï¼‰åº”è¯¥æ˜¯â€¢ å…³é—­çš„ã€‚ä½¿ç”¨è€…ä½¿ç”¨è¿™äº›åŠŸèƒ½æ—¶ï¼Œä¸ä¼šå› ä¸ºæä¾›æ–¹æ–°å¢äº†åŠŸèƒ½è€Œå¯¼è‡´ä½¿ç”¨è€…ä¹Ÿè¿›è¡Œç›¸åº”ä¿®æ”¹<blockquote>
<p>Apache Dubbo æ˜¯ä¸€æ¬¾å¾®æœåŠ¡å¼€å‘æ¡†æ¶ï¼Œå®ƒæä¾›äº† RPC é€šä¿¡ä¸å¾®æœåŠ¡æ²»ç†ä¸¤å¤§å…³é”®èƒ½åŠ›ã€‚è¿™æ„å‘³ç€ï¼Œä½¿ç”¨ Dubbo å¼€å‘çš„å¾®æœåŠ¡ï¼Œå°†å…·å¤‡ç›¸äº’ä¹‹é—´çš„è¿œç¨‹å‘ç°ä¸é€šä¿¡èƒ½åŠ›ï¼ŒåŒæ—¶åˆ©ç”¨ Dubbo æä¾›çš„ä¸°å¯ŒæœåŠ¡æ²»ç†èƒ½åŠ›ï¼Œå¯ä»¥å®ç°è¯¸å¦‚æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æµé‡è°ƒåº¦ç­‰æœåŠ¡æ²»ç†è¯‰æ±‚ã€‚åŒæ—¶ Dubbo æ˜¯é«˜åº¦å¯æ‰©å±•çš„ï¼Œç”¨æˆ·å‡ ä¹å¯ä»¥åœ¨ä»»æ„åŠŸèƒ½ç‚¹å»å®šåˆ¶è‡ªå·±çš„å®ç°ï¼Œä»¥æ”¹å˜æ¡†æ¶çš„é»˜è®¤è¡Œä¸ºæ¥æ»¡è¶³è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚</p>
<p>å¯¹äº Apache Dubbo æ¥è¯´ä¸å˜çš„æ˜¯ RPC è°ƒç”¨æµç¨‹ï¼Œå¾®æœåŠ¡æ²»ç†ç›¸å…³çš„æ¦‚å¿µå’Œæµç¨‹ï¼Œä½†æ˜¯åœ¨æµç¨‹ä¸­æ¯ä¸ªç¯èŠ‚çš„å…·ä½“å®ç°æ–¹å¼å¯ä»¥æ˜¯åŠ¨æ€æ”¹å˜çš„ï¼ŒDubbo ä½¿ç”¨å¾®å†…æ ¸çš„æ¶æ„ï¼Œå°†å…·ä½“çš„å®ç°å¼€æ”¾å‡ºæ¥ï¼Œè®©ä½¿ç”¨è€…å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥é€‰æ‹©</p>
</blockquote>
</li>
</ol>
<h3 id="å¾®å†…æ ¸æ¶æ„"><a href="#å¾®å†…æ ¸æ¶æ„" class="headerlink" title="å¾®å†…æ ¸æ¶æ„"></a>å¾®å†…æ ¸æ¶æ„</h3><p>å¾®å†…æ ¸æ¶æ„ç”±ä¸¤å¤§æ¶æ„æ¨¡å—ç»„æˆï¼šæ ¸å¿ƒç³»ç»Ÿä¸æ’ä»¶æ¨¡å—</p>
<ol>
<li><strong>æ ¸å¿ƒç³»ç»Ÿ</strong>ï¼š è´Ÿè´£å’Œå…·ä½“ä¸šåŠ¡åŠŸèƒ½æ— å…³çš„é€šç”¨åŠŸèƒ½ï¼Œä¾‹å¦‚æ¨¡å—åŠ è½½ã€æ¨¡å—é—´é€šä¿¡ç­‰ï¼ŒDubbo å†…æ ¸çš„å·¥ä½œåŸç†ç”±å››éƒ¨åˆ†ç»„æˆ<ol>
<li>æœåŠ¡å‘ç°æœºåˆ¶ <code>spi</code></li>
<li>è‡ªé€‚åº”æœºåˆ¶ <code>Adaptive</code></li>
<li>åŒ…è£…æœºåˆ¶ <code>Wrapper</code></li>
<li>æ¿€æ´»æœºåˆ¶ <code>Activate</code><br><code>Dubbo</code> é€šè¿‡ä¸Šé¢å››ç§æœºåˆ¶å®ç°äº†å¯¹æ’ä»¶çš„ <code>IOC</code>, <code>AOP</code> å®ç°äº†å¯¹è‡ªåŠ¨ç”Ÿæˆç±»çš„åŠ¨æ€ç¼–è¯‘ <code>Compile</code></li>
</ol>
</li>
<li><strong>æ’ä»¶æ¨¡å—</strong>ï¼š è´Ÿè´£å®ç°å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨ <code>Dubbo</code> ä¸­å°±æ˜¯ <code>Dubbo SPI</code> æ¥å£ä¸å®ç°</li>
</ol>
<h2 id="Dubbo-ä¸­çš„-spi-è§„èŒƒ"><a href="#Dubbo-ä¸­çš„-spi-è§„èŒƒ" class="headerlink" title="Dubbo ä¸­çš„ spi è§„èŒƒ"></a>Dubbo ä¸­çš„ spi è§„èŒƒ</h2><ol>
<li>æ¥å£åï¼š å¯ä»¥éšæ„å®šä¹‰ï¼Œä½†æ˜¯éœ€è¦è¢« <code>@SPI</code> æ³¨è§£ä¿®é¥°</li>
<li>å®ç°ç±»å: åœ¨æ¥å£åå‰é¢æ·»åŠ ä¸€ä¸ªç”¨äºè¡¨ç¤ºè‡ªèº«åŠŸèƒ½çš„ â€œæ ‡è¯†å‰ç¼€â€ å­—ç¬¦ä¸²</li>
<li>æä¾›è€…é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œä¾æ¬¡æŸ¥æ‰¾ç›®å½•ä¸º<ol>
<li><code>META-INF/dubbo/internal</code></li>
<li><code>META-INF/dubbo</code></li>
<li><code>META-INF/services</code></li>
</ol>
</li>
<li>æä¾›è€…é…ç½®æ–‡ä»¶åç§°ï¼šæ¥å£çš„å…¨é™å®šæ€§ç±»å</li>
<li>æä¾›è€…é…ç½®æ–‡ä»¶å†…å®¹ï¼šæ–‡ä»¶çš„å†…å®¹ä¸º <code>key=value</code> å½¢å¼ï¼Œ<code>value</code> ä¸ºè¯¥æ¥å£çš„å®ç°ç±»çš„å…¨é™ç±»æ€§ç±»åï¼Œ<code>key</code> å¯ä»¥éšæ„ï¼Œä½†ä¸€èˆ¬ä¸ºè¯¥å®ç°ç±»çš„â€œæ ‡è¯†å‰è¾â€ï¼ˆé¦–å­—æ¯å°å†™ï¼‰ã€‚ä¸€ä¸ªç±»åå ä¸€è¡Œ</li>
<li><code>æä¾›è€…åŠ è½½ï¼šExtensionLoader</code> ç±»ç›¸å½“äº <code>JDK SP</code>I ä¸­ <code>ServiceLoader</code> ç±»ï¼Œç”¨äºåŠ è½½æä¾›è€…é…ç½®æ–‡ä»¶ä¸­æ‰€æœ‰çš„å®ç°ç±»ï¼Œå¹¶åˆ›å»ºç›¸åº”çš„å®ä¾‹</li>
</ol>
<p>dubbo spi æœºåˆ¶éƒ½æ˜¯ç”Ÿæˆä»£ç†ç±»ï¼Œä¸€èˆ¬ä½¿ç”¨ <code>javaassist</code> æ–¹æ³•ç”Ÿæˆï¼Œå¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/d513f5c497bd/index.html" title="javaè¾“å‡ºè¿è¡Œè¿‡ç¨‹ä¸­çš„ä»£ç†ç±»">javaè¾“å‡ºè¿è¡Œè¿‡ç¨‹ä¸­çš„ä»£ç†ç±»</a></li></ol> æ¥è·å–ä»£ç†ç±»

<h2 id="dubbo-spi-ä½¿ç”¨æ¡ˆä¾‹"><a href="#dubbo-spi-ä½¿ç”¨æ¡ˆä¾‹" class="headerlink" title="dubbo spi ä½¿ç”¨æ¡ˆä¾‹"></a>dubbo spi ä½¿ç”¨æ¡ˆä¾‹</h2><figure class="highlight java"><figcaption><span>æ¥å£å’Œå¯¹åº”å®ç°ç±»</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">@SPI</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    String <span class="title function_">sayHello</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  ç¬¬ä¸€ä¸ªå®ç°ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstHello</span> <span class="keyword">implements</span> <span class="title class_">Hello</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;first&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬äºŒä¸ªå®ç°ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondHello</span> <span class="keyword">implements</span> <span class="title class_">Hello</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;second&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ é…ç½®æ–‡ä»¶ï¼Œåœ¨ <code>resource</code> ä¸‹åˆ›å»ºç›®å½• <code>META-INF/services</code>, ç„¶ååˆ›å»ºæ–‡ä»¶</p>
<p>æ–‡ä»¶åä¸ºæ¥å£å…¨é™å®šæ€§ç±»å ï¼š <code>com.example.dubbodemo.spi.Hello</code> </p>
<p>æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">first=com<span class="selector-class">.example</span><span class="selector-class">.dubbodemo</span><span class="selector-class">.spi</span><span class="selector-class">.FirstHello</span></span><br><span class="line">second=com<span class="selector-class">.example</span><span class="selector-class">.dubbodemo</span><span class="selector-class">.spi</span>.SecondHello</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><figcaption><span>ä»£ç æµ‹è¯•</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSpi</span><span class="params">()</span> &#123;</span><br><span class="line">    ExtensionLoader&lt;Hello&gt; loader = ExtensionLoader.getExtensionLoader(Hello.class);</span><br><span class="line">    <span class="type">Hello</span> <span class="variable">firstHello</span> <span class="operator">=</span> loader.getExtension(<span class="string">&quot;first&quot;</span>);</span><br><span class="line">    System.out.println(firstHello.sayHello()); <span class="comment">// first</span></span><br><span class="line">    <span class="type">Hello</span> <span class="variable">secondHello</span> <span class="operator">=</span> loader.getExtension(<span class="string">&quot;second&quot;</span>);</span><br><span class="line">    System.out.println(secondHello.sayHello()); <span class="comment">// second</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="dubbo-Adaptive-æœºåˆ¶"><a href="#dubbo-Adaptive-æœºåˆ¶" class="headerlink" title="dubbo Adaptive æœºåˆ¶"></a>dubbo Adaptive æœºåˆ¶</h2><ol>
<li>ä»ä¸Šé¢ <code>spi</code> ä»£ç ç¤ºä¾‹ä¸­å¯ä»¥çœ‹åˆ°å½“æœ‰å¤šä¸ªå®ç°ç±»çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ ¹æ® <code>key</code> æ¥é€‰æ‹©å…·ä½“æ˜¯ä½¿ç”¨å“ªä¸ªå®ç°ç±»</li>
<li><code>dubbo</code> ä¸­æ˜¯ä»¥ <code>url</code> æ¥è´¯ç©¿æ•´ä¸ªè°ƒç”¨è·¯å¾„çš„ï¼Œæ‰€è°“çš„ <code>adaptive</code> æœºåˆ¶å°±æ˜¯æ ¹æ® <code>url</code> ä¸­çš„å‚æ•°æ¥è‡ªåŠ¨å¸®æˆ‘ä»¬åˆ¤æ–­åº”è¯¥ä½¿ç”¨å“ªä¸ªå®ç°ç±»ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨æŒ‡å®š <code>key</code></li>
<li><code>@Adaptive</code> å¯ä»¥ç”¨æ¥ä¿®é¥°ç±»å’Œä¿®é¥°æ–¹æ³•ï¼Œ å¦‚æœæ˜¯ä¿®é¥°æ–¹æ³•ï¼Œé‚£ä¹ˆ <code>@Adaptive</code> ä¿®é¥°çš„æ–¹æ³•å°±å¿…é¡»åŒ…å« <code>url</code> å‚æ•°ï¼Œå¦‚æœæ˜¯ä¿®é¥°æ–¹æ³•ï¼Œåˆ™æ²¡æœ‰è¦æ±‚æ¥å£ä¸­çš„æ–¹æ³•å¿…é¡»æœ‰ <code>url</code> å‚æ•°</li>
</ol>
<p>ä¸‹é¢ç¤ºä¾‹ä¸­åŒ…å«ä¸€ä¸ª æ‰“æ‹›å‘¼çš„æ¥å£ <code>Hello</code>ï¼Œ ç„¶åè¿˜æœ‰ä¸¤ç§æ‰“æ‹›å‘¼çš„å®ç°ï¼Œåˆ†åˆ«æ˜¯ <code>FirstHello</code> å’Œ <code>SecondHello</code></p>
<div class="tabs" id="dubboçš„adaptiveæœºåˆ¶ç¤ºä¾‹"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="dubboçš„adaptiveæœºåˆ¶ç¤ºä¾‹-1">ä¿®é¥°æ–¹æ³•ç¤ºä¾‹</button><button type="button" class="tab " data-href="dubboçš„adaptiveæœºåˆ¶ç¤ºä¾‹-2">adaptiveä¿®é¥°ç±»ç¤ºä¾‹</button></ul><div class="tab-contents"><div class="tab-item-content active" id="dubboçš„adaptiveæœºåˆ¶ç¤ºä¾‹-1"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  æ¥å£å®šä¹‰</span></span><br><span class="line"><span class="meta">@SPI</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    String <span class="title function_">sayHello</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Adaptive</span></span><br><span class="line">    String <span class="title function_">adaptiveHello</span><span class="params">(URL url)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  ç¬¬ä¸€ä¸ªå®ç°ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstHello</span> <span class="keyword">implements</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;first normal&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">adaptiveHello</span><span class="params">(URL url)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;first adaptive&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬äºŒä¸ªå®ç°ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondHello</span> <span class="keyword">implements</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;second normal&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">adaptiveHello</span><span class="params">(URL url)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;second adaptive&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ é…ç½®æ–‡ä»¶ï¼Œåœ¨ <code>resource</code> ä¸‹åˆ›å»ºç›®å½• <code>META-INF/services</code>, ç„¶ååˆ›å»ºæ–‡ä»¶</p>
<p>æ–‡ä»¶åä¸ºæ¥å£å…¨é™å®šæ€§ç±»å ï¼š <code>com.example.dubbodemo.spi.Hello</code> </p>
<p>æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">first=com<span class="selector-class">.example</span><span class="selector-class">.dubbodemo</span><span class="selector-class">.spi</span><span class="selector-class">.FirstHello</span></span><br><span class="line">second=com<span class="selector-class">.example</span><span class="selector-class">.dubbodemo</span><span class="selector-class">.spi</span>.SecondHello</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  æµ‹è¯•ç±»</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAdaptive</span><span class="params">()</span> &#123;</span><br><span class="line">    ExtensionLoader&lt;Hello&gt; loader = ExtensionLoader.getExtensionLoader(Hello.class);</span><br><span class="line">    <span class="type">Hello</span> <span class="variable">iHello</span> <span class="operator">=</span> loader.getAdaptiveExtension();</span><br><span class="line">    <span class="comment">// è¿™ä¸ªç›¸å½“äºåœ¨urlä¸­è®¾ç½®äº† key=hello(ä¹Ÿå°±æ˜¯æ¥å£åç§°)ï¼Œ value=second, è¿™é‡Œçš„secondæ˜¯å’Œé…ç½®æ–‡ä»¶ä¸­çš„keyå¯¹åº”çš„ï¼Œè¡¨ç¤º</span></span><br><span class="line">    <span class="comment">// å…·ä½“é€‰æ‹©çš„æ˜¯å“ªä¸ªå®ç°ç±»</span></span><br><span class="line">    <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> URL.valueOf(<span class="string">&quot;http://localhost?hello=second&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> iHello.adaptiveHello(url);</span><br><span class="line">    System.out.println(s); <span class="comment">// ä¼šæ‰“å° second adaptive</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAdaptive2</span><span class="params">()</span> &#123;</span><br><span class="line">    ExtensionLoader&lt;Hello&gt; loader = ExtensionLoader.getExtensionLoader(Hello.class);</span><br><span class="line">    <span class="type">Hello</span> <span class="variable">iHello</span> <span class="operator">=</span> loader.getAdaptiveExtension();</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> iHello.sayHello(); <span class="comment">// è¿™é‡Œä¼šæŠ¥é”™ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•å¹¶æ²¡æœ‰ä½¿ç”¨ @Adaptive æ³¨è§£ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨ adaptive æ–¹æ³•æ¥è¿›è¡Œè°ƒç”¨</span></span><br><span class="line">    System.out.println(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="dubboçš„adaptiveæœºåˆ¶ç¤ºä¾‹-2"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  æ¥å£å®šä¹‰, å…¶ä¸­æœ‰é»˜è®¤å€¼</span></span><br><span class="line"><span class="meta">@SPI(&quot;first&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    String <span class="title function_">sayHello</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªå®ç°ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstHello</span> <span class="keyword">implements</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;first hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬äºŒä¸ªå®ç°ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondHello</span> <span class="keyword">implements</span> <span class="title class_">Hello</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;second hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªé€‚åº”ç±»ï¼Œè¿™ä¸ªç±»éœ€è¦ä½¿ç”¨ @Adaptive æ³¨è§£ä¿®é¥°</span></span><br><span class="line"><span class="meta">@Adaptive</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdaptiveHello</span> <span class="keyword">implements</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setType</span><span class="params">(String type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        ExtensionLoader&lt;Hello&gt; loader = ExtensionLoader.getExtensionLoader(Hello.class);</span><br><span class="line">        Hello hello;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(type)) &#123;</span><br><span class="line">            hello = loader.getExtension(type);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰æŒ‡å®šçš„ç±»å‹ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„ç±»å‹ï¼Œå°±æ˜¯æ¥å£ä¸Š @SPI æ³¨è§£ä¸­çš„å€¼</span></span><br><span class="line">            hello = loader.getDefaultExtension();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hello.sayHello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ é…ç½®æ–‡ä»¶ï¼Œåœ¨ <code>resource</code> ä¸‹åˆ›å»ºç›®å½• <code>META-INF/services</code>, ç„¶ååˆ›å»ºæ–‡ä»¶</p>
<p>æ–‡ä»¶åä¸ºæ¥å£å…¨é™å®šæ€§ç±»å ï¼š <code>com.example.dubbodemo.spi.Hello</code> </p>
<p>æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">first=com<span class="selector-class">.example</span><span class="selector-class">.dubbodemo</span><span class="selector-class">.spi</span><span class="selector-class">.FirstHello</span></span><br><span class="line">second=com<span class="selector-class">.example</span><span class="selector-class">.dubbodemo</span><span class="selector-class">.spi</span><span class="selector-class">.SecondHello</span></span><br><span class="line">adaptive=com<span class="selector-class">.example</span><span class="selector-class">.dubbodemo</span><span class="selector-class">.spi</span>.AdaptiveHello</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æµ‹è¯•ç±»</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAdaptiveClass</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Hello</span> <span class="variable">hello</span> <span class="operator">=</span> ExtensionLoader.getExtensionLoader(Hello.class).getAdaptiveExtension();</span><br><span class="line">    System.out.println(hello.sayHello());<span class="comment">// è¾“å‡º first hello, é»˜è®¤å€¼å°±æ˜¯ æ¥å£ä¸Šçš„ @SPI æ³¨è§£ä¸­çš„å€¼</span></span><br><span class="line"></span><br><span class="line">    ((AdaptiveHello)hello).setType(<span class="string">&quot;second&quot;</span>);</span><br><span class="line">    System.out.println(hello.sayHello());  <span class="comment">// è¾“å‡º second hello, å› ä¸ºé€šè¿‡ type è®¾ç½®äº†æƒ³è¦çš„ç±»å‹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h2 id="dubbo-ä¸­-wrapper-æœºåˆ¶æ¡ˆä¾‹"><a href="#dubbo-ä¸­-wrapper-æœºåˆ¶æ¡ˆä¾‹" class="headerlink" title="dubbo ä¸­ wrapper æœºåˆ¶æ¡ˆä¾‹"></a>dubbo ä¸­ wrapper æœºåˆ¶æ¡ˆä¾‹</h2><h3 id="wrapper-æ˜¯ä»€ä¹ˆ"><a href="#wrapper-æ˜¯ä»€ä¹ˆ" class="headerlink" title="wrapper æ˜¯ä»€ä¹ˆ"></a>wrapper æ˜¯ä»€ä¹ˆ</h3><ol>
<li>ä½œç”¨ä¸Š <code>wrapper</code> å’Œ <code>aop</code> æ˜¯ç±»ä¼¼çš„ï¼Œä¹Ÿæ˜¯å¯¹ä¸€ä¸ªç±»çš„åŠŸèƒ½è¿›è¡Œå¢å¼ºï¼Œä½†æ˜¯ <code>wrapper</code> ä¸æ˜¯é€šè¿‡ <code>aop</code> çš„å½¢å¼å®ç°çš„ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ç³»åˆ—è§„èŒƒæ¥å®šä¹‰ä¸€ä¸ª <code>wrapper</code> ç±»</li>
<li>ç¬¬ä¸€ç‚¹è¯´çš„æ˜¯ <code>wrapper</code> ç±»å¯ä»¥å¢å¼ºï¼Œä½†æ˜¯æ²¡è¯´å¢å¼ºçš„æ˜¯ä»€ä¹ˆï¼Ÿ å…¶å® <code>wrapper</code> ç±»å¢å¼ºçš„å°±æ˜¯ <code>spi</code> æ¥å£çš„å®ç°ç±»</li>
</ol>
<h3 id="wrapper-ç±»è§„èŒƒ"><a href="#wrapper-ç±»è§„èŒƒ" class="headerlink" title="wrapper ç±»è§„èŒƒ"></a>wrapper ç±»è§„èŒƒ</h3><ol>
<li>å®šä¹‰çš„ <code>wrapper</code> ç±»è¦å®ç° <code>spi</code> æ¥å£</li>
<li>å®šä¹‰çš„ <code>wrapper</code> ç±»å¿…é¡»è¦åŒ…å« <code>spi</code> æ¥å£çš„å¼•ç”¨</li>
<li><code>wrapper</code> ç±»ä¸­ <code>spi</code> æ¥å£çš„å®ç°æ˜¯é€šè¿‡ä»…åŒ…å«ä¸€ä¸ª <code>spi</code> æ¥å£å‚æ•°çš„å¸¦å‚æ„é€ å™¨ä¼ å…¥çš„</li>
<li>åœ¨æ¥å£å®ç°æ–¹æ³•ä¸­æ‰€éœ€è¦è°ƒç”¨ <code>spi</code> æ¥å£å¼•ç”¨å¯¹è±¡çš„ç›¸åº”æ–¹æ³•</li>
<li><code>wrapper</code> ç±»åç§°éœ€è¦ä»¥ <code>Wrapper</code> ç»“å°¾</li>
</ol>
<h3 id="wrapper-ç±»ç¤ºä¾‹"><a href="#wrapper-ç±»ç¤ºä¾‹" class="headerlink" title="wrapper ç±»ç¤ºä¾‹"></a>wrapper ç±»ç¤ºä¾‹</h3><p>ä¸‹é¢æ˜¯ <code>wrapper</code> æ¡ˆä¾‹ä»£ç ï¼Œä¾ç„¶ä½¿ç”¨çš„æ˜¯å‰é¢çš„ <code>Hello</code> æ¥å£å’Œä¸¤ä¸ªå®ç°ç±»ä»¥åŠå¯¹è¿™ä¸¤ä¸ªå®ç°ç±»è¿›è¡Œå¢å¼ºçš„ä¸¤ä¸ª <code>wrapper</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPI æ¥å£å®šä¹‰ï¼Œé»˜è®¤å®ç°ç±»æ˜¯ FirstHello</span></span><br><span class="line"><span class="meta">@SPI(&quot;first&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    String <span class="title function_">sayHello</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªå®ç°ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstHello</span> <span class="keyword">implements</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;first hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬äºŒä¸ªå®ç°ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondHello</span> <span class="keyword">implements</span> <span class="title class_">Hello</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;second hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªå¢å¼ºç±»</span></span><br><span class="line"><span class="comment">// 1. æ»¡è¶³ç¬¬ä¸€ç‚¹è¦æ±‚ï¼ŒWrapper ç±»éœ€è¦å®ç° SPI æ¥å£</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWrapper</span> <span class="keyword">implements</span> <span class="title class_">Hello</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. æ»¡è¶³ç¬¬äºŒç‚¹ å®šä¹‰çš„ `wrapper` ç±»å¿…é¡»è¦åŒ…å« `spi` æ¥å£çš„å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">private</span> Hello hello;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. æ»¡è¶³ç¬¬ä¸‰ç‚¹ `wrapper` ç±»ä¸­ `spi` æ¥å£çš„å®ç°æ˜¯é€šè¿‡ä»…åŒ…å«ä¸€ä¸ª `spi` æ¥å£å‚æ•°çš„å¸¦å‚æ„é€ å™¨ä¼ å…¥çš„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HelloWrapper</span><span class="params">(Hello hello)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.hello = hello;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;wrapper1çš„æ–¹æ³•å¢å¼ºå¼€å§‹&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> hello.sayHello();</span><br><span class="line">        System.out.println(<span class="string">&quot;Wrapper1çš„æ–¹æ³•å¢å¼ºç»“æŸ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬äºŒä¸ªå¢å¼ºç±»</span></span><br><span class="line"><span class="comment">// 1. æ»¡è¶³ç¬¬ä¸€ç‚¹è¦æ±‚ï¼ŒWrapper ç±»éœ€è¦å®ç° SPI æ¥å£</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWrapper2</span> <span class="keyword">implements</span> <span class="title class_">Hello</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. æ»¡è¶³ç¬¬äºŒç‚¹ å®šä¹‰çš„ `wrapper` ç±»å¿…é¡»è¦åŒ…å« `spi` æ¥å£çš„å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">private</span> Hello hello;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. æ»¡è¶³ç¬¬ä¸‰ç‚¹ `wrapper` ç±»ä¸­ `spi` æ¥å£çš„å®ç°æ˜¯é€šè¿‡ä»…åŒ…å«ä¸€ä¸ª `spi` æ¥å£å‚æ•°çš„å¸¦å‚æ„é€ å™¨ä¼ å…¥çš„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HelloWrapper2</span><span class="params">(Hello hello)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.hello = hello;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;wrapper2çš„æ–¹æ³•å¢å¼ºå¼€å§‹&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> hello.sayHello();</span><br><span class="line">        System.out.println(<span class="string">&quot;Wrapper2çš„æ–¹æ³•å¢å¼ºç»“æŸ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>com.example.dubbodemo.spi.Hello</code> é…ç½®æ–‡ä»¶å†…å®¹</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">first=com<span class="selector-class">.example</span><span class="selector-class">.dubbodemo</span><span class="selector-class">.spi</span><span class="selector-class">.FirstHello</span></span><br><span class="line">second=com<span class="selector-class">.example</span><span class="selector-class">.dubbodemo</span><span class="selector-class">.spi</span><span class="selector-class">.SecondHello</span></span><br><span class="line">wrapper=com<span class="selector-class">.example</span><span class="selector-class">.dubbodemo</span><span class="selector-class">.spi</span><span class="selector-class">.HelloWrapper</span></span><br><span class="line">wrapper2=com<span class="selector-class">.example</span><span class="selector-class">.dubbodemo</span><span class="selector-class">.spi</span>.HelloWrapper2</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    ExtensionLoader&lt;Hello&gt; loader = ExtensionLoader.getExtensionLoader(Hello.class);</span><br><span class="line">    <span class="type">Hello</span> <span class="variable">firstHello</span> <span class="operator">=</span> loader.getExtension(<span class="string">&quot;first&quot;</span>);</span><br><span class="line">    System.out.println(firstHello.sayHello());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">wrapper2çš„æ–¹æ³•å¢å¼ºå¼€å§‹</span><br><span class="line">wrapper1çš„æ–¹æ³•å¢å¼ºå¼€å§‹</span><br><span class="line">Wrapper1çš„æ–¹æ³•å¢å¼ºç»“æŸ</span><br><span class="line">Wrapper2çš„æ–¹æ³•å¢å¼ºç»“æŸ</span><br><span class="line"><span class="keyword">first</span> hello</span><br></pre></td></tr></table></figure>

<h2 id="dubbo-spi-æœºåˆ¶æºç è§£æ"><a href="#dubbo-spi-æœºåˆ¶æºç è§£æ" class="headerlink" title="dubbo spi æœºåˆ¶æºç è§£æ"></a>dubbo spi æœºåˆ¶æºç è§£æ</h2><p><a href="https://cn.dubbo.apache.org/zh-cn/overview/mannual/java-sdk/reference-manual/spi/description/dubbo-spi/">dubboå®˜ç½‘spiæºç è§£æ</a></p>
<h2 id="dubbo3-æ¨¡å—é¢†åŸŸæ¨¡å‹"><a href="#dubbo3-æ¨¡å—é¢†åŸŸæ¨¡å‹" class="headerlink" title="dubbo3 æ¨¡å—é¢†åŸŸæ¨¡å‹"></a>dubbo3 æ¨¡å—é¢†åŸŸæ¨¡å‹</h2><p>å‰é¢åœ¨è®²è§£åŠ è½½ <code>spi</code> æ‰©å±•ç‚¹æ—¶ç”¨åˆ°çš„æ˜¯å¦‚ä¸‹ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ExtensionLoader&lt;Hello&gt; loader = ExtensionLoader.getExtensionLoader(Hello.class);</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯åœ¨ <code>dubbo3</code> ä¸­å·²ç»å°† <code>ExtensionLoader.getExtensionLoader</code> æ ‡è®°ä¸º <strong>å¼ƒç”¨</strong>ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ <code>dubbo3</code> ä¸­å¢åŠ äº†æ¨¡å—é¢†åŸŸæ¨¡å‹ï¼Œç®€å•ç†è§£å°±æ˜¯ <strong>æ¯ä¸€ä¸ªæ‰©å±•ç‚¹éƒ½æ˜¯æœ‰èŒƒå›´çš„ï¼Œè€Œä¹‹å‰çš„æ–¹å¼ç›¸å½“äºæ‰€æœ‰æ‰©å±•ç‚¹éƒ½åœ¨ä¸€ä¸ªèŒƒå›´ä¸­</strong></p>
<blockquote>
<p>ä¸»è¦æœ‰å¦‚ä¸‹åŸå›  ä¹‹å‰dubbo éƒ½æ˜¯åªæœ‰ä¸€ä¸ªä½œç”¨åŸŸçš„ï¼Œé€šè¿‡é™æ€ç±» å±æ€§å…±äº« å¢åŠ åŸŸæ¨¡å‹æ˜¯ä¸ºäº†:</p>
<ol>
<li>è®©Dubboæ”¯æŒå¤šåº”ç”¨çš„éƒ¨ç½²ï¼Œè¿™å—ä¸€äº›å¤§ä¼ä¸šæœ‰è¯‰æ±‚  </li>
<li>ä»æ¶æ„è®¾è®¡ä¸Šï¼Œè§£å†³é™æ€å±æ€§èµ„æºå…±äº«ã€æ¸…ç†çš„é—®é¢˜</li>
<li>åˆ†å±‚æ¨¡å‹å°†åº”ç”¨çš„ç®¡ç†å’ŒæœåŠ¡çš„ç®¡ç†åˆ†å¼€</li>
</ol>
<p>å¯èƒ½æ¯”è¾ƒæŠ½è±¡ï¼Œå¯ä»¥å…·ä½“ç‚¹æ¥çœ‹ã€‚Dubbo3ä¸­åœ¨å¯åŠ¨æ—¶å€™éœ€è¦å¯åŠ¨é…ç½®ä¸­å¿ƒã€å…ƒæ•°æ®ä¸­å¿ƒï¼Œè¿™ä¸ªé…ç½®ä¸­å¿ƒå’Œå…ƒæ•°æ®ä¸­å¿ƒå¯ä»¥å½’åº”ç”¨æ¨¡å‹æ¥ç®¡ç†ã€‚Dubboä½œä¸ºRPCæ¡†æ¶åˆéœ€è¦å¯åŠ¨æœåŠ¡å’Œå¼•ç”¨æœåŠ¡ï¼ŒæœåŠ¡çº§åˆ«çš„ç®¡ç†å°±äº¤ç»™äº†è¿™ä¸ªæ¨¡å—æ¨¡å‹æ¥ç®¡ç†ã€‚åˆ†å±‚æ¬¡çš„ç®¡ç†æ–¹ä¾¿æˆ‘ä»¬ç†è§£å’Œå¤„ç†é€»è¾‘ï¼Œçˆ¶å­çº§åˆ«çš„æ¨¡å‹åˆæ–¹ä¾¿äº†æ•°æ®ä¼ é€’ã€‚</p>
</blockquote>
<p><a href="https://cn.dubbo.apache.org/zh-cn/blog/2022/08/03/03-%E6%A1%86%E6%9E%B6%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%A8%A1%E5%9D%97%E9%A2%86%E5%9F%9F%E6%A8%A1%E5%9E%8Bmodel%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96/">å®˜ç½‘dubbo3æ¨¡å—é¢†åŸŸæ¨¡å‹</a></p>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>dubbo</category>
      </categories>
      <tags>
        <tag>dubbo</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨mavenç¼–è¯‘nacos2.2.3æºç </title>
    <url>/2023/235410d42872/index.html</url>
    <content><![CDATA[<p>ä½¿ç”¨ <code>maven</code> å‘½ä»¤è¿›å…¥ <code>nacos</code> æ ¹ç›®å½•ç¼–è¯‘</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn clean install -DskipTests</span><br></pre></td></tr></table></figure>

<p>å‡ºç°</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">Execution pmd of goal org<span class="selector-class">.apache</span><span class="selector-class">.maven</span><span class="selector-class">.plugins</span>:maven-pmd-plugin:<span class="number">3.8</span>:pmd failed: org<span class="selector-class">.apache</span><span class="selector-class">.maven</span><span class="selector-class">.reporting</span><span class="selector-class">.MavenReportException</span>:</span><br><span class="line"> Unsupported targetJdk value <span class="string">&#x27;11&#x27;</span>. </span><br></pre></td></tr></table></figure>
<p>é”™è¯¯ï¼Œè¿™æ˜¯å› ä¸ºå¢åŠ äº† <code>pmd</code> æ ¡éªŒï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤è·³è¿‡æ ¡éªŒ</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">mvn clean install &#x27;-DskipTests<span class="string">&#x27; &#x27;</span>-Dpmd.skip=<span class="literal">true</span><span class="string">&#x27; &#x27;</span>-Dcheckstyle.skip=<span class="literal">true</span>&#x27;</span><br></pre></td></tr></table></figure>

<p>å‡ºç° </p>
<figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">[ERROR] Failed to<span class="built_in"> execute </span>goal org.apache.maven.plugins:maven-compiler-plugin:3.5.1:testCompile (default-testCompile) on project nacos-config: Compilation failure</span><br><span class="line">[ERROR] /D:/code/nacos/config/src/test/java/com/alibaba/nacos/config/server/utils/ResponseUtilTest.java:[28,29] ç¨‹åºåŒ… sun.security.action ä¸å¯è§</span><br><span class="line">[ERROR]   (ç¨‹åºåŒ… sun.security.action å·²åœ¨æ¨¡å— java.base ä¸­å£°æ˜, ä½†è¯¥æ¨¡å—æœªå°†å®ƒå¯¼å‡ºåˆ°æœªå‘½åæ¨¡å—)</span><br></pre></td></tr></table></figure>
<p>é”™è¯¯ï¼Œè§£å†³æ–¹å¼æ˜¯åœ¨ <code>maven-compiler-plugin</code> é…ç½®ä¸­æ·»åŠ  <code>--add-exports=java.base/sun.security.action=ALL-UNNAMED</code> å‚æ•°ï¼Œå…·ä½“é…ç½®ä¸ºåœ¨æ ¹ç›®å½•ä¸‹çš„ <code>pom.xml</code> ä¸­æ·»åŠ ä¸‹é¢ä»£ç </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;maven-compiler-plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;maven.compiler.source&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;maven.compiler.target&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">compilerVersion</span>&gt;</span>$&#123;maven.compiler.source&#125;<span class="tag">&lt;/<span class="name">compilerVersion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">showDeprecation</span>&gt;</span>true<span class="tag">&lt;/<span class="name">showDeprecation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">showWarnings</span>&gt;</span>true<span class="tag">&lt;/<span class="name">showWarnings</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- ä¸‹é¢è¿™ä¸€æ®µæ–°æ·»åŠ çš„ç”¨äºè§£å†³ç¼–è¯‘é”™è¯¯çš„å…³é”® --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">arg</span>&gt;</span>--add-exports=java.base/sun.security.action=ALL-UNNAMED<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼š å› ä¸ºæç¤ºå‡ºç°é”™è¯¯çš„åŒ…æ˜¯ <code>sun.security.action</code>ï¼Œ æ‰€ä»¥æ·»åŠ çš„æ—¶å€™æ‰æ·»åŠ  <code>java.base/sun.security.action</code>ï¼Œ å¦‚æœæç¤ºçš„æ˜¯å…¶ä»–åŒ…ï¼Œåˆ™éœ€è¦å¯¹åº”ä¿®æ”¹</p>
<h2 id="æœ€ç»ˆæ‰“åŒ…å‘½ä»¤"><a href="#æœ€ç»ˆæ‰“åŒ…å‘½ä»¤" class="headerlink" title="æœ€ç»ˆæ‰“åŒ…å‘½ä»¤"></a>æœ€ç»ˆæ‰“åŒ…å‘½ä»¤</h2><p>æœ€ç»ˆæ‰“åŒ…éœ€è¦é€‰æ‹© profileï¼Œ è¿™ä¸ª profile åœ¨ <code>nacos-console</code> æ¨¡å—çš„ <code>pom.xml</code> æ–‡ä»¶ä¸­å·²ç»å†™äº†æ˜¯  <code>release-nacos</code>ï¼Œ æ‰€ä»¥æœ€ç»ˆæ‰“åŒ…å‘½ä»¤æ˜¯</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">mvn clean install &#x27;-DskipTests=<span class="literal">true</span><span class="string">&#x27; &#x27;</span>-Dpmd.skip=<span class="literal">true</span><span class="string">&#x27; &#x27;</span>-Dcheckstyle.skip=<span class="literal">true</span>&#x27; -Prelease-nacos</span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>nacos</category>
      </categories>
      <tags>
        <tag>nacos</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQä¸­Brokeræ³¨å†Œåˆ°Nameserverè¯¦è§£</title>
    <url>/2023/e44019fc2e8a/index.html</url>
    <content><![CDATA[]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQä¸­Messageè¯¦è§£</title>
    <url>/2023/cd2da7828738/index.html</url>
    <content><![CDATA[<h2 id="Message-ç±»ç»“æ„"><a href="#Message-ç±»ç»“æ„" class="headerlink" title="Message ç±»ç»“æ„"></a>Message ç±»ç»“æ„</h2><p>åœ¨ <code>RocketMQ</code> çš„å­æ¨¡å— <code>Common</code> ä¸­æœ‰ <code>org.apache.rocketmq.common.message.Message</code> ç±»ï¼Œ åŒ…å«çš„å±æ€§æœ‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Message</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">8445773977080406428L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String topic;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> flag;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; properties;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] body;</span><br><span class="line">    <span class="keyword">private</span> String transactionId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>topic</code>ï¼š æ¶ˆæ¯è¦å‘å¾€åˆ°é‚£ä¸ª <code>topic</code> ä¸­</li>
<li><code>flag</code>: ä½¿ç”¨æ—¶è‡ªå·±è®¾ç½®ï¼Œ<code>RocketMQ</code> æœ¬èº«å¹¶ä¸ä¼šä½¿ç”¨è¿™ä¸ªå­—æ®µï¼Œä½†æ˜¯ä¼šå¸®æˆ‘ä»¬ä»ç”Ÿäº§è€…ç«¯ç›´æ¥ä¼ é€’åˆ°æ¶ˆè´¹è€…ç«¯</li>
<li><code>properties</code>ï¼š è¿™ä¸ªå±æ€§æ˜¯ç”¨æ¥ä¼ é€’ä¸€äº›é¢å¤–çš„ä¿¡æ¯ï¼Œæœ¬è´¨å°±æ˜¯ä¸€ä¸ª <code>Map</code></li>
<li><code>body</code>ï¼š æ¶ˆæ¯ä½“</li>
<li><code>transactionId</code>ï¼š äº‹åŠ¡æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ï¼Œå¦‚æœæ˜¯æ™®é€šæ¶ˆæ¯ï¼Œåˆ™ä¸ºç©º</li>
</ul>
<h2 id="Message-æ„é€ æ–¹æ³•"><a href="#Message-æ„é€ æ–¹æ³•" class="headerlink" title="Message æ„é€ æ–¹æ³•"></a>Message æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Message</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">8445773977080406428L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Message</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Message</span><span class="params">(String topic, <span class="type">byte</span>[] body)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Message</span><span class="params">(String topic, String tags, <span class="type">byte</span>[] body)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Message</span><span class="params">(String topic, String tags, String keys, <span class="type">byte</span>[] body)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‰é¢æ‰€æœ‰æ„é€ æ–¹æ³•æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨è¿™ä¸ªæ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥åªåˆ—å‡ºæ¥æœ€ç»ˆçš„è¿™ä¸ªæ„é€ æ–¹æ³•ä»£ç </span></span><br><span class="line">    <span class="comment">// waitStoreMsgOK è¡¨ç¤ºæ˜¯å¦è¦åœ¨è¿™æ¡ Message è½åˆ°ç£ç›˜ä¸Šä¹‹åæ‰è¿”å›åº”ç­”è¿™é‡Œè¯¥å˜é‡çš„å€¼é»˜è®¤ä¸º true</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Message</span><span class="params">(String topic, String tags, String keys, <span class="type">int</span> flag, <span class="type">byte</span>[] body, <span class="type">boolean</span> waitStoreMsgOK)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.topic = topic;</span><br><span class="line">        <span class="built_in">this</span>.flag = flag;</span><br><span class="line">        <span class="built_in">this</span>.body = body;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é’ˆå¯¹ Tag å­—æ®µçš„å¤„ç†å®é™…æ˜¯å°†å…¶ä¿å­˜åœ¨ properties ä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (tags != <span class="literal">null</span> &amp;&amp; tags.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.setTags(tags);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (keys != <span class="literal">null</span> &amp;&amp; keys.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.setKeys(keys);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.setWaitStoreMsgOK(waitStoreMsgOK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTags</span><span class="params">(String tags)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.putProperty(MessageConst.PROPERTY_TAGS, tags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯ä»¥çœ‹åˆ°ä¸Šé¢è°ƒç”¨ setTags() æ–¹æ³•æ—¶å®é™…æ˜¯å°†å…¶ä¿å­˜åœ¨ properties ä¸­</span></span><br><span class="line">    <span class="comment">// åªæ˜¯è¿™ä¸ª key æ˜¯å†…éƒ¨ä½¿ç”¨çš„keyï¼Œå†…éƒ¨ key ä¸€èˆ¬éƒ½å®šä¹‰åœ¨ MessageConst ç±»ä¸­</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥å¦‚æœæˆ‘ä»¬è¦è‡ªå®šä¹‰å­—æ®µï¼Œä¹Ÿæ˜¯é€šè¿‡ propertiesä¼ é€’ï¼Œä½†æ˜¯key å°±ä¸è¦ä½¿ç”¨å†…éƒ¨keyäº†</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">putProperty</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> String value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == <span class="built_in">this</span>.properties) &#123;</span><br><span class="line">            <span class="built_in">this</span>.properties = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.properties.put(name, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQä¸­Producerå’ŒProducerGroup</title>
    <url>/2023/254af85a97af/index.html</url>
    <content><![CDATA[<p>RocketMQç‰ˆæœ¬: 5.1.4</p>
<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="Producer-å’Œ-ProducerGroup"><a href="#Producer-å’Œ-ProducerGroup" class="headerlink" title="Producer å’Œ ProducerGroup"></a>Producer å’Œ ProducerGroup</h2><h3 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h3><ul>
<li>Producer æ˜¯ RocketMQ å®¢æˆ·ç«¯ï¼Œè´Ÿè´£å‘ RocketMQ é›†ç¾¤å‘é€æ¶ˆæ¯ã€‚</li>
</ul>
<h3 id="ProducerGroup"><a href="#ProducerGroup" class="headerlink" title="ProducerGroup"></a>ProducerGroup</h3><ul>
<li><code>ProducerGroup</code> æ˜¯ä¸€ç±» <code>Producer</code>, æ¯”å¦‚ç°åœ¨å¤§å¤šéƒ½æ˜¯å¾®æœåŠ¡æ¶æ„ï¼Œè€Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½æ˜¯å¤šå®ä¾‹çš„ï¼Œ å¦‚ä¸‹æ‰€ç¤º</li>
</ul>
<pre class="mermaid">graph LR
    PA["ProducerGroupA"]
    PA--> A1 & A2 & A3 & A4
    subgraph A["æœåŠ¡A"]
        A1("å®ä¾‹1ï¼ˆProducerGroup=GroupAï¼‰")
        A2("å®ä¾‹2ï¼ˆProducerGroup=GroupAï¼‰")
        A3("å®ä¾‹ â€¦â€¦ ")
        A4("å®ä¾‹Mï¼ˆProducerGroup=GroupAï¼‰")
    end
    subgraph B["MessageQueue"]
        B1("MessageQueue1")
        B2("MessageQueue2")
        B3("â€¦â€¦")
        B4("MessageQueue3")
    end
    A1-->B1
    A2-->B2
    A2-->B3
    A4-->B4</pre>

<ul>
<li><p>åŒä¸€ä¸ªæœåŠ¡çš„ä¸åŒå®ä¾‹å±äºåŒä¸€ä¸ª <code>ProducerGroup</code></p>
</li>
<li><p>æ¯ä¸€ä¸ªå®ä¾‹å¯ä»¥å°†æ¶ˆæ¯å‘å¾€å¯¹åº”  <code>Topic</code> çš„å¤šä¸ª <code>Queue</code> ä¸­</p>
</li>
<li><p><code>ProducerGroup</code> çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</p>
</li>
</ul>
<p>ä¸Šé¢æœ‰æåˆ° <code>ProducerGroup</code> æ˜¯ä¸ºäº†å°†ç”Ÿäº§è€…å½’ç±»ï¼Œæ—¢ç„¶æ˜¯å½’ç±»ï¼Œé‚£å°±æ˜¯ä¸ºäº†æ–¹ä¾¿æ‰¾åˆ°åŒç±»ç”Ÿäº§è€…ï¼Ÿé‚£ä¸ºä»€ä¹ˆè¦æ‰¾åˆ°åŒç±»ç”Ÿäº§è€…å‘¢ï¼Ÿè¿™é‡Œå’Œ <strong>äº‹åŠ¡æ¶ˆæ¯</strong> æœ‰å…³ï¼Œäº‹åŠ¡æ¶ˆæ¯æ˜¯åˆ†æˆäº†å¤šä¸ªé˜¶æ®µï¼Œå¦‚æœæŸä¸ªç”Ÿäº§è€…åœ¨äº‹åŠ¡æ¶ˆæ¯çš„å…¶ä¸­ä¸€ä¸ªé˜¶æ®µå¤±è´¥äº†ï¼Œé‚£å°±å¯ä»¥æ‰¾åˆ°åŒç±»ç”Ÿäº§è€…ï¼ˆä¹Ÿå°±æ˜¯åŒä¸€ä¸ªæœåŠ¡çš„å…¶ä»–å®ä¾‹ï¼‰æ¥è¿›è¡Œåç»­çš„æ“ä½œ <strong>è¿™é‡Œè¦è®°ä½çš„é‡ç‚¹æ˜¯å±äºåŒä¸€ä¸ªç»„çš„ç”Ÿäº§è€…ä»–ä»¬å‘é€æ¶ˆæ¯çš„topicå’Œå¯¹åº”çš„æ“ä½œéƒ½æ˜¯ç›¸åŒçš„</strong></p>
<h2 id="ç”Ÿäº§è€…åˆå§‹åŒ–æµç¨‹"><a href="#ç”Ÿäº§è€…åˆå§‹åŒ–æµç¨‹" class="headerlink" title="ç”Ÿäº§è€…åˆå§‹åŒ–æµç¨‹"></a>ç”Ÿäº§è€…åˆå§‹åŒ–æµç¨‹</h2><p>åœ¨ <code>RocketMQ</code> æºç çš„ <code>example</code> æ¨¡å—ä¸‹å¯ä»¥æ‰¾åˆ° <code>org.apache.rocketmq.example.simple.Producer</code> æµ‹è¯•ç±»ï¼Œè¯¥ç±»å°±æ˜¯æµ‹è¯•æ¶ˆæ¯å‘é€æµç¨‹çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PRODUCER_GROUP</span> <span class="operator">=</span> <span class="string">&quot;ProducerGroupName&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_NAMESRVADDR</span> <span class="operator">=</span> <span class="string">&quot;127.0.0.1:9876&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOPIC</span> <span class="operator">=</span> <span class="string">&quot;TopicTest&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;TagA&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 1. å®ä¾‹åŒ–</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(PRODUCER_GROUP);</span><br><span class="line">        producer.setNamesrvAddr(DEFAULT_NAMESRVADDR);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. åˆå§‹åŒ–</span></span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">128</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(TOPIC, TAG, <span class="string">&quot;OrderID188&quot;</span>, <span class="string">&quot;Hello world&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3. å‘é€æ¶ˆæ¯</span></span><br><span class="line">                <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.send(msg);</span><br><span class="line">                System.out.printf(<span class="string">&quot;%s%n&quot;</span>, sendResult);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ä½¿ç”¨ ç”Ÿäº§è€…çš„ä½¿ç”¨ä¸»è¦å¦‚ä¸‹ä¸‰ä¸ªæ­¥éª¤</p>
<ol>
<li>å®ä¾‹åŒ– <code>Producer</code></li>
<li>åˆå§‹åŒ– <code>Producer</code></li>
<li>å‘é€æ¶ˆæ¯</li>
</ol>
<h3 id="å®ä¾‹åŒ–"><a href="#å®ä¾‹åŒ–" class="headerlink" title="å®ä¾‹åŒ–"></a>å®ä¾‹åŒ–</h3><p>å®ä¾‹åŒ– <code>Producer</code>, è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>DefaultMQProducer</code>, ä½†æ˜¯çœŸæ­£æ‰§è¡Œæ¶ˆæ¯å‘é€çš„è¿˜æ˜¯ <code>DefaultMQProducerImpl</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">DefaultMQProducer</span><span class="params">(<span class="keyword">final</span> String namespace, <span class="keyword">final</span> String producerGroup, RPCHook rpcHook)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.namespace = namespace;</span><br><span class="line">    <span class="built_in">this</span>.producerGroup = producerGroup;</span><br><span class="line">    defaultMQProducerImpl = <span class="keyword">new</span> <span class="title class_">DefaultMQProducerImpl</span>(<span class="built_in">this</span>, rpcHook);</span><br><span class="line">    <span class="comment">// produceAccumulator å’Œæ‰¹é‡æ¶ˆæ¯æœ‰å…³</span></span><br><span class="line">    produceAccumulator = MQClientManager.getInstance().getOrCreateProduceAccumulator(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p>åœ¨è®²è§£åˆå§‹åŒ–ä¹‹å‰éœ€è¦å¯ä»¥å…ˆäº†è§£ä¸‹ç›¸å…³çš„ç±»</p>
<ul>
<li><code>MQClientInstance</code>ï¼š ä»£è¡¨çš„æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯å®ä¾‹ï¼ˆ <code>Producer</code> å’Œ <code>Consumer</code> éƒ½æ˜¯å®¢æˆ·ç«¯å®ä¾‹ï¼‰ï¼Œé‡Œé¢ä¼šä¿å­˜æœ‰å®¢æˆ·ç«¯ç›¸å…³çš„é…ç½®ï¼Œæ¯”å¦‚ <code>namesrvAddr</code>ï¼Œ <code>clientIP</code>ï¼Œ å‘é€æ¶ˆæ¯ç›¸å…³çš„ <code>Topic</code> ç­‰ä¿¡æ¯</li>
<li><code>MQClientManager</code>ï¼š ä»£è¡¨çš„æ˜¯å®¢æˆ·ç«¯ç®¡ç†å™¨ï¼ŒåŒä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¯åŠ¨å¤šä¸ª <code>Producer</code> å’Œ <code>Consumer</code> å®ä¾‹ï¼Œå³å¯ä»¥è®¤ä¸ºæœ‰å¤šä¸ª <code>MQClientInstance</code>ï¼Œ <code>MQClientManager</code> å°±æ˜¯ç®¡ç†å¤šä¸ª <code>MQClientInstance</code></li>
</ul>
<p>åˆå§‹åŒ– <code>Producer</code>, ä¸»è¦æ˜¯è°ƒç”¨ <code>DefaultMQProducer#start()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> MQClientException &#123;</span><br><span class="line">    <span class="built_in">this</span>.setProducerGroup(withNamespace(<span class="built_in">this</span>.producerGroup));</span><br><span class="line">    <span class="comment">// å› ä¸ºå®é™…å‘é€æ¶ˆæ¯çš„æ˜¯ DefaultMQProducerImplï¼Œ æ‰€ä»¥é‡ç‚¹çœ‹è¿™ä¸ª</span></span><br><span class="line">    <span class="built_in">this</span>.defaultMQProducerImpl.start();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.produceAccumulator != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.produceAccumulator.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != traceDispatcher) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            traceDispatcher.start(<span class="built_in">this</span>.getNamesrvAddr(), <span class="built_in">this</span>.getAccessChannel());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;trace dispatcher start failed &quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥çœ‹ <code>this.defaultMQProducerImpl.start();</code>ï¼Œ ä¹Ÿå°±æ˜¯ <code>DefaultMQProducerImpl#start()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(<span class="keyword">final</span> <span class="type">boolean</span> startFactory)</span> <span class="keyword">throws</span> MQClientException &#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="built_in">this</span>.serviceState) &#123;</span><br><span class="line">        <span class="keyword">case</span> CREATE_JUST:</span><br><span class="line">            <span class="comment">// è®¾ç½®é»˜è®¤çŠ¶æ€æ—¶å¯åŠ¨å¤±è´¥ï¼Œå¦‚æœå¯åŠ¨æˆåŠŸå†ä¿®æ”¹çŠ¶æ€</span></span><br><span class="line">            <span class="built_in">this</span>.serviceState = ServiceState.START_FAILED;</span><br><span class="line">            <span class="comment">// æ£€æŸ¥ç”Ÿäº§è€…ç»„çš„é…ç½®</span></span><br><span class="line">            <span class="built_in">this</span>.checkConfig();</span><br><span class="line">            <span class="comment">// ä¿®æ”¹ instanceName, å¦‚æœæ²¡æœ‰è‡ªå·±è®¾ç½®åˆ™å°†å…¶ä¿®æ”¹ä¸º â€œthis.instanceName = UtilAll.getPid() + &quot;#&quot; + System.nanoTime()â€</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.defaultMQProducer.getProducerGroup().equals(MixAll.CLIENT_INNER_PRODUCER_GROUP)) &#123;</span><br><span class="line">                <span class="built_in">this</span>.defaultMQProducer.changeInstanceNameToPID();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è¿™é‡Œå°±æ˜¯åˆ›å»º MQClientInstanceï¼Œå¹¶ä¸”å°†å…¶å­˜å…¥ MQClientManager</span></span><br><span class="line">            <span class="built_in">this</span>.mQClientFactory = MQClientManager.getInstance().getOrCreateMQClientInstance(<span class="built_in">this</span>.defaultMQProducer, rpcHook);</span><br><span class="line">            <span class="comment">// è¿™é‡Œçš„æ³¨å†Œå®é™…æ˜¯å°† Producer å­˜å…¥ MQClientInstance çš„ ConcurrentMap&lt;String, MQProducerInner&gt; producerTable å±æ€§ä¸­</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">registerOK</span> <span class="operator">=</span> mQClientFactory.registerProducer(<span class="built_in">this</span>.defaultMQProducer.getProducerGroup(), <span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (!registerOK) &#123;</span><br><span class="line">                <span class="built_in">this</span>.serviceState = ServiceState.CREATE_JUST;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MQClientException</span>(<span class="string">&quot;The producer group[&quot;</span> + <span class="built_in">this</span>.defaultMQProducer.getProducerGroup()</span><br><span class="line">                    + <span class="string">&quot;] has been created before, specify another name please.&quot;</span> + FAQUrl.suggestTodo(FAQUrl.GROUP_NAME_DUPLICATE_URL),</span><br><span class="line">                    <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (startFactory) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 *  ã€ä»£ç 1ã€‘</span></span><br><span class="line"><span class="comment">                 * </span></span><br><span class="line"><span class="comment">                 *  è¿™é‡Œçš„å¯åŠ¨ä¹Ÿæ˜¯æ ¸å¿ƒï¼Œä¸»è¦åŒ…å«</span></span><br><span class="line"><span class="comment">                 * 1. å¯åŠ¨åº•å±‚ Netty æœåŠ¡è¿›è¡Œé€šä¿¡</span></span><br><span class="line"><span class="comment">                 * 2. å¯åŠ¨å®šæ—¶ä»»åŠ¡ä¸æ–­ä» Nameserve è·å–æœ€æ–°çš„æ•°æ®</span></span><br><span class="line"><span class="comment">                 * 3. å¯åŠ¨æ‹‰å–æ¶ˆæ¯çš„å®šæ—¶ä»»åŠ¡æœåŠ¡</span></span><br><span class="line"><span class="comment">                 * 4. å¯åŠ¨ RebalanceService æœåŠ¡</span></span><br><span class="line"><span class="comment">                 * 5. å¯åŠ¨æ¸…é™¤ä¸‹çº¿çš„ broker å®šæ—¶ä»»åŠ¡çº¿ç¨‹</span></span><br><span class="line"><span class="comment">                 * 6. å¯åŠ¨å®šæ—¶ä»»åŠ¡å‘é€å¿ƒè·³åˆ° broker ä¸­</span></span><br><span class="line"><span class="comment">                 * 7. å¦‚æœæ˜¯ consumerï¼Œ è¿˜ä¼šæœ‰å®šæ—¶æŒä¹…åŒ–çš„æ“ä½œ</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                mQClientFactory.start();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.mqFaultStrategy.startDetector();</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;the producer [&#123;&#125;] start OK. sendMessageWithVIPChannel=&#123;&#125;&quot;</span>, <span class="built_in">this</span>.defaultMQProducer.getProducerGroup(),</span><br><span class="line">                <span class="built_in">this</span>.defaultMQProducer.isSendMessageWithVIPChannel());</span><br><span class="line">            <span class="built_in">this</span>.serviceState = ServiceState.RUNNING;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> RUNNING:</span><br><span class="line">        <span class="keyword">case</span> START_FAILED:</span><br><span class="line">        <span class="keyword">case</span> SHUTDOWN_ALREADY:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MQClientException</span>(<span class="string">&quot;The producer service state not OK, maybe started once, &quot;</span></span><br><span class="line">                + <span class="built_in">this</span>.serviceState</span><br><span class="line">                + FAQUrl.suggestTodo(FAQUrl.CLIENT_SERVICE_NOT_OK),</span><br><span class="line">                <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å‘é€æ‰€æœ‰å¿ƒè·³åˆ° Broker ä¸­</span></span><br><span class="line">    <span class="built_in">this</span>.mQClientFactory.sendHeartbeatToAllBrokerWithLock();</span><br><span class="line"></span><br><span class="line">    RequestFutureHolder.getInstance().startScheduledTask(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="ç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„æµç¨‹"><a href="#ç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„æµç¨‹" class="headerlink" title="ç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„æµç¨‹"></a>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„æµç¨‹</h2><ol><li><a href="/2023/22987494ce74/index.html" title="RocketMQä¸­åŒæ­¥å’Œå¼‚æ­¥æ¶ˆæ¯å‘é€æµç¨‹">RocketMQä¸­åŒæ­¥å’Œå¼‚æ­¥æ¶ˆæ¯å‘é€æµç¨‹</a></li></ol>

<h2 id="ç”Ÿäº§è€…çš„é«˜å¯ç”¨"><a href="#ç”Ÿäº§è€…çš„é«˜å¯ç”¨" class="headerlink" title="ç”Ÿäº§è€…çš„é«˜å¯ç”¨"></a>ç”Ÿäº§è€…çš„é«˜å¯ç”¨</h2><h3 id="å®¢æˆ·ç«¯ä¿è¯"><a href="#å®¢æˆ·ç«¯ä¿è¯" class="headerlink" title="å®¢æˆ·ç«¯ä¿è¯"></a>å®¢æˆ·ç«¯ä¿è¯</h3><ul>
<li>é‡è¯•æœºåˆ¶ï¼Œ é€šè¿‡ä¸‹é¢å‚æ•°é…ç½®</li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">rocketmq.producer.retry-times-when-send-failed</span>=<span class="string">2</span></span><br><span class="line"><span class="attr">rocketmq.producer.retry-times-when-send-async-failed</span>=<span class="string">2</span></span><br></pre></td></tr></table></figure>
<p><strong>åŒæ­¥å‘é€é‡è¯•</strong>çš„æ ¸å¿ƒä»£ç æ˜¯åœ¨ <code>org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl#sendDefaultImpl()</code> æ–¹æ³•ï¼Œ ä¸‹é¢åªå±•ç¤ºè¯¥æ–¹æ³•ä¸é‡è¯•ç›¸å…³çš„ä»£ç </p>
<p><code>DefaultMQProducerImpl</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> SendResult <span class="title function_">sendDefaultImpl</span><span class="params">(</span></span><br><span class="line"><span class="params">        Message msg,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> CommunicationMode communicationMode,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> SendCallback sendCallback,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">long</span> timeout</span></span><br><span class="line"><span class="params">    )</span> <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</span><br><span class="line">    <span class="keyword">if</span> (topicPublishInfo != <span class="literal">null</span> &amp;&amp; topicPublishInfo.ok()) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">callTimeout</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">MessageQueue</span> <span class="variable">mq</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Exception</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// è·å–è°ƒç”¨çš„æ€»æ¬¡æ•°</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">timesTotal</span> <span class="operator">=</span> communicationMode == CommunicationMode.SYNC ? <span class="number">1</span> + <span class="built_in">this</span>.defaultMQProducer.getRetryTimesWhenSendFailed() : <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">times</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        String[] brokersSent = <span class="keyword">new</span> <span class="title class_">String</span>[timesTotal];</span><br><span class="line">        <span class="keyword">for</span> (; times &lt; timesTotal; times++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">lastBrokerName</span> <span class="operator">=</span> <span class="literal">null</span> == mq ? <span class="literal">null</span> : mq.getBrokerName();</span><br><span class="line">            <span class="type">MessageQueue</span> <span class="variable">mqSelected</span> <span class="operator">=</span> <span class="built_in">this</span>.selectOneMessageQueue(topicPublishInfo, lastBrokerName);</span><br><span class="line">            <span class="keyword">if</span> (mqSelected != <span class="literal">null</span>) &#123;</span><br><span class="line">                mq = mqSelected;</span><br><span class="line">                brokersSent[times] = mq.getBrokerName();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// å‘é€æ¶ˆæ¯å¹¶è·å–è¿”å›ç»“æœ</span></span><br><span class="line">                    sendResult = <span class="built_in">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout - costTime);</span><br><span class="line">                    endTimestamp = System.currentTimeMillis();</span><br><span class="line">                    <span class="built_in">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">switch</span> (communicationMode) &#123;</span><br><span class="line">                        <span class="comment">// å¼‚æ­¥å‘é€çš„ç»“æœä¸æ˜¯åœ¨è¿™é‡Œè·å–,æ‰€ä»¥ç›´æ¥è¿”å› null</span></span><br><span class="line">                        <span class="keyword">case</span> ASYNC:</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                        <span class="comment">// åªå‘é€ä¸€æ¬¡ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦é‡è¯•</span></span><br><span class="line">                        <span class="keyword">case</span> ONEWAY:</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                        <span class="comment">// åŒæ­¥å‘é€ï¼Œç»“æœåœ¨è¿™é‡Œè·å–</span></span><br><span class="line">                        <span class="keyword">case</span> SYNC:</span><br><span class="line">                            <span class="keyword">if</span> (sendResult.getSendStatus() != SendStatus.SEND_OK) &#123;</span><br><span class="line">                                <span class="comment">// å‘é€ä¸æˆåŠŸï¼Œå¹¶ä¸”å¼€å¯äº†é‡è¯•ï¼Œåˆ™è¿›è¡Œé‡è¯•ï¼Œä¹Ÿå°±æ˜¯è¿›å…¥ for å¾ªç¯çš„ä¸‹ä¸€æ¬¡å¾ªç¯</span></span><br><span class="line">                                <span class="keyword">if</span> (<span class="built_in">this</span>.defaultMQProducer.isRetryAnotherBrokerWhenNotStoreOK()) &#123;</span><br><span class="line">                                    <span class="keyword">continue</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> sendResult;</span><br><span class="line">                        <span class="keyword">default</span>:</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å¼‚æ­¥å‘é€é‡è¯•</strong>çš„æ ¸å¿ƒä»£ç æ˜¯åœ¨ <code>org.apache.rocketmq.client.impl.MQClientAPIImpl#sendMessageAsync()</code> æ–¹æ³•ä¸­<br><code>MQClientAPIImpl</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendMessageAsync</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> String addr,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> String brokerName,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> Message msg,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">long</span> timeoutMillis,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> RemotingCommand request,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> SendCallback sendCallback,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> TopicPublishInfo topicPublishInfo,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> MQClientInstance instance,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">int</span> retryTimesWhenSendFailed,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> AtomicInteger times,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> SendMessageContext context,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> DefaultMQProducerImpl producer</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">beginStartTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// new InvokeCallback() å°±æ˜¯æ‰§è¡Œå‘é€æ¶ˆæ¯çš„å›è°ƒ</span></span><br><span class="line">        <span class="built_in">this</span>.remotingClient.invokeAsync(addr, request, timeoutMillis, <span class="keyword">new</span> <span class="title class_">InvokeCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ResponseFuture responseFuture)</span> &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">cost</span> <span class="operator">=</span> System.currentTimeMillis() - beginStartTime;</span><br><span class="line">                <span class="type">RemotingCommand</span> <span class="variable">response</span> <span class="operator">=</span> responseFuture.getResponseCommand();</span><br><span class="line">                <span class="comment">// response != null ä»£è¡¨æ¶ˆæ¯å‘é€æˆåŠŸ</span></span><br><span class="line">                <span class="keyword">if</span> (response != <span class="literal">null</span>) &#123;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// response == null ä»£è¡¨æ¶ˆæ¯å‘é€å¤±è´¥, åœ¨ onExceptionImpl é‡Œé¢å°±ä¼šè¿›è¡Œå‘é€æ–¹æ³•çš„é‡è¯•</span></span><br><span class="line">                    producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), <span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> (!responseFuture.isSendRequestOK()) &#123;</span><br><span class="line">                        <span class="type">MQClientException</span> <span class="variable">ex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MQClientException</span>(<span class="string">&quot;send request failed&quot;</span>, responseFuture.getCause());</span><br><span class="line">                        onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span><br><span class="line">                            retryTimesWhenSendFailed, times, ex, context, <span class="literal">true</span>, producer);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (responseFuture.isTimeout()) &#123;</span><br><span class="line">                        <span class="type">MQClientException</span> <span class="variable">ex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MQClientException</span>(<span class="string">&quot;wait response timeout &quot;</span> + responseFuture.getTimeoutMillis() + <span class="string">&quot;ms&quot;</span>,</span><br><span class="line">                            responseFuture.getCause());</span><br><span class="line">                        onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span><br><span class="line">                            retryTimesWhenSendFailed, times, ex, context, <span class="literal">true</span>, producer);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="type">MQClientException</span> <span class="variable">ex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MQClientException</span>(<span class="string">&quot;unknow reseaon&quot;</span>, responseFuture.getCause());</span><br><span class="line">                        onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span><br><span class="line">                            retryTimesWhenSendFailed, times, ex, context, <span class="literal">true</span>, producer);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å®¢æˆ·ç«¯å®¹é”™"><a href="#å®¢æˆ·ç«¯å®¹é”™" class="headerlink" title="å®¢æˆ·ç«¯å®¹é”™"></a>å®¢æˆ·ç«¯å®¹é”™</h3><p><code>RocketMQ Client</code> ä¼šç»´æŠ¤ä¸€ä¸ª â€œBroker-å‘é€å»¶è¿Ÿâ€ å…³ç³»ï¼Œæ ¹æ®è¿™ä¸ªå…³ç³»é€‰æ‹©ä¸€ä¸ªå‘é€å»¶è¿Ÿçº§åˆ«è¾ƒä½çš„ <code>Broker</code> æ¥å‘é€æ¶ˆæ¯ï¼Œè¿™æ ·èƒ½æœ€å¤§é™åº¦åœ°åˆ©ç”¨ <code>Broker</code> çš„èƒ½åŠ›ï¼Œå‰”é™¤å·²ç»å®•æœºã€ä¸å¯ç”¨æˆ–è€…å‘é€å»¶è¿Ÿçº§åˆ«è¾ƒé«˜çš„ <code>Broker</code>ï¼Œå°½é‡ä¿è¯æ¶ˆæ¯çš„æ­£å¸¸å‘é€</p>
<p>é€‰æ‹© <code>Broker</code> å…¶å®å°±æ˜¯é€‰æ‹© <code>MessageQueue</code> å‘é€æ¶ˆæ¯, å…·ä½“å®ç°åœ¨ <code>org.apache.rocketmq.client.latency.MQFaultStrategy#selectOneMessageQueue()</code> æ–¹æ³•ä¸­ï¼Œå‰é¢è®²åˆ°åŒæ­¥å‘é€æ¶ˆæ¯çš„æ–¹æ³•é»˜è®¤æ˜¯ <code>org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl#sendDefaultImpl()</code>ï¼Œ è€Œ <code>selectOneMessageQueue</code> æ–¹æ³•å°±æ˜¯åœ¨ <code>sendDefaultImpl</code> æ–¹æ³•ä¸­è¿›è¡Œè°ƒç”¨çš„</p>
<p><code>selectOneMessageQueue</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> MessageQueue <span class="title function_">selectOneMessageQueue</span><span class="params">(<span class="keyword">final</span> TopicPublishInfo tpInfo, <span class="keyword">final</span> String lastBrokerName)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. å¦‚æœå¼€å¯äº†å‘é€å»¶è¿Ÿå®¹é”™ï¼Œæ‰ä¼šè°ƒç”¨å®¹é”™ç›¸å…³çš„é€»è¾‘</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.sendLatencyFaultEnable) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> tpInfo.getSendWhichQueue().incrementAndGet();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; tpInfo.getMessageQueueList().size(); i++) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> Math.abs(index++) % tpInfo.getMessageQueueList().size();</span><br><span class="line">                <span class="keyword">if</span> (pos &lt; <span class="number">0</span>)</span><br><span class="line">                    pos = <span class="number">0</span>;</span><br><span class="line">                <span class="type">MessageQueue</span> <span class="variable">mq</span> <span class="operator">=</span> tpInfo.getMessageQueueList().get(pos);</span><br><span class="line">                <span class="keyword">if</span> (latencyFaultTolerance.isAvailable(mq.getBrokerName()))</span><br><span class="line">                    <span class="keyword">return</span> mq;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">notBestBroker</span> <span class="operator">=</span> latencyFaultTolerance.pickOneAtLeast();</span><br><span class="line">            <span class="type">int</span> <span class="variable">writeQueueNums</span> <span class="operator">=</span> tpInfo.getQueueIdByBroker(notBestBroker);</span><br><span class="line">            <span class="keyword">if</span> (writeQueueNums &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">MessageQueue</span> <span class="variable">mq</span> <span class="operator">=</span> tpInfo.selectOneMessageQueue();</span><br><span class="line">                <span class="keyword">if</span> (notBestBroker != <span class="literal">null</span>) &#123;</span><br><span class="line">                    mq.setBrokerName(notBestBroker);</span><br><span class="line">                    mq.setQueueId(tpInfo.getSendWhichQueue().incrementAndGet() % writeQueueNums);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> mq;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                latencyFaultTolerance.remove(notBestBroker);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Error occurred when selecting message queue&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> tpInfo.selectOneMessageQueue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tpInfo.selectOneMessageQueue(lastBrokerName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è·å–ä¸€ä¸ªåœ¨å»¶è¿Ÿä¸Šå¯ä»¥æ¥å—ï¼Œå¹¶ä¸”å’Œä¸Šæ¬¡å‘é€ç›¸åŒçš„ <code>Broker</code>ã€‚é¦–å…ˆè·å–ä¸€ä¸ªè‡ªå¢åºå·<code>index</code>ï¼Œé€šè¿‡å–æ¨¡è·å–<code>Queue</code>çš„ä½ç½®ä¸‹æ ‡ <code>Pos</code>ã€‚å¦‚æœ <code>Pos</code>å¯¹åº”çš„ <code>Broker</code>çš„å»¶è¿Ÿæ—¶é—´æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå¹¶ä¸”æ˜¯ç¬¬ä¸€æ¬¡å‘é€ï¼Œæˆ–è€…å’Œä¸Šæ¬¡å‘é€çš„<code>Broker</code>ç›¸åŒï¼Œåˆ™å°†<code>Queue</code>è¿”å›</li>
<li>å¦‚æœç¬¬ä¸€æ­¥æ²¡æœ‰é€‰ä¸­ä¸€ä¸ª<code>Broker</code>ï¼Œåˆ™é€‰æ‹©ä¸€ä¸ªå»¶è¿Ÿè¾ƒä½çš„<code>Broker</code></li>
<li>å¦‚æœç¬¬ä¸€ã€äºŒæ­¥éƒ½æ²¡æœ‰é€‰ä¸­ä¸€ä¸ª<code>Broker</code>ï¼Œåˆ™éšæœºé€‰æ‹©ä¸€ä¸ª<code>Broker</code></li>
</ul>
<h3 id="Broker-ç«¯ä¿è¯"><a href="#Broker-ç«¯ä¿è¯" class="headerlink" title="Broker ç«¯ä¿è¯"></a>Broker ç«¯ä¿è¯</h3><ul>
<li><code>Broker</code> ç«¯åŒ…å« <code>Master</code> å’Œ <code>Slave</code></li>
<li><code>Master</code> å’Œ <code>Slave</code> ä¹‹é—´æœ‰<strong>åŒæ­¥å¤åˆ¶</strong> å’Œ <strong>å¼‚æ­¥å¤åˆ¶</strong>ï¼Œå¦‚æœè¦æƒ³åšåˆ°é«˜å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ <strong>åŒæ­¥å¤åˆ¶</strong></li>
</ul>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQä¸­åŒæ­¥å’Œå¼‚æ­¥æ¶ˆæ¯å‘é€æµç¨‹</title>
    <url>/2023/22987494ce74/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="Producer-åˆå§‹åŒ–æµç¨‹"><a href="#Producer-åˆå§‹åŒ–æµç¨‹" class="headerlink" title="Producer åˆå§‹åŒ–æµç¨‹"></a>Producer åˆå§‹åŒ–æµç¨‹</h2><p>æ¶ˆæ¯åœ¨å‘é€ä¹‹å‰éœ€è¦å…ˆåˆå§‹åŒ– <code>Producer</code>, å…·ä½“å¯ä»¥å‚è€ƒ</p>


<h2 id="æ¶ˆæ¯ç±»å‹"><a href="#æ¶ˆæ¯ç±»å‹" class="headerlink" title="æ¶ˆæ¯ç±»å‹"></a>æ¶ˆæ¯ç±»å‹</h2><pre class="mermaid">mindmap
Root("Producer(ç”Ÿäº§è€…)")
    A("æ™®é€šæ¶ˆæ¯")
        A1("åŒæ­¥å‘é€")
        A2("å¼‚æ­¥å‘é€")
        A3("å•å‘å‘é€")
    B("é¡ºåºæ¶ˆæ¯")
    C("å»¶è¿Ÿæ¶ˆæ¯")
    D("æ‰¹é‡æ¶ˆæ¯")
    E("äº‹åŠ¡æ¶ˆæ¯")</pre>


<h2 id="æ™®é€š-åŒæ­¥æ¶ˆæ¯å‘é€æµç¨‹"><a href="#æ™®é€š-åŒæ­¥æ¶ˆæ¯å‘é€æµç¨‹" class="headerlink" title="æ™®é€š-åŒæ­¥æ¶ˆæ¯å‘é€æµç¨‹"></a>æ™®é€š-åŒæ­¥æ¶ˆæ¯å‘é€æµç¨‹</h2><p>æ™®é€šæ¶ˆæ¯å‘é€ä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PRODUCER_GROUP</span> <span class="operator">=</span> <span class="string">&quot;ProducerGroupName&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_NAMESRVADDR</span> <span class="operator">=</span> <span class="string">&quot;192.168.208.130:9876&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOPIC</span> <span class="operator">=</span> <span class="string">&quot;TopicTest&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;TagA&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 1. å®ä¾‹åŒ–</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(PRODUCER_GROUP);</span><br><span class="line">        producer.setNamesrvAddr(DEFAULT_NAMESRVADDR);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. åˆå§‹åŒ–</span></span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">128</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 3. æ„é€ æ¶ˆæ¯</span></span><br><span class="line">                <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(TOPIC, TAG, <span class="string">&quot;OrderID188&quot;</span>, <span class="string">&quot;Hello world&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">                <span class="comment">// 4. å‘é€æ¶ˆæ¯</span></span><br><span class="line">                <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.send(msg);</span><br><span class="line">                System.out.printf(<span class="string">&quot;%s%n&quot;</span>, sendResult);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‘é€æ¶ˆæ¯çš„æ ¸å¿ƒæµç¨‹</p>
<figure class="highlight leaf"><table><tr><td class="code"><pre><span class="line">DefaultMQProducer<span class="punctuation">#</span><span class="keyword">send</span><span class="params">(<span class="variable">Message</span>)</span></span><br><span class="line">    DefaultMQProducer<span class="punctuation">#</span><span class="keyword">sendDirect</span><span class="params">()</span></span><br><span class="line">        DefaultMQProducerImpl<span class="punctuation">#</span><span class="keyword">send</span><span class="params">(<span class="variable">org</span>.<span class="variable">apache</span>.<span class="variable">rocketmq</span>.<span class="variable">common</span>.<span class="variable">message</span>.<span class="variable">Message</span>, <span class="variable">long</span>)</span></span><br><span class="line">            DefaultMQProducerImpl<span class="punctuation">#</span><span class="keyword">sendDefaultImpl</span><span class="params">()</span></span><br></pre></td></tr></table></figure>

<p>å¯¹äºæ™®é€šåŒæ­¥æ¶ˆæ¯ï¼Œæœ€ç»ˆçš„ä¸»æµç¨‹ä»£ç æ˜¯åœ¨ <code>DefaultMQProducerImpl#sendDefaultImpl()</code> ä¸­ï¼Œæ¥ä¸‹æ¥å°±çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•ï¼ˆåªå±•ç¤ºäº†ä¸»è¦ç›¸å…³ä»£ç ï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> SendResult <span class="title function_">sendDefaultImpl</span><span class="params">(</span></span><br><span class="line"><span class="params">        Message msg,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> CommunicationMode communicationMode,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> SendCallback sendCallback,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">long</span> timeout</span></span><br><span class="line"><span class="params">    )</span> <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</span><br><span class="line">        <span class="built_in">this</span>.makeSureStateOK();</span><br><span class="line">        Validators.checkMessage(msg, <span class="built_in">this</span>.defaultMQProducer);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">invokeID</span> <span class="operator">=</span> random.nextLong();</span><br><span class="line">        <span class="type">long</span> <span class="variable">beginTimestampFirst</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">beginTimestampPrev</span> <span class="operator">=</span> beginTimestampFirst;</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTimestamp</span> <span class="operator">=</span> beginTimestampFirst;</span><br><span class="line">        <span class="comment">// æ ¸å¿ƒæ­¥éª¤1ï¼šæ„é€  TopicPublishInfo</span></span><br><span class="line">        <span class="type">TopicPublishInfo</span> <span class="variable">topicPublishInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.tryToFindTopicPublishInfo(msg.getTopic());</span><br><span class="line">        <span class="keyword">if</span> (topicPublishInfo != <span class="literal">null</span> &amp;&amp; topicPublishInfo.ok()) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">callTimeout</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="type">MessageQueue</span> <span class="variable">mq</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// è·å–é‡è¯•æ­¤æ—¶ï¼Œæ€»æ¬¡æ•° = 1+é‡è¯•æ¬¡æ•°ï¼ˆåŒæ­¥çš„æ—¶å€™æ‰ä¼šé‡è¯•ï¼‰</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">timesTotal</span> <span class="operator">=</span> communicationMode == CommunicationMode.SYNC ? <span class="number">1</span> + <span class="built_in">this</span>.defaultMQProducer.getRetryTimesWhenSendFailed() : <span class="number">1</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">times</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            String[] brokersSent = <span class="keyword">new</span> <span class="title class_">String</span>[timesTotal];</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">resetIndex</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (; times &lt; timesTotal; times++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">lastBrokerName</span> <span class="operator">=</span> <span class="literal">null</span> == mq ? <span class="literal">null</span> : mq.getBrokerName();</span><br><span class="line">                <span class="keyword">if</span> (times &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    resetIndex = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ ¸å¿ƒæ­¥éª¤2ï¼šé€‰æ‹©ä¸€ä¸ª MessageQueue</span></span><br><span class="line">                <span class="type">MessageQueue</span> <span class="variable">mqSelected</span> <span class="operator">=</span> <span class="built_in">this</span>.selectOneMessageQueue(topicPublishInfo, lastBrokerName, resetIndex);</span><br><span class="line">                <span class="keyword">if</span> (mqSelected != <span class="literal">null</span>) &#123;</span><br><span class="line">                    mq = mqSelected;</span><br><span class="line">                    brokersSent[times] = mq.getBrokerName();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// æ ¸å¿ƒæ­¥éª¤3ï¼š æ‰§è¡Œæ¶ˆæ¯çš„å‘é€é€»è¾‘</span></span><br><span class="line">                        sendResult = <span class="built_in">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout - costTime);</span><br><span class="line">                        endTimestamp = System.currentTimeMillis();</span><br><span class="line">                        <span class="built_in">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                        <span class="keyword">switch</span> (communicationMode) &#123;</span><br><span class="line">                            <span class="keyword">case</span> ASYNC:</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                            <span class="keyword">case</span> ONEWAY:</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                            <span class="keyword">case</span> SYNC:</span><br><span class="line">                                <span class="comment">// å¦‚æœå‘é€ä¸æˆåŠŸï¼Œä½¿ç”¨continueå°±ä¼šè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯é‡è¯•</span></span><br><span class="line">                                <span class="keyword">if</span> (sendResult.getSendStatus() != SendStatus.SEND_OK) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (<span class="built_in">this</span>.defaultMQProducer.isRetryAnotherBrokerWhenNotStoreOK()) &#123;</span><br><span class="line">                                        <span class="keyword">continue</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="comment">// å¦‚æœå‘é€æˆåŠŸï¼Œå°±ç›´æ¥è¿”å›ç»“æœ</span></span><br><span class="line">                                <span class="keyword">return</span> sendResult;</span><br><span class="line">                            <span class="keyword">default</span>:</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sendResult != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> sendResult;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>æ ¸å¿ƒæµç¨‹çš„é€»è¾‘å¦‚ä¸‹</p>
<ol>
<li>æ„é€  <code>TopicPublishInfo</code>, è¯¥ç»“æ„åŒ…å«é˜Ÿåˆ—(<code>Queue</code>, <code>Broker</code>)</li>
<li>é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆ<code>MessageQueue</code>ï¼‰è¿›è¡Œå‘é€ï¼Œå› ä¸ºæ¶ˆæ¯å®é™…æ˜¯å‘å¾€é˜Ÿåˆ—çš„ï¼Œ<code>Topic</code> æ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µ</li>
<li>æ ¹æ® <code>MessageQueue</code> è·å–å¯¹åº”çš„ <code>BrokerName</code> å’Œ <code>BrokerAddr</code></li>
<li>åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦éœ€è¦å‹ç¼©ï¼ˆæ¶ˆæ¯å¤§äº 4K åˆ™å‹ç¼©ï¼‰</li>
<li>æ‰§è¡Œæ¶ˆæ¯å‘é€ï¼Œè‹¥å‘é€å¤±è´¥ï¼Œåˆ™è¿›è¡Œé‡è¯•</li>
</ol>
<p>ä¸‹é¢çœ‹ä¸€ä¸‹è¿™å‡ ä¸ªæ ¸å¿ƒæ­¥éª¤</p>
<div class="tabs" id="å‘é€æ¶ˆæ¯æ ¸å¿ƒæ­¥éª¤"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="å‘é€æ¶ˆæ¯æ ¸å¿ƒæ­¥éª¤-1">æ„é€ TopicPublishInfo</button><button type="button" class="tab " data-href="å‘é€æ¶ˆæ¯æ ¸å¿ƒæ­¥éª¤-2">é€‰æ‹©MessageQueue</button></ul><div class="tab-contents"><div class="tab-item-content active" id="å‘é€æ¶ˆæ¯æ ¸å¿ƒæ­¥éª¤-1"><p>å…ˆçœ‹ä¸€ä¸‹ <code>TopicPublishInfo</code> ç»“æ„ï¼Œ <code>TopicPublishInfo</code> åŒ…å«äº† <code>Lis&lt;MessageQueue&gt;</code> å’Œ <code>TopicRouteData</code><br><code>TopicPublishInfo</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TopicPublishInfo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">orderTopic</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">haveTopicRouterInfo</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> List&lt;MessageQueue&gt; messageQueueList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> TopicRouteData topicRouteData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>TopicRouteData</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TopicRouteData</span> <span class="keyword">extends</span> <span class="title class_">RemotingSerializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;QueueData&gt; queueDatas;</span><br><span class="line">    <span class="keyword">private</span> List&lt;BrokerData&gt; brokerDatas;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String<span class="comment">/*brokerName*/</span>, TopicQueueMappingInfo&gt; topicQueueMappingByBroker;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MessageQueue</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageQueue</span> <span class="keyword">implements</span> <span class="title class_">Comparable</span>&lt;MessageQueue&gt;, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> String topic;</span><br><span class="line">    <span class="keyword">private</span> String brokerName;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> queueId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ ¸å¿ƒæ­¥éª¤1</strong> è°ƒç”¨çš„ä»£ç æ˜¯ <code>TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());</code> æ‰€ä»¥éœ€è¦çœ‹ <code>tryToFindTopicPublishInfo</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> TopicPublishInfo <span class="title function_">tryToFindTopicPublishInfo</span><span class="params">(<span class="keyword">final</span> String topic)</span> &#123;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯è‚¯å®šæ²¡æœ‰å€¼ï¼Œæ‰€ä»¥æ˜¯èµ°ä¸‹é¢çš„æµç¨‹</span></span><br><span class="line">    <span class="type">TopicPublishInfo</span> <span class="variable">topicPublishInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.topicPublishInfoTable.get(topic);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == topicPublishInfo || !topicPublishInfo.ok()) &#123;</span><br><span class="line">        <span class="built_in">this</span>.topicPublishInfoTable.putIfAbsent(topic, <span class="keyword">new</span> <span class="title class_">TopicPublishInfo</span>());</span><br><span class="line">        <span class="built_in">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(topic);</span><br><span class="line">        topicPublishInfo = <span class="built_in">this</span>.topicPublishInfoTable.get(topic);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (topicPublishInfo.isHaveTopicRouterInfo() || topicPublishInfo.ok()) &#123;</span><br><span class="line">        <span class="keyword">return</span> topicPublishInfo;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ¬¡å¾€æŸä¸ª topic ä¸­å‘é€æ•°æ®æ—¶èµ°è¿™ä¸ªé€»è¾‘ï¼Œæ³¨æ„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’çš„æ˜¯ true</span></span><br><span class="line">        <span class="comment">// è¿™ä¸ªå‚æ•°ä»£è¡¨çš„æ˜¯å¦æ˜¯é»˜è®¤çš„ topic</span></span><br><span class="line">        <span class="built_in">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(topic, <span class="literal">true</span>, <span class="built_in">this</span>.defaultMQProducer);</span><br><span class="line">        topicPublishInfo = <span class="built_in">this</span>.topicPublishInfoTable.get(topic);</span><br><span class="line">        <span class="keyword">return</span> topicPublishInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ„å»º <code>TopicPublishInfo</code> ç±»çš„è¿‡ç¨‹å®é™…æ˜¯å…ˆä» <code>Nameserver</code> è·å–æ•°æ®ï¼Œ<code>updateTopicRouteInfoFromNameServer()</code> æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ <code>true</code>, æ‰€ä»¥æœ€ç»ˆæ˜¯è°ƒç”¨åˆ°ä¸‹é¢æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AUTO_CREATE_TOPIC_KEY_TOPIC</span> <span class="operator">=</span> <span class="string">&quot;TBW102&quot;</span>; </span><br><span class="line"><span class="keyword">public</span> TopicRouteData <span class="title function_">getDefaultTopicRouteInfoFromNameServer</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> timeoutMillis)</span></span><br><span class="line">        <span class="keyword">throws</span> RemotingException, MQClientException, InterruptedException &#123;</span><br><span class="line">    <span class="keyword">return</span> getTopicRouteInfoFromNameServer(TopicValidator.AUTO_CREATE_TOPIC_KEY_TOPIC, timeoutMillis, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤å®é™…è·å–çš„æ˜¯ <code>TBW102</code> è¿™ä¸ªå†…éƒ¨ <code>Topic</code> çš„ç›¸å…³æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰çš„ <code>Topic</code> çš„ç›¸å…³æ•°æ®å®é™…æ˜¯ä» <code>TBW102</code> ä¸­æ‹·è´è¿‡æ¥çš„ï¼Œ <code>TBW102</code> çš„ <code>ReadQueue</code> å’Œ <code>WriteQueue</code> éƒ½æ˜¯ 8ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªå®šä¹‰çš„ <code>Topic</code> è¯»å†™é˜Ÿåˆ—ä¹Ÿæ˜¯ 8 ä¹ˆï¼Ÿ å®é™…ä¸æ˜¯çš„ï¼Œå¤„ç†è¯»å†™é˜Ÿåˆ—çš„ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// MQClientInstance ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">updateTopicRouteInfoFromNameServer</span><span class="params">(<span class="keyword">final</span> String topic, <span class="type">boolean</span> isDefault,</span></span><br><span class="line"><span class="params">        DefaultMQProducer defaultMQProducer)</span> &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.lockNamesrv.tryLock(LOCK_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TopicRouteData topicRouteData;</span><br><span class="line">            <span class="keyword">if</span> (isDefault &amp;&amp; defaultMQProducer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// default=true æ—¶ä¼šèµ°ä¸‹é¢é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯ä¼šæŸ¥è¯¢ TBW102 topic çš„æ•°æ®</span></span><br><span class="line">                topicRouteData = <span class="built_in">this</span>.mQClientAPIImpl.getDefaultTopicRouteInfoFromNameServer(clientConfig.getMqClientApiTimeout());</span><br><span class="line">                <span class="keyword">if</span> (topicRouteData != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (QueueData data : topicRouteData.getQueueDatas()) &#123;</span><br><span class="line">                        <span class="comment">// è¿™é‡Œè·å–è¯»å†™é˜Ÿåˆ—çš„é€»è¾‘æ˜¯æœ€é…ç½®çš„ å€¼å’Œ TBW102 topic readQueueNum çš„æœ€å°å€¼</span></span><br><span class="line">                        <span class="comment">// å‰é¢è¯´ TBW102 topic readQueueNum æ˜¯8ï¼Œ ä½†æ˜¯ getDefaultTopicQueueNums é»˜è®¤æ˜¯ 4</span></span><br><span class="line">                        <span class="comment">// private volatile int defaultTopicQueueNums = 4; ï¼ˆDefaultMQProducer ç±»ï¼‰</span></span><br><span class="line">                        <span class="type">int</span> <span class="variable">queueNums</span> <span class="operator">=</span> Math.min(defaultMQProducer.getDefaultTopicQueueNums(), data.getReadQueueNums());</span><br><span class="line">                        data.setReadQueueNums(queueNums);</span><br><span class="line">                        data.setWriteQueueNums(queueNums);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å…¶ä»–ä»£ç çœç•¥</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åé¢ä»£ç å°±ä¸åˆ†æäº†ï¼ŒåŸºæœ¬ä¼šæ˜¯ä» <code>TopicRouteData</code> ä¸­è·å–æ•°æ®å¡«å……åˆ° <code>TopicPublishInfo</code> ä¸­</p></div><div class="tab-item-content" id="å‘é€æ¶ˆæ¯æ ¸å¿ƒæ­¥éª¤-2"><p>å¯¹äºé€‰æ‹© MessageQueue éœ€è¦å…³æ³¨çš„å°±æ˜¯æœ‰ä¸€ä¸ª <strong>é¿è®©</strong> é€»è¾‘ï¼Œå³å½“å‰é¢å‘é€æ¶ˆæ¯å¤±è´¥æ—¶ï¼Œåœ¨é‡è¯•çš„æ—¶å€™ä¸ä¼šé€‰æ‹©åˆ°ä¸Šä¸€æ¬¡å‘é€çš„ <code>Broker</code> ( å› ä¸º <code>Queue</code> æ˜¯åˆ†é…åœ¨ <code>Broker</code> ä¸Šçš„ï¼Œæ‰€ä»¥é€‰æ‹© <code>Queue</code> ä¹Ÿå¯ä»¥è®¤ä¸ºå°±æ˜¯é€‰æ‹© <code>Broker</code> )</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.client.latency.MQFaultStrategy#selectOneMessageQueue ç±»</span></span><br><span class="line"><span class="keyword">public</span> MessageQueue <span class="title function_">selectOneMessageQueue</span><span class="params">(<span class="keyword">final</span> TopicPublishInfo tpInfo, <span class="keyword">final</span> String lastBrokerName, <span class="keyword">final</span> <span class="type">boolean</span> resetIndex)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯é‡è¯•çš„è¯ï¼ŒlastBrokerNameå°±ä¸ä¸ºç©ºï¼ŒBrokerFilter ä¸­å°±åŒ…å« lastBrokerName å­—æ®µ</span></span><br><span class="line">    <span class="type">BrokerFilter</span> <span class="variable">brokerFilter</span> <span class="operator">=</span> threadBrokerFilter.get();</span><br><span class="line">    brokerFilter.setLastBrokerName(lastBrokerName);</span><br><span class="line">    <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œ BrokerFilter å°±æ˜¯ç”¨æ¥è¿‡æ»¤ä¸Šä¸€æ¬¡å‘é€å¤±è´¥çš„ Broker çš„</span></span><br><span class="line">    <span class="type">MessageQueue</span> <span class="variable">mq</span> <span class="operator">=</span> tpInfo.selectOneMessageQueue(brokerFilter);</span><br><span class="line">    <span class="keyword">if</span> (mq != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mq;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tpInfo.selectOneMessageQueue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  selectOneMessageQueue ç±»çš„å†…éƒ¨ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">BrokerFilter</span> <span class="keyword">implements</span> <span class="title class_">QueueFilter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String lastBrokerName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLastBrokerName</span><span class="params">(String lastBrokerName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.lastBrokerName = lastBrokerName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">filter</span><span class="params">(MessageQueue mq)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastBrokerName != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> !mq.getBrokerName().equals(lastBrokerName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  TopicPublishInfo ç±»</span></span><br><span class="line"><span class="keyword">private</span> MessageQueue <span class="title function_">selectOneMessageQueue</span><span class="params">(List&lt;MessageQueue&gt; messageQueueList, ThreadLocalIndex sendQueue, QueueFilter ...filter)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (messageQueueList == <span class="literal">null</span> || messageQueueList.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (filter != <span class="literal">null</span> &amp;&amp; filter.length != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; messageQueueList.size(); i++) &#123;</span><br><span class="line">            <span class="comment">//  å¯¹é˜Ÿåˆ—çš„æ•°é‡è¿›è¡Œå–æ¨¡è¿ç®—</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> Math.abs(sendQueue.incrementAndGet() % messageQueueList.size());</span><br><span class="line">            <span class="type">MessageQueue</span> <span class="variable">mq</span> <span class="operator">=</span> messageQueueList.get(index);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">filterResult</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// è¿›è¡Œè¿‡æ»¤ï¼Œè°ƒç”¨ QueueFilterçš„filter æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">for</span> (QueueFilter f: filter) &#123;</span><br><span class="line">                Preconditions.checkNotNull(f);</span><br><span class="line">                filterResult &amp;= f.filter(mq);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (filterResult) &#123;</span><br><span class="line">                <span class="keyword">return</span> mq;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> Math.abs(sendQueue.incrementAndGet() % messageQueueList.size());</span><br><span class="line">    <span class="keyword">return</span> messageQueueList.get(index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>


<h2 id="æ™®é€š-å•å‘æ¶ˆæ¯å‘é€"><a href="#æ™®é€š-å•å‘æ¶ˆæ¯å‘é€" class="headerlink" title="æ™®é€š-å•å‘æ¶ˆæ¯å‘é€"></a>æ™®é€š-å•å‘æ¶ˆæ¯å‘é€</h2><p>å•å‘å‘é€å’ŒåŒæ­¥å‘é€çš„å·®å¼‚æ˜¯ï¼šå•å‘å‘é€æ¶ˆæ¯ä¸éœ€è¦å¤„ç†å‘é€ç»“æœï¼Œä¸ç”¨ç®¡æ˜¯å‘é€æˆåŠŸè¿˜æ˜¯å‘é€å¤±è´¥ï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡æœ‰é‡è¯•çš„é€»è¾‘</p>
<p><strong>å•å‘å‘é€çš„ä½¿ç”¨åœºæ™¯</strong><br>ä»€ä¹ˆæƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨å•å‘å‘é€å‘¢ï¼Ÿ å› ä¸ºå•å‘å‘é€å¯èƒ½ä¼šä¸¢å¤±æ•°æ®ï¼Œæ‰€ä»¥å…è®¸ä¸¢å¤±æ•°æ®çš„åœºæ™¯å°±å¯ä»¥ä½¿ç”¨ï¼Œä¸€èˆ¬æ¥è¯´åƒæ—¥å¿—æ”¶é›†ä¹‹ç±»çš„å¯ä»¥ä½¿ç”¨å•å‘å‘é€</p>
<h2 id="æ™®é€š-å¼‚æ­¥æ¶ˆæ¯å‘é€"><a href="#æ™®é€š-å¼‚æ­¥æ¶ˆæ¯å‘é€" class="headerlink" title="æ™®é€š-å¼‚æ­¥æ¶ˆæ¯å‘é€"></a>æ™®é€š-å¼‚æ­¥æ¶ˆæ¯å‘é€</h2><p>å¯ä»¥ä» <code>RocketMQ</code> æºç çš„ <code>example</code> æ¨¡å—ä¸‹æ‰¾åˆ° <code>org.apache.rocketmq.example.simple.AsyncProducer</code> ç±»ï¼Œè¿™æ˜¯å¼‚æ­¥å‘é€çš„ç¤ºä¾‹ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncProducer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(</span></span><br><span class="line"><span class="params">        String[] args)</span> <span class="keyword">throws</span> MQClientException, InterruptedException, UnsupportedEncodingException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;Jodie_Daily_test&quot;</span>);</span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="comment">// suggest to on enableBackpressureForAsyncMode in heavy traffic, default is false</span></span><br><span class="line">        producer.setEnableBackpressureForAsyncMode(<span class="literal">true</span>);</span><br><span class="line">        producer.setRetryTimesWhenSendAsyncFailed(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">messageCount</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(messageCount);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; messageCount; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">                <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;Jodie_topic_1023&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;TagA&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;OrderID188&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Hello world&quot;</span>.getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                producer.send(msg, <span class="keyword">new</span> <span class="title class_">SendCallback</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(SendResult sendResult)</span> &#123;</span><br><span class="line">                        countDownLatch.countDown();</span><br><span class="line">                        System.out.printf(<span class="string">&quot;%-10d OK %s %n&quot;</span>, index, sendResult.getMsgId());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onException</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">                        countDownLatch.countDown();</span><br><span class="line">                        System.out.printf(<span class="string">&quot;%-10d Exception %s %n&quot;</span>, index, e);</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒæ­¥æ¶ˆæ¯ä½¿ç”¨çš„ <code>public SendResult send(Message msg)</code> æ–¹æ³•<br>å¼‚æ­¥æ¶ˆæ¯ä½¿ç”¨çš„ <code>public void send(Message msg,SendCallback sendCallback)</code> æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æœ‰å›è°ƒå‡½æ•°<br>é‚£ä¹ˆå¼‚æ­¥æ¶ˆæ¯æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ æ¥ä¸‹æ¥å°±çœ‹å¼‚æ­¥æ¶ˆæ¯çš„æ ¸å¿ƒå®ç°åŸç†, ä¸‹é¢å…ˆçŒœæƒ³ä¸€ä¸‹ï¼Œç„¶åçœ‹æºç å»éªŒè¯</p>
<ol>
<li>æ—¢ç„¶æ˜¯å¼‚æ­¥ï¼Œé‚£ä¹ˆä¸šåŠ¡çº¿ç¨‹å’Œå®é™…å‘é€æ¶ˆæ¯çš„çº¿ç¨‹è‚¯å®šä¸æ˜¯åŒä¸€ä¸ªï¼ŒåŸºæœ¬ä¸Šå°±å¯ä»¥è‚¯å®šå‘é€çº¿ç¨‹æ˜¯ä½¿ç”¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ± æ¥å®ç°çš„</li>
<li>å¼‚æ­¥è°ƒç”¨æ—¶ä¼ å…¥äº† <code>SendCallback</code>ï¼Œ é‚£ä¹ˆåœ¨å‘é€çº¿ç¨‹å¾—åˆ°å‘é€ç»“æœåå°±éœ€è¦è°ƒç”¨è¿™ä¸ª <code>SendCallback</code>ï¼Œè¿™æ ·å°±å¯ä»¥æ‹¿åˆ°è¿”å›ç»“æœ</li>
</ol>
<p>å¼‚æ­¥è°ƒç”¨æµç¨‹</p>
<figure class="highlight leaf"><table><tr><td class="code"><pre><span class="line">DefaultMQProducer<span class="punctuation">#</span><span class="keyword">send</span><span class="params">(<span class="variable">Message</span>, <span class="variable">SendCallback</span>)</span></span><br><span class="line">    DefaultMQProducer<span class="punctuation">#</span><span class="keyword">sendDirect</span><span class="params">(<span class="variable">Message</span>, <span class="variable">MessageQueue</span>,<span class="variable">SendCallback</span>)</span></span><br><span class="line">        DefaultMQProducerImpl<span class="punctuation">#</span><span class="keyword">send</span><span class="params">(<span class="variable">Message</span>, <span class="variable">SendCallback</span>)</span></span><br><span class="line">            DefaultMQProducerImpl<span class="punctuation">#</span><span class="keyword">send</span><span class="params">(<span class="variable">Message</span>, <span class="variable">SendCallback</span>, <span class="variable">long</span>)</span>  ã€é‡ç‚¹ä»£ç 1ã€‘</span><br><span class="line">                DefaultMQProducerImpl<span class="punctuation">#</span><span class="keyword">executeAsyncMessageSend</span><span class="params">(<span class="variable">Runnable</span>, <span class="variable">Message</span>, <span class="variable">BackpressureSendCallBack</span>,<span class="variable">long</span>, <span class="variable">long</span>)</span> ã€é‡ç‚¹ä»£ç 2ã€‘</span><br><span class="line">                    DefaultMQProducerImpl<span class="punctuation">#</span><span class="keyword">sendDefaultImpl</span></span><br></pre></td></tr></table></figure>

<p>æ ¹æ®ä¸Šé¢çš„è°ƒç”¨æµç¨‹ï¼Œç›´æ¥çœ‹ <strong>é‡ç‚¹ä»£ç 1</strong> éƒ¨åˆ†ï¼Œ å³ <code>DefaultMQProducerImpl#send(Message, SendCallback, long)</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  DefaultMQProducerImpl ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(<span class="keyword">final</span> Message msg, <span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> SendCallback sendCallback, <span class="keyword">final</span> <span class="type">long</span> timeout)</span></span><br><span class="line">        <span class="keyword">throws</span> MQClientException, RemotingException, InterruptedException &#123;</span><br><span class="line">    <span class="type">BackpressureSendCallBack</span> <span class="variable">newCallBack</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BackpressureSendCallBack</span>(sendCallback);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">beginStartTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// æ„é€ ä»»åŠ¡ï¼Œè¿™é‡Œåªæ˜¯åˆ›å»ºäº†ä¸€ä¸ª Runnable å¯¹è±¡ï¼Œå¹¶æ²¡æœ‰è°ƒç”¨ start æ–¹æ³•</span></span><br><span class="line">    <span class="comment">// å®é™…ä¼šå°†è¿™ä¸ªä»»åŠ¡äº¤ç»™ çº¿ç¨‹æ±  å»æ‰§è¡Œ</span></span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                makeSureStateOK();</span><br><span class="line">                Validators.checkMessage(msg, defaultMQProducer);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!msg.getTopic().equals(mq.getTopic())) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MQClientException</span>(<span class="string">&quot;Topic of the message does not match its target message queue&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">long</span> <span class="variable">costTime</span> <span class="operator">=</span> System.currentTimeMillis() - beginStartTime;</span><br><span class="line">                <span class="keyword">if</span> (timeout &gt; costTime) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// åœ¨ä»»åŠ¡é‡Œé¢æ‰§è¡Œæ¶ˆæ¯çš„å‘é€ï¼ŒåŒæ—¶å°† callback å›è°ƒå‡½æ•°ä¼ å…¥ï¼Œè¿™æ ·å°†æ”¶åˆ°æ¶ˆæ¯çš„ç»“æœ</span></span><br><span class="line">                        <span class="comment">// ä¹‹åå°±å¯ä»¥è°ƒç”¨å›è°ƒå‡½æ•°</span></span><br><span class="line">                        sendKernelImpl(msg, mq, CommunicationMode.ASYNC, newCallBack, <span class="literal">null</span>,</span><br><span class="line">                            timeout - costTime);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (MQBrokerException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MQClientException</span>(<span class="string">&quot;unknown exception&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    newCallBack.onException(<span class="keyword">new</span> <span class="title class_">RemotingTooMuchRequestException</span>(<span class="string">&quot;call timeout&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                newCallBack.onException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// è¿™é‡Œé¢å°±æ˜¯å°†ä»»åŠ¡äº¤ç»™ çº¿ç¨‹æ±  å»æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢åˆ—å‡ºçš„ **é‡ç‚¹ä»£ç 2**</span></span><br><span class="line">    executeAsyncMessageSend(runnable, msg, newCallBack, timeout, beginStartTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeAsyncMessageSend</span><span class="params">(Runnable runnable, <span class="keyword">final</span> Message msg, <span class="keyword">final</span> BackpressureSendCallBack sendCallback,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">long</span> timeout, <span class="keyword">final</span> <span class="type">long</span> beginStartTime)</span></span><br><span class="line">    <span class="keyword">throws</span> MQClientException, InterruptedException &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="built_in">this</span>.getAsyncSenderExecutor();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isEnableBackpressureForAsyncMode</span> <span class="operator">=</span> <span class="built_in">this</span>.getDefaultMQProducer().isEnableBackpressureForAsyncMode();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSemaphoreAsyncNumAquired</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSemaphoreAsyncSizeAquired</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">msgLen</span> <span class="operator">=</span> msg.getBody() == <span class="literal">null</span> ? <span class="number">1</span> : msg.getBody().length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isEnableBackpressureForAsyncMode) &#123;</span><br><span class="line">            <span class="comment">// çœç•¥â€¦â€¦</span></span><br><span class="line">        &#125;</span><br><span class="line">        sendCallback.isSemaphoreAsyncSizeAquired = isSemaphoreAsyncSizeAquired;</span><br><span class="line">        sendCallback.isSemaphoreAsyncNumAquired = isSemaphoreAsyncNumAquired;</span><br><span class="line">        sendCallback.msgLen = msgLen;</span><br><span class="line">        <span class="comment">//  å°†å‘é€æ¶ˆæ¯çš„ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± ä¸­</span></span><br><span class="line">        executor.submit(runnable);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isEnableBackpressureForAsyncMode) &#123;</span><br><span class="line">            runnable.run();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MQClientException</span>(<span class="string">&quot;executor rejected &quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤å¼‚æ­¥æ¶ˆæ¯ä»»åŠ¡æäº¤å°±å®Œæˆäº†ï¼Œè‡³äºå‘é€é€»è¾‘å…¶å®å’ŒåŒæ­¥å°±æ²¡ä»€ä¹ˆåŒºåˆ«äº†ï¼Œåªæ˜¯åœ¨ç»“æœå¤„ç†çš„åœ°æ–¹ä¼šæœ‰åŒºåˆ«ï¼ŒåŒæ­¥çš„è¯ä¼šéœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå¼‚æ­¥çš„è¯ç›´æ¥è¿”å› <code>null</code>, å½“æ”¶åˆ°å“åº”åç›´æ¥è°ƒç”¨å›è°ƒå‡½æ•°</p>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQä¹‹Brokerè¯¦è§£</title>
    <url>/2023/5398bb79bdb5/index.html</url>
    <content><![CDATA[<p>RocketMQç‰ˆæœ¬ï¼š 5.1.4</p>
<p>ä»¥ä¸‹ä»£ç åœ¨ <code>broker</code> å­æ¨¡å—ä¸­</p>
<h2 id="è·å–å¯åŠ¨æ–‡ä»¶"><a href="#è·å–å¯åŠ¨æ–‡ä»¶" class="headerlink" title="è·å–å¯åŠ¨æ–‡ä»¶"></a>è·å–å¯åŠ¨æ–‡ä»¶</h2><p>å¯åŠ¨ <code>broker</code> çš„è„šæœ¬æ˜¯ <code>bin/mqbroker</code>, è¿™ä¸ªæ‰§è¡Œæ–‡ä»¶çš„æœ€åä¸€è¡Œæ˜¯ <code>sh $&#123;ROCKETMQ_HOME&#125;/bin/runbroker.sh org.apache.rocketmq.broker.BrokerStartup $@</code>ï¼Œ æ‰€ä»¥åœ¨æºç ä¸­å¯åŠ¨ <code>broker</code> çš„æ–‡ä»¶å…¶å®æ˜¯ <code>BrokerStartup</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BrokerStartup</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        start(createBrokerController(args));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†</p>
<ul>
<li>åˆ›å»º <code>BrokerController</code></li>
<li>å¯åŠ¨ <code>BrokerController</code></li>
</ul>
<h2 id="BrokerController-åˆ›å»ºæµç¨‹"><a href="#BrokerController-åˆ›å»ºæµç¨‹" class="headerlink" title="BrokerController åˆ›å»ºæµç¨‹"></a>BrokerController åˆ›å»ºæµç¨‹</h2><h2 id="BrokerControlelr-å¯åŠ¨æµç¨‹"><a href="#BrokerControlelr-å¯åŠ¨æµç¨‹" class="headerlink" title="BrokerControlelr å¯åŠ¨æµç¨‹"></a>BrokerControlelr å¯åŠ¨æµç¨‹</h2>]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQå®‰è£…ä½¿ç”¨å’ŒåŸºæœ¬æ¦‚å¿µ</title>
    <url>/2023/49fb249febb6/index.html</url>
    <content><![CDATA[<p>jdkç‰ˆæœ¬ï¼š17<br>rocketmqç‰ˆæœ¬ï¼š4.9.7 å’Œ 5.1.4</p>
<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå‡ºç°äº†å¦‚ä¸‹å‡ ä¸ªåè¯</p>
<ul>
<li><code>Broker</code></li>
<li><code>Producer</code></li>
<li><code>Consumer</code></li>
<li><code>Topic</code></li>
<li><code>Queue</code></li>
<li><code>NameServer</code></li>
</ul>
<pre class="mermaid">flowchart TB
    MP["Producer"]
    MC["Consumer"]
    style MP fill:#ca108c
    style MC fill:#ca108c
    subgraph A["æ¶ˆæ¯é˜Ÿåˆ—é›†ç¾¤"]
        style A fill:#8a5dca
        subgraph AA["Master"]
            subgraph A1["BrokerA"]
                style A1 fill:#7bed9f
                A11["queue 0 \n (TopicA)"]
                style A11 fill:#5dcac1
                A12["queue 0 \n (TopicB)"]
                style A12 fill:#ca8a5d
                A13["queue 0 \n (TopicC)"]
                style A13 fill:#f9d3e3
            end
            subgraph A2["BrokerB"]
                style A2 fill:#7bed9f
                A21["queue 1 \n (TopicA)"]
                style A21 fill:#5dcac1
                A22["queue 1 \n (TopicB)"]
                style A22 fill:#ca8a5d
                A23["queue 1 \n (TopicC)"]
                style A23 fill:#f9d3e3
            end
            subgraph A3["BrokerC"]
                style A3 fill:#7bed9f
                A31["queue 2 \n (TopicA)"]
                style A31 fill:#5dcac1
                A32["queue 2 \n (TopicB)"]
                style A32 fill:#ca8a5d
                A33["queue 2 \n (TopicC)"]
                style A33 fill:#f9d3e3
            end
            
        end
        subgraph BB["Slave"]
            subgraph B1["BrokerA"]
                B11["Message"]
            end
            subgraph B2["BrokerB"]
                B21["Message"]
            end
            subgraph B3["BrokerC"]
                B31["Message"]
            end
        end
        A1--åŒæ­¥-->B1
        A2--åŒæ­¥-->B2
        A3--åŒæ­¥-->B3
    end
    subgraph C["NameServeré›†ç¾¤"]
        style C fill:#c0d695
        direction LR
        C1["NameServerA"]
        C2["NameServerB"]
        C3["NameServerC"]
        C1~~~C2~~~C3
    end
    A--"BrokerAæ³¨å†Œ"-->C
    A--"BrokerBæ³¨å†Œ"-->C
    A--"BrokerCæ³¨å†Œ"-->C
    MP--"æŠ•é€’æ¶ˆæ¯"-->A
    A--"è·å–æ¶ˆæ¯"-->MC
    MP--"è·å–å…ƒæ•°æ®"-->C
    MC--"è·å–å…ƒæ•°æ®"-->C</pre>

<p>ä¸‹é¢å°±é’ˆå¯¹è¿™äº›æ¦‚å¿µæ¥è¿›è¡Œè®²è§£</p>
<h3 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h3><p><code>Broker</code> å°±æ˜¯ <code>RocketMq</code> æœåŠ¡ç«¯ç¨‹åºï¼Œåç§°å«åš <code>Broker</code> è€Œå·²ï¼Œ<code>Broker</code> æ˜¯ <code>RocketMQ</code> ä¸­çš„æ ¸å¿ƒï¼Œç®€å•æ¥è¯´å®ƒè´Ÿè´£æ¥æ”¶ <code>Producer</code> å‘é€è¿‡æ¥çš„ <code>Message</code> ã€å¹¶å°†å…¶æŒä¹…åŒ–èµ·æ¥ï¼ŒåŒæ—¶è´Ÿè´£å¤„ç† <code>Consumer</code> çš„æ¶ˆè´¹è¯·æ±‚</p>
<pre class="mermaid">graph LR
    A["ç”Ÿäº§è€…(Producer)"]
    B["æ¶ˆæ¯é˜Ÿåˆ—(Broker)"]
    C["æ¶ˆè´¹è€…(Consumer)"]
    A--"æŠ•é€’æ¶ˆæ¯"-->B--"æ‹‰å–æ¶ˆæ¯"-->C</pre>

<h3 id="Producer-å’Œ-Consumer"><a href="#Producer-å’Œ-Consumer" class="headerlink" title="Producer å’Œ Consumer"></a>Producer å’Œ Consumer</h3><ul>
<li><code>Producer</code> å°±æ˜¯å‘é€æ¶ˆæ¯çš„ç¨‹åºï¼Œä¸€èˆ¬éƒ½æ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡ç¨‹åºä½œä¸º <code>Producer</code></li>
<li><code>Consuemr</code> å°±æ˜¯æ¶ˆè´¹æ¶ˆæ¯çš„ç¨‹åºï¼Œä¸€èˆ¬éƒ½æ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡ç¨‹åºä½œä¸º <code>Consumer</code></li>
</ul>
<h3 id="Topic"><a href="#Topic" class="headerlink" title="Topic"></a>Topic</h3><p><code>Topic</code> æ˜¯ <code>RocketMQ</code> ä¸­æ¶ˆæ¯ä¼ è¾“å’Œå­˜å‚¨çš„é¡¶å±‚å®¹å™¨ï¼Œç”¨äºæ ‡è¯†åŒä¸€ç±»ä¸šåŠ¡é€»è¾‘çš„æ¶ˆæ¯ã€‚ ä¸»é¢˜çš„ä½œç”¨ä¸»è¦å¦‚ä¸‹ï¼š</p>
<ul>
<li>å®šä¹‰æ•°æ®çš„åˆ†ç±»éš”ç¦»ï¼š åœ¨ <code>RocketMQ</code> çš„æ–¹æ¡ˆè®¾è®¡ä¸­ï¼Œå»ºè®®å°†ä¸åŒä¸šåŠ¡ç±»å‹çš„æ•°æ®æ‹†åˆ†åˆ°ä¸åŒçš„ä¸»é¢˜ä¸­ç®¡ç†ï¼Œé€šè¿‡ä¸»é¢˜å®ç°å­˜å‚¨çš„éš”ç¦»æ€§å’Œè®¢é˜…éš”ç¦»æ€§</li>
<li>å®šä¹‰æ•°æ®çš„èº«ä»½å’Œæƒé™ï¼š <code>RocketMQ</code> çš„æ¶ˆæ¯æœ¬èº«æ˜¯åŒ¿åæ— èº«ä»½çš„ï¼ŒåŒä¸€åˆ†ç±»çš„æ¶ˆæ¯ä½¿ç”¨ç›¸åŒçš„ä¸»é¢˜æ¥åšèº«ä»½è¯†åˆ«å’Œæƒé™ç®¡ç†</li>
<li><code>Topic</code> å®é™…æ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œæ¶ˆæ¯å®é™…æ˜¯å‘é€åˆ° <code>MessageQueue</code> ä¸­</li>
</ul>
<h3 id="MessageQueue"><a href="#MessageQueue" class="headerlink" title="MessageQueue"></a>MessageQueue</h3><p>ç›´æ¥ä½¿ç”¨ <code>Topic</code> å¸¦æ¥çš„é—®é¢˜è´Ÿè½½ä¸å¹³è¡¡ï¼Œæ¯”å¦‚æœ‰çš„ <code>Topic</code> æ•°æ®é‡å¾ˆå¤§ï¼Œæœ‰çš„ <code>Topic</code> æ•°æ®é‡å¾ˆå°ï¼Œå°±ä¼šå¯¼è‡´æœ‰çš„ <code>Broker</code> å‹åŠ›å¤§ï¼Œæœ‰çš„ <code>Broker</code> å‹åŠ›å°ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¶ˆæ¯å®é™…ä¸Šä¸æ˜¯ç›´æ¥å‘å¾€ <code>Topic</code> çš„ï¼Œè€Œæ˜¯å‘å¾€ <code>MessageQueue</code>, å¯¹åº”çš„å…³ç³»å›¾å¦‚ä¸‹</p>
<pre class="mermaid">graph TB
    A["TopicA"]
    subgraph B["Brokeré›†ç¾¤"]
        subgraph B1["Broker1"]
            B11["MessageQueue-1"]
        end
        subgraph B2["Broker2"]
            B21["MessageQueue-2"]
        end
        subgraph B3["Broker3"]
            B31["MessageQueue-3"]
        end
    end
    style B11 fill:#7bed9f
    style B21 fill:#7bed9f
    style B31 fill:#7bed9f
    A-->B11
    A-->B21
    A-->B31</pre>

<p>ä¸Šé¢æœ‰æåˆ° <code>Topic</code> çš„ä½œç”¨æ˜¯å¯¹æ¶ˆæ¯è¿›è¡Œåˆ†ç±»ï¼Œ<code>MessageQueue</code> æ˜¯æ¶ˆæ¯å­˜å‚¨å’Œä¼ è¾“çš„å®é™…å®¹å™¨ï¼Œä¹Ÿæ˜¯ <code>RocketMQ</code> æ¶ˆæ¯çš„æœ€å°å­˜å‚¨å•å…ƒï¼Œ æ ¹æ®ä¸Šå›¾å°±èƒ½çœ‹å‡ºæ¥ï¼ŒåŒä¸€ç±»æ¶ˆæ¯å°±å¯ä»¥åˆ†æ•£å­˜å‚¨åœ¨ä¸åŒçš„ <code>Broker</code> ä¸­ï¼Œæœºå™¨å‹åŠ›å°±åˆ†æ•£äº†</p>
<h3 id="NameServer"><a href="#NameServer" class="headerlink" title="NameServer"></a>NameServer</h3><ul>
<li><code>NameServer</code> ç”¨äºå­˜å‚¨æ•´ä¸ª <code>RocketMQ</code> é›†ç¾¤çš„ å…ƒæ•°æ®</li>
<li><code>NameServer</code> ä¸­çš„å…ƒæ•°æ®å¤§æ¦‚åŒ…å«å¦‚ä¸‹å‡ ç±»<ul>
<li>é›†ç¾¤é‡Œéƒ½åŒ…å«å“ªäº› <code>Topic</code></li>
<li>è¿™äº› <code>Topic</code> çš„ <code>MessageQueue</code> åˆ†åˆ«åœ¨å“ªäº› <code>Broker</code> ä¸Š</li>
<li>é›†ç¾¤é‡Œéƒ½æœ‰å“ªäº›æ´»è·ƒçš„ <code>Broker</code></li>
</ul>
</li>
<li>ä¸ºäº†é¿å… <code>NameServer</code> å•ç‚¹æ•…éšœï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥å°† <code>NameServer</code> éƒ¨ç½²æˆé›†ç¾¤ï¼Œä½†æ˜¯ <code>NameServer</code> ä¹‹é—´å¹¶æ²¡æœ‰æ•°æ®ä¼ é€’ï¼Œ æ¯ä¸€ä¸ª <code>NameServer</code> éƒ½åŒ…å«å®Œæ•´çš„æ•°æ®</li>
<li><code>Producer</code>,<code>Consumer</code>,<code>Broker</code> éƒ½éœ€è¦è‡ªè¡Œå°†æ•°æ®æ³¨å†Œåˆ° <code>NameServer</code> ä¸Šï¼Œå¦‚æœæ˜¯ <code>NameServer</code> æ˜¯é›†ç¾¤ï¼Œåˆ™éœ€è¦å°†æ•°æ®æ³¨å†Œåˆ°æ¯ä¸€ä¸ª <code>NameServer</code> ä¸­</li>
</ul>
<pre class="mermaid">graph TB
    subgraph A["ç”Ÿäº§è€…/æ¶ˆè´¹è€…"]
        A1["ç”Ÿäº§è€…(Producer)"]
        A2["æ¶ˆè´¹è€…(Consumer)"]
    end
    style A1 fill:#7bed9f
    style A2 fill:#7bed9f
    subgraph B["Brokeré›†ç¾¤"]
        B1["Broker1"]
        B2["Broker2"]
    end
    style B1 fill:#5dcac1
    style B2 fill:#5dcac1
    subgraph D["NameServeré›†ç¾¤"]
        D1["NameServer1"]
        D2["NameServer2"]
    end
    style D1 fill:#c0d695
    style D2 fill:#c0d695
    A1-->D1
    A1-->D2
    A2-->D1
    A2-->D2
    B1-->D1
    B1-->D2
    B2-->D1
    B2-->D2</pre>


<h2 id="RocketMQ4-å®‰è£…å’Œä½¿ç”¨"><a href="#RocketMQ4-å®‰è£…å’Œä½¿ç”¨" class="headerlink" title="RocketMQ4 å®‰è£…å’Œä½¿ç”¨"></a>RocketMQ4 å®‰è£…å’Œä½¿ç”¨</h2><p>å®‰è£… <code>RocketMQ</code> ä¹‹å‰éœ€è¦ä¸‹å®‰è£… <code>JDK</code> ç¯å¢ƒ</p>
<ol><li><a href="/2023/e6e83576f25e/index.html" title="Ubuntu23.04å®‰è£…jdkå’Œmaven">Ubuntu23.04å®‰è£…jdkå’Œmaven</a></li></ol>

<p><a href="https://rocketmq.apache.org/download/">RocketMQå®˜æ–¹ä¸‹è½½åœ°å€</a>ï¼Œé€‰æ‹© <code>binary</code> ç±»å‹ï¼Œæœ¬æ¬¡ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯ <code>4.9.7</code></p>
<p><a href="https://mirrors.aliyun.com/apache/rocketmq/">RocketMQé˜¿é‡Œäº‘é•œåƒç«™ç‚¹</a></p>
<p>è¿™é‡Œä¸‹è½½çš„æ˜¯ <code>rocketmq-all-4.9.7-bin-release.zip</code> ç„¶åå°†å…¶ä¸Šä¼ åˆ° <code>Ubuntu</code> æœåŠ¡å™¨ä¸­ï¼Œ è¿™é‡Œä¸Šä¼ çš„ä½ç½®æ˜¯ <code>/opt/software</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/software</span><br><span class="line">unzip rocketmq-all-4.9.7-bin-release.zip</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> rocketmq-all-4.9.7-bin-release/</span><br><span class="line"><span class="comment"># å¯åŠ¨ namesrv</span></span><br><span class="line"><span class="built_in">nohup</span> bash bin/mqnamesrv &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨ broker</span></span><br><span class="line"><span class="built_in">nohup</span> bash bin/mqbroker -n localhost:9876 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># namesrv å’Œ broker å¯åŠ¨çš„æ—¥å¿—éƒ½æ˜¯å­˜åœ¨ ~/logs/rocketmq-logs/ ä¸‹é¢</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœæ­¢ broker</span></span><br><span class="line"><span class="built_in">cd</span> /opt/software/rocketmq-all-4.9.7-bin-release/</span><br><span class="line">bash bin/mqshutdown broker</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœæ­¢ namesrv</span></span><br><span class="line"><span class="built_in">cd</span> /opt/software/rocketmq-all-4.9.7-bin-release/</span><br><span class="line">bash bin/mqshutdown namesrv</span><br></pre></td></tr></table></figure>
<h3 id="å¯åŠ¨é”™è¯¯é—®é¢˜æ”¶é›†"><a href="#å¯åŠ¨é”™è¯¯é—®é¢˜æ”¶é›†" class="headerlink" title="å¯åŠ¨é”™è¯¯é—®é¢˜æ”¶é›†"></a>å¯åŠ¨é”™è¯¯é—®é¢˜æ”¶é›†</h3><p><strong>å†…å­˜ä¸è¶³</strong></p>
<p>å¯åŠ¨ <code>namesrv</code> æˆ– <code>broker</code> å‡ºç°</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">os</span>::commit_memory(<span class="number">0</span>x0000000600000000, <span class="number">8589934592</span>, <span class="number">0</span>) failed; error=&#x27;Not enough space&#x27; (errno=<span class="number">12</span>)</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># There is insufficient memory for the Java Runtime Environment to continue.</span></span><br><span class="line"><span class="comment"># Native memory allocation (mmap) failed to map 8589934592 bytes for committing reserved memory.</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ˜¯è¯´æ˜å†…å­˜ä¸è¶³ï¼Œå¯ä»¥è°ƒå° <code>jvm</code> å†…å­˜ï¼Œ æ‰¾åˆ° <code>/opt/software/rocketmq-all-4.9.7-bin-release/bin/runserver.sh</code> å’Œ <code>/opt/software/rocketmq-all-4.9.7-bin-release/bin/runbroker.sh</code>ï¼Œ æ‰¾åˆ°ç±»ä¼¼ <code> -Xms8g -Xmx8g -Xmn4g</code> çš„é…ç½®ï¼Œ ç„¶åå°† <code>8g</code> æ”¹æˆ <code>2g</code> å³å¯</p>
<p><strong>å‚æ•°ä¸å¯¹</strong><br>å¯åŠ¨ <code>broker</code> å‡ºç°</p>
<figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line">Unrecognized VM option &#x27;UseBiasedLocking&#x27;</span><br><span class="line"><span class="keyword">Error: </span>Could not create the Java Virtual Machine.</span><br><span class="line"><span class="keyword">Error: </span>A fatal exception has occurred. Program will exit.</span><br></pre></td></tr></table></figure>
<p>é”™è¯¯ä¸­å·²ç»æœ‰æç¤ºæ— æ³•è¯†åˆ« <code>jvm</code> å‚æ•°  <code>UseBiasedLocking</code>ï¼Œ è¿™ä¸ªåŸºæœ¬ä¸Šéƒ½æ˜¯å’Œä½¿ç”¨çš„ <code>jdk</code> ç‰ˆæœ¬æœ‰å…³ï¼Œ<code>broker</code> å¯åŠ¨è„šæœ¬æ˜¯ <code>bin</code> ç›®å½•ä¸‹çš„ <code>runbroker.sh</code>ï¼Œ å¯ä»¥æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶å°†æ— æ³•è¯†åˆ«çš„å‚æ•°å»æ‰</p>
<h3 id="åŸºäºé…ç½®æ–‡ä»¶å¯åŠ¨-Broker"><a href="#åŸºäºé…ç½®æ–‡ä»¶å¯åŠ¨-Broker" class="headerlink" title="åŸºäºé…ç½®æ–‡ä»¶å¯åŠ¨ Broker"></a>åŸºäºé…ç½®æ–‡ä»¶å¯åŠ¨ Broker</h3><p>å‰é¢è®²è§£çš„æ—¶å€™ä½¿ç”¨ <code>nohup bash bin/mqbroker -n localhost:9876 &amp;</code> çš„æ–¹å¼æ¥å¯åŠ¨ <code>Broker</code>, å¦‚æœæ˜¯ä½¿ç”¨ <code>Broker</code> é›†ç¾¤ï¼Œè¿™ç§å¯åŠ¨æ–¹å¼æ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥å¯ä»¥å¯åŠ¨å‚æ•°æ”¾å…¥é…ç½®æ–‡ä»¶ä¸­ï¼Œ é»˜è®¤åœ¨ <code>RocketMQ</code> å®‰è£…ç›®å½•ä¸‹çš„ <code>conf</code> ç›®å½•ä¸‹ï¼Œ å¯åŠ¨é…ç½®æ–‡ä»¶ä¸º <code>broker.conf</code></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#broker.conf</span></span><br><span class="line"><span class="attr">brokerClusterName</span> = <span class="string">DefaultCluster</span></span><br><span class="line"><span class="attr">brokerName</span> = <span class="string">broker-a</span></span><br><span class="line"><span class="attr">brokerId</span> = <span class="string">0</span></span><br><span class="line"><span class="attr">deleteWhen</span> = <span class="string">04</span></span><br><span class="line"><span class="attr">fileReservedTime</span> = <span class="string">48</span></span><br><span class="line"><span class="attr">brokerRole</span> = <span class="string">ASYNC_MASTER</span></span><br><span class="line"><span class="attr">flushDiskType</span> = <span class="string">ASYNC_FLUSH</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªé»˜è®¤çš„é…ç½®æ–‡ä»¶å¹¶æ²¡æœ‰æŒ‡å®š <code>namesrv</code> çš„åœ°å€ï¼Œæ‰€ä»¥å¯ä»¥ä¿®æ”¹æˆå¦‚ä¸‹å½¢å¼</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;!--</span> <span class="string">é…ç½®namesrvåœ°å€ï¼Œå¯ä»¥æ˜¯å¤šä¸ª --&gt;</span></span><br><span class="line"><span class="attr">namesrvAddr</span>=<span class="string">192.168.100.131:9876; 192.168.100.132:9876</span></span><br><span class="line"><span class="attr">&lt;!--</span> <span class="string">é›†ç¾¤çš„åç§°ï¼ŒåŒä¸€ä¸ªé›†ç¾¤ä¸­çš„å¤šä¸ª brokeré…ç½®æ–‡ä»¶çš„é›†ç¾¤åç§°è¦ç›¸åŒ --&gt;</span></span><br><span class="line"><span class="attr">brokerClusterName</span>=<span class="string">DefaultCluster</span></span><br><span class="line"><span class="attr">&lt;!--</span> <span class="string">å½“å‰ broker çš„åç§° --&gt;</span></span><br><span class="line"><span class="attr">brokerName</span>=<span class="string">broker-a</span></span><br><span class="line"><span class="attr">&lt;!--</span> <span class="string">ä¸€ä¸ªMaster Borkerå¯ä»¥æœ‰å¤šä¸ªSlave,0è¡¨ç¤ºMasterï¼Œå¤§äº0è¡¨ç¤ºä¸åŒSlaveçš„ID --&gt;</span></span><br><span class="line"><span class="attr">brokerId</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">&lt;!--</span> <span class="string">ä¸fileReservedTimeå‚æ•°å‘¼åº”ï¼Œè¡¨æ˜åœ¨å‡ ç‚¹åšæ¶ˆæ¯åˆ é™¤åŠ¨ä½œï¼Œé»˜è®¤å€¼04è¡¨ç¤ºå‡Œæ™¨4ç‚¹ --&gt;</span></span><br><span class="line"><span class="attr">deleteWhen</span>=<span class="string">04</span></span><br><span class="line"><span class="attr">&lt;!--</span> <span class="string">åœ¨ç£ç›˜ä¸Šä¿å­˜æ¶ˆæ¯çš„æ—¶é•¿ï¼Œå•ä½æ˜¯å°æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤è¶…æ—¶çš„æ¶ˆæ¯ --&gt;</span></span><br><span class="line"><span class="attr">fileReservedTime</span>=<span class="string">48</span></span><br><span class="line"><span class="attr">&lt;!--</span> <span class="string">brokerRoleæœ‰3ç§ï¼šSYNC_MASTERã€ASYNC_MASTERã€SLAVEã€‚å…³é”®è¯SYNCå’ŒASYNCè¡¨ç¤ºMasterå’ŒSlave</span></span><br><span class="line"><span class="attr">ä¹‹é—´åŒæ­¥æ¶ˆæ¯çš„æœºåˆ¶ï¼ŒSYNCçš„æ„æ€æ˜¯å½“Slaveå’ŒMasteræ¶ˆæ¯åŒæ­¥å®Œæˆåï¼Œå†è¿”å›å‘é€æˆåŠŸçš„çŠ¶æ€</span> <span class="string">--&gt;</span></span><br><span class="line"><span class="attr">brokerRole</span>=<span class="string">SYNC_MASTER</span></span><br><span class="line"><span class="attr">&lt;!--</span> <span class="string">flushDiskTypeè¡¨ç¤ºåˆ·ç›˜ç­–ç•¥ï¼Œåˆ†ä¸ºSYNC_FLUSHå’ŒASYNC_FLUSHä¸¤ç§ï¼Œ</span></span><br><span class="line"><span class="attr">åˆ†åˆ«ä»£è¡¨åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜ã€‚åŒæ­¥åˆ·ç›˜æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯çœŸæ­£å†™å…¥ç£ç›˜åå†è¿”å›æˆåŠŸçŠ¶æ€ï¼›</span></span><br><span class="line"><span class="attr">å¼‚æ­¥åˆ·ç›˜æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯å†™å…¥page_cacheåå°±è¿”å›æˆåŠŸçŠ¶æ€</span> <span class="string">--&gt;</span></span><br><span class="line"><span class="attr">flushDiskType</span>=<span class="string">ASYNC_FLUSH</span></span><br><span class="line"><span class="attr">&lt;!--</span> <span class="string">Brokerç›‘å¬çš„ç«¯å£å·ï¼Œå¦‚æœä¸€å°æœºå™¨ä¸Šå¯åŠ¨äº†å¤šä¸ªBrokerï¼Œåˆ™è¦è®¾ç½®ä¸åŒçš„ç«¯å£å·ï¼Œé¿å…å†²çª --&gt;</span></span><br><span class="line"><span class="attr">listenPort</span>=<span class="string">10911</span></span><br><span class="line"><span class="attr">&lt;!--</span> <span class="string">å­˜å‚¨æ¶ˆæ¯ä»¥åŠä¸€äº›é…ç½®ä¿¡æ¯çš„æ ¹ç›®å½• --&gt;</span></span><br><span class="line"><span class="attr">storePathRootDir</span>=<span class="string">/home/rocketmq/store-a</span></span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨å¯åŠ¨å¤šä¸ª <code>namesrv</code> ä¹‹åå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼æ¥å¯åŠ¨ <code>broker</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/software/rocketmq-all-4.9.7-bin-release/</span><br><span class="line"><span class="built_in">nohup</span> bash ./bin/mqbroker -c  ./conf/broker.conf &amp;</span><br></pre></td></tr></table></figure>

<h2 id="ä½¿ç”¨è„šæœ¬å¿«é€Ÿå¯åŠ¨RocketMQ-å•æœºç‰ˆæœ¬"><a href="#ä½¿ç”¨è„šæœ¬å¿«é€Ÿå¯åŠ¨RocketMQ-å•æœºç‰ˆæœ¬" class="headerlink" title="ä½¿ç”¨è„šæœ¬å¿«é€Ÿå¯åŠ¨RocketMQ å•æœºç‰ˆæœ¬"></a>ä½¿ç”¨è„šæœ¬å¿«é€Ÿå¯åŠ¨RocketMQ å•æœºç‰ˆæœ¬</h2><p>å‰é¢å·²ç»å†™äº†æ€ä¹ˆé€šè¿‡å‘½ä»¤æ¥å¯åŠ¨&#x2F;åœæ­¢ <code>RocketMQ</code>ï¼Œ ä½†æ˜¯æ¯æ¬¡éœ€è¦è¿›å…¥ç‰¹å®šçš„ç›®å½•ï¼Œè€Œä¸”å¯åŠ¨å’Œåœæ­¢çš„å‘½ä»¤ä¹Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥å¯ä»¥å†™ä¸€ä¸ªè„šæœ¬æ¥ç®€åŒ–æ“ä½œï¼ˆå½“å‰ <code>RocketMQ</code> æ ¹ç›®å½•æ˜¯ <code>/opt/software/rocketmq-all-4.9.7-bin-release/</code> ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/software/rocketmq-all-4.9.7-bin-release/</span><br><span class="line">vim rocketmq.sh</span><br></pre></td></tr></table></figure>
<p><code>rocketmq.sh</code> è„šæœ¬å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">ROCKETMQ_HOME=/opt/software/rocketmq-all-4.9.7-bin-release</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;start&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">nohup</span> sh <span class="variable">$ROCKETMQ_HOME</span>/bin/mqnamesrv &gt;  /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">  <span class="built_in">sleep</span> 3</span><br><span class="line">  <span class="built_in">nohup</span> sh <span class="variable">$ROCKETMQ_HOME</span>/bin/mqbroker -n localhost:9876 &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;RocketMQ nameserver and broker started&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;stop&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  sh <span class="variable">$ROCKETMQ_HOME</span>/bin/mqshutdown broker</span><br><span class="line">  <span class="built_in">sleep</span> 3</span><br><span class="line">  sh <span class="variable">$ROCKETMQ_HOME</span>/bin/mqshutdown namesrv</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;RocketMQ broker and nameserver stopped&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> start|stop&quot;</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åå°†è„šæœ¬çš„æƒé™è®¾ç½®ä¸ºå¯æ‰§è¡Œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x rocketmq.sh</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºè½¯è¿æ¥ï¼Œåœ¨ä»»æ„ä½ç½®éƒ½å¯ä»¥æ‰§è¡Œè¿™ä¸ªè„šæœ¬</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -s /opt/software/rocketmq-all-4.9.7-bin-release/rocketmq.sh /usr/local/bin/rocketmq.sh</span><br><span class="line"><span class="comment"># æ¥ä¸‹æ¥çš„å‘½ä»¤æ˜¯å¯ä»¥åœ¨ä»»æ„ä½ç½®æ‰§è¡Œ</span></span><br><span class="line"><span class="comment"># å¯åŠ¨ rocketmq</span></span><br><span class="line">rocketmq.sh start</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœæ­¢ rocketmq</span></span><br><span class="line">rocketmq.sh stop</span><br></pre></td></tr></table></figure>

<h2 id="å®‰è£…-RocketMQ-dashboardï¼ˆrocketmq-consoleï¼‰"><a href="#å®‰è£…-RocketMQ-dashboardï¼ˆrocketmq-consoleï¼‰" class="headerlink" title="å®‰è£… RocketMQ dashboardï¼ˆrocketmq-consoleï¼‰"></a>å®‰è£… RocketMQ dashboardï¼ˆrocketmq-consoleï¼‰</h2><p>ä»¥å‰ <code>RokcetMQ</code> ç•Œé¢ç›‘æ§æœåŠ¡å«åš <code>rocketmq-console</code>ï¼Œ ç°åœ¨å·²ç»æ”¹æˆ <code>rocketmq-dashboard</code>ï¼Œ æ‰€ä»¥éœ€è¦å®‰è£… <code>rocketmq-dashboard</code></p>
<p><a href="https://rocketmq.apache.org/zh/docs/4.x/deployment/03Dashboard">rocketmq-dashboardå®˜æ–¹å®‰è£…è¯´æ˜</a></p>
<p>ä½¿ç”¨ <code>docker</code> å®‰è£…æ›´ç®€å•ï¼Œæ‰€ä»¥å°±ä½¿ç”¨ <code>docker</code> å®‰è£…çš„æ–¹å¼</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull apacherocketmq/rocketmq-dashboard:latest</span><br><span class="line">docker run -d --name rocketmq-dashboard -e <span class="string">&quot;JAVA_OPTS=-Drocketmq.namesrv.addr=192.168.208.130:9876&quot;</span> -p 8080:8080 -t apacherocketmq/rocketmq-dashboard:latest</span><br></pre></td></tr></table></figure>
<p>å› ä¸º <code>RocketMQ</code> æ˜¯å®‰è£…åœ¨ <code>Ubuntu</code> è™šæ‹Ÿæœºä¸­ï¼Œä½†æ˜¯è®¿é—®æ˜¯åœ¨ <code>Window</code> ä¸­ï¼Œæ‰€ä»¥è¿™é‡Œ <code>rocketmq.namesrv.addr</code> å¡«å†™çš„å°±æ˜¯è™šæ‹Ÿæœºçš„ <code>ip</code></p>
<p>ç„¶ååœ¨ <code>Window</code> ä¸­è®¿é—® <code>http://192.168.208.130:8080</code> å³å¯çœ‹åˆ° <code>RocketMQ</code> çš„ç›‘æ§é¡µé¢</p>
<h3 id="ä¿®æ”¹è„šæœ¬ä¸€æ¬¡æ€§å¯åŠ¨-RocketMQ-å’Œ-Dashboard"><a href="#ä¿®æ”¹è„šæœ¬ä¸€æ¬¡æ€§å¯åŠ¨-RocketMQ-å’Œ-Dashboard" class="headerlink" title="ä¿®æ”¹è„šæœ¬ä¸€æ¬¡æ€§å¯åŠ¨ RocketMQ å’Œ Dashboard"></a>ä¿®æ”¹è„šæœ¬ä¸€æ¬¡æ€§å¯åŠ¨ <code>RocketMQ</code> å’Œ <code>Dashboard</code></h3><p>å‰ææ¡ä»¶æ˜¯å·²ç»ä½¿ç”¨ä¸Šé¢ <code>docker</code> çš„æ–¹å¼å¯åŠ¨è¿‡ä¸€æ¬¡ <code>rocketq-dashboard</code>, è¿™æ ·å¯¹åº”å®¹å™¨çš„åç§°å°±æ˜¯ <code>rocketmq-dashboard</code>ï¼Œ ä¹Ÿå°±å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è„šæœ¬ä¸€æ¬¡æ€§å¯åŠ¨å’Œå…³é—­</p>
<p><code>rocketmq.sh</code> è„šæœ¬å†…å®¹ä¿®æ”¹æˆå¦‚ä¸‹å½¢å¼</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">ROCKETMQ_HOME=/opt/software/rocketmq-all-4.9.7-bin-release</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;start&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">nohup</span> sh <span class="variable">$ROCKETMQ_HOME</span>/bin/mqnamesrv &gt;  /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">  ecgi <span class="string">&quot;RocketMQ namesrv started&quot;</span></span><br><span class="line">  <span class="built_in">sleep</span> 3</span><br><span class="line">  <span class="built_in">nohup</span> sh <span class="variable">$ROCKETMQ_HOME</span>/bin/mqbroker -n localhost:9876 &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;RocketMQ broker started&quot;</span></span><br><span class="line">  <span class="built_in">sleep</span> 3</span><br><span class="line">  docker start rocketmq-dashboard</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;rocketmq-dashboard started&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;stop&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  sh <span class="variable">$ROCKETMQ_HOME</span>/bin/mqshutdown broker</span><br><span class="line">  <span class="built_in">sleep</span> 3</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;rocketmq broker stopped&quot;</span></span><br><span class="line">  sh <span class="variable">$ROCKETMQ_HOME</span>/bin/mqshutdown namesrv</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;RocketMQ nameserver stopped&quot;</span></span><br><span class="line">  <span class="built_in">sleep</span> 2</span><br><span class="line">  docker stop rocketmq-dashboard</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;rocketmq-dashboard stopped&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> start|stop&quot;</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ä½¿ç”¨ <code>rocketmq.sh start</code> å¯åŠ¨ <code>Namesrv</code> å’Œ <code>Broker</code> å’Œ <code>Dashboard</code></li>
<li>ä½¿ç”¨ <code>rocketmq.sh stop</code> åœæ­¢ <code>Namesrv</code> å’Œ <code>Broker</code> å’Œ <code>Dashboard</code></li>
</ul>
<h2 id="ä¸‹è½½-RocketMQ-æºç æµ‹è¯•"><a href="#ä¸‹è½½-RocketMQ-æºç æµ‹è¯•" class="headerlink" title="ä¸‹è½½ RocketMQ æºç æµ‹è¯•"></a>ä¸‹è½½ RocketMQ æºç æµ‹è¯•</h2><p>å‰é¢ä¸‹è½½å’Œå®‰è£…çš„éƒ½æ˜¯ <code>binary</code> ç±»å‹ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ <code>RocketMQ</code> çš„æœåŠ¡ç«¯ç¨‹åº( <code>Namesrv</code> å’Œ <code>Broker</code> )ï¼Œ æ¥ä¸‹æ¥ä½¿ç”¨æºç æ˜¯ä½œä¸º <code>Producer</code> å’Œ <code>Consumer</code> è¿›è¡Œæ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶çš„</p>
<blockquote>
<p>RocketMQ æºç ä¹Ÿæ˜¯å¯ä»¥åŸæ¥å¯åŠ¨ Namesrv å’Œ Broker çš„ï¼Œä¸è¿‡å¦‚æœä¸æ˜¯è¦çœ‹å¯¹åº”çš„æºç ï¼Œè¿˜æ˜¯ä½¿ç”¨ Binary æ–¹å¼å¯åŠ¨ Namesrv å’Œ broker æ¯”è¾ƒæ–¹ä¾¿</p>
</blockquote>
<p><a href="https://rocketmq.apache.org/download/">RocketMQå®˜æ–¹ä¸‹è½½åœ°å€</a>ï¼Œé€‰æ‹© <code>Source</code> ç±»å‹ï¼Œæœ¬æ¬¡ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯ <code>4.9.7</code>ï¼Œ è§£å‹åç›´æ¥ç”¨ <code>idea</code> å¯¼å…¥å³å¯</p>
<h3 id="å‘é€æ¶ˆæ¯æµ‹è¯•"><a href="#å‘é€æ¶ˆæ¯æµ‹è¯•" class="headerlink" title="å‘é€æ¶ˆæ¯æµ‹è¯•"></a>å‘é€æ¶ˆæ¯æµ‹è¯•</h3><ul>
<li>æ‰“å¼€ <code>rocket</code> æºç åæ‰¾åˆ° <code>example</code> å­é¡¹ç›®ï¼Œåœ¨è¯¥å­é¡¹ç›®ä¸‹æ‰¾åˆ° <code>org.apache.rocketmq.example.simple.Producer</code> ç±»</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException, InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;ProducerGroupName&quot;</span>);</span><br><span class="line">        <span class="comment">// è¿™ä¸€è¡Œæ˜¯è‡ªå·±æ·»åŠ çš„ï¼ŒæŒ‡å®š Namesrv çš„åœ°å€</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">&quot;192.168.208.130:9876&quot;</span>);</span><br><span class="line">        producer.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">128</span>; i++)</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TopicTest&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;TagA&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;OrderID188&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Hello world&quot;</span>.getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                    <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.send(msg);</span><br><span class="line">                    System.out.printf(<span class="string">&quot;%s%n&quot;</span>, sendResult);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›´æ¥å¯åŠ¨å°±å¯ä»¥å‘é€æ¶ˆæ¯åˆ° <code>RocketMQ</code> ä¸­ï¼Œ å¯ä»¥æ‰“å¼€ <code>RocketMQ dashboard</code> è¿›è¡ŒæŸ¥çœ‹</p>
<h3 id="æ¥æ”¶æ¶ˆæ¯æµ‹è¯•"><a href="#æ¥æ”¶æ¶ˆæ¯æµ‹è¯•" class="headerlink" title="æ¥æ”¶æ¶ˆæ¯æµ‹è¯•"></a>æ¥æ”¶æ¶ˆæ¯æµ‹è¯•</h3><ul>
<li>æ‰“å¼€ <code>rocket</code> æºç åæ‰¾åˆ° <code>example</code> å­é¡¹ç›®ï¼Œåœ¨è¯¥å­é¡¹ç›®ä¸‹æ‰¾åˆ° <code>org.apache.rocketmq.example.simple.PullConsumer</code> ç±»</li>
</ul>
<p>ä¸»è¦æ˜¯ä¿®æ”¹è¿æ¥ <code>Namesrv</code> çš„åœ°å€å’Œå¢åŠ æ¶ˆæ¯æ¥æ”¶åçš„æ‰“å°ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PullConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">DefaultMQPullConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPullConsumer</span>(<span class="string">&quot;please_rename_unique_group_name_5&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¿®æ”¹ namesrv çš„åœ°å€</span></span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">&quot;192.168.208.130:9876&quot;</span>);</span><br><span class="line">        Set&lt;String&gt; topics = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//You would better to register topics,It will use in rebalance when starting</span></span><br><span class="line">        topics.add(<span class="string">&quot;TopicTest&quot;</span>);</span><br><span class="line">        consumer.setRegisterTopics(topics);</span><br><span class="line">        consumer.start();</span><br><span class="line"></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executors</span> <span class="operator">=</span> Executors.newFixedThreadPool(topics.size(), <span class="keyword">new</span> <span class="title class_">ThreadFactory</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, <span class="string">&quot;PullConsumerThread&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">for</span> (String topic : consumer.getRegisterTopics()) &#123;</span><br><span class="line"></span><br><span class="line">            executors.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">(List&lt;MessageExt&gt; msgs)</span> &#123;</span><br><span class="line">                    <span class="comment">// æ‰“å°æ¥æ”¶åˆ°çš„æ¶ˆæ¯</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;æ¥æ”¶åˆ°æ¶ˆæ¯&quot;</span> + msgs.toString());</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Set&lt;MessageQueue&gt; messageQueues = consumer.fetchMessageQueuesInBalance(topic);</span><br><span class="line">                            <span class="keyword">if</span> (messageQueues == <span class="literal">null</span> || messageQueues.isEmpty()) &#123;</span><br><span class="line">                                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="type">PullResult</span> <span class="variable">pullResult</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                            <span class="keyword">for</span> (MessageQueue messageQueue : messageQueues) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> <span class="built_in">this</span>.consumeFromOffset(messageQueue);</span><br><span class="line">                                    pullResult = consumer.pull(messageQueue, <span class="string">&quot;*&quot;</span>, offset, <span class="number">32</span>);</span><br><span class="line">                                    <span class="keyword">switch</span> (pullResult.getPullStatus()) &#123;</span><br><span class="line">                                        <span class="keyword">case</span> FOUND:</span><br><span class="line">                                            List&lt;MessageExt&gt; msgs = pullResult.getMsgFoundList();</span><br><span class="line"></span><br><span class="line">                                            <span class="keyword">if</span> (msgs != <span class="literal">null</span> &amp;&amp; !msgs.isEmpty()) &#123;</span><br><span class="line">                                                <span class="built_in">this</span>.doSomething(msgs);</span><br><span class="line">                                                <span class="comment">//update offset to broker</span></span><br><span class="line">                                                consumer.updateConsumeOffset(messageQueue, pullResult.getNextBeginOffset());</span><br><span class="line">                                                <span class="comment">//print pull tps</span></span><br><span class="line">                                                <span class="built_in">this</span>.incPullTPS(topic, pullResult.getMsgFoundList().size());</span><br><span class="line">                                            &#125;</span><br><span class="line">                                            <span class="keyword">break</span>;</span><br><span class="line">                                        <span class="keyword">case</span> OFFSET_ILLEGAL:</span><br><span class="line">                                            consumer.updateConsumeOffset(messageQueue, pullResult.getNextBeginOffset());</span><br><span class="line">                                            <span class="keyword">break</span>;</span><br><span class="line">                                        <span class="keyword">case</span> NO_NEW_MSG:</span><br><span class="line">                                            Thread.sleep(<span class="number">1</span>);</span><br><span class="line">                                            consumer.updateConsumeOffset(messageQueue, pullResult.getNextBeginOffset());</span><br><span class="line">                                            <span class="keyword">break</span>;</span><br><span class="line">                                        <span class="keyword">case</span> NO_MATCHED_MSG:</span><br><span class="line">                                            consumer.updateConsumeOffset(messageQueue, pullResult.getNextBeginOffset());</span><br><span class="line">                                            <span class="keyword">break</span>;</span><br><span class="line">                                        <span class="keyword">default</span>:</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (RemotingException e) &#123;</span><br><span class="line">                                    e.printStackTrace();</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (MQBrokerException e) &#123;</span><br><span class="line">                                    e.printStackTrace();</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                                    e.printStackTrace();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</span><br><span class="line">                            <span class="comment">//reblance error</span></span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">consumeFromOffset</span><span class="params">(MessageQueue messageQueue)</span> <span class="keyword">throws</span> MQClientException &#123;</span><br><span class="line">                    <span class="comment">//-1 when started</span></span><br><span class="line">                    <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> consumer.getOffsetStore().readOffset(messageQueue, ReadOffsetType.READ_FROM_MEMORY);</span><br><span class="line">                    <span class="keyword">if</span> (offset &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">//query from broker</span></span><br><span class="line">                        offset = consumer.getOffsetStore().readOffset(messageQueue, ReadOffsetType.READ_FROM_STORE);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (offset &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">//first time start from last offset</span></span><br><span class="line">                        offset = consumer.maxOffset(messageQueue);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//make sure</span></span><br><span class="line">                    <span class="keyword">if</span> (offset &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        offset = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> offset;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">incPullTPS</span><span class="params">(String topic, <span class="type">int</span> pullSize)</span> &#123;</span><br><span class="line">                    consumer.getDefaultMQPullConsumerImpl().getRebalanceImpl().getmQClientFactory()</span><br><span class="line">                            .getConsumerStatsManager().incPullTPS(consumer.getConsumerGroup(), topic, pullSize);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        executors.shutdown();</span></span><br><span class="line"><span class="comment">//        consumer.shutdown();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å®‰è£…-RocketMQ5-ç‰ˆæœ¬"><a href="#å®‰è£…-RocketMQ5-ç‰ˆæœ¬" class="headerlink" title="å®‰è£… RocketMQ5 ç‰ˆæœ¬"></a>å®‰è£… RocketMQ5 ç‰ˆæœ¬</h2><p>å’Œ <code>RocketMQ</code> æµç¨‹ä¸€æ ·ï¼Œå½“å¯åŠ¨ <code>broker</code> çš„æ—¶å€™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">java<span class="selector-class">.lang</span><span class="selector-class">.IllegalAccessError</span>: class org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.common</span><span class="selector-class">.UtilAll</span> (<span class="keyword">in</span> unnamed module @<span class="number">0</span>x74582ff6) cannot access class sun<span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.DirectBuffer</span> (<span class="keyword">in</span> module java.base) because module java<span class="selector-class">.base</span> does not export sun<span class="selector-class">.nio</span><span class="selector-class">.ch</span> to unnamed module @<span class="number">0</span>x74582ff6</span><br><span class="line">        at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.common</span><span class="selector-class">.UtilAll</span><span class="selector-class">.viewed</span>(UtilAll<span class="selector-class">.java</span>:<span class="number">741</span>)</span><br><span class="line">        at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.common</span><span class="selector-class">.UtilAll</span><span class="selector-class">.cleanBuffer</span>(UtilAll<span class="selector-class">.java</span>:<span class="number">705</span>)</span><br><span class="line">        at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.store</span><span class="selector-class">.logfile</span><span class="selector-class">.DefaultMappedFile</span><span class="selector-class">.cleanup</span>(DefaultMappedFile<span class="selector-class">.java</span>:<span class="number">540</span>)</span><br><span class="line">        at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.store</span><span class="selector-class">.ReferenceResource</span><span class="selector-class">.release</span>(ReferenceResource<span class="selector-class">.java</span>:<span class="number">63</span>)</span><br><span class="line">        at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.store</span><span class="selector-class">.ReferenceResource</span><span class="selector-class">.shutdown</span>(ReferenceResource<span class="selector-class">.java</span>:<span class="number">47</span>)</span><br><span class="line">        at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.store</span><span class="selector-class">.logfile</span><span class="selector-class">.DefaultMappedFile</span><span class="selector-class">.destroy</span>(DefaultMappedFile<span class="selector-class">.java</span>:<span class="number">551</span>)</span><br><span class="line">        at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.store</span><span class="selector-class">.index</span><span class="selector-class">.IndexFile</span><span class="selector-class">.destroy</span>(IndexFile<span class="selector-class">.java</span>:<span class="number">110</span>)</span><br><span class="line">        at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.store</span><span class="selector-class">.index</span><span class="selector-class">.IndexService</span><span class="selector-class">.load</span>(IndexService<span class="selector-class">.java</span>:<span class="number">72</span>)</span><br><span class="line">        at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.store</span><span class="selector-class">.DefaultMessageStore</span><span class="selector-class">.load</span>(DefaultMessageStore<span class="selector-class">.java</span>:<span class="number">341</span>)</span><br><span class="line">        at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.broker</span><span class="selector-class">.BrokerController</span><span class="selector-class">.recoverAndInitService</span>(BrokerController<span class="selector-class">.java</span>:<span class="number">806</span>)</span><br><span class="line">        at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.broker</span><span class="selector-class">.BrokerController</span><span class="selector-class">.initialize</span>(BrokerController<span class="selector-class">.java</span>:<span class="number">792</span>)</span><br><span class="line">        at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.broker</span><span class="selector-class">.BrokerStartup</span><span class="selector-class">.createBrokerController</span>(BrokerStartup<span class="selector-class">.java</span>:<span class="number">240</span>)</span><br><span class="line">        at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.broker</span><span class="selector-class">.BrokerStartup</span><span class="selector-class">.main</span>(BrokerStartup<span class="selector-class">.java</span>:<span class="number">50</span>)</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ˜¯å’Œä½¿ç”¨çš„ <code>jdk</code> ç‰ˆæœ¬é«˜äº 8 çš„åŸå› å¯¼è‡´ï¼Œè¿™é‡Œä½¿ç”¨çš„ <code>jdk</code> ç‰ˆæœ¬æ˜¯ 17</p>
<p>è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼šæ‰“å¼€ <code>bin</code> ä¸‹é¢çš„ <code>runbroker.sh</code></p>
<p>åŸæ¥çš„ <code>runbroker.sh</code> æ˜¯è¿™æ ·</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$RMQ_NUMA_NODE</span>&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">                numactl --interleave=all <span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span> <span class="variable">$@</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                numactl --cpunodebind=<span class="variable">$RMQ_NUMA_NODE</span> --membind=<span class="variable">$RMQ_NUMA_NODE</span> <span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span> <span class="variable">$@</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        <span class="string">&quot;<span class="variable">$JAVA</span>&quot;</span> <span class="variable">$&#123;JAVA_OPT&#125;</span>   <span class="variable">$@</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹åå˜æˆå¦‚ä¸‹å½¢å¼ï¼Œä¸»è¦æ˜¯åœ¨å¯åŠ¨å‘½ä»¤ä¸­å¢åŠ  <code>--add-exports=java.base/sun.nio.ch=ALL-UNNAMED</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$RMQ_NUMA_NODE</span>&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">                numactl --interleave=all <span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span> --add-exports=java.base/sun.nio.ch=ALL-UNNAMED <span class="variable">$@</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                numactl --cpunodebind=<span class="variable">$RMQ_NUMA_NODE</span> --membind=<span class="variable">$RMQ_NUMA_NODE</span> <span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span> --add-exports=java.base/sun.nio.ch=ALL-UNNAMED <span class="variable">$@</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        <span class="string">&quot;<span class="variable">$JAVA</span>&quot;</span> <span class="variable">$&#123;JAVA_OPT&#125;</span> --add-exports=java.base/sun.nio.ch=ALL-UNNAMED  <span class="variable">$@</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>


<h2 id="é€šè¿‡RocketMQ5æºç å¯åŠ¨å•æœºç‰ˆ-Nameserver-å’Œ-Broker"><a href="#é€šè¿‡RocketMQ5æºç å¯åŠ¨å•æœºç‰ˆ-Nameserver-å’Œ-Broker" class="headerlink" title="é€šè¿‡RocketMQ5æºç å¯åŠ¨å•æœºç‰ˆ Nameserver å’Œ Broker"></a>é€šè¿‡RocketMQ5æºç å¯åŠ¨å•æœºç‰ˆ Nameserver å’Œ Broker</h2><p>ä½¿ç”¨çš„ç³»ç»Ÿæ˜¯ <code>win11</code><br>æ‰¾ä¸€ä¸ªä½ç½®åˆ›å»ºä¸€ä¸ªç›®å½•ä½œä¸º <code>ROCKETMQ_HOME</code>, æ¯”å¦‚åˆ›å»ºç›®å½• <code>D:\data\rocketmq</code>ï¼Œ ç°åœ¨ <code>ROCKETMQ_HOME=D:\data\rocketmq</code><br>åœ¨ <code>ROCKETMQ_HOME</code> ç›®å½•ä¸‹åˆ›å»º <code>conf</code> å’Œ <code>store</code> ç›®å½•ï¼Œ åœ¨ <code>conf</code> ç›®å½•ä¸‹åˆ›å»º <code>broker.conf</code> æ–‡ä»¶ï¼Œç°åœ¨ <code>ROCKETMQ_HOME</code> ç›®å½•ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:\data\rocketmq</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ conf</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ broker.conf</span><br><span class="line">â””â”€â”€ store</span><br></pre></td></tr></table></figure>
<p><code>broker.conf</code> æ–‡ä»¶å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># é›†ç¾¤åç§°</span><br><span class="line">brokerClusterName = DefaultCluster</span><br><span class="line"># broker åç§°</span><br><span class="line">brokerName = broker-a</span><br><span class="line"># brokerId=0è¡¨ç¤ºmasterï¼Œå…¶ä»–å€¼è¡¨ç¤º slave</span><br><span class="line">brokerId = 0</span><br><span class="line"># ä¸fileReservedTimeå‚æ•°å‘¼åº”ï¼Œè¡¨æ˜åœ¨å‡ ç‚¹åšæ¶ˆæ¯åˆ é™¤åŠ¨ä½œï¼Œé»˜è®¤å€¼04è¡¨ç¤ºå‡Œæ™¨4ç‚¹</span><br><span class="line">deleteWhen = 04</span><br><span class="line"># åœ¨ç£ç›˜ä¸Šä¿å­˜æ¶ˆæ¯çš„æ—¶é•¿ï¼Œå•ä½æ˜¯å°æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤è¶…æ—¶çš„æ¶ˆæ¯</span><br><span class="line">fileReservedTime = 48</span><br><span class="line"># brokerRoleæœ‰3ç§ï¼šSYNC_MASTERã€ASYNC_MASTERã€SLAVEã€‚å…³é”®è¯SYNCå’ŒASYNCè¡¨ç¤ºMasterå’ŒSlave</span><br><span class="line"># ä¹‹é—´åŒæ­¥æ¶ˆæ¯çš„æœºåˆ¶ï¼ŒSYNCçš„æ„æ€æ˜¯å½“Slaveå’ŒMasteræ¶ˆæ¯åŒæ­¥å®Œæˆåï¼Œå†è¿”å›å‘é€æˆåŠŸçš„çŠ¶æ€</span><br><span class="line">brokerRole = ASYNC_MASTER</span><br><span class="line"># flushDiskTypeè¡¨ç¤ºåˆ·ç›˜ç­–ç•¥ï¼Œåˆ†ä¸ºSYNC_FLUSHå’ŒASYNC_FLUSHä¸¤ç§ï¼Œ</span><br><span class="line"># åˆ†åˆ«ä»£è¡¨åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜ã€‚åŒæ­¥åˆ·ç›˜æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯çœŸæ­£å†™å…¥ç£ç›˜åå†è¿”å›æˆåŠŸçŠ¶æ€ï¼›</span><br><span class="line"># å¼‚æ­¥åˆ·ç›˜æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯å†™å…¥page_cacheåå°±è¿”å›æˆåŠŸçŠ¶æ€</span><br><span class="line">flushDiskType = ASYNC_FLUSH</span><br><span class="line"></span><br><span class="line">namesrvAddr = 127.0.0.1:9876</span><br><span class="line">storePathRootDir = D:\\data\\rocketmq\\store</span><br><span class="line">storePathCommitLog = D:\\data\\rocketmq\\store\\commitlog</span><br><span class="line">storePathConsumeQueue = D:\\data\\rocketmq\\store\\consumequeue</span><br><span class="line">storePathIndex = D:\\data\\rocketmq\\store\\index</span><br><span class="line">storeCheckpoint = D:\\data\\rocketmq\\store\\checkpoint</span><br></pre></td></tr></table></figure>

<h3 id="æºç å¯åŠ¨-nameserver"><a href="#æºç å¯åŠ¨-nameserver" class="headerlink" title="æºç å¯åŠ¨ nameserver"></a>æºç å¯åŠ¨ nameserver</h3><p>æœ€ç»ˆæ˜¯è¦æ‰¾åˆ° <code>rocketmq-namesrv</code> å­æ¨¡å—ä¸‹çš„ <code>org.apache.rocketmq.namesrv.NamesrvStartup</code>ï¼Œ æ‰§è¡Œè¿™ä¸ªç±»çš„ <code>main</code> æ–¹æ³•ï¼Œä¸è¿‡è¿˜éœ€è¦ä¸€äº›é…ç½®<br>åœ¨ <code>idea</code> ä¸­é…ç½® <code>NamesrvStartup</code> å¯åŠ¨ç±»çš„ <code>ROCKETMQ_HOME</code> ç¯å¢ƒå˜é‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º  <code>ROCKETMQ_HOME=D:\\data\\rocketmq</code><br><img src="https://s2.loli.net/2023/12/20/8NsrKgcuALHDBbf.png" alt="Namesrvé…ç½®"></p>
<h3 id="æºç å¯åŠ¨-Broker"><a href="#æºç å¯åŠ¨-Broker" class="headerlink" title="æºç å¯åŠ¨ Broker"></a>æºç å¯åŠ¨ Broker</h3><p>æœ€ç»ˆæ˜¯è¦æ‰¾åˆ° <code>rocketmq-broker</code> å­æ¨¡å—ä¸‹çš„ <code>org.apache.rocketmq.broker.BrokerStartup</code> ç±»çš„ <code>main</code> æ–¹æ³•ï¼ŒåŒæ ·ä¹Ÿæ˜¯éœ€è¦è®¾ç½®ä¸€äº›å‚æ•°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://s2.loli.net/2023/12/20/G3Ql5mBXafALdIt.png" alt="Brokeré…ç½®"></p>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQæ•´åˆSpringBoot3</title>
    <url>/2023/1a12a33976fc/index.html</url>
    <content><![CDATA[<p>SpringBootç‰ˆæœ¬ï¼š 3.2.0</p>
<p><a href="https://github.com/apache/rocketmq-spring/wiki">å®˜æ–¹æ–‡æ¡£</a></p>
<blockquote>
<p>SpringBoot3 ç‰ˆæœ¬ç›´æ¥ä½¿ç”¨ç¤ºä¾‹ä¼šæç¤º RocketMQTemplate æ³¨å…¥å¤±è´¥ï¼Œè§£å†³æ–¹å¼åœ¨æ–‡æœ«</p>
</blockquote>
<p>ä½¿ç”¨ <code>idea</code> åˆ›å»º <code>SpringBoot</code> é¡¹ç›®, é¡¹ç›®åç§°æ˜¯ <code>rocket-spring-boot</code></p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">rocket-spring-<span class="keyword">boot</span></span><br><span class="line"><span class="keyword"></span>â”œâ”€src</span><br><span class="line">â”‚  â”œâ”€main</span><br><span class="line">â”‚  â”‚  â”œâ”€<span class="keyword">java</span></span><br><span class="line"><span class="keyword"></span>â”‚  â”‚  â”‚  â””â”€<span class="keyword">org</span></span><br><span class="line"><span class="keyword"></span>â”‚  â”‚  â”‚      â””â”€example</span><br><span class="line">â”‚  â”‚  â”‚          â””â”€rocketmqspringboot</span><br><span class="line">â”‚  â”‚  â”‚              â””â”€RocketmqSpringBootApplication.<span class="keyword">java</span></span><br><span class="line"><span class="keyword"></span>â”‚  â”‚  â””â”€resources</span><br><span class="line">â”‚  â”‚      â””â”€application.properties</span><br><span class="line">â””â”€pom.xml</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦æœ‰ä¸‰ä¸ªæ–‡ä»¶</p>
<ul>
<li><code>pom.xml</code> ä¾èµ–æ–‡ä»¶</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-spring-boot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>rocketmq-spring-boot<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>rocketmq-spring-boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>17<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- è¿™é‡Œæ·»åŠ  rocketmq-spring-boot-starter ä¾èµ– --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>RocketmqSpringBootApplication.java</code>, é»˜è®¤åªæœ‰ <code>main</code> æ–¹æ³•ï¼Œè¿™é‡ŒæŒ‰ç…§å®˜æ–¹æ–‡æ¡£ç¤ºä¾‹ï¼Œå®ç° <code>CommandLineRunner</code> æ¥å£ï¼Œåœ¨é¡¹ç›®å¯åŠ¨ä¹‹åå°±è¿›è¡Œæ¶ˆæ¯çš„å‘é€</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RocketmqSpringBootApplication</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RocketMQTemplate rocketMQTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(RocketmqSpringBootApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//send message synchronously</span></span><br><span class="line">        rocketMQTemplate.convertAndSend(<span class="string">&quot;test-topic-1&quot;</span>, <span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">        <span class="comment">//send spring message</span></span><br><span class="line">        rocketMQTemplate.send(<span class="string">&quot;test-topic-1&quot;</span>, MessageBuilder.withPayload(<span class="string">&quot;Hello, World! I&#x27;m from spring message&quot;</span>).build());</span><br><span class="line">        <span class="comment">//send messgae asynchronously</span></span><br><span class="line">        rocketMQTemplate.asyncSend(<span class="string">&quot;test-topic-2&quot;</span>, <span class="keyword">new</span> <span class="title class_">OrderPaidEvent</span>(<span class="string">&quot;T_001&quot;</span>, <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;88.00&quot;</span>)), <span class="keyword">new</span> <span class="title class_">SendCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(SendResult var1)</span> &#123;</span><br><span class="line">                System.out.printf(<span class="string">&quot;async onSucess SendResult=%s %n&quot;</span>, var1);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onException</span><span class="params">(Throwable var1)</span> &#123;</span><br><span class="line">                System.out.printf(<span class="string">&quot;async onException Throwable=%s %n&quot;</span>, var1);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//Send messages orderly</span></span><br><span class="line">        rocketMQTemplate.syncSendOrderly(<span class="string">&quot;orderly_topic&quot;</span>, MessageBuilder.withPayload(<span class="string">&quot;Hello, World&quot;</span>).build(),<span class="string">&quot;hashkey&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//rocketMQTemplate.destroy(); // notes:  once rocketMQTemplate be destroyed, you can not send any message again with this rocketMQTemplate</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderPaidEvent</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String orderId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> BigDecimal paidMoney;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ·»åŠ  <code>application.properties</code> é…ç½®æ–‡ä»¶</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">rocketmq.name-server</span>=<span class="string">192.168.119.129:9876</span></span><br><span class="line"><span class="attr">rocketmq.producer.group</span>=<span class="string">my-group</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="è§£å†³-SpringBoot3-ä¸­-RocketMQTemplate-æ³¨å…¥å¤±è´¥é—®é¢˜"><a href="#è§£å†³-SpringBoot3-ä¸­-RocketMQTemplate-æ³¨å…¥å¤±è´¥é—®é¢˜" class="headerlink" title="è§£å†³ SpringBoot3 ä¸­ RocketMQTemplate æ³¨å…¥å¤±è´¥é—®é¢˜"></a>è§£å†³ SpringBoot3 ä¸­ RocketMQTemplate æ³¨å…¥å¤±è´¥é—®é¢˜</h2><p><code>SpringBoot3</code> è‡ªåŠ¨è£…é…æ–‡ä»¶ä¸æ˜¯ä½¿ç”¨ <code>spring.factories</code> æ–‡ä»¶ï¼Œè€Œæ˜¯éœ€è¦åœ¨ <code>META-INF/spring</code> ç›®å½•ä¸‹åˆ›å»º <code>org.springframework.boot.autoconfigure.AutoConfiguration.imports</code> æ–‡ä»¶ï¼Œç„¶åå°†éœ€è¦è‡ªåŠ¨è£…é…çš„ç±»å…¨åæ”¾å…¥è¿™ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªç±»ä¸€è¡Œå³å¯ï¼Œ æ‰€ä»¥éœ€è¦åœ¨ <code>resources</code> ç›®å½•ä¸‹åˆ›å»º <code>META-INF/spring</code> ç›®å½•ï¼Œç„¶ååˆ›å»º <code>org.springframework.boot.autoconfigure.AutoConfiguration.imports</code> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.spring</span><span class="selector-class">.autoconfigure</span>.RocketMQAutoConfiguration</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤å°±å¯ä»¥æŒ‰ç…§ç¤ºä¾‹ä½¿ç”¨äº†ï¼Œ ç›´æ¥å¯åŠ¨ <code>SpringBoot</code> é¡¹ç›®å°±å¯ä»¥çœ‹åˆ°æ¶ˆæ¯å‘é€æˆåŠŸçš„æ—¥å¿—äº†</p>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨ideaç¼–è¯‘RocketMQ5æºç </title>
    <url>/2023/2adf4cc6108b/index.html</url>
    <content><![CDATA[<blockquote>
<p>Jdkç‰ˆæœ¬ï¼š 17<br>RocketMQç‰ˆæœ¬ï¼š 5.1.4<br>ideaç‰ˆæœ¬ï¼š 2023.2</p>
</blockquote>
<p>å‚è€ƒ <ol><li><a href="/2023/49fb249febb6/index.html" title="RocketMQå®‰è£…ä½¿ç”¨å’ŒåŸºæœ¬æ¦‚å¿µ">RocketMQå®‰è£…ä½¿ç”¨å’ŒåŸºæœ¬æ¦‚å¿µ</a></li></ol></p>
<p>ç›´æ¥åœ¨ <code>idea</code> å¯¼å…¥ <code>RocketMQ5</code> æºç å¹¶ç¼–è¯‘ä¼šç±»ä¼¼ä¸‹é¢çš„é”™è¯¯</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">java: ç¨‹åºåŒ…sun<span class="selector-class">.nio</span><span class="selector-class">.ch</span> ä¸å­˜åœ¨</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯å› ä¸ºä½¿ç”¨ <code>jdk8</code> ä»¥ä¸Šçš„ç‰ˆæœ¬è¿›è¡Œç¼–è¯‘ï¼Œ8 ä»¥ä¸Šçš„ <code>jdk</code> å¼€å§‹ä½¿ç”¨æ¨¡å—åŒ–ï¼Œæ‰€ä»¥æœ‰äº›æ¨¡å—éœ€è¦è‡ªå·±å¯¼å…¥ï¼Œè§£å†³æ–¹å¼å¦‚ä¸‹</p>
<ul>
<li>æ‰“å¼€ <code>settings -&gt; Build,Execution,Deployment -&gt; Compile -&gt; java compile</code></li>
</ul>
<p><img src="https://s2.loli.net/2023/12/19/9z8Tkuhes7FR1wy.png" alt="æ·»åŠ ç¼–è¯‘å‚æ•°"></p>
<p>ç»™ <code>rocketmq-common</code> å’Œ <code>rocketmq-store</code> æ¨¡å—æ·»åŠ å¦‚ä¸‹å‚æ•°</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">--<span class="keyword">add</span>-exports java.<span class="keyword">base</span>/sun.nio.ch=ALL-UNNAMED</span><br></pre></td></tr></table></figure>

<p>ç»™ <code>rocketmq-test</code> æ¨¡å—æ·»åŠ å¦‚ä¸‹å‚æ•°</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">--<span class="keyword">add</span>-exports java.<span class="keyword">base</span>/sun.util.locale=ALL-UNNAMED</span><br></pre></td></tr></table></figure>
<p>ç„¶åé‡æ–°ç¼–è¯‘å³å¯</p>
<p>Tips: ä¸ºä»€ä¹ˆè¦å»æ‰ <code>use --release</code> çš„é€‰é¡¹å‘¢ï¼Ÿ<br>ä½¿ç”¨ <code>javac --help</code> çœ‹çœ‹æ”¯æŒçš„å‚æ•°è¯´æ˜</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">javac --<span class="built_in">help</span></span><br><span class="line">--release &lt;release&gt;</span><br><span class="line">    Compile <span class="keyword">for</span> a specific VM version. Supported targets: 6, 7, 8, 9, 10, 11</span><br><span class="line">-<span class="built_in">source</span> &lt;release&gt;</span><br><span class="line">    Provide <span class="built_in">source</span> compatibility with specified release</span><br><span class="line">-target &lt;release&gt;            Generate class files <span class="keyword">for</span> specific VM version</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥ <code>--release</code> ä¸»è¦æ˜¯ä¸ºäº†å‘ä¸‹å…¼å®¹ï¼Œæ¯”å¦‚ä½¿ç”¨ <code>jdk13</code> å¼€å‘ï¼Œä½†æ˜¯è¿è¡Œç¯å¢ƒä½¿ç”¨çš„æ˜¯ <code>jdk11</code>, ä½¿ç”¨ <code>--release</code> ç¼–è¯‘å°±ä¸ä¼šæœ‰é—®é¢˜</p>
<p>ä¸è¿‡ <code>--release</code> å’Œ æ·»åŠ çš„ ç¼–è¯‘å‚æ•°æœ‰å†²çªï¼Œæ‰€ä»¥å°±å…ˆå–æ¶ˆäº† <code>--release</code> é€‰é¡¹</p>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>mavenç¼–è¯‘è·³è¿‡test</title>
    <url>/2023/5614a2f5fdca/index.html</url>
    <content><![CDATA[<h2 id="æ–¹å¼ä¸€"><a href="#æ–¹å¼ä¸€" class="headerlink" title="æ–¹å¼ä¸€"></a>æ–¹å¼ä¸€</h2><figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mvn</span> clean install -DskipTests</span><br></pre></td></tr></table></figure>

<h2 id="æ–¹å¼äºŒ"><a href="#æ–¹å¼äºŒ" class="headerlink" title="æ–¹å¼äºŒ"></a>æ–¹å¼äºŒ</h2><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">mvn clean <span class="keyword">install</span> -Dmaven.<span class="keyword">test</span>.skip=<span class="keyword">true</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœåœ¨ <code>window</code> ä¸­ä½¿ç”¨ <code>powershell</code> æˆ–åœ¨ <code>idea</code> çš„ç»ˆç«¯ä¸‹ä½¿ç”¨è¿™ç§æ–¹å¼å¯èƒ½ä¼šæç¤º <code>Unknown lifecycle phase &quot;.test.skip=true&quot;</code>ï¼Œæ­¤æ—¶éœ€è¦å¢åŠ å¼•å·ï¼Œæ¯”å¦‚</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">mvn clean <span class="keyword">install</span> &#x27;-Dmaven.<span class="keyword">test</span>.skip=<span class="keyword">true</span>&#x27;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>tools</category>
        <category>maven</category>
      </categories>
      <tags>
        <tag>maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Win11é€šè¿‡è„šæœ¬åˆ‡æ¢ä¸»é¢˜</title>
    <url>/2023/a3ce1a2f074a/index.html</url>
    <content><![CDATA[<p>åˆ‡æ¢ Light ä¸»é¢˜</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line"><span class="built_in">start</span> &quot;&quot; &quot;C:\\Windows\\Resources\\Themes\\Light.theme&quot; &amp; timeout /t <span class="number">2</span> &amp; <span class="built_in">taskkill</span> /im &quot;systemsettings.exe&quot; /f</span><br></pre></td></tr></table></figure>

<p>åˆ‡æ¢ Dark ä¸»é¢˜</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line"><span class="built_in">start</span> &quot;&quot; &quot;C:\\Windows\\Resources\\Themes\\dark.theme&quot; &amp; timeout /t <span class="number">2</span> &amp; <span class="built_in">taskkill</span> /im &quot;systemsettings.exe&quot; /f</span><br></pre></td></tr></table></figure>

<h2 id="éšè—æ‰§è¡Œè„šæœ¬æ—¶çš„é»‘æ¡†"><a href="#éšè—æ‰§è¡Œè„šæœ¬æ—¶çš„é»‘æ¡†" class="headerlink" title="éšè—æ‰§è¡Œè„šæœ¬æ—¶çš„é»‘æ¡†"></a>éšè—æ‰§è¡Œè„šæœ¬æ—¶çš„é»‘æ¡†</h2><p><strong>æ–¹æ³•ä¸€</strong><br>æ‰§è¡Œä¸Šé¢ä¸¤ä¸ªè„šæœ¬éƒ½ä¼šå‡ºç°é»‘è‰²çª—å£ï¼Œå¯ä»¥ä¿®æ”¹ <code>bat</code> æ–‡ä»¶ï¼Œå˜æˆå¦‚ä¸‹å½¢å¼</p>
<p>åˆ‡æ¢é»‘è‰²ä¸»é¢˜</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> &quot;%<span class="number">1</span>&quot;==&quot;hide&quot; <span class="keyword">goto</span> CmdBegin</span><br><span class="line"><span class="built_in">start</span> mshta vbscript:createobject(&quot;wscript.shell&quot;).run(&quot;&quot;&quot;%~<span class="number">0</span>&quot;&quot; hide&quot;,<span class="number">0</span>)(window.close)&amp;&amp;<span class="keyword">exit</span></span><br><span class="line">:CmdBegin</span><br><span class="line"></span><br><span class="line"><span class="built_in">start</span> &quot;&quot; &quot;C:\\Windows\\Resources\\Themes\\dark.theme&quot; &amp; timeout /t <span class="number">2</span> &amp; <span class="built_in">taskkill</span> /im &quot;systemsettings.exe&quot; /f</span><br></pre></td></tr></table></figure>

<p>åˆ‡æ¢ç™½è‰²ä¸»é¢˜</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> &quot;%<span class="number">1</span>&quot;==&quot;hide&quot; <span class="keyword">goto</span> CmdBegin</span><br><span class="line"><span class="built_in">start</span> mshta vbscript:createobject(&quot;wscript.shell&quot;).run(&quot;&quot;&quot;%~<span class="number">0</span>&quot;&quot; hide&quot;,<span class="number">0</span>)(window.close)&amp;&amp;<span class="keyword">exit</span></span><br><span class="line">:CmdBegin</span><br><span class="line"></span><br><span class="line"><span class="built_in">start</span> &quot;&quot; &quot;C:\\Windows\\Resources\\Themes\\Light.theme&quot; &amp; timeout /t <span class="number">2</span> &amp; <span class="built_in">taskkill</span> /im &quot;systemsettings.exe&quot; /f</span><br></pre></td></tr></table></figure>

<p><strong>æ–¹æ³•äºŒ</strong><br>ç¬¬äºŒç§æ–¹å¼æ˜¯å¦å¤–å†åˆ›å»ºä¸€ä¸ª <code>vbs</code> æ–‡ä»¶ï¼Œåœ¨ <code>vbs</code> ä¸­æ‰§è¡Œ <code>bat</code> æ–‡ä»¶</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> <span class="attribute">ws</span>=WScript.CreateObject(&quot;WScript.Shell&quot;)</span><br><span class="line">ws.<span class="built_in">Run</span> <span class="string">&quot;C:\xxx.bat&quot;</span>,0</span><br></pre></td></tr></table></figure>

<p>ç„¶åå¯ä»¥ç»“åˆ <a href="https://u.tools/">utools</a> ä½¿ç”¨ï¼Œå°±å¯ä»¥å¿«é€Ÿæ‰§è¡Œä¸»é¢˜åˆ‡æ¢</p>
]]></content>
      <categories>
        <category>tools</category>
        <category>other</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>WindTermåŠŸèƒ½è®¾ç½®</title>
    <url>/2023/0ff9c6825506/index.html</url>
    <content><![CDATA[<h2 id="è‡ªå®šä¹‰å¿«æ·é”®"><a href="#è‡ªå®šä¹‰å¿«æ·é”®" class="headerlink" title="è‡ªå®šä¹‰å¿«æ·é”®"></a>è‡ªå®šä¹‰å¿«æ·é”®</h2><p><a href="https://github.com/kingToolbox/WindTerm/issues/267">å‚è€ƒgithub</a></p>
<h2 id="å»é™¤é”å±"><a href="#å»é™¤é”å±" class="headerlink" title="å»é™¤é”å±"></a>å»é™¤é”å±</h2><ol>
<li>æ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥åœ¨ <strong>ä¼šè¯-&gt;é¦–é€‰é¡¹-&gt;é…ç½®æ–‡ä»¶</strong> ä¸­æŸ¥çœ‹é…ç½®æ–‡ä»¶çš„ä½ç½®</li>
<li>æ‰¾åˆ° <code>application.lockScreenTimeout</code>ï¼Œ å°†å€¼æ”¹æˆ 0</li>
</ol>
]]></content>
      <categories>
        <category>tools</category>
        <category>other</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>å¸¸ç”¨çš„å·¥å…·ç½‘ç«™è®°å½•</title>
    <url>/2023/366386a79bec/index.html</url>
    <content><![CDATA[<h2 id="pdf"><a href="#pdf" class="headerlink" title="pdf"></a>pdf</h2><p><a href="https://www.ilovepdf.com/compress_pdf">pdfåœ¨çº¿å‹ç¼©</a><br><a href="https://tools.pdf24.org/zh/compress-pdf#s=1604459737862%20%20%20%20%20pdf%E5%8E%8B%E7%BC%A9%E8%BD%AF%E4%BB%B6">pdfåœ¨çº¿å‹ç¼©</a></p>
<h2 id="èµ„æºç½‘ç«™"><a href="#èµ„æºç½‘ç«™" class="headerlink" title="èµ„æºç½‘ç«™"></a>èµ„æºç½‘ç«™</h2><ul>
<li><a href="https://cmsblogs.cn/">å¤§ç™½èœåšå®¢</a></li>
</ul>
]]></content>
      <categories>
        <category>tools</category>
        <category>other</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>utoolsè‡ªåŠ¨åŒ–è„šæœ¬æ’ä»¶</title>
    <url>/2023/d899f5ff1973/index.html</url>
    <content><![CDATA[<h2 id="utools-ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬æ‰“å¼€æœ¬åœ°ç¨‹åº"><a href="#utools-ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬æ‰“å¼€æœ¬åœ°ç¨‹åº" class="headerlink" title="utools ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬æ‰“å¼€æœ¬åœ°ç¨‹åº"></a>utools ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬æ‰“å¼€æœ¬åœ°ç¨‹åº</h2><ol>
<li>æ¯”å¦‚ typora å¯ä»¥æ‰“å¼€ä¹‹å‰çš„æ–‡ä»¶å’Œç›®å½•ï¼Œä½†æ˜¯ç›®å½•åªèƒ½åˆ°æ–‡ä»¶çš„ä¸Šä¸€ä¸ªå±‚çº§ï¼Œå¦‚æœæºç›®å½•åŒ…å«å¾ˆå¤šå­ç›®å½•ï¼Œé‡æ–°æ‰“å¼€æ—¶å¯èƒ½ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œé‚£å¯ä»¥åœ¨å‘½ä»¤è¡Œæ‰§è¡Œ <code>typora folder</code>, eg: <code>typora E:\\blog</code> <span id="more"></span></li>
</ol>
<blockquote>
<p>åœ¨å‘½ä»¤è¡Œæ‰§è¡Œ typora å‘½ä»¤éœ€è¦å…ˆé…ç½® typora çš„ç¯å¢ƒå˜é‡</p>
</blockquote>
<ol>
<li>æ›´ç®€ä¾¿çš„æ–¹å¼æ˜¯ç›´æ¥ä½¿ç”¨ utools çš„è‡ªåŠ¨åŒ–è„šæœ¬è¿™ä¸ªæ’ä»¶ï¼Œæ–°å¢ä¸€ä¸ªè‡ªå·±çš„æ’ä»¶è„šæœ¬ï¼Œå†…å®¹å¦‚ä¸‹</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; execFile &#125; = <span class="built_in">require</span>(<span class="string">&quot;child_process&quot;</span>)</span><br><span class="line"></span><br><span class="line"> <span class="comment">// ä»¥ä¸‹æ˜¯å…³é”®ä»£ç ï¼Œè°ƒç”¨ typora æ¥æ‰§è¡Œç›®æ ‡æ–‡ä»¶</span></span><br><span class="line"><span class="title function_">execFile</span>(<span class="string">&#x27;typora&#x27;</span>, [<span class="string">&#x27;E:/code/learnerguo&#x27;</span>], <span class="function">(<span class="params">error, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">    process.<span class="title function_">exit</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>ç„¶åè‡ªå®šä¹‰å…³é”®å­—ï¼Œåç»­å½“æ‰“å¼€ utools è¾“å…¥å¯¹åº”å…³é”®å­—å°±å¯ä»¥æ‰“å¼€ typora çš„ç›®å½•</p>
<h2 id="ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬è·å–å½“å¤©èµ·å§‹æ—¶é—´"><a href="#ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬è·å–å½“å¤©èµ·å§‹æ—¶é—´" class="headerlink" title="ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬è·å–å½“å¤©èµ·å§‹æ—¶é—´"></a>ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬è·å–å½“å¤©èµ·å§‹æ—¶é—´</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"><span class="comment">// è®¾ç½®å½“å‰æ—¶é—´çš„å°æ—¶ã€åˆ†é’Ÿã€ç§’å’Œæ¯«ç§’ä¸º0ï¼Œå³å°†æ—¶é—´è®¾ç½®ä¸ºå½“å¤©çš„å¼€å§‹æ—¶é—´</span></span><br><span class="line">now.<span class="title function_">setHours</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// è·å–å½“å¤©å¼€å§‹æ—¶é—´ç‚¹çš„æ¯«ç§’æ•°</span></span><br><span class="line"><span class="keyword">const</span> startTime = now.<span class="title function_">getTime</span>();</span><br><span class="line">utools.<span class="title function_">copyText</span>(<span class="string">&quot;&quot;</span>+startTime);</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;å¼€å§‹æ—¶é—´å·²å¤åˆ¶&#x27;</span> + startTime);</span><br><span class="line">utools.<span class="title function_">hideMainWindow</span>();</span><br><span class="line">process.<span class="title function_">exit</span>()</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>tools</category>
        <category>utools</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>utools</tag>
      </tags>
  </entry>
  <entry>
    <title>vscodeç›¸å…³è®¾ç½®</title>
    <url>/2023/6b613d963af3/index.html</url>
    <content><![CDATA[<h2 id="vscode-ä¸­-markdown-çš„-snippets-çš„è®¾ç½®"><a href="#vscode-ä¸­-markdown-çš„-snippets-çš„è®¾ç½®" class="headerlink" title="vscode ä¸­ markdown çš„ snippets çš„è®¾ç½®"></a>vscode ä¸­ markdown çš„ snippets çš„è®¾ç½®</h2><h3 id="snippets-çš„è®¾ç½®"><a href="#snippets-çš„è®¾ç½®" class="headerlink" title="snippets çš„è®¾ç½®"></a>snippets çš„è®¾ç½®</h3><ol>
<li>æ‰“å¼€ ctrl+shift+p , æœç´¢ <code>configure user snippets</code> </li>
<li>é€‰æ‹© markdown.json, ä¼šå‡ºç°å¦‚ä¸‹å†…å®¹</li>
</ol>
<span id="more"></span>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="comment">// Place your snippets for markdown here. Each snippet is defined under a snippet name and has a prefix, body and </span></span><br><span class="line">	<span class="comment">// description. The prefix is what is used to trigger the snippet and the body will be expanded and inserted. Possible variables are:</span></span><br><span class="line">	<span class="comment">// $1, $2 for tab stops, $0 for the final cursor position, and $&#123;1:label&#125;, $&#123;2:another&#125; for placeholders. Placeholders with the </span></span><br><span class="line">	<span class="comment">// same ids are connected.</span></span><br><span class="line">	<span class="comment">// Example:</span></span><br><span class="line">	<span class="comment">// &quot;Print to console&quot;: &#123;</span></span><br><span class="line">	<span class="comment">// 	&quot;prefix&quot;: &quot;log&quot;,</span></span><br><span class="line">	<span class="comment">// 	&quot;body&quot;: [</span></span><br><span class="line">	<span class="comment">// 		&quot;console.log(&#x27;$1&#x27;);&quot;,</span></span><br><span class="line">	<span class="comment">// 		&quot;$2&quot;</span></span><br><span class="line">	<span class="comment">// 	],</span></span><br><span class="line">	<span class="comment">// 	&quot;description&quot;: &quot;Log output to console&quot;</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>å¯ä»¥æ ¹æ®ç¤ºä¾‹æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;markdown code graph&quot;</span>: &#123;</span><br><span class="line">	<span class="string">&quot;prefix&quot;</span>: <span class="string">&quot;codeblock&quot;</span>,</span><br><span class="line">	<span class="string">&quot;body&quot;</span>: [</span><br><span class="line">		<span class="string">&quot;&lt;pre class=&quot;</span>mermaid<span class="string">&quot;&gt;<span class="variable">$0</span>&quot;</span>,</span><br><span class="line">		<span class="string">&quot;```&quot;</span></span><br><span class="line">	],</span><br><span class="line">	<span class="string">&quot;description&quot;</span>: <span class="string">&quot;insert markdown code graph&quot;</span></span><br><span class="line">&#125;&lt;/pre&gt;</span><br><span class="line"></span><br><span class="line">ä¸Šé¢ç¤ºä¾‹çš„æ„æ€æ˜¯ å½“è¾“å…¥ codeblock æ—¶å°±ä¼šå‡ºç° mermaid ä»£ç å—ï¼Œ <span class="variable">$0</span> æ˜¯å…‰æ ‡å‡ºç°çš„åœ°æ–¹</span><br><span class="line"></span><br><span class="line"><span class="comment">### markdown snippets ä¸ç”Ÿæ•ˆçš„è§£å†³æ–¹å¼</span></span><br><span class="line">ä½¿ç”¨ä¸Šé¢çš„æ­¥éª¤è®¾ç½®å®Œ snippets ä¹‹åï¼Œåœ¨ markdown æ–‡æ¡£ä¸­ç¼–å†™å…³é”®å­—ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼Œè¿˜éœ€è¦åœ¨  settings.json ä¸­ï¼ˆå¯ä»¥è¾“å…¥ ctrl+<span class="built_in">shift</span>+p, æœç´¢ settingsï¼Œ é€‰æ‹© Open User Settings(JSON)ï¼‰, ç„¶åå¡«å†™ä¸‹é¢çš„å†…å®¹</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="string">&quot;[markdown]&quot;</span>:&#123;</span><br><span class="line">	<span class="string">&quot;editor.formatOnSave&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="string">&quot;editor.renderWhitespace&quot;</span>: <span class="string">&quot;all&quot;</span>,</span><br><span class="line">	<span class="string">&quot;editor.quickSuggestions&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;other&quot;</span>: <span class="string">&quot;on&quot;</span>,</span><br><span class="line">		<span class="string">&quot;comments&quot;</span>: <span class="string">&quot;on&quot;</span>,</span><br><span class="line">		<span class="string">&quot;strings&quot;</span>: <span class="string">&quot;on&quot;</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;editor.acceptSuggestionOnEnter&quot;</span>: <span class="string">&quot;on&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>æ·»åŠ ä¸Šè¿°å†…å®¹åå°±å¯ä»¥ç”Ÿæ•ˆäº†</p>
<h2 id="vscode-è®¾ç½®ç™½å¤©é»‘å¤œè‡ªåŠ¨åˆ‡æ¢ä¸»é¢˜"><a href="#vscode-è®¾ç½®ç™½å¤©é»‘å¤œè‡ªåŠ¨åˆ‡æ¢ä¸»é¢˜" class="headerlink" title="vscode è®¾ç½®ç™½å¤©é»‘å¤œè‡ªåŠ¨åˆ‡æ¢ä¸»é¢˜"></a>vscode è®¾ç½®ç™½å¤©é»‘å¤œè‡ªåŠ¨åˆ‡æ¢ä¸»é¢˜</h2><ol>
<li>vscode å¯ä»¥æ ¹æ®ç³»ç»Ÿè®¾ç½®çš„ <code>light</code> æˆ– <code>dark</code> ä¸»é¢˜æ¥è¿›è¡Œåˆ‡æ¢</li>
<li>ç³»ç»Ÿè‡ªåŠ¨åˆ‡æ¢ä¸»é¢˜è½¯ä»¶å¯ä»¥åœ¨ <code>store</code> ä¸­å®‰è£… <code>Auto Dark Mode</code> è¿™ä¸ªè½¯ä»¶å¹¶è¿›è¡Œè®¾ç½®</li>
<li><code>window</code> ç³»ç»Ÿè®¾ç½®å®Œæˆä¹‹åå¯ä»¥åœ¨ <code>vscode</code> çš„ <code>user setting</code> ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹, ç¬¬ä¸€ä¸ªé…ç½®æ˜¯å¼€å¯è‡ªåŠ¨åˆ‡æ¢ï¼Œåé¢çš„é…ç½®æ˜¯è®¾ç½®çš„ <code>light</code> å’Œ <code>dark</code> ä¸»é¢˜çš„åç§°</li>
</ol>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;window.autoDetectColorScheme&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;workbench.preferredLightColorTheme&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Atom One Light&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;workbench.preferredDarkColorTheme&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Default Dark Modern&quot;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>tools</category>
        <category>vscode</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>vscode</tag>
      </tags>
  </entry>
  <entry>
    <title>vscodeè®¾ç½®markdownå›¾ç‰‡é»˜è®¤è·¯å¾„</title>
    <url>/2023/5b4d784e18c2/index.html</url>
    <content><![CDATA[<p><code>vscode</code> åœ¨ <code>markdown</code> æ–‡æ¡£ä¸­ç›´æ¥å¤åˆ¶å›¾ç‰‡æ—¶æ˜¯æ”¾åœ¨å½“å‰ç›®å½•ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹å¯ä»¥æŒ‰ç…§ä¸‹é¢æ–¹å¼è®¾ç½®</p>
<span id="more"></span>
<ol>
<li>è¾“å…¥å¿«æ·é”® <code>ctrl+,</code> å¯ä»¥å¿«é€Ÿæ‰“å¼€è®¾ç½®</li>
<li>æœç´¢ <code>markdown.copy: Destination</code></li>
</ol>
<p><img src="/2023/5b4d784e18c2/index/1700033681108.png" alt="Alt text"></p>
]]></content>
      <categories>
        <category>tools</category>
        <category>vscode</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>dockerä¸­è¿è¡Œnacos</title>
    <url>/2023/f67204379054/index.html</url>
    <content><![CDATA[<p>ä½¿ç”¨çš„ç³»ç»Ÿä¸º <code>ubuntu22.04</code></p>
<ol><li><a href="/2023/71e6b223e45b/index.html" title="ubuntu22.04å®‰è£…docker-compose">ubuntu22.04å®‰è£…docker-compose</a></li></ol>

<p>å‚è€ƒ <a href="https://nacos.io/zh-cn/docs/quick-start-docker.html">nacoså®˜æ–¹æ–‡æ¡£ä¹‹ä½¿ç”¨dockerå¯åŠ¨</a></p>
<p>è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>mysql8</code> å•æœºç‰ˆå¯åŠ¨</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- å…‹éš†é¡¹ç›® --&gt;</span></span><br><span class="line">git clone https://github.com/nacos-group/nacos-docker.git</span><br><span class="line">cd nacos-docker</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ä»¥åå°æ¨¡å¼å¯åŠ¨ nacos æœåŠ¡ --&gt;</span></span><br><span class="line">docker-compose -f example/standalone-mysql-8.yaml up -d</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- æŸ¥çœ‹å¯åŠ¨çš„dockeræœåŠ¡ --&gt;</span></span><br><span class="line">docker container ps</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- å…³é—­æœåŠ¡ --&gt;</span></span><br><span class="line">docker-compose -f example/standalone-mysql-8.yaml down</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- å¯åŠ¨åï¼Œè®¿é—® nacos  --&gt;</span></span><br><span class="line">http://localhost:8848/nacos/index.html</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>äº‘åŸç”Ÿ</category>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>dockeré…ç½®é˜¿é‡Œäº‘åŠ é€Ÿé•œåƒ</title>
    <url>/2023/2b35420a425c/index.html</url>
    <content><![CDATA[<ol>
<li>è®¿é—®<a href="https://cr.console.aliyun.com/">é˜¿é‡Œäº‘é•œåƒæ§åˆ¶å°</a>ï¼Œ æ‰¾åˆ°é•œåƒåŠ é€Ÿé“¾æ¥</li>
</ol>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311272213645.webp" alt="åŠ é€Ÿé•œåƒ"></p>
<ol start="2">
<li>åœ¨æ–‡æ¡£çš„ä¸‹æ–¹å°±æœ‰ä¸åŒç¯å¢ƒé…ç½®çš„ä»£ç ï¼Œä¸‹é¢æ˜¯ <code>ubuntu</code> ç¯å¢ƒçš„é…ç½®ï¼ˆåŠ é€Ÿè·¯å¾„æ›¿æ¢æˆè‡ªå·±çš„ï¼‰</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line">sudo <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://xxx.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<ol>
<li>ä¿®æ”¹ Cgroup Driver, ä¿®æ”¹ <code>/etc/docker/daemon.json</code> æ–‡ä»¶ï¼Œå¢åŠ å¦‚ä¸‹å†…å®¹</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆ <code>daemon.json</code> æ–‡ä»¶å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://xxx.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">  <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>é‡å¯ <code>docker</code> æœåŠ¡</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>




]]></content>
      <categories>
        <category>äº‘åŸç”Ÿ</category>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>ubuntu22.04å®‰è£…docker-compose</title>
    <url>/2023/71e6b223e45b/index.html</url>
    <content><![CDATA[<ol>
<li><a href="https://github.com/docker/compose/releases">docker-composeä¸‹è½½</a>, é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬å³å¯ï¼Œå¯¹äº <code>ubuntu</code> ç³»ç»Ÿé€‰æ‹©çš„æ˜¯ <code>Linux</code> ç‰ˆæœ¬ï¼Œ ä¸‹è½½å®Œæˆåï¼Œå°†å…¶ç§»åŠ¨åˆ° <code>/usr/local/bin/</code> ç›®å½•ä¸‹å³å¯ã€‚</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é‡å‘½å</span></span><br><span class="line"><span class="built_in">mv</span> docker-compose-linux-x86_64 docker-compose</span><br><span class="line"><span class="comment"># ç§»åŠ¨åˆ°æ‰§è¡Œç›®å½•</span></span><br><span class="line">sudo <span class="built_in">mv</span> docker-compose /usr/local/bin/</span><br><span class="line"><span class="comment"># èµ‹äºˆæ‰§è¡Œæƒé™</span></span><br><span class="line">sudo <span class="built_in">chmod</span> u+x docker-compose</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>äº‘åŸç”Ÿ</category>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨docker-composeå®‰è£…mysqlå’ŒredisåŸºæœ¬ç¯å¢ƒ</title>
    <url>/2023/3c61103fd97b/index.html</url>
    <content><![CDATA[<h2 id="åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ"><a href="#åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ" class="headerlink" title="åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ"></a>åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker network create service_default</span><br></pre></td></tr></table></figure>

<h2 id="docker-compose-å®‰è£…mysql-redis"><a href="#docker-compose-å®‰è£…mysql-redis" class="headerlink" title="docker-compose å®‰è£…mysql,redis"></a>docker-compose å®‰è£…mysql,redis</h2><p>ä¸‹é¢å°†æ‰€æœ‰çš„è½¯ä»¶å®‰è£…åœ¨ <code>/opt/docker_soft</code> ç›®å½•ä¸‹</p>
<ol>
<li>åœ¨ <code>/opt/docker_soft</code> ç›®å½•ä¸‹åˆ›å»ºå¦‚ä¸‹ç›®å½•ç»“æ„</li>
</ol>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚   â”œâ”€â”€ mysql8</span><br><span class="line">â”‚   â”‚   â””â”€â”€ my<span class="selector-class">.cnf</span></span><br><span class="line">â”‚   â”œâ”€â”€ nginx</span><br><span class="line">â”‚   â”‚   â””â”€â”€ nginx<span class="selector-class">.conf</span></span><br><span class="line">â”‚   â”œâ”€â”€ redis7</span><br><span class="line">â”‚   â”‚   â””â”€â”€ redis<span class="selector-class">.conf</span></span><br><span class="line">â”‚   â””â”€â”€ zk</span><br><span class="line">â”‚       â””â”€â”€ zoo<span class="selector-class">.cfg</span></span><br><span class="line">â”œâ”€â”€ data</span><br><span class="line">â”‚   â”œâ”€â”€ mysql8</span><br><span class="line">â”‚   â”œâ”€â”€ nginx</span><br><span class="line">â”‚   â”œâ”€â”€ redis</span><br><span class="line">â”œâ”€â”€ docker-compose<span class="selector-class">.yml</span></span><br><span class="line">â””â”€â”€ log</span><br><span class="line">    â”œâ”€â”€ mysql8</span><br><span class="line">    â””â”€â”€ nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/docker_soft</span><br><span class="line"><span class="built_in">mkdir</span> -p config data <span class="built_in">log</span></span><br><span class="line"><span class="built_in">cd</span> config/</span><br><span class="line"><span class="built_in">mkdir</span> mysql8</span><br><span class="line"><span class="built_in">mkdir</span> nginx</span><br><span class="line"><span class="built_in">mkdir</span> redis7</span><br><span class="line"><span class="built_in">touch</span> mysql8/my.cnf</span><br><span class="line"><span class="built_in">touch</span> nginx/nginx.conf</span><br><span class="line"><span class="built_in">touch</span> redis7/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">mkdir</span> data/mysql8</span><br><span class="line"><span class="built_in">mkdir</span> data/nginx</span><br><span class="line"><span class="built_in">mkdir</span> data/redis</span><br><span class="line"><span class="built_in">mkdir</span> <span class="built_in">log</span>/mysql8</span><br><span class="line"><span class="built_in">mkdir</span> <span class="built_in">log</span>/nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»™mysqlæŒ‚è½½ç›®å½•èµ‹äºˆæ‰€æœ‰æƒé™ï¼Œé¿å…mysqlå¯åŠ¨æŠ¥é”™</span></span><br><span class="line"><span class="built_in">chmod</span> -R 777 data/mysql8</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šé¢å‘½ä»¤åˆ›å»ºäº†ä¸‰ä¸ªé…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­ <code>my.cnf</code> æ˜¯ mysql çš„é…ç½®æ–‡ä»¶ï¼Œ<code>nginx.conf</code> æ˜¯ nginx çš„é…ç½®æ–‡ä»¶ï¼Œ<code>redis.conf</code> æ˜¯ redis çš„é…ç½®æ–‡ä»¶ï¼Œ å¯ä»¥å°†ä¸‹é¢å†…å®¹æ‹·è´åˆ°å¯¹åº”çš„é…ç½®æ–‡ä»¶ä¸­ã€‚</p>
<div class="tabs" id="é…ç½®æ–‡ä»¶"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="é…ç½®æ–‡ä»¶-1">mysqlçš„é…ç½®æ–‡ä»¶(my.cnf)</button><button type="button" class="tab " data-href="é…ç½®æ–‡ä»¶-2">nginxçš„é…ç½®æ–‡ä»¶(nginx.conf)</button><button type="button" class="tab " data-href="é…ç½®æ–‡ä»¶-3">redisçš„é…ç½®æ–‡ä»¶(redis.conf)</button></ul><div class="tab-contents"><div class="tab-item-content active" id="é…ç½®æ–‡ä»¶-1"><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment">###### [mysql]é…ç½®æ¨¡å— ######</span></span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="comment"># è®¾ç½®MySQLå®¢æˆ·ç«¯é»˜è®¤å­—ç¬¦é›†</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8mb4</span><br><span class="line"><span class="attr">socket</span>=/var/lib/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###### [mysqld]é…ç½®æ¨¡å— ######</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3306</span></span><br><span class="line"><span class="attr">user</span>=root</span><br><span class="line"><span class="comment"># æ³¨é‡Š1</span></span><br><span class="line"><span class="comment">#skip-grant-tables</span></span><br><span class="line"><span class="attr">sql_mode</span>=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION</span><br><span class="line"></span><br><span class="line"><span class="attr">datadir</span>=/var/lib/mysql</span><br><span class="line"><span class="attr">socket</span>=/var/lib/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># MySQL8 çš„å¯†ç è®¤è¯æ’ä»¶</span></span><br><span class="line"><span class="comment">#default_authentication_plugin=mysql_native_password</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¦ç”¨ç¬¦å·é“¾æ¥ä»¥é˜²æ­¢å„ç§å®‰å…¨é£é™©</span></span><br><span class="line"><span class="comment">#symbolic-links=0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line"><span class="attr">max_connections</span>=<span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœåŠ¡ç«¯ä½¿ç”¨çš„å­—ç¬¦é›†é»˜è®¤ä¸º8æ¯”ç‰¹ç¼–ç çš„latin1å­—ç¬¦é›†</span></span><br><span class="line"><span class="attr">character-set-server</span>=utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ–°è¡¨æ—¶å°†ä½¿ç”¨çš„é»˜è®¤å­˜å‚¨å¼•æ“</span></span><br><span class="line"><span class="attr">default-storage-engine</span>=INNODB</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¡¨åå­˜å‚¨åœ¨ç£ç›˜æ˜¯å°å†™çš„ï¼Œä½†æ˜¯æ¯”è¾ƒçš„æ—¶å€™æ˜¯ä¸åŒºåˆ†å¤§å°å†™</span></span><br><span class="line"><span class="attr">lower_case_table_names</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">max_allowed_packet</span>=<span class="number">16</span>M </span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®æ—¶åŒº</span></span><br><span class="line"><span class="attr">default-time_zone</span>=<span class="string">&#x27;+8:00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># binlog é…ç½®</span></span><br><span class="line"><span class="attr">log-bin</span> = /logs/mysql-bin.log</span><br><span class="line"><span class="attr">expire-logs-days</span> = <span class="number">90</span></span><br><span class="line"><span class="attr">max-binlog-size</span> = <span class="number">500</span>M</span><br><span class="line"></span><br><span class="line"><span class="comment"># server-id é…ç½®</span></span><br><span class="line"><span class="attr">server-id</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###### [client]é…ç½®æ¨¡å— ######</span></span><br><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="comment">#â€“initialize --lower-case-table-names=1</span></span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="é…ç½®æ–‡ä»¶-2"><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line"><span class="comment"># å¦‚æœè®¾ç½®äº† autoï¼Œ åˆ™ work-processes çš„æ•°é‡ä¸º CPU çš„æ ¸æ•°</span></span><br><span class="line"><span class="comment"># worker_processes  auto;</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">pid</span>        /var/log/nginx/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment">#include       mime.types;</span></span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   /usr/share/nginx/html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="é…ç½®æ–‡ä»¶-3"><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">protected-mode <span class="keyword">no</span></span><br><span class="line">port <span class="number">6379</span></span><br><span class="line">tcp-backlog <span class="number">511</span></span><br><span class="line">timeout <span class="number">0</span></span><br><span class="line">tcp-keepalive <span class="number">300</span></span><br><span class="line">daemonize <span class="keyword">no</span></span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">loglevel <span class="keyword">notice</span></span><br><span class="line">logfile &quot;&quot;</span><br><span class="line">databases <span class="number">16</span></span><br><span class="line"><span class="keyword">always</span>-<span class="keyword">show</span>-logo <span class="keyword">no</span></span><br><span class="line"><span class="keyword">set</span>-proc-title yes</span><br><span class="line">proc-title-<span class="keyword">template</span> &quot;&#123;title&#125; &#123;listen-addr&#125; &#123;server-mode&#125;&quot;</span><br><span class="line">stop-writes-<span class="keyword">on</span>-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">rdb-del-sync-files <span class="keyword">no</span></span><br><span class="line">dir ./</span><br><span class="line"><span class="keyword">replica</span>-serve-stale-data yes</span><br><span class="line"><span class="keyword">replica</span>-<span class="keyword">read</span>-<span class="keyword">only</span> yes</span><br><span class="line">repl-diskless-sync yes</span><br><span class="line">repl-diskless-sync-max-replicas <span class="number">0</span></span><br><span class="line">repl-diskless-<span class="keyword">load</span> disabled</span><br><span class="line">repl-<span class="keyword">disable</span>-tcp-nodelay <span class="keyword">no</span></span><br><span class="line"><span class="keyword">replica</span>-priority <span class="number">100</span></span><br><span class="line">acllog-max-len <span class="number">128</span></span><br><span class="line"></span><br><span class="line">lazyfree-lazy-eviction <span class="keyword">no</span></span><br><span class="line">lazyfree-lazy-expire <span class="keyword">no</span></span><br><span class="line">lazyfree-lazy-<span class="keyword">server</span>-del <span class="keyword">no</span></span><br><span class="line"><span class="keyword">replica</span>-lazy-flush <span class="keyword">no</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lazyfree-lazy-<span class="keyword">user</span>-del <span class="keyword">no</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lazyfree-lazy-<span class="keyword">user</span>-flush <span class="keyword">no</span></span><br><span class="line">oom-score-adj <span class="keyword">no</span></span><br><span class="line"></span><br><span class="line">oom-score-adj-<span class="keyword">values</span> <span class="number">0</span> <span class="number">200</span> <span class="number">800</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">disable</span>-thp yes</span><br><span class="line"></span><br><span class="line">appendonly <span class="keyword">no</span></span><br><span class="line"></span><br><span class="line">appendfilename &quot;appendonly.aof&quot;</span><br><span class="line">appenddirname &quot;appendonlydir&quot;</span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="keyword">no</span>-appendfsync-<span class="keyword">on</span>-rewrite <span class="keyword">no</span></span><br><span class="line">auto-aof-rewrite-percentage <span class="number">100</span></span><br><span class="line">auto-aof-rewrite-min-size <span class="number">64</span>mb</span><br><span class="line"></span><br><span class="line">aof-<span class="keyword">load</span>-truncated yes</span><br><span class="line"></span><br><span class="line">aof-use-rdb-preamble yes</span><br><span class="line"></span><br><span class="line">aof-<span class="type">timestamp</span>-enabled <span class="keyword">no</span></span><br><span class="line"></span><br><span class="line">slowlog-<span class="keyword">log</span>-slower-than <span class="number">10000</span></span><br><span class="line"></span><br><span class="line">slowlog-max-len <span class="number">128</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">latency-monitor-threshold <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">notify</span>-keyspace-events &quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hash-max-listpack-entries <span class="number">512</span></span><br><span class="line">hash-max-listpack-<span class="keyword">value</span> <span class="number">64</span></span><br><span class="line"></span><br><span class="line">list-max-listpack-size <span class="number">-2</span></span><br><span class="line"></span><br><span class="line">list-compress-depth <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>-max-intset-entries <span class="number">512</span></span><br><span class="line"></span><br><span class="line">zset-max-listpack-entries <span class="number">128</span></span><br><span class="line">zset-max-listpack-<span class="keyword">value</span> <span class="number">64</span></span><br><span class="line"></span><br><span class="line">hll-sparse-max-bytes <span class="number">3000</span></span><br><span class="line"></span><br><span class="line">stream-node-max-bytes <span class="number">4096</span></span><br><span class="line">stream-node-max-entries <span class="number">100</span></span><br><span class="line"></span><br><span class="line">activerehashing yes</span><br><span class="line"></span><br><span class="line">client-output-buffer-<span class="keyword">limit</span> normal <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">client-output-buffer-<span class="keyword">limit</span> <span class="keyword">replica</span> <span class="number">256</span>mb <span class="number">64</span>mb <span class="number">60</span></span><br><span class="line">client-output-buffer-<span class="keyword">limit</span> pubsub <span class="number">32</span>mb <span class="number">8</span>mb <span class="number">60</span></span><br><span class="line">hz <span class="number">10</span></span><br><span class="line"></span><br><span class="line">dynamic-hz yes</span><br><span class="line"></span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line"></span><br><span class="line">rdb-save-incremental-fsync yes</span><br><span class="line">jemalloc-bg-thread yes</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<ol start="3">
<li>åœ¨ <code>/opt/docker_soft</code> ç›®å½•ä¸‹åˆ›å»º <code>docker-compose.yml</code> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">service_default:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql8:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql8</span></span><br><span class="line">    <span class="comment">#restart: always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">service_default</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3306</span><span class="string">:3306</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">MYSQL_USER:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">MYSQL_PASSWORD:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment"># æ•°æ®æŒ‚è½½</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/docker_soft/data/mysql8/:/var/lib/mysql/</span></span><br><span class="line">      <span class="comment"># é…ç½®æŒ‚è½½</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/docker_soft/config/mysql8/:/etc/mysql/conf.d/</span></span><br><span class="line">      <span class="comment"># æ—¥å¿—æŒ‚è½½</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/docker_soft/log/mysql8:/logs</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="comment"># å°†mysql8.0é»˜è®¤å¯†ç ç­–ç•¥ ä¿®æ”¹ä¸º åŸå…ˆ ç­–ç•¥ (mysql8.0å¯¹å…¶é»˜è®¤ç­–ç•¥åšäº†æ›´æ”¹ ä¼šå¯¼è‡´å¯†ç æ— æ³•åŒ¹é…)</span></span><br><span class="line">      <span class="string">--authentication_policy=mysql_native_password</span></span><br><span class="line">      <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">      <span class="string">--collation-server=utf8mb4_general_ci</span></span><br><span class="line">      <span class="string">--explicit_defaults_for_timestamp=true</span></span><br><span class="line">      <span class="string">--lower_case_table_names=1</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.25.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="comment">#restart: always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">service_default</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/docker_soft/config/nginx:/etc/nginx</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/docker_soft/log/nginx:/var/log/nginx</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7-alpine3.18</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="comment">#restart: always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">service_default</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/docker_soft/config/redis7/:/usr/local/etc/redis/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/docker_soft/data/redis:/data</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å®‰è£… <code>docker</code> é•œåƒ</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull mysql:8.0</span><br><span class="line">docker pull redis:7-alpine3.18</span><br><span class="line">docker pull nginx:1.25.0</span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>äº‘åŸç”Ÿ</category>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>æ™®é€šç”¨æˆ·æ‰§è¡Œdockerå‘½ä»¤</title>
    <url>/2023/6987d518f2d5/index.html</url>
    <content><![CDATA[<p>ä»¥ä¸‹æ“ä½œæ˜¯åœ¨ <code>ubuntu22.04</code> ç‰ˆæœ¬å®‰è£… <code>docker</code> åï¼Œæ™®é€šç”¨æˆ·æ‰§è¡Œ <code>docker</code> å‘½ä»¤æ—¶ä¸ç”¨æ·»åŠ  <code>sudo</code></p>
<ol>
<li>åˆ›å»º <code>docker</code> ç”¨æˆ·ç»„</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo groupadd docker</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å°†å½“å‰ç”¨æˆ·åŠ å…¥åˆ° <code>docker</code> ç”¨æˆ·ç»„</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo usermod -aG docker <span class="variable">$USER</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>é€€å‡ºå½“å‰ç”¨æˆ·ï¼Œé‡æ–°ç™»å½•ï¼Œå³å¯ä½¿ç”¨ <code>docker</code> å‘½ä»¤</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>äº‘åŸç”Ÿ</category>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
</search>
