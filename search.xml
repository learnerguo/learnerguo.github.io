<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ä¹¦å•è®°å½•</title>
    <url>/2023/d298f472fcd1/index.html</url>
    <content><![CDATA[<h2 id="ç®—æ³•"><a href="#ç®—æ³•" class="headerlink" title="ç®—æ³•"></a>ç®—æ³•</h2><ul>
<li>ã€Šå‰‘æŒ‡Offerï¼šä¸“é¡¹çªç ´ç‰ˆ. æ•°æ®ç»“æ„ä¸ç®—æ³•åä¼é¢è¯•é¢˜ç²¾è®²ã€‹  â€“ ä½•æµ·æ¶›  ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="java"><a href="#java" class="headerlink" title="java"></a>java</h2><ul>
<li>ğŸ“– ã€ŠJavaå¹¶å‘ç¼–ç¨‹æ·±åº¦è§£æä¸å®æˆ˜ã€‹ â€“ è°­é”‹   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ğŸ“– ã€Šå‰‘æŒ‡JVMï¼šè™šæ‹Ÿæœºæ—¶é—´ä¸æ€§èƒ½è°ƒä¼˜ã€‹   â€“ å°šç¡…è°·æ•™è‚²      ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€Šè®¾è®¡æ¨¡å¼å°±è¯¥è¿™ä¹ˆå­¦ï¼šåŸºäºç»å…¸æ¡†æ¶æºç å’ŒçœŸå®ä¸šåŠ¡åœºæ™¯ã€‹   â€“ è°­å‹‡å¾·   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€Šäº’è”ç½‘è½»é‡çº§SSMæ¡†æ¶è§£å¯†ï¼šSpringã€Spring MVCã€MyBatisæºç æ·±åº¦å‰–æã€‹   â€“ æè‰³é¹   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€Šåˆ†å¸ƒå¼ä¸­é—´ä»¶æŠ€æœ¯(Javaç‰ˆ)ã€‹  <a href="https://cmsblogs.cn/4303.html">ä¸‹è½½åœ°å€</a>    ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="tomcat"><a href="#tomcat" class="headerlink" title="tomcat"></a>tomcat</h2><ul>
<li>ã€ŠTomcatæ¶æ„è§£æã€‹  â€“ åˆ˜å…‰ç‘ ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="ç®¡ç†"><a href="#ç®¡ç†" class="headerlink" title="ç®¡ç†"></a>ç®¡ç†</h2><ul>
<li>ã€ŠçŸ¥è¡Œ:æŠ€æœ¯äººçš„ç®¡ç†ä¹‹è·¯ã€‹ â€“ åˆ˜å»ºå›½   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>æŠ€æœ¯ç®¡ç†å®æˆ˜ 36 è®²   â€“ åˆ˜å»ºå›½  ã€æå®¢æ—¶é—´ã€‘ã€ç™¾åº¦ç½‘ç›˜ã€‘</li>
<li>æŠ€æœ¯é¢†å¯¼åŠ›å®æˆ˜   ã€æå®¢æ—¶é—´ã€‘ã€ç™¾åº¦ç½‘ç›˜ã€‘</li>
</ul>
<h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><ul>
<li>ğŸ“– ã€Šåˆ†å¸ƒå¼æ¶æ„åŸç†ä¸å®è·µã€‹  â€“ å´”çš“  ã€å¾®ä¿¡è¯»ä¹¦ã€‘<ol><li><a href="/2024/48c302d39723/index.html" title="åˆ†å¸ƒå¼æ¶æ„åŸç†ä¸å®è·µ">åˆ†å¸ƒå¼æ¶æ„åŸç†ä¸å®è·µ</a></li></ol></li>
</ul>
<h2 id="Springç³»åˆ—"><a href="#Springç³»åˆ—" class="headerlink" title="Springç³»åˆ—"></a>Springç³»åˆ—</h2><ul>
<li>ã€ŠSpring Cloud Alibabaå¾®æœåŠ¡åŸç†ä¸å®æˆ˜ã€‹  <a href="https://cmsblogs.cn/2647.html">ä¸‹è½½åœ°å€</a>   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€ŠSpringBootæŠ€æœ¯å†…å¹•ã€‹   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h2><ul>
<li>ğŸ“–ã€ŠMySQLæŠ€æœ¯å†…å¹•ï¼šInnoDBå­˜å‚¨å¼•æ“ã€‹ â€“ å§œæ‰¿å°§</li>
<li>ğŸ“– <a href="https://relph1119.github.io/mysql-learning-notes/#/">ã€ŠMySQL æ˜¯æ€æ ·è¿è¡Œçš„ï¼šä»æ ¹å„¿ä¸Šç†è§£ MySQLã€‹</a></li>
</ul>
<h2 id="ç½‘ç»œ"><a href="#ç½‘ç»œ" class="headerlink" title="ç½‘ç»œ"></a>ç½‘ç»œ</h2><ul>
<li>ã€Šæ·±å…¥ç†è§£ TCP åè®®ï¼šä»åŸç†åˆ°å®æˆ˜ã€‹ <a href="https://juejin.cn/book/6844733788681928712">æ˜é‡‘å°å†Œ</a></li>
<li>ã€Šè¶£è°ˆç½‘ç»œåè®®ã€‹  â€“ åˆ˜è¶…  </li>
<li>ã€Šæ·±å…¥æµ…å‡ºè®¡ç®—æœºç½‘ç»œã€‹  â€“éŸ©ç«‹åˆš</li>
<li>ã€Šå®Œå…¨å›¾è§£æœåŠ¡å™¨å·¥ä½œåŸç†ã€‹</li>
<li>ã€Šæ·±å…¥ç†è§£Linuxç½‘ç»œã€‹</li>
<li>ã€Šæ·±å…¥æµ…å‡ºTCP&#x2F;IPã€‹</li>
<li>ã€Šå›¾è§£httpã€‹   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="Netty"><a href="#Netty" class="headerlink" title="Netty"></a>Netty</h2><ul>
<li>ã€Šè·Ÿé—ªç”µä¾ å­¦Netty:Nettyå³æ—¶èŠå¤©å®æˆ˜ä¸åº•å±‚åŸç†ã€‹  â€“ ä¿è¶…  ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€ŠNettyè¿›é˜¶ä¹‹è·¯ï¼šè·Ÿç€æ¡ˆä¾‹å­¦Nettyã€‹  â€“ ææ—é”‹  ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€ŠNettyæºç å…¨è§£ä¸æ¶æ„æ€ç»´ã€‹ æš‚æ— </li>
</ul>
<h2 id="MQ"><a href="#MQ" class="headerlink" title="MQ"></a>MQ</h2><ul>
<li>ğŸ“–ã€ŠRocketMQå®æˆ˜ä¸åŸç†è§£æã€‹  â€“ æ¨å¼€å…ƒ</li>
<li>ğŸ“–ã€ŠRocketMQåˆ†å¸ƒå¼ä¸­é—´ä»¶ï¼šæ ¸å¿ƒåŸç†ä¸æœ€ä½³å®è·µã€‹   â€“ æä¼Ÿ  ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ğŸ“–ã€ŠRocketMQæŠ€æœ¯å†…å¹•ï¼šRocketMQæ¶æ„è®¾è®¡ä¸å®ç°åŸç†ã€‹  ã€å¾®ä¿¡è¯»ä¹¦ã€‘   æºç åˆ†æé‡ç‚¹çœ‹è¿™æœ¬</li>
</ul>
<h2 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h2><ul>
<li>ã€Šæ·±å…¥ç†è§£RPCæ¡†RPCæ¶åŸç†ä¸å®ç°ã€‹ <a href="https://pan.baidu.com/s/1sQMae0v9yGKctRsoin_dow?pwd=y3s3">ä¸‹è½½é“¾æ¥</a></li>
<li>ã€Šæ·±åº¦å‰–æApacheDubboæ ¸å¿ƒæŠ€æœ¯å†…å¹•ã€‹  â€“ ç¿Ÿé™†ç»­   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="äº‘åŸç”Ÿ"><a href="#äº‘åŸç”Ÿ" class="headerlink" title="äº‘åŸç”Ÿ"></a>äº‘åŸç”Ÿ</h2><ul>
<li>ã€ŠKubernetesç½‘ç»œæƒå¨æŒ‡å—ï¼šåŸºç¡€ï¼ŒåŸç†ä¸å®è·µã€‹ â€“ æœå†›   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€Šäº‘åŸç”ŸKuberneteså…¨æ ˆæ¶æ„å¸ˆå®æˆ˜ã€‹ â€“ æœå®½    ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="è®¡ç®—æœºåŸºç¡€"><a href="#è®¡ç®—æœºåŸºç¡€" class="headerlink" title="è®¡ç®—æœºåŸºç¡€"></a>è®¡ç®—æœºåŸºç¡€</h2><ul>
<li>ã€Šæ¼«ç”»è®¡ç®—æœºåŸç†ã€‹</li>
<li>ã€Šè®¡ç®—æœºæ—¶æ€æ ·è·‘èµ·æ¥çš„ã€‹</li>
</ul>
<h2 id="DevOps"><a href="#DevOps" class="headerlink" title="DevOps"></a>DevOps</h2><ul>
<li>ã€ŠæŒç»­äº¤ä»˜2.0ï¼šä¸šåŠ¡å¼•é¢†çš„DevOpsç²¾è¦ã€‹   â€“ ä¹”æ¢      ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="æ¶æ„-1"><a href="#æ¶æ„-1" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><ul>
<li>ã€Šå¯ä¼¸ç¼©åºŸç‰©æ¶æ„ï¼šæ¡†æ¶ä¸ä¸­é—´ä»¶ã€‹  â€“ æè‰³é¹   ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€Šç¨‹åºå‘˜å¿…è¯»ä¹‹è½¯ä»¶æ¶æ„ã€‹    ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€Šæœªæ¥æ¶æ„ï¼šä»æœåŠ¡åŒ–åˆ°äº‘åŸç”Ÿã€‹ ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
</ul>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><ul>
<li>ã€Šæ–°ç¨‹åºå‘˜04ï¼šæˆ‘ä»¬çš„æŠ€æœ¯æ—¶ä»£ï¼Œæˆ‘ä»¬çš„ç¨‹åºäººç”Ÿã€‹    ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li>ã€Šç¨‹åºå‘˜çš„ä¿®ç‚¼ä¹‹é“ï¼šé€šå‘åŠ¡å®çš„æœ€é«˜å¢ƒç•Œã€‹           ã€å¾®ä¿¡è¯»ä¹¦ã€‘</li>
<li></li>
</ul>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>book</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexoä¸­ä½¿ç”¨æ€ç»´å¯¼å›¾</title>
    <url>/2023/a8d3178908dd/index.html</url>
    <content><![CDATA[<p><a href="https://github.com/maxchang3/hexo-markmap">æ’ä»¶ä¸‹è½½åœ°å€</a></p>
]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Next7ä¸»é¢˜è‡ªå®šä¹‰åˆ†ç±»</title>
    <url>/2023/baf924a75393/index.html</url>
    <content><![CDATA[<p><a href="https://enigmatisms.github.io/2022/02/18/Hexo-NexT%E4%B8%BB%E9%A2%98-%E6%9B%B4%E5%BC%BA%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E9%A1%B5%E9%9D%A2/">å‚è€ƒæ–‡ç« </a></p>
<h2 id="æ·»åŠ ä¾èµ–åŒ…"><a href="#æ·»åŠ ä¾èµ–åŒ…" class="headerlink" title="æ·»åŠ ä¾èµ–åŒ…"></a>æ·»åŠ ä¾èµ–åŒ…</h2><figure class="highlight coffeescript"><table><tr><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-built_in">npm</span> uninstall hexo-generator-index<br><span class="hljs-built_in">npm</span> install hexo-generator-indexed<br><span class="hljs-built_in">npm</span> install hexo-pagination --save<br><span class="hljs-built_in">npm</span> install timsort --save<br></code></pre></td></tr></table></figure>
<span id="more"></span>
<h2 id="æ·»åŠ è‡ªå®šä¹‰æ–‡ä»¶"><a href="#æ·»åŠ è‡ªå®šä¹‰æ–‡ä»¶" class="headerlink" title="æ·»åŠ è‡ªå®šä¹‰æ–‡ä»¶"></a>æ·»åŠ è‡ªå®šä¹‰æ–‡ä»¶</h2><ol>
<li>å¢åŠ çš„åˆ†ç±»æ˜¯ é˜…è¯»ï¼šbook</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">menu:</span><br>  <span class="hljs-attr">home:</span> <span class="hljs-string">/</span> <span class="hljs-string">||</span> <span class="hljs-string">fa</span> <span class="hljs-string">fa-home</span><br>  <span class="hljs-attr">about:</span> <span class="hljs-string">/about/</span> <span class="hljs-string">||</span> <span class="hljs-string">fa</span> <span class="hljs-string">fa-user</span><br>  <span class="hljs-attr">tags:</span> <span class="hljs-string">/tags/</span> <span class="hljs-string">||</span> <span class="hljs-string">fa</span> <span class="hljs-string">fa-tags</span><br>  <span class="hljs-attr">categories:</span> <span class="hljs-string">/categories/</span> <span class="hljs-string">||</span> <span class="hljs-string">fa</span> <span class="hljs-string">fa-th</span><br>  <span class="hljs-attr">archives:</span> <span class="hljs-string">/archives/</span> <span class="hljs-string">||</span> <span class="hljs-string">fa</span> <span class="hljs-string">fa-archive</span><br>  <span class="hljs-comment"># schedule: /schedule/ || fa fa-calendar</span><br>  <span class="hljs-attr">book:</span> <span class="hljs-string">/book/</span> <span class="hljs-string">||</span> <span class="hljs-string">fa</span> <span class="hljs-string">fa-book</span> <span class="hljs-comment">#è¿™é‡Œæ˜¯æ–°æ·»åŠ çš„èœå•</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>åœ¨åšå®¢æ ¹ç›®å½•ä¸‹åˆ›å»º scripts ç›®å½•å¹¶åˆ›å»º <code>customcategory.js</code> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> pagination = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;hexo-pagination&#x27;</span>);<br><span class="hljs-keyword">const</span> &#123; sort &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;timsort&#x27;</span>);<br><span class="hljs-keyword">const</span> filteredCategory = <span class="hljs-string">&#x27;book&#x27;</span>;<br><br>hexo.<span class="hljs-property">extend</span>.<span class="hljs-property">generator</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">&#x27;customcategory&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">locals</span>)&#123;<br>  <span class="hljs-keyword">var</span> posts = locals.<span class="hljs-property">posts</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>) &#123;<br>    <span class="hljs-keyword">return</span> x.<span class="hljs-property">categories</span>.<span class="hljs-property">data</span>[<span class="hljs-number">0</span>].<span class="hljs-property">name</span> == filteredCategory;<br>  &#125;).<span class="hljs-title function_">sort</span>(<span class="hljs-string">&#x27;-date&#x27;</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>);				<span class="hljs-comment">// å¤åˆ¶ï¼Œè€ŒéåŸåœ°æ“ä½œ</span><br>  <span class="hljs-title function_">sort</span>(posts.<span class="hljs-property">data</span>, <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> (b.<span class="hljs-property">sticky</span> || <span class="hljs-number">0</span>) - (a.<span class="hljs-property">sticky</span> || <span class="hljs-number">0</span>));<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">pagination</span>(<span class="hljs-string">&#x27;book&#x27;</span>, posts, &#123;<br>    <span class="hljs-attr">perPage</span>: <span class="hljs-number">10</span>,<br>    <span class="hljs-attr">layout</span>: [<span class="hljs-string">&#x27;customcategory&#x27;</span>],<br>    <span class="hljs-attr">data</span>: &#123;<br>      <span class="hljs-attr">__index</span>: <span class="hljs-literal">true</span><br>    &#125;<br>  &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure>
<ol start="3">
<li>åœ¨ä¸»é¢˜çš„ layout ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶ <code>customcategory.njk</code> æ–‡ä»¶å†…å®¹å¦‚ä¸‹</li>
</ol>
<figure class="highlight django"><table><tr><td class="code"><pre><code class="hljs django"><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">extends</span></span> &#x27;_layout.njk&#x27; %&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;% <span class="hljs-name">import</span> &#x27;_macro/post-collapse.njk&#x27; <span class="hljs-keyword">as</span> post_template with context %&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;% <span class="hljs-name">import</span> &#x27;_macro/sidebar.njk&#x27; <span class="hljs-keyword">as</span> sidebar_template with context %&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">block</span></span> title %&#125;</span><span class="hljs-template-variable">&#123;&#123; __(&#x27;title.category&#x27;) &#125;&#125;</span><span class="language-xml">: </span><span class="hljs-template-variable">&#123;&#123; page.category &#125;&#125;</span><span class="language-xml"> | </span><span class="hljs-template-variable">&#123;&#123; title &#125;&#125;</span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endblock</span></span> %&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">block</span></span> class %&#125;</span><span class="language-xml">index posts-expand</span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endblock</span></span> %&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">block</span></span> content %&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml">  </span><span class="hljs-template-tag">&#123;%- <span class="hljs-name"><span class="hljs-name">for</span></span> post <span class="hljs-keyword">in</span> page.posts.toArray() %&#125;</span><span class="language-xml"></span><br><span class="language-xml">    </span><span class="hljs-template-variable">&#123;&#123; partial(&#x27;_macro/post.njk&#x27;, &#123;post: post, is_index: true&#125;) &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">  </span><span class="hljs-template-tag">&#123;%- <span class="hljs-name"><span class="hljs-name">endfor</span></span> %&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml">  </span><span class="hljs-template-tag">&#123;%- <span class="hljs-name"><span class="hljs-name">include</span></span> &#x27;_partials/pagination.njk&#x27; -%&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endblock</span></span> %&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">block</span></span> sidebar %&#125;</span><span class="language-xml"></span><br><span class="language-xml">  </span><span class="hljs-template-variable">&#123;&#123; sidebar_template.render(false) &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endblock</span></span> %&#125;</span><br></code></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>butterflyä¸»é¢˜å¤šçº§åˆ†ç±»æŠ˜å ä¸å±•å¼€</title>
    <url>/2023/acbd53e5de56/index.html</url>
    <content><![CDATA[<ol>
<li>å¼•å…¥ <code>jquery</code> å’Œ è‡ªå®šä¹‰çš„ js æ–‡ä»¶</li>
</ol>
<p>æ‰“å¼€ <code>_config.butterfly.yml</code> æ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">inject:</span><br>  <span class="hljs-attr">head:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&lt;link</span> <span class="hljs-string">rel=&quot;stylesheet&quot;</span> <span class="hljs-string">href=&quot;/cusconfig/css/hidemermaid.css?1&quot;&gt;</span><br>    <span class="hljs-comment"># å¼•å…¥jquery</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&lt;script</span> <span class="hljs-string">src=&quot;https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br>    <span class="hljs-comment"># å¼•å…¥è‡ªå®šä¹‰æ–‡ä»¶ï¼Œè‡ªå®šä¹‰æ–‡ä»¶æ”¾åœ¨åšå®¢æ ¹ç›®å½•çš„ /cusconfig/js ç›®å½•ä¸‹ï¼Œåç§°æ˜¯ category.js</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&lt;script</span> <span class="hljs-string">src=&quot;/cusconfig/js/category.js&quot;&gt;&lt;/script&gt;</span><br>  <span class="hljs-attr">bottom:</span><br>    <span class="hljs-comment"># - &lt;script src=&quot;xxxx&quot;&gt;&lt;/script&gt;</span><br>    <span class="hljs-comment"># - &lt;script src=&quot;https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>category.js æ–‡ä»¶å†…å®¹</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">$(<span class="hljs-variable language_">document</span>).<span class="hljs-title function_">ready</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>	<span class="hljs-title function_">categoryUnfold</span>();<br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">categoryUnfold</span>(<span class="hljs-params"></span>) &#123;<br>		$(<span class="hljs-string">&quot;.category-list-link&quot;</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>			<span class="hljs-keyword">if</span>($(<span class="hljs-variable language_">this</span>).<span class="hljs-title function_">siblings</span>(<span class="hljs-string">&quot;.category-list-child&quot;</span>).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>)<br>                <span class="hljs-comment">// è¿™é‡Œå¼•å…¥äº†å‘ä¸‹å±•å¼€çš„å›¾æ ‡ï¼Œå¯ä»¥ç›´æ¥ä»æœ¬ç«™ä¸‹è½½æ”¾å…¥å¯¹åº”ç›®å½•å³å¯</span><br>				$(<span class="hljs-variable language_">this</span>).<span class="hljs-title function_">parent</span>().<span class="hljs-title function_">css</span>(<span class="hljs-string">&quot;list-style-image&quot;</span>,<span class="hljs-string">&quot;url(&#x27;/cusconfig/img/category-unfold-16x16.png&#x27;&quot;</span>);<br>		&#125;);<br>		<br>		<span class="hljs-comment">//ç‚¹å‡»å«æœ‰å­æ ‡ç­¾category-list-childçš„category-list-linkæ ‡ç­¾æ—¶ï¼Œä¸è¿›è¡Œè·³è½¬</span><br>		$(<span class="hljs-string">&quot;.category-list-link&quot;</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>			<span class="hljs-keyword">return</span> $(<span class="hljs-variable language_">this</span>).<span class="hljs-title function_">siblings</span>(<span class="hljs-string">&quot;.category-list-child&quot;</span>).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span><br>		&#125;).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&quot;href&quot;</span>, <span class="hljs-string">&quot;javascript:void(0)&quot;</span>);<br>		<br>		<span class="hljs-comment">//å«æœ‰å­æ ‡ç­¾category-list-childçš„category-list-linkæ ‡ç­¾å°†è‡ªåŠ¨éšè—å­æ ‡ç­¾</span><br>		$(<span class="hljs-string">&quot;.category-list-link&quot;</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>			<span class="hljs-keyword">if</span>($(<span class="hljs-variable language_">this</span>).<span class="hljs-title function_">siblings</span>(<span class="hljs-string">&quot;.category-list-child&quot;</span>).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>)<br>				$(<span class="hljs-variable language_">this</span>).<span class="hljs-title function_">siblings</span>(<span class="hljs-string">&quot;.category-list-child&quot;</span>).<span class="hljs-title function_">hide</span>();<br>		&#125;);	<br>		<br>		<span class="hljs-comment">//ç‚¹å‡»å«æœ‰å­æ ‡ç­¾category-list-childçš„category-list-linkæ ‡ç­¾æ—¶ï¼Œå°†éšè—å­æ ‡ç­¾å±•å¼€</span><br>		$(<span class="hljs-string">&quot;.category-list-link&quot;</span>).<span class="hljs-title function_">click</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>			$(<span class="hljs-variable language_">this</span>).<span class="hljs-title function_">siblings</span>(<span class="hljs-string">&quot;.category-list-child&quot;</span>).<span class="hljs-title function_">slideToggle</span>();<br>		&#125;);<br>	&#125;<br>&#125;);<br></code></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Next8ç‰ˆæœ¬ä¸»é¢˜ä¼˜åŒ–ä¿®æ”¹çš„æ–‡ä»¶</title>
    <url>/2023/44b973fe011c/index.html</url>
    <content><![CDATA[<p><a href="https://zhuanlan.zhihu.com/p/252983030">å‚è€ƒæ–‡ç« </a></p>
<span id="more"></span>

<p>é¦–é¡µæ¯ç¯‡æ–‡ç« å˜æˆåœ†è§’ï¼Œåªéœ€è¦åœ¨ <code>styles.styl</code> ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs styles">// æ·»åŠ é¦–é¡µæ¯ç¯‡æ–‡ç« åœ†è§’ç‹¬ç«‹ start ------------<br>.post-block&#123;<br>        background-color: rgba(255, 255, 255, 1);<br>        //margin-top: 24px;<br>        margin-bottom: 24px;<br>        padding: 20px;<br>        border-radius: 30px 50px 30px 50px;<br>        box-shadow: 8px 7px 2px 0 rgba(0,0,0,0.12), 7px 4px 1px -2px rgba(0,0,0,0.06), 0 1px 5px 0 rgba(0,0,0,0.12);<br>&#125;<br>// æ·»åŠ é¦–é¡µæ¯ç¯‡æ–‡ç« åœ†è§’ç‹¬ç«‹ end ------------<br></code></pre></td></tr></table></figure>
<p><code>styles.styl</code> åœ¨åšå®¢æ ¹ç›®å½•ä¸‹çš„ï¼Œ<code>source/_data</code> ä¸‹ï¼Œè‹¥æ²¡æœ‰åˆ™éœ€è¦è‡ªå·±åˆ›å»ºå¹¶ä¸”åœ¨ <code>next</code> ä¸»é¢˜çš„ <code>_config.yml</code> ä¸­æ‰“å¼€ä¸‹é¢çš„æ³¨é‡Š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">custom_file_path:</span><br>  <span class="hljs-comment">#head: source/_data/head.njk</span><br>  <span class="hljs-comment">#header: source/_data/header.njk</span><br>  <span class="hljs-attr">style:</span> <span class="hljs-string">source/_data/styles.styl</span><br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>butterflyä¸»é¢˜å½’æ¡£åˆ†ç±»é¡µé¢å±•ç¤ºæˆåŒæ </title>
    <url>/2023/e641424208d5/index.html</url>
    <content><![CDATA[<ol>
<li>åœ¨ åšå®¢æ ¹ç›®å½•çš„ <code>source</code> ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹ <code>cusconfig/css</code>, å¹¶åˆ›å»ºæ–‡ä»¶, <code>cus_butterfly.css</code>, æ·»åŠ å¦‚ä¸‹å†…å®¹</li>
</ol>
<figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* å½’æ¡£ï¼Œåˆ†ç±»æ–‡æ¡£é¡µé¢è®¾ç½®åŒæ å±•ç¤ºï¼Œ å¢åŠ è¾¹æ¡† */</span><br><span class="hljs-selector-class">.no-article-cover</span> &#123;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-number">48%</span>;<br>    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> dashed lightblue;<br>    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">241</span>, <span class="hljs-number">242</span>, <span class="hljs-number">246</span>, <span class="hljs-number">0.5</span>);<br>    <span class="hljs-attribute">float</span>: left;<br>&#125;<br><br><span class="hljs-selector-class">.article-sort-item</span><span class="hljs-selector-class">.year</span> &#123;<br>    <span class="hljs-attribute">clear</span>: both;<br>&#125;<br><br><span class="hljs-selector-id">#pagination</span> &#123;<br>    <span class="hljs-attribute">clear</span>:both;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>å¼•å…¥è‡ªå®šä¹‰ <code>css</code> æ–‡ä»¶ï¼Œ æ‰“å¼€ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>_config.butterfly.yml</code>, æ·»åŠ å¦‚ä¸‹å†…å®¹</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">inject:</span><br>  <span class="hljs-attr">head:</span><br>    <span class="hljs-comment"># æ·»åŠ ä¸‹é¢è¿™è¡Œå†…å®¹å¼•å…¥è‡ªå®šä¹‰ js</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&lt;link</span> <span class="hljs-string">rel=&quot;stylesheet&quot;</span> <span class="hljs-string">href=&quot;/cusconfig/css/cus_butterfly.css?1&quot;&gt;</span><br></code></pre></td></tr></table></figure>

<h1 id="å»æ‰æ–‡æ¡£å‰é¢çš„ç‚¹å’Œç«–çº¿"><a href="#å»æ‰æ–‡æ¡£å‰é¢çš„ç‚¹å’Œç«–çº¿" class="headerlink" title="å»æ‰æ–‡æ¡£å‰é¢çš„ç‚¹å’Œç«–çº¿"></a>å»æ‰æ–‡æ¡£å‰é¢çš„ç‚¹å’Œç«–çº¿</h1><p>ä¿®æ”¹ <code>archives.styl</code> æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶è·¯å¾„ä¸º <code>åšå®¢æ ¹ç›®å½•/themes/butterfly/source/css_page</code> ä¸‹é¢ï¼Œ æœ‰æ³¨é‡Šçš„åœ°æ–¹ä»£è¡¨ä¿®æ”¹è¿‡</p>
<figure class="highlight nestedtext"><table><tr><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">.article-sort</span><br><span class="hljs-attribute">  margin-left</span><span class="hljs-punctuation">:</span> <span class="hljs-string">10px</span><br>  <span class="hljs-attribute">padding-left</span><span class="hljs-punctuation">:</span> <span class="hljs-string">20px</span><br>  <span class="hljs-attribute">// border-left</span><span class="hljs-punctuation">:</span> <span class="hljs-string">2px solid lighten($light-blue, 20)   è¿™ä¸€è¡Œæ³¨é‡Šæ‰ï¼Œè¿™é‡Œå»æ‰ç«–çº¿</span><br><br>  <span class="hljs-attribute">&amp;-title</span><br><span class="hljs-attribute">    position</span><span class="hljs-punctuation">:</span> <span class="hljs-string">relative</span><br>    <span class="hljs-attribute">margin-left</span><span class="hljs-punctuation">:</span> <span class="hljs-string">10px</span><br>    <span class="hljs-attribute">padding-bottom</span><span class="hljs-punctuation">:</span> <span class="hljs-string">20px</span><br>    <span class="hljs-attribute">padding-left</span><span class="hljs-punctuation">:</span> <span class="hljs-string">20px</span><br>    <span class="hljs-attribute">font-size</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1.72em</span><br><br>    &amp;:hover<br>      &amp;:before<br>        <span class="hljs-attribute">border-color</span><span class="hljs-punctuation">:</span> <span class="hljs-string">var(--pseudo-hover)</span><br><br>    &amp;:before<br>      <span class="hljs-attribute">position</span><span class="hljs-punctuation">:</span> <span class="hljs-string">absolute</span><br>      <span class="hljs-attribute">top</span><span class="hljs-punctuation">:</span> <span class="hljs-string">calc(((100% - 36px) / 2))</span><br>      <span class="hljs-attribute">left</span><span class="hljs-punctuation">:</span> <span class="hljs-string">-9px</span><br>      <span class="hljs-attribute">z-index</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1</span><br>      <span class="hljs-attribute">width</span><span class="hljs-punctuation">:</span> <span class="hljs-string">w = 10px</span><br>      <span class="hljs-attribute">height</span><span class="hljs-punctuation">:</span> <span class="hljs-string">h = w</span><br>      <span class="hljs-attribute">border</span><span class="hljs-punctuation">:</span> <span class="hljs-string">.5 * w solid $light-blue</span><br>      <span class="hljs-attribute">border-radius</span><span class="hljs-punctuation">:</span> <span class="hljs-string">w</span><br>      <span class="hljs-attribute">background</span><span class="hljs-punctuation">:</span> <span class="hljs-string">var(--card-bg)</span><br>      <span class="hljs-attribute">content</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&#x27;&#x27;</span><br>      <span class="hljs-attribute">line-height</span><span class="hljs-punctuation">:</span> <span class="hljs-string">h</span><br>      <span class="hljs-attribute">transition</span><span class="hljs-punctuation">:</span> <span class="hljs-string">all .2s ease-in-out</span><br><br>    &amp;:after<br>      <span class="hljs-attribute">position</span><span class="hljs-punctuation">:</span> <span class="hljs-string">absolute</span><br>      <span class="hljs-attribute">bottom</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0</span><br>      <span class="hljs-attribute">left</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0</span><br>      <span class="hljs-attribute">z-index</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0</span><br>      <span class="hljs-attribute">width</span><span class="hljs-punctuation">:</span> <span class="hljs-string">2px</span><br>      <span class="hljs-attribute">height</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1.5em</span><br>      <span class="hljs-attribute">background</span><span class="hljs-punctuation">:</span> <span class="hljs-string">lighten($light-blue, 20)</span><br>      <span class="hljs-attribute">content</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&#x27;&#x27;</span><br><br>  <span class="hljs-attribute">&amp;-item</span><br><span class="hljs-attribute">    position</span><span class="hljs-punctuation">:</span> <span class="hljs-string">relative</span><br>    <span class="hljs-attribute">display</span><span class="hljs-punctuation">:</span> <span class="hljs-string">flex</span><br>    <span class="hljs-attribute">align-items</span><span class="hljs-punctuation">:</span> <span class="hljs-string">center</span><br>    <span class="hljs-attribute">margin</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0 0 20px 10px</span><br>    <span class="hljs-attribute">transition</span><span class="hljs-punctuation">:</span> <span class="hljs-string">all .2s ease-in-out</span><br><br>    &amp;:hover<br>      &amp;:before<br>        <span class="hljs-attribute">border-color</span><span class="hljs-punctuation">:</span> <span class="hljs-string">var(--pseudo-hover)</span><br><br>    /* &amp;:before   è¿™ä¸€æ•´å—éƒ½æ³¨é‡Šæ‰ï¼Œè¿™é‡Œæ˜¯å»æ‰æ–‡ç« å‰é¢çš„ç‚¹<br>      <span class="hljs-attribute">$w = 6px</span><br><span class="hljs-attribute">      position</span><span class="hljs-punctuation">:</span> <span class="hljs-string">absolute</span><br>      <span class="hljs-attribute">left</span><span class="hljs-punctuation">:</span> <span class="hljs-string">calc(-20px - 17px)</span><br>      <span class="hljs-attribute">width</span><span class="hljs-punctuation">:</span> <span class="hljs-string">w = $w</span><br>      <span class="hljs-attribute">height</span><span class="hljs-punctuation">:</span> <span class="hljs-string">h = w</span><br>      <span class="hljs-attribute">border</span><span class="hljs-punctuation">:</span> <span class="hljs-string">.5 * w solid $light-blue</span><br>      <span class="hljs-attribute">border-radius</span><span class="hljs-punctuation">:</span> <span class="hljs-string">w</span><br>      <span class="hljs-attribute">background</span><span class="hljs-punctuation">:</span> <span class="hljs-string">var(--card-bg)</span><br>      <span class="hljs-attribute">content</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&#x27;&#x27;</span><br>      <span class="hljs-attribute">transition</span><span class="hljs-punctuation">:</span> <span class="hljs-string">all .2s ease-in-out */</span><br><br>    <span class="hljs-attribute">&amp;.no-article-cover</span><br><span class="hljs-attribute">      height</span><span class="hljs-punctuation">:</span> <span class="hljs-string">80px</span><br><br>      <span class="hljs-attribute">.article-sort-item-info</span><br><span class="hljs-attribute">        padding</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0</span><br><br>    <span class="hljs-attribute">&amp;.year</span><br><span class="hljs-attribute">      font-size</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1.43em</span><br><br>      &amp;:hover<br>        &amp;:before<br>          <span class="hljs-attribute">border-color</span><span class="hljs-punctuation">:</span> <span class="hljs-string">$light-blue</span><br><br>      &amp;:before<br>        <span class="hljs-attribute">border-color</span><span class="hljs-punctuation">:</span> <span class="hljs-string">var(--pseudo-hover)</span><br><br>    <span class="hljs-attribute">&amp;-time</span><br><span class="hljs-attribute">      color</span><span class="hljs-punctuation">:</span> <span class="hljs-string">$theme-meta-color</span><br>      <span class="hljs-attribute">font-size</span><span class="hljs-punctuation">:</span> <span class="hljs-string">95%</span><br><br>      <span class="hljs-attribute">time</span><br><span class="hljs-attribute">        padding-left</span><span class="hljs-punctuation">:</span> <span class="hljs-string">6px</span><br>        <span class="hljs-attribute">cursor</span><span class="hljs-punctuation">:</span> <span class="hljs-string">default</span><br><br>    <span class="hljs-attribute">&amp;-title</span><br><span class="hljs-attribute">      @extend .limit-more-line</span><br><span class="hljs-attribute">      color</span><span class="hljs-punctuation">:</span> <span class="hljs-string">var(--font-color)</span><br>      <span class="hljs-attribute">font-size</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1.1em</span><br>      <span class="hljs-attribute">transition</span><span class="hljs-punctuation">:</span> <span class="hljs-string">all .3s</span><br>      <span class="hljs-attribute">-webkit-line-clamp</span><span class="hljs-punctuation">:</span> <span class="hljs-string">2</span><br><br>      &amp;:hover<br>        <span class="hljs-attribute">color</span><span class="hljs-punctuation">:</span> <span class="hljs-string">$text-hover</span><br>        <span class="hljs-attribute">transform</span><span class="hljs-punctuation">:</span> <span class="hljs-string">translateX(10px)</span><br><br>    <span class="hljs-attribute">&amp;-img</span><br><span class="hljs-attribute">      overflow</span><span class="hljs-punctuation">:</span> <span class="hljs-string">hidden</span><br>      <span class="hljs-attribute">width</span><span class="hljs-punctuation">:</span> <span class="hljs-string">80px</span><br>      <span class="hljs-attribute">height</span><span class="hljs-punctuation">:</span> <span class="hljs-string">80px</span><br><br>      :first-child<br>        <span class="hljs-attribute">@extend .imgHover</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">    &amp;-info</span><br><span class="hljs-attribute">      flex</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1</span><br>      <span class="hljs-attribute">padding</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0 16px</span><br><br></code></pre></td></tr></table></figure>




]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>butterflyæ ‡ç­¾é¡µå›ºå®šæ¯è¡Œä¸ªæ•°</title>
    <url>/2023/1099169ec3c6/index.html</url>
    <content><![CDATA[<ol>
<li><p>å¯ä»¥å…ˆå‚è€ƒå¦‚ä¸‹æ–‡ç« æ·»åŠ è‡ªå®šä¹‰ <code>css</code> æ–‡ä»¶</p>
<ol><li><a href="/2023/e641424208d5/index.html" title="butterflyä¸»é¢˜å½’æ¡£åˆ†ç±»é¡µé¢å±•ç¤ºæˆåŒæ ">butterflyä¸»é¢˜å½’æ¡£åˆ†ç±»é¡µé¢å±•ç¤ºæˆåŒæ </a></li></ol>
</li>
<li><p>åœ¨ <code>cus_butterfly.css</code> æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹</p>
</li>
</ol>
<figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* ä¿®æ”¹æ ‡ç­¾é¡µï¼Œæ¯ä¸ªæ ‡ç­¾å®½åº¦å›ºå®š  start -------------- */</span><br><span class="hljs-selector-class">.tag-cloud-list</span> &#123;<br>    <span class="hljs-attribute">display</span>: flex;<br>    <span class="hljs-attribute">flex-wrap</span>: wrap;<br>&#125;<br><br><span class="hljs-comment">/* æ¯è¡Œæ”¾5ä¸ªæ ‡ç­¾ */</span><br><span class="hljs-selector-class">.tag-cloud-list</span> <span class="hljs-selector-tag">a</span> &#123;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-number">20%</span>;<br>    <span class="hljs-attribute">text-align</span>: center;<br>&#125;<br><br><span class="hljs-comment">/* ä¿®æ”¹æ ‡ç­¾é¡µï¼Œæ¯ä¸ªæ ‡ç­¾å®½åº¦å›ºå®š  end -------------- */</span><br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>hexoä½¿ç”¨æ’å…¥æœ¬åœ°å›¾ç‰‡è·¯å¾„é—®é¢˜</title>
    <url>/2023/563e23df91d3/index.html</url>
    <content><![CDATA[<p>Hexo version: 7.0<br>Next version: 8.18</p>
<span id="more"></span>
<ol>
<li>å®‰è£…æ’ä»¶</li>
</ol>
<figure class="highlight ada"><table><tr><td class="code"><pre><code class="hljs ada">npm install hexo-renderer-marked <span class="hljs-comment">--save</span><br></code></pre></td></tr></table></figure>
<ol start="2">
<li>ä¿®æ”¹ hexo é…ç½®æ–‡ä»¶ <code>_config.yml</code> (ä¸æ˜¯next ä¸»é¢˜çš„é…ç½®æ–‡ä»¶)</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># è¿™æ ·æ–‡ç« ç”Ÿæˆçš„è·¯å¾„ä¼šæ˜¯å¹´/æœˆ/æ—¥/hashå€¼å½¢å¼</span><br><span class="hljs-attr">permalink:</span> <span class="hljs-string">:year/:month/:day/:hash/</span><br><span class="hljs-comment"># å¼€å¯èµ„æºæ–‡ä»¶å¤¹åŠŸèƒ½</span><br><span class="hljs-attr">post_asset_folder:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">marked:</span><br>  <span class="hljs-comment"># è¿™ä¸¤ä¸ªå€¼éƒ½é…ç½®ä¸ºfalseï¼Œç½‘ä¸Šå¾ˆå¤šæ–‡ç« é…ç½®æˆtrueï¼Œå¯èƒ½æ˜¯ä¸åŒç‰ˆæœ¬æ•ˆæœä¸åŒï¼Œåœ¨ Next8.18, hexo7 è¿™ä¸ªç‰ˆæœ¬è‹¥é…ç½®æˆtrueï¼Œå›¾ç‰‡è·¯å¾„ä¼šå¤šäº†æ—¥æœŸå¯¼è‡´æ˜¾ç¤ºå¤±è´¥ </span><br>  <span class="hljs-attr">prependRoot:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">postAsset:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>åœ¨ md æ–‡ç« ç›®å½•ä¸­åˆ›å»ºåŒåçš„æ–‡ä»¶å¤¹ï¼Œæ¯”å¦‚å½“å‰è¿™ç¯‡æ–‡ç« çš„åç§°æ˜¯ <code>hexoæ’å…¥æœ¬åœ°å›¾ç‰‡è·¯å¾„é—®é¢˜</code>ï¼Œ é‚£å°±éœ€è¦åœ¨è¿™ç¯‡æ–‡ç« çš„åŒçº§ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåŒåçš„æ–‡ä»¶å¤¹ï¼Œç„¶åå›¾ç‰‡å°±æ”¾åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­</li>
<li>åœ¨ä½¿ç”¨ md è¯­æ³•å¼•å…¥å›¾ç‰‡çš„æ—¶å€™ï¼Œå› ä¸ºå›¾ç‰‡æ˜¯æ”¾åœ¨ç›®å½•ä¸­ï¼ˆå’Œæ–‡ç« åŒåçš„é‚£ä¸ªç›®å½•ï¼‰ï¼Œä½†æ˜¯å¦‚æœåœ¨æœ¬åœ° vscode ä¸­å°†ç›®å½•ä¹ŸåŠ ä¸Šï¼Œè™½ç„¶æœ¬åœ°å¯ä»¥è®¿é—®ï¼Œä½†æ˜¯ hexo g ç”Ÿæˆä¹‹åï¼Œè®¿é—®åšå®¢åœ°å€æ˜¯æ— æ³•è®¿é—®çš„ï¼Œæ‰€ä»¥æœ¬åœ°å¼•å…¥å›¾ç‰‡çš„æ—¶å€™åªèƒ½å†™å›¾ç‰‡çš„æ–‡ä»¶åï¼Œä¸è¦è·¯å¾„ï¼Œè¿™æ ·è™½ç„¶æœ¬åœ°æ— æ³•é¢„è§ˆï¼Œä½†æ˜¯ hexo s å’Œ hexo d ä¹‹åçš„ç»“æœéƒ½å¯ä»¥æ­£å¸¸æŸ¥çœ‹</li>
</ol>
]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>hexoå’ŒNextä¸»é¢˜ä¿®æ”¹</title>
    <url>/2023/52739010ef7c/index.html</url>
    <content><![CDATA[<h1 id="hexoä¸­-Nextä¸»é¢˜ç›¸å…³ä¿®æ”¹"><a href="#hexoä¸­-Nextä¸»é¢˜ç›¸å…³ä¿®æ”¹" class="headerlink" title="hexoä¸­ Nextä¸»é¢˜ç›¸å…³ä¿®æ”¹"></a>hexoä¸­ Nextä¸»é¢˜ç›¸å…³ä¿®æ”¹</h1><h2 id="æ–‡ç« ç›®å½•é»˜è®¤å±•å¼€"><a href="#æ–‡ç« ç›®å½•é»˜è®¤å±•å¼€" class="headerlink" title="æ–‡ç« ç›®å½•é»˜è®¤å±•å¼€"></a>æ–‡ç« ç›®å½•é»˜è®¤å±•å¼€</h2><p>åŸºäº Next7.x ç‰ˆæœ¬</p>
<ol>
<li>ä¸»é¢˜é…ç½®æ–‡ä»¶ _config.yml ä¸­æœç´¢ custom_file_path,çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼Œæ‰“å¼€ style é‚£ä¸€è¡Œçš„æ³¨é‡Š</li>
</ol>
<figure class="highlight yml"><table><tr><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">custom_file_path:</span><br>  <span class="hljs-comment">#head: source/_data/head.swig</span><br>  <span class="hljs-comment">#header: source/_data/header.swig</span><br>  <span class="hljs-comment">#sidebar: source/_data/sidebar.swig</span><br>  <span class="hljs-comment">#postMeta: source/_data/post-meta.swig</span><br>  <span class="hljs-comment">#postBodyEnd: source/_data/post-body-end.swig</span><br>  <span class="hljs-comment">#footer: source/_data/footer.swig</span><br>  <span class="hljs-comment">#bodyEnd: source/_data/body-end.swig</span><br>  <span class="hljs-comment">#variable: source/_data/variables.styl</span><br>  <span class="hljs-comment">#mixin: source/_data/mixins.styl</span><br>  <span class="hljs-attr">style:</span> <span class="hljs-string">source/_data/styles.styl</span><br></code></pre></td></tr></table></figure>
<span id="more"></span>
<ol start="2">
<li>åœ¨é¡¹ç›®æ ¹ç›®å½•(æ³¨æ„è¿™é‡Œä¸æ˜¯åœ¨ä¸»é¢˜ç›®å½•ä¸‹æ–°å»º)ä¸‹çš„ source ç›®å½•ä¸‹æ–°å»º _data ç›®å½•ï¼Œå¹¶ä¸”åˆ›å»º style.styl æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</li>
</ol>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">//æ–‡ç« ç›®å½•é»˜è®¤å±•å¼€</span><br><span class="hljs-selector-class">.post-toc</span> <span class="hljs-selector-class">.nav</span> <span class="hljs-selector-class">.nav-child</span> &#123; <br>    <span class="hljs-attribute">display</span>: block; <br>&#125;<br><span class="hljs-comment">//æ–‡ç« ç›®å½•å­—ä½“å¤§å°è°ƒæ•´</span><br><span class="hljs-selector-class">.post-toc</span> <span class="hljs-selector-tag">ol</span> &#123;  <br>    <span class="hljs-attribute">font-size</span> : <span class="hljs-number">14px</span>;     <br>&#125;<br></code></pre></td></tr></table></figure>
<ol start="3">
<li>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ _config.yml, æœç´¢ toc ä¿®æ”¹å†…å®¹å¦‚ä¸‹</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># æ–‡ç« ç›®å½•</span><br><span class="hljs-attr">toc:</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">number:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">wrap:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<h2 id="æ·»åŠ æœç´¢åŠŸèƒ½"><a href="#æ·»åŠ æœç´¢åŠŸèƒ½" class="headerlink" title="æ·»åŠ æœç´¢åŠŸèƒ½"></a>æ·»åŠ æœç´¢åŠŸèƒ½</h2><ol>
<li>å®‰è£…ä¾èµ–</li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">npm install hexo<span class="hljs-operator">-</span>generator<span class="hljs-operator">-</span><span class="hljs-keyword">search</span> <span class="hljs-comment">--save</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>åœ¨å…¨å±€é…ç½®æ–‡ä»¶ _config.yml ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹</li>
</ol>
<figure class="highlight dts"><table><tr><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">search:</span><br><span class="hljs-symbol">  path:</span> search.xml<br><span class="hljs-symbol">  field:</span> post<br><span class="hljs-symbol">  format:</span> html<br><span class="hljs-symbol">  limit:</span> <span class="hljs-number">10000</span><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ _config.ymlï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ Next ä¸»é¢˜, æœç´¢ local_search å°† enable: false æ”¹æˆ true</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">local_search:</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<ol start="4">
<li>é‡æ–°ç”Ÿæˆ</li>
</ol>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">hexo clean</span><br><span class="hljs-attribute">hexo g</span><br></code></pre></td></tr></table></figure>



<h2 id="æ–°å»ºèœå•ä»¥åŠæ·»åŠ èœå•å›¾æ ‡"><a href="#æ–°å»ºèœå•ä»¥åŠæ·»åŠ èœå•å›¾æ ‡" class="headerlink" title="æ–°å»ºèœå•ä»¥åŠæ·»åŠ èœå•å›¾æ ‡"></a>æ–°å»ºèœå•ä»¥åŠæ·»åŠ èœå•å›¾æ ‡</h2><p><a href="http://theme-next.iissnan.com/getting-started.html#menu-settings">nextå®˜ç½‘</a></p>
<p>åœ¨å®˜ç½‘ä¸­æŸ¥çœ‹ä¸»é¢˜è®¾å®š-&gt;èœå•é‚£éƒ¨åˆ†ï¼Œå½“æˆ‘ä»¬æ–°æ·»åŠ ä¸€ä¸ªèœå•æ˜¯(æ¯”å¦‚æˆ‘è¦æ·»åŠ é˜…è¯»)ï¼Œåœ¨<code>next</code>çš„é…ç½®æ–‡ä»¶ä¸­(<code>_config.yml</code>)é‡Œé¢æ‰¾åˆ°ä¸‹é¢çš„é…ç½®ï¼š</p>
<p>Next8.x ç‰ˆæœ¬</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">menu:</span><br>  <span class="hljs-attr">home:</span> <span class="hljs-string">/</span> <span class="hljs-string">||</span> <span class="hljs-string">fa</span> <span class="hljs-string">fa-home</span><br>  <span class="hljs-attr">about:</span> <span class="hljs-string">/about/</span> <span class="hljs-string">||</span> <span class="hljs-string">fa</span> <span class="hljs-string">fa-user</span><br>  <span class="hljs-attr">tags:</span> <span class="hljs-string">/tags/</span> <span class="hljs-string">||</span> <span class="hljs-string">fa</span> <span class="hljs-string">fa-tags</span><br>  <span class="hljs-attr">categories:</span> <span class="hljs-string">/categories/</span> <span class="hljs-string">||</span> <span class="hljs-string">fa</span> <span class="hljs-string">fa-th</span><br>  <span class="hljs-attr">archives:</span> <span class="hljs-string">/archives/</span> <span class="hljs-string">||</span> <span class="hljs-string">fa</span> <span class="hljs-string">fa-archive</span><br>  <span class="hljs-comment"># schedule: /schedule/ || fa fa-calendar</span><br>  <span class="hljs-attr">book:</span> <span class="hljs-string">/book/</span> <span class="hljs-string">||</span> <span class="hljs-string">fa</span> <span class="hljs-string">fa-book</span> <span class="hljs-comment">#è¿™é‡Œæ˜¯æ–°æ·»åŠ çš„èœå•</span><br><br><span class="hljs-comment"># Enable/Disable menu icons.</span><br><span class="hljs-attr">menu_icons:</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">book:</span> <span class="hljs-string">bookï¼ˆè¿™é‡Œæ˜¯å›¾æ ‡ï¼‰</span><br></code></pre></td></tr></table></figure>

<p>ç„¶ååœ¨å¼€å¯çš„å¯¹åº”çš„è¯­è¨€æ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚æˆ‘ä½¿ç”¨çš„æ˜¯ä¸­æ–‡ï¼Œé‚£ä¹ˆå°±æ˜¯åœ¨<code>zh-CN.yml</code>æ–‡ä»¶ä¸­æ‰¾åˆ°<code>menu</code>ï¼š</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">menu:</span><br>  <span class="hljs-attr">home:</span> <span class="hljs-string">é¦–é¡µ</span><br>  <span class="hljs-attr">archives:</span> <span class="hljs-string">å½’æ¡£</span><br>  <span class="hljs-attr">categories:</span> <span class="hljs-string">åˆ†ç±»</span><br>  <span class="hljs-attr">tags:</span> <span class="hljs-string">æ ‡ç­¾</span><br>  <span class="hljs-attr">search:</span> <span class="hljs-string">æœç´¢</span><br>  <span class="hljs-attr">book:</span> <span class="hljs-string">é˜…è¯»</span><br></code></pre></td></tr></table></figure>

<p>åé¢çš„booké‚£ä¸€æ æ˜¯åæ¥æ·»åŠ çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯åœ¨ä¸Šé¢çš„ç¬¬ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­æ‰€å†™çš„<code>book</code>æ˜¯<a href="http://fontawesome.io/">Font Awesome</a>ä¸­<code>icon</code>çš„åç§°ï¼Œè¿™æ ·æ‰å¯ä»¥åœ¨æˆ‘ä»¬è‡ªå·±çš„é¡µé¢æ˜¾ç¤ºå‡ºå›¾æ ‡ã€‚</p>
<p>åœ¨ <code>source/</code> ç›®å½•ä¸‹åˆ›å»ºç›®å½• <code>book</code>,  ç„¶ååœ¨ <code>source/book</code> ç›®å½•ä¸‹åˆ›å»º <code>index.md</code>, å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">title:</span> <span class="hljs-string">book</span><br><span class="hljs-attr">date:</span> <span class="hljs-number">2023-11-10 21:12:59</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">book</span><br><span class="hljs-attr">comments:</span> <span class="hljs-literal">true</span><br><span class="hljs-meta">---</span><br></code></pre></td></tr></table></figure>

<h2 id="æ·»åŠ ç¤¾äº¤åŠŸèƒ½ä¹‹é‚®ç®±"><a href="#æ·»åŠ ç¤¾äº¤åŠŸèƒ½ä¹‹é‚®ç®±" class="headerlink" title="æ·»åŠ ç¤¾äº¤åŠŸèƒ½ä¹‹é‚®ç®±"></a>æ·»åŠ ç¤¾äº¤åŠŸèƒ½ä¹‹é‚®ç®±</h2><p>åœ¨nextä¸»é¢˜é…ç½®æ–‡ä»¶æœç´¢social:</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">social:</span><br>  <span class="hljs-attr">E-Mail:</span> <span class="hljs-string">mailto:1744709138@qq.com</span> <span class="hljs-string">||</span> <span class="hljs-string">envelope</span><br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œåªæ˜¯æ˜¾ç¤ºäº†é‚®ç®±ï¼Œè¿™äº›åŸæ¥éƒ½æ˜¯æ³¨é‡Šæ‰çš„ï¼Œè‡ªå·±å»æ‰å‰é¢çš„æ³¨é‡Šå³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯é‚®ç®±å‰é¢çš„<code>mailto</code>æ˜¯å¿…é¡»è¦ä¿ç•™çš„ï¼Œè¿˜æœ‰æœ€åé¢çš„<code>envelope</code>åˆ™æ˜¯å›¾æ ‡åå­—ï¼Œä¹Ÿæ˜¯ä¸èƒ½ä¿®æ”¹çš„ã€‚</p>
<h2 id="å‹æƒ…é“¾æ¥çš„é…ç½®"><a href="#å‹æƒ…é“¾æ¥çš„é…ç½®" class="headerlink" title="å‹æƒ…é“¾æ¥çš„é…ç½®"></a>å‹æƒ…é“¾æ¥çš„é…ç½®</h2><p>åœ¨<code>next</code>ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­æŸ¥æ‰¾æ ‡ç­¾<code>links</code>å¹¶è¿›è¡Œå¦‚ä¸‹é…ç½®:</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># title</span><br><span class="hljs-attr">links_title:</span> <span class="hljs-string">Links</span><br><span class="hljs-attr">links:</span><br>  <span class="hljs-attr">MacTalk:</span> <span class="hljs-string">http://macshuo.com/</span><br>  <span class="hljs-attr">Title:</span> <span class="hljs-string">http://example.com/</span><br></code></pre></td></tr></table></figure>

<h2 id="Next8-å¢åŠ è¯„è®ºåŠŸèƒ½ï¼ˆvalineï¼‰"><a href="#Next8-å¢åŠ è¯„è®ºåŠŸèƒ½ï¼ˆvalineï¼‰" class="headerlink" title="Next8 å¢åŠ è¯„è®ºåŠŸèƒ½ï¼ˆvalineï¼‰"></a>Next8 å¢åŠ è¯„è®ºåŠŸèƒ½ï¼ˆvalineï¼‰</h2><p>åœ¨ Next8.1.0 ä¸­ç§»é™¤äº† valine, <a href="https://github.com/next-theme/hexo-theme-next/issues/4">å‚è€ƒç½‘å€</a><br>å¦‚æœè¿˜éœ€è¦ç»§ç»­ä½¿ç”¨ï¼Œå®˜æ–¹æœ‰æä¾›æ’ä»¶ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹</p>
<ol>
<li>å®‰è£…æ’ä»¶ <code>npm install hexo-next-valine --save</code></li>
<li>ç¼–è¾‘ Next ä¸»é¢˜ _config.yml æ–‡ä»¶ï¼Œæ‰¾åˆ° <code>comments:</code> æ ‡ç­¾ï¼Œåœ¨ä¸‹é¢æ·»åŠ  valine ç›¸å…³è®¾ç½®</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">comments:</span><br>  <span class="hljs-comment"># Available values: tabs | buttons</span><br>  <span class="hljs-attr">style:</span> <span class="hljs-string">tabs</span><br>  <span class="hljs-attr">active:</span> <span class="hljs-string">valine</span><br><br><span class="hljs-attr">valine:</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">appId:</span> <span class="hljs-string">è®¾ç½®apiId</span><br>  <span class="hljs-attr">appKey:</span> <span class="hljs-string">è®¾ç½®apiKey</span><br>  <span class="hljs-attr">serverURLs:</span> <span class="hljs-string">https://leancloud.cn</span> <span class="hljs-comment"># When the custom domain name is enabled, fill it in here</span><br>  <span class="hljs-attr">placeholder:</span> <span class="hljs-string">æœŸå¾…ä¸æ‚¨çš„äº¤æµ</span> <span class="hljs-comment"># Comment box placeholder</span><br>  <span class="hljs-attr">avatar:</span> <span class="hljs-string">mm</span> <span class="hljs-comment"># Gravatar style</span><br>  <span class="hljs-attr">meta:</span> [<span class="hljs-string">nick</span>, <span class="hljs-string">mail</span>, <span class="hljs-string">link</span>] <span class="hljs-comment"># Custom comment header</span><br>  <span class="hljs-attr">pageSize:</span> <span class="hljs-number">10</span> <span class="hljs-comment"># Pagination size</span><br>  <span class="hljs-attr">lang:</span> <span class="hljs-comment"># Language, available values: en, zh-cn</span><br>  <span class="hljs-attr">visitor:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># Article reading statistic</span><br>  <span class="hljs-attr">comment_count:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># If false, comment count will only be displayed in post page, not in home page</span><br>  <span class="hljs-attr">recordIP:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># Whether to record the commenter IP</span><br>  <span class="hljs-attr">enableQQ:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># Whether to enable the Nickname box to automatically get QQ Nickname and QQ Avatar</span><br>  <span class="hljs-attr">requiredFields:</span> []<br></code></pre></td></tr></table></figure>

<h2 id="æ·»åŠ è¿‘æœŸæ–‡ç« å±•ç¤º"><a href="#æ·»åŠ è¿‘æœŸæ–‡ç« å±•ç¤º" class="headerlink" title="æ·»åŠ è¿‘æœŸæ–‡ç« å±•ç¤º"></a>æ·»åŠ è¿‘æœŸæ–‡ç« å±•ç¤º</h2><p><a href="https://blog.csdn.net/wugenqiang/article/details/88581218">æŸ¥çœ‹è½¬è½½æ–‡ç« </a></p>
<h2 id="æ˜¾ç¤ºæ–‡ç« çš„æ›´æ–°æ—¶é—´"><a href="#æ˜¾ç¤ºæ–‡ç« çš„æ›´æ–°æ—¶é—´" class="headerlink" title="æ˜¾ç¤ºæ–‡ç« çš„æ›´æ–°æ—¶é—´"></a>æ˜¾ç¤ºæ–‡ç« çš„æ›´æ–°æ—¶é—´</h2><p>åœ¨ä¸»é¢˜çš„é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°<code>updated_at</code>ï¼Œç„¶åå°†å…¶å€¼ä¿®æ”¹ä¸º<code>true</code>å³å¯(è¿™ç§æ–¹å¼åº”è¯¥æ˜¯é€‚ç”¨äº5ä»¥åçš„ç‰ˆæœ¬)</p>
<p>å¯¹äºä»¥å‰çš„æ–¹å¼å¯ä»¥çœ‹è¿™ç¯‡<a href="https://blog.csdn.net/ganzhilin520/article/details/79053399">åˆ«äººå†™çš„æ–‡ç« </a></p>
<h2 id="å­—æ•°ç»Ÿè®¡ä¸é˜…è¯»æ—¶é•¿"><a href="#å­—æ•°ç»Ÿè®¡ä¸é˜…è¯»æ—¶é•¿" class="headerlink" title="å­—æ•°ç»Ÿè®¡ä¸é˜…è¯»æ—¶é•¿"></a>å­—æ•°ç»Ÿè®¡ä¸é˜…è¯»æ—¶é•¿</h2><p><a href="https://www.cnblogs.com/php-linux/p/8418518.html">æŸ¥çœ‹è½¬è½½æ–‡ç« </a></p>
<h2 id="æ·»åŠ ç‰ˆæƒä¿¡æ¯"><a href="#æ·»åŠ ç‰ˆæƒä¿¡æ¯" class="headerlink" title="æ·»åŠ ç‰ˆæƒä¿¡æ¯"></a>æ·»åŠ ç‰ˆæƒä¿¡æ¯</h2><p>åœ¨ç«™ç‚¹é…ç½®æ–‡ä»¶æœç´¢<code>post_copyright</code>ï¼Œå°†<code>enable</code>ä¿®æ”¹ä¸º<code>true</code>ï¼Œæ·»åŠ <code>author</code>å³å¯ã€‚<br><a href="https://zhuanlan.zhihu.com/p/463548944#:~:text=%E4%BA%8C%E3%80%81hexo%E5%8D%9A%E5%AE%A2%E6%96%B0%E5%A2%9E%E5%BA%95%E9%83%A8%E7%89%88%E6%9D%83%E4%BF%A1%E6%81%AF%202.1%20%E5%BC%80%E5%90%AF%E6%96%87%E7%AB%A0%E5%BA%95%E9%83%A8%E7%89%88%E6%9D%83%E4%BF%A1%E6%81%AF%E9%85%8D%E7%BD%AE%20%E7%BC%96%E8%BE%91%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6themes%2Fnext%2F_config.yml%EF%BC%8C%E5%B0%86creative_commons%E4%B8%8B%E9%9D%A2%E7%9A%84post%E5%80%BC%E7%94%B1false%E6%94%B9%E4%B8%BAtrue%E3%80%82%20creative_commons%3A%20license%3A%20by-nc-sa,sidebar%3A%20false%20post%3A%20true%20language%3A%202.2%20%E6%9B%B4%E6%96%B0%E7%89%88%E6%9D%83%E8%AF%B4%E6%98%8E%20%E7%BC%96%E8%BE%91%E6%96%87%E4%BB%B6themes%2Fnext%2Flayout%2F_partials%2Fpost%2Fpost-copyright.swig%EF%BC%8C%E6%9B%B4%E6%96%B0%E7%89%88%E6%9D%83%E8%AF%B4%E6%98%8E%E6%96%87%E5%AD%97%EF%BC%8C%E4%BF%9D%E5%AD%98%E3%80%82">å‚è€ƒæ–‡ç« </a></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">post_copyright:</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">license:</span> <span class="hljs-string">CC</span> <span class="hljs-string">BY-NC-SA</span> <span class="hljs-number">3.0</span><br>  <span class="hljs-attr">license_url:</span> <span class="hljs-string">https://creativecommons.org/licenses/by-nc-sa/3.0/</span><br>  <span class="hljs-attr">author:</span> <span class="hljs-string">å’–å•¡æ¯é‡Œçš„èŒ¶</span><br></code></pre></td></tr></table></figure>

<h2 id="ä¿®æ”¹æ–‡ç« åº•éƒ¨çš„æ ‡ç­¾"><a href="#ä¿®æ”¹æ–‡ç« åº•éƒ¨çš„æ ‡ç­¾" class="headerlink" title="ä¿®æ”¹æ–‡ç« åº•éƒ¨çš„æ ‡ç­¾"></a>ä¿®æ”¹æ–‡ç« åº•éƒ¨çš„æ ‡ç­¾</h2><p>åŸºäº Next7 ä¿®æ”¹<br>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>_config.yml</code> ä¸­å°†ä¸‹é¢é…ç½®è®¾ç½®ä¸º true å³å¯ï¼ˆè¯¥é…ç½®é»˜è®¤å€¼ä¸ºfalseï¼‰</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">tag_icon:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<h2 id="æ˜¾ç¤ºå›¾ç‰‡"><a href="#æ˜¾ç¤ºå›¾ç‰‡" class="headerlink" title="æ˜¾ç¤ºå›¾ç‰‡"></a>æ˜¾ç¤ºå›¾ç‰‡</h2><p><a href="https://www.jianshu.com/p/ea78bdd0551f">æ˜¾ç¤ºå›¾ç‰‡</a></p>
<h2 id="æ·»åŠ æœç´¢åŠŸèƒ½-1"><a href="#æ·»åŠ æœç´¢åŠŸèƒ½-1" class="headerlink" title="æ·»åŠ æœç´¢åŠŸèƒ½"></a>æ·»åŠ æœç´¢åŠŸèƒ½</h2><p><a href="https://blog.csdn.net/qq_40265501/article/details/80030627">æ·»åŠ æœç´¢</a></p>
<h2 id="æ·»åŠ æ‰“èµåŠŸèƒ½"><a href="#æ·»åŠ æ‰“èµåŠŸèƒ½" class="headerlink" title="æ·»åŠ æ‰“èµåŠŸèƒ½"></a>æ·»åŠ æ‰“èµåŠŸèƒ½</h2><p>åœ¨<code>next</code>ä¸»é¢˜çš„é…ç½®æ–‡ä»¶æ–‡ä»¶ä¸­åŠ ä¸Šä¸‹é¢çš„ä»£ç </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml">reward_comment: åšæŒåŸåˆ›æŠ€æœ¯åˆ†äº«ï¼Œæ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œï¼<br>wechatpay: /images/å¾®ä¿¡æ”¯ä»˜.jpg<br>alipay: /images/æ”¯ä»˜å®æ”¯ä»˜.jpg<br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>wechatpay</code>å’Œ<code>alipay</code>å¯¹åº”çš„æ˜¯å¾®ä¿¡æ”¯ä»˜æ”¶æ¬¾ç å’Œæ”¯ä»˜å®æ”¯ä»˜æ”¶æ¬¾ç çš„å›¾ç‰‡åœ°å€ï¼Œæˆ‘è¿™é‡Œæ˜¯å­˜æ”¾åœ¨ <code>ä¸»é¢˜\source\images\</code>ä¸‹é¢</p>
<h2 id="ç”Ÿæˆæ°¸ä¹…é“¾æ¥"><a href="#ç”Ÿæˆæ°¸ä¹…é“¾æ¥" class="headerlink" title="ç”Ÿæˆæ°¸ä¹…é“¾æ¥"></a>ç”Ÿæˆæ°¸ä¹…é“¾æ¥</h2><p><a href="https://zhuanlan.zhihu.com/p/134492757">Hexo ç”Ÿæˆæ°¸ä¹…æ–‡ç« é“¾æ¥ - çŸ¥ä¹ (zhihu.com)</a><br>å¯¹äºHeox7 ç‰ˆæœ¬å¯ä»¥æœ‰æ›´ç®€å•çš„æ–¹å¼ï¼Œç›´æ¥ä½¿ç”¨ hash å³å¯</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#permalink: :year/:month/:day/:title/</span><br><span class="hljs-attr">permalink:</span> <span class="hljs-string">:hash/</span><br></code></pre></td></tr></table></figure>

<h2 id="æ–‡ç« æ”¶å½•"><a href="#æ–‡ç« æ”¶å½•" class="headerlink" title="æ–‡ç« æ”¶å½•"></a>æ–‡ç« æ”¶å½•</h2><p><a href="https://zhuanlan.zhihu.com/p/651590960">å…³äºHexoåšå®¢æ”¶å½•ä¸SEOé‚£äº›äº‹ - çŸ¥ä¹ (zhihu.com)</a><br>æ–‡ç« ä¸­éªŒè¯ç½‘ç«™çš„æ­¥éª¤ä¸­ä½¿ç”¨çš„æ˜¯ä¸‹è½½ html éªŒè¯æ–‡ä»¶ï¼Œæœ‰å¯èƒ½è¿™ç§æ–¹å¼éªŒè¯ä¸æˆåŠŸï¼Œå¯ä»¥é€‰æ‹©ç¬¬äºŒç§æ–¹å¼ï¼Œåœ¨ç½‘ç«™é¦–é¡µæ·»åŠ  meta æ ‡ç­¾ä¸­çš„å†…å®¹ï¼Œå°† meta ä¸­çš„å†…å®¹å¤åˆ¶åˆ°<br><code>themes\nextlayout\_partials\head\head.njk</code> æ–‡ä»¶ä¸­</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width&quot;</span>&gt;</span><br><span class="hljs-comment">&lt;!-- è¿™é‡Œæ·»åŠ çš„æ˜¯ç™¾åº¦çš„éªŒè¯å¤´æ–‡ä»¶ --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;baidu-site-verification&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;xxxx&quot;</span> /&gt;</span><br><span class="hljs-comment">&lt;!-- è¿™é‡Œæ·»åŠ çš„æ˜¯bingéªŒè¯çš„å¤´æ–‡ä»¶ --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;msvalidate.01&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;xxxx&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="å‡çº§-Hexo"><a href="#å‡çº§-Hexo" class="headerlink" title="å‡çº§ Hexo"></a>å‡çº§ Hexo</h2><p><a href="https://guoguocai.github.io/2022/06/05/%E5%A6%82%E4%BD%95%E5%8D%87%E7%BA%A7-Hexo-%E7%89%88%E6%9C%AC/">å‡çº§hexo</a></p>
<h2 id="Next7-å¤šçº§ç›®å½•æŠ˜å "><a href="#Next7-å¤šçº§ç›®å½•æŠ˜å " class="headerlink" title="Next7 å¤šçº§ç›®å½•æŠ˜å "></a>Next7 å¤šçº§ç›®å½•æŠ˜å </h2><p><a href="https://alex-mcavoy.github.io/hexo/41b257b8.html">å¤šçº§ç›®å½•æŠ˜å </a><br>æŒ‰ç…§ä¸Šé¢å‚è€ƒçš„æ–‡æ¡£å¼€å¯ Jquery, é¡µé¢ä¾ç„¶æŠ¥é”™ <code>$ ç¬¦å·æœªå®šä¹‰</code>, æ­¤æ—¶å¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹å¼ä¿®æ”¹,åœ¨è¿›å…¥ category.js ä¹‹å‰å…ˆå¼•å…¥ä¸€æ¬¡ Jquery</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- å¤šçº§ç›®å½• --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/js/category.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="Hexo-Nextä¸»é¢˜æ”¯æŒ-mermaid"><a href="#Hexo-Nextä¸»é¢˜æ”¯æŒ-mermaid" class="headerlink" title="Hexo Nextä¸»é¢˜æ”¯æŒ mermaid"></a>Hexo Nextä¸»é¢˜æ”¯æŒ mermaid</h2><ol>
<li>è¿›å…¥åšå®¢æ ¹ç›®å½•ï¼Œæ‰§è¡Œå®‰è£…æ’ä»¶å‘½ä»¤ <code>npm install hexo-filter-mermaid-diagrams --save</code></li>
<li>æ‰“å¼€ Next ä¸»é¢˜ä¸‹çš„ _config.yml æ–‡ä»¶ï¼Œå°† mermaid çš„é…ç½®æ”¹æˆ true</li>
</ol>
<figure class="highlight yml"><table><tr><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">mermaid:</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>
<p>åœ¨ç«™ç‚¹é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹å¦‚ä¸‹(å»é™¤å›¾å½¢çš„é«˜äº®)</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">highlight:</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-comment"># å¢åŠ ä¸‹é¢çš„å†…å®¹</span><br>  <span class="hljs-attr">exclude_languages:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">mermaid</span><br></code></pre></td></tr></table></figure>
<ol start="3">
<li>é‡æ–°ç”Ÿæˆéƒ¨ç½²å³å¯</li>
</ol>
<h2 id="å¢åŠ å›¾ç‰‡èƒŒæ™¯å’Œé€æ˜åº¦"><a href="#å¢åŠ å›¾ç‰‡èƒŒæ™¯å’Œé€æ˜åº¦" class="headerlink" title="å¢åŠ å›¾ç‰‡èƒŒæ™¯å’Œé€æ˜åº¦"></a>å¢åŠ å›¾ç‰‡èƒŒæ™¯å’Œé€æ˜åº¦</h2><ol>
<li>å°†èƒŒæ™¯å›¾ç‰‡æ”¾åœ¨ä¸»é¢˜ç›®å½•ä¸‹ <code>themes/next/source/images/</code> ä¸‹é¢</li>
<li>ä¿®æ”¹ Next ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>_config.yml</code>, å°†ä¸‹é¢çš„æ³¨é‡Šæ‰“å¼€</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">custom_file_path:</span><br>  <span class="hljs-comment">#head: source/_data/head.swig</span><br>  <span class="hljs-comment">#header: source/_data/header.swig</span><br>  <span class="hljs-comment">#sidebar: source/_data/sidebar.swig</span><br>  <span class="hljs-comment">#postMeta: source/_data/post-meta.swig</span><br>  <span class="hljs-comment">#postBodyEnd: source/_data/post-body-end.swig</span><br>  <span class="hljs-comment">#footer: source/_data/footer.swig</span><br>  <span class="hljs-comment">#bodyEnd: source/_data/body-end.swig</span><br>  <span class="hljs-comment">#variable: source/_data/variables.styl</span><br>  <span class="hljs-comment">#mixin: source/_data/mixins.styl</span><br>  <span class="hljs-attr">style:</span> <span class="hljs-string">source/_data/styles.styl</span><br></code></pre></td></tr></table></figure>
<ol start="3">
<li>åœ¨åšå®¢æ ¹ç›®å½•ä¸‹çš„ <code>source/</code> ä¸‹é¢åˆ›å»º <code>_data/styles.styl</code> æ–‡ä»¶ï¼ˆé»˜è®¤åœ¨ source ç›®å½•ä¸‹æ²¡æœ‰ _data ç›®å½•ï¼Œè‹¥æ²¡æœ‰ä¹Ÿéœ€è¦åˆ›å»ºï¼‰</li>
<li>åœ¨ä¸Šé¢åˆ›å»ºçš„ <code>styles.styl</code> æ–‡ä»¶ä¸­å¢åŠ å¦‚ä¸‹å†…å®¹</li>
</ol>
<figure class="highlight less"><table><tr><td class="code"><pre><code class="hljs less"><span class="hljs-comment">// å›¾ç‰‡èƒŒæ™¯ start------------</span><br><span class="hljs-selector-tag">body</span> &#123;<br>    <span class="hljs-attribute">background</span>:url(<span class="hljs-string">/images/background.jpg</span>);		<span class="hljs-comment">//å›¾ç‰‡è·¯å¾„ï¼Œé»˜è®¤</span><br>    <span class="hljs-attribute">background-repeat</span>: no-repeat;			<span class="hljs-comment">//å›¾ç‰‡æ— æ³•é“ºæ»¡æ—¶ï¼Œæ˜¯å¦é‡å¤åŠé‡å¤æ–¹å¼</span><br>    <span class="hljs-attribute">background-attachment</span>:fixed;		<span class="hljs-comment">//å›¾ç‰‡æ˜¯å¦è·Ÿéšæ»šåŠ¨</span><br>    <span class="hljs-attribute">background-size</span>:cover;				<span class="hljs-comment">//è¦†ç›–</span><br>    <span class="hljs-attribute">background-position</span>:center;		<span class="hljs-comment">//å›¾ç‰‡æ˜¾ç¤ºèµ·å§‹ä½ç½®</span><br>&#125;<br><span class="hljs-comment">// å›¾ç‰‡èƒŒæ™¯ end------------</span><br><br><br><span class="hljs-comment">// é€æ˜åº¦start----------------------------</span><br><span class="hljs-comment">// æ–‡ç« å†…å®¹é€æ˜åº¦è®¾ç½®</span><br><span class="hljs-comment">// 7 ç‰ˆæœ¬æœ‰æ•ˆ</span><br><span class="hljs-selector-class">.content-wrap</span> &#123;<br>    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.9</span>;<br>&#125;<br><br><span class="hljs-comment">// 8ç‰ˆæœ¬æœ‰æ•ˆ</span><br><span class="hljs-selector-class">.main-inner</span> &#123;<br>    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.9</span>;<br>&#125;<br><br><span class="hljs-selector-class">.header-inner</span> &#123;<br>    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.9</span>);<br>&#125;<br><br><span class="hljs-comment">//ä¾§è¾¹æ¡†çš„é€æ˜åº¦è®¾ç½®</span><br><span class="hljs-selector-class">.sidebar</span> &#123;<br>  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.9</span>;<br>&#125;<br><br><span class="hljs-comment">// æœç´¢æ¡†çš„é€æ˜åº¦</span><br><span class="hljs-selector-class">.popup</span> &#123;<br>    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.9</span>;<br>&#125;<br><span class="hljs-comment">// é€æ˜åº¦end----------------------------</span><br></code></pre></td></tr></table></figure>

<h2 id="é™æ€èµ„æºå‹ç¼©"><a href="#é™æ€èµ„æºå‹ç¼©" class="headerlink" title="é™æ€èµ„æºå‹ç¼©"></a>é™æ€èµ„æºå‹ç¼©</h2><p><a href="https://github.com/rozbo/hexo-neat">å‚è€ƒgithub hexo-neat æ’ä»¶</a></p>
<ol>
<li>å®‰è£…æ’ä»¶</li>
</ol>
<figure class="highlight ada"><table><tr><td class="code"><pre><code class="hljs ada">npm install hexo-neat <span class="hljs-comment">--save</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>åœ¨ hexo é…ç½®æ–‡ä»¶ <code>_config.yml</code> ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># é™æ€æ–‡ä»¶å‹ç¼© start-----------------</span><br><span class="hljs-attr">neat_enable:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">neat_html:</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">exclude:</span><br><span class="hljs-attr">neat_css:</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">exclude:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*.min.css&#x27;</span><br><span class="hljs-attr">neat_js:</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">mangle:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">output:</span><br>  <span class="hljs-attr">compress:</span><br>  <span class="hljs-attr">exclude:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*.min.js&#x27;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;**/*.min.js&#x27;</span><br><span class="hljs-comment"># é™æ€æ–‡ä»¶å‹ç¼© end-----------------</span><br></code></pre></td></tr></table></figure>
<ol start="3">
<li>é‡æ–°ç”Ÿæˆæ¨é€å³å¯</li>
</ol>
<h2 id="å¼•ç”¨è‡ªå·±çš„æ–‡ç« "><a href="#å¼•ç”¨è‡ªå·±çš„æ–‡ç« " class="headerlink" title="å¼•ç”¨è‡ªå·±çš„æ–‡ç« "></a>å¼•ç”¨è‡ªå·±çš„æ–‡ç« </h2><p><code>&#123;% post_path filename %&#125;</code><br>filename å°±æ˜¯å¼•ç”¨æ–‡ç« çš„åç§°</p>
<h2 id="é˜»æ­¢ç‚¹å‡»moreæ—¶è·³è½¬åˆ°moreä½ç½®"><a href="#é˜»æ­¢ç‚¹å‡»moreæ—¶è·³è½¬åˆ°moreä½ç½®" class="headerlink" title="é˜»æ­¢ç‚¹å‡»moreæ—¶è·³è½¬åˆ°moreä½ç½®"></a>é˜»æ­¢ç‚¹å‡»moreæ—¶è·³è½¬åˆ°moreä½ç½®</h2><ol>
<li>å¦‚æœç»™æ–‡ç« æ·»åŠ äº† <code>&lt;!--more--&gt;</code> ç‚¹å‡»é˜…è¯»æ›´å¤šæ—¶ä¼šè·³è½¬åˆ° <code>more</code> é”šç‚¹ä½ç½®ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢æ–¹å¼ä¿®æ”¹</li>
<li>æ‰¾åˆ° <code>themes\next-8.18.2\layout\_macro\post.njk</code> æ–‡ä»¶ï¼Œ æœç´¢ <code>elif post.excerpt</code>ï¼Œç›¸å…³éƒ¨åˆ†åŸæ¥çš„ä»£ç å¦‚ä¸‹</li>
</ol>
<figure class="highlight handlebars"><table><tr><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">&#123;% elif post.excerpt %&#125;</span><br><span class="language-xml">  </span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">post.excerpt</span> &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">  <span class="hljs-comment">&lt;!--noindex--&gt;</span></span><br><span class="language-xml">  &#123;%- if theme.read_more_btn %&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;post-button&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;</span></span></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">url_for</span>(<span class="hljs-name">post.path</span>) &#125;&#125;</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">suffix</span>&#125;&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">&quot;</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;contents&quot;</span>&gt;</span></span><br><span class="language-xml">        </span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">__</span>(<span class="hljs-name">&#x27;post.read_more&#x27;</span>) &#125;&#125;</span><span class="language-xml"> <span class="hljs-symbol">&amp;raquo;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">  &#123;%- endif %&#125;</span><br><span class="language-xml">  <span class="hljs-comment">&lt;!--/noindex--&gt;</span></span><br><span class="language-xml">&#123;% else %&#125;</span><br></code></pre></td></tr></table></figure>
<p>æ·»åŠ éƒ¨åˆ†å†…å®¹åå˜æˆå¦‚ä¸‹å†…å®¹</p>
<figure class="highlight django"><table><tr><td class="code"><pre><code class="hljs django"><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">elif</span></span> post.excerpt %&#125;</span><span class="language-xml"></span><br><span class="language-xml">  </span><span class="hljs-template-variable">&#123;&#123; post.excerpt &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">  <span class="hljs-comment">&lt;!--noindex--&gt;</span></span><br><span class="language-xml">  </span><span class="hljs-template-tag">&#123;%- <span class="hljs-name"><span class="hljs-name">if</span></span> theme.read_more_btn %&#125;</span><span class="language-xml"></span><br><span class="language-xml">  <span class="hljs-comment">&lt;!-- æ­¤å¤„æ˜¯æ·»åŠ çš„å†…å®¹ --&gt;</span></span><br><span class="language-xml">  </span><span class="hljs-template-tag">&#123;%- <span class="hljs-name">set</span> suffix = &quot;&quot;%&#125;</span><span class="language-xml"></span><br><span class="language-xml">  </span><span class="hljs-template-tag">&#123;%- <span class="hljs-name"><span class="hljs-name">if</span></span> theme.read_more_anchor %&#125;</span><span class="language-xml"></span><br><span class="language-xml">    </span><span class="hljs-template-tag">&#123;%- <span class="hljs-name">set</span> suffix = &quot;#more&quot;%&#125;</span><span class="language-xml"></span><br><span class="language-xml">  </span><span class="hljs-template-tag">&#123;%- <span class="hljs-name"><span class="hljs-name">endif</span></span> %&#125;</span><span class="language-xml"></span><br><span class="language-xml">  <span class="hljs-comment">&lt;!-- æ·»åŠ ç»“æŸ --&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;post-button&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-comment">&lt;!-- è¿™é‡Œæœ‰ä¿®æ”¹ï¼Œå°† #more æ”¹æˆäº† </span></span><span class="hljs-template-variable">&#123;&#123;suffix&#125;&#125;</span><span class="language-xml"><span class="hljs-comment"> --&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;</span></span></span><span class="hljs-template-variable">&#123;&#123; url_for(post.path) &#125;&#125;</span><span class="hljs-template-variable">&#123;&#123;suffix&#125;&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">&quot;</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;contents&quot;</span>&gt;</span></span><br><span class="language-xml">        </span><span class="hljs-template-variable">&#123;&#123; __(&#x27;post.read_more&#x27;) &#125;&#125;</span><span class="language-xml"> <span class="hljs-symbol">&amp;raquo;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">  </span><span class="hljs-template-tag">&#123;%- <span class="hljs-name"><span class="hljs-name">endif</span></span> %&#125;</span><span class="language-xml"></span><br><span class="language-xml">  <span class="hljs-comment">&lt;!--/noindex--&gt;</span></span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">else</span></span> %&#125;</span><br></code></pre></td></tr></table></figure>
<ol start="3">
<li>åœ¨ next çš„ <code>_config.yml</code> æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹å³å¯ï¼Œé…ç½®ä¸ºtrueæ—¶ä¾ç„¶è·³è½¬åˆ°more</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">read_more_anchor:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>hexoçš„butterflyä¸»é¢˜æ›´æ¢walineç³»ç»Ÿcdnåœ°å€</title>
    <url>/2023/0fd7aa9951f7/index.html</url>
    <content><![CDATA[<ol>
<li><p>butterflyä¸»é¢˜é»˜è®¤ä½¿ç”¨ cdn.jsdelivr.netï¼Œåœ¨å›½å†…ä½¿ç”¨å¾ˆæ…¢ï¼Œæœ‰æ—¶å€™åŠ è½½ä¸å‡ºæ¥ï¼Œå¯ä»¥æ›¿æ¢æˆå›½å†…æºï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸¤ä¸ª</p>
<figure class="highlight dts"><table><tr><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">http:</span><span class="hljs-comment">//www.staticfile.org/</span><br><span class="hljs-symbol">https:</span><span class="hljs-comment">//cdn.onmicrosoft.cn/</span><br></code></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€ä¸ªï¼Œæ‰“å¼€ <code>http://www.staticfile.org/</code> åï¼Œä¼šå‡ºç°æœç´¢æ¡†ï¼Œæœç´¢ <code>waline</code>ï¼Œ ç„¶åé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬å°±å¥½äº†ï¼Œå¦‚æœä¸çŸ¥é“è‡ªå·±çš„ç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨åˆ‡æ¢å‰å…ˆæ‰“å¼€è‡ªå·±çš„ <code>wailne</code> ç³»ç»Ÿï¼Œåœ¨è¯„è®ºæ¡†ä¸‹é¢ä¼šæ˜¾ç¤ºç‰ˆæœ¬</p>
</li>
<li><p>æ‰¾åˆ°å¯¹åº”çš„ç‰ˆæœ¬åå¤åˆ¶å‡ºå¯¹åº”çš„ <code>css</code> å’Œ <code>js</code> åœ°å€ï¼Œæ·»åŠ åˆ° <code>_config.butterfly.yml</code> æ–‡ä»¶ä¸­,æ¯”å¦‚æˆ‘ä½¿ç”¨çš„æ˜¯3.0ç‰ˆæœ¬ï¼Œåˆ™æ‰“å¼€ <code>wailne_css</code> å’Œ <code>waline_js</code> æ³¨é‡Šå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹</p>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">CDN:</span><br>  <span class="hljs-attr">option:</span><br>    <span class="hljs-attr">waline_css:</span> <span class="hljs-string">https://cdn.staticfile.org/waline/3.0.0-alpha.2/waline.min.css</span><br>    <span class="hljs-attr">waline_js:</span> <span class="hljs-string">https://cdn.staticfile.org/waline/3.0.0-alpha.2/waline.min.js</span><br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>tools</category>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>æ¯”è¾ƒ</title>
    <url>/2023/2084759b2332/index.html</url>
    <content><![CDATA[<blockquote>
<p>äººæ„Ÿåˆ°ä¸å¹¸ç¦å¤§å¤šæ¥æºäºæ¯”è¾ƒï¼Œæ„Ÿåˆ°æ»¡è¶³ä¹Ÿæºäºæ¯”è¾ƒ</p>
</blockquote>
<span id="more"></span>
<p>åœ¨å¾®ä¿¡è¯»ä¹¦çœ‹åˆ°ä¸€ä½ä¹¦å‹å†™åˆ°ï¼Œä½œä¸ºå†œæ‘å‡ºæ¥çš„å­©å­ï¼Œåº”è¯¥å¦‚ä½•æ”¹å˜è‡ªå·±çš„å‘½è¿ï¼Œå› ä¸ºå‘¨å›´çš„ä¸€åˆ‡åœ¨å‘Šè¯‰æˆ‘ä»¬ï¼Œå°±ç®—ä½ åŠªåŠ›äº†äºŒåå‡ å¹´ï¼Œæ‰å‹‰å¼ºè¾¾åˆ°äº†åˆ«äººçš„èµ·è·‘çº¿ï¼Œä½†æ˜¯æˆ‘ä»¬çš„å‡ºèº«æ˜¯è‡ªå·±æ— æ³•å†³å®šçš„ï¼Œé‚£æˆ‘ä»¬åº”è¯¥å¦‚ä½•æ›´è¿›ä¸€æ­¥å‘¢ï¼Ÿ</p>
<p>çœ‹åˆ°å¦å¤–ä¸€ä½ä¹¦å‹çš„å›ç­”å¾ˆæœ‰æ„Ÿè§¦ï¼Œä¸”è®°å½•åœ¨æ­¤ï¼Œå’Œæœ‰ç¼˜äººå…±å‹‰</p>
<blockquote>
<p>å›å¤´çœ‹ï¼Œè½»èˆŸå·²è¿‡ä¸‡é‡å±±<br>å‘å‰çœ‹ï¼Œé•¿è·¯æ¼«æ¼«äº¦ç¿ç¿<br>å¹³å¸¸çœ‹ï¼Œäººé—´çƒŸç«ç”šç¿çƒ‚<br>ä½å¤´çœ‹ï¼Œä¸‡é‡Œé»„å±±çš†è„šä¸‹  </p>
</blockquote>
]]></content>
      <categories>
        <category>record</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>ç»åŸé›å­è°·</title>
    <url>/2023/5f05aa7a8eab/index.html</url>
    <content><![CDATA[<ol>
<li>é å¿™ç¢Œèµšæ¥çš„é’±å¾€å¾€ä¸å¤ŸèŠ±ï¼Œåªæœ‰æ´è§ã€æ€è€ƒã€æŠ“ä½æœºä¼šå’Œè¶‹åŠ¿èµšæ¥çš„é’±æ‰èƒ½å¤Ÿè®©ä½ å®ç°é˜¶çº§è·ƒå‡ã€‚</li>
</ol>
]]></content>
      <categories>
        <category>record</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>å®è´µçš„äººç”Ÿå»ºè®®</title>
    <url>/2023/5792ca8e5e27/index.html</url>
    <content><![CDATA[<ul>
<li>ä¹¦åï¼šã€Šå®è´µçš„äººç”Ÿå»ºè®®ã€‹</li>
<li>ä½œè€…ï¼šå‡¯æ–‡å‡¯åˆ©</li>
</ul>
<p>çœ‹è¿‡äº†ï¼Œè§‰å¾—æœ‰é“ç†ï¼Œæƒ³è¦æ”¹å˜éƒ½ä¸ä»£è¡¨ä½ çœŸçš„è®¤åŒå¹¶ç†è§£ï¼Œâ€åšå‡ºæ¥â€å°±æ˜¯å¯¹â€è®¤åŒâ€æœ€å¥½çš„å›å¤</p>
<span id="more"></span>

<blockquote>
<p>æŠŠâ€åˆ›é€ â€å’Œâ€æ”¹è¿›â€è¿™ä¸¤ä¸ªè¿‡ç¨‹åˆ†å¼€ï¼Œä½ ä¸èƒ½è¾¹å†™ä½œè¾¹ç¼–è¾‘ï¼Œè¾¹é›•åˆ»è¾¹æ‰“ç£¨ï¼Œè¾¹åˆ¶ä½œè¾¹åˆ†æã€‚å¦‚æœä½ è¿™ä¹ˆåšï¼Œç¼–è¾‘å°±ä¼šé˜»éåˆ›é€ ï¼Œå‘æ˜æ—¶ï¼Œä¸è¦é€‰æ‹©ã€‚ç”»è‰å›¾æ—¶ï¼Œä¸è¦æ£€æŸ¥ã€‚å†™åˆç¨¿æ—¶ï¼Œä¸è¦åæ€ã€‚ä¸€å¼€å§‹ï¼Œåˆ›é€ æ€§æ€ç»´å¿…é¡»æ˜¯è‡ªç”±çš„ï¼Œä¸å—æ‰¹åˆ¤çš„å¹²æ‰°ã€‚</p>
</blockquote>
<p>æ— è®ºæ˜¯æŠ€æœ¯ç±»æ–‡ç« è¿˜æ˜¯å…¶ä»–ç±»å‹çš„è®°å½•ï¼Œé‡ç‚¹æ˜¯å†™ï¼Œè€Œä¸æ˜¯å…ˆå­¦ä¹ å„ç§å„æ ·çš„å¥—è·¯(å¥—è·¯ä¹Ÿå¾ˆé‡è¦ï¼Œä½†å†…å®¹æ˜¯å‰æ)ï¼Œåç»­åœ¨å†™å†…å®¹ä¹‹å‰ä¸è¦è¿½æ±‚å®Œç¾ï¼Œå…ˆå†™å‡ºæ¥æ‰ä¼šæœ‰åç»­çš„æ•…äº‹</p>
<blockquote>
<p>å…»æˆä¹ æƒ¯çš„å¥½å¤„æ˜¯ï¼Œåœ¨è¡ŒåŠ¨æ—¶ï¼Œä¸å¿…å†è¿›è¡Œå†…å¿ƒçš„æƒè¡¡ã€‚ä¸å†æ¶ˆè€—èƒ½é‡å»æ€è€ƒæ˜¯å¦è¦åšè¿™ä»¶äº‹ã€‚ä½ åªç®¡å»åšã€‚å¥½ä¹ æƒ¯å¾ˆå¤šï¼Œä»è¯´çœŸè¯åˆ°ä½¿ç”¨ç‰™çº¿ã€‚</p>
</blockquote>
<p>ä¸è¦ä½¿ç”¨æ„å¿—åŠ›å»åšæŒåšä¸€ä»¶äº‹ï¼Œæ…¢æ…¢å…»æˆä¹ æƒ¯ï¼Œè®©åšæŸä»¶äº‹æˆä¸ºèº«ä½“çš„æœ¬èƒ½</p>
<blockquote>
<p>ææƒ§æ˜¯å› ä¸ºç¼ºä¹æƒ³è±¡åŠ›ã€‚ææƒ§çš„è§£è¯ä¸æ˜¯å‹‡æ•¢ï¼Œè€Œæ›´å¯èƒ½æ˜¯æƒ³è±¡åŠ›</p>
</blockquote>
<ul>
<li>ææƒ§æ˜¯å› ä¸ºç»å†çš„å¤ªå°‘ï¼ŒçŸ¥é“çš„å¤ªå°‘ï¼Œæ‡‚å¾—çš„å¤ªå°‘</li>
</ul>
<blockquote>
<p>ä½ å¹¶ä¸éœ€è¦æ›´å¤šæ—¶é—´ï¼Œå› ä¸ºä½ å·²ç»æ‹¥æœ‰äº†ä½ çš„æ‰€æœ‰æ—¶é—´</p>
</blockquote>
<blockquote>
<p>ä½ æœ€è¿‘ä¸€æ¬¡æ”¹å˜æ˜¯åœ¨ä»€ä¹ˆå¹´çºªï¼Œä½ å°±æ˜¯å¤šå°‘å²</p>
</blockquote>
<blockquote>
<p>ä¸è¦ç®¡åˆ«äººæ€ä¹ˆçœ‹å¾…ä½ ï¼Œå› ä¸ºä»–ä»¬æ ¹æœ¬æ²¡çœ‹ä½ </p>
</blockquote>
<blockquote>
<p>ä»»ä½•æœ‰ä»·å€¼çš„äº‹éƒ½éœ€è¦æ— å°½çš„å·¥ä½œã€‚ä½ æ— æ³•ç»™å·¥ä½œè®¾å®šä¸Šé™ï¼Œæ‰€ä»¥ä½ å¿…é¡»ç»™å·¥ä½œæ—¶é—´è®¾é™ã€‚ä½ å”¯ä¸€èƒ½ç®¡ç†çš„æ˜¯æ—¶é—´ï¼Œè€Œä¸æ˜¯å·¥ä½œ</p>
</blockquote>
<blockquote>
<p>å¦‚æœä½ æƒ³è¶…è¶Šä½ å¿ƒç›®ä¸­çš„è‹±é›„ï¼Œé‚£å°±æ”¾ä¸‹è‡ªå°Šå¿ƒï¼Œåƒå­¦ç”Ÿä¸€æ ·æ¨¡ä»¿ä»–ä»¬ï¼Œç›´åˆ°ä½ èƒ½è¶…è¶Šä»–ä»¬ã€‚è¿™æ˜¯æ‰€æœ‰å¤§å¸ˆçš„æˆåŠŸä¹‹é“</p>
</blockquote>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>book</tag>
      </tags>
  </entry>
  <entry>
    <title>å¾®ä¿¡è¯»ä¹¦é˜…è¯»æŒ‘æˆ˜</title>
    <url>/2023/c4c074b722a1/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p>å‚ä¸å¾®ä¿¡é˜…è¯»æŒ‘æˆ˜</p>
<ol>
<li>365 å¤©ä¸é—´æ–­</li>
<li>æœŸé—´æœ€å°‘é˜…è¯» 300 å°æ—¶</li>
<li>æ¯æœˆæ›´æ–°è¿›åº¦</li>
</ol>
<div class="tabs" id="æ€»è¿›åº¦"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="æ€»è¿›åº¦-1">23-12</button></ul><div class="tab-contents"><div class="tab-item-content active" id="æ€»è¿›åº¦-1"><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202401010927782.webp?imageSlim" alt="23å¹´12æœˆ"></p></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>book</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ†å¸ƒå¼æ¶æ„åŸç†ä¸å®è·µ</title>
    <url>/2024/48c302d39723/index.html</url>
    <content><![CDATA[<blockquote>
<p>å‚è€ƒä¹¦ç±ï¼š ã€Šåˆ†å¸ƒå¼æ¶æ„åŸç†ä¸å®è·µã€‹ å´”çš“</p>
</blockquote>
<h2 id="åˆ†å¸ƒå¼æ•´ä½“æ¡†æ¶å†…å®¹"><a href="#åˆ†å¸ƒå¼æ•´ä½“æ¡†æ¶å†…å®¹" class="headerlink" title="åˆ†å¸ƒå¼æ•´ä½“æ¡†æ¶å†…å®¹"></a>åˆ†å¸ƒå¼æ•´ä½“æ¡†æ¶å†…å®¹</h2><p>è¯¥ä¹¦ä¸­è°ˆè®ºçš„åˆ†å¸ƒå¼æ¶æ„åŒ…å«çš„å†…å®¹</p>
<ul>
<li>åˆ†å¸ƒå¼åº”ç”¨æœåŠ¡çš„æ‹†åˆ†</li>
<li>åˆ†å¸ƒå¼è°ƒç”¨<ul>
<li>æ¥å…¥å±‚çš„è´Ÿè½½å‡è¡¡ï¼ˆç»ˆç«¯åˆ°æœåŠ¡é›†ç¾¤çš„è´Ÿè½½ï¼Œæ¯”å¦‚å—æ–¹å®¢æˆ·è®¿é—®åŒä¸€ä¸ªä¸šåŠ¡å¯ä»¥è·¯ç”±åˆ°å—æ–¹æœåŠ¡ä¸­å¿ƒè€Œä¸æ˜¯åŒ—æ–¹æœåŠ¡ä¸­å¿ƒï¼Œå°±è¿‘æœåŠ¡å¯ä»¥æé«˜è®¿é—®æ€§èƒ½ï¼‰</li>
<li>å†…éƒ¨æœåŠ¡çš„è´Ÿè½½å‡è¡¡ï¼Œä¹Ÿå°±æ˜¯APIç½‘å…³åšçš„äº‹æƒ…ï¼ˆå³ä½¿è·¯ç”±åˆ°å—æ–¹ä¸­å¿ƒï¼Œä½†å†…éƒ¨æœåŠ¡ä¹Ÿæ˜¯é›†ç¾¤éƒ¨ç½²ï¼Œè¦å®šä½åˆ°æŸä¸ªå…·ä½“çš„æœåŠ¡å™¨è¿˜éœ€è¦è¿›ä¸€æ­¥è´Ÿè½½ï¼‰</li>
<li>æœåŠ¡æ³¨å†Œä¸å‘ç°</li>
<li>æœåŠ¡é—´çš„è¿œç¨‹è°ƒç”¨ï¼šHTTPè°ƒç”¨ï¼ŒRPC è°ƒç”¨ç­‰</li>
</ul>
</li>
<li>åˆ†å¸ƒå¼ååŒ<ul>
<li>åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç‰¹æ€§ä¸äº’æ–¥é—®é¢˜</li>
<li>åˆ†å¸ƒå¼é”</li>
<li>åˆ†å¸ƒå¼äº‹åŠ¡</li>
<li>åˆ†å¸ƒå¼é€‰ä¸¾</li>
</ul>
</li>
<li>åˆ†å¸ƒå¼è®¡ç®—<ul>
<li>ç°åœ¨éƒ½æ˜¯å¤§æ•°æ®ï¼Œå•ä¸€æœåŠ¡æ¯”è¾ƒéš¾å¤„ç†ï¼Œæ‰€ä»¥ä¼šä½¿ç”¨åˆ†å¸ƒå¼è®¡ç®—ï¼Œå³é›†ç¾¤ä¸­çš„æ¯ä¸ªæœåŠ¡è®¡ç®—éƒ¨åˆ†æ•°æ®</li>
<li>æ‰¹é‡é™æ€æ•°æ®è®¡ç®—çš„ <code>MapReduce</code> æ¨¡å¼</li>
<li>åŠ¨æ€æ•°æ®æµè¿›è¡Œè®¡ç®—çš„ <code>Stream</code> æ¨¡å¼</li>
</ul>
</li>
<li>åˆ†å¸ƒå¼å­˜å‚¨<ul>
<li>åˆ†å¸ƒå¼æ¶æ„ä¸­å¯¹æœåŠ¡è¿›è¡Œäº†æ‹†åˆ†ï¼Œæ¯ä¸ªæœåŠ¡éƒ½ä¼šäº§ç”Ÿæ•°æ®ï¼Œæ¯ä¸ªæœåŠ¡çš„æ•°æ®æ˜¯åˆ†å¼€å­˜å‚¨çš„</li>
</ul>
</li>
<li>åˆ†å¸ƒå¼èµ„æºç®¡ç†å’Œè°ƒåº¦</li>
<li>é«˜æ€§èƒ½å’Œé«˜å¯ç”¨ä»¥åŠæŒ‡æ ‡ä¸ç›‘æ§</li>
</ul>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202401061117240.webp?imageSlim" alt="åˆ†å¸ƒå¼æ¶æ„æ•´ä½“æµç¨‹å›¾"></p>
<h2 id="åˆ†å¸ƒå¼è°ƒç”¨"><a href="#åˆ†å¸ƒå¼è°ƒç”¨" class="headerlink" title="åˆ†å¸ƒå¼è°ƒç”¨"></a>åˆ†å¸ƒå¼è°ƒç”¨</h2><p><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šç³»ç»Ÿå¤–çš„å®¢æˆ·ç«¯è°ƒç”¨ç³»ç»Ÿå†…çš„æœåŠ¡æ—¶éœ€è¦é€šè¿‡åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„æ–¹å¼<br><strong>APIç½‘å…³</strong>ï¼šç³»ç»Ÿæ¶æ„å†…éƒ¨æœåŠ¡ä¹‹é—´çš„è°ƒç”¨éœ€è¦é€šè¿‡ <code>API</code> ç½‘å…³<br><strong>æœåŠ¡æ³¨å†Œä¸å‘ç°</strong>ï¼šæœåŠ¡ä¹‹é—´çš„äº’ç›¸æ„ŸçŸ¥éœ€è¦ç”¨åˆ°æœåŠ¡æ³¨å†Œä¸å‘ç°<br><strong>æœåŠ¡é€šä¿¡</strong>ï¼šæœåŠ¡ä¹‹é—´çš„é€šä¿¡ä¼šä½¿ç”¨ <code>RPC</code> æ¶æˆ– <code>HTTP</code> è°ƒç”¨</p>
<p><strong>ç–‘é—®ï¼šNginx å’Œ API ç½‘å…³çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<h2 id="åˆ†å¸ƒå¼ååŒ"><a href="#åˆ†å¸ƒå¼ååŒ" class="headerlink" title="åˆ†å¸ƒå¼ååŒ"></a>åˆ†å¸ƒå¼ååŒ</h2><ul>
<li>åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç‰¹æ€§å’Œäº’æ–¥é—®é¢˜ï¼ˆåŸºäºä»¥ä¸‹ä¸€ç³»åˆ—ç‰¹æ€§è€Œäº§ç”Ÿäº†åˆ†å¸ƒå¼äº’æ–¥ç®—æ³•ï¼‰<ul>
<li>ç‰¹æ€§1ï¼šç«äº‰ä¸´ç•Œèµ„æºçš„è¿›ç¨‹éƒ¨ç½²åœ¨ä¸åŒæœåŠ¡å™¨ä¸Šï¼Œè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ä¾èµ–äºç½‘ç»œï¼Œåœ¨è¯·æ±‚ä¸´ç•Œèµ„æºæ—¶ä¼šç”±äºç½‘ç»œåŸå› å‡ºç°å»¶è¿Ÿã€ä¸¢åŒ…ç­‰æƒ…å†µ</li>
<li>ç‰¹æ€§2ï¼šä¸åŒæœåŠ¡å™¨ä¸Šçš„æ—¶é—´ä¸ä¸€å®šéƒ½ä¸€è‡´ï¼Œæ‰€ä»¥éœ€è¦å…¨å±€æ—¶é’Ÿæœºåˆ¶æ¥ä¿è¯æ—¶é—´çš„åŒæ­¥</li>
<li>ç‰¹æ€§3ï¼šå› ä¸ºæœåŠ¡åœ¨ä¸åŒæœºå™¨ä¸­ï¼Œæ‰€ä»¥éœ€è¦ç½‘ç»œé€šä¿¡ï¼Œå½“ç½‘ç»œå‡ºç°æ•…éšœæ—¶ï¼Œéœ€è¦ä¸€å®šçš„æ£€æµ‹æœºåˆ¶ï¼Œä¿è¯ç³»ç»Ÿæ•´ä½“çš„ç¨³å®šæ€§</li>
</ul>
</li>
<li>åˆ†å¸ƒå¼é”</li>
<li>åˆ†å¸ƒå¼äº‹åŠ¡</li>
<li>åˆ†å¸ƒå¼é€‰ä¸¾</li>
</ul>
<h3 id="åˆ†å¸ƒå¼äº’æ–¥ç®—æ³•"><a href="#åˆ†å¸ƒå¼äº’æ–¥ç®—æ³•" class="headerlink" title="åˆ†å¸ƒå¼äº’æ–¥ç®—æ³•"></a>åˆ†å¸ƒå¼äº’æ–¥ç®—æ³•</h3><p><strong>é›†ä¸­äº’æ–¥ç®—æ³•</strong><br>å°±æ˜¯åœ¨æœåŠ¡ä¹‹å¤–å¢åŠ ä¸€ä¸ªå…¨å±€çš„åè°ƒè€…ï¼Œæ‰€æœ‰æœåŠ¡æƒ³è¦è·å–æˆ–è€…é‡Šæ”¾æŸä¸ªèµ„æºéƒ½éœ€è¦ç»è¿‡å…¨å±€åè°ƒè€…</p>
<p><strong>åŸºäºè®¸å¯çš„äº’æ–¥ç®—æ³•</strong><br>ä¸å¢åŠ é¢å¤–çš„åè°ƒè€…ï¼Œè€Œæ˜¯å†…éƒ¨æœåŠ¡è‡ªå·±å†³å®šåº”è¯¥ç”±è°æ¥è·çš„èµ„æºï¼Œå³å½“æŸä¸ªæœåŠ¡æƒ³è¦è·å–ä¸€ä¸ªå…±äº«èµ„æºæ—¶ï¼Œéœ€è¦è·å–åŒç±»å‹çš„æ‰€æœ‰æœåŠ¡ä¸­çš„åŠæ•°ä»¥ä¸Šçš„æœåŠ¡è®¤å¯æ‰è¡Œ</p>
<h3 id="åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡"></a>åˆ†å¸ƒå¼äº‹åŠ¡</h3><p><strong>äº‹åŠ¡çš„ <code>ACID</code> ç‰¹æ€§</strong></p>
<ul>
<li>åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šäº‹åŠ¡æ˜¯åŸå­çš„ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥</li>
<li>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´æ€§</li>
<li>éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œæ—¶ï¼Œæ•°æ®ä¿æŒéš”ç¦»æ€§ï¼Œå³ä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸ä¼šå½±å“å…¶ä»–äº‹åŠ¡çš„æ‰§è¡Œ</li>
<li>æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šäº‹åŠ¡æ‰§è¡ŒæˆåŠŸåï¼Œæ•°æ®ä¿å­˜åœ¨ç£ç›˜ä¸Š</li>
</ul>
<p><strong>CAP ç†è®º</strong></p>
<ul>
<li>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šæ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶åˆ»çš„æ•°æ®è§†å›¾æ˜¯ä¸€è‡´çš„ï¼Œå³å¯¹å®¢æˆ·ç«¯æ¥è¯´ï¼Œä¸è®ºè®¿é—®çš„æ˜¯å“ªå°æœºå™¨ï¼Œæ•°æ®éƒ½ä¼šæ˜¯æœ€æ–°çš„</li>
<li>å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰ï¼šå½“é›†ç¾¤ä¸­å‡ºç°ç½‘ç»œåˆ†åŒºæ—¶ï¼Œå³ä½¿å½“å‰æœºå™¨ä¸Šçš„æ•°æ®å¯èƒ½ä¸æ˜¯æœ€æ–°çš„ï¼Œä¹Ÿä¼šå“åº”ç»“æœç»™å®¢æˆ·ç«¯ï¼ˆå“åº”çš„æ•°æ®å¯èƒ½æ˜¯æ—§çš„ï¼‰ï¼Œä¸€èˆ¬ä¼šé€šè¿‡è´Ÿè½½å‡è¡¡ï¼Œç¼“å­˜æœºåˆ¶ï¼Œå¼‚æ­¥å¤„ç†ï¼Œå®¹é”™æœºåˆ¶ç­‰æ–¹å¼æ¥æé«˜å¯ç”¨æ€§</li>
<li>åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰ï¼šåˆ†åŒºå®¹é”™æ€§æ˜¯æŒ‡åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå³ä½¿å‡ºç°ç½‘ç»œåˆ†åŒºæˆ–è€…èŠ‚ç‚¹æ•…éšœï¼Œç³»ç»Ÿä»ç„¶èƒ½å¤Ÿæ­£å¸¸è¿è¡Œå’Œæä¾›æœåŠ¡çš„èƒ½åŠ›ã€‚ç½‘ç»œåˆ†åŒºæ˜¯æŒ‡å› ä¸ºç½‘ç»œæ•…éšœå¯¼è‡´èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡ä¸­æ–­ï¼Œä½¿å¾—æ•´ä¸ªç³»ç»Ÿè¢«åˆ†å‰²æˆè‹¥å¹²ä¸ªå­¤ç«‹çš„éƒ¨åˆ†ã€‚åˆ†åŒºå®¹é”™æ€§è¦æ±‚ç³»ç»Ÿèƒ½å¤Ÿåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¿æŒæ•°æ®çš„ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ï¼Œå³å¯¹äºå®¢æˆ·ç«¯è¯·æ±‚ï¼Œç³»ç»Ÿä»ç„¶èƒ½å¤Ÿè¿”å›æ­£ç¡®çš„ç»“æœï¼Œä¸€èˆ¬ä¼šé€šè¿‡å¤šå‰¯æœ¬ï¼Œå¼‚æ­¥å¤åˆ¶ã€æ•…éšœè½¬ç§»ç­‰ç­–ç•¥ï¼Œå°†æ•°æ®åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šè¿›è¡Œå¤åˆ¶ï¼Œä»¥ç¡®ä¿åœ¨æŸä¸ªèŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œå…¶ä»–èŠ‚ç‚¹ä»ç„¶å¯ä»¥æä¾›æœåŠ¡</li>
</ul>
<p>ä¸ºä»€ä¹ˆ <code>CAP</code> ç†è®ºä¸­æœ€å¤šåªèƒ½æ»¡è¶³ä¸¤ä¸ªï¼Ÿ</p>
<ol>
<li>å› ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿçš„ç‰¹å®šï¼Œåˆ†åŒºå®¹é”™æ€§æ˜¯ä¸€å®šè¦æ»¡è¶³çš„ï¼Œå› ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿä¾èµ–ç½‘ç»œé€šä¿¡ï¼Œå¦‚æœå› ä¸ºç½‘ç»œé—®é¢˜ï¼Œé€ æˆæ•°æ®åŒæ­¥å¤±è´¥ï¼Œå¤§é›†ç¾¤è¢«åˆ†å‰²æˆå¤šä¸ªæ— é€šä¿¡çš„å°é›†ç¾¤ç­‰ï¼Œç³»ç»Ÿåº”è¯¥è¿˜æ˜¯è¦èƒ½æä¾›æœåŠ¡ï¼Œæ‰€ä»¥åœ¨å‡ºç°ç½‘ç»œé—®é¢˜çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿè¿˜è¦èƒ½æä¾›æœåŠ¡ï¼Œå°±ä»£è¡¨ç€ä¸€å®šè¦æ»¡è¶³åˆ†åŒºå®¹é”™æ€§</li>
<li>åœ¨å‡ºç°ç½‘ç»œçš„é—®é¢˜æƒ…å†µä¸‹ï¼Œè‹¥æƒ³æ»¡è¶³<code>C</code>ï¼Œå³æ•°æ®å¿…é¡»ä¿æŒä¸€ç›´ï¼Œåˆ™åªèƒ½ç‰ºç‰² <code>A</code>ï¼Œç³»ç»Ÿéœ€è¦ç­‰åˆ°ç½‘ç»œæ¢å¤æ‰èƒ½ç”¨</li>
<li>åœ¨å‡ºç°ç½‘ç»œçš„é—®é¢˜æƒ…å†µä¸‹ï¼Œè‹¥æƒ³æ»¡è¶³<code>A</code>ï¼Œåˆ™å¿…é¡»èƒ½å¿å—è¿”å›çš„æ•°æ®ä¸æ˜¯æœ€æ–°çš„è¿™ç§æƒ…å†µï¼Œä¹Ÿå°±æ˜¯ç‰ºç‰²äº† <code>C</code></li>
</ol>
]]></content>
      <categories>
        <category>java</category>
        <category>æ¶æ„</category>
      </categories>
      <tags>
        <tag>æ¶æ„</tag>
      </tags>
  </entry>
  <entry>
    <title>ArrayListä¸­å‡ºç°ConcurrentModificationExceptionå¼‚å¸¸è¯¦è§£</title>
    <url>/2023/0dae6ecb7b1d/index.html</url>
    <content><![CDATA[<h2 id="å‡ºç°-ConcurrentModificationException-å¼‚å¸¸çš„ä»£ç "><a href="#å‡ºç°-ConcurrentModificationException-å¼‚å¸¸çš„ä»£ç " class="headerlink" title="å‡ºç° ConcurrentModificationException å¼‚å¸¸çš„ä»£ç "></a>å‡ºç° ConcurrentModificationException å¼‚å¸¸çš„ä»£ç </h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestArrayList</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>            list.add(i + <span class="hljs-string">&quot;&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// ç¬¬ä¸€ä¸ªçº¿ç¨‹éå† List</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            <span class="hljs-keyword">for</span> (String s : list) &#123;<br>                System.out.println(s);<br>            &#125;<br>        &#125;).start();<br><br>        <span class="hljs-comment">// ç¬¬ä¸€ä¸ªçº¿ç¨‹å¾€ List ä¸­æ·»åŠ æ•°æ®</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>                list.add(i+<span class="hljs-string">&quot;1&quot;</span>);<br>            &#125;<br>        &#125;).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç  <strong>æœ‰å¯èƒ½</strong> ä¼šå‡ºç°ä¸‹é¢çš„é”™è¯¯</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">739</span><br><span class="hljs-number">740</span><br>Exception <span class="hljs-keyword">in</span> thread <span class="hljs-string">&quot;Thread-0&quot;</span> java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.ConcurrentModificationException</span><br>	at java.base/java<span class="hljs-selector-class">.util</span>.ArrayList<span class="hljs-variable">$Itr</span><span class="hljs-selector-class">.checkForComodification</span>(ArrayList<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1013</span>)<br>	at java.base/java<span class="hljs-selector-class">.util</span>.ArrayList<span class="hljs-variable">$Itr</span><span class="hljs-selector-class">.next</span>(ArrayList<span class="hljs-selector-class">.java</span>:<span class="hljs-number">967</span>)<br>	at org<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.collect</span><span class="hljs-selector-class">.TestArrayList</span>.lambda<span class="hljs-variable">$main</span>$<span class="hljs-number">0</span>(TestArrayList<span class="hljs-selector-class">.java</span>:<span class="hljs-number">14</span>)<br>	at java.base/java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Thread</span><span class="hljs-selector-class">.run</span>(Thread<span class="hljs-selector-class">.java</span>:<span class="hljs-number">842</span>)<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ª <code>Thread-0</code> å°±æ˜¯éå† <code>List</code> çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p>
<p>ä¸Šé¢çš„é”™è¯¯å·²ç»ç»™å‡ºäº†è°ƒç”¨æ ˆï¼Œæœ€åˆæ˜¯åœ¨ <code>TestArrayList.lambda$main$0(TestArrayList.java:14)</code> è¿™è¡Œä»£ç è§¦å‘çš„ï¼Œå®é™…å°±æ˜¯ <code>for (String s : list) &#123;</code> è¿™ä¸€è¡Œä»£ç ï¼Œè¿™è¡Œä»£ç ä¼šè°ƒç”¨ <code>ArrayList$Itr.next</code>ï¼Œ è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ </p>
<p>å…¶å® <code>foreach</code> è¯­æ³•å°±æ˜¯ä¸€ä¸ªè¯­æ³•ç³–(è¯­æ³•ç³–å°±æ˜¯åœ¨è¯­æ³•ä¸Šåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œä¾¿äºç¨‹åºå‘˜ä¹¦å†™ä»£ç ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ”¹å˜å®é™…çš„åŠŸèƒ½)ï¼Œå¯ä»¥åœ¨ <code>idea</code> ä¸­é€šè¿‡ <code>jclasslib</code> æ’ä»¶æ¥ç¼–è¯‘çœ‹çœ‹</p>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202312202106893.webp" alt="ç¼–è¯‘æºä»£ç "></p>
<p>å¯ä»¥çœ‹åˆ° <code>foreach</code> å½¢å¼çš„éå†å…¶å®å°±æ˜¯ä½¿ç”¨ <code>iterator</code>, ç„¶åä¸æ–­çš„è°ƒç”¨ <code>hasNext</code> å’Œ <code>next</code> æ–¹æ³•ï¼Œè€Œä¸Šé¢é”™è¯¯æç¤ºä¸­ä¹Ÿæç¤ºäº†æ˜¯åœ¨è°ƒç”¨ <code>next</code> æ–¹æ³•æ—¶å‡ºç°çš„é”™è¯¯ï¼Œæˆ‘ä»¬å°±çœ‹ä¸€ä¸‹ <code>Iterator.next</code> æ–¹æ³•</p>
<p>ä¸‹é¢çš„ <code>Itr</code> ç±»æ˜¯ <code>ArrayList</code> ç±»çš„ä¸€ä¸ªå†…éƒ¨ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Itr</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Iterator</span>&lt;E&gt; &#123;<br>    <span class="hljs-type">int</span> cursor;       <span class="hljs-comment">// index of next element to return</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">lastRet</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// index of last element returned; -1 if no such</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">expectedModCount</span> <span class="hljs-operator">=</span> modCount;<br><br>    <span class="hljs-comment">// prevent creating a synthetic constructor</span><br>    Itr() &#123;&#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNext</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> cursor != size;<br>    &#125;<br><br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    <span class="hljs-keyword">public</span> E <span class="hljs-title function_">next</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// åœ¨è°ƒç”¨ checkForComodification æ–¹æ³•çš„æ—¶å€™å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸</span><br>        checkForComodification();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> cursor;<br>        <span class="hljs-keyword">if</span> (i &gt;= size)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>();<br>        Object[] elementData = ArrayList.<span class="hljs-built_in">this</span>.elementData;<br>        <span class="hljs-keyword">if</span> (i &gt;= elementData.length)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentModificationException</span>();<br>        cursor = i + <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">return</span> (E) elementData[lastRet = i];<br>    &#125;<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkForComodification</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// å½“ modCount ä¸ç­‰äº expectedModCount æ—¶å°±ä¼šæŠ›å‡º ConcurrentModificationException å¼‚å¸¸</span><br>        <span class="hljs-keyword">if</span> (modCount != expectedModCount)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentModificationException</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="ConcurrentModificationException-å¼‚å¸¸æºç åˆ†æ"><a href="#ConcurrentModificationException-å¼‚å¸¸æºç åˆ†æ" class="headerlink" title="ConcurrentModificationException å¼‚å¸¸æºç åˆ†æ"></a>ConcurrentModificationException å¼‚å¸¸æºç åˆ†æ</h2><p>å‰é¢çœ‹ <code>Itr</code> ç±»çš„æ—¶å€™å·²ç»çœ‹åˆ°äº†å‡ ä¸ªå˜é‡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> cursor;       <span class="hljs-comment">// index of next element to return</span><br><span class="hljs-type">int</span> <span class="hljs-variable">lastRet</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// index of last element returned; -1 if no such</span><br><span class="hljs-type">int</span> <span class="hljs-variable">expectedModCount</span> <span class="hljs-operator">=</span> modCount;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>cursor</code>: è¿”å›çš„ä¸‹ä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡ï¼Œæ³¨æ„è¿™é‡Œè¯´çš„æ˜¯ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œè€Œä¸æ˜¯å½“å‰è¿”å›çš„å…ƒç´ </li>
<li><code>lastRet</code>: æœ€åè¿”å›çš„å…ƒç´ çš„ä¸‹æ ‡ï¼Œ-1 è¡¨ç¤ºæ²¡æœ‰è¿”å›è¿‡å…ƒç´ </li>
<li><code>expectedModCount</code>: è¿­ä»£å™¨ä¿®æ”¹å…ƒç´ çš„æ¬¡æ•°ï¼Œå½“ <code>modCount</code> ä¸ç­‰äº <code>expectedModCount</code> æ—¶å°±ä¼šæŠ›å‡º <code>ConcurrentModificationException</code> å¼‚å¸¸ï¼Œè¿™è¯´æ˜é™¤äº†å½“å‰è¿­ä»£å™¨è¿˜æœ‰å…¶ä»–çº¿ç¨‹åœ¨ä¿®æ”¹è¿™ä¸ªé›†åˆ</li>
<li><code>modCount</code>ï¼š è¿™ä¸ªä¸æ˜¯è¿­ä»£å™¨ä¸­çš„å˜é‡ï¼Œè€Œæ˜¯ <code>AbstracList</code> ä¸­çš„å˜é‡ï¼Œè¡¨ç¤ºé›†åˆè¢«ä¿®æ”¹çš„æ¬¡æ•°</li>
</ul>
<h3 id="modCount-å˜é‡çš„ä½œç”¨"><a href="#modCount-å˜é‡çš„ä½œç”¨" class="headerlink" title="modCount å˜é‡çš„ä½œç”¨"></a>modCount å˜é‡çš„ä½œç”¨</h3><p><code>modCount</code> å˜é‡çš„æ˜¯ç”¨æ¥ç»Ÿè®¡é›†åˆè¢«ä¿®æ”¹çš„æ¬¡æ•°ï¼Œ å½“æ‰§è¡Œ <code>ArrayList</code> ä¸­çš„ <code>add()</code>,<code>remove()</code>,<code>addAll()</code> ç­‰æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œ <code>modCount++</code>, ä»£è¡¨é›†åˆçš„å…ƒç´ è¢«ä¿®æ”¹äº†</p>
<h3 id="expectedModCount-çš„ä½œç”¨"><a href="#expectedModCount-çš„ä½œç”¨" class="headerlink" title="expectedModCount çš„ä½œç”¨"></a>expectedModCount çš„ä½œç”¨</h3><p><code>expectedModCount</code> æ˜¯è¿­ä»£å™¨ä¸­çš„å˜é‡ï¼Œå½“åˆå§‹åŒ–ä¸€ä¸ªè¿­ä»£å™¨æ—¶ï¼Œ<code>expectedModCount=modCount</code>, åªæœ‰åœ¨æ‰§è¡Œ <strong>è¿­ä»£å™¨</strong>çš„ <code>remove()</code> æ–¹æ³•æ—¶ï¼Œä¼šå¯¹ <code>expectedModCount</code> è¿›è¡Œé‡æ–°è®¾ç½®å€¼ï¼Œå…¶å®ä»è¿™é‡Œä¹Ÿèƒ½çœ‹å‡ºæ¥å½“æƒ³è¦åœ¨å¾ªç¯ä¸­å¯¹ <code>ArrayList</code> è¿›è¡Œåˆ é™¤æ—¶ï¼Œä¸ºä»€ä¹ˆè¦é€šè¿‡è¿­ä»£å™¨æ¥å®ç°ï¼Œå› ä¸ºè¿­ä»£å™¨çš„ <code>remove()</code> æ–¹æ³•ä¼šä¿®æ”¹ <code>expectedModCount</code></p>
<p>æ€»ç»“ï¼šç»è¿‡ä¸Šé¢çš„åˆ†æä¹ŸçŸ¥é“äº† <code>ConcurrentModificationException</code> å¼‚å¸¸å‡ºç°çš„åŸå› ï¼Œå°±æ˜¯åœ¨å¤šçº¿ç¨‹æ“ä½œ <code>ArrayList</code> æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨é€šè¿‡ <code>Iterator</code> éå†ï¼Œå…¶ä»–çº¿ç¨‹å¯¹é›†åˆè¿›è¡Œäº†ä¿®æ”¹ï¼ˆæ–°å¢ï¼Œåˆ é™¤å…ƒç´ ï¼‰ï¼Œå¯¼è‡´ <code>expectedModCount != modCount</code></p>
<h2 id="è§£å†³åŠæ³•"><a href="#è§£å†³åŠæ³•" class="headerlink" title="è§£å†³åŠæ³•"></a>è§£å†³åŠæ³•</h2><p>è¿˜æ˜¯ä»¥æœ€åˆçš„ä»£ç ä¸ºä¾‹ï¼Œå¦‚æœå°±æ˜¯æœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šéå†ï¼Œä¸€ä¸ªçº¿ç¨‹ä¼šä¿®æ”¹é›†åˆï¼Œé‚£ä¹ˆåº”è¯¥å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ<br>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡ ç§æ–¹å¼</p>
<ul>
<li>åŠ é”ï¼ˆæ— è®ºæ˜¯ <code>synchronized</code> è¿˜æ˜¯ <code>lock</code> ï¼‰, å¯¹é›†åˆçš„ <strong>è¯»</strong> å’Œ <strong>å†™</strong> åŠ ä¸ŠåŒä¸€æŠŠé”</li>
<li>ä½¿ç”¨ <code>CopyOnWriteArrayList</code> ç±»</li>
<li>å€Ÿç”¨ <code>CopyOnWriteArrayList</code> æ€æƒ³ï¼Œåœ¨ä½¿ç”¨ <code>foreach</code> éå†çš„æ—¶å€™å…ˆæ‹·è´ä¸€ä»½é›†åˆï¼Œæ¯”å¦‚ <code>List&lt;String&gt; list2 = new ArrayList&lt;&gt;(list);</code> ç„¶åä½¿ç”¨ <code>list2</code> å»éå†</li>
</ul>
]]></content>
      <categories>
        <category>java</category>
        <category>javaåŸºç¡€</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>HashMapè¯¦è§£</title>
    <url>/2023/834224a16039/index.html</url>
    <content><![CDATA[<h2 id="HashMapçš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#HashMapçš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="HashMapçš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ"></a>HashMapçš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ</h2><ol>
<li>ä¹‹å‰ <code>Jdk1.7</code> çš„å­˜å‚¨ç»“æ„æ˜¯æ•°ç»„+é“¾è¡¨ï¼Œåˆ°äº† <code>Jdk1.8</code> å˜æˆäº†æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ã€‚</li>
</ol>
<h2 id="HashMap-æ˜¯å¦‚ä½•å®šä½ç´¢å¼•ä¸‹æ ‡çš„"><a href="#HashMap-æ˜¯å¦‚ä½•å®šä½ç´¢å¼•ä¸‹æ ‡çš„" class="headerlink" title="HashMap æ˜¯å¦‚ä½•å®šä½ç´¢å¼•ä¸‹æ ‡çš„"></a>HashMap æ˜¯å¦‚ä½•å®šä½ç´¢å¼•ä¸‹æ ‡çš„</h2><p>å®šä½ <code>index</code> åˆ†æˆä¸¤æ­¥</p>
<ol>
<li><p>æ ¹æ® hash å‡½æ•°è·å– hash å€¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-type">int</span> h;<br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>å¯ä»¥çœ‹åˆ°ä¸Šé¢ä»£ç è·å–åˆ° hashCode ä¹‹åè¿˜å³ç§» 16 ä½ï¼Œå…·ä½“åŸå› åœ¨ä¸‹é¢åˆ†æ</strong></p>
</li>
<li><p>æ ¹æ®ç¬¬ä¸€æ­¥è®¡ç®—çš„ <code>hash</code> å€¼è·å–æ•°ç»„ä½ç½®ï¼ˆä¸€èˆ¬æ˜¯å¯¹æ•°ç»„é•¿åº¦å–æ¨¡ï¼Œ<code>HashMap</code> ä¸­æ˜¯å¯¹é•¿åº¦ -1 è¿›è¡Œ <code>&amp;</code> è¿ç®—ï¼‰</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> V <span class="hljs-title function_">putVal</span><span class="hljs-params">(<span class="hljs-type">int</span> hash, K key, V value, <span class="hljs-type">boolean</span> onlyIfAbsent,</span><br><span class="hljs-params">                   <span class="hljs-type">boolean</span> evict)</span> &#123;<br>    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="hljs-type">int</span> n, i;<br>    <span class="hljs-keyword">if</span> ((tab = table) == <span class="hljs-literal">null</span> || (n = tab.length) == <span class="hljs-number">0</span>)<br>        n = (tab = resize()).length;<br>        <span class="hljs-comment">// è·å–ä¸‹æ ‡çš„æ“ä½œæ˜¯  i = (n-1) &amp; hash</span><br>    <span class="hljs-keyword">if</span> ((p = tab[i = (n - <span class="hljs-number">1</span>) &amp; hash]) == <span class="hljs-literal">null</span>)<br>        tab[i] = newNode(hash, key, value, <span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">else</span> &#123;<br>       ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>è·å–ä¸‹æ ‡ä¸ºä»€ä¹ˆæ˜¯å¯¹ n-1 è¿›è¡Œä¸æ“ä½œè€Œä¸æ˜¯å–æ¨¡ï¼Ÿå…·ä½“åŸå› ä¸‹é¢åˆ†æ</strong></p>
<h2 id="ä¸ºä»€ä¹ˆéœ€è¦å¯¹keyçš„-hash-å€¼å³ç§»-16ä½"><a href="#ä¸ºä»€ä¹ˆéœ€è¦å¯¹keyçš„-hash-å€¼å³ç§»-16ä½" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦å¯¹keyçš„ hash å€¼å³ç§» 16ä½"></a>ä¸ºä»€ä¹ˆéœ€è¦å¯¹keyçš„ hash å€¼å³ç§» 16ä½</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">HashMap</span> <span class="hljs-string">ä¸­ä½¿ç”¨çš„</span> <span class="hljs-string">hash</span> <span class="hljs-string">å‡½æ•°æ˜¯</span> <span class="hljs-string">key.hash</span> <span class="hljs-string">^</span> <span class="hljs-string">(key.hash</span> <span class="hljs-string">&gt;&gt;</span> <span class="hljs-number">16</span><span class="hljs-string">)</span>  <span class="hljs-string">è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨</span> <span class="hljs-string">key.hash,</span> <span class="hljs-string">è¿™ä¹ˆåšçš„åŸå› æ˜¯å¢åŠ äº†æ‰°åŠ¨è®¡ç®—ï¼Œä½¿å¾—</span> <span class="hljs-string">hash</span> <span class="hljs-string">åˆ†å¸ƒçš„å°½å¯èƒ½çš„å‡åŒ€ï¼Œ</span> <span class="hljs-string">è®©å…ƒç´ çš„é«˜16</span> <span class="hljs-string">ä½å’Œä½16</span> <span class="hljs-string">ä½éƒ½å‚ä¸è¿ç®—</span><br><span class="hljs-string">ç¤ºä¾‹ï¼š</span><br><span class="hljs-string">æ¯”å¦‚æœ‰ä¸€ä¸ªå…ƒç´ 1æ¢æˆäºŒè¿›åˆ¶å¦‚ä¸‹</span><br><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1010 </span><span class="hljs-number">1010 </span><span class="hljs-number">1010 </span><span class="hljs-number">1010</span> <span class="hljs-string">ï¼ˆæ²¡æœ‰å³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span><br><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111</span>  <span class="hljs-string">ï¼ˆå³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span><br><br><span class="hljs-string">å¦å¤–ä¸€ä¸ªå…ƒç´ 2æ¢æˆäºŒè¿›åˆ¶å¦‚ä¸‹</span><br><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1110 </span><span class="hljs-number">1010 </span><span class="hljs-number">1010 </span><span class="hljs-number">1010 </span><span class="hljs-number">1010</span> <span class="hljs-string">ï¼ˆæ²¡æœ‰å³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span><br><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1110</span>  <span class="hljs-string">ï¼ˆå³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span><br><br><span class="hljs-string">åœ¨è®¡ç®—æ•°ç»„ä½ç½®çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯</span> <span class="hljs-string">hash</span> <span class="hljs-string">&amp;</span> <span class="hljs-string">(n</span> <span class="hljs-number">-1</span><span class="hljs-string">),</span>  <span class="hljs-string">è¦çŸ¥é“</span> <span class="hljs-string">n-1</span> <span class="hljs-string">è‚¯å®šæ˜¯ä¸€ä¸ªç›¸å¯¹æ¥è¯´æ¯”è¾ƒå°çš„æ•°å­—ï¼ˆ32ä¸ªbit</span> <span class="hljs-string">åªä¼šä½¿ç”¨æ¯”è¾ƒå°‘çš„ä½ä½ï¼‰ï¼Œ</span> <span class="hljs-string">æ¯”å¦‚é•¿åº¦æ˜¯</span> <span class="hljs-number">32</span><span class="hljs-string">ï¼Œ</span> <span class="hljs-string">å¯¹åº”çš„äºŒè¿›åˆ¶æ˜¯</span> <span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0001 </span><span class="hljs-number">1111</span><br><br><span class="hljs-string">ä½¿ç”¨æ²¡æœ‰å³ç§»çš„å…ƒç´ 1å’Œ</span> <span class="hljs-string">ï¼ˆ32</span> <span class="hljs-number">-1</span><span class="hljs-string">ï¼‰</span> <span class="hljs-string">è¿›è¡Œä¸æ“ä½œï¼ˆä¸æ“ä½œæ˜¯éƒ½ä¸º1æ‰ä¸º1ï¼Œå¦åˆ™ä¸º0ï¼‰</span><br><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111     </span><span class="hljs-number">1010 </span><span class="hljs-number">1010 </span><span class="hljs-number">1010 </span><span class="hljs-number">1010</span> <span class="hljs-string">ï¼ˆæ²¡æœ‰å³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span><br><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000      </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0001 </span><span class="hljs-number">1111</span><br><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000      </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">1010</span><br><br><span class="hljs-string">ä½¿ç”¨æ²¡æœ‰å³ç§»çš„å…ƒç´ 2å’Œ</span> <span class="hljs-string">ï¼ˆ32</span> <span class="hljs-number">-1</span><span class="hljs-string">ï¼‰</span> <span class="hljs-string">è¿›è¡Œä¸æ“ä½œï¼ˆä¸æ“ä½œæ˜¯éƒ½ä¸º1æ‰ä¸º1ï¼Œå¦åˆ™ä¸º0ï¼‰</span><br><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1100     </span><span class="hljs-number">1010 </span><span class="hljs-number">1010 </span><span class="hljs-number">1010 </span><span class="hljs-number">1010</span> <span class="hljs-string">ï¼ˆæ²¡æœ‰å³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span><br><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000      </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0001 </span><span class="hljs-number">1111</span><br><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000      </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">1010</span><br><span class="hljs-string">å¯ä»¥çœ‹åˆ°å…ƒç´ 1å’Œå…ƒç´ 2è®¡ç®—å‡ºæ¥ä¸‹æ ‡æ˜¯ç›¸åŒçš„ï¼Œè¿™ä¸ªä¸åŒæ˜¯å› ä¸ºå…ƒç´ 1å’Œå…ƒç´ 2çš„ä½16ä½æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œä¸åŒä¹‹å¤„åªåœ¨äºé«˜16ä½ï¼Œä½†æ˜¯å½“æˆ‘ä»¬å¯¹</span> <span class="hljs-string">ï¼ˆn-1ï¼‰è¿›è¡Œä¸æ“ä½œçš„æ—¶å€™ï¼Œç”±äº</span> <span class="hljs-string">n-1</span> <span class="hljs-string">çš„å€¼æ¯”è¾ƒå°ï¼Œç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œåªæœ‰ä½16ä½ä¼šè¿›è¡Œè¿ç®—çš„</span><br><br><span class="hljs-string">æ¥ä¸‹æ¥å†çœ‹ä¸€ä¸‹å¦‚æœä½¿ç”¨å³ç§»çš„hashè¿›è¡Œè®¡ç®—ä¼šæœ‰ä»€ä¹ˆä¸åŒ</span><br><span class="hljs-string">ä½¿ç”¨å³ç§»çš„å…ƒç´ 1å’Œ</span> <span class="hljs-string">ï¼ˆ32</span> <span class="hljs-number">-1</span><span class="hljs-string">ï¼‰</span> <span class="hljs-string">è¿›è¡Œä¸æ“ä½œï¼ˆä¸æ“ä½œæ˜¯éƒ½ä¸º1æ‰ä¸º1ï¼Œå¦åˆ™ä¸º0ï¼‰</span><br><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000      </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111</span> <span class="hljs-string">ï¼ˆæ²¡æœ‰å³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span><br><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000      </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0001 </span><span class="hljs-number">1111</span><br><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000      </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000  </span><span class="hljs-number">1111</span><br><br><span class="hljs-string">ç”¨å³ç§»çš„å…ƒç´ 2å’Œ</span> <span class="hljs-string">ï¼ˆ32</span> <span class="hljs-number">-1</span><span class="hljs-string">ï¼‰</span> <span class="hljs-string">è¿›è¡Œä¸æ“ä½œï¼ˆä¸æ“ä½œæ˜¯éƒ½ä¸º1æ‰ä¸º1ï¼Œå¦åˆ™ä¸º0ï¼‰</span><br><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000      </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1110</span> <span class="hljs-string">ï¼ˆæ²¡æœ‰å³ç§»16ä½çš„äºŒè¿›åˆ¶ï¼‰</span><br><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000      </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0001 </span><span class="hljs-number">1111</span><br><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000      </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000  </span><span class="hljs-number">1110</span><br><span class="hljs-string">å¯ä»¥çœ‹åˆ°è®¡ç®—å‡ºæ¥çš„</span> <span class="hljs-string">index</span> <span class="hljs-string">å€¼æ˜¯ä¸åŒçš„ï¼Œè¿™å°±æ˜¯å³ç§»å¸¦æ¥çš„è®©é«˜16ä½æœ‰å‚ä¸è¿ç®—çš„æ•ˆæœ</span><br></code></pre></td></tr></table></figure>

<h2 id="ä¸ºä»€ä¹ˆä¸å¯¹é•¿åº¦å–æ¨¡è€Œæ˜¯ä½¿ç”¨ä¸è¿ç®—"><a href="#ä¸ºä»€ä¹ˆä¸å¯¹é•¿åº¦å–æ¨¡è€Œæ˜¯ä½¿ç”¨ä¸è¿ç®—" class="headerlink" title="ä¸ºä»€ä¹ˆä¸å¯¹é•¿åº¦å–æ¨¡è€Œæ˜¯ä½¿ç”¨ä¸è¿ç®—"></a>ä¸ºä»€ä¹ˆä¸å¯¹é•¿åº¦å–æ¨¡è€Œæ˜¯ä½¿ç”¨ä¸è¿ç®—</h2><ol>
<li><code>X % 2^n = X &amp; (2^n â€“ 1)</code>  è¿™ä¸¤ç§è¿ç®—ç­‰ä»·ï¼Œæ‰€ä»¥è¿™ä¹Ÿæ˜¯ <code>HashMap</code> é•¿åº¦å– <code>2^n</code> çš„åŸå› <br>ä¹Ÿå¯ä»¥ä»æ•°æ®è§’åº¦è®°ä½ï¼Œå½“ <code>n</code> æ˜¯ 2 çš„å€æ•°æ—¶ï¼Œ <code>X % 2^n = X &amp; (2^n â€“ 1)</code>  ç­‰ä»·</li>
</ol>
<p><a href="https://www.cnblogs.com/ysocean/p/9054804.html">å…¬å¼è®¡ç®—å‚è€ƒé“¾æ¥</a></p>
<h2 id="HashMapæ˜¯å¦‚ä½•å®ç°æ‰©å®¹çš„"><a href="#HashMapæ˜¯å¦‚ä½•å®ç°æ‰©å®¹çš„" class="headerlink" title="HashMapæ˜¯å¦‚ä½•å®ç°æ‰©å®¹çš„"></a>HashMapæ˜¯å¦‚ä½•å®ç°æ‰©å®¹çš„</h2><p>æ‰©å®¹åç´¢å¼•å…¶å®ä¹Ÿæ˜¯ä½¿ç”¨ <code>hash &amp; ï¼ˆnewLength -1ï¼‰</code>, è¿™æ ·è®¡ç®—å‡ºæ¥çš„ä½ç½®è¦æ˜¯å’ŒåŸæ¥çš„å…ƒç´ åœ¨ç›¸åŒçš„ä½ç½®ï¼Œè¦ä¹ˆæ˜¯ åŸæ¥çš„ä½ç½®+æ—§æ•°ç»„é•¿åº¦&#x3D;æ–°ç´¢å¼•ä½ç½®</p>
<h2 id="HashMapæ˜¯å¦‚ä½•è§£å†³hashå†²çªçš„"><a href="#HashMapæ˜¯å¦‚ä½•è§£å†³hashå†²çªçš„" class="headerlink" title="HashMapæ˜¯å¦‚ä½•è§£å†³hashå†²çªçš„"></a>HashMapæ˜¯å¦‚ä½•è§£å†³hashå†²çªçš„</h2><ol>
<li>å¯¹ <code>hash</code> çš„è®¡ç®—è¿›è¡Œä¼˜åŒ–ï¼Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ <code>hashcode</code>,  è€Œæ˜¯å³ç§»16ä½ï¼Œè®©é«˜16ä½ä¹Ÿå‚ä¸è¿ç®—ï¼Œå‡å°‘<code>hash</code> å†²çª</li>
<li>å¦‚æœé‡åˆ°å†²çªï¼Œä½¿ç”¨æ‹‰é“¾æ³•è§£å†³</li>
</ol>
]]></content>
      <categories>
        <category>java</category>
        <category>javaåŸºç¡€</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>JDKåŠ¨æ€ä»£ç†è¯¦è§£</title>
    <url>/2023/92222e5bba3e/index.html</url>
    <content><![CDATA[<blockquote>
<p>JDKç‰ˆæœ¬ï¼š 17</p>
</blockquote>
<h2 id="åŠ¨æ€ä»£ç†ç¤ºä¾‹"><a href="#åŠ¨æ€ä»£ç†ç¤ºä¾‹" class="headerlink" title="åŠ¨æ€ä»£ç†ç¤ºä¾‹"></a>åŠ¨æ€ä»£ç†ç¤ºä¾‹</h2><p>ç¤ºä¾‹ä»£ç åŒ…å«</p>
<ol>
<li><p><code>IUser</code> æ¥å£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUser</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><code>IUser</code> æ¥å£å®ç°ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IUserImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUser</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;default hello&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>å®ç°äº† <code>InvocationHandler</code> æ¥å£çš„ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br>    <span class="hljs-keyword">private</span> IUser target;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CusInvocationHandler</span><span class="hljs-params">(IUser target)</span> &#123;<br>        <span class="hljs-built_in">this</span>.target = target;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        System.out.println(<span class="hljs-string">&quot;ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰&quot;</span>);<br>        method.invoke(target, args);<br>        System.out.println(<span class="hljs-string">&quot;ç›®æ ‡æ–¹æ³•æ‰§è¡Œå&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestProxy</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">IUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IUserImpl</span>();<br>        <span class="hljs-type">IUser</span> <span class="hljs-variable">proxyInstance</span> <span class="hljs-operator">=</span> (IUser)Proxy.newProxyInstance(user.getClass().getClassLoader(), user.getClass().getInterfaces(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">CusInvocationHandler</span>(user));<br>        <span class="hljs-type">TestProxy</span> <span class="hljs-variable">testProxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestProxy</span>();<br>        proxyInstance.sayHello();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>æµ‹è¯•ç»“æœ</p>
<figure class="highlight actionscript"><table><tr><td class="code"><pre><code class="hljs actionscript">ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰<br><span class="hljs-keyword">default</span> hello<br>ç›®æ ‡æ–¹æ³•æ‰§è¡Œå<br></code></pre></td></tr></table></figure></li>
</ol>
<p>å¦‚æœæƒ³è¦æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç†ç±»ä»£ç ï¼Œå¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/d513f5c497bd/index.html" title="javaè¾“å‡ºè¿è¡Œè¿‡ç¨‹ä¸­çš„ä»£ç†ç±»">javaè¾“å‡ºè¿è¡Œè¿‡ç¨‹ä¸­çš„ä»£ç†ç±»</a></li></ol>

<p>ä¸‹é¢ç»™å‡ºä¸Šé¢ç¤ºä¾‹ä»£ç ä¸­ç”Ÿæˆçš„ä»£ç†ç±»(çœç•¥å…¶ä»– <code>hashcode()</code> ç­‰å…¶ä»–æ— å…³ä»£ç  )</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">$Proxy0</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUser</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Method m0;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Method m1;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Method m2;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Method m3;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">super</span>.h.invoke(<span class="hljs-built_in">this</span>, m3, (Object[])<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (RuntimeException | Error var2) &#123;<br>            <span class="hljs-keyword">throw</span> var2;<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var3) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndeclaredThrowableException</span>(var3);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>è¯¥ä»£ç†ç±»å®ç°äº†æˆ‘ä»¬è‡ªå·±çš„æ¥å£ <code>IUser</code> å¹¶ä¸”ç»§æ‰¿äº† <code>Proxy</code>ï¼Œ<code>Proxy</code> ç±»ä¸­æœ‰å±æ€§ <code>InvocationHandler</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable &#123;<br>    <span class="hljs-keyword">protected</span> InvocationHandler h;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="ä»£ç†ç±»æ‰§è¡Œæµç¨‹"><a href="#ä»£ç†ç±»æ‰§è¡Œæµç¨‹" class="headerlink" title="ä»£ç†ç±»æ‰§è¡Œæµç¨‹"></a>ä»£ç†ç±»æ‰§è¡Œæµç¨‹</h2><p>ä»¥ä¸Šé¢ç¤ºä¾‹ä»£ç ä¸ºä¾‹ï¼Œä»£ç†ç±»çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<pre class="mermaid">sequenceDiagram
    participant A as IUserä»£ç†ç±»
    participant B as CusInvocationHandler
    participant C as IUserImpl
    A->>B: ä»£ç†ç±»çš„sayHello()
    B->>C: InvocationHandlerçš„invoke()</pre>

<h2 id="æ˜¯å¦ä¸€å®šéœ€è¦å®ç°ç±»"><a href="#æ˜¯å¦ä¸€å®šéœ€è¦å®ç°ç±»" class="headerlink" title="æ˜¯å¦ä¸€å®šéœ€è¦å®ç°ç±»"></a>æ˜¯å¦ä¸€å®šéœ€è¦å®ç°ç±»</h2><p>ä»£ç†ç±»æœ€ç»ˆä¼šæ‰§è¡Œ <code>InvocationHandler</code> çš„ <code>invoke()</code> æ–¹æ³•ï¼Œè€Œåœ¨ <code>invoke</code> æ–¹æ³•ä¸­ä¼šè°ƒç”¨å…·ä½“æ¥å£å®ç°ç±»çš„æ–¹æ³•ï¼ˆé€šè¿‡ <code>method.invoke()</code> è°ƒç”¨ï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br>    <span class="hljs-comment">// ç›®æ ‡å¯¹è±¡å¯ä»¥é€šç”¨çš„å†™ Object</span><br>    <span class="hljs-keyword">private</span> Object target;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CusInvocationHandler</span><span class="hljs-params">(Object target)</span> &#123;<br>        <span class="hljs-built_in">this</span>.target = target;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        System.out.println(<span class="hljs-string">&quot;ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰&quot;</span>);<br>        <span class="hljs-comment">// è¿™é‡Œè°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•</span><br>        method.invoke(target, args);<br>        System.out.println(<span class="hljs-string">&quot;ç›®æ ‡æ–¹æ³•æ‰§è¡Œå&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>é‚£ä¹ˆæ˜¯å¦ä¸€å®šéœ€è¦è¿™ä¸ªå®ç°ç±»å‘¢ï¼Ÿå…¶å®ä¸æ˜¯çš„ï¼Œä¸€èˆ¬æˆ‘ä»¬éœ€è¦å®ç°ç±»æ˜¯å› ä¸ºå®Œæˆä¸šåŠ¡é€»è¾‘ä¹‹å¤–çš„åŠŸèƒ½ï¼Œå®ç°ç±»æ‰æ˜¯å®Œæˆä¸»è¦çš„ä¸šåŠ¡é€»è¾‘ï¼Œä½†æ˜¯å¦‚æœä»£ç†ç±»åªéœ€è¦æ ¹æ®æ¥å£é‡Œé¢æ–¹æ³•ç›¸å…³çš„ä¿¡æ¯(æ¯”å¦‚æ¥å£åï¼Œæ¥å£ä¸­æ–¹æ³•å‚æ•°ï¼Œæ¥å£ä¸­æ–¹æ³•è¿”å›å€¼)å°±å·²ç»çŸ¥é“è¦æ€ä¹ˆåšäº†ï¼ˆå¯ä»¥è®¤ä¸ºæ ¹æ®çº¦å®šåšäº‹ï¼‰é‚£å¯ä»¥å®Œå…¨ä¸éœ€è¦å®ç°ç±»äº†ï¼Œæ¯”å¦‚ <code>Mybatis</code> æ¡†æ¶ä¸­çš„ <code>Mapper</code> æ¥å£å°±å®Œå…¨éœ€è¦å®ç°ç±», å…·ä½“å¯å‚è€ƒ</p>
<ol><li><a href="/2023/5cc9f93ce77a/index.html" title="Mybatisè·å–Mapperä»£ç†å¯¹è±¡çš„è¿‡ç¨‹åˆ†æ">Mybatisè·å–Mapperä»£ç†å¯¹è±¡çš„è¿‡ç¨‹åˆ†æ</a></li></ol>


<h2 id="ä¸€å¥è¯æ€»ç»“"><a href="#ä¸€å¥è¯æ€»ç»“" class="headerlink" title="ä¸€å¥è¯æ€»ç»“"></a>ä¸€å¥è¯æ€»ç»“</h2><p><strong>ä½¿ç”¨ <code>jdk</code> åŠ¨æ€ä»£ç†ï¼Œåªéœ€è¦å…³æ³¨å®ç°äº† <code>InvocationHandler</code> æ¥å£ç±»çš„ <code>invoke()</code> æ–¹æ³•å°±èƒ½çŸ¥é“ä»£ç†ç±»é¢å¤–åšçš„äº‹æƒ…æ˜¯ä»€ä¹ˆ</strong></p>
]]></content>
      <categories>
        <category>java</category>
        <category>javaåŸºç¡€</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>javaè¾“å‡ºè¿è¡Œè¿‡ç¨‹ä¸­çš„ä»£ç†ç±»</title>
    <url>/2023/d513f5c497bd/index.html</url>
    <content><![CDATA[<h2 id="è¾“å‡º-jdk-åŠ¨æ€ä»£ç†ç±»åˆ°æ–‡ä»¶"><a href="#è¾“å‡º-jdk-åŠ¨æ€ä»£ç†ç±»åˆ°æ–‡ä»¶" class="headerlink" title="è¾“å‡º jdk åŠ¨æ€ä»£ç†ç±»åˆ°æ–‡ä»¶"></a>è¾“å‡º jdk åŠ¨æ€ä»£ç†ç±»åˆ°æ–‡ä»¶</h2><p>åœ¨æµ‹è¯•ä»£ç çš„ç¬¬ä¸€è¡Œå¢åŠ ä¸‹é¢è¿™æ®µä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">System.getProperties().put(<span class="hljs-string">&quot;jdk.proxy.ProxyGenerator.saveGeneratedFiles&quot;</span>, <span class="hljs-string">&quot;true&quot;</span>);<br></code></pre></td></tr></table></figure>
<p>ä¸åŒ <code>jdk</code> ç‰ˆæœ¬çš„ä½¿ç”¨ <code>key</code> å¯èƒ½ä¸åŒï¼Œå…·ä½“çš„ <code>key</code> æ˜¯ä»€ä¹ˆå¯ä»¥æŸ¥çœ‹ <code>ProxyGenerator</code> ç±»çš„ <code>saveGeneratedFiles</code> å±æ€§ï¼Œ æ¯”å¦‚ <code>jdk17</code> ç‰ˆæœ¬ <code>ProxyGenerator</code> ç±»çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyGenerator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassWriter</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">saveGeneratedFiles</span> <span class="hljs-operator">=</span><br>            java.security.AccessController.doPrivileged(<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">GetBooleanAction</span>(<br>                            <span class="hljs-string">&quot;jdk.proxy.ProxyGenerator.saveGeneratedFiles&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ‰§è¡Œå®Œä»£ç ååœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¼šè¾“å‡ºåŠ¨æ€ä»£ç†ç±»</p>
<p><a href="https://arthas.aliyun.com/doc/">arthaså®˜æ–¹æ–‡æ¡£</a></p>
<h2 id="ä½¿ç”¨-arthas-è¾“å‡º-javaassist-ç”Ÿæˆçš„ä»£ç†ç±»"><a href="#ä½¿ç”¨-arthas-è¾“å‡º-javaassist-ç”Ÿæˆçš„ä»£ç†ç±»" class="headerlink" title="ä½¿ç”¨ arthas è¾“å‡º javaassist ç”Ÿæˆçš„ä»£ç†ç±»"></a>ä½¿ç”¨ arthas è¾“å‡º javaassist ç”Ÿæˆçš„ä»£ç†ç±»</h2><ol>
<li>å…ˆæ‰“ç«¯ç‚¹ï¼Œç¡®å®šä»£ç†ç±»çš„åç§°ï¼Œæ¯”å¦‚æœ‰ä¸€ä¸ªä»£ç†ç±»åç§°æ˜¯ <code>Hello$Adaptive</code></li>
<li>æ‰“å¼€ <code>arthas</code> é€‰æ‹©å¯¹åº”çš„è¿›ç¨‹è¿›å…¥åï¼Œä½¿ç”¨ä¸‹é¢å‘½ä»¤è¾“å‡ºä»£ç†ç±»</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä¸‹é¢å‘½ä»¤æ‰¾åˆ°å¯¹åº”ä»£ç†ç±»çš„å…¨è·¯å¾„ï¼Œ æ¯”å¦‚è¾“å‡ºç»“æœæ˜¯ com.example.dubbodemo.spi.Hello$Adaptive</span><br>sc *Hello$Adaptive*<br><span class="hljs-comment">// æ ¹æ®ä¸Šé¢æ‰¾åˆ°çš„ä»£ç†ç±»çš„å…¨è·¯å¾„ï¼Œè§£æå‡ºæºä»£ç å…µè¾“å‡ºåˆ°ç‰¹å®šçš„æ–‡ä»¶</span><br>jad com.example.dubbodemo.spi.Hello$Adaptive &gt; D:\\Hello$Adaptive.java<br></code></pre></td></tr></table></figure>

<h2 id="è¾“å‡º-cglib-ä»£ç†ç±»åˆ°æ–‡ä»¶"><a href="#è¾“å‡º-cglib-ä»£ç†ç±»åˆ°æ–‡ä»¶" class="headerlink" title="è¾“å‡º cglib ä»£ç†ç±»åˆ°æ–‡ä»¶"></a>è¾“å‡º cglib ä»£ç†ç±»åˆ°æ–‡ä»¶</h2><p>åœ¨æµ‹è¯•æ–¹æ³•çš„ç¬¬ä¸€è¡ŒåŠ ä¸Šå¦‚ä¸‹ä»£ç , ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯æŒ‡å®šè¾“å‡ºçš„æ–‡ä»¶å¤¹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, <span class="hljs-string">&quot;D:\\temp\\cglib&quot;</span>);<br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>java</category>
        <category>javaåŸºç¡€</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>javaçš„ioæ¨¡å‹</title>
    <url>/2023/180f5b629f58/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="BIO"><a href="#BIO" class="headerlink" title="BIO"></a>BIO</h2><ol>
<li><code>bio</code> æ˜¯åŒæ­¥é˜»å¡ <code>io</code>ï¼Œæ¯ä¸€ä¸ªè¿æ¥éƒ½éœ€è¦ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†</li>
<li><code>bio</code> ä¼šæœ‰èµ„æºæµªè´¹é—®é¢˜ï¼Œä¸€ä¸ªçº¿ç¨‹åªèƒ½å¤„ç†ä¸€ä¸ªè¿æ¥ï¼Œå¦‚æœæŸä¸ªå®¢æˆ·ç«¯å¹¶æ²¡æœ‰å‘é€æ•°æ®ï¼Œå¯¹åº”çš„æœåŠ¡ç«¯çº¿ç¨‹ä¹Ÿåªèƒ½é˜»å¡</li>
</ol>
<span id="more"></span>
<h3 id="é˜»å¡çš„å«ä¹‰"><a href="#é˜»å¡çš„å«ä¹‰" class="headerlink" title="é˜»å¡çš„å«ä¹‰"></a>é˜»å¡çš„å«ä¹‰</h3><ol>
<li>æœåŠ¡ç«¯ <code>ServerSocket</code> è°ƒç”¨ <code>accept()</code> æ–¹æ³•ä¼šé˜»å¡ï¼ˆå¦‚æœæ²¡æœ‰å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•åä¸ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼‰</li>
<li>çº¿ç¨‹ä»Socketçš„è¾“å…¥æµè¯»å…¥æ•°æ®æ—¶,å¦‚æœè¾“å…¥æµæ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®ï¼Œå°±ä¼šè¿›å…¥é˜»å¡çŠ¶æ€</li>
</ol>
<h3 id="java-bio-ä»£ç å®ç°"><a href="#java-bio-ä»£ç å®ç°" class="headerlink" title="java bio ä»£ç å®ç°"></a>java bio ä»£ç å®ç°</h3><p><strong>æœåŠ¡ç«¯ä»£ç </strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.demo.socket;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.net.ServerSocket;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusServerSocket</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ServerSocket</span> <span class="hljs-variable">serverSocket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerSocket</span>(<span class="hljs-number">8080</span>);) &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> serverSocket.accept();<br>                <span class="hljs-comment">//è¿æ¥æˆåŠŸåæ–°å¼€ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†è¿™ä¸ªè¿æ¥</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>                        <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                            <span class="hljs-comment">// read() æ–¹æ³•ä¸Šçš„æ³¨é‡Š If no byte is available because the stream is at the end of the file, the value -1 is returned</span><br>                            <span class="hljs-keyword">while</span> ((length = socket.getInputStream().read(bytes)) != -<span class="hljs-number">1</span>) &#123;<br>                                System.out.println(<span class="hljs-string">&quot;thredId:&quot;</span> + Thread.currentThread().getName() + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes, <span class="hljs-number">0</span>, length));<br>                            &#125;<br>                        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                            e.printStackTrace();<br>                        &#125;<br>                        System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:&quot;</span> + Thread.currentThread().getName());<br>                    &#125;<br>                &#125;).start();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (<br>                IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p><strong>å®¢æˆ·ç«¯å®ç°</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.demo.socket;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusClientSocket</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// å¤–å±‚å¾ªç¯ä¼šåˆ›å»ºå¤šä¸ª socketï¼Œç”¨æ¥æ¨¡æ‹Ÿå¤šä¸ª socket å®¢æˆ·ç«¯</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">3</span>; j++) &#123;<br>            <span class="hljs-keyword">try</span> (<span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>(<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<span class="hljs-number">8080</span>)) &#123;<br>                <span class="hljs-comment">// å†…å­˜å¾ªç¯ç”¨æ¥æ¨¡æ‹Ÿä¸€ä¸ªå®¢æˆ·ç«¯çš„å¤šæ¬¡é€šä¿¡</span><br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;<br>                    Thread.sleep(<span class="hljs-number">20</span>);<br>                    socket.getOutputStream().write((<span class="hljs-string">&quot;å®¢æˆ·ç«¯&quot;</span> + j + <span class="hljs-string">&quot;ç¬¬&quot;</span> + i + <span class="hljs-string">&quot;æ¬¡é€šä¿¡&quot;</span>).getBytes());<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (IOException | InterruptedException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>æ‰§è¡Œç»“æœ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">thredId:Thread-<span class="hljs-number">0</span>å®¢æˆ·ç«¯<span class="hljs-number">0</span>ç¬¬<span class="hljs-number">1</span>æ¬¡é€šä¿¡<br>thredId:Thread-<span class="hljs-number">0</span>å®¢æˆ·ç«¯<span class="hljs-number">0</span>ç¬¬<span class="hljs-number">2</span>æ¬¡é€šä¿¡<br>å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:Thread-<span class="hljs-number">0</span><br>thredId:Thread-<span class="hljs-number">1</span>å®¢æˆ·ç«¯<span class="hljs-number">1</span>ç¬¬<span class="hljs-number">1</span>æ¬¡é€šä¿¡<br>thredId:Thread-<span class="hljs-number">1</span>å®¢æˆ·ç«¯<span class="hljs-number">1</span>ç¬¬<span class="hljs-number">2</span>æ¬¡é€šä¿¡<br>å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:Thread-<span class="hljs-number">1</span><br>thredId:Thread-<span class="hljs-number">2</span>å®¢æˆ·ç«¯<span class="hljs-number">2</span>ç¬¬<span class="hljs-number">1</span>æ¬¡é€šä¿¡<br>thredId:Thread-<span class="hljs-number">2</span>å®¢æˆ·ç«¯<span class="hljs-number">2</span>ç¬¬<span class="hljs-number">2</span>æ¬¡é€šä¿¡<br>å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:Thread-<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>
<ol>
<li>æ‰§è¡Œå®Œæˆä¹‹åï¼ŒæœåŠ¡ç«¯ç¨‹åºå¹¶ä¸ä¼šå…³é—­ï¼Œä¼šä¸€ç›´åœ¨è¿è¡Œ</li>
<li>ä»ä¸Šé¢ç»“æœçœ‹ï¼Œä¸€å…±åˆ›å»ºäº†ä¸‰ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œ</li>
</ol>
<h3 id="ä½¿ç”¨çº¿ç¨‹æ± ä¼˜åŒ–-bio-å®ç°"><a href="#ä½¿ç”¨çº¿ç¨‹æ± ä¼˜åŒ–-bio-å®ç°" class="headerlink" title="ä½¿ç”¨çº¿ç¨‹æ± ä¼˜åŒ– bio å®ç°"></a>ä½¿ç”¨çº¿ç¨‹æ± ä¼˜åŒ– bio å®ç°</h3><p>å®¢æˆ·ç«¯ä»£ç ä¸éœ€è¦æ”¹åŠ¨ï¼Œåªéœ€è¦æ›´æ”¹æœåŠ¡ç«¯ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.demo.socket;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.net.ServerSocket;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusServerSocket</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ServerSocket</span> <span class="hljs-variable">serverSocket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerSocket</span>(<span class="hljs-number">8080</span>);) &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> serverSocket.accept();<br>                <span class="hljs-comment">//è¿æ¥æˆåŠŸåæ–°å¼€ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†è¿™ä¸ªè¿æ¥</span><br>                executorService.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientTask</span>(socket));<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (<br>                IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientTask</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br><br>        <span class="hljs-keyword">private</span> Socket socket;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">ClientTask</span><span class="hljs-params">(Socket socket)</span> &#123;<br>            <span class="hljs-built_in">this</span>.socket = socket;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// read() æ–¹æ³•ä¸Šçš„æ³¨é‡Š If no byte is available because the stream is at the end of the file, the value -1 is returned</span><br>                <span class="hljs-keyword">while</span> ((length = socket.getInputStream().read(bytes)) != -<span class="hljs-number">1</span>) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;thredId:&quot;</span> + Thread.currentThread().getName() + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes, <span class="hljs-number">0</span>, length));<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:&quot;</span> + Thread.currentThread().getName());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">thredId:pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>å®¢æˆ·ç«¯<span class="hljs-number">0</span>ç¬¬<span class="hljs-number">1</span>æ¬¡é€šä¿¡<br>thredId:pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>å®¢æˆ·ç«¯<span class="hljs-number">0</span>ç¬¬<span class="hljs-number">2</span>æ¬¡é€šä¿¡<br>å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span><br>thredId:pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>å®¢æˆ·ç«¯<span class="hljs-number">1</span>ç¬¬<span class="hljs-number">1</span>æ¬¡é€šä¿¡<br>thredId:pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>å®¢æˆ·ç«¯<span class="hljs-number">1</span>ç¬¬<span class="hljs-number">2</span>æ¬¡é€šä¿¡<br>å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span><br>thredId:pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>å®¢æˆ·ç«¯<span class="hljs-number">2</span>ç¬¬<span class="hljs-number">1</span>æ¬¡é€šä¿¡<br>thredId:pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>å®¢æˆ·ç«¯<span class="hljs-number">2</span>ç¬¬<span class="hljs-number">2</span>æ¬¡é€šä¿¡<br>å®¢æˆ·ç«¯å…³é—­, å½“å‰çº¿ç¨‹:pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>
<p>å³ä½¿ä½¿ç”¨çº¿ç¨‹æ± è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæœ¬åœ°è¿˜æ˜¯é˜»å¡ioï¼Œåªæœ‰å½“ä¸€ä¸ªå®¢æˆ·ç«¯é€šä¿¡å®Œæˆï¼ˆsocketå…³é—­äº†ï¼‰ï¼Œå¦å¤–ä¸€ä¸ª socket æ‰å¯ä»¥å¼€å§‹è¿›è¡Œé€šä¿¡</p>
<h2 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h2><ol>
<li>nio æ˜¯éé˜»å¡ ioï¼ˆNon-block ioï¼‰</li>
<li>éé˜»å¡ io çš„é‡ç‚¹æ˜¯ <strong>äº‹ä»¶</strong> å’Œ <strong>é€šçŸ¥æˆ–è½®è¯¢</strong></li>
<li><code>java.nio.channerls</code> åŒ…æä¾›äº†æ”¯æŒéé˜»å¡é€šä¿¡çš„ç±»<ol>
<li><code>ServerSocketChannel</code>: <code>ServerSocket</code> çš„æ›¿ä»£ç±»ï¼Œæ”¯æŒé˜»å¡é€šä¿¡ä¸éé˜»å¡é€šä¿¡</li>
<li><code>SocketChannerl</code>ï¼š <code>Socket</code> çš„æ›¿ä»£ç±»ï¼Œæ”¯æŒé˜»å¡é€šä¿¡ä¸éé˜»å¡é€šä¿¡</li>
<li><code>Selector</code>ï¼š ä¸º<code>ServerSocketChannel</code>ç›‘æ§æ¥æ”¶è¿æ¥å°±ç»ªäº‹ä»¶ï¼Œä¸º<code>SocketChannel</code>ç›‘æ§è¿æ¥å°±ç»ªã€è¯»å°±ç»ªå’Œå†™å°±ç»ªäº‹ä»¶</li>
<li><code>SelectionKey</code>ï¼šä»£è¡¨<code>ServerSocketChannel</code>ä»¥åŠ<code>SocketChannel</code>å‘<code>Selector</code>æ³¨å†Œäº‹ä»¶çš„å¥æŸ„ã€‚å½“ä¸€ä¸ª<code>SelectionKey</code>å¯¹è±¡ä½äº<code>Selector</code>å¯¹è±¡çš„<code>selected-keys</code>é›†åˆä¸­ï¼Œå°±è¡¨ç¤ºä¸è¿™ä¸ª<code>SelectionKey</code>å¯¹è±¡ç›¸å…³çš„äº‹ä»¶å‘ç”Ÿäº†</li>
</ol>
</li>
</ol>
<h3 id="NIO-æ‰§è¡Œæµç¨‹"><a href="#NIO-æ‰§è¡Œæµç¨‹" class="headerlink" title="NIO æ‰§è¡Œæµç¨‹"></a>NIO æ‰§è¡Œæµç¨‹</h3><pre class="mermaid">sequenceDiagram
    participant A as ServerSocketChannel
    participant B as Selector
    participant C as socketChannel
    A->>A: open()
    B-->>B: open()
    A-->>B: register(SelectionKey.OP_ACCEPT)
    C-->>C: open()
    C-->>B: register(SelectionKey.OP_CONNECT)
    B-->>A: selectionKey.isAcceptable()==true
    A-->>A: accept()
    A-->>B: register(SelectionKey.OP_READ)
    C-->>B: write(byte[])
    B-->>A: selectionKey.isReadable()==true
    A-->>A: read()
    A-->>B: register(SelectionKey.OP_WRITE)</pre>


<h2 id="ä»£ç ç¤ºä¾‹"><a href="#ä»£ç ç¤ºä¾‹" class="headerlink" title="ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h2><p>ä»£ç æ‰§è¡Œæµç¨‹</p>
<ol>
<li>æœåŠ¡ç«¯å¯åŠ¨</li>
<li>å®¢æˆ·ç«¯å¯åŠ¨è¿æ¥æœåŠ¡ç«¯ï¼ˆæ³¨å†Œ <strong>å¯è¯»</strong>å’Œ <strong>å¯å†™</strong>äº‹ä»¶ï¼‰</li>
<li>å®¢æˆ·ç«¯å‘ç”Ÿå¯å†™äº‹ä»¶ï¼Œå¼€å§‹å†™æ•°æ®åˆ°æœåŠ¡ç«¯å¹¶ä¸” <strong>å–æ¶ˆå¯å†™äº‹ä»¶</strong></li>
<li>æœåŠ¡ç«¯å‘ç”Ÿå¯è¯»äº‹ä»¶ï¼Œè¯»å–æ•°æ®å¹¶æ³¨å†Œå¯å†™äº‹ä»¶</li>
<li>æœåŠ¡ç«¯å†™æ•°æ®åˆ°ç”¨æˆ·ç«¯å¹¶ <strong>å–æ¶ˆå¯å†™äº‹ä»¶</strong></li>
<li>å®¢æˆ·ç«¯å‘ç”Ÿå¯è¯»äº‹ä»¶ï¼Œè¯»å–æ•°æ®åæ³¨å†Œå¯å†™äº‹ä»¶</li>
<li>é‡å¤3-6æ­¥éª¤</li>
</ol>
<p>ä¸Šé¢æœ‰ä¸€ä¸ªæ ¸å¿ƒçš„æ­¥éª¤æ˜¯ï¼Œä¸è®ºæ˜¯ç®¡ç†ç«¯è¿˜æ˜¯æœåŠ¡ç«¯ï¼Œåœ¨å†™å®Œæ•°æ®ä¹‹åéƒ½è¦å–æ¶ˆå¯å†™äº‹ä»¶ï¼Œå½“æƒ³è¦å†™æ•°æ®çš„æ—¶å€™ï¼Œå†è¿›è¡Œæ³¨å†Œå†™äº‹ä»¶å³å¯</p>
<ol>
<li>å¦‚æœæ³¨å†Œå®Œå†™äº‹ä»¶å¹¶ä¸”å†™å®Œæ•°æ®ä¹‹åï¼Œæ²¡æœ‰è¿›è¡Œå–æ¶ˆï¼Œé‚£ä¹ˆ <code>selectionKey.isWritable()</code> ä¼šä¸€ç›´è¿”å›trueï¼Œ åŸå› è¯·çœ‹ç¬¬äºŒç‚¹</li>
<li><code>SocketChannel</code> åœ¨å¦‚ä¸‹æƒ…å†µä¸‹éƒ½æ˜¯å¯å†™çš„çŠ¶æ€<ol>
<li>å½“è¿æ¥å»ºç«‹åï¼Œå¯ä»¥å‘ <code>SocketChannel</code> ä¸­å†™å…¥æ•°æ®</li>
<li>å½“ <code>SocketChannel</code> ä¸­çš„è¾“å‡ºç¼“å†²åŒºæœ‰ç©ºé—´æ—¶ï¼Œå¯ä»¥å†™å…¥æ•°æ®, æ‰€å¤„åªè¦ç¼“å†²åŒºæœ‰ç©ºé—´ï¼Œå°±ä¼šä¸€ç›´å¯å†™</li>
</ol>
</li>
</ol>
<h3 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusServerSocket</span> &#123;<br><br>    <span class="hljs-comment">/*ç¼“å†²åŒºå¤§å°*/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">BLOCK</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span>;<br>    <span class="hljs-comment">/*æ¥å—æ•°æ®ç¼“å†²åŒº*/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">sendBuffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(BLOCK);<br>    <span class="hljs-comment">/*å‘é€æ•°æ®ç¼“å†²åŒº*/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">receiveBuffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(BLOCK);<br>    <span class="hljs-keyword">private</span> Selector selector;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CusServerSocket</span><span class="hljs-params">(<span class="hljs-type">int</span> port)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// æ‰“å¼€æœåŠ¡å™¨å¥—æ¥å­—é€šé“</span><br>        <span class="hljs-type">ServerSocketChannel</span> <span class="hljs-variable">serverSocketChannel</span> <span class="hljs-operator">=</span> ServerSocketChannel.open();<br>        <span class="hljs-comment">// æœåŠ¡å™¨é…ç½®ä¸ºéé˜»å¡</span><br>        serverSocketChannel.configureBlocking(<span class="hljs-literal">false</span>);<br>        serverSocketChannel.socket().bind(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(port));<br>        selector = Selector.open();<br>        <span class="hljs-comment">// æ³¨å†Œåˆ°selectorï¼Œç­‰å¾…è¿æ¥</span><br>        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);<br>        System.out.println(<span class="hljs-string">&quot;æœåŠ¡å¯åŠ¨----8080:&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listen</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-comment">// é€‰æ‹©ä¸€ç»„é”®ï¼Œå¹¶ä¸”ç›¸åº”çš„é€šé“å·²ç»æ‰“å¼€</span><br>            selector.select();<br>            <span class="hljs-comment">// è¿”å›æ­¤é€‰æ‹©å™¨çš„å·²é€‰æ‹©é”®é›†ã€‚</span><br>            Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();<br>            Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();<br>            <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>                <span class="hljs-type">SelectionKey</span> <span class="hljs-variable">selectionKey</span> <span class="hljs-operator">=</span> iterator.next();<br>                iterator.remove();<br>                handleEvent(selectionKey);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// å¤„ç†è¯·æ±‚</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleEvent</span><span class="hljs-params">(SelectionKey selectionKey)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException &#123;<br>        String receiveText;<br>        String sendText;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// å¯è¿æ¥</span><br>        <span class="hljs-keyword">if</span> (selectionKey.isAcceptable()) &#123;<br>            <span class="hljs-type">ServerSocketChannel</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> (ServerSocketChannel) selectionKey.channel();<br>            <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> server.accept();<br>            <span class="hljs-comment">// è®¾ç½®è¯¥é€šé“éé˜»å¡</span><br>            client.configureBlocking(<span class="hljs-literal">false</span>);<br>            <span class="hljs-comment">// æ³¨å†Œå¯è¯»å’Œå¯å†™äº‹ä»¶</span><br>            client.register(selector, SelectionKey.OP_READ);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selectionKey.isReadable()) &#123;<br>            <span class="hljs-comment">// è¿”å›ä¸ºä¹‹åˆ›å»ºæ­¤é”®çš„é€šé“ã€‚</span><br>            <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> (SocketChannel) selectionKey.channel();<br>            <span class="hljs-comment">//å°†ç¼“å†²åŒºæ¸…ç©ºä»¥å¤‡ä¸‹æ¬¡è¯»å–</span><br>            receiveBuffer.clear();<br>            <span class="hljs-comment">//è¯»å–æœåŠ¡å™¨å‘é€æ¥çš„æ•°æ®åˆ°ç¼“å†²åŒºä¸­</span><br>            count = client.read(receiveBuffer);<br>            <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>                receiveText = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(receiveBuffer.array(), <span class="hljs-number">0</span>, count);<br>                System.out.println(<span class="hljs-string">&quot;æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®--:&quot;</span> + receiveText);<br>            &#125;<br>            client.register(selector, SelectionKey.OP_WRITE);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selectionKey.isWritable()) &#123;<br>            sendBuffer.clear();<br>            <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> (SocketChannel) selectionKey.channel();<br>            <span class="hljs-type">LocalTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalTime.now();<br>            sendText = <span class="hljs-string">&quot;æœåŠ¡ç«¯--ã€‹å®¢æˆ·ç«¯  &quot;</span> + now.getMinute() + <span class="hljs-string">&quot;:&quot;</span> + now.getSecond();<br>            sendBuffer.put(sendText.getBytes());<br>            <span class="hljs-comment">//å°†ç¼“å†²åŒºå„æ ‡å¿—å¤ä½,å› ä¸ºå‘é‡Œé¢putäº†æ•°æ®æ ‡å¿—è¢«æ”¹å˜è¦æƒ³ä»ä¸­è¯»å–æ•°æ®å‘å‘æœåŠ¡å™¨,å°±è¦å¤ä½</span><br>            sendBuffer.flip();<br>            <span class="hljs-comment">//è¾“å‡ºåˆ°é€šé“</span><br>            client.write(sendBuffer);<br>            selectionKey.interestOps(SelectionKey.OP_READ);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">8080</span>;<br>        <span class="hljs-type">CusServerSocket</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CusServerSocket</span>(port);<br>        server.listen();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ç”¨æˆ·ç«¯"><a href="#ç”¨æˆ·ç«¯" class="headerlink" title="ç”¨æˆ·ç«¯"></a>ç”¨æˆ·ç«¯</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusClientSocket</span> &#123;<br><br>    <span class="hljs-comment">/*ç¼“å†²åŒºå¤§å°*/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">BLOCK</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span>;<br>    <span class="hljs-comment">/*æ¥å—æ•°æ®ç¼“å†²åŒº*/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">sendBuffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(BLOCK);<br>    <span class="hljs-comment">/*å‘é€æ•°æ®ç¼“å†²åŒº*/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">receiveBuffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(BLOCK);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException &#123;<br>        <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">socketChannel</span> <span class="hljs-operator">=</span> SocketChannel.open();<br>        socketChannel.configureBlocking(<span class="hljs-literal">false</span>);<br>        <span class="hljs-type">Selector</span> <span class="hljs-variable">selector</span> <span class="hljs-operator">=</span> Selector.open();<br>        socketChannel.register(selector, SelectionKey.OP_CONNECT);<br>        socketChannel.connect(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">8080</span>));<br><br>        Set&lt;SelectionKey&gt; selectionKeys;<br>        Iterator&lt;SelectionKey&gt; iterator;<br>        SelectionKey selectionKey;<br>        SocketChannel client;<br>        String receiveText;<br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            selector.select();<br>            <span class="hljs-comment">//è¿”å›æ­¤é€‰æ‹©å™¨çš„å·²é€‰æ‹©é”®é›†ã€‚</span><br>            selectionKeys = selector.selectedKeys();<br>            iterator = selectionKeys.iterator();<br>            <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>                selectionKey = iterator.next();<br>                iterator.remove();<br>                <span class="hljs-keyword">if</span> (selectionKey.isConnectable()) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;client connect&quot;</span>);<br>                    client = (SocketChannel) selectionKey.channel();<br>                    <span class="hljs-comment">// åˆ¤æ–­æ­¤é€šé“ä¸Šæ˜¯å¦æ­£åœ¨è¿›è¡Œè¿æ¥æ“ä½œã€‚</span><br>                    <span class="hljs-comment">// å®Œæˆå¥—æ¥å­—é€šé“çš„è¿æ¥è¿‡ç¨‹ã€‚</span><br>                    <span class="hljs-keyword">if</span> (client.isConnectionPending()) &#123;<br>                        client.finishConnect();<br>                        System.out.println(<span class="hljs-string">&quot;å®Œæˆè¿æ¥!&quot;</span>);<br>                    &#125;<br>                    <span class="hljs-comment">// è¿æ¥æˆåŠŸä¹‹åæ³¨å†Œå¯è¯»å’Œå¯å†™äº‹ä»¶</span><br>                    client.register(selector, SelectionKey.OP_READ | SelectionKey.OP_WRITE);<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selectionKey.isReadable()) &#123;<br>                    client = (SocketChannel) selectionKey.channel();<br>                    <span class="hljs-comment">//å°†ç¼“å†²åŒºæ¸…ç©ºä»¥å¤‡ä¸‹æ¬¡è¯»å–</span><br>                    receiveBuffer.clear();<br>                    <span class="hljs-comment">//è¯»å–æœåŠ¡å™¨å‘é€æ¥çš„æ•°æ®åˆ°ç¼“å†²åŒºä¸­</span><br>                    <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> client.read(receiveBuffer);<br>                    <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>                        receiveText = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(receiveBuffer.array(), <span class="hljs-number">0</span>, count);<br>                        System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®--:&quot;</span> + receiveText);<br>                    &#125;<br>                    client.register(selector, SelectionKey.OP_WRITE);<br><br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selectionKey.isWritable()) &#123;<br>                    Thread.sleep(<span class="hljs-number">2000</span>);<br>                    sendBuffer.clear();<br>                    client = (SocketChannel) selectionKey.channel();<br>                    <span class="hljs-type">LocalTime</span> <span class="hljs-variable">localTime</span> <span class="hljs-operator">=</span> LocalTime.now();<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">sendText</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;å®¢æˆ·ç«¯å‘é€çš„æ•°æ®--&gt;&quot;</span> + localTime.getMinute() + <span class="hljs-string">&quot;:&quot;</span> + localTime.getSecond();<br>                    sendBuffer.put(sendText.getBytes());<br>                    <span class="hljs-comment">//å°†ç¼“å†²åŒºå„æ ‡å¿—å¤ä½,å› ä¸ºå‘é‡Œé¢putäº†æ•°æ®æ ‡å¿—è¢«æ”¹å˜è¦æƒ³ä»ä¸­è¯»å–æ•°æ®å‘å‘æœåŠ¡å™¨,å°±è¦å¤ä½</span><br>                    sendBuffer.flip();<br>                    client.write(sendBuffer);<br>                    <span class="hljs-comment">// å†™å®Œä¹‹åéœ€è¦æ³¨é”€å†™äº‹ä»¶ï¼Œå¦åˆ™ä¼šä¸€ç›´åˆ¤æ–­æˆå¯å†™, è¿™é‡Œè¡¨æ˜¯å¯¹è¯»äº‹ä»¶æ„Ÿå…´è¶£ï¼Œå°±æ˜¯ç§»é™¤å†™äº‹ä»¶çš„æ„æ€</span><br>                    selectionKey.interestOps(SelectionKey.OP_READ);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div class="tabs" id="æ‰§è¡Œç»“æœ"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="æ‰§è¡Œç»“æœ-1">æœåŠ¡ç«¯ç»“æœ</button><button type="button" class="tab " data-href="æ‰§è¡Œç»“æœ-2">ç”¨æˆ·ç«¯ç»“æœ</button></ul><div class="tab-contents"><div class="tab-item-content active" id="æ‰§è¡Œç»“æœ-1"><figure class="highlight brainfuck"><table><tr><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">æœåŠ¡å¯åŠ¨</span><span class="hljs-literal">----</span><span class="hljs-comment">8080:</span><br><span class="hljs-comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="hljs-literal">--</span>&gt;<span class="hljs-comment">59:45</span><br><span class="hljs-comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="hljs-literal">--</span>&gt;<span class="hljs-comment">59:47</span><br><span class="hljs-comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="hljs-literal">--</span>&gt;<span class="hljs-comment">59:49</span><br><span class="hljs-comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="hljs-literal">--</span>&gt;<span class="hljs-comment">59:51</span><br><span class="hljs-comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="hljs-literal">--</span>&gt;<span class="hljs-comment">59:53</span><br><span class="hljs-comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="hljs-literal">--</span>&gt;<span class="hljs-comment">59:55</span><br><span class="hljs-comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="hljs-literal">--</span>&gt;<span class="hljs-comment">59:57</span><br><span class="hljs-comment">æœåŠ¡å™¨ç«¯æ¥å—å®¢æˆ·ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span><span class="hljs-literal">--</span>&gt;<span class="hljs-comment">59:59</span><br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="æ‰§è¡Œç»“æœ-2"><figure class="highlight brainfuck"><table><tr><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">client connect</span><br><span class="hljs-comment">å®Œæˆè¿æ¥!</span><br><span class="hljs-comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:æœåŠ¡ç«¯</span><span class="hljs-literal">--</span><span class="hljs-comment">ã€‹å®¢æˆ·ç«¯  59:45</span><br><span class="hljs-comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:æœåŠ¡ç«¯</span><span class="hljs-literal">--</span><span class="hljs-comment">ã€‹å®¢æˆ·ç«¯  59:47</span><br><span class="hljs-comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:æœåŠ¡ç«¯</span><span class="hljs-literal">--</span><span class="hljs-comment">ã€‹å®¢æˆ·ç«¯  59:49</span><br><span class="hljs-comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:æœåŠ¡ç«¯</span><span class="hljs-literal">--</span><span class="hljs-comment">ã€‹å®¢æˆ·ç«¯  59:51</span><br><span class="hljs-comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:æœåŠ¡ç«¯</span><span class="hljs-literal">--</span><span class="hljs-comment">ã€‹å®¢æˆ·ç«¯  59:53</span><br><span class="hljs-comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:æœåŠ¡ç«¯</span><span class="hljs-literal">--</span><span class="hljs-comment">ã€‹å®¢æˆ·ç«¯  59:55</span><br><span class="hljs-comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:æœåŠ¡ç«¯</span><span class="hljs-literal">--</span><span class="hljs-comment">ã€‹å®¢æˆ·ç«¯  59:57</span><br><span class="hljs-comment">å®¢æˆ·ç«¯æ¥å—æœåŠ¡å™¨ç«¯æ•°æ®</span><span class="hljs-literal">--</span><span class="hljs-comment">:æœåŠ¡ç«¯</span><span class="hljs-literal">--</span><span class="hljs-comment">ã€‹å®¢æˆ·ç«¯  59:59</span><br></code></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>


]]></content>
      <categories>
        <category>java</category>
        <category>javaåŸºç¡€</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>javaå†…å­˜æ¨¡å‹</title>
    <url>/2023/08549388833c/index.html</url>
    <content><![CDATA[<h2 id="ä¸»è¦å†…å®¹"><a href="#ä¸»è¦å†…å®¹" class="headerlink" title="ä¸»è¦å†…å®¹"></a>ä¸»è¦å†…å®¹</h2><p><code>java</code>å†…å­˜æ¨¡å‹å®é™…ä¸Šæ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œæ˜¯ä¸€å¥—è§„èŒƒï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå®é™…çš„ä¸œè¥¿ï¼Œè€Œ<code>java</code>å†…å­˜ç»“æ„å°±æ˜¯æ ¹æ®è¿™ä¸€å¥—è§„èŒƒæ¥è¿›è¡Œåˆ’åˆ†çš„ã€‚</p>
<span id="more"></span>

<p>å¯¹äº<code>java</code>å†…å­˜æ¨¡å‹æˆ‘ä»¬ä¸»è¦éœ€è¦äº†è§£ä»¥ä¸‹å‡ ä¸ªå†…å®¹ï¼š</p>
<ul>
<li>ç¡¬ä»¶å†…å­˜æ¶æ„</li>
<li>çº¿ç¨‹å’Œ<code>jvm</code></li>
<li><code>java</code>å†…å­˜æ¨¡å‹</li>
<li><code>java</code>å†…å­˜æ¨¡å‹å¯¹å¹¶å‘ç¼–ç¨‹çš„æ”¯æŒ</li>
</ul>
<h2 id="ç¡¬ä»¶å†…å­˜æ¶æ„"><a href="#ç¡¬ä»¶å†…å­˜æ¶æ„" class="headerlink" title="ç¡¬ä»¶å†…å­˜æ¶æ„"></a>ç¡¬ä»¶å†…å­˜æ¶æ„</h2><blockquote>
<p>ç‰©ç†æœºé‡åˆ°çš„å¹¶å‘é—®é¢˜ä¸è™šæ‹Ÿæœºä¸­çš„æƒ…å†µæœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„ï¼Œç‰©ç†æœºå¯¹å¹¶å‘çš„å¤„ç†æ–¹æ¡ˆå¯¹è™šæ‹Ÿæœºçš„å®ç°ä¹Ÿæœ‰ç›¸å½“å¤§çš„å‚è€ƒæ„ä¹‰</p>
</blockquote>
<p>åœ¨è®¡ç®—æœºæ¨¡å‹ä¸­ä¸»è¦æ˜¯æœ‰äº”ä¸ªéƒ¨åˆ†æ¥ç»„æˆçš„</p>
<ol>
<li>è¾“å…¥</li>
<li>å¯„å­˜å™¨</li>
<li>cpu<ol>
<li>å¤„ç†å™¨</li>
<li>æ§åˆ¶å™¨</li>
</ol>
</li>
<li>è¾“å‡º</li>
</ol>
<p>å…¶ä¸­<strong>å¤„ç†å™¨</strong>å’Œ<strong>æ§åˆ¶å™¨</strong>åˆèµ·æ¥å°±æ˜¯æˆ‘ä»¬æ‰€ç¤ºçš„<code>cpu</code></p>
<p>è¿ç®—å™¨çš„è¿ç®—é€Ÿåº¦éƒ½æ˜¯å¾ˆå¿«çš„ï¼Œä½†æ˜¯æˆ‘ä»¬çš„æ•°æ®å­˜å‚¨ä¸å¯èƒ½æ‰€æœ‰æ•°æ®éƒ½å­˜æ”¾åœ¨å¯„å­˜å™¨ä¸­ï¼Œæ‰€ä»¥æ•°æ®çš„<code>io</code>æ“ä½œéƒ½æ˜¯å¾ˆæœ‰å¿…è¦ çš„ï¼Œè¿™æ ·å°±ä¸èƒ½å……åˆ†åˆ©ç”¨<code>cpu</code>çš„è¿ç®—èƒ½åŠ›ï¼Œæ­¤æ—¶å°±éœ€è¦<strong>åŠ ä¸Šè¯»å†™é€Ÿåº¦å’Œå¤„ç†å™¨è¿ç®—é€Ÿåº¦å·®ä¸å¤šçš„çš„é«˜é€Ÿç¼“å­˜</strong>æ¥ä½œä¸º<strong>å†…å­˜å’Œå¤„ç†å™¨ä¹‹é—´</strong>çš„ç¼“å†²ã€‚å°†è¿ç®—éœ€è¦ä½¿ç”¨çš„æ•°æ®å¤åˆ¶åˆ°ç¼“å­˜ä¸­ï¼Œè®©è¿ç®—èƒ½å¿«é€Ÿè¿›è¡Œï¼Œå½“è¿ç®—ç»“æŸåå†ä»ç¼“å­˜åŒæ­¥å›å†…å­˜ä¹‹ä¸­ï¼Œè¿™æ ·å¤„ç†å™¨å°±æ— é¡»ç­‰å¾…ç¼“æ…¢çš„å†…å­˜è¯»å†™äº†ã€‚</p>
<h3 id="ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜"><a href="#ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜"></a>ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜</h3><p>ä¸Šé¢åŠ ä¸Šäº†ç¼“å­˜å¯ä»¥è§£å†³å†…å­˜çš„è¯»å†™é€Ÿåº¦èµ¶ä¸ä¸Šå¤„ç†å™¨çš„è¿ç®—é€Ÿåº¦é—®é¢˜ï¼Œä½†æ˜¯åˆå‡ºç°äº†å¦å¤–ä¸€ä¸ªé—®é¢˜ã€‚<strong>ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜</strong></p>
<p>å› ä¸º åœ¨å¤šå¤„ç†å™¨ä¸­ï¼Œæ¯ä¸€ä¸ªå¤„ç†å™¨éƒ½æœ‰è‡ªå·±çš„é«˜é€Ÿç¼“å­˜ï¼Œä½†æ˜¯å†…å­˜æ˜¯åªæœ‰ä¸€ä¸ªã€‚å¯¹äºç¼“å­˜ä¸€è‡´æ€§é—®é¢˜åœ¨ç¡¬ä»¶å±‚é¢ä¸»è¦æœ‰ä¸¤ä¸ªè§£å†³æ–¹å¼</p>
<ul>
<li><p>æ€»çº¿åŠ é”</p>
<ul>
<li>æ‰€è°“çš„æ€»çº¿åŠ é”å°±æ¯ä¸€æ¬¡éƒ½ä¼šé”å®šä¸€ä¸ª<code>cpu</code>ï¼Œåªæœ‰è¿™ä¸ªé”å®šçš„<code>cpu</code>æ‰å¯ä»¥æ‰§è¡Œï¼Œå…¶ä½™çš„<code>cpu</code>æ˜¯ä¸èƒ½æ‰§è¡Œçš„ã€‚è¿™ç§æ–¹å¼ä¼šé™ä½<code>cpu</code>çš„ååé‡ã€‚</li>
</ul>
</li>
<li><p>ä½¿ç”¨ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œæ‰€è°“ä½¿ç”¨ç¼“å­˜ä¸€è‡´æ€§åè®®ä¹Ÿå°±æ˜¯åœ¨ç¼“å­˜å’Œä¸»å†…å­˜ä¹‹é—´åŠ ä¸Šä¸€ä¸ªè®¿é—®è§„åˆ™ï¼Œé€šè¿‡è¿™ç§è§„åˆ™æ¥è§£å†³ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚</p>
</li>
</ul>
<pre class="mermaid">graph LR
  A-->B
  subgraph A[å¤„ç†å™¨]
    direction TB
    A1[å¤„ç†å™¨1]~~~A2[å¤„ç†å™¨2]~~~A3[å¤„ç†å™¨3]
  end
  subgraph B[é«˜é€Ÿç¼“å­˜]
    direction TB
    B1[ç¼“å­˜1]~~~B2[ç¼“å­˜2]~~~B3[ç¼“å­˜3]
  end
  B-->C
  C[ç¼“å­˜ä¸€è‡´æ€§]-->D[ä¸»å†…å­˜]</pre>
<p>è¿™é‡Œçš„<strong>ç¼“å­˜ä¸€è‡´æ€§å…¶å®æ˜¯ä¸€ä¸ªåè®®</strong>ï¼Œæ˜¯å¤„ç†ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜çš„ä¸€ä¸ªåè®®(ä¹Ÿå¯ä»¥ä»»è®¤ä¸ºæ˜¯å¤„ç†ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜çš„ä¸€ä¸ªç†è®ºåŸºç¡€)ã€‚</p>
<h2 id="javaå†…å­˜æ¨¡å‹-java-memory-mode"><a href="#javaå†…å­˜æ¨¡å‹-java-memory-mode" class="headerlink" title="javaå†…å­˜æ¨¡å‹(java memory mode)"></a>javaå†…å­˜æ¨¡å‹(java memory mode)</h2><h3 id="ä»€ä¹ˆæ˜¯javaå†…å­˜æ¨¡å‹-JMMè§„èŒƒ"><a href="#ä»€ä¹ˆæ˜¯javaå†…å­˜æ¨¡å‹-JMMè§„èŒƒ" class="headerlink" title="ä»€ä¹ˆæ˜¯javaå†…å­˜æ¨¡å‹(JMMè§„èŒƒ)"></a>ä»€ä¹ˆæ˜¯<code>java</code>å†…å­˜æ¨¡å‹(JMMè§„èŒƒ)</h3><p><strong><code>java</code>å†…å­˜æ¨¡å‹å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªç†è®ºä¸Šçš„ä¸œè¥¿ï¼Œæ˜¯ä¸€ä¸ªè§„èŒƒï¼Œè¿™ä¸ªè§„èŒƒçš„ä¸»è¦ç›®çš„æ˜¯å®šä¹‰ç¨‹åºä¸­å„ç§å˜é‡çš„è®¿é—®è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯å…³æ³¨çš„æ˜¯è™šæ‹Ÿæœºä¸­æŠŠå˜é‡å€¼å­˜å‚¨åˆ°å†…å­˜å’Œä»å†…å­˜ä¸­å–å‡ºå˜é‡å€¼è¿™æ ·çš„åº•å±‚ç»†èŠ‚ã€‚</strong>æ­¤å¤„çš„å˜é‡å’Œ<code>java</code>ç¼–ç¨‹ä¸­çš„å˜é‡æ˜¯ä¸åŒçš„ï¼Œè¿™é‡Œçš„å˜é‡åŒ…å«äº†å®ä¾‹å­—æ®µï¼Œé™æ€å­—æ®µå’Œæ„æˆæ•°ç»„å¯¹è±¡çš„å…ƒç´ ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬å±€éƒ¨å˜é‡å’Œæ–¹æ³•å‚æ•°ã€‚ï¼ˆä¸Šé¢è¿™æ®µè¯æ˜¯ã€Šæ·±å…¥ç†è§£javaè™šæ‹Ÿæœºã€‹è¿™æœ¬ä¹¦ä¸­çš„ï¼‰</p>
<p><code>jvm</code>å°†å†…å­˜ç»„ç»‡ç»“æ„ä¸»è¦åˆ’åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†</p>
<ul>
<li>ä¸»å†…å­˜</li>
<li>å·¥ä½œå†…å­˜</li>
</ul>
<pre class="mermaid">graph LR
  A-->B
  subgraph A[javaçº¿ç¨‹]
    direction TB
    A1[çº¿ç¨‹1]~~~A2[çº¿ç¨‹2]~~~A3[çº¿ç¨‹3]
  end
  subgraph B[å·¥ä½œå†…å­˜]
    direction TB
    B1[å·¥ä½œå†…å­˜1]~~~B2[å·¥ä½œå†…å­˜2]~~~B3[å·¥ä½œå†…å­˜3]
  end
  B-->C
  C[saveå’Œloadæ“ä½œ]-->D[ä¸»å†…å­˜]</pre>

<h4 id="ä¸»å†…å­˜"><a href="#ä¸»å†…å­˜" class="headerlink" title="ä¸»å†…å­˜"></a>ä¸»å†…å­˜</h4><ul>
<li>ä¸»è¦åŒ…å«æœ¬åœ°æ–¹æ³•åŒºå’Œå †</li>
<li>æ‰€æœ‰å˜é‡éƒ½è¦å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼Œè¿™äº›å˜é‡å¯¹äºæ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯å…±äº«çš„</li>
</ul>
<h4 id="å·¥ä½œå†…å­˜"><a href="#å·¥ä½œå†…å­˜" class="headerlink" title="å·¥ä½œå†…å­˜"></a>å·¥ä½œå†…å­˜</h4><ul>
<li>æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹å·¥ä½œçš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯å·¥ä½œå†…å­˜</li>
<li>å·¥ä½œå†…å­˜ä¸­ä¿å­˜çš„æ˜¯ä¸»å†…å­˜ä¸­æŸäº›å˜é‡çš„æ‹·è´ï¼Œçº¿ç¨‹å †å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œä¸èƒ½ç›´æ¥æ“ä½œä¸»å†…å­˜</li>
<li><strong>å¦‚æœæ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œé‚£ä¹ˆç›´æ¥åˆ†é…åˆ°å·¥ä½œå†…å­˜ï¼Œå¦‚æœæ˜¯å¼•ç”¨ç±»å‹ï¼Œå¼•ç”¨çš„åœ°å€å­˜åœ¨åœ¨å·¥ä½œç©ºé—´ä¸­ï¼Œä½†æ˜¯å…·ä½“çš„å¯¹è±¡æ˜¯å­˜åœ¨åœ¨å †ä¸­(ä¹Ÿå°±æ˜¯ä¸»å†…å­˜ä¸­)ï¼Œæ˜¯å¯ä»¥å…±äº«çš„</strong></li>
</ul>
<pre class="mermaid">graph LR
  subgraph B[javaçº¿ç¨‹]
    direction BT
    B1[çº¿ç¨‹2]-->B2[å·¥ä½œå†…å­˜2]
    B2-->B1
  end
  subgraph A[javaçº¿ç¨‹]
    direction BT
    A1[çº¿ç¨‹1]-->A2[å·¥ä½œå†…å­˜1]
    A2-->A1
  end
  C[ä¸»å†…å­˜]
  A & B --> C
  C --> A & B</pre>

<p>çœ‹ä¸Šå›¾ï¼Œä¹‹æ‰€ä»¥å­˜åœ¨<code>java</code>å†…å­˜æ¨¡å‹ä¸€è¯´æ˜¯å› ä¸º<code>java</code>è™šæ‹Ÿæœºçš„å·¥ä½œæœºåˆ¶ã€‚å½“æœ‰å¤šä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ“ä½œçš„æ•°æ®æœ‰ä¸¤ç§ç±»å‹</p>
<ul>
<li>çº¿ç¨‹ç§æœ‰çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªæ•°æ®å°±ç®—æ”¹å˜äº†ä¹Ÿä¸ä¼šå½±å“å…¶ä½™çº¿ç¨‹ï¼Œæ¯”å¦‚è¯´å±€éƒ¨å˜é‡å°±æ˜¯çº¿ç¨‹ç§æœ‰çš„æ•°æ®</li>
<li>çº¿ç¨‹å…±äº«çš„æ•°æ®ï¼Œè¿™æ ·çš„æ•°æ®å¤šä¸ªçº¿ç¨‹éƒ½å¯ä»¥è®¿é—®ï¼Œå°±ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨çš„é—®é¢˜</li>
</ul>
<p>å› ä¸ºçº¿ç¨‹æ“ä½œçš„æ•°æ®æœ‰ä¸åŒç±»å‹ï¼Œæ‰€ä»¥åœ¨<code>java</code>ä¸­ä¸€ä¸ªçº¿ç¨‹å»æ“ä½œæ•°æ®çš„æ—¶å€™ä¸æ˜¯åœ¨ä¸»å†…å­˜ä¸­ç›´æ¥æ“ä½œï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªå±äºçº¿ç¨‹è‡ªå·±çš„å†…å­˜(å·¥ä½œå†…å­˜)ï¼Œå½“æ“ä½œçº¿ç¨‹ç§æœ‰çš„æ•°æ®æ¯”è¾ƒå¥½ç†è§£ï¼Œç›´æ¥åœ¨å·¥ä½œå†…å­˜ä¸­å®Œæˆå°±å¯ä»¥å’¯ï¼Œå¦‚æœæ˜¯æ“ä½œå…±äº«çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±åœ¨ä¸»å†…å­˜ä¸­æ‹¿ä¸€ä»½æ•°æ®åˆ°è‡ªå·±å·¥ä½œå†…å­˜ä¸­æ“ä½œï¼Œæ“ä½œå®Œäº†å†å°†æ•°æ®ç»™åˆ°ä¸»å†…å­˜ä¸­ã€‚</p>
<h3 id="å†…å­˜ç»“æ„å’Œå†…å­˜æ¨¡å‹çš„å…³ç³»"><a href="#å†…å­˜ç»“æ„å’Œå†…å­˜æ¨¡å‹çš„å…³ç³»" class="headerlink" title="å†…å­˜ç»“æ„å’Œå†…å­˜æ¨¡å‹çš„å…³ç³»"></a>å†…å­˜ç»“æ„å’Œå†…å­˜æ¨¡å‹çš„å…³ç³»</h3><p>ä¸Šé¢è¯´äº†ä»€ä¹ˆæ˜¯<code>java</code>çš„å†…å­˜æ¨¡å‹ï¼ŒçŸ¥é“<code>java</code>å†…å­˜æ¨¡å‹æ˜¯ä¸€ä¸ªè§„èŒƒï¼Œå®šä¹‰çš„æ˜¯ç¨‹åºä¸­å˜é‡çš„è®¿é—®è§„åˆ™ï¼Œé‚£ä¹ˆè¿™ä¸ªå†…å­˜æ¨¡å‹å’Œæˆ‘ä»¬å¹³æ—¶æ‰€æœ‰çš„å†…å­˜ç»“æ„æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿå…ˆçœ‹ä¸€ä¸‹<code>java</code>å†…å­˜ç»“æ„</p>
<h4 id="javaå†…å­˜ç»“æ„"><a href="#javaå†…å­˜ç»“æ„" class="headerlink" title="javaå†…å­˜ç»“æ„"></a>javaå†…å­˜ç»“æ„</h4><p><code>java</code>ä¸­å†…å­˜ç»“æ„ä¸»è¦æ˜¯æœ‰äº”ä¸ªéƒ¨åˆ†</p>
<ul>
<li>ç¨‹åºè®¡æ•°å™¨</li>
<li>å †</li>
<li>è™šæ‹Ÿæœºæ ˆ<ul>
<li>å­˜æ”¾æ–¹æ³•è¿è¡Œæ—¶æ‰€éœ€çš„æ•°æ®ï¼Œæˆä¸ºæ ˆå¸§</li>
</ul>
</li>
<li>æœ¬åœ°æ–¹æ³•æ ˆ</li>
<li>æ–¹æ³•åŒº<ul>
<li>å­˜å‚¨è¿è¡Œæ—¶å¸¸é‡æ± ã€å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ï¼Œå³æ—¶ç¼–è¯‘åçš„ä»£ç ç­‰</li>
</ul>
</li>
</ul>
<p>ä¸Šé¢<code>java</code>çš„äº”ä¸ªéƒ¨åˆ†å…¶å®å°±æ˜¯æ ¹æ®<code>JMM</code>è§„èŒƒ(<code>java</code>å†…å­˜æ¨¡å‹)æ¥åˆ’åˆ†çš„ä¸€ä¸ªå†…å­˜ç»“æ„ã€‚</p>
<h2 id="å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹æ€§"><a href="#å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹æ€§" class="headerlink" title="å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹æ€§"></a>å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹æ€§</h2><h3 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h3><p>æ‰§è¡Œçš„æ“ä½œä¸å¯åˆ†å‰²ï¼Œå¯ä»¥ç†è§£ä¸ºå°±æ˜¯ä¸€æ­¥æ“ä½œï¼Œå› ä¸ºåªæœ‰ä¸€æ­¥æ‰€ä»¥è‚¯å®šæ˜¯ä¸èƒ½åˆ†å‰²çš„</p>
<h3 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h3><p>çº¿ç¨‹éƒ½æ˜¯æœ‰è‡ªå·±çš„å·¥ä½œç©ºé—´çš„ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½åªèƒ½æ“ä½œè‡ªå·±å·¥ä½œç©ºé—´çš„æ•°æ®ï¼Œåˆ«çš„çº¿ç¨‹æ˜¯çœ‹ä¸åˆ°è‡ªå·±çº¿ç¨‹çš„å·¥ä½œç©ºé—´çš„æ•°æ®çš„</p>
<h3 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="headerlink" title="æœ‰åºæ€§"></a>æœ‰åºæ€§</h3><p>ç¨‹åºä¸­ä»£ç çš„é¡ºåºä¸ä¸€å®šå°±æ˜¯åœ¨<code>cpu</code>ä¸­æ‰§è¡Œçš„é¡ºåºï¼Œå› ä¸ºå­˜åœ¨ä¸¤ç§é‡æ’</p>
<ul>
<li>ç¼–è¯‘é‡æ’åº(ç¼–è¯‘æœŸ)</li>
<li>æŒ‡ä»¤é‡æ’åº(è¿è¡ŒæœŸ)</li>
</ul>
<h2 id="JMMè§„èŒƒæ˜¯å¦‚ä½•ä¿è¯å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹å¾çš„å‘¢"><a href="#JMMè§„èŒƒæ˜¯å¦‚ä½•ä¿è¯å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹å¾çš„å‘¢" class="headerlink" title="JMMè§„èŒƒæ˜¯å¦‚ä½•ä¿è¯å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹å¾çš„å‘¢"></a>JMMè§„èŒƒæ˜¯å¦‚ä½•ä¿è¯å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªç‰¹å¾çš„å‘¢</h2><h3 id="JMMå’ŒåŸå­æ€§"><a href="#JMMå’ŒåŸå­æ€§" class="headerlink" title="JMMå’ŒåŸå­æ€§"></a><code>JMM</code>å’ŒåŸå­æ€§</h3><h4 id="åŸå­æ€§æ¡ˆä¾‹1"><a href="#åŸå­æ€§æ¡ˆä¾‹1" class="headerlink" title="åŸå­æ€§æ¡ˆä¾‹1"></a>åŸå­æ€§æ¡ˆä¾‹1</h4><p><code>X = 10</code>è¿™æ ·ä¸€ä¸ªæ“ä½œå…·æœ‰åŸå­æ€§ä¹ˆï¼Ÿ</p>
<ul>
<li>å¦‚æœ<code>X</code>æ˜¯ç§æœ‰æ•°æ®ï¼Œæ˜¯åˆ†é…åˆ°å·¥ä½œç©ºé—´çš„ï¼Œé‚£ä¹ˆå°±æ˜¯æœ‰åŸå­æ€§çš„ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªå†™çš„æ“ä½œ</li>
<li>å¦‚æœ<code>X</code>æ˜¯å…±äº«çš„æ•°æ®ï¼Œå°±æ˜¯åœ¨ä¸»å†…å­˜ä¸­ï¼Œè¿™æ ·å°±éœ€è¦å…ˆåœ¨ä¸»å†…å­˜ä¸­è¯»å–(å¤åˆ¶)åˆ°å·¥ä½œç©ºé—´ä¸­ï¼Œä¿®æ”¹å®Œæˆåå†å°†æ•°æ®é€šè¿‡åˆ°ä¸»å†…å­˜ä¸­ï¼Œè¿™æ ·å°±æ˜¯ä¸¤æ­¥ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰åŸå­æ€§</li>
</ul>
<h4 id="åŸå­æ€§æ¡ˆä¾‹2"><a href="#åŸå­æ€§æ¡ˆä¾‹2" class="headerlink" title="åŸå­æ€§æ¡ˆä¾‹2"></a>åŸå­æ€§æ¡ˆä¾‹2</h4><p><code>i++</code>è¿™ä¸ªæ“ä½œå…·æœ‰åŸå­æ€§ä¹ˆï¼Ÿ</p>
<p><code>i++</code>è¿™ä¸ªæ“ä½œå…¶å®æ˜¯éœ€è¦åˆ†ä¸ºä¸‹é¢è¿™å‡ ä¸ªæ­¥éª¤çš„</p>
<ul>
<li>è¯»å–<code>i</code>çš„å€¼</li>
<li>å°†<code>i</code>çš„å€¼åŠ ä¸€</li>
<li>å°†ä¿®æ”¹åçš„å€¼èµ‹å€¼ç»™<code>i</code></li>
</ul>
<p>å¯ä»¥çœ‹åˆ°æ¯ä¸€æ­¥éƒ½æ˜¯åŸå­æ“ä½œï¼Œä½†æ˜¯è¿™ä¸‰ä¸ªåŸå­æ“ä½œåˆåœ¨ä¸€èµ·ä¹‹åå»ä¸æ˜¯åŸå­æ“ä½œäº†</p>
<h4 id="JMMå¦‚ä½•ä¿è¯åŸå­æ€§çš„"><a href="#JMMå¦‚ä½•ä¿è¯åŸå­æ€§çš„" class="headerlink" title="JMMå¦‚ä½•ä¿è¯åŸå­æ€§çš„"></a>JMMå¦‚ä½•ä¿è¯åŸå­æ€§çš„</h4><ul>
<li>ä½¿ç”¨<code>Synchronized</code>å…³é”®å­—</li>
<li>ä½¿ç”¨<code>JUC</code>çš„<code>lock</code>å’Œ<code>unlock</code>å…³é”®å­—</li>
</ul>
<h3 id="JMMå’Œå¯è§æ€§"><a href="#JMMå’Œå¯è§æ€§" class="headerlink" title="JMMå’Œå¯è§æ€§"></a><code>JMM</code>å’Œå¯è§æ€§</h3><p>çº¿ç¨‹æ˜¯ä¸èƒ½æ“ä½œä¸»å†…å­˜ä¸­çš„æ•°æ®çš„ï¼Œåªèƒ½æ“ä½œè‡ªå·±çš„å·¥ä½œç©ºé—´çš„æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦æ•°æ®æ—¶ä¼šå…ˆå»å·¥ä½œç©ºé—´æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°äº†å°±ä¼šä½¿ç”¨å·¥ä½œç©ºé—´ä¸­çš„æ•°æ®ï¼Œæ‰¾ä¸åˆ°æ‰ä¼šä»ä¸»å†…å­˜ä¸­æ‰¾ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œç©ºé—´æ‰¾åˆ°äº†ï¼Œä¸è¿‡è¿™ä¸ªæ•°æ®åœ¨åˆ«çš„çº¿ç¨‹ä¸­å·²ç»ä¿®æ”¹äº†ï¼Œå¹¶ä¸”åˆ·æ–°åˆ°ä¸»å†…ä¸­äº†ï¼Œç”±äºå½“å‰çº¿ç¨‹çš„å·¥ä½œç©ºé—´ä¸­æœ‰è¿™ä¸ªæ•°æ®ï¼Œæ²¡æœ‰åœ¨ä¸»å†…å­˜ä¸­æ‹¿ï¼Œè¿™æ ·å½“å‰çº¿ç¨‹æ‹¿åˆ°çš„å°±ä¸æ˜¯æœ€æ–°çš„æ•°æ®ã€‚<code>JMM</code>æ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿ</p>
<h4 id="JMMå¦‚ä½•ä¿è¯å¯è§æ€§çš„"><a href="#JMMå¦‚ä½•ä¿è¯å¯è§æ€§çš„" class="headerlink" title="JMMå¦‚ä½•ä¿è¯å¯è§æ€§çš„"></a><code>JMM</code>å¦‚ä½•ä¿è¯å¯è§æ€§çš„</h4><ul>
<li><code>Volatile</code>å…³é”®å­—ï¼Œä½¿ç”¨è¿™ä¸ªå…³é”®å­—åï¼Œå½“çº¿ç¨‹éœ€è¦ä½¿ç”¨è¿™ä¸ªå…³é”®å­—ä¿®é¥°çš„æ•°æ®æ—¶ï¼Œæ¯ä¸€æ¬¡éƒ½ä¼šä»ä¸»å†…å­˜ä¸­å»æ‰¾æ•°æ®ï¼Œè€Œä¸æ˜¯ä»å·¥ä½œç©ºé—´ä¸­æ‰¾ã€‚</li>
<li><code>JUC</code>  å¯ä»¥ä½¿ç”¨<code>JUC</code>çš„<code>lock</code>å’Œ<code>unlock</code></li>
</ul>
<h3 id="JMMå’Œæœ‰åºæ€§-é‡æ’åº"><a href="#JMMå’Œæœ‰åºæ€§-é‡æ’åº" class="headerlink" title="JMMå’Œæœ‰åºæ€§(é‡æ’åº)"></a><code>JMM</code>å’Œæœ‰åºæ€§(é‡æ’åº)</h3><p>å¯¹äºæœ‰åºæ€§é—®é¢˜å¯ä»¥ä½¿ç”¨ä¸‹é¢ä¸¤ç§æ–¹å¼æ¥è§£å†³</p>
<ul>
<li>ä½¿ç”¨<code>Volatile</code>å…³é”®å­—</li>
<li>ä½¿ç”¨<code>Synchronized</code>æ¥åŠ é”</li>
</ul>
]]></content>
      <categories>
        <category>java</category>
        <category>jvm</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>jdkè‡ªå¸¦å·¥å…·çš„ä½¿ç”¨</title>
    <url>/2024/19b110e0830d/index.html</url>
    <content><![CDATA[<h2 id="jdk17-ä½¿ç”¨-hsdb"><a href="#jdk17-ä½¿ç”¨-hsdb" class="headerlink" title="jdk17 ä½¿ç”¨ hsdb"></a>jdk17 ä½¿ç”¨ hsdb</h2><ol>
<li>è¿›å…¥ <code>jdk17</code> å®‰è£…ç›®å½•ä¸‹çš„ <code>bin</code> ç›®å½•ï¼Œæ¯”å¦‚ <code>cd E:\java\jdk17\bin</code></li>
<li>æ‰§è¡Œ <code>jhsdb hsdb</code>ï¼Œå°±ä¼šå‡ºç°ç•Œé¢</li>
<li>é€‰æ‹© <code>File -&gt; Attacch to Host Spot process</code> è¾“å…¥ <code>pid</code> å³å¯</li>
</ol>
<h2 id="visualvm"><a href="#visualvm" class="headerlink" title="visualvm"></a>visualvm</h2><ol>
<li><code>JDK14</code> èµ·ï¼Œå·²ä¸å†é›†æˆ<code>visualvm</code>ï¼Œå¯ä»¥åˆ° <a href="https://visualvm.github.io/">visualvmä¸‹è½½åœ°å€</a> ä¸­ä¸‹è½½</li>
<li>ä¸‹è½½åè§£å‹åˆ°ä»»æ„ä¸€ä¸ªç›®å½•ï¼Œæ¯”å¦‚æˆ‘è¿™é‡Œè§£å‹åˆ° <code>E:\config\visualvm_217</code></li>
<li>ç¼–è¾‘ <code>E:\config\visualvm_217\etc\visualvm.conf</code>, è®¾ç½® <code>jdk</code> ç›®å½•(ä¹Ÿå¯ä»¥ä¿®æ”¹æ•°æ®å­˜æ”¾ç›®å½•)<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs conf">visualvm_jdkhome=&quot;E:\\installpackage\\java\\jdk17&quot;<br><br># ä¸‹é¢ä¸¤æ¡æ˜¯ä¿®æ”¹æ•°æ®å’Œç¼“å­˜å­˜æ”¾ç›®å½•, userdir ç›®å½•ä¸èƒ½è®¾ç½®åˆ° visualvm ç›®å½•ä¸‹ï¼Œå¦åˆ™ä¸èƒ½å¯åŠ¨<br># visualvm_default_userdir=&quot;$&#123;DEFAULT_USERDIR_ROOT&#125;/2.1.7&quot;<br>visualvm_default_userdir=&quot;E:\\data\\visualvmdata&quot;<br># visualvm_default_cachedir=&quot;$&#123;DEFAULT_CACHEDIR_ROOT&#125;/2.1.7&quot;<br>visualvm_default_cachedir=&quot;E:\\config\\visualvm_217\\cache&quot;<br></code></pre></td></tr></table></figure></li>
<li>å¯åŠ¨ <code>visualvm</code>ï¼Œè¿›å…¥ <code>E:\config\visualvm_217\bin</code>, ç›´æ¥åŒå‡» <code>visualvm.exe</code> å³å¯ï¼Œå¦‚æœæ²¡æœ‰å›¾å½¢ç•Œé¢å‡ºç°ï¼Œè¯´æ˜å¯åŠ¨å¤±è´¥ï¼Œå¯ä»¥åœ¨è¯¥ç›®å½•ä¸­æ‰“å¼€ <code>cmd</code>, é€šè¿‡å‘½ä»¤ <code>visualvm.exe</code> å¯åŠ¨æ¥æŸ¥çœ‹é”™è¯¯ä¿¡æ¯</li>
<li>å¯åŠ¨æˆåŠŸåå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¼šåˆ—å‡ºæ‰€æœ‰çš„ <code>java</code> è¿›ç¨‹<br><img src="https://s2.loli.net/2024/01/09/pPvd3NwFRH9cOWa.png" alt="visualvmå¯åŠ¨æˆåŠŸç¤ºä¾‹"></li>
</ol>
<h3 id="åœ¨ideaä¸­ä½¿ç”¨-visualvm"><a href="#åœ¨ideaä¸­ä½¿ç”¨-visualvm" class="headerlink" title="åœ¨ideaä¸­ä½¿ç”¨ visualvm"></a>åœ¨ideaä¸­ä½¿ç”¨ visualvm</h3><ol>
<li>åœ¨ <code>idea</code> ä¸­å®‰è£…æ’ä»¶ <code>VisualVMLauncher</code></li>
<li>ç„¶ååœ¨ <code>idea</code> ä¸­é…ç½® <code>visualvm</code><br><img src="https://s2.loli.net/2024/01/09/t8bJzhsKoP9dFue.png" alt="visualvmé…ç½®"></li>
<li>å¯åŠ¨æ—¶é€‰æ‹© <code>visualvm</code>  å¯åŠ¨<br><img src="https://s2.loli.net/2024/01/09/udHrKYtv2FmaZCN.png" alt="é€šè¿‡visualvmå¯åŠ¨æœåŠ¡"></li>
</ol>
]]></content>
      <categories>
        <category>java</category>
        <category>jvm</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>jvmåƒåœ¾å›æ”¶</title>
    <url>/2023/63d242ce6cb3/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p>ä»¥ä¸‹å†…å®¹å‚è€ƒã€Šå‰‘æŒ‡JVM:è™šæ‹Ÿæœºå®è·µä¸æ€§èƒ½è°ƒä¼˜ã€‹</p>
<blockquote>
<p>Javaä½¿ç”¨çš„æ˜¯è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œæœ‰å†…å­˜åˆ†é…å™¨å’Œåƒåœ¾æ”¶é›†å™¨æ¥ä»£ä¸ºåˆ†é…å’Œå›æ”¶å†…å­˜ã€‚è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ä½¿å¼€å‘äººå‘˜æ— é¡»å‚ä¸å†…å­˜çš„åˆ†é…å’Œå›æ”¶,è‡ªåŠ¨å†…å­˜ç®¡ç†å°±åƒä¸€ä¸ªé»‘åŒ£å­,æ‰€ä»¥äº†è§£JVMçš„è‡ªåŠ¨å†…å­˜åˆ†é…å’Œåƒåœ¾æ”¶é›†æœºåˆ¶å°±æ˜¾å¾—éå¸¸é‡è¦</p>
</blockquote>
<h2 id="å“ªäº›å¯¹è±¡æ˜¯åƒåœ¾"><a href="#å“ªäº›å¯¹è±¡æ˜¯åƒåœ¾" class="headerlink" title="å“ªäº›å¯¹è±¡æ˜¯åƒåœ¾"></a>å“ªäº›å¯¹è±¡æ˜¯åƒåœ¾</h2><p>æ—¢ç„¶æ˜¯è®²è§£åƒåœ¾å›æ”¶ï¼Œè‡ªç„¶éœ€è¦å…ˆå¼„æ¸…æ¥šä»€ä¹ˆæ ·çš„å¯¹è±¡æ‰æ˜¯åƒåœ¾</p>
<h3 id="å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¼•ç”¨è®¡æ•°æ³•"><a href="#å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¼•ç”¨è®¡æ•°æ³•" class="headerlink" title="å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¼•ç”¨è®¡æ•°æ³•"></a>å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¼•ç”¨è®¡æ•°æ³•</h3><ol>
<li>å¼•ç”¨è®¡æ•°ç®—æ³•æ¯”è¾ƒç®€å•ï¼Œå¯¹æ¯ä¸ªå¯¹è±¡ä¿å­˜ä¸€ä¸ªæ•´å‹çš„å¼•ç”¨è®¡æ•°å™¨å±æ€§ï¼Œç”¨äºè®°å½•å¯¹è±¡è¢«å¼•ç”¨çš„æ¬¡æ•°ï¼ˆå®ç°æ–¹å¼ï¼‰</li>
<li>å¼•ç”¨è®¡æ•°ç®—æ³•çš„ä¼˜ç‚¹æ˜¯å®ç°ç®€å•ï¼Œåƒåœ¾å¯¹è±¡ä¾¿äºè¾¨è¯†ï¼Œåˆ¤å®šæ•ˆç‡é«˜ï¼Œå›æ”¶æ²¡æœ‰å»¶è¿Ÿæ€§ï¼ˆä¼˜ç‚¹ï¼‰</li>
<li>æ¯ä¸ªå¯¹è±¡éœ€è¦å•ç‹¬çš„å­—æ®µå­˜å‚¨è®¡æ•°å™¨ï¼Œè¿™æ ·çš„åšæ³•å¢åŠ äº†å­˜å‚¨ç©ºé—´çš„å¼€é”€ï¼ˆç¼ºç‚¹ï¼‰</li>
<li>å¼•ç”¨è®¡æ•°å™¨æœ‰ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œå³æ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨çš„æƒ…å†µï¼ˆä¸¥é‡çš„ç¼ºç‚¹ï¼‰</li>
</ol>
<h4 id="å¾ªç¯å¼•ç”¨ç¤ºä¾‹"><a href="#å¾ªç¯å¼•ç”¨ç¤ºä¾‹" class="headerlink" title="å¾ªç¯å¼•ç”¨ç¤ºä¾‹"></a>å¾ªç¯å¼•ç”¨ç¤ºä¾‹</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjOne</span> &#123;<br>    <span class="hljs-keyword">private</span> ObjTwo objTwo;<br>    <span class="hljs-comment">// çœç•¥setï¼Œget</span><br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjTwo</span> &#123;<br>    <span class="hljs-keyword">private</span> ObjOne objOne;<br>    <span class="hljs-comment">// çœç•¥setï¼Œget</span><br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> test &#123;<br>    <span class="hljs-type">ObjOne</span> <span class="hljs-variable">objOne</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjOne</span>();<br>    <span class="hljs-type">ObjTwo</span> <span class="hljs-variable">objTwo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjTwo</span>();<br>    objOne.setObjTwo(objTwo);<br>    objTwo.setObjOne(objOne);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç æ‰§è¡Œå®Œæˆå †æ ˆå¦‚æœæ‰€ç¤º</p>
<pre class="mermaid">flowchart LR
  subgraph A[æ ˆ]
    A1["objOne"]
    A2["objTwo"]
  end
  subgraph B[å †]
    subgraph B1["ObjOne"]
      style B1 fill:#70b224
      B11[objTwo]
      style B11 fill:#f9f
    end
    subgraph B2["ObjTwo"]
      style B2 fill:#70b224
      B21[objOne]
      style B21 fill:#f9f
    end
    
    B11-->B21
    B21-->B11
  end
  A1-->B1
  A2-->B2</pre>
<p>å½“æ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼Œå †æ ˆå¼•ç”¨æƒ…å†µä¼šæ”¹å˜</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> test &#123;<br>    <span class="hljs-type">ObjOne</span> <span class="hljs-variable">objOne</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjOne</span>();<br>    <span class="hljs-type">ObjTwo</span> <span class="hljs-variable">objTwo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjTwo</span>();<br>    objOne.setObjTwo(objTwo);<br>    objTwo.setObjOne(objOne);<br>    objOne = <span class="hljs-literal">null</span>;<br>    objTwo = <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<pre class="mermaid">flowchart LR
  subgraph A[æ ˆ]
    A1["objOne"]
    A2["objTwo"]
  end
  subgraph B[å †]
    subgraph B1["ObjOne"]
      style B1 fill:#70b224
      B11[objTwo]
      style B11 fill:#f9f
    end
    subgraph B2["ObjTwo"]
      style B2 fill:#70b224
      B21[objOne]
      style B21 fill:#f9f
    end
    
    B11-->B21
    B21-->B11
  end
  A1-. "X" .->B1
  A2-. "X" .->B2</pre>
<p>å¯ä»¥çœ‹åˆ°æ ˆåˆ°å †ä¸­çš„å¼•ç”¨è™½ç„¶æ–­å¼€äº†ï¼Œä½†æ˜¯å„è‡ªå¯¹è±¡å±æ€§ä¸Šé¢çš„è¿æ¥ä¾ç„¶æ²¡æœ‰æ–­å¼€</p>
<h3 id="å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¯è¾¾æ€§åˆ†æç®—æ³•"><a href="#å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¯è¾¾æ€§åˆ†æç®—æ³•" class="headerlink" title="å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¯è¾¾æ€§åˆ†æç®—æ³•"></a>å¯¹è±¡å­˜æ´»åˆ¤æ–­â€“å¯è¾¾æ€§åˆ†æç®—æ³•</h3><ol>
<li>å¯è¾¾æ€§åˆ†æç®—æ³•æ˜¯ä»¥ <code>GC Root</code> ä¸ºèµ·å§‹ç‚¹ï¼Œæš—è—ä»ä¸Šåˆ°ä¸‹çš„æ–¹å¼æœç´¢è¢«è·Ÿå¯¹è±¡é›†åˆæ‰€è¿æ¥çš„å¯¹è±¡æ˜¯å¦å¯è¾¾</li>
</ol>
<h3 id="GC-Root-åŒ…å«ä»¥ä¸‹å†…å®¹"><a href="#GC-Root-åŒ…å«ä»¥ä¸‹å†…å®¹" class="headerlink" title="GC Root åŒ…å«ä»¥ä¸‹å†…å®¹"></a>GC Root åŒ…å«ä»¥ä¸‹å†…å®¹</h3><ol>
<li>è™šæ‹Ÿæœºæ ˆä¸­å¯¹è±¡çš„å¼•ç”¨ï¼Œæ¯”å¦‚ï¼Œå„ä¸ªçº¿ç¨‹è¢«è°ƒç”¨çš„æ–¹æ³•ä¸­ä½¿ç”¨åˆ°çš„å¼•ç”¨æ•°æ®ç±»å‹çš„å‚æ•°ã€å±€éƒ¨å˜é‡ç­‰</li>
<li>æœ¬åœ°æ–¹æ³•æ ˆå†…JNIï¼ˆæœ¬åœ°æ–¹æ³•ï¼‰å¯¹è±¡çš„å¼•ç”¨</li>
<li>æ–¹æ³•åŒºä¸­å¼•ç”¨æ•°æ®ç±»å‹çš„é™æ€å˜é‡</li>
<li>æ–¹æ³•åŒºä¸­å¸¸é‡å¯¹è±¡çš„å¼•ç”¨ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²å¸¸é‡æ± <code>(String Table)</code>é‡Œçš„å¼•ç”¨</li>
<li>æ‰€æœ‰è¢«åŒæ­¥é”<code>synchronized</code>æŒæœ‰çš„å¯¹è±¡å¼•ç”¨</li>
<li><code>JVM</code>å†…éƒ¨çš„å¼•ç”¨ã€‚åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„Classå¯¹è±¡å¼•ç”¨ï¼Œä¸€äº›å¸¸é©»çš„å¼‚å¸¸å¯¹è±¡å¼•ç”¨ï¼ˆå¦‚<code>NullPointerException</code>ã€<code>OutOfMemoryError</code>ï¼‰ï¼Œç³»ç»Ÿç±»åŠ è½½å™¨å¯¹è±¡å¼•ç”¨ç­‰</li>
</ol>
<h2 id="åƒåœ¾å›æ”¶çš„åŒºåŸŸ"><a href="#åƒåœ¾å›æ”¶çš„åŒºåŸŸ" class="headerlink" title="åƒåœ¾å›æ”¶çš„åŒºåŸŸ"></a>åƒåœ¾å›æ”¶çš„åŒºåŸŸ</h2><p>æ ¹æ® <ol><li><a href="/2023/70e7b048ccf4/index.html" title="jvmè¿è¡Œæ—¶å†…å­˜åŒºåŸŸ">jvmè¿è¡Œæ—¶å†…å­˜åŒºåŸŸ</a></li></ol> å¯çŸ¥ï¼Œ<code>jvm</code>è¿è¡Œæ—¶æ•°æ®åŒºä¸»è¦åŒ…å«ä¸¤å¤§ç±»</p>
<ol>
<li>çº¿ç¨‹ç§æœ‰çš„åŒºåŸŸï¼š ç¨‹åºè®¡æ•°å™¨ï¼Œæœ¬åœ°æ–¹æ³•æ ˆï¼Œè™šæ‹Ÿæœºæ ˆ</li>
<li>çº¿ç¨‹å…±äº«çš„åŒºåŸŸï¼š æ–¹æ³•åŒºï¼Œå †<br>å¯¹äºçº¿ç¨‹ç§æœ‰çš„åŒºåŸŸæ˜¯ä¸éœ€è¦åƒåœ¾å›æ”¶çš„ï¼Œå› ä¸ºå½“çº¿ç¨‹æ‰§è¡Œå®Œæˆä¹‹åï¼Œçº¿ç¨‹ä¸­ä½¿ç”¨çš„å†…å­˜ä¼šè‡ªåŠ¨å›æ”¶æ‰ï¼Œ<code>jvm</code>åƒåœ¾å›æ”¶åªéœ€è¦å…³æ³¨ <strong>æ–¹æ³•åŒº</strong>å’Œ <strong>å †</strong>å³å¯ï¼Œé‡ç‚¹æ˜¯ <strong>å †</strong></li>
</ol>
<h2 id="åƒåœ¾æ”¶é›†ç®—æ³•"><a href="#åƒåœ¾æ”¶é›†ç®—æ³•" class="headerlink" title="åƒåœ¾æ”¶é›†ç®—æ³•"></a>åƒåœ¾æ”¶é›†ç®—æ³•</h2><p>åœ¨ <code>jvm</code> ä¸­ï¼Œåƒåœ¾æ”¶é›†ç®—æ³•ä¸»è¦åŒ…å«ä»¥ä¸‹ä¸‰ç§</p>
<ol>
<li>æ ‡è®°-æ¸…é™¤ç®—æ³•</li>
<li>å¤åˆ¶ç®—æ³•</li>
<li>æ ‡è®°å‹ç¼©ç®—æ³•</li>
</ol>
<p>ä¸‰ç§ç®—æ³•ä¸»è¦è§£å†³äº†å°†åƒåœ¾æ ‡è®°å‡ºæ¥ä¹‹åå¦‚ä½•æ¸…é™¤çš„é—®é¢˜ï¼Œä¸‰ç§ç®—æ³•å„æœ‰åˆ©å¼Šï¼Œå•ç‹¬é‡‡ç”¨å…¶ä¸­ä»»ä½•ä¸€ç§ç®—æ³•ï¼Œéƒ½ä¸èƒ½å–å¾—å¾ˆå¥½çš„æ•ˆæœã€‚æ‰€ä»¥åœ¨JVMä¸­ï¼Œä¼šé’ˆå¯¹å†…å­˜çš„ä¸åŒåŒºåŸŸé‡‡ç”¨ä¸åŒçš„åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œè¿™å°±æ˜¯åˆ†ä»£ç®—æ³•</p>
<h3 id="æ ‡è®°-æ¸…é™¤ç®—æ³•"><a href="#æ ‡è®°-æ¸…é™¤ç®—æ³•" class="headerlink" title="æ ‡è®°-æ¸…é™¤ç®—æ³•"></a>æ ‡è®°-æ¸…é™¤ç®—æ³•</h3><ol>
<li>æ ‡è®°ï¼šåƒåœ¾æ”¶é›†å™¨ä»å¼•ç”¨æ ¹èŠ‚ç‚¹å¼€å§‹éå†ï¼Œæ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡</li>
<li>æ¸…é™¤ï¼šåƒåœ¾æ”¶é›†å™¨å¯¹å †å†…å­˜ä»å¤´åˆ°å°¾è¿›è¡Œçº¿æ€§éå†ï¼Œå¦‚æœå‘ç°æŸä¸ªå¯¹è±¡ä¸ºä¸å¯è¾¾å¯¹è±¡ï¼Œåˆ™å°†å…¶å›æ”¶</li>
</ol>
<p>ä¼˜ç‚¹ï¼š</p>
<ol>
<li>æ ‡è®°-æ¸…é™¤ç®—æ³•çš„ä¼˜ç‚¹æ˜¯ç®€å•ã€å®¹æ˜“å®ç°ï¼Œè€Œä¸”ä¸éœ€è¦ç§»åŠ¨å¯¹è±¡</li>
</ol>
<p>ç¼ºç‚¹ï¼š</p>
<ol>
<li>åœ¨è¿›è¡Œ<code>GC</code>çš„æ—¶å€™ï¼Œéœ€è¦åœæ­¢æ•´ä¸ªåº”ç”¨ç¨‹åºï¼Œå¯¼è‡´ç”¨æˆ·ä½“éªŒå·®</li>
<li>è¿™ç§æ–¹å¼æ¸…ç†å‡ºæ¥çš„ç©ºé—²å†…å­˜æ˜¯ä¸è¿ç»­çš„ï¼Œä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡</li>
<li>è¯¥ç®—æ³•æ¸…é™¤å¯¹è±¡å¹¶ä¸æ˜¯çœŸçš„ç½®ç©ºï¼Œè€Œæ˜¯æŠŠéœ€è¦æ¸…é™¤çš„å¯¹è±¡åœ°å€ä¿å­˜åœ¨ç©ºé—²çš„åœ°å€åˆ—è¡¨é‡Œï¼Œä¸‹æ¬¡æœ‰æ–°å¯¹è±¡ç”³è¯·å†…å­˜æ—¶ï¼Œåˆ¤æ–­æŸå—å†…å­˜ç©ºé—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœå……è¶³ï¼Œæ–°çš„å¯¹è±¡å°†ä¼šè¦†ç›–åŸæ¥æ ‡è®°ä¸ºåƒåœ¾çš„å¯¹è±¡ï¼Œä»è€Œå®ç°å†…å­˜çš„é‡å¤ä½¿ç”¨ã€‚ä½†æ˜¯å› ä¸ºå¯ç”¨å†…å­˜ä¸è¿ç»­é—®é¢˜ï¼Œåœ¨å¤§å¯¹è±¡ç”³è¯·å†…å­˜æ—¶ï¼Œéœ€è¦èŠ±è´¹æ›´å¤šæ—¶é—´å»æ‰¾å¯»åˆé€‚çš„ä½ç½®ï¼Œç”šè‡³å¤±è´¥ã€‚æ‰€ä»¥æ ‡è®°-æ¸…é™¤ç®—æ³•æ•ˆç‡ä¸é«˜ï¼Œä¸”å†…å­˜åˆ©ç”¨ç‡ä½ä¸‹ï¼Œç”šè‡³æœ‰äº›å†…å­˜ç¢ç‰‡æ— æ³•é‡å¤åˆ©ç”¨</li>
</ol>
<h3 id="å¤åˆ¶ç®—æ³•"><a href="#å¤åˆ¶ç®—æ³•" class="headerlink" title="å¤åˆ¶ç®—æ³•"></a>å¤åˆ¶ç®—æ³•</h3><ol>
<li>æ ¸å¿ƒæ€æƒ³æ˜¯å°†å†…å­˜ç©ºé—´åˆ†ä¸ºä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­ä¸€å—ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶å°†æ­£åœ¨ä½¿ç”¨çš„å†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æœªè¢«ä½¿ç”¨çš„å†…å­˜å—ä¸­ï¼Œä¹‹åæ¸…é™¤æ­£åœ¨ä½¿ç”¨çš„å†…å­˜å—ä¸­çš„æ‰€æœ‰å¯¹è±¡ã€‚ä¸¤å—å†…å­˜äº¤æ›¿ä½¿ç”¨ï¼Œä»è€Œå®Œæˆåƒåœ¾å¯¹è±¡çš„å›æ”¶</li>
<li>å¤åˆ¶ç®—æ³•æ²¡æœ‰æ ‡è®°å’Œæ¸…é™¤è¿‡ç¨‹ï¼Œå®ç°ç®€å•ï¼Œè¿è¡Œé«˜æ•ˆã€‚å†…å­˜ä»ä¸€å—ç©ºé—´å¤åˆ¶åˆ°å¦ä¸€å—ç©ºé—´å¯ä»¥ä¿è¯ç©ºé—´çš„è¿ç»­æ€§ï¼Œä¸ä¼šå‡ºç°å†…å­˜ç¢ç‰‡é—®é¢˜ã€‚ä½†æ˜¯å¤åˆ¶ç®—æ³•éœ€è¦åŒå€å†…å­˜ç©ºé—´</li>
<li>å¤åˆ¶ç®—æ³•éœ€è¦ç§»åŠ¨å¯¹è±¡ï¼Œè¿™å°±æ¶‰åŠä¿®æ”¹å¯¹è±¡å¼•ç”¨åœ°å€å€¼çš„é—®é¢˜</li>
<li>å¦‚æœç³»ç»Ÿä¸­çš„åƒåœ¾å¯¹è±¡å¾ˆå°‘ï¼Œå¤åˆ¶ç®—æ³•ä¸ä¼šå¾ˆç†æƒ³ã€‚å› ä¸ºå¤åˆ¶ç®—æ³•éœ€è¦å¤åˆ¶çš„å­˜æ´»å¯¹è±¡æ•°é‡å˜å¤§ï¼Œä½¿å¾—åƒåœ¾å›æ”¶å™¨çš„è¿è¡Œæ•ˆç‡å˜ä½</li>
</ol>
<h3 id="æ ‡è®°-å‹ç¼©ç®—æ³•"><a href="#æ ‡è®°-å‹ç¼©ç®—æ³•" class="headerlink" title="æ ‡è®°-å‹ç¼©ç®—æ³•"></a>æ ‡è®°-å‹ç¼©ç®—æ³•</h3><p>æ ‡è®°-å‹ç¼©ç®—æ³•æ¸…é™¤åƒåœ¾å¯¹è±¡çš„è¿‡ç¨‹</p>
<ol>
<li>ç¬¬ä¸€é˜¶æ®µå’Œæ ‡è®°â€“æ¸…é™¤ç®—æ³•ä¸€æ ·ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹æ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨å¯¹è±¡</li>
<li>ç¬¬äºŒé˜¶æ®µå°†æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡å‹ç¼©åˆ°å†…å­˜çš„ä¸€ç«¯ï¼ŒæŒ‰é¡ºåºæ’æ”¾</li>
<li>ç¬¬ä¸‰é˜¶æ®µæ¸…ç†è¾¹ç•Œå¤–æ‰€æœ‰çš„ç©ºé—´</li>
</ol>
<p>æ ‡è®°â€“å‹ç¼©ç®—æ³•çš„æœ€ç»ˆæ•ˆæœç­‰åŒäºæ ‡è®°â€“æ¸…é™¤ç®—æ³•æ‰§è¡Œå®Œæˆåï¼Œå†è¿›è¡Œä¸€æ¬¡å†…å­˜ç¢ç‰‡æ•´ç†</p>
<h2 id="åˆ†ä»£æ”¶é›†ç®—æ³•"><a href="#åˆ†ä»£æ”¶é›†ç®—æ³•" class="headerlink" title="åˆ†ä»£æ”¶é›†ç®—æ³•"></a>åˆ†ä»£æ”¶é›†ç®—æ³•</h2><ol>
<li>åœ¨ç¨‹åºä¸­ï¼Œä¸åŒçš„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸åŒçš„ï¼Œæœ‰äº›å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå¾ˆé•¿ï¼Œæœ‰äº›å¯¹è±¡æ˜¯æœç”Ÿå¤•æ­»çš„ï¼Œå› æ­¤åœ¨ <code>HotSpot</code> çš„ <code>jvm</code> ä¸­ï¼Œå°† <code>Java</code> å †åˆ†ä¸º <strong>æ–°ç”Ÿä»£</strong> å’Œ <strong>è€å¹´ä»£</strong>ï¼Œç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£ï¼Œç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„ä¸€èˆ¬æ”¾å…¥æ–°ç”Ÿä»£</li>
</ol>
<h3 id="æ–°ç”Ÿä»£"><a href="#æ–°ç”Ÿä»£" class="headerlink" title="æ–°ç”Ÿä»£"></a>æ–°ç”Ÿä»£</h3><ol>
<li>æ–°ç”Ÿä»£ç‰¹ç‚¹æ˜¯åŒºåŸŸç›¸å¯¹è€å¹´ä»£è¾ƒå°ï¼Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸçŸ­ã€å­˜æ´»ç‡ä½ã€å›æ”¶é¢‘ç¹</li>
<li>å¤åˆ¶ç®—æ³•çš„æ•ˆç‡åªå’Œå½“å‰å­˜æ´»å¯¹è±¡æ•°é‡å¤§å°æœ‰å…³ï¼Œç»“åˆæ–°ç”Ÿä»£çš„ç‰¹ç‚¹ï¼Œæ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œé€Ÿåº¦æœ€å¿«ã€æ•ˆç‡ä¹Ÿæœ€é«˜</li>
<li><code>HotSpot</code> å°†æ–°ç”Ÿä»£ç©ºé—´åˆ†æˆä¸‰ä¸ªåŒºåŸŸ<ol>
<li>Eden(é»˜è®¤å 80%)</li>
<li>From(é»˜è®¤å 10%)</li>
<li>To(é»˜è®¤å 10%)</li>
</ol>
</li>
</ol>
<p>æ¯æ¬¡æ–°ç”Ÿä»£å‘ç”Ÿ<code>GC</code>æ—¶ï¼ŒæŠŠ<code>Eden</code>åŒºå’Œä¸Šæ¬¡å¹¸å­˜åŒºä¸­åœ¨æœ¬æ¬¡<code>GC</code>ä»ç„¶å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€ä¸ªå¹¸å­˜åŒºï¼Œå¹¸å­˜åŒºåœ¨<code>From</code>åŒºå’Œ<code>To</code>åŒºä¹‹é—´åˆ‡æ¢ï¼Œæ€»æœ‰ä¸€å—ç©ºé—´ä¸ºç©ºï¼Œä»è€Œè§£å†³å†…å­˜åˆ©ç”¨ç‡ä½çš„é—®é¢˜</p>
<h3 id="è€å¹´ä»£"><a href="#è€å¹´ä»£" class="headerlink" title="è€å¹´ä»£"></a>è€å¹´ä»£</h3><ol>
<li>è€å¹´ä»£ç‰¹ç‚¹æ˜¯åŒºåŸŸè¾ƒå¤§ï¼Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸé•¿ã€å­˜æ´»ç‡é«˜ï¼Œå›æ”¶ä¸åŠæ–°ç”Ÿä»£é¢‘ç¹ã€‚å› ä¸ºå­˜åœ¨å¤§é‡å­˜æ´»ç‡é«˜çš„å¯¹è±¡ï¼Œå¤åˆ¶ç®—æ³•æ˜æ˜¾å˜å¾—ä¸åˆé€‚ã€‚ä¸€èˆ¬æ˜¯ç”±æ ‡è®°â€“æ¸…é™¤æˆ–è€…æ ‡è®°â€“æ¸…é™¤ä¸æ ‡è®°â€“å‹ç¼©çš„æ··åˆå®ç°</li>
</ol>
<h2 id="å¢é‡æ”¶é›†ç®—æ³•"><a href="#å¢é‡æ”¶é›†ç®—æ³•" class="headerlink" title="å¢é‡æ”¶é›†ç®—æ³•"></a>å¢é‡æ”¶é›†ç®—æ³•</h2><ol>
<li>ä¸Šè¿°ç°æœ‰çš„ç®—æ³•ï¼Œåœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨è½¯ä»¶å°†å¤„äºä¸€ç§<code>STW(Stop The World)</code>çš„çŠ¶æ€ã€‚åœ¨<code>STW</code>çŠ¶æ€ä¸‹ï¼Œåº”ç”¨ç¨‹åºæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šæŒ‚èµ·ï¼Œæš‚åœä¸€åˆ‡æ­£å¸¸çš„å·¥ä½œï¼Œç­‰å¾…åƒåœ¾å›æ”¶çš„å®Œæˆã€‚å¦‚æœåƒåœ¾å›æ”¶æ—¶é—´è¿‡é•¿ï¼Œåº”ç”¨ç¨‹åºä¼šè¢«æŒ‚èµ·å¾ˆä¹…ï¼Œå°†ä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒæˆ–è€…ç³»ç»Ÿçš„ç¨³å®šæ€§</li>
<li>å¢é‡æ”¶é›†åŸºæœ¬æ€æƒ³æ˜¯å¦‚æœä¸€æ¬¡æ€§å°†æ‰€æœ‰çš„åƒåœ¾è¿›è¡Œå¤„ç†ï¼Œä¼šé€ æˆç³»ç»Ÿé•¿æ—¶é—´çš„åœé¡¿ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®©åƒåœ¾æ”¶é›†çº¿ç¨‹å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹äº¤æ›¿æ‰§è¡Œã€‚æ¯æ¬¡åƒåœ¾æ”¶é›†çº¿ç¨‹åªæ”¶é›†ä¸€å°ç‰‡åŒºåŸŸçš„å†…å­˜ç©ºé—´ï¼Œæ¥ç€åˆ‡æ¢åˆ°åº”ç”¨ç¨‹åºçº¿ç¨‹ã€‚ä¾æ¬¡åå¤ï¼Œç›´åˆ°åƒåœ¾æ”¶é›†å®Œæˆ</li>
<li>å¢é‡æ”¶é›†ç®—æ³•çš„åŸºç¡€ä»æ˜¯ä¼ ç»Ÿçš„æ ‡è®°â€“æ¸…é™¤å’Œå¤åˆ¶ç®—æ³•ã€‚å¢é‡æ”¶é›†ç®—æ³•é€šè¿‡å¯¹çº¿ç¨‹é—´å†²çªçš„å¦¥å–„å¤„ç†ï¼Œå…</li>
<li>è®¸åƒåœ¾æ”¶é›†çº¿ç¨‹ä»¥åˆ†é˜¶æ®µçš„æ–¹å¼å®Œæˆæ ‡è®°ã€æ¸…ç†æˆ–å¤åˆ¶å·¥ä½œ</li>
</ol>
<h2 id="åˆ†åŒºæ”¶é›†ç®—æ³•"><a href="#åˆ†åŒºæ”¶é›†ç®—æ³•" class="headerlink" title="åˆ†åŒºæ”¶é›†ç®—æ³•"></a>åˆ†åŒºæ”¶é›†ç®—æ³•</h2><ol>
<li>åˆ†ä»£ç®—æ³•æŒ‰ç…§å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸé•¿çŸ­å°†å †ç©ºé—´åˆ’åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åŒºç®—æ³•å°†æ•´ä¸ªå †ç©ºé—´åˆ’åˆ†æˆè¿ç»­çš„ä¸åŒå°åŒºé—´(<code>region</code>)</li>
<li>åœ¨ç›¸åŒæ¡ä»¶ä¸‹ï¼Œå †ç©ºé—´è¶Šå¤§ï¼Œä¸€æ¬¡<code>GC</code>æ‰€éœ€è¦çš„æ—¶é—´å°±è¶Šé•¿ï¼Œæœ‰å…³<code>GC</code>äº§ç”Ÿçš„åœé¡¿ä¹Ÿå°±è¶Šé•¿ã€‚ä¸ºäº†æ›´å¥½åœ°æ§åˆ¶<code>GC</code>äº§ç”Ÿçš„åœé¡¿æ—¶é—´ï¼Œå°†ä¸€å—å¤§çš„å†…å­˜åŒºåŸŸåˆ†å‰²æˆå¤šä¸ªå°å—ï¼Œæ ¹æ®ç›®æ ‡çš„åœé¡¿æ—¶é—´ï¼Œæ¯æ¬¡åˆç†åœ°å›æ”¶è‹¥å¹²ä¸ªå°åŒºé—´ï¼Œè€Œä¸æ˜¯æ•´ä¸ªå †ç©ºé—´ï¼Œä»è€Œå‡å°‘ä¸€æ¬¡<code>GC</code>æ‰€äº§ç”Ÿçš„åœé¡¿</li>
</ol>
<h2 id="åƒåœ¾å›æ”¶ç›¸å…³æ¦‚å¿µç†è§£"><a href="#åƒåœ¾å›æ”¶ç›¸å…³æ¦‚å¿µç†è§£" class="headerlink" title="åƒåœ¾å›æ”¶ç›¸å…³æ¦‚å¿µç†è§£"></a>åƒåœ¾å›æ”¶ç›¸å…³æ¦‚å¿µç†è§£</h2><h3 id="STW-Stop-the-world"><a href="#STW-Stop-the-world" class="headerlink" title="STW(Stop the world)"></a>STW(Stop the world)</h3><ol>
<li>åœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œæ•´ä¸ªåº”ç”¨ç¨‹åºéƒ½ä¼šæš‚åœï¼Œæ²¡æœ‰ä»»ä½•å“åº”ï¼Œæ‰€ä»¥è¢«å½¢è±¡åœ°ç§°ä¸º<code>â€œStop-The-Worldâ€</code>ï¼Œç®€ç§°<code>STW</code></li>
<li>å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­æšä¸¾æ ¹èŠ‚ç‚¹(<code>GC Roots</code>)é€ æˆ<code>STW</code>ï¼ŒåŸå› æ˜¯å¦‚æœå‡ºç°åˆ†æè¿‡ç¨‹ä¸­å¯¹è±¡å¼•ç”¨å…³ç³»è¿˜åœ¨ä¸æ–­å˜åŒ–ï¼Œåˆ™åˆ†æç»“æœçš„å‡†ç¡®æ€§æ— æ³•ä¿è¯ã€‚æ‰€ä»¥åˆ†æå·¥ä½œå¿…é¡»åœ¨ä¸€ä¸ªèƒ½ç¡®ä¿ä¸€è‡´æ€§çš„å¿«ç…§ä¸­è¿›è¡Œ</li>
</ol>
<h3 id="å®‰å…¨ç‚¹"><a href="#å®‰å…¨ç‚¹" class="headerlink" title="å®‰å…¨ç‚¹"></a>å®‰å…¨ç‚¹</h3><ol>
<li>åœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨ç¨‹åºä¼šå‘ç”Ÿ <code>STW</code> ç°è±¡, ä½†æ˜¯åº”ç”¨ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¹¶ä¸æ˜¯åœ¨ä»»æ„ä½ç½®éƒ½é€‚åˆåœé¡¿ä¸‹æ¥è¿›è¡Œ<code>GC</code>çš„ï¼Œåªæœ‰åœ¨ç‰¹å®šçš„ä½ç½®æ‰èƒ½åœé¡¿ä¸‹æ¥è¿›è¡Œ<code>GC</code>æ“ä½œï¼Œè¿™äº›ç‰¹å®šçš„ä½ç½®è¢«ç§°ä¸ºå®‰å…¨ç‚¹(<code>Safe Point</code>)</li>
</ol>
<h4 id="å“ªäº›ä½ç½®æ˜¯å®‰å…¨ç‚¹"><a href="#å“ªäº›ä½ç½®æ˜¯å®‰å…¨ç‚¹" class="headerlink" title="å“ªäº›ä½ç½®æ˜¯å®‰å…¨ç‚¹"></a>å“ªäº›ä½ç½®æ˜¯å®‰å…¨ç‚¹</h4><ol>
<li>å®‰å…¨ç‚¹å¤ªå°‘å¯èƒ½å¯¼è‡´<code>GC</code>ç­‰å¾…çš„æ—¶é—´å¤ªé•¿ï¼Œå¦‚æœå®‰å…¨ç‚¹å¤ªå¯†å¯èƒ½å¯¼è‡´è¿è¡Œæ—¶çš„æ€§èƒ½é—®é¢˜</li>
<li>é€šå¸¸é€‰æ‹©ä¸€äº›è¿è¡Œæ—¶é—´è¾ƒé•¿çš„æŒ‡ä»¤ä½ç½®ä½œä¸ºå®‰å…¨ç‚¹ï¼Œä¾‹å¦‚æ–¹æ³•è°ƒç”¨ã€å¾ªç¯è·³è½¬ç­‰</li>
</ol>
<h4 id="GC-å‘ç”Ÿæ—¶å¦‚ä½•ä¿è¯åº”ç”¨çº¿ç¨‹éƒ½åœ¨å®‰å…¨ç‚¹ä¸Š"><a href="#GC-å‘ç”Ÿæ—¶å¦‚ä½•ä¿è¯åº”ç”¨çº¿ç¨‹éƒ½åœ¨å®‰å…¨ç‚¹ä¸Š" class="headerlink" title="GC å‘ç”Ÿæ—¶å¦‚ä½•ä¿è¯åº”ç”¨çº¿ç¨‹éƒ½åœ¨å®‰å…¨ç‚¹ä¸Š"></a>GC å‘ç”Ÿæ—¶å¦‚ä½•ä¿è¯åº”ç”¨çº¿ç¨‹éƒ½åœ¨å®‰å…¨ç‚¹ä¸Š</h4><p><strong>æŠ¢å…ˆå¼ä¸­æ–­</strong><br><code>GC</code>æŠ¢å…ˆä¸­æ–­æ‰€æœ‰çº¿ç¨‹ã€‚å¦‚æœå‘ç°æŸä¸ªçº¿ç¨‹ä¸åœ¨å®‰å…¨ç‚¹ï¼Œå°±é‡æ–°æ¢å¤è¯¥çº¿ç¨‹ï¼Œè®©çº¿ç¨‹è·‘åˆ°å®‰å…¨ç‚¹ã€è¿™ç§æ–¹å¼ä¸æ˜¯åº”ç”¨ç¨‹åºä¸»å¯¼ï¼Œè€Œæ˜¯ <code>GC</code> çº¿ç¨‹ä¸»å¯¼ï¼Œæ‰€ä»¥æ²¡æœ‰ä½¿ç”¨ã€‘</p>
<p><strong>ä¸»åŠ¨å¼ä¸­æ–­</strong><br><code>GC</code>çº¿ç¨‹ç»™è‡ªå·±è®¾ç½®ä¸€ä¸ªä¸­æ–­æ ‡å¿—ï¼Œå„ä¸ªåº”ç”¨çº¿ç¨‹è¿è¡Œåˆ°å®‰å…¨ç‚¹çš„æ—¶å€™ä¸»åŠ¨è½®è¯¢è¿™ä¸ªæ ‡å¿—ï¼Œå¦‚æœæ­¤æ—¶<code>GC</code>çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä¸ºçœŸï¼Œåˆ™å°†è‡ªå·±ä¸­æ–­æŒ‚èµ·ã€‚è¿™ç§æ–¹å¼çš„å¥½å¤„æ˜¯ç”±åº”ç”¨ç¨‹åºåœ¨å®‰å…¨ç‚¹ä¸»åŠ¨å‘èµ·ä¸­æ–­ï¼Œè€Œä¸ä¼šå‡ºç°è¢«è¿«åœ¨éå®‰å…¨ç‚¹çš„ä½ç½®å…ˆä¸­æ–­çš„æƒ…å†µ</p>
<h3 id="å®‰å…¨åŒºåŸŸ"><a href="#å®‰å…¨åŒºåŸŸ" class="headerlink" title="å®‰å…¨åŒºåŸŸ"></a>å®‰å…¨åŒºåŸŸ</h3><ol>
<li>å®‰å…¨ç‚¹æœºåˆ¶ä¿è¯äº†ç¨‹åºæ‰§è¡Œæ—¶ï¼Œåœ¨ä¸å¤ªé•¿çš„æ—¶é—´å†…å°±ä¼šé‡åˆ°å¯è¿›å…¥<code>GC</code>çš„å®‰å…¨ç‚¹, å¦‚æœåº”ç”¨çº¿ç¨‹è¢«é˜»å¡äº†åˆè¯¥å¦‚ä½•å¤„ç†ï¼Ÿâ€”è¿™å°±éœ€è¦é€šè¿‡å¼•å…¥ <strong>å®‰å…¨åŒºåŸŸ</strong> æ¥è§£å†³</li>
<li>å®‰å…¨åŒºåŸŸæ˜¯æŒ‡åœ¨ä¸€æ®µä»£ç ç‰‡æ®µä¸­ï¼Œå¯¹è±¡çš„å¼•ç”¨å…³ç³»ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåœ¨è¿™ä¸ªåŒºåŸŸä¸­çš„ä»»ä½•ä½ç½®å¼€å§‹<code>GC</code>éƒ½æ˜¯å®‰å…¨çš„</li>
<li>å½“çº¿ç¨‹è¿è¡Œå®‰å…¨åŒºåŸŸçš„ä»£ç æ—¶ï¼Œé¦–å…ˆæ ‡è¯†å·²ç»è¿›å…¥äº†å®‰å…¨åŒºåŸŸï¼Œå¦‚æœè¿™æ®µæ—¶é—´å†…å‘ç”Ÿ<code>GC</code>,<code>JVM</code>ä¼šå¿½ç•¥æ ‡è¯†ä¸ºå®‰å…¨åŒºåŸŸçŠ¶æ€çš„çº¿ç¨‹</li>
<li>å½“çº¿ç¨‹å³å°†ç¦»å¼€å®‰å…¨åŒºåŸŸæ—¶ï¼Œä¼šæ£€æŸ¥<code>JVM</code>æ˜¯å¦å·²ç»å®Œæˆ<code>GC</code>ï¼Œå¦‚æœå®Œæˆäº†ï¼Œåˆ™ç»§ç»­è¿è¡Œï¼Œå¦åˆ™çº¿ç¨‹å¿…é¡»ç­‰å¾…ç›´åˆ°æ”¶åˆ°å¯ä»¥å®‰å…¨ç¦»å¼€å®‰å…¨åŒºåŸŸçš„ä¿¡å·ä¸ºæ­¢</li>
</ol>
<h2 id="åƒåœ¾æ”¶é›†å™¨"><a href="#åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="åƒåœ¾æ”¶é›†å™¨"></a>åƒåœ¾æ”¶é›†å™¨</h2><h3 id="åƒåœ¾æ”¶é›†å™¨çš„åˆ†ç±»"><a href="#åƒåœ¾æ”¶é›†å™¨çš„åˆ†ç±»" class="headerlink" title="åƒåœ¾æ”¶é›†å™¨çš„åˆ†ç±»"></a>åƒåœ¾æ”¶é›†å™¨çš„åˆ†ç±»</h3><p>å‰é¢è®²è§£åƒåœ¾æ”¶é›†ç®—æ³•æ—¶æåˆ° <code>HotSpot</code> è™šæ‹Ÿæœºä¸­ä½¿ç”¨äº†åˆ†ä»£åƒåœ¾æ”¶é›†æ€æƒ³ï¼Œå¯¹åº”çš„æ ¹æ®åƒåœ¾æ”¶é›†å™¨å·¥ä½œçš„å†…å­˜åŒºé—´ä¸åŒï¼Œå¯åˆ†ä¸ºæ–°ç”Ÿä»£åƒåœ¾æ”¶é›†å™¨ï¼Œè€å¹´ä»£åƒåœ¾æ”¶é›†å™¨å’Œæ•´å †åƒåœ¾æ”¶é›†å™¨</p>
<pre class="mermaid">flowchart LR
    subgraph A["æ–°ç”Ÿä»£"]
        A1["Serial GC"]
        A2["Parallel Scavenge GC"]
        A3["ParNew GC"]
        A4["G1 GC"]
    end
    subgraph B["æ–°ç”Ÿä»£"]
        B1["Serial Old GC"]
        B2["Parallel Old GC"]
        B3["CMS GC"]
        B4["G1 GC"]
    end</pre>

<h3 id="Serial"><a href="#Serial" class="headerlink" title="Serial"></a>Serial</h3><ol>
<li><code>Serial</code> é‡‡ç”¨çš„æ˜¯<strong>å¤åˆ¶ç®—æ³•</strong>ã€<strong>ä¸²è¡Œå›æ”¶</strong>å’Œ<code>STW</code>æœºåˆ¶çš„æ–¹å¼æ‰§è¡Œå†…å­˜å›æ”¶</li>
<li><code>Serial</code> ç”¨äºå›æ”¶ <strong>æ–°ç”Ÿä»£</strong></li>
<li><code>Serial</code>æ”¶é›†å™¨ä½œä¸º<code>HotSpot</code>ä¸­<code>Client</code>æ¨¡å¼ä¸‹çš„é»˜è®¤æ–°ç”Ÿä»£åƒåœ¾æ”¶é›†å™¨</li>
</ol>
<h3 id="Serial-Old"><a href="#Serial-Old" class="headerlink" title="Serial Old"></a>Serial Old</h3><ol>
<li><code>Serial Old</code> ç”¨äºå›æ”¶ <strong>è€å¹´ä»£</strong></li>
<li><code>Serial Old</code>æ”¶é›†å™¨åŒæ ·é‡‡ç”¨äº†<strong>ä¸²è¡Œå›æ”¶</strong>å’Œ<code>STW</code>æœºåˆ¶ï¼Œåªä¸è¿‡å†…å­˜å›æ”¶ç®—æ³•ä½¿ç”¨çš„æ˜¯<strong>æ ‡è®°â€”å‹ç¼©ç®—æ³•</strong></li>
<li><code>Serial Old</code>æ˜¯è¿è¡Œåœ¨<code>Client</code>æ¨¡å¼ä¸‹é»˜è®¤çš„è€å¹´ä»£çš„åƒåœ¾æ”¶é›†å™¨</li>
<li><code>Serial Old</code>åœ¨<code>Server</code>æ¨¡å¼ä¸‹ä¸»è¦æœ‰ä¸¤ä¸ªç”¨é€”<ol>
<li>ä¸æ–°ç”Ÿä»£çš„<code>Parallel Scavenge</code>åƒåœ¾æ”¶é›†å™¨æ­é…</li>
<li>ä½œä¸ºè€å¹´ä»£<code>CMS</code>æ”¶é›†å™¨çš„åå¤‡æ–¹æ¡ˆ</li>
</ol>
</li>
</ol>
<h3 id="Serial-Serial-Oldåƒåœ¾æ”¶é›†å™¨è¿‡ç¨‹å›¾"><a href="#Serial-Serial-Oldåƒåœ¾æ”¶é›†å™¨è¿‡ç¨‹å›¾" class="headerlink" title="Serial&#x2F;Serial Oldåƒåœ¾æ”¶é›†å™¨è¿‡ç¨‹å›¾"></a>Serial&#x2F;Serial Oldåƒåœ¾æ”¶é›†å™¨è¿‡ç¨‹å›¾</h3><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311262309313.webp" alt="Serial"></p>
<h3 id="CMS"><a href="#CMS" class="headerlink" title="CMS"></a>CMS</h3><ol>
<li><code>CMS</code>ä¸»è¦é€‚åˆåœºæ™¯æ˜¯å¯¹å“åº”æ—¶é—´çš„éœ€æ±‚å¤§äºå¯¹ååé‡çš„è¦æ±‚ã€‚å®ƒæ˜¯HotSpotè™šæ‹Ÿæœºä¸­ç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘æ”¶é›†å™¨ï¼Œç¬¬ä¸€æ¬¡å®ç°äº†è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶å·¥ä½œ</li>
<li><code>CMS</code>çš„åƒåœ¾æ”¶é›†ç®—æ³•é‡‡ç”¨<strong>æ ‡è®°â€“æ¸…é™¤ç®—æ³•</strong>ï¼Œä¹Ÿä¼š<code>STW</code></li>
<li><code>CMS</code>ä½œä¸ºè€å¹´ä»£çš„æ”¶é›†å™¨ï¼Œæ— æ³•ä¸æ–°ç”Ÿä»£æ”¶é›†å™¨<code>Parallel Scavenge</code>é…åˆå·¥ä½œï¼Œæ‰€ä»¥ä½¿ç”¨<code>CMS</code>æ”¶é›†è€å¹´ä»£æ—¶ï¼Œæ–°ç”Ÿä»£åªèƒ½é€‰æ‹©<code>ParNew</code>æˆ–è€…<code>Serial</code>æ”¶é›†å™¨ä¸­çš„ä¸€ä¸ª</li>
<li><code>JDK9</code> ä¸­ <code>G1</code> å˜æˆäº†é»˜è®¤çš„åƒåœ¾æ”¶é›†å™¨ï¼Œæ›¿æ¢äº† <code>CMS</code></li>
<li><code>JDK14</code> ä¸­ï¼Œå½»åº•ç§»é™¤äº† <code>CMS</code> åƒåœ¾æ”¶é›†å™¨</li>
</ol>
<h3 id="CMS-åƒåœ¾å›æ”¶è¿‡ç¨‹"><a href="#CMS-åƒåœ¾å›æ”¶è¿‡ç¨‹" class="headerlink" title="CMS åƒåœ¾å›æ”¶è¿‡ç¨‹"></a>CMS åƒåœ¾å›æ”¶è¿‡ç¨‹</h3><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311262316564.webp" alt="CMSåƒåœ¾å›æ”¶è¿‡ç¨‹"></p>
<ol>
<li>åˆå§‹æ ‡è®°ï¼š è¯¥é˜¶æ®µçš„ä¸»è¦ä»»åŠ¡ä»…ä»…åªæ˜¯æ ‡è®°å‡º<code>GC Roots</code>èƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ã€‚ä¸€æ—¦æ ‡è®°å®Œæˆä¹‹åå°±ä¼šæ¢å¤ä¹‹å‰è¢«æš‚åœçš„æ‰€æœ‰åº”ç”¨çº¿ç¨‹ã€‚ç”±äºç›´æ¥å…³è”å¯¹è±¡æ¯”è¾ƒå°ï¼Œæ‰€ä»¥è¿™é‡Œçš„é€Ÿåº¦éå¸¸å¿«</li>
<li>å¹¶å‘æ ‡è®°ï¼š ä»<code>GC Roots</code>çš„ç›´æ¥å…³è”å¯¹è±¡å¼€å§‹éå†æ•´ä¸ªå¯¹è±¡å›¾çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹è€—æ—¶è¾ƒé•¿ä½†æ˜¯ä¸éœ€è¦åœé¡¿ç”¨æˆ·çº¿ç¨‹ï¼Œå¯ä»¥ä¸åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸€èµ·å¹¶å‘è¿è¡Œ</li>
<li>é‡æ–°æ ‡è®°(<code>Remark</code>): ç”±äºåœ¨å¹¶å‘æ ‡è®°é˜¶æ®µä¸­ï¼Œç¨‹åºçš„å·¥ä½œçº¿ç¨‹ä¼šå’Œåƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶è¿è¡Œæˆ–è€…äº¤å‰è¿è¡Œï¼Œä¸ºäº†ä¿®æ­£åœ¨å¹¶å‘æ ‡è®°æœŸé—´å› ç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼Œéœ€è¦ä¸€æ¬¡é‡æ–°æ ‡è®°æ“ä½œ</li>
<li>å¹¶å‘æ¸…é™¤ï¼š æ­¤é˜¶æ®µæ¸…ç†å·²ç»è¢«æ ‡è®°ä¸ºæ­»äº¡çš„å¯¹è±¡ï¼Œé‡Šæ”¾å†…å­˜ç©ºé—´ã€‚ç”±äºä¸éœ€è¦ç§»åŠ¨å­˜æ´»å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¸ªé˜¶æ®µä¹Ÿæ˜¯å¯ä»¥ä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶å¹¶å‘çš„</li>
</ol>
<h3 id="CMS-åƒåœ¾æ”¶é›†å™¨çš„ç¼ºç‚¹"><a href="#CMS-åƒåœ¾æ”¶é›†å™¨çš„ç¼ºç‚¹" class="headerlink" title="CMS åƒåœ¾æ”¶é›†å™¨çš„ç¼ºç‚¹"></a>CMS åƒåœ¾æ”¶é›†å™¨çš„ç¼ºç‚¹</h3><ol>
<li>ç”±äºä½¿ç”¨çš„æ˜¯æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼Œå› æ­¤ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼ˆä¸ºä»€ä¹ˆä¸ä½¿ç”¨æ•´ç†ç®—æ³•å‘¢â€“å› ä¸ºè¦ä¿è¯åƒåœ¾æ”¶é›†å’Œç”¨æˆ·çº¿ç¨‹åŒæ—¶è¿è¡Œï¼Œæ‰€ä»¥ç”¨æˆ·çº¿ç¨‹æ‰€éœ€çš„èµ„æºå°±ä¸èƒ½ç§»åŠ¨ä½ç½®ï¼Œæ ‡è®°æ•´ç†ç®—æ³•éœ€è¦ç§»åŠ¨å¯¹è±¡ä½ç½®ï¼‰</li>
<li>å¯¹<code>CPU</code>èµ„æºéå¸¸æ•æ„Ÿã€‚åœ¨å¹¶å‘é˜¶æ®µï¼Œå®ƒè™½ç„¶ä¸ä¼šå¯¼è‡´ç”¨æˆ·åœé¡¿ï¼Œä½†æ˜¯ä¼šå› ä¸ºå ç”¨äº†ä¸€éƒ¨åˆ†çº¿ç¨‹è€Œå¯¼è‡´åº”ç”¨ç¨‹åºå˜æ…¢ï¼Œæ€»ååé‡ä¼šé™ä½</li>
<li>ç”±äºåœ¨åƒåœ¾æ”¶é›†é˜¶æ®µç”¨æˆ·çº¿ç¨‹æ²¡æœ‰ä¸­æ–­ï¼Œè¦æ˜¯<code>CMS</code>è¿è¡ŒæœŸé—´é¢„ç•™çš„å†…å­˜æ— æ³•æ»¡è¶³ç¨‹åºéœ€è¦ï¼Œå°±ä¼šå‡ºç°ä¸€æ¬¡<code>â€œConcurrent Mode Failureâ€</code>å¤±è´¥è€Œå¯¼è‡´å¦ä¸€æ¬¡<code>Full GC</code>çš„äº§ç”Ÿ</li>
<li>æ— æ³•å¤„ç†<strong>æµ®åŠ¨åƒåœ¾</strong>,åœ¨å¹¶å‘æ¸…é™¤é˜¶æ®µç”±äºç¨‹åºçš„å·¥ä½œçº¿ç¨‹å’Œåƒåœ¾æ”¶é›†çº¿ç¨‹æ˜¯åŒæ—¶è¿è¡Œæˆ–è€…äº¤å‰è¿è¡Œçš„ï¼Œé‚£ä¹ˆåœ¨å¹¶å‘æ¸…é™¤é˜¶æ®µå¦‚æœäº§ç”Ÿæ–°çš„åƒåœ¾å¯¹è±¡ï¼Œ<code>CMS</code>å°†æ— æ³•å¯¹è¿™äº›åƒåœ¾å¯¹è±¡è¿›è¡Œæ ‡è®°ï¼Œæœ€ç»ˆä¼šå¯¼è‡´è¿™äº›æ–°äº§ç”Ÿçš„åƒåœ¾å¯¹è±¡æ²¡æœ‰è¢«åŠæ—¶å›æ”¶</li>
</ol>
<h3 id="G1-æ”¶é›†å™¨"><a href="#G1-æ”¶é›†å™¨" class="headerlink" title="G1 æ”¶é›†å™¨"></a>G1 æ”¶é›†å™¨</h3><p><strong>ä¸ºä»€ä¹ˆéœ€è¦ G1 åƒåœ¾æ”¶é›†å™¨</strong><br>ä¸ºäº†å®ç°åœ¨åº”ç”¨ç¨‹åºè¿è¡Œç¯å¢ƒå†…å­˜ä¸æ–­æ‰©å¤§ï¼Œå¤„ç†å™¨æ•°é‡ä¸æ–­å¢åŠ çš„æƒ…å†µä¸‹ï¼Œè¿›ä¸€æ­¥é™ä½åœé¡¿æ—¶é—´ï¼ŒåŒæ—¶è¿˜èƒ½å…¼é¡¾è‰¯å¥½çš„ååé‡çš„ç›®æ ‡</p>
<p><strong>G1 åƒåœ¾æ”¶é›†å™¨çš„å·¥ä½œæ–¹å¼</strong><br><code>G1</code>æœ‰è®¡åˆ’åœ°é¿å…åœ¨æ•´ä¸ª<code>Java</code>å †ä¸­è¿›è¡Œå…¨åŒºåŸŸçš„åƒåœ¾æ”¶é›†ã€‚<code>G1</code>è·Ÿè¸ªå„ä¸ª<code>Region</code>é‡Œé¢çš„åƒåœ¾å †ç§¯çš„ä»·å€¼å¤§å°ï¼ˆå›æ”¶æ‰€è·å¾—çš„ç©ºé—´å¤§å°ä»¥åŠå›æ”¶æ‰€éœ€æ—¶é—´çš„ç»éªŒå€¼ï¼‰ï¼Œåœ¨åå°ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆå›æ”¶ä»·å€¼æœ€å¤§çš„<code>Region</code></p>
<p><strong>G1 åƒåœ¾æ”¶é›†å™¨çš„ä½¿ç”¨åœºæ™¯</strong><br><code>G1</code>æ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡ç«¯åº”ç”¨çš„åƒåœ¾æ”¶é›†å™¨ï¼Œä¸»è¦é’ˆå¯¹é…å¤‡å¤šæ ¸<code>CPU</code>åŠå¤§å®¹é‡å†…å­˜çš„æœºå™¨ï¼Œæå¤§å¯èƒ½é™ä½åƒåœ¾å›æ”¶åœé¡¿æ—¶é—´çš„åŒæ—¶ï¼Œè¿˜å…¼å…·é«˜ååé‡çš„æ€§èƒ½ç‰¹å¾</p>
<h3 id="G1-åƒåœ¾æ”¶é›†å™¨æ”¶é›†åƒåœ¾è¿‡ç¨‹"><a href="#G1-åƒåœ¾æ”¶é›†å™¨æ”¶é›†åƒåœ¾è¿‡ç¨‹" class="headerlink" title="G1 åƒåœ¾æ”¶é›†å™¨æ”¶é›†åƒåœ¾è¿‡ç¨‹"></a>G1 åƒåœ¾æ”¶é›†å™¨æ”¶é›†åƒåœ¾è¿‡ç¨‹</h3><p><code>G1</code> å¯ä»¥ä½œç”¨äºæ•´ä¸ªæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œåƒåœ¾å›æ”¶è¿‡ç¨‹å¦‚ä¸‹</p>
<ol>
<li>æ–°ç”Ÿä»£GC</li>
<li>è€å¹´ä»£å¹¶å‘æ ‡è®°</li>
<li>æ··åˆå›æ”¶</li>
</ol>
]]></content>
      <categories>
        <category>java</category>
        <category>jvm</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>jvmç±»åŠ è½½æœºåˆ¶</title>
    <url>/2024/859a04275429/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="1-ç±»çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ"><a href="#1-ç±»çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="1. ç±»çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ"></a>1. ç±»çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ</h2><pre class="mermaid">flowchart LR
    A["åŠ è½½"]
    subgraph B["é“¾æ¥"]
        direction LR
        B1["éªŒè¯"]
        B2["å‡†å¤‡"]
        B3["è§£æ"]
        B1-->B2-->B3
    end
    C["åˆå§‹åŒ–"]
    D["ä½¿ç”¨"]
    E["å¸è½½"]
    A-->B-->C-->D-->E</pre>
<p>æ¥ä¸‹æ¥çœ‹çœ‹æ¯ä¸ªé˜¶æ®µåšçš„äº‹æƒ…</p>
<h3 id="1-1-åŠ è½½é˜¶æ®µå®Œæˆçš„äº‹æƒ…"><a href="#1-1-åŠ è½½é˜¶æ®µå®Œæˆçš„äº‹æƒ…" class="headerlink" title="1.1. åŠ è½½é˜¶æ®µå®Œæˆçš„äº‹æƒ…"></a>1.1. åŠ è½½é˜¶æ®µå®Œæˆçš„äº‹æƒ…</h3><ul>
<li>æ ¹æ®ç±»çš„å…¨é™å®šåè¯»å–ç±»çš„äºŒè¿›åˆ¶æµ</li>
<li>å°†å­—èŠ‚æµæ‰€ä»£è¡¨çš„çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ <strong>å­—èŠ‚ç ç»“æ„æ˜¯å­˜å‚¨åœ¨æ–¹æ³•åŒº</strong></li>
<li>åœ¨å †åŒºä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„<code>java.lang.Class</code>å¯¹è±¡ï¼Œç”¨äºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ï¼Œ <strong>Classå¯¹è±¡æ˜¯åœ¨å †ä¸­</strong></li>
</ul>
<h3 id="1-2-é“¾æ¥é˜¶æ®µ"><a href="#1-2-é“¾æ¥é˜¶æ®µ" class="headerlink" title="1.2. é“¾æ¥é˜¶æ®µ"></a>1.2. é“¾æ¥é˜¶æ®µ</h3><h4 id="1-2-1-å‡†å¤‡é˜¶æ®µå®Œæˆçš„äº‹æƒ…"><a href="#1-2-1-å‡†å¤‡é˜¶æ®µå®Œæˆçš„äº‹æƒ…" class="headerlink" title="1.2.1. å‡†å¤‡é˜¶æ®µå®Œæˆçš„äº‹æƒ…"></a>1.2.1. å‡†å¤‡é˜¶æ®µå®Œæˆçš„äº‹æƒ…</h4><ul>
<li>ç»™ç±»å˜é‡åˆ†é…å†…å­˜å¹¶é™„åˆå§‹å€¼(é›¶å€¼) </li>
<li><code>final</code> ä¿®é¥°çš„å˜é‡ç›´æ¥èµ‹å€¼ï¼Œè€Œä¸æ˜¯åˆå§‹åŒ–ä¸ºé›¶å€¼</li>
</ul>
<h4 id="1-2-2-è§£æé˜¶æ®µå®Œæˆçš„äº‹æƒ…"><a href="#1-2-2-è§£æé˜¶æ®µå®Œæˆçš„äº‹æƒ…" class="headerlink" title="1.2.2. è§£æé˜¶æ®µå®Œæˆçš„äº‹æƒ…"></a>1.2.2. è§£æé˜¶æ®µå®Œæˆçš„äº‹æƒ…</h4><ul>
<li>è™šæ‹Ÿæœºå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨</li>
</ul>
<h3 id="1-3-åˆå§‹åŒ–é˜¶æ®µå®Œæˆçš„äº‹æƒ…"><a href="#1-3-åˆå§‹åŒ–é˜¶æ®µå®Œæˆçš„äº‹æƒ…" class="headerlink" title="1.3. åˆå§‹åŒ–é˜¶æ®µå®Œæˆçš„äº‹æƒ…"></a>1.3. åˆå§‹åŒ–é˜¶æ®µå®Œæˆçš„äº‹æƒ…</h3><ul>
<li>ä¸ºç±»å˜é‡èµ‹å€¼ï¼ˆåœ¨å‡†å¤‡é˜¶æ®µæ˜¯ç»™ç±»å˜é‡åˆ†é…å†…å­˜å’Œèµ‹é›¶å€¼ï¼‰ï¼Œè¿™é‡Œæ˜¯è®¾ç½®ä¸ºä»£ç ä¸­è®¾å®šçš„å€¼ï¼Œæ¯”å¦‚ <code>static int a = 10</code>, è¿™é‡Œçš„èµ‹å€¼å°±æ˜¯å°†10èµ‹å€¼ç»™ <code>a</code></li>
<li>å½“ä¸€ä¸ªç±»ä¸­å«æœ‰ç±»å˜é‡æˆ–é™æ€æ–¹æ³•ï¼Œ<code>jvm</code> ä¼šç»™å½“å‰ç±»ç”Ÿæˆä¸€ä¸ª <strong>ç±»åˆå§‹åŒ–æ–¹æ³•</strong> <code>&lt;clinit&gt;</code></li>
</ul>
<h2 id="2-ç±»åŠ è½½å™¨"><a href="#2-ç±»åŠ è½½å™¨" class="headerlink" title="2. ç±»åŠ è½½å™¨"></a>2. ç±»åŠ è½½å™¨</h2><p>åœ¨å‰é¢è®²ç±»çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæ—¶ï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µå°±æ˜¯åŠ è½½ï¼ŒåŠ è½½åŠ¨ä½œå°±æ˜¯é€šè¿‡ç±»åŠ è½½å™¨å®Œæˆçš„ï¼Œç±»åŠ è½½å™¨å®Œæˆçš„äº‹æƒ…å°±æ˜¯ <strong>é€šè¿‡ç±»çš„å…¨é™å®šåè·å–æè¿°ç±»çš„äºŒè¿›åˆ¶æµ</strong></p>
<h3 id="2-1-jdk9-ä¹‹å‰çš„ç±»åŠ è½½å™¨"><a href="#2-1-jdk9-ä¹‹å‰çš„ç±»åŠ è½½å™¨" class="headerlink" title="2.1. jdk9 ä¹‹å‰çš„ç±»åŠ è½½å™¨"></a>2.1. jdk9 ä¹‹å‰çš„ç±»åŠ è½½å™¨</h3><pre class="mermaid">flowchart TB
    A["BootStrap ClassLoader"]
    B["xtension ClassLoader"]
    C["Application ClassLoader"]
    D1["è‡ªå®šä¹‰ç±»åŠ è½½å™¨ User ClassLoader"]
    D2["è‡ªå®šä¹‰ç±»åŠ è½½å™¨ User ClassLoader"]
    A-->B-->C
    C-->D1
    C-->D2</pre>

<h3 id="2-2-jdk9-ä¹‹åçš„ç±»åŠ è½½å™¨"><a href="#2-2-jdk9-ä¹‹åçš„ç±»åŠ è½½å™¨" class="headerlink" title="2.2. jdk9 ä¹‹åçš„ç±»åŠ è½½å™¨"></a>2.2. jdk9 ä¹‹åçš„ç±»åŠ è½½å™¨</h3><pre class="mermaid">flowchart TB
    A["BootStrap ClassLoader"]
    B["Platform  ClassLoader"]
    C["Application ClassLoader"]
    D1["è‡ªå®šä¹‰ç±»åŠ è½½å™¨ User ClassLoader"]
    D2["è‡ªå®šä¹‰ç±»åŠ è½½å™¨ User ClassLoader"]
    A-->B-->C
    C-->D1
    C-->D2</pre>

<h3 id="2-3-åŒäº²å§”æ´¾æ¨¡å¼"><a href="#2-3-åŒäº²å§”æ´¾æ¨¡å¼" class="headerlink" title="2.3. åŒäº²å§”æ´¾æ¨¡å¼"></a>2.3. åŒäº²å§”æ´¾æ¨¡å¼</h3><ol>
<li>å½“ä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°åŠ è½½è¯·æ±‚æ—¶ä¼šå…ˆæŠŠåŠ è½½è¯·æ±‚å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½å™¨</li>
<li>å¦‚æœçˆ¶ç±»åŠ è½½å™¨ä¹Ÿå­˜åœ¨çˆ¶ç±»åŠ è½½å™¨ï¼Œç»§ç»­å‘ä¸Šå§”æ‰˜ï¼Œç›´è‡³æœ€é¡¶å±‚å¼•å¯¼ç±»åŠ è½½å™¨</li>
<li>å¦‚æœçˆ¶ç±»åŠ è½½å™¨èƒ½å®Œæˆç±»çš„åŠ è½½ï¼Œå°±äº¤ç»™çˆ¶ç±»åŠ è½½å™¨å®Œæˆï¼Œåä¹‹ç”±å­ç±»è¿›è¡ŒåŠ è½½</li>
</ol>
<p><strong>æ³¨ï¼šè¿™é‡Œç±»åŠ è½½å™¨ä¸­æ‰€è¯´çš„çˆ¶ç±»ä¸æ˜¯ç»§æ‰¿å…³ç³»ï¼Œè€Œæ˜¯å®ç°ç±»åŠ è½½å™¨çš„å±‚çº§å…³ç³»ï¼Œå­ç±»åŠ è½½å™¨ä¸­ä¼šåŒ…å«çˆ¶ç±»åŠ è½½å™¨çš„å¼•ç”¨è€Œå·²</strong></p>
<h4 id="2-3-1-ä¼˜ç‚¹"><a href="#2-3-1-ä¼˜ç‚¹" class="headerlink" title="2.3.1. ä¼˜ç‚¹"></a>2.3.1. ä¼˜ç‚¹</h4><ul>
<li>é¿å…æ ¸å¿ƒç±»åº“è¢«ä¿®æ”¹ï¼Œå³ä½¿æœ‰ç›¸åŒå…¨é™å®šç±»åçš„ç±»ï¼Œä¹Ÿä¼šå…ˆäº¤ç»™çˆ¶ç±»å»åˆ¤æ–­</li>
<li>é¿å…å…¨é™å®šåç›¸åŒçš„ç±»è¢«é‡å¤åŠ è½½ï¼Œå¯¼è‡´ç¨‹åºå¼‚å¸¸</li>
</ul>
]]></content>
      <categories>
        <category>java</category>
        <category>jvm</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>jvmæ‰§è¡Œå¼•æ“</title>
    <url>/2023/a18206d79e08/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="æ‰§è¡Œå¼•æ“çš„ä½œç”¨"><a href="#æ‰§è¡Œå¼•æ“çš„ä½œç”¨" class="headerlink" title="æ‰§è¡Œå¼•æ“çš„ä½œç”¨"></a>æ‰§è¡Œå¼•æ“çš„ä½œç”¨</h2><pre class="mermaid">flowchart TB
    A["javaæºä»£ç (.javaæ–‡ä»¶)"]
    B["classå­—èŠ‚ç æ–‡ä»¶"]
    C["å†…å­˜(æ”¾å…¥jvmæ–¹æ³•åŒº)"]
        subgraph D["æ‰§è¡Œå¼•æ“"]
            subgraph D1["ç¼–è¯‘å™¨"]
                D11["Client Compiler"]
                D12["Server Compiler"]
            end
        end
    E["æœºå™¨ç "]

    A--"javacç¼–è¯‘å™¨"-->B
    B--"ç±»åŠ è½½å™¨"-->C
    C-->D
    D--è§£é‡Šæ‰§è¡Œ-->E
    D--"ç¼–è¯‘æ‰§è¡Œ(JIT)"-->E</pre>
<h3 id="å­—èŠ‚ç "><a href="#å­—èŠ‚ç " class="headerlink" title="å­—èŠ‚ç "></a>å­—èŠ‚ç </h3><ol>
<li><code>Java</code>ç¨‹åºå¯ä»¥é€šè¿‡ç¼–è¯‘å™¨å°†æºç ç¼–è¯‘æˆ<code>Java</code>å­—èŠ‚ç ï¼Œç‰¹å®šå¹³å°ä¸Šçš„è™šæ‹Ÿæœºå°†å­—èŠ‚ç è½¬è¯‘ä¸ºå¯ä»¥ç›´æ¥æ‰§è¡Œçš„æœºå™¨ç ï¼Œä¹Ÿå°±å®ç°äº†è·¨å¹³å°æ€§</li>
<li>å­—èŠ‚ç ä¸»è¦ä¸ºäº†å®ç°ç‰¹å®šè½¯ä»¶è¿è¡Œå’Œè½¯ä»¶ç¯å¢ƒï¼Œä¸ç¡¬ä»¶ç¯å¢ƒæ— å…³</li>
</ol>
<h2 id="å³æ—¶ç¼–è¯‘å™¨-JIT-çš„ä½œç”¨"><a href="#å³æ—¶ç¼–è¯‘å™¨-JIT-çš„ä½œç”¨" class="headerlink" title="å³æ—¶ç¼–è¯‘å™¨(JIT)çš„ä½œç”¨"></a>å³æ—¶ç¼–è¯‘å™¨(JIT)çš„ä½œç”¨</h2><ol>
<li>å³æ—¶ç¼–è¯‘å™¨åœ¨æœ€åˆçš„ <code>jvm</code> ä¸­æ˜¯æ²¡æœ‰çš„ï¼Œæ²¡æœ‰çš„åŸå› å°±æ˜¯ <code>jvm</code> è®¾è®¡çš„åˆè¡·æ˜¯ä¸ºäº†æ»¡è¶³ <code>Java</code> ç¨‹åºå®ç°è·¨å¹³å°çš„ç‰¹æ€§ï¼Œæ‰€ä»¥é¿å…é‡‡ç”¨é™æ€ç¼–è¯‘çš„æ–¹å¼ç›´æ¥ç”Ÿæˆæœºå™¨ç ï¼Œæ‰€ä»¥é‡‡ç”¨äº†è§£é‡Šå™¨åœ¨è¿è¡Œæ—¶é€è¡Œè§£é‡Šå­—èŠ‚ç æ‰§è¡Œç¨‹åº</li>
<li><code>JIT</code>ç¼–è¯‘å™¨çš„ä½œç”¨å°±æ˜¯è™šæ‹Ÿæœºå°†å­—èŠ‚ç ç›´æ¥ç¼–è¯‘æˆæœºå™¨ç </li>
<li><strong>æ— è®ºæ˜¯é‡‡ç”¨è§£é‡Šå™¨è¿›è¡Œè§£é‡Šæ‰§è¡Œï¼Œè¿˜æ˜¯é‡‡ç”¨å³æ—¶ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘æ‰§è¡Œï¼Œæœ€ç»ˆå­—èŠ‚ç éƒ½æ˜¯éœ€è¦è¢«è½¬æ¢æˆå¯¹åº”å¹³å°çš„æœºå™¨ç </strong></li>
</ol>
<h2 id="ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦ä½¿ç”¨è§£é‡Šå™¨ä¸ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„"><a href="#ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦ä½¿ç”¨è§£é‡Šå™¨ä¸ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„" class="headerlink" title="ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦ä½¿ç”¨è§£é‡Šå™¨ä¸ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„"></a>ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦ä½¿ç”¨è§£é‡Šå™¨ä¸ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„</h2><p>å› ä¸ºè§£é‡Šå™¨å’Œç¼–è¯‘å™¨å„æœ‰ä¼˜åŠ¿</p>
<ol>
<li>ç¨‹åºå¯åŠ¨åï¼Œè§£é‡Šå™¨å¯ä»¥ç«‹å³å‘æŒ¥ä½œç”¨ï¼Œçœå»ç¼–è¯‘çš„æ—¶é—´ï¼Œç«‹å³æ‰§è¡Œã€‚ç¼–è¯‘å™¨æƒ³è¦å‘æŒ¥ä½œç”¨ï¼Œå°†ä»£ç ç¼–è¯‘æˆæœºå™¨ç ï¼Œéœ€è¦ä¸€å®šçš„æ‰§è¡Œæ—¶é—´ï¼Œä½†æ˜¯ç¼–è¯‘ä¸ºæœºå™¨ç ä¹‹åï¼Œæ‰§è¡Œæ•ˆç‡æ›´é«˜</li>
<li>å½“ç¨‹åºçš„è¿è¡Œç¯å¢ƒä¸­å†…å­˜èµ„æºè¾ƒå¤§(æ¯”å¦‚åµŒå…¥å¼ç³»ç»Ÿ)æ—¶ï¼Œè§£é‡Šæ‰§è¡Œå¯ä»¥æ›´èŠ‚çº¦å†…å­˜</li>
</ol>
<h2 id="ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦å®ç°ä¸¤ä¸ªä¸åŒçš„å³æ—¶ç¼–è¯‘å™¨"><a href="#ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦å®ç°ä¸¤ä¸ªä¸åŒçš„å³æ—¶ç¼–è¯‘å™¨" class="headerlink" title="ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦å®ç°ä¸¤ä¸ªä¸åŒçš„å³æ—¶ç¼–è¯‘å™¨"></a>ä¸ºä½•HotSpotè™šæ‹Ÿæœºè¦å®ç°ä¸¤ä¸ªä¸åŒçš„å³æ—¶ç¼–è¯‘å™¨</h2><p><code>HotSpot</code> è™šæ‹ŸæœºåŒ…å«ä¸¤ä¸ªå³æ—¶ç¼–è¯‘å™¨</p>
<ol>
<li><code>Client Compile</code>ï¼Œ ä¹Ÿå«åš <code>c1</code> ç¼–è¯‘å™¨</li>
<li><code>Server Compile</code>ï¼Œä¹Ÿå«åš <code>c2</code> ç¼–è¯‘å™¨</li>
</ol>
<p><code>HotSpot</code> è™šæ‹Ÿæœºé»˜è®¤é‡‡ç”¨è§£é‡Šå™¨å’Œå…¶ä¸­ä¸€ä¸ªç¼–è¯‘å™¨é…åˆçš„æ–¹å¼å·¥ä½œï¼Œç¨‹åºä½¿ç”¨å“ªä¸ªç¼–è¯‘å™¨ï¼Œå–å†³äºè™šæ‹Ÿæœºè¿è¡Œçš„æ¨¡å¼</p>
<p>é€šè¿‡ <code>-client</code> å‚æ•°å¯ä»¥æŒ‡å®š <code>jvm</code> è¿è¡Œåœ¨ <code>Client</code> æ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨ <code>c1</code> ç¼–è¯‘å™¨ï¼Œ<code>c1</code> ç¼–è¯‘å™¨ä¼šå¯¹å­—èŠ‚ç è¿›è¡Œç®€å•å’Œå¯é çš„ä¼˜åŒ–ï¼Œè€—æ—¶çŸ­ï¼Œè¾¾åˆ°æ›´å¿«çš„ç¼–è¯‘é€Ÿåº¦</p>
<p>é€šè¿‡ <code>-server</code> å‚æ•°å¯ä»¥æŒ‡å®š <code>jvm</code> è¿è¡Œåœ¨ <code>Server</code> æ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨ <code>c2</code> ç¼–è¯‘å™¨ï¼Œ<code>c2</code> ä¼šè¿›è¡Œè€—æ—¶è¾ƒé•¿çš„ä¼˜åŒ–ï¼Œä»¥åŠæ¿€è¿›ä¼˜åŒ–ï¼Œä½†ä¼˜åŒ–çš„ä»£ç æ‰§è¡Œæ•ˆç‡æ›´é«˜</p>
<p>å®æ–½åˆ†å±‚ç¼–è¯‘åï¼Œ<code>Client Compiler</code>å’Œ<code>Server Compiler</code>å°†ä¼šåŒæ—¶å·¥ä½œï¼Œè®¸å¤šä»£ç éƒ½å¯èƒ½ä¼šè¢«å¤šæ¬¡ç¼–è¯‘ï¼Œç”¨<code>Client Compiler</code>è·å–æ›´é«˜çš„ç¼–è¯‘é€Ÿåº¦ï¼Œç”¨<code>Server Compiler</code>æ¥è·å–æ›´å¥½çš„ç¼–è¯‘è´¨é‡ï¼Œåœ¨è§£é‡Šæ‰§è¡Œçš„æ—¶å€™ä¹Ÿæ— é¡»å†æ‰¿æ‹…æ”¶é›†æ€§èƒ½ç›‘æ§ä¿¡æ¯çš„ä»»åŠ¡</p>
<h2 id="ç¨‹åºä½•æ—¶ä½¿ç”¨è§£é‡Šå™¨æ‰§è¡Œï¼Ÿä½•æ—¶ä½¿ç”¨ç¼–è¯‘å™¨æ‰§è¡Œï¼Ÿ"><a href="#ç¨‹åºä½•æ—¶ä½¿ç”¨è§£é‡Šå™¨æ‰§è¡Œï¼Ÿä½•æ—¶ä½¿ç”¨ç¼–è¯‘å™¨æ‰§è¡Œï¼Ÿ" class="headerlink" title="ç¨‹åºä½•æ—¶ä½¿ç”¨è§£é‡Šå™¨æ‰§è¡Œï¼Ÿä½•æ—¶ä½¿ç”¨ç¼–è¯‘å™¨æ‰§è¡Œï¼Ÿ"></a>ç¨‹åºä½•æ—¶ä½¿ç”¨è§£é‡Šå™¨æ‰§è¡Œï¼Ÿä½•æ—¶ä½¿ç”¨ç¼–è¯‘å™¨æ‰§è¡Œï¼Ÿ</h2><p>åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¼šè¢«å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘çš„ <strong>çƒ­ç‚¹ä»£ç </strong>åŒ…å«ä¸¤ç±»</p>
<ol>
<li>è¢«<strong>å¤šæ¬¡</strong>è°ƒç”¨çš„æ–¹æ³•</li>
<li>è¢«<strong>å¤šæ¬¡</strong>æ‰§è¡Œçš„å¾ªç¯ä½“</li>
</ol>
<h3 id="çƒ­ç‚¹æ¢æµ‹"><a href="#çƒ­ç‚¹æ¢æµ‹" class="headerlink" title="çƒ­ç‚¹æ¢æµ‹"></a>çƒ­ç‚¹æ¢æµ‹</h3><p>æ— è®ºæ˜¯åŸºäºå¤šæ¬¡è°ƒç”¨çš„æ–¹æ³•è¿˜æ˜¯å¤šæ¬¡æ‰§è¡Œçš„å¾ªç¯ä½“ï¼Œéƒ½å¼ºè°ƒå¤šæ¬¡ï¼Œå…·ä½“å¤šå°‘æ¬¡ç®—å¤šæ¬¡å‘¢ï¼Ÿ åœ¨ <code>HotSpot</code> ä¸­æ˜¯ä½¿ç”¨ <strong>åŸºäºè®¡æ•°å™¨çš„çƒ­ç‚¹æ¢æµ‹</strong> æ–¹å¼æ¥åˆ¤æ–­æ‰§è¡Œçš„æ¬¡æ•°çš„ï¼Œåœ¨ <code>HotSpot</code> è™šæ‹Ÿæœºä¸­ä¸ºæ¯ä¸ªæ–¹æ³•å‡†å¤‡äº†ä¸¤ç±»è®¡æ•°å™¨ï¼Œè¿™ä¸¤ç±»è®¡æ•°å™¨éƒ½æœ‰ç¡®å®šçš„é˜ˆå€¼ï¼Œå½“æŠ€æœ¯å™¨è¶…è¿‡é˜ˆå€¼äº†ï¼Œå°±ä¼šè§¦å‘ <code>JIT</code> ç¼–è¯‘</p>
<ol>
<li>æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ï¼š ç”¨æ¥ç»Ÿè®¡æ–¹æ³•è°ƒç”¨çš„æ¬¡æ•°ï¼Œå¯ä»¥é€šè¿‡å‚æ•° <code>-XX:CompileThreshold</code> æ¥è®¤ä¸ºè®¾ç½®é˜ˆå€¼</li>
<li>å›è¾¹è®¡æ•°å™¨ï¼š ç”¨æ¥ç»Ÿè®¡ä¸€ä¸ªæ–¹æ³•ä¸­å¾ªç¯ä½“ä»£ç æ‰§è¡Œçš„æ¬¡æ•°ï¼Œåœ¨å­—èŠ‚ç ä¸­é‡åˆ°æ§åˆ¶æµå‘åè·³è½¬çš„æŒ‡ä»¤ç§°ä¸º <strong>å›è¾¹</strong></li>
</ol>
]]></content>
      <categories>
        <category>java</category>
        <category>jvm</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>jvmè¿è¡Œæ—¶å†…å­˜åŒºåŸŸ</title>
    <url>/2023/70e7b048ccf4/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>
ä»¥ä¸‹å†…å®¹å‚è€ƒã€Šå‰‘æŒ‡JVM:è™šæ‹Ÿæœºå®è·µä¸æ€§èƒ½è°ƒä¼˜ã€‹

<h2 id="JVM-æ•´ä½“ç»“æ„"><a href="#JVM-æ•´ä½“ç»“æ„" class="headerlink" title="JVM æ•´ä½“ç»“æ„"></a>JVM æ•´ä½“ç»“æ„</h2><ol>
<li><code>JVM</code> åœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´æŠŠå®ƒæ‰€ç®¡ç†çš„å†…å­˜åˆ†ä¸ºè‹¥å¹²ä¸ªä¸åŒçš„æ•°æ®åŒºåŸŸ</li>
<li><code>JVM</code> å†…å­˜å¸ƒå±€è§„å®šäº† <code>Java</code> åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å†…å­˜ç”³è¯·ã€åˆ†é…ã€ç®¡ç†çš„ç­–ç•¥ï¼Œä¿è¯äº†JVMçš„é«˜æ•ˆç¨³å®šè¿è¡Œ</li>
<li>çº¿ç¨‹ç§æœ‰åŒºåŸŸï¼š è™šæ‹Ÿæœºæ ˆï¼Œæœ¬åœ°æ–¹æ³•æ ˆï¼Œç¨‹åºè®¡æ•°å™¨</li>
<li>çº¿ç¨‹å…±äº«åŒºåŸŸï¼š å †ï¼Œæ–¹æ³•åŒº</li>
</ol>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311222254661.png" alt="jvm æ•´ä½“ç»“æ„"></p>
<h2 id="ç¨‹åºè®¡æ•°å™¨"><a href="#ç¨‹åºè®¡æ•°å™¨" class="headerlink" title="ç¨‹åºè®¡æ•°å™¨"></a>ç¨‹åºè®¡æ•°å™¨</h2><h3 id="ç¨‹åºè®¡æ•°å™¨ç›¸å…³æ¦‚å¿µ"><a href="#ç¨‹åºè®¡æ•°å™¨ç›¸å…³æ¦‚å¿µ" class="headerlink" title="ç¨‹åºè®¡æ•°å™¨ç›¸å…³æ¦‚å¿µ"></a>ç¨‹åºè®¡æ•°å™¨ç›¸å…³æ¦‚å¿µ</h3><ol>
<li>ç¨‹åºè®¡æ•°å™¨ä¸­çš„å¯„å­˜å™¨å¹¶éæ˜¯å¹¿ä¹‰ä¸Šæ‰€æŒ‡çš„ç‰©ç†å¯„å­˜å™¨ï¼ŒJVMä¸­çš„ç¨‹åºè®¡æ•°å™¨æ˜¯å¯¹ç‰©ç†å¯„å­˜å™¨çš„ä¸€ç§æŠ½è±¡æ¨¡æ‹Ÿ</li>
<li>JVMä¸­çš„ç¨‹åºè®¡æ•°å™¨è‹±æ–‡å…¨ç§°æ˜¯ Program Counter Register</li>
<li>ç¨‹åºè®¡æ•°å™¨æ—¢æ²¡æœ‰åƒåœ¾å›æ”¶ä¹Ÿæ²¡æœ‰å†…å­˜æº¢å‡º</li>
<li>å¦‚æœçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªJavaæ–¹æ³•ï¼Œè¿™ä¸ªè®¡æ•°å™¨è®°å½•çš„æ˜¯æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼›å¦‚æœæ­£åœ¨æ‰§è¡Œçš„æ˜¯æœ¬åœ°(Native)æ–¹æ³•ï¼Œè¿™ä¸ªè®¡æ•°å™¨å€¼åˆ™åº”ä¸ºç©º(Undefined)</li>
<li>æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç¨‹åºè®¡æ•°å™¨ï¼ˆç¨‹åºè®¡æ•°å™¨å’Œå¯„å­˜å™¨æ˜¯ä¸¤ä¸ªæ¦‚å¿µï¼‰</li>
</ol>
<h3 id="ä¸ºä»€ä¹ˆéœ€è¦ç¨‹åºè®¡æ•°å™¨"><a href="#ä¸ºä»€ä¹ˆéœ€è¦ç¨‹åºè®¡æ•°å™¨" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦ç¨‹åºè®¡æ•°å™¨"></a>ä¸ºä»€ä¹ˆéœ€è¦ç¨‹åºè®¡æ•°å™¨</h3><p>å› ä¸ºCPUéœ€è¦ä¸åœåœ°åˆ‡æ¢å„ä¸ªçº¿ç¨‹ï¼Œåˆ‡æ¢å›æ¥ä»¥åï¼Œå°±éœ€è¦çŸ¥é“æ¥ç€ä»å“ªé‡Œå¼€å§‹ç»§ç»­æ‰§è¡Œã€‚JVMçš„å­—èŠ‚ç è§£é‡Šå™¨é€šè¿‡æ”¹å˜ç¨‹åºè®¡æ•°å™¨çš„å€¼ï¼Œæ¥æ˜ç¡®ä¸‹ä¸€æ¡åº”è¯¥æ‰§è¡Œä»€ä¹ˆæ ·çš„å­—èŠ‚ç æŒ‡ä»¤</p>
<h2 id="è™šæ‹Ÿæœºæ ˆ"><a href="#è™šæ‹Ÿæœºæ ˆ" class="headerlink" title="è™šæ‹Ÿæœºæ ˆ"></a>è™šæ‹Ÿæœºæ ˆ</h2><ol>
<li>æ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ ˆï¼Œå…¶å†…éƒ¨ç”±è®¸å¤šæ ˆå¸§(Stack Frame)æ„æˆï¼Œæ¯ä¸ªæ ˆå¸§å¯¹åº”ç€ä¸€ä¸ªJavaæ–¹æ³•çš„è°ƒç”¨</li>
<li>æ¯ä¸ªæ–¹æ³•è¢«æ‰§è¡Œçš„æ—¶å€™ï¼ŒJVMéƒ½ä¼šåŒæ­¥åˆ›å»ºä¸€ä¸ªæ ˆå¸§ç”¨äºå­˜å‚¨<strong>å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£</strong>ç­‰ä¿¡æ¯</li>
</ol>
<h3 id="æ ˆå¸§-æ ˆçš„å­˜å‚¨å•ä½"><a href="#æ ˆå¸§-æ ˆçš„å­˜å‚¨å•ä½" class="headerlink" title="æ ˆå¸§-æ ˆçš„å­˜å‚¨å•ä½"></a>æ ˆå¸§-æ ˆçš„å­˜å‚¨å•ä½</h3><ol>
<li>æ¯ä¸ªçº¿ç¨‹ä¸Šæ­£åœ¨æ‰§è¡Œçš„æ¯ä¸ªæ–¹æ³•éƒ½å„è‡ªå¯¹åº”ä¸€ä¸ªæ ˆå¸§</li>
</ol>
<h3 id="æ ˆå¸§ä¸­å­˜å‚¨çš„å†…å®¹"><a href="#æ ˆå¸§ä¸­å­˜å‚¨çš„å†…å®¹" class="headerlink" title="æ ˆå¸§ä¸­å­˜å‚¨çš„å†…å®¹"></a>æ ˆå¸§ä¸­å­˜å‚¨çš„å†…å®¹</h3><pre class="mermaid">flowchart TB
  subgraph A[æ ˆ]
    subgraph B[æ ˆå¸§]
      direction LR
        B1[å±€éƒ¨å˜é‡è¡¨]
        B2[æ–¹æ³•è¿”å›å€¼]
        B3[æ“ä½œæ•°æ ˆ]
        B4[åŠ¨æ€é“¾æ¥]
        B5["é™„åŠ ä¿¡æ¯\næ¯”å¦‚å¯¹ç¨‹åºè°ƒè¯•ç›¸å…³ä¿¡æ¯"]
        B1~~~B2~~~B3~~~B4~~~B5
    end
    subgraph C[æ ˆå¸§]
      direction LR
        C1[å±€éƒ¨å˜é‡è¡¨]
        C2[æ–¹æ³•è¿”å›å€¼]
        C3[æ“ä½œæ•°æ ˆ]
        C4[åŠ¨æ€é“¾æ¥]
        C5["é™„åŠ ä¿¡æ¯\næ¯”å¦‚å¯¹ç¨‹åºè°ƒè¯•ç›¸å…³ä¿¡æ¯"]
        C1~~~C2~~~C3~~~C4~~~C5
    end
  end</pre>
<h4 id="å±€éƒ¨å˜é‡è¡¨"><a href="#å±€éƒ¨å˜é‡è¡¨" class="headerlink" title="å±€éƒ¨å˜é‡è¡¨"></a>å±€éƒ¨å˜é‡è¡¨</h4><ol>
<li>å±€éƒ¨å˜é‡è¡¨æ˜¯ä¸€ä¸ªæ•°ç»„</li>
<li>å±€éƒ¨å˜é‡è¡¨çš„ä½œç”¨æ˜¯å­˜å‚¨æ–¹æ³•å‚æ•°å’Œå®šä¹‰åœ¨æ–¹æ³•ä½“å†…çš„å±€éƒ¨å˜é‡<ol>
<li>å±€éƒ¨å˜é‡æ•°æ®ç±»å‹å¯ä»¥æ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå¯¹è±¡å¼•ç”¨(å­˜å‚¨çš„æ˜¯æŒ‡å‘å¯¹è±¡çš„å¼•ç”¨)</li>
</ol>
</li>
<li>å±€éƒ¨å˜é‡è¡¨çš„å¤§å°åœ¨ç¼–è¯‘å™¨ç¡®å®šï¼Œæ–¹æ³•è¿è¡ŒæœŸé—´ä¸ä¼šå¤§æ¦‚å±€éƒ¨å˜é‡è¡¨çš„å¤§å°</li>
</ol>
<h5 id="slot"><a href="#slot" class="headerlink" title="slot"></a>slot</h5><ol>
<li>å±€éƒ¨å˜é‡è¡¨è¾¾å­˜å‚¨å•å…ƒæ˜¯ <code>slot</code></li>
<li>32 ä½ä»¥å†…çš„ç±»å‹åªå ç”¨ä¸€ä¸ª <code>slot</code>ï¼Œ 64 ä½çš„ç±»å‹ï¼ˆ<code>long</code> å’Œ <code>double</code> ï¼‰å ç”¨ä¸¤ä¸ª <code>slot</code></li>
<li><code>byteï¼Œshortï¼Œchar</code> åœ¨å­˜å‚¨å‰ä¼šè¢«è½¬æ¢æˆ <code>int</code></li>
<li><code>JVM</code> ä¼šä¸ºå±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ª <code>slot</code> éƒ½åˆ†é…ä¸€ä¸ªè®¿é—®ç´¢å¼•ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å³å¯æˆåŠŸè®¿é—®åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­æŒ‡å®šçš„å±€éƒ¨å˜é‡å€¼</li>
</ol>
<h4 id="æ“ä½œæ•°æ ˆ"><a href="#æ“ä½œæ•°æ ˆ" class="headerlink" title="æ“ä½œæ•°æ ˆ"></a>æ“ä½œæ•°æ ˆ</h4><ol>
<li>æ“ä½œæ•°æ ˆä¸»è¦ç”¨äºä¿å­˜è®¡ç®—è¿‡ç¨‹çš„ä¸­é—´ç»“æœï¼ŒåŒæ—¶ä½œä¸ºè®¡ç®—è¿‡ç¨‹ä¸­å˜é‡ä¸´æ—¶çš„å­˜å‚¨ç©ºé—´</li>
<li>æ¯ä¸€ä¸ªæ“ä½œæ•°æ ˆéƒ½æ‹¥æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ ˆæ·±åº¦ç”¨äºå­˜å‚¨æ•°å€¼ï¼Œå…¶æ‰€éœ€çš„æœ€å¤§æ·±åº¦åœ¨ç¼–è¯‘æœŸå°±å®šä¹‰å¥½äº†ï¼Œä¿å­˜åœ¨æ–¹æ³•çš„ <code>Code</code> å±æ€§ä¸­çš„<code>Maximum stack size</code>æ•°æ®é¡¹ä¸­</li>
<li>æ“ä½œæ•°æ ˆåªèƒ½é€šè¿‡å…¥æ ˆ(<code>push</code>)å’Œå‡ºæ ˆ(<code>pop</code>)æ“ä½œæ¥å®Œæˆä¸€æ¬¡æ•°æ®è®¿é—®</li>
</ol>
<h4 id="åŠ¨æ€é“¾æ¥"><a href="#åŠ¨æ€é“¾æ¥" class="headerlink" title="åŠ¨æ€é“¾æ¥"></a>åŠ¨æ€é“¾æ¥</h4><ol>
<li>æ¯ä¸€ä¸ªæ ˆå¸§å†…éƒ¨éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­è¯¥æ ˆå¸§æ‰€å±æ–¹æ³•çš„å¼•ç”¨ã€‚åŒ…å«è¿™ä¸ªå¼•ç”¨çš„ç›®çš„å°±æ˜¯ä¸ºäº†æ”¯æŒå½“å‰æ–¹æ³•çš„ä»£ç èƒ½å¤Ÿå®ç°åŠ¨æ€é“¾æ¥</li>
<li>åŠ¨æ€é“¾æ¥çš„ç›®çš„æ˜¯åœ¨ <code>jvm</code> åŠ è½½äº†å­—èŠ‚ç æ–‡ä»¶ï¼Œå°†ç±»æ•°æ®åŠ è½½åˆ°å†…å­˜ä¹‹åï¼Œå¯ä»¥å°†å­—èŠ‚ç æ–‡ä»¶ä¸­è®°å½•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä½ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨</li>
</ol>
<h4 id="æ–¹æ³•è¿”å›åœ°å€"><a href="#æ–¹æ³•è¿”å›åœ°å€" class="headerlink" title="æ–¹æ³•è¿”å›åœ°å€"></a>æ–¹æ³•è¿”å›åœ°å€</h4><ol>
<li>æ–¹æ³•è¿”å›åœ°å€å­˜å‚¨çš„æ˜¯è°ƒç”¨è¯¥æ–¹æ³•çš„ç¨‹åºè®¡æ•°å™¨çš„å€¼</li>
<li>æ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œè°ƒç”¨è€…çš„ç¨‹åºè®¡æ•°å™¨çš„å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€</li>
<li>æ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œè°ƒç”¨è€…çš„ç¨‹åºè®¡æ•°å™¨çš„å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€</li>
</ol>
<h2 id="å †åŒº"><a href="#å †åŒº" class="headerlink" title="å †åŒº"></a>å †åŒº</h2><ol>
<li>å‰é¢è®²è§£çš„ <strong>æ ˆ</strong> è§£å†³çš„æ˜¯ç¨‹åºçš„è¿è¡Œé—®é¢˜ï¼Œå³ç¨‹åºæ˜¯å¦‚ä½•è¿è¡Œï¼Œå¦‚ä½•å¤„ç†æ•°æ®çš„ï¼Œä½†æ˜¯æ•°æ®ä»å“ªé‡Œæ¥å‘¢ï¼Ÿ è¿™å°±æ¶‰åŠåˆ°ä¸‹é¢è¦è®²çš„å †</li>
<li>å †æ˜¯å­˜å‚¨çš„å•ä½ï¼Œå †è§£å†³çš„æ˜¯æ•°æ®å­˜å‚¨çš„é—®é¢˜ï¼Œå³æ•°æ®æ€ä¹ˆæ”¾ã€æ”¾åœ¨å“ªå„¿</li>
</ol>
<h3 id="å †ç©ºé—´çš„åˆ’åˆ†"><a href="#å †ç©ºé—´çš„åˆ’åˆ†" class="headerlink" title="å †ç©ºé—´çš„åˆ’åˆ†"></a>å †ç©ºé—´çš„åˆ’åˆ†</h3><pre class="mermaid">flowchart LR
  subgraph A[å †]
    subgraph B[æ–°ç”Ÿä»£]
      B1["\nEden\n\n"]
      B2["\nfrom\n\n"]
      B3["\nto\n\n"]
      B1~~~B2~~~B3
    end
    subgraph C["\n\n\n &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspè€å¹´ä»£&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp\n\n\n\n"]
    end
  end</pre>

<ol>
<li>å †ç©ºé—´å¯ä»¥é€šè¿‡å‚æ•° <code>-Xms</code>(ä»£è¡¨å †æœ€å°å€¼) å’Œ <code>-Xmx</code> ï¼ˆä»£è¡¨å †ç©ºé—´æœ€å¤§å€¼ï¼‰æ¥è®¾ç½®</li>
<li>æ–°ç”Ÿä»£ä¸è€å¹´ä»£çš„ç©ºé—´æ¯”ä¾‹å¯ä»¥é€šè¿‡ <code>-XX:NewRatio=4</code> å‚æ•°æ¥è®¾ç½®ï¼Œè¿™ä¸ªæ¡ˆä¾‹ä»£è¡¨ï¼Œæ–°ç”Ÿä»£å æ¯”1ï¼Œè€å¹´ä»£å æ¯”4ï¼Œæ–°ç”Ÿä»£å æ•´ä¸ªå †çš„ 1&#x2F;5</li>
<li><code>Eden</code> åŒºå’Œä¸¤ä¸ª <code>Survivor</code> åŒºé»˜è®¤çš„æ¯”ä¾‹æ˜¯ 8:1:1, å¯ä»¥é€šè¿‡å‚æ•° <code>-XX:SurvivorRatio=8</code> æ¥æ˜¾ç¤ºè®¾ç½®æ¯”ä¾‹ï¼Œ å¦‚æœ <code>-XX:SurvivorRatio=5</code> ä»£è¡¨ <code>Eden</code> å’Œä¸¤ä¸ª <code>Survivor</code> åŒºå æ¯”ä¸º 5:1:1</li>
</ol>
<h3 id="å¯¹è±¡å†…å­˜åˆ†é…è¿‡ç¨‹"><a href="#å¯¹è±¡å†…å­˜åˆ†é…è¿‡ç¨‹" class="headerlink" title="å¯¹è±¡å†…å­˜åˆ†é…è¿‡ç¨‹"></a>å¯¹è±¡å†…å­˜åˆ†é…è¿‡ç¨‹</h3><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311232258657.png" alt="å¯¹è±¡å†…å­˜åˆ†é…è¿‡ç¨‹"></p>
<h3 id="TLAB"><a href="#TLAB" class="headerlink" title="TLAB"></a>TLAB</h3><ol>
<li>å †ä¸­è¿˜æœ‰ä¸€éƒ¨åˆ†åŒºåŸŸæ˜¯çº¿ç¨‹ç§æœ‰ï¼Œè¿™éƒ¨åˆ†åŒºåŸŸç§°ä¸ºçº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å­˜åŒº(<code>Thread Local Allocation Buffer,TLAB</code>)</li>
<li><code>TLAB</code> è¡¨ç¤º<code>JVM</code>ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ä¸ªç§æœ‰ç¼“å­˜åŒºåŸŸï¼Œè¿™å—ç¼“å­˜åŒºåŸŸåŒ…å«åœ¨<code>Eden</code>åŒºå†…</li>
<li>å¯ä»¥é€šè¿‡å‚æ•°  <code>-XX:+/-UseTLAB</code> æ¥è®¾ç½®æ˜¯å¦å¼€å¯ <code>TLAB</code> åŠŸèƒ½</li>
<li>å¯ä»¥é€šè¿‡å‚æ•° <code>-XX:TLABWasteTargetPercent</code> å¼€è®¾ç½® <code>TLAB</code> å ç”¨ <code>Eden</code> åŒºåŸŸçš„å¤§å°ï¼Œé»˜è®¤æ˜¯å ç”¨ 1%</li>
<li>å¯¹è±¡åœ¨<code>TLAB</code>ç©ºé—´åˆ†é…å†…å­˜å¤±è´¥æ—¶ï¼Œ<code>JVM</code>å°±ä¼šå°è¯•ç€é€šè¿‡ä½¿ç”¨åŠ é”æœºåˆ¶ç¡®ä¿æ•°æ®æ“ä½œçš„åŸå­æ€§ï¼Œä»è€Œç›´æ¥åœ¨<code>Eden</code>åŒºä¸­åˆ†é…å†…å­˜</li>
</ol>
<h4 id="ä½¿ç”¨-TLAB-çš„åŸå› "><a href="#ä½¿ç”¨-TLAB-çš„åŸå› " class="headerlink" title="ä½¿ç”¨ TLAB çš„åŸå› "></a>ä½¿ç”¨ TLAB çš„åŸå› </h4><ol>
<li>å †åŒºæ˜¯çº¿ç¨‹å…±äº«åŒºåŸŸï¼Œå¯¹è±¡å®ä¾‹çš„åˆ›å»ºåœ¨<code>JVM</code>ä¸­éå¸¸é¢‘ç¹ï¼Œå› æ­¤åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä»å †åŒºä¸­åˆ’åˆ†å†…å­˜ç©ºé—´æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„</li>
<li>é¿å…å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€åœ°å€ï¼Œå°±éœ€è¦ä½¿ç”¨åŠ é”ç­‰æœºåˆ¶ï¼Œä½†æ˜¯åŠ é”ä¼šå½±å“åˆ†é…é€Ÿåº¦</li>
</ol>
<h3 id="é€ƒé€¸åˆ†æ"><a href="#é€ƒé€¸åˆ†æ" class="headerlink" title="é€ƒé€¸åˆ†æ"></a>é€ƒé€¸åˆ†æ</h3><p>é€ƒé€¸åˆ†ææ˜¯æŒ‡ï¼šå½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­åˆ›å»ºåï¼Œè‹¥å¯¹è±¡åªæ˜¯åœ¨æ–¹æ³•å†…éƒ¨ä½¿ç”¨ï¼Œåˆ™è®¤ä¸ºå¯¹è±¡æ²¡æœ‰å‘ç”Ÿé€ƒé€¸ï¼Œè‹¥è¿™ä¸ªå¯¹è±¡è¢«æ–¹æ³•å¤–éƒ¨ä½¿ç”¨ï¼Œåˆ™è®¤ä¸ºå‘ç”Ÿäº†é€ƒé€¸</p>
<h4 id="é€ƒé€¸åˆ†æä¹‹åŒæ­¥çœç•¥"><a href="#é€ƒé€¸åˆ†æä¹‹åŒæ­¥çœç•¥" class="headerlink" title="é€ƒé€¸åˆ†æä¹‹åŒæ­¥çœç•¥"></a>é€ƒé€¸åˆ†æä¹‹åŒæ­¥çœç•¥</h4><p>é‡åˆ°åŒæ­¥ä»£ç å—æ—¶ï¼Œ<code>JIT</code>ç¼–è¯‘å™¨å¯ä»¥å€ŸåŠ©é€ƒé€¸åˆ†æï¼Œæ¥åˆ¤æ–­åŒæ­¥å—æ‰€ä½¿ç”¨çš„é”å¯¹è±¡æ˜¯å¦åªèƒ½å¤Ÿè¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®è€Œæ²¡æœ‰è¢«å‘å¸ƒåˆ°å…¶ä»–çº¿ç¨‹, å¦‚æœæ²¡æœ‰è¢«å‘å¸ƒåˆ°å…¶å®ƒçº¿ç¨‹ï¼Œ<code>JIT</code> ç¼–è¯‘å™¨åœ¨ç¼–è¯‘åŒæ­¥ä»£ç å—æ—¶ä¼šå–æ¶ˆå †è¿™éƒ¨åˆ†ä»£ç çš„åŒæ­¥</p>
<h4 id="é€ƒé€¸åˆ†æä¹‹æ ˆä¸Šåˆ†é…"><a href="#é€ƒé€¸åˆ†æä¹‹æ ˆä¸Šåˆ†é…" class="headerlink" title="é€ƒé€¸åˆ†æä¹‹æ ˆä¸Šåˆ†é…"></a>é€ƒé€¸åˆ†æä¹‹æ ˆä¸Šåˆ†é…</h4><p><code>JIT(Just In Time)</code>ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´æ ¹æ®é€ƒé€¸åˆ†æçš„ç»“æœï¼Œå‘ç°å¦‚æœä¸€ä¸ªå¯¹è±¡æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œå°±å¯èƒ½è¢«ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…</p>
<h4 id="é€ƒé€¸åˆ†æä¹‹æ ‡é‡æ›¿æ¢"><a href="#é€ƒé€¸åˆ†æä¹‹æ ‡é‡æ›¿æ¢" class="headerlink" title="é€ƒé€¸åˆ†æä¹‹æ ‡é‡æ›¿æ¢"></a>é€ƒé€¸åˆ†æä¹‹æ ‡é‡æ›¿æ¢</h4><p>æ ‡é‡<code>(Scalar)</code>æ˜¯æŒ‡ä¸€ä¸ªæ— æ³•å†åˆ†è§£æˆæ›´å°æ•°æ®çš„æ•°æ®ã€‚<code>Java</code>ä¸­çš„åŸå§‹æ•°æ®ç±»å‹å°±æ˜¯æ ‡é‡ã€‚ç›¸å¯¹çš„ï¼Œé‚£äº›è¿˜å¯ä»¥åˆ†è§£çš„æ•°æ®å«ä½œèšåˆé‡<code>(Aggregate)</code>ï¼Œ<code>Java</code>ä¸­çš„å¯¹è±¡å°±æ˜¯èšåˆé‡ï¼Œå› ä¸ºå®ƒå¯ä»¥åˆ†è§£æˆå…¶ä»–èšåˆé‡å’Œæ ‡é‡ã€‚åœ¨<code>JIT</code>ç¼–è¯‘å™¨çš„ç¼–è¯‘é˜¶æ®µï¼Œå¦‚æœç»è¿‡é€ƒé€¸åˆ†æï¼Œå‘ç°ä¸€ä¸ªå¯¹è±¡ä¸ä¼šè¢«å¤–ç•Œè®¿é—®çš„è¯ï¼Œé‚£ä¹ˆç»è¿‡<code>JIT</code>ä¼˜åŒ–ï¼Œå°±ä¼šæŠŠè¿™ä¸ªå¯¹è±¡æ‹†è§£æˆè‹¥å¹²ä¸ªæˆå‘˜å˜é‡ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ ‡é‡æ›¿æ¢</p>
<h1 id="æ–¹æ³•åŒº"><a href="#æ–¹æ³•åŒº" class="headerlink" title="æ–¹æ³•åŒº"></a>æ–¹æ³•åŒº</h1><h3 id="æ–¹æ³•åŒº-æ ˆå’Œå †ä¸‰è€…ä¹‹é—´çš„å…³ç³»"><a href="#æ–¹æ³•åŒº-æ ˆå’Œå †ä¸‰è€…ä¹‹é—´çš„å…³ç³»" class="headerlink" title="æ–¹æ³•åŒº, æ ˆå’Œå †ä¸‰è€…ä¹‹é—´çš„å…³ç³»"></a>æ–¹æ³•åŒº, æ ˆå’Œå †ä¸‰è€…ä¹‹é—´çš„å…³ç³»</h3><p>ä»¥ä¸‹é¢ä»£ç ä¸ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br></code></pre></td></tr></table></figure>
<ol>
<li><code>Student</code> è¿™ä¸ª <code>class</code> è¿è¡Œæ—¶ä¼šå­˜å‚¨åˆ°æ–¹æ³•åŒº</li>
<li><code>student</code> å¼•ç”¨å˜é‡ä¼šå­˜å‚¨åœ¨æ ˆåŒº</li>
<li><code>new Student()</code> å¯¹è±¡æ˜¯å­˜æ”¾åœ¨å †åŒº</li>
</ol>
<h3 id="jdk-ä¸­æ–¹æ³•åŒºçš„å˜åŒ–"><a href="#jdk-ä¸­æ–¹æ³•åŒºçš„å˜åŒ–" class="headerlink" title="jdk ä¸­æ–¹æ³•åŒºçš„å˜åŒ–"></a>jdk ä¸­æ–¹æ³•åŒºçš„å˜åŒ–</h3><ol>
<li>åœ¨ <code>jdk7</code> ä¹‹å‰ï¼Œå°†æ–¹æ³•åŒºç§°ä¸ºæ°¸ä¹…ä»£ï¼Œåœ¨ <code>jdk8</code> ä¸­ï¼Œæ–¹æ³•åŒºå˜æˆäº† <strong>å…ƒç©ºé—´</strong></li>
<li>æ°¸ä¹…ä»£åœ¨é€»è¾‘ä¸Šå±äºå †çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ç‰©ç†å­˜å‚¨ä¸Šä¸æ˜¯åœ¨å †ä¸­ï¼Œæ‰€ä»¥æ°¸ä¹…ä»£ä¹Ÿå«åš <strong>éå †</strong><ol>
<li>é€šè¿‡<code>-XX:PermSize</code>å‚æ•°è®¾ç½®æ°¸ä¹…ä»£åˆå§‹åˆ†é…ç©ºé—´</li>
<li>é€šè¿‡<code>-XX:MaxPermSize</code>å‚æ•°è®¾ç½®æ°¸ä¹…ä»£æœ€å¤§å¯åˆ†é…ç©ºé—´ã€‚32ä½æœºå™¨é»˜è®¤æ˜¯64MB,64ä½æœºå™¨æ¨¡å¼æ˜¯82MB</li>
<li>å½“ç©ºé—´ä¸è¶³æ—¶ä¼šå‡ºç° <code>java.lang.OutOfMemoryError:PermGen space</code></li>
</ol>
</li>
<li>å…ƒç©ºé—´æ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜å®ç°ï¼Œåªè¦ç‰©ç†å†…å­˜è¿˜æœ‰å®¹é‡ï¼Œå°±ä¸ä¼šæœ‰å†…å­˜æº¢å‡ºçš„é—®é¢˜<ol>
<li>å…ƒç©ºé—´å¤§å°å¯ä»¥ä½¿ç”¨å‚æ•°<code>-XX:MetaspaceSize</code>å’Œ<code>-XX:MaxMetaspaceSize</code>æŒ‡å®šï¼Œæ›¿ä»£<code>JDK7</code>ä¸­çš„æ°¸ä¹…ä»£çš„åˆå§‹å€¼å’Œæœ€å¤§å€¼</li>
<li>å½“ç©ºé—´ä¸è¶³æ—¶ä¼šå‡ºç° <code>java.lang.OutOfMemoryError:Metaspace</code></li>
</ol>
</li>
</ol>
<h3 id="æ–¹æ³•åŒºä¸­å­˜å‚¨çš„å†…å®¹"><a href="#æ–¹æ³•åŒºä¸­å­˜å‚¨çš„å†…å®¹" class="headerlink" title="æ–¹æ³•åŒºä¸­å­˜å‚¨çš„å†…å®¹"></a>æ–¹æ³•åŒºä¸­å­˜å‚¨çš„å†…å®¹</h3><ol>
<li><code>java</code> æºä»£ç ç¼–è¯‘ä¹‹åä¼šç”Ÿæˆ <code>class</code> æ–‡ä»¶ï¼Œç»è¿‡ç±»åŠ è½½å™¨æŠŠ <code>class</code> æ–‡ä»¶ä¸­å†…å®¹åŠ è½½åˆ° <code>jvm</code> è¿è¡Œæ—¶æ•°æ®åŒº</li>
<li><code>class</code> æ–‡ä»¶ä¸­çš„ä¸€éƒ¨åˆ†ä¿¡æ¯ä¼šåŠ è½½åˆ°æ–¹æ³•åŒºï¼Œä¸»è¦åŒ…å«çš„å†…å®¹å¦‚ä¸‹å›¾</li>
</ol>
<pre class="mermaid">flowchart TB
  subgraph A[æ–¹æ³•åŒºå­˜å‚¨çš„å†…å®¹]
    A1[ç±»å‹ä¿¡æ¯]
    A11["ç±»classï¼Œæ¥å£interface,æšä¸¾enmuï¼Œannotaion"]
    A1-->A11

    A2[è¿è¡Œæ—¶å¸¸é‡æ± ]
    A21["classæ–‡ä»¶ä¸­æœ‰ä¸ªconstant pool,\nå½“classæ–‡ä»¶è¢«åŠ è½½åˆ°å†…å­˜ä¹‹åï¼Œæ–¹æ³•åŒºä¹Ÿ\nä¼šå­˜æ”¾classæ–‡ä»¶çš„å¸¸é‡æ± ç›¸å…³ä¿¡æ¯ï¼Œ\næ­¤æ—¶classæ–‡ä»¶çš„å¸¸é‡æ± å°±å˜æˆäº†æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± "]
    A22["è¿è¡Œæ—¶å¸¸é‡æ± ç›¸å¯¹äºclassæ–‡ä»¶å¸¸é‡æ± çš„\nå¦å¤–ä¸€ä¸ªé‡è¦ç‰¹å¾æ˜¯å…·å¤‡åŠ¨æ€æ€§,\nè¿è¡ŒæœŸé—´ä¹Ÿå¯ä»¥å°†æ–°çš„å¸¸é‡ä½¿ç”¨intern()æ”¾å…¥æ± ä¸­"]
    A2-->A21 & A22

    A3[é™æ€å˜é‡]
    A31["jdk7ä¹‹å‰ç±»å˜é‡ä¹Ÿæ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†"]
    A32["jdk7åŠä»¥åç±»å˜é‡æ”¾åœ¨äº†å †ç©ºé—´"]
    A3-->A31 & A32

    A4[JITä»£ç ç¼“å­˜]

    A5[åŸŸä¿¡æ¯]
    A51["åŸŸç›¸å…³ä¿¡æ¯åŒ…å«åŸŸåç§°ï¼Œç±»å‹ï¼Œ\nåŸŸä¿®é¥°ç¬¦(publicï¼Œprivateï¼Œproteced,static,final,volatile)"]
    A5-->A51

    A6["æ–¹æ³•ä¿¡æ¯,åŒ…å«ä»¥ä¸‹å†…å®¹"]
    A61["æ–¹æ³•çš„è¿”å›ç±»å‹ï¼ˆæˆ–voidï¼‰"]
    A62["æ–¹æ³•å‚æ•°çš„æ•°é‡å’Œç±»å‹"]
    A63["æ–¹æ³•çš„ä¿®é¥°ç¬¦(publicï¼Œprivateç­‰)"]
    A64["æ–¹æ³•çš„å­—èŠ‚ç ï¼Œæ“ä½œæ•°æ ˆæ·±åº¦ï¼Œå±€éƒ¨å˜é‡è¡¨å¤§å°"]
    A65["å¼‚å¸¸è¡¨"]
    A6-->A61 & A62 & A63 & A64 & A65
  end</pre>

<p><a href="https://zhuanlan.zhihu.com/p/269134063">jdk7é™æ€å˜é‡å­˜æ”¾åœ¨å †ä¸­çš„å·¥å…·åˆ†æ</a></p>
<h3 id="ä¸åŒç‰ˆæœ¬jdkæ–¹æ³•åŒºçš„å†…å®¹"><a href="#ä¸åŒç‰ˆæœ¬jdkæ–¹æ³•åŒºçš„å†…å®¹" class="headerlink" title="ä¸åŒç‰ˆæœ¬jdkæ–¹æ³•åŒºçš„å†…å®¹"></a>ä¸åŒç‰ˆæœ¬jdkæ–¹æ³•åŒºçš„å†…å®¹</h3><h4 id="jdk6-æ–¹æ³•åŒº"><a href="#jdk6-æ–¹æ³•åŒº" class="headerlink" title="jdk6 æ–¹æ³•åŒº"></a>jdk6 æ–¹æ³•åŒº</h4><pre class="mermaid">flowchart LR
    subgraph A[æ–¹æ³•åŒºå’Œå †]
        subgraph A1["æ–¹æ³•åŒº(æ°¸ä¹…ä»£PermGenå®ç°)"]
            subgraph A11["è¿è¡Œæ—¶å¸¸é‡æ± "]
                A111["å­—ç¬¦ä¸²å¸¸é‡æ± "]
            end
            A12["ç±»å‹ä¿¡æ¯"]
            A13["åŸŸä¿¡æ¯"]
            A14["æ–¹æ³•ä¿¡æ¯"]
            A15["JITä»£ç ç¼“å­˜"]
            A16["é™æ€å˜é‡"]
            A11~~~A12~~~A13~~~A14~~~A15~~~A16
        end
        A2["\n\n\n &nbsp;&nbsp; å † &nbsp;&nbsp; \n\n\n"]
    end</pre>

<h4 id="jdk7-æ–¹æ³•åŒº"><a href="#jdk7-æ–¹æ³•åŒº" class="headerlink" title="jdk7 æ–¹æ³•åŒº"></a>jdk7 æ–¹æ³•åŒº</h4><pre class="mermaid">flowchart LR
    subgraph A[æ–¹æ³•åŒºå’Œå †]
        subgraph A1["æ–¹æ³•åŒº(æ°¸ä¹…ä»£PermGenå®ç°)"]
            A11["è¿è¡Œæ—¶å¸¸é‡æ± "]
            A12["ç±»å‹ä¿¡æ¯"]
            A13["åŸŸä¿¡æ¯"]
            A14["æ–¹æ³•ä¿¡æ¯"]
            A15["JITä»£ç ç¼“å­˜"]
            A11~~~A12~~~A13~~~A14~~~A15
        end
        subgraph A2["å †"]
            A21["å­—ç¬¦ä¸²å¸¸é‡æ± "]
            A22["é™æ€å˜é‡"]
            A21~~~A22
        end
    end</pre>
<h4 id="jdk8-æ–¹æ³•åŒº"><a href="#jdk8-æ–¹æ³•åŒº" class="headerlink" title="jdk8 æ–¹æ³•åŒº"></a>jdk8 æ–¹æ³•åŒº</h4><pre class="mermaid">flowchart LR
    subgraph A[æ–¹æ³•åŒºå’Œå †]
        subgraph A1["æ–¹æ³•åŒº(å…ƒç©ºé—´Metaspaceå®ç°)"]
            A11["è¿è¡Œæ—¶å¸¸é‡æ± "]
            A12["ç±»å‹ä¿¡æ¯"]
            A13["åŸŸä¿¡æ¯"]
            A14["æ–¹æ³•ä¿¡æ¯"]
            A15["JITä»£ç ç¼“å­˜"]
            A11~~~A12~~~A13~~~A14~~~A15
        end
        subgraph A2[å †]
            A21["æ–¹æ³•åŒº(é€»è¾‘ä¸Š\næ˜¯å †çš„ä¸€éƒ¨åˆ†ï¼Œ\nå®é™…ä¸åœ¨å †é‡Œé¢)"]
            subgraph A22[å®é™…å †]
                A221["é™æ€å˜é‡"]
                A222["å­—ç¬¦ä¸²å¸¸é‡æ± "]
            end
            A21~~~A22
        end
        A21-->A1
    end</pre>

<h3 id="æ–¹æ³•åŒºä¸­ä¸ºä»€ä¹ˆä½¿ç”¨å…ƒç©ºé—´æ›¿ä»£æ°¸ä¹…ä»£"><a href="#æ–¹æ³•åŒºä¸­ä¸ºä»€ä¹ˆä½¿ç”¨å…ƒç©ºé—´æ›¿ä»£æ°¸ä¹…ä»£" class="headerlink" title="æ–¹æ³•åŒºä¸­ä¸ºä»€ä¹ˆä½¿ç”¨å…ƒç©ºé—´æ›¿ä»£æ°¸ä¹…ä»£"></a>æ–¹æ³•åŒºä¸­ä¸ºä»€ä¹ˆä½¿ç”¨å…ƒç©ºé—´æ›¿ä»£æ°¸ä¹…ä»£</h3><ol>
<li><code>JRockit</code> è™šæ‹Ÿæœºå’Œ<code>HotSpot</code>è™šæ‹Ÿæœºjè¿›è¡Œèåˆï¼Œè€Œ<code>JRockit</code>ä¸éœ€è¦é…ç½®æ°¸ä¹…ä»£</li>
<li>ä¸ºæ°¸ä¹…ä»£è®¾ç½®ç©ºé—´å¤§å°æ˜¯å¾ˆéš¾ç¡®å®šçš„,å¦‚æœåŠ¨æ€åŠ è½½ç±»è¿‡å¤šï¼Œå®¹æ˜“äº§ç”Ÿæ°¸ä¹…ä»£çš„<code>OOM</code></li>
<li>å…ƒç©ºé—´å’Œæ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶</li>
<li><code>JDK7</code>ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œ<code>HotSpot</code>è™šæ‹Ÿæœºå°†ç±»å‹ä¿¡æ¯ã€å†…éƒ¨å­—ç¬¦ä¸²å’Œç±»é™æ€å˜é‡å­˜å‚¨åœ¨æ°¸ä¹…ä»£ä¸­ï¼Œåƒåœ¾æ”¶é›†å™¨ä¹Ÿä¼šå¯¹è¯¥åŒºåŸŸè¿›è¡Œåƒåœ¾å›æ”¶ã€‚<code>JDK7</code>å°†<code>HotSpot</code>è™šæ‹Ÿæœºä¸­æ°¸ä¹…ä»£å†…éƒ¨å­—ç¬¦ä¸²å’Œç±»é™æ€å˜é‡æ•°æ®ç§»åŠ¨åˆ°<code>Java</code>å †ä¸­ï¼Œä½†æ˜¯ä¾ç„¶å­˜åœ¨æ°¸ä¹…ä»£,å°†å…ƒæ•°æ®ä»æ°¸ä¹…ä»£å‰¥ç¦»å‡ºæ¥æ”¾åˆ°å…ƒç©ºé—´ä¸­ï¼Œä¸ä»…å®ç°äº†å¯¹å…ƒæ•°æ®çš„æ— ç¼ç®¡ç†ï¼Œè€Œä¸”å› ä¸ºå…ƒç©ºé—´å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶ï¼Œä¹Ÿç®€åŒ–äº†<code>Full GC</code>ï¼Œå¹¶ä¸”å¯ä»¥åœ¨<code>GC</code>ä¸æš‚åœçš„æƒ…å†µä¸‹å¹¶å‘åœ°é‡Šæ”¾å…ƒæ•°æ®</li>
</ol>
<h3 id="æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶"><a href="#æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶" class="headerlink" title="æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶"></a>æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶</h3><p>æ–¹æ³•åŒºä¸»è¦å›æ”¶ä¸¤éƒ¨åˆ†å†…å®¹</p>
<ol>
<li>å¸¸é‡æ± ä¸­åºŸå¼ƒçš„å¸¸é‡<ol>
<li>å¸¸é‡æ± ä¸­çš„å­—é¢é‡ï¼šæ¯”å¦‚æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œè¢«å£°æ˜ä¸º <code>final</code>çš„å¸¸é‡å€¼ç­‰</li>
<li>ç¬¦å·å¼•ç”¨ï¼šç±»å’Œæ¥å£çš„å…¨é™å®šåï¼Œå­—æ®µçš„åç§°å’Œæè¿°ç¬¦ï¼Œæ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦</li>
</ol>
</li>
<li>ä¸å†ä½¿ç”¨çš„ç±»å‹ä¿¡æ¯</li>
</ol>
<p>å¸¸é‡æ± ä¸­åˆ¤æ–­å­—é¢é‡æ˜¯å¦ä¸å†ä½¿ç”¨ç®€å•ä¸€äº›ï¼Œä½†æ˜¯åˆ¤æ–­ä¸€ä¸ªç±»å‹æ˜¯å¦å±äºä¸å†è¢«ä½¿ç”¨çš„ç±»ï¼Œåˆ™éœ€è¦æ»¡è¶³ä¸‹é¢çš„æ¡ä»¶</p>
<ol>
<li>è¯¥ç±»çš„æ‰€æœ‰ç¤ºä¾‹éƒ½å·²ç»è¢«å›æ”¶</li>
<li>åŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨å·²ç»è¢«å›æ”¶</li>
<li>è¯¥ç±»çš„ <code>java.lang.Class</code> å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨</li>
</ol>
<p><strong>æ»¡è¶³äº†ä¸Šé¢çš„æ¡ä»¶åªæ˜¯ä»£è¡¨å¯ä»¥ä¼šå›æ”¶ï¼Œå¹¶ä¸æ˜¯ä¸€å®šä¼šè¢«å›æ”¶</strong></p>
]]></content>
      <categories>
        <category>java</category>
        <category>jvm</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>è‡ªå®šä¹‰ç±»åŠ è½½å™¨</title>
    <url>/2024/0ca6653854a6/index.html</url>
    <content><![CDATA[<blockquote>
<p>jdkç‰ˆæœ¬ï¼š 17</p>
</blockquote>
<h2 id="è‡ªå®šä¹‰ç±»åŠ è½½å™¨"><a href="#è‡ªå®šä¹‰ç±»åŠ è½½å™¨" class="headerlink" title="è‡ªå®šä¹‰ç±»åŠ è½½å™¨"></a>è‡ªå®šä¹‰ç±»åŠ è½½å™¨</h2><p>è‡ªå®šä¹‰ç±»åŠ è½½å™¨éœ€è¦ç»§æ‰¿ <code>ClassLoader</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br><br>    <span class="hljs-comment">// é‡å†™ findClass ç±»ï¼Œ å‚æ•° name æ˜¯ç±»çš„å…¨é™å®šç±»å</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <span class="hljs-type">byte</span>[] data;<br>        <span class="hljs-keyword">try</span> &#123;<br>            data = findClassData(name);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.defineClass(name, data, <span class="hljs-number">0</span>, data.length);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] findClassData(String name) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// éœ€è¦æ ¹æ® name æ‰¾åˆ°å¯¹åº”çš„ class æ–‡ä»¶ï¼Œè¿™é‡Œçœç•¥äº†ï¼Œç›´æ¥åŠ è½½å¯¹åº”çš„ class æ–‡ä»¶</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;D:\\logs\\TestOne.class&quot;</span>);<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file);<br>        <span class="hljs-keyword">return</span> inputStream.readAllBytes();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="ç¼–å†™éœ€è¦è¢«åŠ è½½çš„ç±»"><a href="#ç¼–å†™éœ€è¦è¢«åŠ è½½çš„ç±»" class="headerlink" title="ç¼–å†™éœ€è¦è¢«åŠ è½½çš„ç±»"></a>ç¼–å†™éœ€è¦è¢«åŠ è½½çš„ç±»</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestOne</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testOne</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;test one&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="ç¼–å†™æµ‹è¯•ç±»"><a href="#ç¼–å†™æµ‹è¯•ç±»" class="headerlink" title="ç¼–å†™æµ‹è¯•ç±»"></a>ç¼–å†™æµ‹è¯•ç±»</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">CusClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CusClassLoader</span>();<br>        Class&lt;?&gt; aClass = classLoader.loadClass(<span class="hljs-string">&quot;com.example.TestOne&quot;</span>);<br>        System.out.println(aClass.getClassLoader());<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> aClass.getMethod(<span class="hljs-string">&quot;testOne&quot;</span>);<br>        method.invoke(aClass.newInstance());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">com.example.CusClassLoader@6576fe71<br>test one<br></code></pre></td></tr></table></figure>

<h2 id="é‡å†™-findClass-è¿˜æ˜¯-loadClass"><a href="#é‡å†™-findClass-è¿˜æ˜¯-loadClass" class="headerlink" title="é‡å†™ findClass è¿˜æ˜¯ loadClass"></a>é‡å†™ findClass è¿˜æ˜¯ loadClass</h2><p>è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶éœ€è¦ç»§æ‰¿ <code>ClassLoader</code> ç±»ï¼Œä½†æ˜¯å…·ä½“å¯é‡å†™çš„æ–¹æ³•åŒ…å« <code>findClass</code> å’Œ <code>loadClass</code>ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åªéœ€è¦é‡å†™ <code>findClass</code> å³å¯ï¼Œå› ä¸ºåŒäº²å§”æ´¾çš„é€»è¾‘æ˜¯åœ¨ <code>loadClass</code> ä¸­å®Œæˆï¼Œæ‰€ä»¥ä¸æƒ³ç ´ååŒäº²å§”æ´¾æ—¶å°±ç›´æ¥é‡å†™ <code>findClass</code> å³å¯</p>
]]></content>
      <categories>
        <category>java</category>
        <category>jvm</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatisæ‰§è¡Œæµç¨‹å’Œæ ¸å¿ƒç»„ä»¶</title>
    <url>/2023/08bb8954abe7/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<blockquote>
<p>Mybatisç‰ˆæœ¬ï¼š 3.5.15<br>å‚è€ƒä¹¦ç±ï¼š ã€ŠMybatis3æºç æ·±åº¦è§£æã€‹</p>
</blockquote>
<h2 id="Mybatisæ ¸å¿ƒç»„ä»¶"><a href="#Mybatisæ ¸å¿ƒç»„ä»¶" class="headerlink" title="Mybatisæ ¸å¿ƒç»„ä»¶"></a>Mybatisæ ¸å¿ƒç»„ä»¶</h2><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202312262105691.webp" alt="Mybatisæ ¸å¿ƒç»„ä»¶"></p>
<p><strong>ç»„ä»¶è¯´æ˜</strong></p>
<ul>
<li><code>Configuration</code>: ç”¨äºæè¿° <code>MyBatis</code> çš„ä¸»é…ç½®ä¿¡æ¯ï¼Œå…¶ä»–ç»„ä»¶éœ€è¦è·å–é…ç½®ä¿¡æ¯æ—¶ï¼Œç›´æ¥é€šè¿‡<code>Configuration</code> å¯¹è±¡è·å–<ul>
<li><code>Mybatis</code> åœ¨å¯åŠ¨æ—¶ï¼Œå°† <code>Mapper</code> é…ç½®ä¿¡æ¯ã€ç±»å‹åˆ«åã€<code>TypeHandler</code> ç­‰æ³¨å†Œåˆ°<code>Configuration</code> ç»„ä»¶ä¸­ï¼Œå…¶ä»–ç»„ä»¶éœ€è¦è¿™äº›ä¿¡æ¯æ—¶ï¼Œä¹Ÿå¯ä»¥ä» <code>Configuration</code> å¯¹è±¡ä¸­è·å–</li>
</ul>
</li>
<li><code>MappedStatement</code>ï¼š <code>MappedStatement</code> ç”¨äºæè¿° <code>Mapper</code> ä¸­çš„ <code>SQL</code> é…ç½®ä¿¡æ¯ï¼Œæ˜¯å¯¹<code>Mapper XML</code> é…ç½®æ–‡ä»¶ä¸­ <code>&lt;select|update|delete|insert&gt;</code> ç­‰æ ‡ç­¾æˆ–è€… <code>@Select/@Update</code> ç­‰æ³¨è§£é…ç½®ä¿¡æ¯çš„å°è£…</li>
<li><code>SqlSession</code>ï¼š <code>SqlSession</code> æ˜¯æä¾›ç»™ç”¨æˆ·æ“ä½œçš„ <code>API</code>, è¡¨ç¤ºå’Œæ•°æ®åº“äº¤äº’æ—¶çš„ä¼šè¯å¯¹è±¡</li>
<li><code>Executor</code>: <code>Executor</code> æ˜¯ <code>MyBatis</code> çš„ <code>SQL</code> æ‰§è¡Œå™¨ï¼Œ<code>MyBatis</code> ä¸­å¯¹æ•°æ®åº“æ‰€æœ‰çš„å¢åˆ æ”¹æŸ¥æ“ä½œéƒ½æ˜¯ç”± <code>Executor</code> ç»„ä»¶å®Œæˆçš„</li>
<li><code>StatementHandler</code>: <code>StatementHandler</code> å°è£…äº†å¯¹ <code>JDBC Statement</code> å¯¹è±¡çš„æ“ä½œ</li>
<li><code>ParameterHandler</code>: å½“ <code>MyBatis</code> æ¡†æ¶ä½¿ç”¨çš„ <code>Statement</code> ç±»å‹ä¸º <code>CallableStatement</code> å’Œ<code>PreparedStatement</code>æ—¶ï¼Œ<code>ParameterHandler</code> ç”¨äºä¸º <code>Statement</code> å¯¹è±¡å‚æ•°å ä½ç¬¦è®¾ç½®å€¼</li>
<li><code>ResultSetHandler</code>: <code>ResultSetHandler</code>å°è£…äº†å¯¹ <code>JDBC</code> ä¸­çš„ <code>ResultSet</code> å¯¹è±¡æ“ä½œ</li>
<li><code>TypeHandler</code>: <code>TypeHandler</code> æ˜¯ <code>MyBatis</code> ä¸­çš„ç±»å‹å¤„ç†å™¨ï¼Œç”¨äºå¤„ç† <code>Java</code> ç±»å‹ä¸ <code>JDBC</code> ç±»å‹ä¹‹é—´çš„æ˜ å°„</li>
</ul>
<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><p><strong>ä½œç”¨1ï¼šä½œä¸ºä¸»é…ç½®æ–‡ä»¶çš„æ‰¿è½½</strong></p>
<blockquote>
<p>MyBatis æ¡†æ¶çš„é…ç½®ä¿¡æ¯æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯é…ç½® MyBatis æ¡†æ¶å±æ€§çš„ä¸»é…ç½®æ–‡ä»¶ï¼›<br>å¦ä¸€ç§æ˜¯é…ç½®æ‰§è¡Œ SQLè¯­å¥çš„ Mapper é…ç½®æ–‡ä»¶ã€‚<br>Configuration çš„ä½œç”¨æ˜¯æè¿° MyBatis ä¸»é…ç½®æ–‡ä»¶çš„ä¿¡æ¯</p>
</blockquote>
<p>å¯ä»¥çœ‹ <code>Configuration</code> ç±»ä¸­ç›¸å…³å±æ€§</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> Environment environment;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> safeRowBoundsEnabled;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">safeResultHandlerEnabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> mapUnderscoreToCamelCase;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> aggressiveLazyLoading;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">multipleResultSetsEnabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> useGeneratedKeys;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">useColumnLabel</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">cacheEnabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> callSettersOnNulls;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">useActualParamName</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> returnInstanceForEmptyRow;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> shrinkWhitespacesInSql;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> nullableOnForEach;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> argNameBasedConstructorAutoMapping;<br>    â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure>
<p>è¿™ä¸ªé…ç½®æ–‡ä»¶æœ‰å¾ˆå¤šé…ç½®ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ <a href="https://mybatis.net.cn/configuration.html">Mybatisä¸»é…ç½®æ–‡ä»¶</a></p>
<p><strong>ä½œç”¨2ï¼šä½œä¸ºå®¹å™¨å­˜å‚¨TypeHandler,TypeAlias,Mapperæ¥å£ä¿¡æ¯</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span> &#123;<br>    <span class="hljs-comment">// ç”¨äºæ³¨å†ŒMapperæ¥å£ä¿¡æ¯ï¼Œå»ºç«‹Mapperæ¥å£çš„Classå¯¹è±¡å’ŒMapperProxyFactory</span><br>    <span class="hljs-comment">// å¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼Œå…¶ä¸­MapperProxyFactoryå¯¹è±¡ç”¨äºåˆ›å»ºMapperåŠ¨æ€ä»£ç†å¯¹è±¡</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MapperRegistry</span> <span class="hljs-variable">mapperRegistry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperRegistry</span>(<span class="hljs-built_in">this</span>);<br><br>    <span class="hljs-comment">// ç”¨äºæ³¨å†ŒMyBatisæ’ä»¶ä¿¡æ¯ï¼ŒMyBatisæ’ä»¶å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæ‹¦æˆªå™¨</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">InterceptorChain</span> <span class="hljs-variable">interceptorChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterceptorChain</span>();<br><br>    <span class="hljs-comment">// ç”¨äºæ³¨å†Œæ‰€æœ‰çš„TypeHandlerï¼Œå¹¶å»ºç«‹Jdbcç±»å‹ã€JDBCç±»å‹ä¸TypeHandlerä¹‹é—´çš„å¯¹åº”å…³ç³»</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">TypeHandlerRegistry</span> <span class="hljs-variable">typeHandlerRegistry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeHandlerRegistry</span>(<span class="hljs-built_in">this</span>);<br><br>    <span class="hljs-comment">// ç”¨äºæ³¨å†Œæ‰€æœ‰çš„ç±»å‹åˆ«å</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">TypeAliasRegistry</span> <span class="hljs-variable">typeAliasRegistry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeAliasRegistry</span>();<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">LanguageDriverRegistry</span> <span class="hljs-variable">languageRegistry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LanguageDriverRegistry</span>();<br><br>    <span class="hljs-comment">// MyBatiså°†æ‰€æœ‰çš„MappedStatementå¯¹è±¡æ³¨å†Œåˆ°è¯¥å±æ€§ä¸­ï¼Œ</span><br>    <span class="hljs-comment">// å…¶ä¸­Keyä¸ºMapperçš„Idï¼ŒValueä¸ºMappedStatementå¯¹è±¡</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, MappedStatement&gt; mappedStatements = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMap</span>&lt;MappedStatement&gt;(<br>        <span class="hljs-string">&quot;Mapped Statements collection&quot;</span>)<br>        .conflictMessageProducer((savedValue, targetValue) -&gt; <span class="hljs-string">&quot;. please check &quot;</span> + savedValue.getResource() + <span class="hljs-string">&quot; and &quot;</span><br>            + targetValue.getResource());<br>    â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>ä½œç”¨3ï¼šä½œä¸ºExecutorï¼ŒStatementhandlerï¼ŒResultSetHandler,ParameterHandlerç»„ä»¶çš„å·¥å‚ç±»</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span> &#123;<br>    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">newExecutor</span><span class="hljs-params">(Transaction transaction)</span> &#123;<br>        <span class="hljs-keyword">return</span> newExecutor(transaction, defaultExecutorType);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ParameterHandler <span class="hljs-title function_">newParameterHandler</span><span class="hljs-params">(MappedStatement mappedStatement, Object parameterObject,</span><br><span class="hljs-params">        BoundSql boundSql)</span> &#123;<br>        <span class="hljs-type">ParameterHandler</span> <span class="hljs-variable">parameterHandler</span> <span class="hljs-operator">=</span> mappedStatement.getLang().<br>        createParameterHandler(mappedStatement, parameterObject, boundSql);<br>        <span class="hljs-keyword">return</span> (ParameterHandler) interceptorChain.pluginAll(parameterHandler);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ResultSetHandler <span class="hljs-title function_">newResultSetHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, RowBounds rowBounds,</span><br><span class="hljs-params">        ParameterHandler parameterHandler, </span><br><span class="hljs-params">        ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br>        <span class="hljs-type">ResultSetHandler</span> <span class="hljs-variable">resultSetHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResultSetHandler</span>(executor, mappedStatement, parameterHandler,<br>            resultHandler, boundSql, rowBounds);<br>        <span class="hljs-keyword">return</span> (ResultSetHandler) interceptorChain.pluginAll(resultSetHandler);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> StatementHandler <span class="hljs-title function_">newStatementHandler</span><span class="hljs-params">(Executor executor, </span><br><span class="hljs-params">        MappedStatement mappedStatement,</span><br><span class="hljs-params">        Object parameterObject, RowBounds rowBounds, </span><br><span class="hljs-params">        ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br>        <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">statementHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RoutingStatementHandler</span>(executor, mappedStatement, parameterObject,<br>            rowBounds, resultHandler, boundSql);<br>        <span class="hljs-keyword">return</span> (StatementHandler) interceptorChain.pluginAll(statementHandler);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ä¸ºä»€ä¹ˆè¦é€šè¿‡-Configuration-æ¥åˆ›å»º-Executorç­‰ç»„ä»¶"><a href="#ä¸ºä»€ä¹ˆè¦é€šè¿‡-Configuration-æ¥åˆ›å»º-Executorç­‰ç»„ä»¶" class="headerlink" title="ä¸ºä»€ä¹ˆè¦é€šè¿‡ Configuration æ¥åˆ›å»º Executorç­‰ç»„ä»¶"></a>ä¸ºä»€ä¹ˆè¦é€šè¿‡ Configuration æ¥åˆ›å»º Executorç­‰ç»„ä»¶</h3><p>ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªåŸå› </p>
<ol>
<li><code>Mybatis</code> çš„é…ç½®æœ€ç»ˆéƒ½ä¿å­˜åœ¨ <code>Configuration</code> ä¸­ï¼Œè€Œåˆ›å»º <code>Executor</code>, <code>ParameterHandler</code> ç­‰ç»„ä»¶çš„åˆ›å»ºéƒ½éœ€è¦ç”¨åˆ°é…ç½®(ä¸åŒé…ç½®åˆ›å»ºçš„å¯¹åº”å®ç°ç±»å¯èƒ½å°±ä¸åŒ)</li>
<li><code>Mybatis</code> çš„æ’ä»¶æœºåˆ¶å°±æ˜¯ä½œç”¨åœ¨ <code>Executor</code> ç­‰ç»„ä»¶ä¸Šï¼Œæ‰€ä»¥ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»º <code>Executor</code>, <code>StatementHandler</code>,<code>ResultSetHandler</code>,<code>ParameterHandler</code> ç»„ä»¶å°±æ¯”è¾ƒæ–¹ä¾¿å®ç°æ‹¦æˆªé€»è¾‘</li>
</ol>
<h3 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h3><ul>
<li><code>SqlSession</code> æ˜¯ <code>MyBatis</code> æä¾›çš„æ“ä½œæ•°æ®åº“çš„ <code>API</code>ï¼Œä½†æ˜¯çœŸæ­£æ‰§è¡Œ <code>SQL</code> çš„æ˜¯ <code>Executor</code> ç»„ä»¶</li>
<li><code>Executor</code> æ¥å£ä¸­å®šä¹‰äº†å¯¹æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥æ–¹æ³•<ul>
<li><code>query()</code> å’Œ <code>queryCursor()</code> ç”¨äºæŸ¥è¯¢</li>
<li><code>update()</code> ç”¨äºæ–°å¢ï¼Œåˆ é™¤ï¼Œä¿®æ”¹</li>
</ul>
</li>
</ul>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202312262155346.webp?imageSlim" alt="Executortç»§æ‰¿å…³ç³»"></p>
<ul>
<li><code>BaseExecutor</code> å®šä¹‰æ–¹æ³•çš„æ‰§è¡Œæµç¨‹å’Œé€šç”¨çš„å¤„ç†é€»è¾‘(æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„è¿ç”¨)</li>
<li><code>SimpleExecutor</code> æ˜¯åŸºç¡€çš„ <code>Executor</code>ï¼Œèƒ½å¤Ÿå®ŒæˆåŸºæœ¬çš„å¢åˆ æ”¹æŸ¥æ“ä½œ</li>
<li><code>ResueExecutor</code> å¯¹ <code>JDBC</code> ä¸­çš„ <code>Statement</code> å¯¹è±¡åšäº†ç¼“å­˜ï¼Œå½“æ‰§è¡Œç›¸åŒçš„ <code>SQL</code> è¯­å¥æ—¶ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­å–å‡º <code>Statement</code> å¯¹è±¡è¿›è¡Œå¤ç”¨</li>
<li><code>BatchExecutor</code> åˆ™ä¼šå¯¹è°ƒç”¨åŒä¸€ä¸ª <code>Mapper</code> æ‰§è¡Œçš„ <code>updateã€insert</code> å’Œ <code>delete</code> æ“ä½œï¼Œè°ƒç”¨<code>Statement</code> å¯¹è±¡çš„æ‰¹é‡æ“ä½œåŠŸèƒ½</li>
<li>å½“ <code>MyBatis</code> å¼€å¯äº†äºŒçº§ç¼“å­˜åŠŸèƒ½æ—¶ï¼Œä¼šä½¿ç”¨ <code>CachingExecutor</code> å¯¹ <code>SimpleExecutor</code>ã€<code>ResueExecutor</code>ã€<code>BatchExecutor</code>è¿›è¡Œè£…é¥°ï¼ˆè£…é¥°å™¨æ¨¡å¼çš„ä½¿ç”¨ï¼‰</li>
</ul>
<h3 id="MappedStatement"><a href="#MappedStatement" class="headerlink" title="MappedStatement"></a>MappedStatement</h3><p><code>MyBatis</code> é€šè¿‡ <code>MappedStatement</code> æè¿° <code>&lt;select|update|insert|delete&gt;</code> æˆ–è€… <code>@Selectã€@Update</code> ç­‰æ³¨è§£é…ç½®çš„ <code>SQL</code> ä¿¡æ¯</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ª <code>Mapper</code> é…ç½®æ–‡ä»¶çš„ç¤ºä¾‹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;org.example.mapper.StudentMapper&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectById&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;org.example.vo.Student&quot;</span>&gt;</span><br>        select * from student where id = #&#123;id&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>æ¯ä¸€ä¸ªæ ‡ç­¾éƒ½æœ‰å¾ˆå¤šçš„å±æ€§å¯ä»¥è¿›è¡Œé…ç½®ï¼Œå…·ä½“çš„å¯ä»¥å‚è€ƒ <a href="https://mybatis.net.cn/sqlmap-xml.html">Mybatisä¸­xmlæ˜ å°„å™¨æ–‡ä»¶çš„é…ç½®</a></p>
<h3 id="TypeHandler"><a href="#TypeHandler" class="headerlink" title="TypeHandler"></a>TypeHandler</h3>


]]></content>
      <categories>
        <category>java</category>
        <category>Mybatis</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatisæ•´åˆSpringBootä¸­MapperScanæ³¨è§£çš„åŸç†åˆ†æ</title>
    <url>/2023/c801a695ec29/index.html</url>
    <content><![CDATA[<blockquote>
<p>SpringBootç‰ˆæœ¬: 3.1.7<br>mybatis-spring-boot-starterç‰ˆæœ¬: 3.0.2<br>JDKç‰ˆæœ¬: 17</p>
</blockquote>
<p>å•ç‹¬ä½¿ç”¨ <code>Mybatis</code> æ—¶æ ¸å¿ƒå…¥å£æ˜¯ç”Ÿæˆçš„ <code>Mapper</code> ä»£ç†ç±»ï¼Œå¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/5cc9f93ce77a/index.html" title="Mybatisè·å–Mapperä»£ç†å¯¹è±¡çš„è¿‡ç¨‹åˆ†æ">Mybatisè·å–Mapperä»£ç†å¯¹è±¡çš„è¿‡ç¨‹åˆ†æ</a></li></ol>

<p><code>Spring</code> ç”Ÿæˆ <code>Bean</code> çš„ä¸¤å¤§æ ¸å¿ƒæ­¥éª¤æ˜¯</p>
<ol>
<li>å°†ç±»å˜æˆ <code>BeanDefinition</code>, ç„¶åæ³¨å†Œåˆ° <code>DefaultListableBeanFactory</code> ç±»çš„ <code>beanDefinitionMap</code> ä¸­<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultListableBeanFactory</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">256</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>å°† <code>BeanDefinition</code> å˜æˆçœŸæ­£çš„ <code>Bean</code>, å¹¶ä¸”æ³¨å†Œåˆ° <code>DefaultListableBeanFactory</code> ç±»çš„ <code>singletonObjects</code><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultListableBeanFactory</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">256</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<p><code>Mybatis</code> å’Œ <code>Spring</code> æ•´åˆè‡ªç„¶æ˜¯éœ€è¦å°† <code>Mybatis</code> ä¸­ä¸€äº›å…³é”®çš„ç±»äº¤ç»™ <code>Spring</code> ç®¡ç†ï¼Œè¿™é‡Œä¸»è¦è®²è§£ <code>MapperScan</code> æ³¨è§£ï¼Œä¹Ÿå°±æ˜¯ <code>Mapper</code> çš„ä»£ç†ç±»äº¤ç»™ <code>Spring</code> ç®¡ç†çš„è¿‡ç¨‹ã€‚</p>
<h2 id="Spring-æ‰«æ-Mapperæ¥å£æ³¨å†Œä¸º-BeanDefinition"><a href="#Spring-æ‰«æ-Mapperæ¥å£æ³¨å†Œä¸º-BeanDefinition" class="headerlink" title="Spring æ‰«æ Mapperæ¥å£æ³¨å†Œä¸º BeanDefinition"></a>Spring æ‰«æ Mapperæ¥å£æ³¨å†Œä¸º BeanDefinition</h2><p>è¿™ä¸ªè¿‡ç¨‹éœ€è¦å…ˆçœ‹ä¸€ä¸‹ <code>MapperScan</code> æ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Import(MapperScannerRegistrar.class)</span><br><span class="hljs-meta">@Repeatable(MapperScans.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> MapperScan &#123;<br>    <span class="hljs-comment">// çœç•¥ä»£ç â€¦â€¦</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ° <code>MapperScan</code> ä¸­æœ‰ <code>Import</code> <code>MapperScannerRegistrar</code> è¿™ä¸ªç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperScannerRegistrar</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportBeanDefinitionRegistrar</span>, ResourceLoaderAware &#123;<br>    <span class="hljs-comment">// çœç•¥ä»£ç â€¦â€¦</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="å¯¼å…¥ImportBeanDefinitionRegistrarå®ç°ç±»MapperScannerRegistrar"><a href="#å¯¼å…¥ImportBeanDefinitionRegistrarå®ç°ç±»MapperScannerRegistrar" class="headerlink" title="å¯¼å…¥ImportBeanDefinitionRegistrarå®ç°ç±»MapperScannerRegistrar"></a>å¯¼å…¥ImportBeanDefinitionRegistrarå®ç°ç±»MapperScannerRegistrar</h3><p>åœ¨è§£æ <code>SpringBoot</code> ä¸»ç±»çš„æ—¶å€™ï¼Œä¼šå»æ‰¾ä¸»ç±»ä¸Šæ˜¯å¦æœ‰æ³¨è§£å¼•å…¥äº† <code>ImportBeanDefinitionRegistrar</code> çš„å®ç°ç±»ï¼Œå…ˆçœ‹ä¸€ä¸‹ä¸»ç±»ä»£ç ï¼Œå®Œæ•´çš„ <code>Mybatis</code> æ•´åˆ <code>SpringBoot</code> ä»£ç å¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/c7647f7aa552/index.html" title="SpringBoot3æ•´åˆMybatis">SpringBoot3æ•´åˆMybatis</a></li></ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan(&quot;com.example.testmybatis.mapper&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestMybatisApplication</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationContext applicationContext;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(TestMybatisApplication.class, args);<br>        <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">studentMapper</span> <span class="hljs-operator">=</span> applicationContext.getBean(StudentMapper.class);<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> studentMapper.selectById(<span class="hljs-number">1</span>);<br>        System.out.println(student);<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContextParam)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        applicationContext = applicationContextParam;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>è§£æ <code>SpringBoot</code> ä¸»ç±»æ—¶å¯¼å…¥ <code>ImportBeanDefinitionRegistrar</code> å®ç°ç±»çš„æµç¨‹</strong><br>ç›´æ¥ä» <code>AbstractApplicationContext#refresh</code> å¼€å§‹ï¼Œå‰é¢æ­¥éª¤çœç•¥</p>
<figure class="highlight leaf"><table><tr><td class="code"><pre><code class="hljs leaf">AbstractApplicationContext<span class="hljs-punctuation">#</span><span class="hljs-keyword">refresh</span><br>    AbstractApplicationContext<span class="hljs-punctuation">#</span><span class="hljs-keyword">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(<span class="hljs-variable">ConfigurableListableBeanFactory</span>)</span><br>        PostProcessorRegistrationDelegate<span class="hljs-punctuation">#</span><span class="hljs-keyword">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(<span class="hljs-variable">ConfigurableListableBeanFactory</span>, <span class="hljs-variable">List</span><span class="hljs-operator">&lt;</span><span class="hljs-variable">BeanFactoryPostProcessor</span><span class="hljs-operator">&gt;</span>)</span><br>            PostProcessorRegistrationDelegate<span class="hljs-punctuation">#</span><span class="hljs-keyword">invokeBeanDefinitionRegistryPostProcessors</span><br>                ã€æ³¨ï¼šConfigurationClassPostProcessor æ˜¯å®ç°äº† BeanDefinitionRegistryPostProcessor æ¥å£çš„ç±»ã€‘<br>                ConfigurationClassPostProcessor<span class="hljs-punctuation">#</span><span class="hljs-keyword">postProcessBeanDefinitionRegistry</span><br>                    ConfigurationClassPostProcessor<span class="hljs-punctuation">#</span><span class="hljs-keyword">processConfigBeanDefinitions</span><br>                        ConfigurationClassBeanDefinitionReader<span class="hljs-punctuation">#</span><span class="hljs-keyword">loadBeanDefinitions</span><br>                            ã€è¿™é‡Œä¼šè°ƒç”¨ä¸»ç±»çš„ configClass.getImportBeanDefinitionRegistrars()ã€‘<br>                            ConfigurationClassBeanDefinitionReader<span class="hljs-punctuation">#</span><span class="hljs-keyword">loadBeanDefinitionsForConfigurationClass</span><br>                                ConfigurationClassBeanDefinitionReader<span class="hljs-punctuation">#</span><span class="hljs-keyword">loadBeanDefinitionsFromRegistrars</span><br></code></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„æµç¨‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ ¸å¿ƒç‚¹æ˜¯ <code>ConfigurationClassBeanDefinitionReader#loadBeanDefinitionsForConfigurationClass</code> æ–¹æ³•ï¼Œä¸»è¦çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationClassBeanDefinitionReader</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadBeanDefinitionsForConfigurationClass</span><span class="hljs-params">(</span><br><span class="hljs-params">			ConfigurationClass configClass, TrackedConditionEvaluator trackedConditionEvaluator)</span> &#123;<br>        <span class="hljs-comment">// çœç•¥å…¶ä»–ä»£ç â€¦â€¦</span><br>        <span class="hljs-comment">// configClass.getImportBeanDefinitionRegistrars() , è¿™é‡Œ configClass å°±æ˜¯ä¸»ç±»</span><br>        <span class="hljs-comment">// getImportBeanDefinitionRegistrars() æ–¹æ³•è·å–çš„å°±æ˜¯ä¸»ç±»çš„æ³¨è§£ä¸Š ImportBeanDefinitionRegistrar</span><br>        <span class="hljs-comment">// æ¥å£çš„å®ç°ç±»</span><br>		loadBeanDefinitionsFromRegistrars(configClass.getImportBeanDefinitionRegistrars());<br>	&#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadBeanDefinitionsFromRegistrars</span><span class="hljs-params">(Map&lt;ImportBeanDefinitionRegistrar, AnnotationMetadata&gt; registrars)</span> &#123;<br>		registrars.forEach((registrar, metadata) -&gt;<br>                <span class="hljs-comment">// è¿™é‡Œä¼šè°ƒç”¨ ImportBeanDefinitionRegistrar æ¥å£ä¸­çš„registerBeanDefinitions æ–¹æ³•</span><br>				registrar.registerBeanDefinitions(metadata, <span class="hljs-built_in">this</span>.registry, <span class="hljs-built_in">this</span>.importBeanNameGenerator));<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šé¢ä»£ç ä¸­åŠ è½½ <code>ImportBeanDefinitionRegistrar</code> æ¥å£çš„å®ç°ç±»çš„æ¥æºæ˜¯ <code>configClass.getImportBeanDefinitionRegistrars()</code> æ–¹æ³•çš„è¿”å›å€¼ï¼Œçœ‹ä¸€ä¸‹ <code>ConfigurationClass</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationClass</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;ImportBeanDefinitionRegistrar, AnnotationMetadata&gt; importBeanDefinitionRegistrars = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();<br>    <span class="hljs-comment">// çœç•¥å…¶ä»–ä»£ç â€¦â€¦</span><br>    <span class="hljs-keyword">public</span> List&lt;ImportBeanDefinitionRegistrar&gt; <span class="hljs-title function_">getImportBeanDefinitionRegistrars</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.importBeanDefinitionRegistrars;<br>    &#125;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addImportBeanDefinitionRegistrar</span><span class="hljs-params">(ImportBeanDefinitionRegistrar registrar, AnnotationMetadata importingClassMetadata)</span> &#123;<br>		<span class="hljs-built_in">this</span>.importBeanDefinitionRegistrars.put(registrar, importingClassMetadata);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>getImportBeanDefinitionRegistrars()</code> æ–¹æ³•åªæ˜¯è¿”å›ï¼Œå¦‚æœè¦æƒ³çŸ¥é“æ˜¯ä»€ä¹ˆæ—¶å€™æ·»åŠ çš„ï¼Œä¹Ÿå¾ˆç®€å•ï¼Œ<code>importBeanDefinitionRegistrars</code> æ˜¯ä¸€ä¸ª <code>Map</code>, æ‰€ä»¥å¯ä»¥æœç´¢ <code>importBeanDefinitionRegistrars.put(</code>, ç„¶ååœ¨è¿™äº›ä½ç½®æ‰“æ–­ç‚¹å³å¯ï¼Œè¿™é‡Œç›´æ¥è¯´ç»“è®ºï¼Œå…¶å®ä¹Ÿæ˜¯åœ¨è§£æä¸»ç±»æ—¶ä¹Ÿè§£æ <code>Import</code> æ³¨è§£ï¼Œå¯¹äº <code>Import</code> æ³¨è§£å¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/73d35f59945c/index.html" title="Springä¸­Importæ³¨è§£æºç è§£æ">Springä¸­Importæ³¨è§£æºç è§£æ</a></li></ol>
<p>åœ¨è¿™é‡Œç›´æ¥ç»™å‡ºåŠ è½½ <code>ImportBeanDefinitionRegistrar</code> æ¥å£å®ç°ç±»çš„ç›¸å…³ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationClassParser</span> &#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> SourceClass <span class="hljs-title function_">doProcessConfigurationClass</span><span class="hljs-params">(</span><br><span class="hljs-params">			ConfigurationClass configClass, SourceClass sourceClass, Predicate&lt;String&gt; filter)</span><br>			<span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// çœç•¥å…¶ä»–ä»£ç â€¦â€¦</span><br>		<span class="hljs-comment">// Process any @Import annotations</span><br>		processImports(configClass, sourceClass, getImports(sourceClass), filter, <span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">// çœç•¥å…¶ä»–ä»£ç â€¦â€¦</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>doProcessConfigurationClass</code> æ–¹æ³•å°±æ˜¯è§£æä¸»ç±»çš„æ–¹æ³•ï¼Œåœ¨ <code>processImports()</code> æ–¹æ³•å‚æ•°ä¸­è¿˜æœ‰ä¸€ä¸ª <code>getImports()</code> æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªæ–¹æ³•è·å–äº†ä¸»ç±»ä¸Šçš„ <code>Import</code> æ³¨è§£å¼•å…¥çš„ç±»</p>
<p>**ç¬¬ä¸€éƒ¨åˆ†æ€»ç»“ï¼šç»è¿‡ä¸Šé¢çš„è§£æå¯ä»¥çŸ¥é“ MapperScan æ³¨è§£ä¸Šçš„ MapperScannerRegistrar ç±»æ˜¯æ€ä¹ˆè¢«å¼•å…¥çš„äº†ï¼Œå°±æ˜¯ è§£æä¸»ç±» -&gt; è·å–ä¸»ç±»ä¸Š Import æ³¨è§£å¼•å…¥çš„ç±» -&gt; å¤„ç†ImportBeanDefinitionRegistraræ¥å£å®ç°ç±» **</p>
<h3 id="é€šè¿‡MapperScannerRegistrarå¯¼å…¥MapperScannerConfigurer"><a href="#é€šè¿‡MapperScannerRegistrarå¯¼å…¥MapperScannerConfigurer" class="headerlink" title="é€šè¿‡MapperScannerRegistrarå¯¼å…¥MapperScannerConfigurer"></a>é€šè¿‡MapperScannerRegistrarå¯¼å…¥MapperScannerConfigurer</h3><p>ç»è¿‡ä¸Šé¢è§£æå·²ç»çŸ¥é“ <code>MapperScannerRegistrar</code> æ˜¯æ€ä¹ˆè¢«å¯¼å…¥åˆ° <code>Spring</code> ä¸­å¹¶è¢« <code>Spring</code> è°ƒç”¨çš„ï¼Œæ¥ä¸‹æ¥å°±çœ‹çœ‹ <code>MapperScannerRegistrar</code> ç±»ã€éƒ¨åˆ†ä»£ç çœç•¥ï¼Œåªå±•ç¤ºæ–¹æ³•ä¸­å…³é”®ä»£ç ã€‘</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperScannerRegistrar</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportBeanDefinitionRegistrar</span>, ResourceLoaderAware &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;<br>        <span class="hljs-type">AnnotationAttributes</span> <span class="hljs-variable">mapperScanAttrs</span> <span class="hljs-operator">=</span> AnnotationAttributes<br>            .fromMap(importingClassMetadata.getAnnotationAttributes(MapperScan.class.getName()));<br>        <span class="hljs-keyword">if</span> (mapperScanAttrs != <span class="hljs-literal">null</span>) &#123;<br>        registerBeanDefinitions(importingClassMetadata, mapperScanAttrs, registry,<br>            generateBaseBeanName(importingClassMetadata, <span class="hljs-number">0</span>));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(AnnotationMetadata annoMeta, AnnotationAttributes annoAttrs,</span><br><span class="hljs-params">        BeanDefinitionRegistry registry, String beanName)</span> &#123;<br>        <span class="hljs-comment">// ã€é‡ç‚¹1ã€‘å¼•å…¥ MapperScannerConfigurer ç±»äº¤ç»™ Spring ç®¡ç†</span><br>        <span class="hljs-type">BeanDefinitionBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(MapperScannerConfigurer.class);<br>        builder.addPropertyValue(<span class="hljs-string">&quot;processPropertyPlaceHolders&quot;</span>, <span class="hljs-literal">true</span>);<br><br>        Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MapperFactoryBean</span>&gt; mapperFactoryBeanClass = annoAttrs.getClass(<span class="hljs-string">&quot;factoryBean&quot;</span>);<br>        <span class="hljs-keyword">if</span> (!MapperFactoryBean.class.equals(mapperFactoryBeanClass)) &#123;<br>        <span class="hljs-comment">// ã€é‡ç‚¹2ã€‘ï¼šå°†è¿™äº› Mapper ç±»çš„ class è®¾ç½®ä¸º mapperFactoryBeanClass</span><br>        builder.addPropertyValue(<span class="hljs-string">&quot;mapperFactoryBeanClass&quot;</span>, mapperFactoryBeanClass);<br>        &#125;<br>        <span class="hljs-comment">// ã€é‡ç‚¹3ã€‘ï¼š æ‰§è¡Œæ³¨å…¥é€»è¾‘ï¼Œä½†æ˜¯è¿™é‡Œçš„æ³¨å…¥æ˜¯åªæ³¨å…¥ MapperScannerConfigurer è¿™ä¸ªç±»</span><br>        registry.registerBeanDefinition(beanName, builder.getBeanDefinition());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>MapperScannerRegistrar</code> ç±»çš„ä¸»è¦ä½œç”¨æ˜¯å°† <code>MapperScannerConfigurer</code> äº¤ç»™ <code>Spring</code> ç®¡ç†ï¼Œæ‰€ä»¥ç»§ç»­çœ‹ <code>MapperScannerConfigurer</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperScannerConfigurer</span><br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanDefinitionRegistryPostProcessor</span>, InitializingBean, ApplicationContextAware, BeanNameAware &#123;<br>    <br>    <span class="hljs-comment">//  MapperScannerConfigurer å®ç°äº† BeanDefinitionRegistryPostProcessor æ¥å£</span><br>    <span class="hljs-comment">//  æ‰€ä»¥ä¼šè°ƒç”¨åˆ° postProcessBeanDefinitionRegistry æ–¹æ³•</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.processPropertyPlaceHolders) &#123;<br>        processPropertyPlaceHolders();<br>        &#125;<br><br>        <span class="hljs-type">ClassPathMapperScanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathMapperScanner</span>(registry);<br>        scanner.setAddToConfig(<span class="hljs-built_in">this</span>.addToConfig);<br>        scanner.setAnnotationClass(<span class="hljs-built_in">this</span>.annotationClass);<br>        scanner.setMarkerInterface(<span class="hljs-built_in">this</span>.markerInterface);<br>        scanner.setSqlSessionFactory(<span class="hljs-built_in">this</span>.sqlSessionFactory);<br>        scanner.setSqlSessionTemplate(<span class="hljs-built_in">this</span>.sqlSessionTemplate);<br>        scanner.setSqlSessionFactoryBeanName(<span class="hljs-built_in">this</span>.sqlSessionFactoryBeanName);<br>        scanner.setSqlSessionTemplateBeanName(<span class="hljs-built_in">this</span>.sqlSessionTemplateBeanName);<br>        scanner.setResourceLoader(<span class="hljs-built_in">this</span>.applicationContext);<br>        scanner.setBeanNameGenerator(<span class="hljs-built_in">this</span>.nameGenerator);<br>        scanner.setMapperFactoryBeanClass(<span class="hljs-built_in">this</span>.mapperFactoryBeanClass);<br>        <span class="hljs-keyword">if</span> (StringUtils.hasText(lazyInitialization)) &#123;<br>        scanner.setLazyInitialization(Boolean.valueOf(lazyInitialization));<br>        &#125;<br>        <span class="hljs-keyword">if</span> (StringUtils.hasText(defaultScope)) &#123;<br>        scanner.setDefaultScope(defaultScope);<br>        &#125;<br>        scanner.registerFilters();<br>        <span class="hljs-comment">// ã€é‡ç‚¹4ã€‘ï¼šæ‰§è¡Œ Mapper çš„æ‰«æé€»è¾‘</span><br>        scanner.scan(<br>            StringUtils.tokenizeToStringArray(<span class="hljs-built_in">this</span>.basePackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>MapperScannerConfigurer</code> çš„ä½œç”¨æ˜¯ç”Ÿæˆ <code>ClassPathMapperScanner(BeanDefinitionRegistry)</code>, ç„¶åå°† <code>Mapper</code> çš„æ‰«æå·¥ä½œå°±äº¤ç»™ <code>ClassPathMapperScanner</code> å®Œæˆï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çœ‹çœ‹ <code>ClassPathMapperScanner</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassPathMapperScanner</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassPathBeanDefinitionScanner</span> &#123;<br>    <span class="hljs-keyword">public</span> Set&lt;BeanDefinitionHolder&gt; <span class="hljs-title function_">doScan</span><span class="hljs-params">(String... basePackages)</span> &#123;<br>        Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="hljs-built_in">super</span>.doScan(basePackages);<br>        processBeanDefinitions(beanDefinitions);<br>        <span class="hljs-keyword">return</span> beanDefinitions;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBeanDefinitions</span><span class="hljs-params">(Set&lt;BeanDefinitionHolder&gt; beanDefinitions)</span> &#123;<br>        AbstractBeanDefinition definition;<br>        <span class="hljs-type">BeanDefinitionRegistry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> getRegistry();<br>        <span class="hljs-keyword">for</span> (BeanDefinitionHolder holder : beanDefinitions) &#123;<br>        definition = (AbstractBeanDefinition) holder.getBeanDefinition();<br>        <span class="hljs-comment">// ã€é‡ç‚¹ã€‘ï¼šè¿™é‡Œå°† BeanDefinition ä¸­çš„ BeanClass è®¾ç½®æˆäº† MapperFacotryBean</span><br>        <span class="hljs-comment">// è¿™æ ·å°±å¯ä»¥è®© Spring ç®¡ç† MapperFactoryBeanï¼Œç„¶åå¯ä»¥é€šè¿‡ MapperFacotryBean ç”Ÿæˆ Mapper ä»£ç†ç±»</span><br>        definition.setBeanClass(<span class="hljs-built_in">this</span>.mapperFactoryBeanClass);<br>        <span class="hljs-comment">// çœç•¥å…¶ä»–ä»£ç â€¦â€¦</span><br>        <span class="hljs-keyword">if</span> (!definition.isSingleton()) &#123;<br>            <span class="hljs-type">BeanDefinitionHolder</span> <span class="hljs-variable">proxyHolder</span> <span class="hljs-operator">=</span> ScopedProxyUtils.createScopedProxy(holder, registry, <span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">if</span> (registry.containsBeanDefinition(proxyHolder.getBeanName())) &#123;<br>            registry.removeBeanDefinition(proxyHolder.getBeanName());<br>            &#125;<br>            registry.registerBeanDefinition(proxyHolder.getBeanName(), proxyHolder.getBeanDefinition());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>ClassPathMapperScanner</code> ç»§æ‰¿ <code>ClassPathBeanDefinitionScanner</code> ç±»å¹¶ä¸”é‡å†™äº† <code>doScan()</code> æ–¹æ³•ï¼Œ<code>ClassPathBeanDefinitionScanner</code> æ˜¯ <code>Spring</code> æ‰«æ <code>BeanDefinition</code> çš„ç±»ï¼Œ<code>Mybatis</code> ç»§æ‰¿è¿™ä¸ªç±»æ˜¯ä¸ºäº†è®©å¤§éƒ¨åˆ†çš„æ‰«æå·¥ä½œç›´æ¥äº¤ç»™ <code>Spring</code> å®Œæˆï¼ŒåŒæ—¶é‡å†™ <code>doScan()</code> æ–¹æ³•æ˜¯ä¸ºäº†ç»™ <code>BeanDefinition</code> è®¾ç½®ä¸€äº›ç‰¹æ®Šçš„å±æ€§ï¼Œæ¯”å¦‚è®¾ç½® <code>BeanClass</code>ä¸º <code>mapperFactoryBeanClass</code></p>
<h2 id="é€šè¿‡-MapperFactoryBean-ç”Ÿæˆ-Mapper-ä»£ç†ç±»"><a href="#é€šè¿‡-MapperFactoryBean-ç”Ÿæˆ-Mapper-ä»£ç†ç±»" class="headerlink" title="é€šè¿‡ MapperFactoryBean ç”Ÿæˆ Mapper ä»£ç†ç±»"></a>é€šè¿‡ MapperFactoryBean ç”Ÿæˆ Mapper ä»£ç†ç±»</h2><p>é€šè¿‡å‰é¢çš„è§£æå¯çŸ¥æ‰«æ <code>Mapper</code> æ¥å£å°†å…¶è§£ææˆ <code>BeanDefinition</code> åï¼Œä¼šå°†å…¶ <code>BeanClass</code> è®¾ç½®æˆ <code>MapperFactoryBeanClass</code>, æ¥ä¸‹æ¥çœ‹çœ‹ <code>MapperFactoryBean</code>(åªå±•ç¤ºéƒ¨åˆ†ä»£ç )</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperFactoryBean</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SqlSessionDaoSupport</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FactoryBean</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">private</span> Class&lt;T&gt; mapperInterface;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperFactoryBean</span><span class="hljs-params">(Class&lt;T&gt; mapperInterface)</span> &#123;<br>        <span class="hljs-built_in">this</span>.mapperInterface = mapperInterface;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> getSqlSession().getMapper(<span class="hljs-built_in">this</span>.mapperInterface);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>MapperFactoryBean</code> å®ç°äº† <code>FactoryBean</code>ï¼Œ å¯¹äº <code>FactoryBean</code> å¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/fdea11462f1f/index.html" title="Springä¸­FactoryBeanè¯¦è§£">Springä¸­FactoryBeanè¯¦è§£</a></li></ol>
<p>ç›´æ¥è·å– <code>FactoryBean</code> å¯¹è±¡ï¼Œå®é™…è·å–çš„æ˜¯ <code>getObject()</code> æ–¹æ³•è¿”å›çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ <code> getSqlSession().getMapper(this.mapperInterface)</code> è¿”å› <code>Mapper</code> ä»£ç†ç±»</p>
]]></content>
      <categories>
        <category>java</category>
        <category>Mybatis</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatisè·å–Mapperä»£ç†å¯¹è±¡çš„è¿‡ç¨‹åˆ†æ</title>
    <url>/2023/5cc9f93ce77a/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<blockquote>
<p>Mybatisç‰ˆæœ¬ï¼š 3.5.15<br>JDK: 17</p>
</blockquote>
<p>ä½¿ç”¨ <code>Mapper</code> æ¥å£çš„ç¤ºä¾‹å¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/1d9bedf3f03a/index.html" title="æ­å»ºMybatisæºç æµ‹è¯•ç¯å¢ƒ">æ­å»ºMybatisæºç æµ‹è¯•ç¯å¢ƒ</a></li></ol>


<h2 id="è·å–-Mapper-æµç¨‹"><a href="#è·å–-Mapper-æµç¨‹" class="headerlink" title="è·å– Mapper æµç¨‹"></a>è·å– Mapper æµç¨‹</h2><p>è·å– <code>Mapper</code> ä»£ç†ç±»çš„ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// sesion æ˜¯ DefaultSqlSession</span><br><span class="hljs-type">StudentMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> session.getMapper(StudentMapper.class);<br></code></pre></td></tr></table></figure>
<p>è·å– <code>Mapper</code> ä»£ç†ç±»çš„æ•´ä¸ªæµç¨‹å¦‚ä¸‹</p>
<pre class="mermaid">sequenceDiagram
    participant A as DefaultSqlSession
    participant B as Configuration
    participant C as MapperRegistry
    participant D as MapperProxyFactory
    participant E as Proxy
    A->>B: getMapper(Class)
    B->>C: getMapper(Class,Configuration)
    C->>D: newInstance(SqlSession)
    D->>D: new MapperProxy()
    D->>D: newInstance(MapperProxy)
    D->>E: Proxy.newProxyInstance(MapperProxy)</pre>

<p>æœ€ç»ˆæ˜¯é€šè¿‡ <code>Proxy.newProxyInstance()</code> æ–¹æ³•è·å–çš„ä»£ç†ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ <code>JDK</code> åŠ¨æ€ä»£ç†ï¼Œå¯¹äº <code>JDK</code> åŠ¨æ€ä»£ç†ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/92222e5bba3e/index.html" title="JDKåŠ¨æ€ä»£ç†è¯¦è§£">JDKåŠ¨æ€ä»£ç†è¯¦è§£</a></li></ol>
<p>å¯¹äº <code>JDK</code> åŠ¨æ€ä»£ç†ï¼Œé‡ç‚¹æ˜¯å®ç°äº† <code>InvocationHandler</code> æ¥å£çš„ç±»çš„ <code>invoke()</code> æ–¹æ³•ï¼Œ <code>MapperProxy</code> å°±æ˜¯ <code>InvocationHandler</code> çš„å®ç°ç±»ï¼Œä½†æ˜¯ä»ä¸Šé¢çš„æµç¨‹çœ‹å¥½åƒè¿˜ä¸æ˜¯é‚£ä¹ˆç®€å•ï¼Œè¿˜æ¶‰åŠåˆ°äº† <code>MapperRegistry</code> å’Œ <code>MapperProxyFactory</code>ï¼Œæˆ‘ç”Ÿæˆä¸€ä¸ªä»£ç†ç±»ä¸ºä»€ä¹ˆè¿˜éœ€è¦è¿™ä¸¤ä¸ªç±»å‘¢ï¼Ÿ</p>
<h2 id="MapperRegistryä¹‹Mapperæ³¨å†Œæµç¨‹"><a href="#MapperRegistryä¹‹Mapperæ³¨å†Œæµç¨‹" class="headerlink" title="MapperRegistryä¹‹Mapperæ³¨å†Œæµç¨‹"></a>MapperRegistryä¹‹Mapperæ³¨å†Œæµç¨‹</h2><p>å‰é¢è¯´åˆ›å»ºä»£ç†ç±»çš„æ—¶å€™ä½¿ç”¨ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">StudentMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> session.getMapper(StudentMapper.class);<br></code></pre></td></tr></table></figure>
<p>é‚£ä¹ˆæ˜¯ä»»æ„ä¸€ä¸ªç±»éƒ½å¯ä»¥é€šè¿‡ <code>session.getMapper()</code> æ–¹æ³•æ¥è·å–ä»£ç†ç±»ä¹ˆï¼Ÿ é‚£è‚¯å®šä¸æ˜¯çš„ï¼Œå› ä¸ºè¿™ä¸ªä»£ç†ç±»æ˜¯è¦æ»¡è¶³ <code>Mybatis</code> æ‰§è¡Œ <code>Sql</code> çš„ç›¸å…³åŠŸèƒ½ï¼Œæ€»ä¸èƒ½éšä¾¿ä¸€ä¸ªç±»éƒ½å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼è·å–ä»£ç†ç±»å§ï¼Œé‚£å“ªäº›ç±»æ˜¯å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼è·å–çš„å‘¢ï¼Ÿè¿™é‡Œå°±ç”¨åˆ°äº† <code>MapperRegistry</code>, é¡¾åæ€ä¹‰ä¹ŸçŸ¥é“è¿™ä¸ªå°±æ˜¯ <code>Mapper</code> çš„æ³¨å†Œå™¨ï¼Œåªæœ‰å·²ç»æ³¨å†Œçš„ <code>Mapper</code> æ‰èƒ½é€šè¿‡è¿™ç§æ–¹å¼æ¥è·å–ï¼Œçœ‹çœ‹ <code>MapperRegistry</code> çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperRegistry</span> &#123;<br>    <span class="hljs-comment">// ä¿å­˜æ³¨å†Œçš„ Mapper ç±»</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>MapperRegistry</code> ç¼“å­˜æ³¨å†Œçš„ <code>Mapper</code> ç±»æ—¶ç”¨çš„ <code>Map</code>, <code>value</code> ç±»å‹æ˜¯ <code>MapperProxyFactory</code>ï¼Œ <code>MapperProxyFactory</code> æ˜¯ç”¨æ¥ç”Ÿæˆ <code>MapperProxy</code> çš„ï¼Œè€Œ <code>MapperProxy</code> å®ç°äº† <code>InvocationHandler</code> æ¥å£.</p>
<p><strong>Mapperæ³¨å†Œæµç¨‹å›¾</strong></p>
<pre class="mermaid">graph LR
    A["è§£æMybatis
    ä¸»é…ç½®æ–‡ä»¶"]
    B["è§£æMybatis Mapperæ–‡ä»¶"]
    C["æ‰¾åˆ°Mapperæ–‡ä»¶
    å…³è”çš„Mapperç±»"]
    D["å°†Mapperç±»æ³¨å†Œ
    åˆ°MapperRegistry"]
    A-->B-->C-->D</pre>

<p>ä¹‹æ‰€ä»¥å¯ä»¥æ ¹æ® <code>Mapper</code> æ–‡ä»¶æ‰¾åˆ° <code>Mapper</code> æ¥å£ï¼Œæ˜¯å› ä¸ºå¼€å‘ <code>Mapper</code> æ¥å£éœ€è¦éµå¾ªä¸€å®šçš„è§„èŒƒ</p>
<ol>
<li><code>Mapper.xml</code> æ–‡ä»¶ä¸­çš„ <code>namespace</code> ä¸ <code>mapper</code> æ¥å£çš„ç±»è·¯å¾„ç›¸åŒ (æ ¹æ®è¿™ä¸€ç‚¹å°±å¯ä»¥æ ¹æ® <code>Mapper.xml</code> æ–‡ä»¶æ‰¾åˆ° <code>Mapper</code> æ¥å£)</li>
<li><code>Mapper</code> æ¥å£æ–¹æ³•åå’Œ <code>Mapper.xml</code> ä¸­å®šä¹‰çš„æ¯ä¸ª <code>statement</code> çš„ <code>id</code> ç›¸åŒ</li>
<li><code>Mapper</code> æ¥å£æ–¹æ³•çš„å‚æ•°ç±»å‹å’Œ <code>mapper.xml</code> ä¸­å®šä¹‰çš„æ¯ä¸ª <code>sql</code> çš„ <code>parameterType</code> çš„ç±»å‹ç›¸åŒ</li>
<li><code>Mapper</code> å£æ–¹æ³•çš„è¿”å›å€¼ç±»å‹å’Œ <code>mapper.xml</code> ä¸­å®šä¹‰çš„æ¯ä¸ª <code>sql</code> çš„ <code>resultType</code> çš„ç±»å‹ç›¸åŒ</li>
</ol>
<p><img src="https://s2.loli.net/2023/12/27/F1LhBe4GDYWO2dH.png" alt="Mappeæ¥å£è§„èŒƒ"><br>å…·ä½“åœ¨ä»£ç ä¸­æ ¹æ® <code>namespace</code> æ‰¾åˆ° <code>Mapper</code> æ¥å£ç±»å‹åˆ™æ˜¯åœ¨ <code>XMLMapperBuilder#bindMapperForNamespace</code> æ–¹æ³•ä¸­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XMLMapperBuilder</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bindMapperForNamespace</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">namespace</span> <span class="hljs-operator">=</span> builderAssistant.getCurrentNamespace();<br>        <span class="hljs-keyword">if</span> (namespace != <span class="hljs-literal">null</span>) &#123;<br>        Class&lt;?&gt; boundType = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            boundType = Resources.classForName(namespace);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-comment">// ignore, bound type is not required</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> (boundType != <span class="hljs-literal">null</span> &amp;&amp; !configuration.hasMapper(boundType)) &#123;<br>            configuration.addLoadedResource(<span class="hljs-string">&quot;namespace:&quot;</span> + namespace);<br>            <span class="hljs-comment">// è¿™é‡Œæœ€ç»ˆæ˜¯è°ƒç”¨ MapperRegistry çš„ addMapper æ–¹æ³•è¿›è¡Œæ³¨å†Œ</span><br>            configuration.addMapper(boundType);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>










]]></content>
      <categories>
        <category>java</category>
        <category>Mybatis</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot3æ•´åˆMybatis</title>
    <url>/2023/c7647f7aa552/index.html</url>
    <content><![CDATA[<blockquote>
<p>SpringBootç‰ˆæœ¬: 3.1.7<br>MyBatis-Spring-Boot-Starter 3.0.2<br>JDKç‰ˆæœ¬ï¼š 17</p>
</blockquote>
<p><a href="https://mybatis.org/spring-boot-starter/mybatis-spring-boot-autoconfigure/">å®˜ç½‘Mybatisæ•´åˆSpringBootç‰ˆæœ¬å¯¹åº”å…³ç³»åŠç¤ºä¾‹ä»£ç </a></p>
<h2 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h2><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.28<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="ç¼–å†™æµ‹è¯•ä»£ç "><a href="#ç¼–å†™æµ‹è¯•ä»£ç " class="headerlink" title="ç¼–å†™æµ‹è¯•ä»£ç "></a>ç¼–å†™æµ‹è¯•ä»£ç </h2><p>åˆ›å»ºè¡¨åŠåŸºæœ¬å®ä½“ï¼Œ<code>Mapper</code> ç±»å‚è€ƒ</p>
<ol><li><a href="/2023/1d9bedf3f03a/index.html" title="æ­å»ºMybatisæºç æµ‹è¯•ç¯å¢ƒ">æ­å»ºMybatisæºç æµ‹è¯•ç¯å¢ƒ</a></li></ol>
<p>è¿™é‡Œåˆ—ä¸‹ä½¿ç”¨åˆ°çš„ç±»</p>
<ul>
<li><code>Studentt</code> ç±»<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ToString</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String idCard;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><code>StudentMapper</code> ç±»<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StudentMapper</span> &#123;<br>    Student <span class="hljs-title function_">selectById</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><code>studnet.xml</code> é…ç½®æ–‡ä»¶<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.example.testmybatis.mapper.StudentMapper&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectById&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.example.testmybatis.vo.Student&quot;</span>&gt;</span><br>        select * from student where id = #&#123;id&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li>å¯åŠ¨ç±»<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan(&quot;com.example.testmybatis.mapper&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestMybatisApplication</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationContext applicationContext;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(TestMybatisApplication.class, args);<br>        <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">studentMapper</span> <span class="hljs-operator">=</span> applicationContext.getBean(StudentMapper.class);<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> studentMapper.selectById(<span class="hljs-number">1</span>);<br>        System.out.println(student);<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContextParam)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        applicationContext = applicationContextParam;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><code>SpringBoot</code> é…ç½®æ–‡ä»¶<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.datasource.driver-class-name</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><span class="hljs-attr">spring.datasource.url</span>=<span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test?useUnicode=true&amp;characterEncoding=UTF-8</span><br><span class="hljs-attr">spring.datasource.username</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-string">admin</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">#mybatis</span><br><span class="hljs-attr">mybatis.type-aliases-package</span>=<span class="hljs-string">com.example.testmybatis.vo</span><br><span class="hljs-comment"># resource ç›®å½•ä¸‹ Mapper æ–‡ä»¶ä½ç½®</span><br><span class="hljs-attr">mybatis.mapper-locations</span>=<span class="hljs-string">classpath:mapper/*.xml</span><br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>java</category>
        <category>Mybatis</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBootä¸­ç¼–å†™Mybatisæ’ä»¶åŠMybatisæ’ä»¶åŸç†</title>
    <url>/2023/c46f5c1f519a/index.html</url>
    <content><![CDATA[<blockquote>
<p>SpringBootç‰ˆæœ¬: 3.1.7<br>mybatis-spring-boot-starter: 3.0.2</p>
</blockquote>
<h2 id="Mybatisæ’ä»¶çš„ä½œç”¨"><a href="#Mybatisæ’ä»¶çš„ä½œç”¨" class="headerlink" title="Mybatisæ’ä»¶çš„ä½œç”¨"></a>Mybatisæ’ä»¶çš„ä½œç”¨</h2><p><code>Mybatis</code> æ’ä»¶ä¸»è¦æ˜¯å¯¹ä»¥ä¸‹å››ä¸ªç±»ä¸Šçš„æ–¹æ³•è¿›è¡Œæ‹¦æˆª</p>
<ul>
<li><code>Executor</code></li>
<li><code>StatementHandler</code></li>
<li><code>ResultSetHandler</code></li>
<li><code>ParameterHandler</code></li>
</ul>
<h2 id="SpringBootæ•´åˆMybatisåŠè‡ªå®šä¹‰æ’ä»¶"><a href="#SpringBootæ•´åˆMybatisåŠè‡ªå®šä¹‰æ’ä»¶" class="headerlink" title="SpringBootæ•´åˆMybatisåŠè‡ªå®šä¹‰æ’ä»¶"></a>SpringBootæ•´åˆMybatisåŠè‡ªå®šä¹‰æ’ä»¶</h2><p>å•çº¯åœ¨ <code>Mybatis</code> ä¸­ç¼–å†™æ’ä»¶ï¼Œå¯ä»¥å‚è€ƒ <a href="https://juejin.cn/post/7205897684623900728">Mybatisæ’ä»¶çš„ä½¿ç”¨å’ŒåŸç†</a><br>å¯¹äºåœ¨ <code>SpringBoot</code> ä½¿ç”¨æ’ä»¶ä¹Ÿå¾ˆç®€å•ï¼Œå¯ä»¥å…ˆå‚è€ƒ</p>
<ol><li><a href="/2023/c7647f7aa552/index.html" title="SpringBoot3æ•´åˆMybatis">SpringBoot3æ•´åˆMybatis</a></li></ol>
<p>ç„¶åå†ç¼–å†™ä¸€ä¸ªæ’ä»¶ç±»å³å¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Intercepts(@Signature(type= Executor.class, method=&quot;query&quot;, args=&#123;MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class&#125;))</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusPlugin</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Interceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        System.out.println(<span class="hljs-string">&quot;æ’ä»¶æ‰§è¡Œå‰&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proceed</span> <span class="hljs-operator">=</span> invocation.proceed();<br>        System.out.println(<span class="hljs-string">&quot;æ’ä»¶æ‰§è¡Œå&quot;</span>);<br>        <span class="hljs-keyword">return</span> proceed;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>java</category>
        <category>Mybatis</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>æ­å»ºMybatisæºç æµ‹è¯•ç¯å¢ƒ</title>
    <url>/2023/1d9bedf3f03a/index.html</url>
    <content><![CDATA[<blockquote>
<p>Mybatisç‰ˆæœ¬: 3.5.15<br>JDKç‰ˆæœ¬ï¼š17</p>
</blockquote>
<h2 id="ä¸‹è½½æºç "><a href="#ä¸‹è½½æºç " class="headerlink" title="ä¸‹è½½æºç "></a>ä¸‹è½½æºç </h2><p><a href="https://github.com/mybatis/mybatis-3">ä¸‹è½½Mybatis3</a><br><code>Mybatis</code> æºç ä¸­ä¼šä¾èµ– <code>Mybatis-parent</code>, å¦‚ä¸‹æ‰€ç¤ºï¼Œè¿˜éœ€è¦ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ <code>Mybatis-parent</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>41<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p><a href="https://github.com/mybatis/parent">ä¸‹è½½Mybatis-parent</a></p>
<p>ä¸‹è½½å®Œæˆä¹‹åï¼Œå¯ä»¥å…ˆå¯¼å…¥ä¸€ä¸ªé¡¹ç›®åˆ° <code>idea</code> ä¸­ï¼Œç„¶ååœ¨ <code>idea</code> çš„ <code>Project Structure</code> é¢æ¿ä¸­å°†å¦å¤–ä¸€ä¸ªé¡¹ç›®ä½œä¸º <code>module</code> å¯¼å…¥</p>
<h2 id="å®‰è£…-Mysql"><a href="#å®‰è£…-Mysql" class="headerlink" title="å®‰è£… Mysql"></a>å®‰è£… Mysql</h2><p>å‚è€ƒå¦‚ä¸‹æ–‡ç« ï¼Œå…ˆå®‰è£… <code>Mysql</code></p>
<ol><li><a href="/2023/ff432902bea0/index.html" title="Windowä¸‹å®‰è£…mysql8è§£å‹ç‰ˆ">Windowä¸‹å®‰è£…mysql8è§£å‹ç‰ˆ</a></li></ol>

<h3 id="åˆ›å»ºè¡¨"><a href="#åˆ›å»ºè¡¨" class="headerlink" title="åˆ›å»ºè¡¨"></a>åˆ›å»ºè¡¨</h3><p><strong>å…ˆåˆ›å»ºæ•°æ®åº“</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> database test;<br></code></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨æ•°æ®åº“</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">use test;<br></code></pre></td></tr></table></figure>

<p><strong>åˆ›å»ºè¡¨</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> student<br>(<br>    id      <span class="hljs-type">int</span>          <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span><br>        <span class="hljs-keyword">primary</span> key,<br>    name    <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">null</span>,<br>    id_card <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>)  <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,<br>    <span class="hljs-keyword">constraint</span> s_id_card<br>        <span class="hljs-keyword">unique</span> (id_card)<br>);<br></code></pre></td></tr></table></figure>

<h3 id="æ·»åŠ æµ‹è¯•æ•°æ®"><a href="#æ·»åŠ æµ‹è¯•æ•°æ®" class="headerlink" title="æ·»åŠ æµ‹è¯•æ•°æ®"></a>æ·»åŠ æµ‹è¯•æ•°æ®</h3><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> test.student (id, name, id_card) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;name1&#x27;</span>, <span class="hljs-string">&#x27;1_card&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> test.student (id, name, id_card) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">5</span>, <span class="hljs-string">&#x27;name5&#x27;</span>, <span class="hljs-string">&#x27;5_card&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> test.student (id, name, id_card) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10</span>, <span class="hljs-string">&#x27;name10&#x27;</span>, <span class="hljs-string">&#x27;10_card&#x27;</span>);<br></code></pre></td></tr></table></figure>

<h2 id="åˆ›å»ºæµ‹è¯•ä»£ç "><a href="#åˆ›å»ºæµ‹è¯•ä»£ç " class="headerlink" title="åˆ›å»ºæµ‹è¯•ä»£ç "></a>åˆ›å»ºæµ‹è¯•ä»£ç </h2><h3 id="åˆ›å»ºMybatisæ ¸å¿ƒé…ç½®æ–‡ä»¶"><a href="#åˆ›å»ºMybatisæ ¸å¿ƒé…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºMybatisæ ¸å¿ƒé…ç½®æ–‡ä»¶"></a>åˆ›å»ºMybatisæ ¸å¿ƒé…ç½®æ–‡ä»¶</h3><p>åœ¨ <code>Mybatis</code> æºç é¡¹ç›®çš„ <code>resources</code> ç›®å½•ä¸‹åˆ›å»º <code>mybatis-config.xml</code> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">configuration</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">environments</span> <span class="hljs-attr">default</span>=<span class="hljs-string">&quot;development&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">environment</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;development&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">transactionManager</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;JDBC&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;POOLED&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driver&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test?serverTimezone=UTC&quot;</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;root&quot;</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;admin&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">environments</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;mapper/student.xml&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="åˆ›å»ºMybatisæ˜ å°„æ–‡ä»¶å’Œå®ç°ç±»"><a href="#åˆ›å»ºMybatisæ˜ å°„æ–‡ä»¶å’Œå®ç°ç±»" class="headerlink" title="åˆ›å»ºMybatisæ˜ å°„æ–‡ä»¶å’Œå®ç°ç±»"></a>åˆ›å»ºMybatisæ˜ å°„æ–‡ä»¶å’Œå®ç°ç±»</h3><p><img src="https://s2.loli.net/2023/12/26/ftVYKd8b9MgvUNp.png" alt="æµ‹è¯•ç±»ç›®å½•å’Œç»“æ„"></p>
<p><strong>å®ä½“ç±» Student</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ToString</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String idCard;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>StudentMapperç±»</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StudentMapper</span> &#123;<br>    Student <span class="hljs-title function_">selectById</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>Mapperæ˜ å°„æ–‡ä»¶</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;org.example.mapper.StudentMapper&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectById&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;org.example.vo.Student&quot;</span>&gt;</span><br>        select * from student where id = #&#123;id&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><strong>æµ‹è¯•ç±»</strong><br><img src="https://s2.loli.net/2023/12/26/hWT4Ne7g98XsQkr.png" alt="æµ‹è¯•ç±»ç»“æ„"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestMybatis</span> &#123;<br><br>    SqlSessionFactory sqlSessionFactory;<br><br>    <span class="hljs-meta">@Before</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mybatis-config.xml&quot;</span>;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Resources.getResourceAsStream(resource);<br>        sqlSessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(inputStream);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">selectById</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession()) &#123;<br>            <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> session.getMapper(StudentMapper.class);<br>            <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> mapper.selectById(<span class="hljs-number">1</span>);<br>            System.out.println(student);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>æ‰§è¡Œç»“æœ</strong></p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">Student(<span class="hljs-attribute">id</span>=1, <span class="hljs-attribute">name</span>=name1, <span class="hljs-attribute">idCard</span>=<span class="hljs-literal">null</span>)<br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>java</category>
        <category>Mybatis</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>BeanFacotryçš„åç½®å¤„ç†å™¨è¯¦è§£</title>
    <url>/2023/e7d5d1305e5d/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p><strong>Spring ç‰ˆæœ¬ï¼š 6.0.6</strong></p>
<h2 id="BeanFactory-çš„åç½®å¤„ç†å™¨çš„ä½œç”¨"><a href="#BeanFactory-çš„åç½®å¤„ç†å™¨çš„ä½œç”¨" class="headerlink" title="BeanFactory çš„åç½®å¤„ç†å™¨çš„ä½œç”¨"></a>BeanFactory çš„åç½®å¤„ç†å™¨çš„ä½œç”¨</h2><p><code>BeanFactory</code> çš„åç½®å¤„ç†å™¨ï¼ˆ<code>PostProcessor</code>ï¼‰æ˜¯ç”¨äºåœ¨ <code>BeanFactory</code> åŠ è½½å’Œåˆ›å»º <code>bean</code> è¿‡ç¨‹ä¸­å¯¹ <code>bean</code> è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†çš„æ¥å£ã€‚å®ƒæä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥åœ¨ <code>Spring</code> å®¹å™¨å®ä¾‹åŒ– <code>bean</code> ä¹‹å‰å¯¹ <code>bean</code> è¿›è¡Œå®šåˆ¶ã€ä¿®æ”¹æˆ–æ‰©å±•</p>
<h2 id="ä¸¤ç§-BeanFactory-çš„æ¥å£ç±»å‹"><a href="#ä¸¤ç§-BeanFactory-çš„æ¥å£ç±»å‹" class="headerlink" title="ä¸¤ç§ BeanFactory çš„æ¥å£ç±»å‹"></a>ä¸¤ç§ BeanFactory çš„æ¥å£ç±»å‹</h2><h3 id="BeanFactoryPostProcessor"><a href="#BeanFactoryPostProcessor" class="headerlink" title="BeanFactoryPostProcessor"></a>BeanFactoryPostProcessor</h3><p>å¯ä»¥é€šè¿‡ <code>ConfigurableListableBeanFactory</code> å¯¹ <code>BeanDefinition</code> è¿›è¡Œä¿®æ”¹ï¼Œè¿™æ ·å°±ä¼šæ”¹å˜ <code>bean</code> çš„å®šä¹‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FunctionalInterface</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanFactoryPostProcessor</span> &#123;<br>	<span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> BeansException;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="BeanDefinitionRegistryPostProcessor"><a href="#BeanDefinitionRegistryPostProcessor" class="headerlink" title="BeanDefinitionRegistryPostProcessor"></a>BeanDefinitionRegistryPostProcessor</h3><p><code>BeanDefinitionRegistryPostProcessor</code> ç»§æ‰¿äº† <code>BeanFactoryPostProcessor</code> æ¥å£ï¼ŒåŒæ—¶å¢åŠ äº†ä¸€ä¸ªæ¥å£ï¼Œè¯¥æ¥å£æä¾›äº† <code>BeanDefinitionRegistry</code> å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åŠ¨æ€æ³¨å…¥ä¸€äº› <code>BeanDefinition</code>ï¼Œ åœ¨ <code>Spring</code> ä¸­å…¸å‹çš„åº”ç”¨æ˜¯ <code>ConfigurationClassPostProcessor</code>ï¼Œåé¢ä¼šåˆ†æè¿™ä¸ªç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanDefinitionRegistryPostProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BeanFactoryPostProcessor</span> &#123;<br>	<span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> <span class="hljs-keyword">throws</span> BeansException;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="BeanFactory-åç½®å¤„ç†å™¨çš„ä½¿ç”¨ç¤ºä¾‹"><a href="#BeanFactory-åç½®å¤„ç†å™¨çš„ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="BeanFactory åç½®å¤„ç†å™¨çš„ä½¿ç”¨ç¤ºä¾‹"></a>BeanFactory åç½®å¤„ç†å™¨çš„ä½¿ç”¨ç¤ºä¾‹</h2><h3 id="ä½¿ç”¨ç¤ºä¾‹ç±»è¯´æ˜"><a href="#ä½¿ç”¨ç¤ºä¾‹ç±»è¯´æ˜" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹ç±»è¯´æ˜"></a>ä½¿ç”¨ç¤ºä¾‹ç±»è¯´æ˜</h3><ol>
<li><code>CusBeanFactoryPostProcessor</code> è¯¥ç±»å®ç°äº† <code>BeanFactoryPostProcessor</code> æ¥å£å¹¶ä¸”æ ‡æœ‰ <code>@Component</code> æ³¨è§£</li>
<li><code>CusBeanDefinitionRegistryPostProcessor</code> è¯¥ç±»å®ç°äº† <code>BeanDefinitionRegistryPostProcessor</code> æ¥å£å¹¶ä¸”æ ‡æœ‰ <code>@Component</code> æ³¨è§£</li>
<li><code>RegisterComponent</code> æ™®é€šç±»ï¼Œä¼šé€šè¿‡ <code>CusBeanDefinitionRegistryPostProcessor</code> æ³¨å…¥åˆ° <code>Spring</code> å®¹å™¨</li>
<li><code>ScanComponent</code> æ ‡æœ‰ <code>@Component</code> å’Œ <code>@Scope(&quot;prototype&quot;)</code>, ä¼šé€šè¿‡ <code>CusBeanFactoryPostProcessor</code> å°† <code>scope</code> ä» <code>prototype</code> æ”¹ä¸º <code>singleton</code></li>
<li><code>BeanFactoryPostProcessMain</code> ä¸»ç±»ï¼Œæ ‡æœ‰ <code>@Configuration</code> å’Œ <code>@ComponentScan</code></li>
</ol>
<p>ä¸Šè¿°æ‰€æœ‰ç±»éƒ½æ”¾åœ¨åŒä¸€ä¸ªåŒ…ä¸­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  æ™®é€šç±»ï¼Œå¹¶æ²¡æœ‰å¢åŠ springæ³¨è§£ï¼Œä¼šé€šè¿‡ CusBeanDefinitionRegistryPostProcessor æ³¨å…¥åˆ° Spring å®¹å™¨</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegisterComponent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;RegisterComponent.sayHello&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// å®ç°äº†BeanDefinitionRegistryPostProcessoræ¥å£ï¼Œä¼šè¢«springæ‰«æï¼Œå¹¶ä¸”æ³¨å…¥äº†æ™®é€šç±» RegisterComponent</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusBeanDefinitionRegistryPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanDefinitionRegistryPostProcessor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-type">AbstractBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(RegisterComponent.class).getBeanDefinition();<br>        registry.registerBeanDefinition(<span class="hljs-string">&quot;registerComponent&quot;</span>, beanDefinition);<br>        System.out.println(<span class="hljs-string">&quot;CusBeanDefinitionRegistryPostProcessor postProcessBeanDefinitionRegistry&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        System.out.println(<span class="hljs-string">&quot;CusBeanDefinitionRegistryPostProcessor postProcessBeanFactory&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//  è¢«springç®¡ç†çš„ç±»ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•å¤„ç†ä¼šæ˜¯ prototype ä½œç”¨åŸŸï¼Œ è¿™é‡Œä¼šé€šè¿‡ CusBeanFactoryPostProcessor å°† scope æ”¹ä¸º singleton</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Scope(&quot;prototype&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScanComponent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;BeanFactoryDemo1 sayHello&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// å®ç°äº†BeanFactoryPostProcessoræ¥å£ï¼Œä¼šå°†scanComponentç±»çš„scopeä»prototypeæ”¹ä¸ºsingleton</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusBeanFactoryPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanFactoryPostProcessor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">scanComponent</span> <span class="hljs-operator">=</span> beanFactory.getBeanDefinition(<span class="hljs-string">&quot;scanComponent&quot;</span>);<br>        scanComponent.setScope(<span class="hljs-string">&quot;singleton&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;CusBeanFactoryPostProcessor postProcessBeanFactory&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// é…ç½®ä¸»ç±»</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanFactoryPostProcessMain</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(BeanFactoryPostProcessMain.class);<br>        <span class="hljs-comment">// BeanFactoryPostProcessor çš„æµ‹è¯•ï¼ˆä¿®æ”¹äº† ScanComponent ç±»çš„ scope å±æ€§ï¼‰</span><br>        <span class="hljs-type">ScanComponent</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> context.getBean(ScanComponent.class);<br>        System.out.println(bean);<br>        <span class="hljs-type">ScanComponent</span> <span class="hljs-variable">bean2</span> <span class="hljs-operator">=</span> context.getBean(ScanComponent.class);<br>        System.out.println(bean2);<br><br>        <span class="hljs-type">RegisterComponent</span> <span class="hljs-variable">registerComponent</span> <span class="hljs-operator">=</span> context.getBean(RegisterComponent.class);<br>        registerComponent.sayHello(); <span class="hljs-comment">// ä¼šæ‰“å° &quot;RegisterComponent.sayHello&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">CusBeanDefinitionRegistryPostProcessor postProcessBeanDefinitionRegistry<br>CusBeanDefinitionRegistryPostProcessor postProcessBeanFactory<br>CusBeanFactoryPostProcessor postProcessBeanFactory<br>org.example.beanfactorypost.ScanComponent@5e1fa5b1<br>org.example.beanfactorypost.ScanComponent@5e1fa5b1<br>RegisterComponent.sayHello<br></code></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢æ‰§è¡Œç»“æœå¯ä»¥å¾—å‡ºå¦‚ä¸‹å‡ ä¸ªç»“è®ºï¼š</p>
<ol>
<li>å…ˆæ‰§è¡Œå®ç°äº† <code>BeanDefinitionRegistryPostProcessor</code> æ¥å£çš„ç±»ï¼Œç„¶åæ‰æ˜¯æ‰§è¡Œçš„ <code>BeanFactoryPostProcessor</code> æ¥å£å®ç°ç±»</li>
<li><code>BeanDefinitionRegistryPostProcessor</code> å®ç°ç±»ç¡®å®å¯ä»¥æ³¨å†Œæ™®é€šå¯¹è±¡æˆä¸º <code>bean</code>, æ¯”å¦‚ä¸Šé¢æ³¨å†Œäº†æ™®é€šå¯¹è±¡ <code>RegisterComponent</code></li>
<li><code>CusBeanFactoryPostProcessor</code> ç±»å·²ç»å°† <code>ScanComponent</code> çš„ <code>scope</code> å±æ€§æ”¹æˆ <code>singleton</code>, å› ä¸ºä¸¤æ¬¡ <code>getBean</code> è·å–çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡</li>
</ol>
<h2 id="BeanFactory-åç½®å¤„ç†å™¨çš„æ‰§è¡Œæ—¶æœº"><a href="#BeanFactory-åç½®å¤„ç†å™¨çš„æ‰§è¡Œæ—¶æœº" class="headerlink" title="BeanFactory åç½®å¤„ç†å™¨çš„æ‰§è¡Œæ—¶æœº"></a>BeanFactory åç½®å¤„ç†å™¨çš„æ‰§è¡Œæ—¶æœº</h2><p>å‚è€ƒ <ol><li><a href="/2023/b93a520f6ddc/index.html" title="Springä¸Šä¸‹æ–‡refreshæ–¹æ³•è§£æ">Springä¸Šä¸‹æ–‡refreshæ–¹æ³•è§£æ</a></li></ol> ä¸­å†™åˆ°çš„ <code>refresh()</code> æ–¹æ³•çš„ç¬¬äº”æ­¥ï¼Œå°±æ˜¯æ‰§è¡Œåç½®å¤„ç†å™¨</p>
<p>æ‰§è¡Œæµç¨‹å¦‚ä¸‹</p>
<pre class="mermaid">sequenceDiagram
    participant A as AnnotationConfigApplicationContext
    participant B as AbstractApplicationContext
    participant C as PostProcessorRegistrationDelegate
    A->>A: new AnnotationConfigApplicationContext(classes)
    A->>B: refresh()
    B->>C: invokeBeanFactoryPostProcessors()
    C->>C: invokeBeanFactoryPostProcessors()</pre>

<p>æ‰€ä»¥æœ€ç»ˆæ˜¯æ‰§è¡Œåˆ° <code>public PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors()</code> æ–¹æ³• ï¼Œ ä»£ç è¿™é‡Œå°±ä¸è´´äº†ï¼Œè¿™é‡Œæ€»ç»“ä¸€ä¸‹</p>
<ol>
<li>æ‰§è¡Œå®ç°äº† <code>BeanDefinitionRegistryPostProcessors</code> å’Œ <code>PriorityOrdered</code> çš„ç±»çš„<code>postProcessBeanDefinitionRegistry()</code> æ–¹æ³•</li>
<li>æ‰§è¡Œå®ç°äº† <code>BeanDefinitionRegistryPostProcessors</code> å’Œ <code>Ordered</code> çš„ç±»çš„<code>postProcessBeanDefinitionRegistry()</code> æ–¹æ³•</li>
<li>æ‰§è¡Œå®ç°äº† <code>BeanDefinitionRegistryPostProcessors</code> å¹¶ä¸”åœ¨ <strong>å‰é¢ä¸¤æ­¥ä¸­æ²¡æœ‰æ‰§è¡Œè¿‡çš„ç±»</strong></li>
<li>å¯¹äºå®ç°äº† <code>BeanFactoryPostProcessor</code> çš„ç±»ï¼Œè°ƒç”¨æµç¨‹ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œæ‰§è¡Œå®ç°äº† <code>PriorityOrdered</code> çš„ç±» -&gt; æ‰§è¡Œå®ç°äº† <code>Ordered</code> çš„ç±» -&gt; æ‰§è¡Œå‰©ä¸‹çš„ç±»</li>
</ol>
<h2 id="BeanDefinitionRegistryPostProcessor-å…¸å‹å®ç°ç±»-ConfigurationClassPostProcessor"><a href="#BeanDefinitionRegistryPostProcessor-å…¸å‹å®ç°ç±»-ConfigurationClassPostProcessor" class="headerlink" title="BeanDefinitionRegistryPostProcessor å…¸å‹å®ç°ç±» ConfigurationClassPostProcessor"></a>BeanDefinitionRegistryPostProcessor å…¸å‹å®ç°ç±» ConfigurationClassPostProcessor</h2><p>åœ¨ <code>Spring</code> å†…éƒ¨ä¹Ÿæ˜¯æœ‰å¾ˆå¤šå®ç°äº† <code>BeanDefinitionRegistryPostProcessor</code> æ¥å£çš„ç±»ï¼Œæ¯”å¦‚ <code>ConfigurationClassPostProcessor</code> ç±»ï¼Œä¸‹é¢å°±æ¥çœ‹çœ‹è¿™ä¸ªç±»</p>
<ol>
<li>å…ˆè¯´æ˜ä¸€ä¸‹ <code>ConfigurationClassPostProcessor</code> è¿™ä¸ªç±»åšçš„äº‹æƒ…ï¼Œåœ¨ <code>Spring</code> ä¸­ <code>@ComponentScan</code> æ³¨è§£å¯ä»¥æ‰¹é‡æ‰«æç±»è¢« <code>Spring</code> ç®¡ç†ï¼Œä½†æ˜¯æ³¨è§£åªæ˜¯èµ·åˆ°ä¸€ä¸ªæ ‡è®°çš„ä½œç”¨ï¼Œéœ€è¦æœ‰åœ°æ–¹æ¥è§£æè¿™ä¸ªæ³¨è§£æ‰è¡Œï¼Œè€Œè¿™ä¸ªè§£æçš„æºå¤´å°±æ˜¯ <code>ConfigurationClassPostProcessor</code>ï¼ŒçœŸæ­£è§£ææ˜¯åœ¨ <code>ConfigurationClassParser</code> ä¸­</li>
<li>å‰é¢æœ‰è¯´è¿‡ <code>BeanDefinitionRegistryPostProcessors</code> æ¥å£çš„å®ç°ç±»å¯ä»¥æ‰¹é‡æ³¨å†Œ <code>BeanDefinition</code> è¢« <code>Spring</code> ç®¡ç†ï¼Œåœ¨ <code>ConfigurationClassParser</code> ä¸­å°† <code>@ComponentScan</code> æ¶‰åŠåˆ°çš„ç±»éƒ½è§£æå‡ºæ¥ä¹‹åï¼Œåˆšå¥½å°±å¯ä»¥æ³¨å†Œåˆ° <code>Spring</code> å®¹å™¨ä¸­</li>
</ol>
<p>ä»£ç æ‰§è¡Œæµç¨‹å¦‚ä¸‹</p>
<figure class="highlight axapta"><table><tr><td class="code"><pre><code class="hljs axapta">AbstractApplicationContext<span class="hljs-meta">#refresh</span><br>    AbstractApplicationContext<span class="hljs-meta">#invokeBeanFactoryPostProcessors</span><br>        <span class="hljs-keyword">public</span> PostProcessorRegistrationDelegate<span class="hljs-meta">#invokeBeanFactoryPostProcessors</span><br>            <span class="hljs-keyword">private</span> PostProcessorRegistrationDelegate<span class="hljs-meta">#invokeBeanDefinitionRegistryPostProcessors</span><br>                ConfigurationClassPostProcessor<span class="hljs-meta">#postProcessBeanDefinitionRegistry</span><br>                    ConfigurationClassPostProcessor<span class="hljs-meta">#processConfigBeanDefinitions</span><br>                        ConfigurationClassParser<span class="hljs-meta">#parse</span><br>                            ComponentScanAnnotationParser<span class="hljs-meta">#parse</span><br></code></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯ä»£ç çš„æ•´ä½“æ‰§è¡Œæµç¨‹ï¼Œ æœ€ç»ˆæ˜¯é€šè¿‡ <code>ComponentScanAnnotationParser</code> æ¥è¿›è¡Œè§£æ <code>@ComponentScan</code> æ³¨è§£çš„</p>
<h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3><p>ä¸Šé¢ä»£ç æ‰§è¡Œæµç¨‹ä¸­ï¼Œåœ¨ <code>PostProcessorRegistrationDelegate#invokeBeanDefinitionRegistryPostProcessors</code> ä¸­å¯ä»¥å¾—åˆ° <code>ConfigurationClassPostProcessor</code> ç±»ï¼Œä½†æ˜¯è¿™ä¸ªç±»æˆ‘ä»¬å¹¶æ²¡æœ‰æ‰‹åŠ¨è¿›è¡Œæ³¨å†Œã€‚</p>
<p>åœ¨ <code>AbstractApplicationContext</code> ä¸­æœ‰ <code>addBeanFactoryPostProcessor()</code> å¯ä»¥æ‰‹åŠ¨æ³¨å†Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultResourceLoader</span><br>		<span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableApplicationContext</span> &#123;<br>     <span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addBeanFactoryPostProcessor</span><span class="hljs-params">(BeanFactoryPostProcessor postProcessor)</span> &#123;<br>		Assert.notNull(postProcessor, <span class="hljs-string">&quot;BeanFactoryPostProcessor must not be null&quot;</span>);<br>		<span class="hljs-built_in">this</span>.beanFactoryPostProcessors.add(postProcessor);<br>	&#125;   <br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ‰€ä»¥è‚¯å®šæ˜¯ <code>Spring</code> åœ¨å“ªä¸ªæ­¥éª¤ä¸­è‡ªå·±æ³¨å†Œäº†ï¼Œè¦æƒ³æ‰¾åˆ°åœ¨å“ªé‡Œæ³¨å†Œçš„ä¹Ÿä¸éš¾ï¼Œé‚£å°±æ˜¯åœ¨ <code>ConfigurationClassPostProcessor</code> ç±»çš„ <code>postProcessBeanDefinitionRegistry()</code> æ–¹æ³•ä¸­æ‰“æ–­ç‚¹ï¼Œç„¶åçœ‹è°ƒç”¨æ ˆï¼Œå°±å¯ä»¥çŸ¥é“ <code>ConfigurationClassPostProcessor</code> å¯¹è±¡æ˜¯ä»å“ªé‡Œè·å–çš„ï¼Œä¸åŒçš„ä¸Šä¸‹æ–‡è®¾ç½®çš„æ–¹å¼å¯èƒ½ä¸åŒï¼Œåœ¨ç»™å‡ºç»“è®ºä¹‹å‰å†çœ‹ä¸€ä¸‹æˆ‘ä»¬çš„ä¸»ç±»æµ‹è¯•ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanFactoryPostProcessMain</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(BeanFactoryPostProcessMain.class);<br>        <span class="hljs-comment">// BeanFactoryPostProcessor çš„æµ‹è¯•ï¼ˆä¿®æ”¹äº† ScanComponent ç±»çš„ scope å±æ€§ï¼‰</span><br>        <span class="hljs-type">ScanComponent</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> context.getBean(ScanComponent.class);<br>        System.out.println(bean);<br>        <span class="hljs-type">ScanComponent</span> <span class="hljs-variable">bean2</span> <span class="hljs-operator">=</span> context.getBean(ScanComponent.class);<br>        System.out.println(bean2);<br><br>        <span class="hljs-type">RegisterComponent</span> <span class="hljs-variable">registerComponent</span> <span class="hljs-operator">=</span> context.getBean(RegisterComponent.class);<br>        registerComponent.sayHello(); <span class="hljs-comment">// ä¼šæ‰“å° &quot;RegisterComponent.sayHello&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä»æµ‹è¯•ä»£ç ä¸­çœ‹åˆ°ä¸Šä¸‹æ–‡å¯¹è±¡æ˜¯ <code>AnnotationConfigApplicationContext</code>, æ‰€ä»¥ä¸‹é¢ç»™å‡ºçš„ç»“è®ºä¹Ÿæ˜¯åŸºäºè¿™ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡, ä¸‹é¢ä»£ç æ‰§è¡Œæµç¨‹ä½¿ç”¨åºå·è¿›è¡Œæ ‡è®°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// new AnnotationConfigApplicationContext(classes) </span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">AnnotationConfigApplicationContext</span><span class="hljs-params">(Class&lt;?&gt;... componentClasses)</span> &#123;<br>    <span class="hljs-built_in">this</span>();  <span class="hljs-comment">// 1</span><br>    register(componentClasses);<br>    refresh();<br>&#125;<br><br><span class="hljs-comment">// AnnotationConfigApplicationContext ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">AnnotationConfigApplicationContext</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">StartupStep</span> <span class="hljs-variable">createAnnotatedBeanDefReader</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getApplicationStartup().start(<span class="hljs-string">&quot;spring.context.annotated-bean-reader.create&quot;</span>);<br>    <span class="hljs-built_in">this</span>.reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotatedBeanDefinitionReader</span>(<span class="hljs-built_in">this</span>); <span class="hljs-comment">// 2</span><br>    createAnnotatedBeanDefReader.end();<br>    <span class="hljs-built_in">this</span>.scanner = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathBeanDefinitionScanner</span>(<span class="hljs-built_in">this</span>);<br>&#125;<br><br><span class="hljs-comment">// AnnotatedBeanDefinitionReader ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">AnnotatedBeanDefinitionReader</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> &#123;<br>    <span class="hljs-built_in">this</span>(registry, getOrCreateEnvironment(registry)); <span class="hljs-comment">// 3</span><br>&#125;<br> <br><span class="hljs-comment">// AnnotatedBeanDefinitionReader ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">AnnotatedBeanDefinitionReader</span><span class="hljs-params">(BeanDefinitionRegistry registry, Environment environment)</span> &#123;<br>    Assert.notNull(registry, <span class="hljs-string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);<br>    Assert.notNull(environment, <span class="hljs-string">&quot;Environment must not be null&quot;</span>);<br>    <span class="hljs-built_in">this</span>.registry = registry;<br>    <span class="hljs-built_in">this</span>.conditionEvaluator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionEvaluator</span>(registry, environment, <span class="hljs-literal">null</span>);<br>    AnnotationConfigUtils.registerAnnotationConfigProcessors(<span class="hljs-built_in">this</span>.registry); <span class="hljs-comment">// 4</span><br>&#125;<br><br><span class="hljs-comment">// AnnotationConfigUtils ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerAnnotationConfigProcessors</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> &#123;<br>    registerAnnotationConfigProcessors(registry, <span class="hljs-literal">null</span>); <span class="hljs-comment">// 5</span><br>&#125;<br><br><span class="hljs-comment">// AnnotationConfigUtils ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Set&lt;BeanDefinitionHolder&gt; <span class="hljs-title function_">registerAnnotationConfigProcessors</span><span class="hljs-params">(</span><br><span class="hljs-params">			BeanDefinitionRegistry registry, <span class="hljs-meta">@Nullable</span> Object source)</span> &#123;<br>    <span class="hljs-comment">// public static final String CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME = &quot;org.springframework.context.annotation.internalConfigurationAnnotationProcessor&quot;;</span><br>    <span class="hljs-comment">// çœç•¥</span><br>    <span class="hljs-keyword">if</span> (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;<br>        <span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">def</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(ConfigurationClassPostProcessor.class);<br>        def.setSource(source);<br>        beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)); <span class="hljs-comment">// 6</span><br>    &#125;<br>    <span class="hljs-comment">// çœç•¥</span><br>    <span class="hljs-keyword">return</span> beanDefs;<br>&#125;<br><br><span class="hljs-comment">// AnnotationConfigUtils ç±»</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BeanDefinitionHolder <span class="hljs-title function_">registerPostProcessor</span><span class="hljs-params">(</span><br><span class="hljs-params">			BeanDefinitionRegistry registry, RootBeanDefinition definition, String beanName)</span> &#123;<br>    definition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);<br>    registry.registerBeanDefinition(beanName, definition); <span class="hljs-comment">// 7</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionHolder</span>(definition, beanName);<br>&#125;<br><br><span class="hljs-comment">// GenericApplicationContext ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinition</span><span class="hljs-params">(String beanName, BeanDefinition beanDefinition)</span><br>        <span class="hljs-keyword">throws</span> BeanDefinitionStoreException &#123;<br>    <span class="hljs-built_in">this</span>.beanFactory.registerBeanDefinition(beanName, beanDefinition); <span class="hljs-comment">// 8</span><br>&#125;<br><br><br><span class="hljs-comment">// DefaultListableBeanFactory ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinition</span><span class="hljs-params">(String beanName, BeanDefinition beanDefinition)</span><br>			<span class="hljs-keyword">throws</span> BeanDefinitionStoreException &#123;<br>    <span class="hljs-comment">// çœç•¥</span><br>    <span class="hljs-built_in">this</span>.beanDefinitionNames.add(beanName); <span class="hljs-comment">// 9 </span><br>    <span class="hljs-comment">// çœç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>è‡³æ­¤å·²ç»çŸ¥é“ <code>ConfigurationClassPostProcessor</code> æ˜¯åœ¨ä½•å¤„æ·»åŠ çš„ï¼Œè€Œä¸” <code>ConfigurationClassPostProcessor</code> ç±»å¯¹åº”çš„ <code>beanName</code> æ˜¯ <code>org.springframework.context.annotation.internalConfigurationAnnotationProcessor</code></p>
]]></content>
      <categories>
        <category>java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Springä¸Šä¸‹æ–‡refreshæ–¹æ³•è§£æ</title>
    <url>/2023/b93a520f6ddc/index.html</url>
    <content><![CDATA[<p>æœ¬æ–‡ä¸»è¦è®°å½• <code>AbstractApplicationContext#refresh()</code> æ–¹æ³•ä¸­æ¯ä¸ªæ­¥éª¤çš„ä½œç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException &#123;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.startupShutdownMonitor) &#123;<br>        <span class="hljs-type">StartupStep</span> <span class="hljs-variable">contextRefresh</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationStartup.start(<span class="hljs-string">&quot;spring.context.refresh&quot;</span>);<br><br>        <span class="hljs-comment">/** </span><br><span class="hljs-comment">         * 1. å‡†å¤‡åˆ·æ–°ä¸Šä¸‹æ–‡æ–¹æ³•,ç”¨äºè®¾ç½®å‡†å¤‡åˆ·æ–°å‰çš„ä¸€äº›å‚æ•°:</span><br><span class="hljs-comment">		 * ç¨‹åºå¯åŠ¨æ ‡å¿—ä½/ä¸Šä¸‹æ–‡æ‹“å±•èµ„æºåŠ è½½/ä¸Šä¸‹æ–‡ç¯å¢ƒå‡†å¤‡æƒ…å†µéªŒè¯/ç›‘å¬å™¨ç›‘å¬äº‹ä»¶å®¹å™¨åˆå§‹åŒ–å‡†å¤‡</span><br><span class="hljs-comment">         */</span><br>        prepareRefresh();<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 2. æ„å»º BeanFactory å®¹å™¨, é»˜è®¤ä½¿ç”¨çš„ DefaultListableBeanFactory</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">ConfigurableListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> obtainFreshBeanFactory();<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 3. å‡†å¤‡ BeanFactory å®¹å™¨, ä¸»è¦æ˜¯å¯¹ BeanFactory è¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œ</span><br><span class="hljs-comment">         */</span><br>        prepareBeanFactory(beanFactory);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 4. åå¤„ç† BeanFactory å®¹å™¨, ä¸»è¦æ˜¯å¯¹ BeanFactory è¿›è¡Œä¸€äº›åå¤„ç†æ“ä½œ</span><br><span class="hljs-comment">             */</span><br>            postProcessBeanFactory(beanFactory);<br><br>            <span class="hljs-type">StartupStep</span> <span class="hljs-variable">beanPostProcess</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationStartup.start(<span class="hljs-string">&quot;spring.context.beans.post-process&quot;</span>);<br>            <br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 5. æ‰§è¡ŒBeanFactoryåç½®å¤„ç†. <span class="hljs-doctag">@ComponentScan</span> çš„è§£æå°±æ˜¯é€šè¿‡åç½®å¤„ç†å™¨ ConfigurationClassPostProcessor å®Œæˆ</span><br><span class="hljs-comment">             */</span><br>            invokeBeanFactoryPostProcessors(beanFactory);<br><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 6. æ³¨å†Œ BeanPostProcessor åˆ° bean å·¥å‚ä¸­</span><br><span class="hljs-comment">             */</span><br>            registerBeanPostProcessors(beanFactory);<br>            beanPostProcess.end();<br><br>        <br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 7. åˆå§‹åŒ– MessageSource èµ„æºï¼Œå›½é™…åŒ–ç›¸å…³çš„å¤„ç†</span><br><span class="hljs-comment">             */</span><br>            initMessageSource();<br><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * </span><br><span class="hljs-comment">             * 8. åˆå§‹åŒ– ApplicationEventMulticaster äº‹ä»¶å¹¿æ’­å™¨</span><br><span class="hljs-comment">             */</span><br>            initApplicationEventMulticaster();<br><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 9. å­ç±»å®ç°,springbootstarterwebåœ¨æ­¤åˆ›å»ºwebå®¹å™¨,å¹¶æå‰ç”Ÿæˆå®¹å™¨æ‰€éœ€çš„BeanåŠå…¶å¯¹åº”ç”Ÿå‘½å‘¨æœŸ</span><br><span class="hljs-comment">             */</span><br>            onRefresh();<br><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 10. ç»™å¹¿æ’­å™¨ä¸­æ³¨å†Œç›‘å¬å™¨,æ‰§è¡ŒåˆæœŸäº‹ä»¶</span><br><span class="hljs-comment">             */</span><br>            registerListeners();<br><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 11. åˆå§‹åŒ–æ‰€æœ‰éæ‡’åŠ è½½å•ä¾‹Bean</span><br><span class="hljs-comment">             */</span><br>            finishBeanFactoryInitialization(beanFactory);<br><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 12. å®Œæˆåˆ·æ–°,å‘å¸ƒä¸Šä¸‹æ–‡åˆ·æ–°å®Œæ¯•äº‹ä»¶</span><br><span class="hljs-comment">             */</span><br>            finishRefresh();<br>        &#125;<br><br>        <span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>            <span class="hljs-comment">// çœç•¥</span><br>        &#125;<br><br>        <span class="hljs-keyword">finally</span> &#123;<br>            resetCommonCaches();<br>            contextRefresh.end();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Springä¸­Beançš„ç”Ÿå‘½å‘¨æœŸè¯¦è§£</title>
    <url>/2023/160e87d42e42/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p>springç‰ˆæœ¬ 6.x</p>
<h2 id="Spring-çš„-Bean-ç”Ÿå‘½å‘¨æœŸæœ‰å“ªå‡ ä¸ªé˜¶æ®µ"><a href="#Spring-çš„-Bean-ç”Ÿå‘½å‘¨æœŸæœ‰å“ªå‡ ä¸ªé˜¶æ®µ" class="headerlink" title="Spring çš„ Bean ç”Ÿå‘½å‘¨æœŸæœ‰å“ªå‡ ä¸ªé˜¶æ®µ"></a>Spring çš„ Bean ç”Ÿå‘½å‘¨æœŸæœ‰å“ªå‡ ä¸ªé˜¶æ®µ</h2><p>æ‰€è°“çš„ Bean çš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯ Bean åœ¨æ•´ä¸ªåº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸­æ‰€ç»å†çš„å„ç§çŠ¶æ€ï¼Œä»åˆ›å»ºã€åˆå§‹åŒ–ã€ä½¿ç”¨ã€é”€æ¯ç­‰å„ä¸ªé˜¶æ®µã€‚</p>
<pre class="mermaid">flowchart LR
    subgraph A["åˆ›å»º"]
        style A fill:#f9f
        direction LR
        A1["å®ä¾‹åŒ–Bean[createBeanInstance()æ–¹æ³•]"]
        subgraph A2["åˆå§‹åŒ–è¿‡ç¨‹"]
            style A2 fill:#8ff600
            direction TB
            A21["è®¾ç½®å±æ€§å€¼ populateBean() æ–¹æ³•"]
            A22["è°ƒç”¨å¯¹åº”çš„ Aware æ¥å£ "]
            A23[" BeanPostProcessor å‰ç½®å¤„ç† "]
            A24[" InitializingBean çš„ afterPropertiesSet() æ–¹æ³• "]
            A25[" è‡ªå®šä¹‰ init-method æ–¹æ³• "]
            A26[" BeanPostProcessor åç½®å¤„ç† "]
            A21-->A22-->A23-->A24-->A25-->A26
        end
        A3["æ³¨å†Œ Destruction å›è°ƒ"]
        A1-->A2-->A3
    end
    B[" \nä½¿ç”¨ \n\n"]
    subgraph C["é”€æ¯"]
        direction TB
        C1["DisposableBean#destroy()"]
        C2["è‡ªå®šä¹‰destroy-method"]
        C1-->C2
    end
    A-->B-->C</pre>

<h2 id="Bean-ç”Ÿå‘½å‘¨æœŸä»£ç ç¤ºä¾‹"><a href="#Bean-ç”Ÿå‘½å‘¨æœŸä»£ç ç¤ºä¾‹" class="headerlink" title="Bean ç”Ÿå‘½å‘¨æœŸä»£ç ç¤ºä¾‹"></a>Bean ç”Ÿå‘½å‘¨æœŸä»£ç ç¤ºä¾‹</h2><p>ç¤ºä¾‹ä»£ç åŒ…å«ä»¥ä¸‹å‡ ä¸ªç±»</p>
<ol>
<li><code>LifeCycleBean</code> ä¸»è¦æ˜¯è§‚å¯Ÿè¯¥ç±»åˆ›å»º Bean çš„è¿‡ç¨‹ï¼Œè¯¥ç±»å®ç°äº† <code>ApplicationContextAware</code>, <code>InitializingBean</code>, <code>DisposableBean</code> æ¥å£</li>
<li><code>CusBeanPostProcessor</code> è¯¥ç±»å®ç°äº† <code>BeanPostProcessor</code> æ¥å£</li>
<li><code>LifeCycleMain</code> æµ‹è¯•ä¸»ç±»</li>
</ol>
<figure class="highlight java"><figcaption><span>LifeCycleBeanç±»</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LifeCycleBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span>, InitializingBean, DisposableBean &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LifeCycleBean</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;æ‰§è¡Œæ„é€ æ–¹æ³• &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;@PostConstruct init&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;DisposableBean -- destroy &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;InitializingBean afterPropertiesSet &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        System.out.println(<span class="hljs-string">&quot;ApplicationContextAware setApplicationContext&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>CusBeanPostProcessorç±»</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusBeanPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanPostProcessor</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        System.out.println(<span class="hljs-string">&quot;CusBeanPostProcessor before, current beanName:&quot;</span> + beanName);<br>        <span class="hljs-keyword">return</span> BeanPostProcessor.<span class="hljs-built_in">super</span>.postProcessBeforeInitialization(bean, beanName);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        System.out.println(<span class="hljs-string">&quot;CusBeanPostProcessor after, current beanName:&quot;</span> + beanName);<br>        <span class="hljs-keyword">return</span> BeanPostProcessor.<span class="hljs-built_in">super</span>.postProcessAfterInitialization(bean, beanName);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>LifeCycleMainæµ‹è¯•ä¸»ç±»</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LifeCycleMain</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(LifeCycleMain.class);<br>        <span class="hljs-type">LifeCycleBean</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> context.getBean(LifeCycleBean.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">æ‰§è¡Œæ„é€ æ–¹æ³• <br>ApplicationContextAware setApplicationContext<br>CusBeanPostProcessor <span class="hljs-keyword">before</span>, <span class="hljs-keyword">current</span> beanName:lifeCycleBean<br>@PostConstruct init<br>InitializingBean afterPropertiesSet <br>CusBeanPostProcessor <span class="hljs-keyword">after</span>, <span class="hljs-keyword">current</span> beanName:lifeCycleBean<br></code></pre></td></tr></table></figure>

<p>ä»ä¸Šè¿°æµ‹è¯•ä»£ç æ¥çœ‹ï¼Œåœ¨åˆ›å»º <code>LifeCycleBean</code> è¿™ä¸ª Bean è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œé¡ºåºæ˜¯</p>
<ol>
<li>æ‰§è¡Œå¯¹åº”ç±»çš„æ„é€ æ–¹æ³•</li>
<li>æ‰§è¡Œå¯¹åº” Aware æ¥å£çš„æ–¹æ³•</li>
<li>æ‰§è¡Œ BeanPostProcessor å‰ç½®å¤„ç†æ–¹æ³•</li>
<li>æ‰§è¡Œ <code>@PostConstruct</code> æ³¨è§£å®šä¹‰çš„æ–¹æ³•</li>
<li>æ‰§è¡Œ InitializingBean ä¸­çš„ afterPropertiesSet æ–¹æ³•</li>
<li>æ‰§è¡Œ BeanPostProcessor åç½®å¤„ç†æ–¹æ³•</li>
</ol>
<h2 id="Spring-Bean-ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œæµç¨‹"><a href="#Spring-Bean-ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œæµç¨‹" class="headerlink" title="Spring Bean ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œæµç¨‹"></a>Spring Bean ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œæµç¨‹</h2><figure class="highlight leaf"><table><tr><td class="code"><pre><code class="hljs leaf">AbstractApplicationContext<span class="hljs-punctuation">#</span><span class="hljs-keyword">refresh</span><br>    AbstractApplicationContext<span class="hljs-punctuation">#</span><span class="hljs-keyword">finishBeanFactoryInitialization</span><br>        DefaultListableBeanFactory<span class="hljs-punctuation">#</span><span class="hljs-keyword">preInstantiateSingletons</span><br>            AbstractBeanFactory<span class="hljs-punctuation">#</span><span class="hljs-keyword">getBean</span><span class="hljs-params">(<span class="hljs-variable">java</span>.<span class="hljs-variable">lang</span>.<span class="hljs-variable">String</span>)</span><br>                AbstractBeanFactory<span class="hljs-punctuation">#</span><span class="hljs-keyword">doGetBean</span><br>                    DefaultSingletonBeanRegistry<span class="hljs-punctuation">#</span><span class="hljs-keyword">getSingleton</span><span class="hljs-params">(<span class="hljs-variable">ObjectFactory</span><span class="hljs-operator">&lt;</span>?<span class="hljs-operator">&gt;</span>)</span><br>                        AbstractAutowireCapableBeanFactory<span class="hljs-punctuation">#</span><span class="hljs-keyword">createBean</span><span class="hljs-params">(<span class="hljs-variable">String</span> <span class="hljs-variable">beanName</span>, <span class="hljs-variable">RootBeanDefinition</span>, <span class="hljs-variable">java</span>.<span class="hljs-variable">lang</span>.<span class="hljs-variable">Object</span>[])</span><br>                            AbstractAutowireCapableBeanFactory<span class="hljs-punctuation">#</span><span class="hljs-keyword">doCreateBean</span><br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°æµç¨‹æ˜¯åˆ›å»º Bean çš„è°ƒç”¨è¿‡ç¨‹ï¼Œæœ€ç»ˆæ˜¯åœ¨ <code>AbstractAutowireCapableBeanFactory</code> ä¸­è°ƒç”¨ <code>doCreateBean</code> æ–¹æ³•æ¥åˆ›å»ºï¼Œæ‰€ä»¥ç›´æ¥çœ‹ä¸‹è¿™éƒ¨åˆ†ä»£ç ï¼ˆçœç•¥å’Œæ­¤æ¬¡æµç¨‹æ— å…³ä»£ç ï¼‰</p>
<figure class="highlight java"><figcaption><span>AbstractAutowireCapableBeanFactoryç±»</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">doCreateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span><br>        <span class="hljs-keyword">throws</span> BeanCreationException &#123;<br><br>    <span class="hljs-comment">// Instantiate the bean.</span><br>    <span class="hljs-type">BeanWrapper</span> <span class="hljs-variable">instanceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (instanceWrapper == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// æ­¥éª¤1ï¼š å®ä¾‹åŒ– Bean</span><br>        instanceWrapper = createBeanInstance(beanName, mbd, args);<br>    &#125;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> instanceWrapper.getWrappedInstance();<br>    Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();<br>    <span class="hljs-keyword">if</span> (beanType != NullBean.class) &#123;<br>        mbd.resolvedTargetType = beanType;<br>    &#125;<br><br>    <span class="hljs-comment">// Initialize the bean instance.</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">exposedObject</span> <span class="hljs-operator">=</span> bean;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// æ­¥éª¤2ï¼š è®¾ç½®å±æ€§</span><br>        populateBean(beanName, mbd, instanceWrapper);<br>        <span class="hljs-comment">// æ­¥éª¤3ï¼š è°ƒç”¨ aware æ¥å£ -ã€‹è°ƒç”¨ BeanPostProcessor å‰ç½®æ–¹æ³•</span><br>        <span class="hljs-comment">// -ã€‹ è°ƒç”¨  InitializingBean çš„ afterPropertiesSet æ–¹æ³•</span><br>        <span class="hljs-comment">// -ã€‹ è°ƒç”¨  è‡ªå®šä¹‰çš„ init-method æ–¹æ³•</span><br>        <span class="hljs-comment">// -ã€‹ è°ƒç”¨  è‡ªå®šä¹‰çš„ init-method æ–¹æ³•</span><br>        <span class="hljs-comment">// -ã€‹ è°ƒç”¨ BeanPostProcessor åç½®æ–¹æ³•</span><br>        exposedObject = initializeBean(beanName, exposedObject, mbd);<br>    &#125;<br><br>    <span class="hljs-comment">// Register bean as disposable.</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// æ­¥éª¤4ï¼š æ³¨å†Œé”€æ¯æ–¹æ³•</span><br>        registerDisposableBeanIfNecessary(beanName, bean, mbd);<br>    &#125;<br>    <span class="hljs-keyword">return</span> exposedObject;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å®ä¾‹åŒ–(<strong>æ­¥éª¤1</strong>)å’Œè®¾ç½®å±æ€§å€¼(<strong>æ­¥éª¤2</strong>) å°±ä¸çœ‹äº†ï¼Œä¸»è¦çœ‹ä¸€ä¸‹ <strong>æ­¥éª¤3</strong>ï¼Œè¿™ä¸ªæ­¥éª¤åŒ…å«äº† Bean ç”Ÿå‘½å‘¨æœŸä¸­æ•´ä¸ªåˆå§‹åŒ–è¿‡ç¨‹</p>
<figure class="highlight java"><figcaption><span>AbstractAutowireCapableBeanFactoryç±»</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">initializeBean</span><span class="hljs-params">(String beanName, Object bean, <span class="hljs-meta">@Nullable</span> RootBeanDefinition mbd)</span> &#123;<br>    <span class="hljs-comment">// æ­¥éª¤3.1 è°ƒç”¨å¯¹åº”çš„ Aware æ¥å£</span><br>    invokeAwareMethods(beanName, bean);<br><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">wrappedBean</span> <span class="hljs-operator">=</span> bean;<br>    <span class="hljs-keyword">if</span> (mbd == <span class="hljs-literal">null</span> || !mbd.isSynthetic()) &#123;<br>        <span class="hljs-comment">// æ­¥éª¤3.2 è°ƒç”¨ BeanPostProcessor å‰ç½®æ–¹æ³•</span><br>        wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// æ­¥éª¤3.3 è°ƒç”¨ InitializingBean çš„ afterPropertiesSet æ–¹æ³• å’Œ è‡ªå®šä¹‰çš„ init-method æ–¹æ³•</span><br>        invokeInitMethods(beanName, wrappedBean, mbd);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>                (mbd != <span class="hljs-literal">null</span> ? mbd.getResourceDescription() : <span class="hljs-literal">null</span>), beanName, ex.getMessage(), ex);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (mbd == <span class="hljs-literal">null</span> || !mbd.isSynthetic()) &#123;<br>        <span class="hljs-comment">// æ­¥éª¤3.4 è°ƒç”¨ BeanPostProcessor åç½®æ–¹æ³•</span><br>        wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> wrappedBean;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>æ­¥éª¤3.3</strong> ä¸­æ˜¯è°ƒç”¨ <code>InitializingBean</code> çš„ <code>afterPropertiesSet</code> æ–¹æ³• å’Œ è‡ªå®šä¹‰çš„ <code>init-method</code> æ–¹æ³•ï¼Œ è°ƒç”¨ <code>InitializingBean</code> æ¥å£çš„æ–¹æ³•è¿˜æ¯”è¾ƒå¥½è¯´ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯è‡ªå®šä¹‰çš„ <code>init-method</code> æ–¹æ³•å‘¢ï¼Ÿçœ‹å¦‚ä¸‹ç¤ºä¾‹ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  è¿™æ˜¯ä¸€ä¸ª æ™®é€š ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LifeCycleBean</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initMethod</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;LifeCycleBean initMethod&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroyMethod</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;LifeCycleBean destroyMethod&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;LifeCycleBean sayHello&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LifeCycleMain</span> &#123;<br><br>    <span class="hljs-comment">// ä½¿ç”¨ @Bean æ³¨å…¥ LifeCycleBean ç±»ï¼ŒåŒæ—¶æ·»åŠ äº† initMethod å’Œ destroyMethod æ–¹æ³•</span><br>    <span class="hljs-meta">@Bean(initMethod = &quot;initMethod&quot;, destroyMethod=&quot;destroyMethod&quot;)</span><br>    <span class="hljs-keyword">public</span> LifeCycleBean <span class="hljs-title function_">lifeCycleBean</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LifeCycleBean</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(LifeCycleMain.class);<br>        context.getBean(LifeCycleBean.class).sayHello();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">LifeCycleBean initMethod</span><br><span class="hljs-attribute">LifeCycleBean sayHello</span><br></code></pre></td></tr></table></figure>

<p>é‡ç‚¹æ‰§è¡Œæµç¨‹å¯¼è‡´å°±ç»“æŸäº†</p>
]]></content>
      <categories>
        <category>java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Springä¸­DeferredImportSelectoræºç è§£æ</title>
    <url>/2023/55186be8f39b/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p>Springç‰ˆæœ¬: 6.0.6</p>
<p><code>DeferredImportSelector</code> æ˜¯ <code>ImportSelector</code> çš„å­æ¥å£ï¼Œæ‰€ä»¥éœ€è¦å…ˆäº†è§£ <code>ImportSelector</code> çš„ä½œç”¨ï¼Œå¯ä»¥å‚è€ƒ <ol><li><a href="/2023/73d35f59945c/index.html" title="Springä¸­Importæ³¨è§£æºç è§£æ">Springä¸­Importæ³¨è§£æºç è§£æ</a></li></ol></p>
<h2 id="ç®€è¿°-ImportSelector-çš„ä½œç”¨"><a href="#ç®€è¿°-ImportSelector-çš„ä½œç”¨" class="headerlink" title="ç®€è¿° ImportSelector çš„ä½œç”¨"></a>ç®€è¿° ImportSelector çš„ä½œç”¨</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ImportSelector</span> &#123;<br><br>	String[] selectImports(AnnotationMetadata importingClassMetadata);<br><br>	<span class="hljs-meta">@Nullable</span><br>	<span class="hljs-keyword">default</span> Predicate&lt;String&gt; <span class="hljs-title function_">getExclusionFilter</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œç›´æ¥æ€»ç»“ä¸€ä¸‹ <code>ImportSelector</code> çš„ä½œç”¨ï¼Œ<code>selectImports()</code> æ–¹æ³•è¿”å›å€¼æ˜¯éœ€è¦å¯¼å…¥çš„ç±»çš„å…¨é™å®šç±»åç»„æˆçš„æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æ‰¹é‡æ³¨å†Œæ™®é€šç±»ç»™ <code>Spring</code> è¿›è¡Œç®¡ç†ï¼Œ <code>getExclusionFilter()</code> åˆ™æ˜¯å¯ä»¥è¿‡æ»¤æ‰ä¸æƒ³è¦æ³¨å†Œçš„ç±»</p>
<h2 id="DeferredImportSelector-å’Œ-ImportSelector-çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ"><a href="#DeferredImportSelector-å’Œ-ImportSelector-çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ" class="headerlink" title="DeferredImportSelector å’Œ ImportSelector çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ"></a>DeferredImportSelector å’Œ ImportSelector çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ</h2><p>å…ˆçœ‹ä¸€ä¸‹ <code>DeferredImportSelector</code> æ¥å£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DeferredImportSelector</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ImportSelector</span> &#123;<br>	<span class="hljs-meta">@Nullable</span><br>	<span class="hljs-keyword">default</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Group</span>&gt; getImportGroup() &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Group</span> &#123;<br>        <span class="hljs-comment">// ç¬¬äºŒä¸ªå‚æ•° selector å°±æ˜¯å¯¹åº” DeferredImportSelector å®ç°ç±»</span><br>		<span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(AnnotationMetadata metadata, DeferredImportSelector selector)</span>;<br><br>        <span class="hljs-comment">// è¿”å›éœ€è¦è¢«å¯¼å…¥çš„ç±»å…¨é™å®šç±»åï¼Œå°±å’Œ ImportSelector æ¥å£ä¸­çš„ selectImports æ–¹æ³•ç±»ä¼¼</span><br>		Iterable&lt;Entry&gt; <span class="hljs-title function_">selectImports</span><span class="hljs-params">()</span>;<br><br>        <span class="hljs-comment">// Entry å°±æ˜¯ç”¨æ¥ä¿å­˜éœ€è¦å¯¼å…¥çš„ç±»çš„å…¨é™å®šç±»åå’Œ å…ƒæ•°æ®ä¿¡æ¯</span><br>		<span class="hljs-keyword">class</span> <span class="hljs-title class_">Entry</span> &#123;<br>			<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AnnotationMetadata metadata;<br>			<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String importClassName;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li><p>è¡¨é¢ä¸Šçœ‹æ¥ <code>DeferredImportSelector</code> ä¸ <code>ImportSelector</code> çš„åŒºåˆ«æ˜¯ <code>DeferredImportSelector</code> ä¸­å¤šäº†ä¸€ä¸ªå†…éƒ¨æ¥å£</p>
</li>
<li><p>å®é™…æ˜¯æ˜¯ <code>DeferredImportSelector</code> å’Œ <code>ImportSelector</code> çš„æ‰§è¡Œæ—¶æœºä¸ä¸€æ ·</p>
<ol>
<li><code>ImportSelector</code> æ˜¯åœ¨è§£æå¯¹åº”çš„å®ç°ç±»æ—¶å°±ä¼šç›´æ¥å¤„ç†éœ€è¦å¯¼å…¥çš„ç±»</li>
<li><code>DeferredImportSelector</code> æ˜¯æä¾›äº†ä¸€ç§å»¶è¿Ÿå¯¼å…¥é…ç½®ç±»çš„æœºåˆ¶ï¼Œ<code>SpringBoot</code> çš„è‡ªåŠ¨è£…é…å°±æ˜¯ç”¨åˆ°äº† <code>DeferredImportSelector</code> å»¶è¿Ÿå¯¼å…¥çš„åŠŸèƒ½ï¼Œè¿™ä¸ªå»¶è¿Ÿçš„æ„æ€æ˜¯ï¼Œéè‡ªåŠ¨è£…é…çš„ç±»éƒ½è§£æå®Œæˆä¹‹åæ‰ä¼šå»å¯¼å…¥è‡ªåŠ¨è£…é…çš„ç±»ï¼Œå…·ä½“æºç ä¼šåœ¨ä¸‹é¢è¯´æ˜</li>
</ol>
</li>
<li><p>é™¤äº†å»¶è¿Ÿå¯¼å…¥æœºåˆ¶ï¼Œå¦‚æœ <code>DeferredImportSelector</code> å®ç°ç±»æ²¡æœ‰å®ç° <code>Group</code> æ¥å£çš„è¯ï¼Œå…¶ä»–æ–¹æ³•å’Œ <code>ImportSelector</code> ä¸€æ ·ï¼Œå› ä¸ºå½“æ²¡æœ‰å®ç° <code>Group</code> æ¥å£æ—¶ä¼šä½¿ç”¨ <code>Spring</code> æä¾›çš„é»˜è®¤çš„å®ç°ç±» <code>DefaultDeferredImportSelectorGroup</code>, å¯ä»¥ä»ä¸‹é¢ä»£ç çœ‹åˆ°é»˜è®¤çš„å®ç°ä¸­ <code>process()</code> æ–¹æ³•ç›´æ¥è°ƒç”¨çš„å°±æ˜¯ <code>selector.selectImports()</code> æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯ç›´æ¥è°ƒç”¨çš„å°±æ˜¯ <code>ImportSelector</code> æ¥å£çš„ <code>selectImports()</code> æ–¹æ³•ï¼Œå› æ­¤æ­¤æ—¶å’Œ <code>ImportSelector</code> æ¥å£åœ¨åŠŸèƒ½ä¸Šæ˜¯ä¸€è‡´çš„ã€å½“ç„¶ï¼Œæ‰§è¡Œæ—¶æœºè¿˜æ˜¯ä¸åŒã€‘</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultDeferredImportSelectorGroup</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Group</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Entry&gt; imports = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(AnnotationMetadata metadata, DeferredImportSelector selector)</span> &#123;<br>        <span class="hljs-keyword">for</span> (String importClassName : selector.selectImports(metadata)) &#123;<br>            <span class="hljs-built_in">this</span>.imports.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(metadata, importClassName));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Iterable&lt;Entry&gt; <span class="hljs-title function_">selectImports</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.imports;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="DeferredImportSelector-ä½¿ç”¨ç¤ºä¾‹"><a href="#DeferredImportSelector-ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="DeferredImportSelector ä½¿ç”¨ç¤ºä¾‹"></a>DeferredImportSelector ä½¿ç”¨ç¤ºä¾‹</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ™®é€šçš„ç±»ï¼Œè¿™ä¸ªç±»æ²¡æœ‰ä»»ä½•æ³¨è§£ï¼Œå°±æ˜¯ä¸ºäº†è®© DeferredImportSelector æ¥å¯¼å…¥çš„</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefImportBean</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;DefImportBean sayHello&quot;</span>);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">// å®ç°äº† DeferredImportSelector æ¥å£çš„ç±»ï¼Œè¿™ä¸ªç±»çš„ä½œç”¨æ˜¯ä¸ºäº†å¯¼å…¥ DefImportBean ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusDeferredImportSelector</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DeferredImportSelector</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;<br>        System.out.println(<span class="hljs-string">&quot;å®é™…å¯¼å…¥ --- 2&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;DefImportBean.class.getName()&#125;;<br>    &#125;<br><br>    <span class="hljs-comment">// è‡ªå®šä¹‰å¯¼å…¥åˆ†ç»„ï¼Œè¿™ä»£è¡¨ä¸ä½¿ç”¨é»˜è®¤çš„DefaultDeferredImportSelectorGroupï¼Œ å¦‚æœæ²¡æœ‰å¯¼å…¥å°±ç®—å†™äº† Group å®ç°ç±»ä¹Ÿä¸ä¼šä½¿ç”¨çš„</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Group</span>&gt; getImportGroup() &#123;<br>        <span class="hljs-keyword">return</span> CusImportSelectorBeanGroup.class;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusImportSelectorBeanGroup</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DeferredImportSelector</span>.Group &#123;<br>        <span class="hljs-comment">// ç”¨æ¥ä¿å­˜éœ€è¦å¯¼å…¥çš„ç±»</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Entry&gt; instanceImports = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(AnnotationMetadata metadata, DeferredImportSelector selector)</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;ä½¿ç”¨äº†è‡ªå®šä¹‰çš„åˆ†ç»„ ----  1&quot;</span>);<br>            <span class="hljs-keyword">for</span> (String importClassName : selector.selectImports(metadata)) &#123;<br>                <span class="hljs-built_in">this</span>.instanceImports.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(metadata, importClassName));<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Iterable&lt;Entry&gt; <span class="hljs-title function_">selectImports</span><span class="hljs-params">()</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;çœŸæ­£è¿”å› -- 3&quot;</span>);<br>            <span class="hljs-keyword">return</span> instanceImports;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ä¸»ç±»ï¼Œä½¿ç”¨äº† Import å¯¼å…¥äº† å®ç°äº† CusDeferredImportSelector æ¥å£çš„ç±»</span><br><span class="hljs-meta">@ComponentScan</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Import(CusDeferredImportSelector.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefImportMain</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(DefImportMain.class);<br>        <span class="hljs-type">DefImportBean</span> <span class="hljs-variable">defImportBean</span> <span class="hljs-operator">=</span> context.getBean(DefImportBean.class);<br>        defImportBean.sayHello();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœï¼š</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><code class="hljs ada">ä½¿ç”¨äº†è‡ªå®šä¹‰çš„åˆ†ç»„ <span class="hljs-comment">----  1</span><br>å®é™…å¯¼å…¥ <span class="hljs-comment">--- 2</span><br>çœŸæ­£è¿”å› <span class="hljs-comment">-- 3</span><br>DefImportBean sayHello<br></code></pre></td></tr></table></figure>

<p>ä»æ‰“å°ç»“æœä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°å®ç°äº† <code>DeferredImportSelector</code> æ¥å£çš„ç±»çš„æ‰§è¡Œé¡ºåºå¦‚ä¸‹</p>
<pre class="mermaid">flowchart TB
    A["Groupå®ç°ç±»ä¸­çš„ process() æ–¹æ³•"]
    B["DeferredImportSelectorå®ç°ç±» 
     ä¸­çš„ selectImports() æ–¹æ³• 
     ï¼ˆè¯¥æ–¹æ³•ä¸ä¸€å®šæ‰§è¡Œï¼Œå½“ Group å®ç°ç±»ä¸­
     æœ‰è°ƒç”¨çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œï¼Œæ²¡æœ‰è°ƒç”¨å°±æ²¡æœ‰æ‰§è¡Œ
     SpringBootè‡ªåŠ¨è£…é…æ—¶å°±æ²¡æœ‰æ‰§è¡Œ selectImports() æ–¹æ³•ï¼‰"]
    C["Groupå®ç°ç±»ä¸­çš„ selectImports() æ–¹æ³•
    è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼æ‰æ˜¯çœŸæ­£è¦è¢«
    å¯¼å…¥çš„ç±»"]
    A-->B-->C</pre>

<h2 id="DeferredImportSelector-æ‰§è¡Œæµç¨‹æºç è§£æ"><a href="#DeferredImportSelector-æ‰§è¡Œæµç¨‹æºç è§£æ" class="headerlink" title="DeferredImportSelector æ‰§è¡Œæµç¨‹æºç è§£æ"></a>DeferredImportSelector æ‰§è¡Œæµç¨‹æºç è§£æ</h2><p>åœ¨æºç åˆ†æä¹‹å‰å…ˆç†Ÿæ‚‰ä¸€ä¸‹ä¼šæ¶‰åŠåˆ°çš„å‡ ä¸ªç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeferredImportSelectorHolder</span> &#123;<br>    <span class="hljs-comment">// é…ç½®ä¸»ç±»ï¼Œåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­å°±æ˜¯ DefImportMain å¯¹åº”çš„ ConfigurationClass</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConfigurationClass configurationClass;<br>    <span class="hljs-comment">// ä¿å­˜çš„å°±æ˜¯ DeferredImportSelector å®ç°ç±»</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DeferredImportSelector importSelector;<br>&#125;<br><br><br><span class="hljs-comment">// å‰é¢æœ‰è¯´è¿‡ DeferredImportSelector æ˜¯ä¼šå»¶è¿Ÿæ³¨å…¥çš„ï¼Œæ—¢ç„¶è¦å»¶è¿Ÿï¼Œé‚£å°±éœ€è¦å…ˆå°†å…¶å­˜åœ¨ä¸€ä¸ªåœ°æ–¹ï¼ŒDeferredImportSelectorHandler ç±»å°±æ˜¯ä¿å­˜æ‰€æœ‰çš„ DeferredImportSelector å®ç°ç±»</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeferredImportSelectorHandler</span> &#123;<br>	<span class="hljs-keyword">private</span> List&lt;DeferredImportSelectorHolder&gt; deferredImportSelectors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>DeferredImportSelector</code> çš„è§£æå…¶å®æ˜¯é€šè¿‡ <code>BeanFactory</code> çš„åç½®å¤„ç†å™¨å®ç°çš„ï¼Œå¯¹åº”çš„ <code>BeanFactory</code> åç½®å¤„ç†å™¨ç±»æ˜¯ <code>ConfigurationClassPostProcessor</code>ï¼Œè€Œè§£æ <code>Import</code> æ³¨è§£çš„ç±»åˆ™æ˜¯ <code>ConfigurationClassParser</code>ï¼Œè¿™é‡Œå†ç®€å•å†™ä¸€ä¸‹è§£æé¡ºåºæµç¨‹</p>
<figure class="highlight leaf"><table><tr><td class="code"><pre><code class="hljs leaf">AbstractApplicationContext<span class="hljs-punctuation">#</span><span class="hljs-keyword">refresh</span><br>    AbstractApplicationContext<span class="hljs-punctuation">#</span><span class="hljs-keyword">invokeBeanFactoryPostProcessors</span><br>        public PostProcessorRegistrationDelegate<span class="hljs-punctuation">#</span><span class="hljs-keyword">invokeBeanFactoryPostProcessors</span><br>            private PostProcessorRegistrationDelegate<span class="hljs-punctuation">#</span><span class="hljs-keyword">invokeBeanDefinitionRegistryPostProcessors</span><br>                ConfigurationClassPostProcessor<span class="hljs-punctuation">#</span><span class="hljs-keyword">postProcessBeanDefinitionRegistry</span><br>                    ConfigurationClassPostProcessor<span class="hljs-punctuation">#</span><span class="hljs-keyword">processConfigBeanDefinitions</span><br>                        ConfigurationClassParser<span class="hljs-punctuation">#</span><span class="hljs-keyword">parse</span><br>                            for å¾ªç¯ start[è§£æå•ä¸ªç±»]<br>                                ConfigurationClassParser<span class="hljs-punctuation">#</span><span class="hljs-keyword">parse</span><span class="hljs-params">(<span class="hljs-variable">AnnotationMetadata</span>, <span class="hljs-variable">java</span>.<span class="hljs-variable">lang</span>.<span class="hljs-variable">String</span>)</span><br>                                    ConfigurationClassParser<span class="hljs-punctuation">#</span><span class="hljs-keyword">processImports</span>    (1)<br>                            for å¾ªç¯ç»“æŸ<br>                            DeferredImportSelectorHandler<span class="hljs-punctuation">#</span><span class="hljs-keyword">process</span>              (2)<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  ConfigurationClassParser ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">(Set&lt;BeanDefinitionHolder&gt; configCandidates)</span> &#123;<br>    <span class="hljs-keyword">for</span> (BeanDefinitionHolder holder : configCandidates) &#123;<br>        <span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> holder.getBeanDefinition();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (bd <span class="hljs-keyword">instanceof</span> AnnotatedBeanDefinition annotatedBeanDef) &#123;<br>                <span class="hljs-comment">// è¿™é‡Œä¼šå¯¹ DeferredImportSelector è¿›è¡Œç¼“å­˜ï¼Œç¼“å­˜åœ¨ DeferredImportSelectorHandler ç±»ä¸­</span><br>                parse(annotatedBeanDef.getMetadata(), holder.getBeanName());<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bd <span class="hljs-keyword">instanceof</span> AbstractBeanDefinition abstractBeanDef &amp;&amp; abstractBeanDef.hasBeanClass()) &#123;<br>                parse(abstractBeanDef.getBeanClass(), holder.getBeanName());<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                parse(bd.getBeanClassName(), holder.getBeanName());<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (BeanDefinitionStoreException ex) &#123;<br>            <span class="hljs-keyword">throw</span> ex;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(<br>                    <span class="hljs-string">&quot;Failed to parse configuration class [&quot;</span> + bd.getBeanClassName() + <span class="hljs-string">&quot;]&quot;</span>, ex);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// è¿™é‡Œæ˜¯å¯¹ DeferredImportSelector çš„å®é™…å¤„ç†</span><br>    <span class="hljs-built_in">this</span>.deferredImportSelectorHandler.process();<br>&#125;<br></code></pre></td></tr></table></figure>


<p>å…ˆç®€å•æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ol>
<li>ä¸Šè¿°æµç¨‹ä¸­ <code>(1)</code> ä½ç½®å°±æ˜¯å¤„ç† <code>ImportSelector</code> çš„åœ°æ–¹ï¼Œ åŒæ—¶ä¹Ÿæ˜¯ç¼“å­˜ <code>DeferredImportSelector</code> å®ç°ç±»çš„åœ°æ–¹</li>
<li>ä¸Šè¿°æµç¨‹ä¸­ <code>(2)</code> ä½ç½®å°±æ˜¯å®é™…å¤„ç† <code>DeferredImportSelector</code> çš„åœ°æ–¹ï¼Œ å¯ä»¥çœ‹åˆ° <code>(2)</code> ä½ç½®æ˜¯åœ¨å¾ªç¯å¤–é¢ï¼Œä¹Ÿå°±æ˜¯ç­‰æ‰€æœ‰çš„ <code>BeanDefinition</code> éƒ½è§£æå®Œæˆä¹‹åå†å¤„ç†çš„ï¼Œæ‰€ä»¥æ‰è¯´ <code>DeferredImportSelector</code> å®ç°æ¥å£æœ‰å»¶è¿Ÿå¯¼å…¥çš„åŠŸèƒ½</li>
</ol>
<p>æ¥ä¸‹æ¥å°±ç›´æ¥çœ‹ <code>processImports</code> æ–¹æ³•ã€ä¸‹é¢æ‰€æœ‰åˆ—å‡ºä»£ç éƒ½çœç•¥äº†å’Œæœ¬æ¬¡åˆ†ææ— å…³çš„ä»£ç ã€‘</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processImports</span><span class="hljs-params">(ConfigurationClass configClass, SourceClass currentSourceClass,</span><br><span class="hljs-params">			Collection&lt;SourceClass&gt; importCandidates, Predicate&lt;String&gt; exclusionFilter,</span><br><span class="hljs-params">			<span class="hljs-type">boolean</span> checkForCircularImports)</span> &#123;<br>    <span class="hljs-keyword">for</span> (SourceClass candidate : importCandidates) &#123;<br>        <span class="hljs-keyword">if</span> (candidate.isAssignable(ImportSelector.class)) &#123;<br>            <span class="hljs-comment">// Candidate class is an ImportSelector -&gt; delegate to it to determine imports</span><br>            Class&lt;?&gt; candidateClass = candidate.loadClass();<br>            <span class="hljs-type">ImportSelector</span> <span class="hljs-variable">selector</span> <span class="hljs-operator">=</span> ParserStrategyUtils.instantiateClass(candidateClass, ImportSelector.class,<br>                    <span class="hljs-built_in">this</span>.environment, <span class="hljs-built_in">this</span>.resourceLoader, <span class="hljs-built_in">this</span>.registry);<br>            <span class="hljs-comment">// è¿™é‡Œå°±æ˜¯å¤„ç† DeferredImportSelector çš„é€»è¾‘</span><br>            <span class="hljs-keyword">if</span> (selector <span class="hljs-keyword">instanceof</span> DeferredImportSelector deferredImportSelector) &#123;<br>                <span class="hljs-comment">// è¿™é‡Œå¹¶æ²¡æœ‰çœŸæ­£çš„å¤„ç†ï¼Œåªæ˜¯å°†å…¶å­˜åœ¨ DeferredImportSelectorHandler å¯¹è±¡ä¸­</span><br>                <span class="hljs-built_in">this</span>.deferredImportSelectorHandler.handle(configClass, deferredImportSelector);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šé¢ä»£ç å°±æ˜¯ç¼“å­˜ <code>DeferredImportSelector</code> å®ç°ç±»çš„å¤„ç†é€»è¾‘ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¤„ç† <code>DeferredImportSelector</code> å®ç°ç±»çš„é€»è¾‘äº†ï¼Œä»å‰é¢ä»£ç å·²ç»çŸ¥é“äº†ï¼Œæ˜¯ä¼šåœ¨ <code>DeferredImportSelectorHandler</code> ä¸­è¿›è¡Œå¤„ç†, å¤„ç†è¿‡ç¨‹ä¸­ä¼šæ¶‰åŠåˆ° <code>Group</code> ç›¸å…³çš„ç±»ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆçœ‹ä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeferredImportSelectorGrouping</span> &#123;<br>    <span class="hljs-comment">// è¿™é‡Œå°±ä¿å­˜äº† Group å®ç°ç±»</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DeferredImportSelector.Group group;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;DeferredImportSelectorHolder&gt; deferredImports = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeferredImportSelectorGroupingHandler</span> &#123;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Object, DeferredImportSelectorGrouping&gt; groupings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥çœ‹  <code>this.deferredImportSelectorHandler.process();</code> è¿™ä¸ªå¤„ç†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// DeferredImportSelectorHandler ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">()</span> &#123;<br>    List&lt;DeferredImportSelectorHolder&gt; deferredImports = <span class="hljs-built_in">this</span>.deferredImportSelectors;<br>    <span class="hljs-built_in">this</span>.deferredImportSelectors = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (deferredImports != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">DeferredImportSelectorGroupingHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeferredImportSelectorGroupingHandler</span>();<br>            deferredImports.sort(DEFERRED_IMPORT_COMPARATOR);<br>            <span class="hljs-comment">// è¿™é‡Œæ¶‰åŠåˆ° Group çš„æ³¨å†Œ   (1)</span><br>            deferredImports.forEach(handler::register);<br>            <span class="hljs-comment">// çœŸæ­£çš„å¤„ç† å¯¼å…¥é€»è¾‘       (2)</span><br>            handler.processGroupImports();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-built_in">this</span>.deferredImportSelectors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å…ˆçœ‹ä¸€ä¸‹ <code>Group</code> æ³¨å†Œçš„ç›¸å…³é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯ <code>(1)</code> ä¸­çš„ç›¸å…³é€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeferredImportSelectorGroupingHandler</span> &#123;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Object, DeferredImportSelectorGrouping&gt; groupings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;AnnotationMetadata, ConfigurationClass&gt; configurationClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(DeferredImportSelectorHolder deferredImport)</span> &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         *  deferredImport.getImportSelector() è·å–çš„å°±æ˜¯ DeferredImportSelector å®ç°ç±»ï¼Œå†è°ƒç”¨ getImportGroup() å°±æ˜¯æƒ³è¦è·å–æˆ‘ä»¬è‡ªå·±å®ç°äº† Group çš„ç±»</span><br><span class="hljs-comment">         * è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå‰é¢è¯´å¦‚æœå•çº¯å®ç°äº† Group ç±»æ˜¯æ²¡æœ‰ç”¨çš„ï¼Œè¿˜éœ€è¦ä½¿ç”¨ getImportGroup() æ–¹æ³•è¿”å›æ‰è¡Œï¼Œå°±æ˜¯å› ä¸ºè¿™é‡Œä¼šè°ƒç”¨ getImportGroup() æ–¹æ³•è·å–æˆ‘ä»¬è‡ªå·±å®ç°äº† Group çš„ç±»</span><br><span class="hljs-comment">         */</span><br><br>        Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Group</span>&gt; group = deferredImport.getImportSelector().getImportGroup();<br>        <span class="hljs-type">DeferredImportSelectorGrouping</span> <span class="hljs-variable">grouping</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.groupings.computeIfAbsent(<br>                (group != <span class="hljs-literal">null</span> ? group : deferredImport),<br>                <span class="hljs-comment">// è¿™é‡Œæ˜¯åˆ›å»º Group, å¦‚æœæ²¡æœ‰åˆ›å»ºåˆ›å»ºå°±æ˜¯ä½¿ç”¨é»˜è®¤çš„ï¼Œå…·ä½“çœ‹ä¸‹é¢ createGroup æ–¹æ³•</span><br>                key -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeferredImportSelectorGrouping</span>(createGroup(group)));<br>        grouping.add(deferredImport);<br>        <span class="hljs-built_in">this</span>.configurationClasses.put(deferredImport.getConfigurationClass().getMetadata(),<br>                deferredImport.getConfigurationClass());<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Group <span class="hljs-title function_">createGroup</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Class&lt;? extends Group&gt; type)</span> &#123;<br>            <span class="hljs-comment">// è¿™é‡Œæ˜¯åˆ›å»º Group, å¦‚æœæˆ‘ä»¬è‡ªå·±æ²¡æœ‰åˆ›å»ºï¼Œé‚£ä¹ˆ type å°±ä¼šæ˜¯ nullï¼Œ ä¹Ÿå°±ä¼šä½¿ç”¨é»˜è®¤çš„ DefaultDeferredImportSelectorGroup ç±»</span><br>			Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Group</span>&gt; effectiveType = (type != <span class="hljs-literal">null</span> ? type : DefaultDeferredImportSelectorGroup.class);<br>        <span class="hljs-keyword">return</span> ParserStrategyUtils.instantiateClass(effectiveType, Group.class,<br>                ConfigurationClassParser.<span class="hljs-built_in">this</span>.environment,<br>                ConfigurationClassParser.<span class="hljs-built_in">this</span>.resourceLoader,<br>                ConfigurationClassParser.<span class="hljs-built_in">this</span>.registry);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°±æ˜¯çœ‹ <code>processGroupImports()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  DeferredImportSelectorGroupingHandler ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processGroupImports</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (DeferredImportSelectorGrouping grouping : <span class="hljs-built_in">this</span>.groupings.values()) &#123;<br>        Predicate&lt;String&gt; exclusionFilter = grouping.getCandidateFilter();<br>        <span class="hljs-comment">// grouping.getImports() ä¸­å°±ä¼šå®é™…è°ƒç”¨ Group ç±»çš„ process() æ–¹æ³•</span><br>        <span class="hljs-comment">// å¦‚æœä½¿ç”¨çš„æ˜¯é»˜è®¤çš„ Group å®ç°ç±»ï¼Œå®é™…å°±ä¼šè°ƒç”¨ ImportSelector ä¸­çš„ selectImports æ–¹æ³•ï¼Œ </span><br>        <span class="hljs-comment">//getImports() æ–¹æ³•çš„è¿”å›å€¼å°±æ˜¯æˆ‘ä»¬è‡ªå·±å®ç°äº† Group ç±»çš„ selectImports æ–¹æ³•çš„è¿”å›å€¼</span><br>        grouping.getImports().forEach(entry -&gt; &#123;<br>            <span class="hljs-type">ConfigurationClass</span> <span class="hljs-variable">configurationClass</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.configurationClasses.get(entry.getMetadata());<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// æ‹¿åˆ° æ‰«æåˆ°çš„ç±»çš„å…¨é™å®šç±»åï¼Œç„¶åå°±æŒ‰ç…§ Import æ™®é€šç±»æ¥å¤„ç†ï¼Œä¹Ÿå°±æ˜¯å½“ä½œ @Configuration æ³¨è§£çš„ç±»æ¥å¤„ç†</span><br>                processImports(configurationClass, asSourceClass(configurationClass, exclusionFilter),<br>                        Collections.singleton(asSourceClass(entry.getImportClassName(), exclusionFilter)),<br>                        exclusionFilter, <span class="hljs-literal">false</span>);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (BeanDefinitionStoreException ex) &#123;<br>                <span class="hljs-keyword">throw</span> ex;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(<br>                        <span class="hljs-string">&quot;Failed to process import candidates for configuration class [&quot;</span> +<br>                                configurationClass.getMetadata().getClassName() + <span class="hljs-string">&quot;]&quot;</span>, ex);<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> Iterable&lt;Group.Entry&gt; getImports() &#123;<br>    <span class="hljs-keyword">for</span> (DeferredImportSelectorHolder deferredImport : <span class="hljs-built_in">this</span>.deferredImports) &#123;<br>        <span class="hljs-comment">// åœ¨è¿™é‡Œå¼€å§‹è°ƒç”¨ Group çš„ process() æ–¹æ³•</span><br>        <span class="hljs-built_in">this</span>.group.process(deferredImport.getConfigurationClass().getMetadata(),<br>                deferredImport.getImportSelector());<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.group.selectImports();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è‡³æ­¤å°±è§£æå®Œäº† <code>Spring</code> ä¸­ <code>DeferredImportSelectory</code> çš„æ•´ä½“è°ƒç”¨æµç¨‹</p>
]]></content>
      <categories>
        <category>java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Springä¸­FactoryBeanè¯¦è§£</title>
    <url>/2023/fdea11462f1f/index.html</url>
    <content><![CDATA[<h2 id="FactoryBean-çš„ä½œç”¨"><a href="#FactoryBean-çš„ä½œç”¨" class="headerlink" title="FactoryBean çš„ä½œç”¨"></a>FactoryBean çš„ä½œç”¨</h2><p><code>FactoryBean</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¯¹äºå®ç°äº†è¯¥æ¥å£çš„ <code>Bean</code> æ¥è¯´ï¼Œç›´æ¥è°ƒç”¨ <code>getBean()</code> æ–¹æ³•æ—¶ï¼Œä¼šè¿”å› <code>FactoryBean</code> æ¥å£ä¸­ <code>getObject()</code> æ–¹æ³•è¿”å›çš„å®ä¾‹ï¼Œè€Œä¸æ˜¯ <code>Bean</code> æœ¬èº«ã€‚</p>
<h2 id="FactoryBean-ç¤ºä¾‹ä»£ç "><a href="#FactoryBean-ç¤ºä¾‹ä»£ç " class="headerlink" title="FactoryBean ç¤ºä¾‹ä»£ç "></a>FactoryBean ç¤ºä¾‹ä»£ç </h2><blockquote>
<p>ä»¥ä¸‹æ‰€æœ‰ä»£ç åœ¨åŒä¸€ä¸ªåŒ…ä¸­</p>
</blockquote>
<ul>
<li><p><code>BeanOne</code> æ™®é€šç±»ï¼Œå¹¶æ²¡æœ‰æ·»åŠ  <code>@Component</code> æ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanOne</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;BeanOne test&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><code>CusFactoryBean</code> è‡ªå®šä¹‰ <code>FactoryBean</code> å®ç°ç±»ï¼Œå¹¶ä¸”è¢« <code>Spring</code> ç®¡ç†ï¼ˆæ·»åŠ äº† <code>@Component</code> æ³¨è§£ ï¼‰ï¼Œå¹¶ä¸”å®šä¹‰äº† <code>beanName=cusBean</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component(&quot;cusBean&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusFactoryBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FactoryBean</span>&lt;BeanOne&gt; &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> BeanOne <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanOne</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; getObjectType() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><code>FactoryBeanMain</code> æµ‹è¯•ä¸»ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FactoryBeanMain</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(FactoryBeanMain.class);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">cusBean</span> <span class="hljs-operator">=</span> applicationContext.getBean(<span class="hljs-string">&quot;&amp;cusBean&quot;</span>);<br>        <span class="hljs-comment">// com.example.bean.CusFactoryBean@759d26fb</span><br>        System.out.println(cusBean);<br>        <span class="hljs-type">BeanOne</span> <span class="hljs-variable">beanOne</span> <span class="hljs-operator">=</span> (BeanOne)applicationContext.getBean(<span class="hljs-string">&quot;cusBean&quot;</span>);<br>        <span class="hljs-comment">// com.example.bean.BeanOne@3c73951</span><br>        System.out.println(beanOne);<br>        <span class="hljs-type">BeanOne</span> <span class="hljs-variable">beanOne2</span> <span class="hljs-operator">=</span> (BeanOne)applicationContext.getBean(<span class="hljs-string">&quot;cusBean&quot;</span>);<br>        <span class="hljs-comment">// com.example.bean.BeanOne@3c73951</span><br>        System.out.println(beanOne2);<br>        beanOne.test();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>ç›´æ¥é€šè¿‡ <code>beanName=cusBean</code> ä» <code>Spring</code> ä¸­è·å–æ—¶å¾—åˆ°çš„æ˜¯ <code>FactoryBean</code> æ¥å£ä¸­ <code>getObject()</code> è¿”å›çš„å®ä¾‹ï¼Œæœ¬ä¾‹ä¸­æ˜¯ <code>BeanOne</code> å®ä¾‹</p>
</li>
<li><p>è‹¥æƒ³è·å– <code>FactoryBean</code> å®ç°ç±» <code>Bean</code>, åˆ™éœ€è¦åœ¨ <code>beanName</code> å‰é¢æ·»åŠ  <code>&amp;</code> ç¬¦å·ï¼Œå³ <code>&amp;cusBean</code></p>
</li>
</ul>
<h2 id="è·å–-FacotoryBean-ä¸­-getObject-å¯¹è±¡çš„æµç¨‹"><a href="#è·å–-FacotoryBean-ä¸­-getObject-å¯¹è±¡çš„æµç¨‹" class="headerlink" title="è·å– FacotoryBean ä¸­ getObject() å¯¹è±¡çš„æµç¨‹"></a>è·å– FacotoryBean ä¸­ getObject() å¯¹è±¡çš„æµç¨‹</h2><p>ä½¿ç”¨çš„æ˜¯ä¸Šé¢çš„ç¤ºä¾‹ï¼Œ<code>CusFactoryBean</code> å®ç°äº† <code>FactoryBean</code> æ¥å£ï¼Œ<code>getObject()</code> ä¸­è¿”å›çš„æ˜¯ <code>BeanOne</code> å®ä¾‹ï¼Œç¨‹åºå…¥å£æ˜¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(FactoryBeanMain.class);<br><span class="hljs-type">BeanOne</span> <span class="hljs-variable">beanOne</span> <span class="hljs-operator">=</span> (BeanOne)applicationContext.getBean(<span class="hljs-string">&quot;cusBean&quot;</span>);<br></code></pre></td></tr></table></figure>
<p><code>getBean()</code> æ•´ä½“è°ƒç”¨æµç¨‹å¦‚ä¸‹</p>
<figure class="highlight leaf"><table><tr><td class="code"><pre><code class="hljs leaf">AbstractApplicationContext<span class="hljs-punctuation">#</span><span class="hljs-keyword">getBean</span><span class="hljs-params">(<span class="hljs-variable">String</span>)</span><br>    AbstractBeanFactory<span class="hljs-punctuation">#</span><span class="hljs-keyword">getBean</span><span class="hljs-params">(<span class="hljs-variable">String</span>)</span><br>        AbstractBeanFactory<span class="hljs-punctuation">#</span><span class="hljs-keyword">doGetBean</span><span class="hljs-params">(<span class="hljs-variable">String</span>,<span class="hljs-variable">Class</span>,<span class="hljs-variable">Object</span>[],<span class="hljs-variable">boolean</span>)</span><br>            AbstractBeanFactory<span class="hljs-punctuation">#</span><span class="hljs-keyword">transformedBeanName</span><span class="hljs-params">(<span class="hljs-variable">String</span> <span class="hljs-variable">name</span>)</span>   ã€è¿™é‡Œæ˜¯å°†nameè½¬æ¢æˆ beanName, å³å°† &amp;cusBean è½¬æ¢æˆ cusBeanã€‘<br>            DefaultSingletonBeanRegistry<span class="hljs-punctuation">#</span><span class="hljs-keyword">getSingleton</span><span class="hljs-params">(<span class="hljs-variable">String</span>)</span> ã€è¿™é‡Œè·å–çš„å®ä¾‹è¿˜æ˜¯ CusFactoryBean å¯¹è±¡ã€‘<br>            AbstractAutowireCapableBeanFactory<span class="hljs-punctuation">#</span><span class="hljs-keyword">getObjectForBeanInstance</span><span class="hljs-params">(<span class="hljs-variable">beanInstance</span>, <span class="hljs-variable">name</span>, <span class="hljs-variable">beanName</span>, <span class="hljs-variable">RootBeanDefinition</span>)</span><br>                AbstractBeanFactory<span class="hljs-punctuation">#</span><span class="hljs-keyword">getObjectForBeanInstance</span><span class="hljs-params">(<span class="hljs-variable">beanInstance</span>, <span class="hljs-variable">name</span>, <span class="hljs-variable">beanName</span>, <span class="hljs-variable">RootBeanDefinition</span>)</span><br>                    FactoryBeanRegistrySupport<span class="hljs-punctuation">#</span><span class="hljs-keyword">getObjectFromFactoryBean</span><br>                        FactoryBeanRegistrySupport<span class="hljs-punctuation">#</span><span class="hljs-keyword">doGetObjectFromFactoryBean</span><span class="hljs-params">(<span class="hljs-variable">FactoryBean</span><span class="hljs-operator">&lt;</span>?<span class="hljs-operator">&gt;</span>, <span class="hljs-variable">beanName</span>)</span>  ã€è¿™é‡Œé¢ä¼šè°ƒç”¨ CusFactoryBean çš„ getObject() æ–¹æ³•ã€‘<br><br></code></pre></td></tr></table></figure>
<p>å•ä¾‹ <code>Bean</code> é»˜è®¤éƒ½æ˜¯æ”¾åœ¨ <code>DefaultSingletonBeanRegistry</code> ç±»çš„ <code>singletonObjects</code> ä¸­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSingletonBeanRegistry</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">256</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>å¯¹äº <code>FacotryBean</code> è€Œè¨€ï¼Œåœ¨ä¸Šé¢ä¾‹å­ä¸­æœ€ç»ˆ <code>singletonObjects</code> ä¸­çš„ <code>key=cusBean</code>, <code>value=CusFactoryBean</code></li>
<li><code>FactoryBean#getObject()</code> è¿”å›çš„å®ä¾‹æœ€ç»ˆæ˜¯ç¼“å­˜åœ¨ <code>FactoryBeanRegistrySupport</code> ä¸­ <code>factoryBeanObjectCache</code> çš„ <code>key=cusBean</code>, <code>value=BeanOne</code><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FactoryBeanRegistrySupport</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; factoryBeanObjectCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">16</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="ç›´æ¥è·å–-FactoryBean-çš„æµç¨‹"><a href="#ç›´æ¥è·å–-FactoryBean-çš„æµç¨‹" class="headerlink" title="ç›´æ¥è·å– FactoryBean çš„æµç¨‹"></a>ç›´æ¥è·å– FactoryBean çš„æµç¨‹</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(FactoryBeanMain.class);<br><span class="hljs-type">Object</span> <span class="hljs-variable">cusBean</span> <span class="hljs-operator">=</span> applicationContext.getBean(<span class="hljs-string">&quot;&amp;cusBean&quot;</span>);<br></code></pre></td></tr></table></figure>
<p>è¿™é‡Œç¤ºä¾‹ä¸­ä¼ é€’çš„ <code>beanName</code> æ˜¯ <code>&amp;cusBean</code>ï¼Œä¸è¿‡ä»ä¸Šé¢çš„æµç¨‹ä¹ŸçŸ¥é“äº†ï¼Œæ— è®ºæ˜¯ <code>DefaultSingletonBeanRegistry</code> ç±»çš„ <code>singletonObjects</code> è¿˜æ˜¯ <code>FactoryBeanRegistrySupport</code> ä¸­ <code>factoryBeanObjectCache</code> å®é™…å­˜å‚¨çš„ <code>beanName</code> éƒ½æ˜¯ <code>cusBean</code>, å¹¶æ²¡æœ‰ <code>&amp;cusBean</code>ï¼Œæ­£å› ä¸ºå¦‚æ­¤ï¼Œåœ¨ä¸Šé¢æµç¨‹ä¸­æ‰ä¼šæœ‰ <code>AbstractBeanFactory#transformedBeanName</code> æ–¹æ³•å¯¹æˆ‘ä»¬ä¼ é€’çš„ <code>name</code> è½¬æ¢æˆ <code>beanName</code></p>
<figure class="highlight leaf"><table><tr><td class="code"><pre><code class="hljs leaf">AbstractApplicationContext<span class="hljs-punctuation">#</span><span class="hljs-keyword">getBean</span><span class="hljs-params">(<span class="hljs-variable">String</span>)</span><br>    AbstractBeanFactory<span class="hljs-punctuation">#</span><span class="hljs-keyword">getBean</span><span class="hljs-params">(<span class="hljs-variable">String</span>)</span><br>        AbstractBeanFactory<span class="hljs-punctuation">#</span><span class="hljs-keyword">doGetBean</span><span class="hljs-params">(<span class="hljs-variable">String</span>,<span class="hljs-variable">Class</span>,<span class="hljs-variable">Object</span>[],<span class="hljs-variable">boolean</span>)</span><br>            AbstractBeanFactory<span class="hljs-punctuation">#</span><span class="hljs-keyword">transformedBeanName</span><span class="hljs-params">(<span class="hljs-variable">String</span> <span class="hljs-variable">name</span>)</span>   ã€è¿™é‡Œæ˜¯å°†nameè½¬æ¢æˆ beanName, å³å°† &amp;cusBean è½¬æ¢æˆ cusBeanã€‘<br></code></pre></td></tr></table></figure>
<p><strong>éœ€è¦è®°ä½çš„æ˜¯æˆ‘ä»¬ä¼ é€’çš„åç§°æ˜¯ <code>name=&amp;cusBean</code>, è½¬æ¢åæ˜¯ <code>beanName=cusBean</code></strong><br>æ—¢ç„¶æœ€ç»ˆè·å–çš„ <code>beanName</code> éƒ½æ˜¯ <code>cusBean</code>ï¼Œå°±è¯´æ˜æ˜¯ä» <code>DefaultSingletonBeanRegistry</code> ç±»çš„ <code>singletonObjects</code> ä¸­è·å–å®ä¾‹å°±å¯ä»¥äº†ï¼Œåé¢çš„æµç¨‹éœ€è¦é˜»æŒ¡ï¼Œå…·ä½“æŒ¡çš„é€»è¾‘æ˜¯åœ¨ <code>AbstractBeanFactory#getObjectForBeanInstance</code> ä¸­ï¼Œä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractBeanFactory</span> &#123;<br>    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getObjectForBeanInstance</span><span class="hljs-params">(</span><br><span class="hljs-params">			Object beanInstance, String name, String beanName, <span class="hljs-meta">@Nullable</span> RootBeanDefinition mbd)</span> &#123;<br><br>		<span class="hljs-comment">// å°±æ˜¯åœ¨è¿™é‡Œåˆ¤æ–­æŒ¡ä½çš„, è¿™é‡Œç›´æ¥åˆ¤æ–­nameæ˜¯å¦ä»¥ &amp; å¼€å¤´</span><br>		<span class="hljs-keyword">if</span> (BeanFactoryUtils.isFactoryDereference(name)) &#123;<br>			<span class="hljs-keyword">if</span> (beanInstance <span class="hljs-keyword">instanceof</span> NullBean) &#123;<br>				<span class="hljs-keyword">return</span> beanInstance;<br>			&#125;<br>			<span class="hljs-keyword">if</span> (!(beanInstance <span class="hljs-keyword">instanceof</span> FactoryBean)) &#123;<br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanIsNotAFactoryException</span>(beanName, beanInstance.getClass());<br>			&#125;<br>			<span class="hljs-keyword">if</span> (mbd != <span class="hljs-literal">null</span>) &#123;<br>				mbd.isFactoryBean = <span class="hljs-literal">true</span>;<br>			&#125;<br>            <span class="hljs-comment">// å› ä¸ºæˆ‘ä»¬ä¼ é€’çš„æ˜¯ &amp;cusBeanï¼Œæ‰€ä»¥è¿™é‡Œå°±ç›´æ¥è¿”å›äº†ï¼Œå¹¶æ²¡æœ‰èµ°åé¢çš„é€»è¾‘</span><br>            <span class="hljs-comment">// é‚£ä¹ˆè¿”å›çš„å°±æ˜¯ `DefaultSingletonBeanRegistry` ç±»çš„ `singletonObjects` </span><br>            <span class="hljs-comment">// ä¸­è·å–çš„ Bean</span><br>			<span class="hljs-keyword">return</span> beanInstance;<br>		&#125;<br>        <span class="hljs-comment">// çœç•¥å…¶ä»–ä»£ç  â€¦â€¦</span><br>	&#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanFactoryUtils</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">FACTORY_BEAN_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&amp;&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFactoryDereference</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> String name)</span> &#123;<br>		<span class="hljs-keyword">return</span> (name != <span class="hljs-literal">null</span> &amp;&amp; name.startsWith(BeanFactory.FACTORY_BEAN_PREFIX));<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Springä¸­Importæ³¨è§£æºç è§£æ</title>
    <url>/2023/73d35f59945c/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p><code>@Import</code> æ³¨è§£å¯ä»¥å¯¼å…¥ä¸‰ç§ç±»å‹çš„ç±»</p>
<ol>
<li>å¯¼å…¥æ™®é€šç±»ï¼Œæ­¤æ—¶ç›´æ¥å°†æ™®é€šç±»äº¤ç»™ <code>Spring</code> ç®¡ç†</li>
<li>å¯¼å…¥ <code>ImportSelector</code> å®ç°ç±»ä¸­ <code>String[] selectImports(AnnotationMetadata importingClassMetadata);</code> æ–¹æ³•è¿”å›çš„ç±»</li>
<li>å¯¼å…¥ <code>ImportBeanDefinitionRegistrar</code> å®ç°ç±»ä¸­ <code>registerBeanDefinitions</code> æ–¹æ³•æ³¨å…¥çš„ç±»</li>
</ol>
<h2 id="ä»£ç ç¤ºä¾‹"><a href="#ä»£ç ç¤ºä¾‹" class="headerlink" title="ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h2><p>ä»¥ä¸‹ä»£ç æ¯ç§æ–¹å¼ä½¿ç”¨çš„ç±»éƒ½åœ¨åŒä¸€ä¸ªåŒ…ä¸‹( <code>@Configuration</code> é»˜è®¤ä¼šæ‰«æå½“å‰åŒ…å’Œå­åŒ… )ã€‚</p>
<div class="tabs" id="importçš„ä¸‰ç§ä½¿ç”¨æ–¹å¼"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="importçš„ä¸‰ç§ä½¿ç”¨æ–¹å¼-1">å¼•å…¥æ™®é€šç±»</button><button type="button" class="tab " data-href="importçš„ä¸‰ç§ä½¿ç”¨æ–¹å¼-2">ç»“åˆ ImportSelector</button><button type="button" class="tab " data-href="importçš„ä¸‰ç§ä½¿ç”¨æ–¹å¼-3">ç»“åˆ ImportBeanDefinitionRegistrar</button></ul><div class="tab-contents"><div class="tab-item-content active" id="importçš„ä¸‰ç§ä½¿ç”¨æ–¹å¼-1"><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ™®é€šç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;test hello&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//  é…ç½®ç±»</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Import(Student.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImportConfig</span> &#123;<br>&#125;<br><br><span class="hljs-comment">//  ä¸»ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImportMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(ImportConfig.class);<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> context.getBean(Student.class);<br>        student.sayHello();  <span class="hljs-comment">// ä¼šæ‰“å° &quot;test hello&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="importçš„ä¸‰ç§ä½¿ç”¨æ–¹å¼-2"><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ™®é€šç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;test hello&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//  é…ç½®ç±»</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Import(CusImportSelector.class)</span>  <span class="hljs-comment">// è¿™é‡Œå¯¼å…¥çš„æ˜¯å®ç°äº† ImportSelector æ¥å£çš„ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImportConfig</span> &#123;<br>&#125;<br><br><span class="hljs-comment">// è‡ªå®šä¹‰å®ç° ImportSelector æ¥å£çš„ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusImportSelector</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportSelector</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;<br>        <span class="hljs-comment">// è¿”å›çš„æ•°ç»„å°±æ˜¯éœ€è¦å¯¼å…¥çš„ç±»å…¨é™å®šå</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;org.example.imports.Student&quot;</span>&#125;;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//  ä¸»ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImportMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(ImportConfig.class);<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> context.getBean(Student.class);<br>        student.sayHello();  <span class="hljs-comment">// ä¼šæ‰“å° &quot;test hello&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="importçš„ä¸‰ç§ä½¿ç”¨æ–¹å¼-3"><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ™®é€šç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;test hello&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//  é…ç½®ç±»</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Import(CusImportBeanDefinitionRegistrar.class)</span>  <span class="hljs-comment">// è¿™é‡Œå¯¼å…¥çš„æ˜¯å®ç°äº† ImportSelector æ¥å£çš„ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImportConfig</span> &#123;<br>&#125;<br><br><span class="hljs-comment">// è‡ªå®šä¹‰å®ç° ImportBeanDefinitionRegistrar æ¥å£çš„ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusImportBeanDefinitionRegistrar</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportBeanDefinitionRegistrar</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry, BeanNameGenerator importBeanNameGenerator)</span> &#123;<br>        <span class="hljs-type">BeanDefinitionBuilder</span> <span class="hljs-variable">beanDefinitionBuilder</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(Student.class);<br>        <span class="hljs-type">AbstractBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> beanDefinitionBuilder.getBeanDefinition();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> importBeanNameGenerator.generateBeanName(beanDefinition, registry);<br>        registry.registerBeanDefinition(beanName, beanDefinition);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//  ä¸»ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImportMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(ImportConfig.class);<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> context.getBean(Student.class);<br>        student.sayHello();  <span class="hljs-comment">// ä¼šæ‰“å° &quot;test hello&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h2 id="æºç æµç¨‹è§£æ"><a href="#æºç æµç¨‹è§£æ" class="headerlink" title="æºç æµç¨‹è§£æ"></a>æºç æµç¨‹è§£æ</h2><p><code>@Import</code> çš„è§£æå®é™…æ˜¯é€šè¿‡ <code>BeanFactoryPostProcessor</code> å®ç°çš„ï¼Œ åœ¨ <ol><li><a href="/2023/e7d5d1305e5d/index.html" title="BeanFacotryçš„åç½®å¤„ç†å™¨è¯¦è§£">BeanFacotryçš„åç½®å¤„ç†å™¨è¯¦è§£</a></li></ol> æåˆ° <code>@ComponentScan</code> æ˜¯é€šè¿‡ <code>ConfigurationClassPostProcessor</code> å¤„ç†çš„ï¼Œå¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight leaf"><table><tr><td class="code"><pre><code class="hljs leaf">AbstractApplicationContext<span class="hljs-punctuation">#</span><span class="hljs-keyword">refresh</span><br>    AbstractApplicationContext<span class="hljs-punctuation">#</span><span class="hljs-keyword">invokeBeanFactoryPostProcessors</span><br>        PostProcessorRegistrationDelegate<span class="hljs-punctuation">#</span><span class="hljs-keyword">invokeBeanDefinitionRegistryPostProcessors</span><br>            ConfigurationClassPostProcessor<span class="hljs-punctuation">#</span><span class="hljs-keyword">postProcessBeanDefinitionRegistry</span><br>                ConfigurationClassParser<span class="hljs-punctuation">#</span><span class="hljs-keyword">parse</span><span class="hljs-params">(<span class="hljs-variable">Set</span><span class="hljs-operator">&lt;</span><span class="hljs-variable">BeanDefinitionHolder</span><span class="hljs-operator">&gt;</span>)</span><br>                    ConfigurationClassParser<span class="hljs-punctuation">#</span><span class="hljs-keyword">doProcessConfigurationClass</span><br></code></pre></td></tr></table></figure>
<p>æœ€ç»ˆæ˜¯ä¼šè°ƒç”¨åˆ° <code>ConfigurationClassParser#doProcessConfigurationClass</code> æ–¹æ³•ï¼Œæ¥ä¸‹æ¥å°±çœ‹çœ‹è¿™ä¸ªæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> SourceClass <span class="hljs-title function_">doProcessConfigurationClass</span><span class="hljs-params">(</span><br><span class="hljs-params">			ConfigurationClass configClass, SourceClass sourceClass, Predicate&lt;String&gt; filter)</span><br>			<span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-comment">// çœç•¥</span><br><br>    <span class="hljs-comment">// Process any @PropertySource annotations</span><br>    <span class="hljs-keyword">for</span> (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(<br>            sourceClass.getMetadata(), PropertySources.class,<br>            org.springframework.context.annotation.PropertySource.class)) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.propertySourceRegistry != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-built_in">this</span>.propertySourceRegistry.processPropertySource(propertySource);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            logger.info(<span class="hljs-string">&quot;Ignoring @PropertySource annotation on [&quot;</span> + sourceClass.getMetadata().getClassName() +<br>                    <span class="hljs-string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//  è¿™é‡Œæ˜¯å¤„ç† @ComponentScan  Process any @ComponentScan annotations</span><br>    Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(<br>            sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);<br>    <span class="hljs-keyword">if</span> (!componentScans.isEmpty() &amp;&amp;<br>            !<span class="hljs-built_in">this</span>.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;<br>        <span class="hljs-comment">// çœç•¥</span><br>    &#125;<br><br>    <span class="hljs-comment">// å¤„ç† @Import Process any @Import annotations</span><br>    processImports(configClass, sourceClass, getImports(sourceClass), filter, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-comment">// çœç•¥  å¤„ç† @ImportResource ç­‰  Process any @ImportResource annotations</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>processImports</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ConfigurationClassParser ç±»ï¼Œ è¯¥æ–¹æ³•åªåˆ—å‡ºäº†é‡è¦æ–¹æ³•</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processImports</span><span class="hljs-params">(ConfigurationClass configClass, SourceClass currentSourceClass,</span><br><span class="hljs-params">			Collection&lt;SourceClass&gt; importCandidates, Predicate&lt;String&gt; exclusionFilter,</span><br><span class="hljs-params">			<span class="hljs-type">boolean</span> checkForCircularImports)</span> &#123;<br><br>    <span class="hljs-keyword">for</span> (SourceClass candidate : importCandidates) &#123;<br>        <span class="hljs-comment">// å¯¼å…¥çš„æ˜¯ ImportSelector ç±»å‹çš„å¤„ç†æµç¨‹</span><br>        <span class="hljs-keyword">if</span> (candidate.isAssignable(ImportSelector.class)) &#123;<br>            <span class="hljs-comment">// Candidate class is an ImportSelector -&gt; delegate to it to determine imports</span><br>            Class&lt;?&gt; candidateClass = candidate.loadClass();<br>            <span class="hljs-type">ImportSelector</span> <span class="hljs-variable">selector</span> <span class="hljs-operator">=</span> ParserStrategyUtils.instantiateClass(candidateClass, ImportSelector.class,<br>                    <span class="hljs-built_in">this</span>.environment, <span class="hljs-built_in">this</span>.resourceLoader, <span class="hljs-built_in">this</span>.registry);<br>            Predicate&lt;String&gt; selectorFilter = selector.getExclusionFilter();<br>            <span class="hljs-keyword">if</span> (selectorFilter != <span class="hljs-literal">null</span>) &#123;<br>                exclusionFilter = exclusionFilter.or(selectorFilter);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (selector <span class="hljs-keyword">instanceof</span> DeferredImportSelector deferredImportSelector) &#123;<br>                <span class="hljs-built_in">this</span>.deferredImportSelectorHandler.handle(configClass, deferredImportSelector);<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                String[] importClassNames = selector.selectImports(currentSourceClass.getMetadata());<br>                Collection&lt;SourceClass&gt; importSourceClasses = asSourceClasses(importClassNames, exclusionFilter);<br>                processImports(configClass, currentSourceClass, importSourceClasses, exclusionFilter, <span class="hljs-literal">false</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// å¯¼å…¥çš„æ˜¯ ImportBeanDefinitionRegistrar ç±»å‹çš„å¤„ç†æµç¨‹</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (candidate.isAssignable(ImportBeanDefinitionRegistrar.class)) &#123;<br>            <span class="hljs-comment">// Candidate class is an ImportBeanDefinitionRegistrar -&gt;</span><br>            <span class="hljs-comment">// delegate to it to register additional bean definitions</span><br>            Class&lt;?&gt; candidateClass = candidate.loadClass();<br>            <span class="hljs-type">ImportBeanDefinitionRegistrar</span> <span class="hljs-variable">registrar</span> <span class="hljs-operator">=</span><br>                    ParserStrategyUtils.instantiateClass(candidateClass, ImportBeanDefinitionRegistrar.class,<br>                            <span class="hljs-built_in">this</span>.environment, <span class="hljs-built_in">this</span>.resourceLoader, <span class="hljs-built_in">this</span>.registry);<br>            configClass.addImportBeanDefinitionRegistrar(registrar, currentSourceClass.getMetadata());<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// æ—¢ä¸æ˜¯ ImportSelector ä¹Ÿä¸æ˜¯ ImportBeanDefinitionRegistrar ç±»å‹çš„å¤„ç†æµç¨‹ï¼Œå½“ä½œ æ™®é€šçš„ @Configuration ç±»å¤„ç†</span><br>            <span class="hljs-built_in">this</span>.importStack.registerImport(<br>                    currentSourceClass.getMetadata(), candidate.getMetadata().getClassName());<br>            processConfigurationClass(candidate.asConfigClass(configClass), exclusionFilter);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>å¯¼å…¥çš„æ˜¯æ™®é€šç±»æ˜¯çš„å¤„ç†æµç¨‹</strong></p>
<p>ä»ä¸Šé¢æºç å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœå¯¼å…¥çš„æ˜¯æ™®é€šçš„ç±»ï¼ˆä¸æ˜¯ <code>ImportSelector</code> ä¹Ÿä¸æ˜¯ <code>ImportBeanDefinitionRegistrar</code> ç±»å‹ï¼‰åˆ™å°†è¿™ä¸ªæ™®é€šç±»æŒ‰ç…§å«æœ‰ <code>@Configuration</code> æ³¨è§£çš„ç±»ä¸€æ ·è¿›è¡Œå¤„ç†, å¦‚æœæ˜¯æŒ‰ç…§ <code>@Configuration</code> æ³¨è§£çš„ç±»è¿›è¡Œå¤„ç†ï¼Œä¼šå°†æ™®é€šç±»å˜æˆ <code>ConfigurationClass</code> ç±»å‹</p>
<p><strong>å¯¼å…¥çš„æ˜¯ <code>ImportSelector</code> ç±»å‹</strong></p>
<p>å¯¹äºå¯¼å…¥çš„æ˜¯ <code>ImportSelector</code> ç±»å‹å¤„ç†ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (candidate.isAssignable(ImportSelector.class)) &#123;<br>    <span class="hljs-comment">// Candidate class is an ImportSelector -&gt; delegate to it to determine imports</span><br>    Class&lt;?&gt; candidateClass = candidate.loadClass();<br>    <span class="hljs-type">ImportSelector</span> <span class="hljs-variable">selector</span> <span class="hljs-operator">=</span> ParserStrategyUtils.instantiateClass(candidateClass, ImportSelector.class,<br>            <span class="hljs-built_in">this</span>.environment, <span class="hljs-built_in">this</span>.resourceLoader, <span class="hljs-built_in">this</span>.registry);<br>    Predicate&lt;String&gt; selectorFilter = selector.getExclusionFilter();<br>    <span class="hljs-keyword">if</span> (selectorFilter != <span class="hljs-literal">null</span>) &#123;<br>        exclusionFilter = exclusionFilter.or(selectorFilter);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (selector <span class="hljs-keyword">instanceof</span> DeferredImportSelector deferredImportSelector) &#123;<br>        <span class="hljs-built_in">this</span>.deferredImportSelectorHandler.handle(configClass, deferredImportSelector);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        String[] importClassNames = selector.selectImports(currentSourceClass.getMetadata());<br>        Collection&lt;SourceClass&gt; importSourceClasses = asSourceClasses(importClassNames, exclusionFilter);<br>        processImports(configClass, currentSourceClass, importSourceClasses, exclusionFilter, <span class="hljs-literal">false</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>å…ˆè°ƒç”¨ <code>selectImports</code> æ–¹æ³•è·å–å¯¼å…¥çš„ç±»åæ•°ç»„</li>
<li>è°ƒç”¨ <code>asSourceClasses</code> æ–¹æ³•å°†ç±»åæ•°ç»„è½¬æ¢ä¸º <code>SourceClass</code> é›†åˆ</li>
<li>è°ƒç”¨ <code>processImports</code> æ–¹æ³•å¤„ç† <code>SourceClass</code> æ•°ç»„ï¼Œ è¿™é‡Œå°±æ˜¯é€’å½’è°ƒç”¨äº†ï¼Œé€’å½’çš„ç¬¬ä¸€å±‚æ˜¯ <code>ImportSelector</code> ç±»å‹çš„ç±»ï¼Œé€’å½’çš„ç¬¬äºŒå±‚å°±æ˜¯ <code>selectImports</code> æ–¹æ³•ä¸­è¿”å›çš„æ™®é€šçš„ç±»äº†ï¼Œè¿™ä¸ªå°±å’Œ <code>Import</code> å¯¼å…¥çš„æ˜¯æ™®é€šç±»ä¸€æ ·çš„å¤„ç†æµç¨‹ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆæ˜¯æŒ‰ç…§ <code>@Configuration</code> æ³¨è§£çš„ç±»å¤„ç†</li>
</ol>
<p><strong>å¯¼å…¥çš„æ˜¯ <code>ImportBeanDefinitionRegistrar</code> ç±»å‹</strong></p>
<p>å¯¹äºå¯¼å…¥çš„æ˜¯ <code>ImportBeanDefinitionRegistrar</code> ç±»å‹å¤„ç†ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (candidate.isAssignable(ImportBeanDefinitionRegistrar.class)) &#123;<br>    <span class="hljs-comment">// Candidate class is an ImportBeanDefinitionRegistrar -&gt;</span><br>    <span class="hljs-comment">// delegate to it to register additional bean definitions</span><br>    Class&lt;?&gt; candidateClass = candidate.loadClass();<br>    <span class="hljs-type">ImportBeanDefinitionRegistrar</span> <span class="hljs-variable">registrar</span> <span class="hljs-operator">=</span><br>            ParserStrategyUtils.instantiateClass(candidateClass, ImportBeanDefinitionRegistrar.class,<br>                    <span class="hljs-built_in">this</span>.environment, <span class="hljs-built_in">this</span>.resourceLoader, <span class="hljs-built_in">this</span>.registry);<br>    <span class="hljs-comment">// configClass å°±æ˜¯ ConfigurationClass</span><br>    configClass.addImportBeanDefinitionRegistrar(registrar, currentSourceClass.getMetadata()); <br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *   ConfigurationClass ç±»</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> *  private final Map&lt;ImportBeanDefinitionRegistrar, AnnotationMetadata&gt; importBeanDefinitionRegistrars = new LinkedHashMap&lt;&gt;();</span><br><span class="hljs-comment"> * /</span><br><span class="hljs-comment">void addImportBeanDefinitionRegistrar(ImportBeanDefinitionRegistrar registrar, AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="hljs-comment">    this.importBeanDefinitionRegistrars.put(registrar, importingClassMetadata);</span><br><span class="hljs-comment">&#125;</span><br></code></pre></td></tr></table></figure>
<p>æœ€ç»ˆæ˜¯å°† <code>ImportBeanDefinitionRegistrar</code> å®ç°ç±»æ”¾å…¥äº† <code>ConfigurationClass</code> ç±»ä¸­çš„ <code>importBeanDefinitionRegistrars</code> å±æ€§ä¸­ï¼Œé‚£ä¹ˆæœ€ç»ˆæ˜¯ä»€ä¹ˆæ—¶å€™æ³¨å†Œæˆ <code>BeanDefinition</code> çš„å‘¢ï¼Ÿ</p>
<p>è¿™ä¸ªå°±å¾—å›åˆ° <code>org.springframework.context.annotation.ConfigurationClassPostProcessor#processConfigBeanDefinitions</code> æ–¹æ³•ä¸­äº†ï¼Œ è¿™é‡Œé€šè¿‡æµç¨‹å›¾æ¢³ç†ä¸€ä¸‹è§£æå’Œæ³¨å†Œä¸¤ä¸ªæ­¥éª¤çš„æµç¨‹</p>
<pre class="mermaid">sequenceDiagram
    autonumber
    participant A as ConfigurationClassPostProcessor
    participant B as ConfigurationClassParser
    participant C as ConfigurationClassBeanDefinitionReader
    activate A
    A->>A: processConfigBeanDefinitions()
    A->>B: parse()
    B->>B: doProcessConfigurationClassï¼ˆï¼‰
    A->>C: loadBeanDefinitions()
    C->>C: loadBeanDefinitionsFromRegistrars()
    deactivate  A</pre>

<ol>
<li>æ•´ä½“é€»è¾‘æ˜¯åœ¨ <code>ConfigurationClassPostProcessor</code> çš„ <code>processConfigBeanDefinitions()</code> æ–¹æ³•ä¸­æ‰§è¡Œçš„</li>
<li>å¯¹äº <code>@ComponentScan</code>, <code>@Import</code> ç­‰è§£ææ˜¯åœ¨ <code>ConfiguraionClassParser</code> çš„ <code>doProcessConfigurationClass()</code> æ–¹æ³•ä¸­è§£æçš„</li>
<li>å¯¹äº <code>ImportBeanDefinitionRegistrar</code> ç±»å‹çš„ç±»åœ¨ç¬¬äºŒæ­¥è§£æå®Œæˆä¹‹åæ”¾å…¥äº† <code>ConfigurationClass</code> ç±»å‹ï¼ˆå°±æ˜¯å°† <code>ImportBeanDefinitionRegistrar</code> ç±»å‹çš„å®ç°ç±»è½¬æ¢æˆ <code>ConfigurationClass</code> ç±»å‹è€Œå·²ï¼‰ä¸­çš„ <code>importBeanDefinitionRegistrars</code> å±æ€§ä¸­</li>
<li>æœ€ååœ¨ <code>ConfigurationClassBeanDefinitionReader</code> ç±»çš„ <code>loadBeanDefinitionsFromRegistrars()</code> æ–¹æ³•ä¸­ä¼šè¿›è¡Œ <code>BeanDefinition</code> çš„æ³¨å†Œ</li>
</ol>
<p>è‡³æ­¤ï¼Œè§£æå’Œæ³¨å†Œä¸¤ä¸ªæ­¥éª¤çš„æµç¨‹å°±è§£æå®Œäº†</p>
]]></content>
      <categories>
        <category>java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>å¦‚ä½•è®©è‡ªå®šä¹‰çš„æŸä¸ªbeanåœ¨æ‰€æœ‰beanä¹‹å‰åŠ è½½</title>
    <url>/2023/5cb19cbceeb7/index.html</url>
    <content><![CDATA[<p>å¯ä»¥é€šè¿‡ <code>@DependsOn</code> æ³¨è§£æ¥æ§åˆ¶æŸä¸ª <code>bean</code> çš„åŠ è½½é¡ºåºï¼Œä½†æ˜¯å¦‚æœæœ‰æ§åˆ¶é¡¹ç›®ä¸­è®©æŸä¸ª <code>Bean</code> å…ˆäºå…¶ä»–çš„ <code>Bean</code> åŠ è½½ï¼Œè¿™ç§æ–¹å¼å°±ä¸å¯è¡Œï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦ä» <code>Spring</code> ä¸­åŠ è½½ <code>Bean</code> çš„æœºåˆ¶å…¥æ‰‹</p>
<ol>
<li>é€šè¿‡ <code>BeanFacotry.getBean()</code> æ–¹æ³•ä¸»åŠ¨å»åŠ è½½ <code>Bean</code></li>
<li>æ‰€æœ‰éæ‡’åŠ è½½çš„ <code>Bean</code> ä¼šåœ¨ <code>AbstractApplicationContext#finishBeanFactoryInitialization()</code> æ–¹æ³•ä¸­è¿›è¡ŒåŠ è½½</li>
</ol>
<p>å¦‚æœæ˜¯é€šè¿‡ç¬¬äºŒç§æ–¹å¼(è‡ªåŠ¨åŠ è½½)ï¼Œé‚£ä¹ˆ <code>Bean</code> åŠ è½½æ—¶æœºå°±ä¸æ˜¯å¯æ§çš„ï¼Œæ‰€ä»¥åªèƒ½ä½¿ç”¨ç¬¬ä¸€ç§æ–¹å¼ï¼Œè¿›è¡Œä¸»åŠ¨åŠ è½½</p>
<p>ä½¿ç”¨ä¸»åŠ¨åŠ è½½çš„æ–¹æ³•éœ€è¦è·å–åˆ° <code>BeanFactory</code>ï¼Œè€Œ <code>BeanFactoryPostProcessor</code> æ–¹æ³•å°±å¯ä»¥æä¾› <code>beanFactory</code>ï¼Œ è€Œä¸” <code>BeanFactoryPostProcessor</code> çš„æ‰§è¡Œæ—¶æœºæ˜¯æ‰€æœ‰ <code>Bean</code> åŠ è½½ä¹‹å‰</p>
<p><strong>ç¤ºä¾‹ä»£ç </strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusBeanFactoryPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanFactoryPostProcessor</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-comment">// ä¸»åŠ¨è·å– FirstDemo</span><br>        beanFactory.getBean(FirstDemo.class);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirstDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;FirstDemo Hello&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot3è‡ªåŠ¨è£…é…åŸç†</title>
    <url>/2023/8e23a1d3d97d/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p>SpringBootç‰ˆæœ¬: 3.2.0</p>
<h2 id="ä»€ä¹ˆæ˜¯è‡ªåŠ¨è£…é…"><a href="#ä»€ä¹ˆæ˜¯è‡ªåŠ¨è£…é…" class="headerlink" title="ä»€ä¹ˆæ˜¯è‡ªåŠ¨è£…é…"></a>ä»€ä¹ˆæ˜¯è‡ªåŠ¨è£…é…</h2><p><strong>è£…é…çš„æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<p>è£…é…çš„å°±æ˜¯ <code>bean</code>, ä¹Ÿå°±æ˜¯å¯ä»¥å°†ä¸€ä¸ª å¯¹è±¡äº¤ç»™ <code>Spring</code> å®¹å™¨ç®¡ç†</p>
<p><strong>ä¸ºä»€ä¹ˆå¯ä»¥è‡ªåŠ¨ï¼Ÿ</strong></p>
<p><code>SpringBoot</code> ç§‰æŒçš„å°±æ˜¯ <strong>çº¦å®šä¼˜äºé…ç½®</strong>ï¼Œæ‰€ä»¥è¦æƒ³åšåˆ°å°±å¾—æœ‰ä¸€å®šçš„è§„åˆ™ï¼Œæ¯”å¦‚</p>
<ul>
<li>æ€»å¾—è¦å‘Šè¯‰ <code>Spring</code> æˆ‘ä»¬æƒ³è¦è£…é…çš„æ˜¯ä»€ä¹ˆç±»ï¼Œé€šè¿‡ä»€ä¹ˆæ–¹å¼å‘Šè¯‰å‘¢ï¼Ÿ å°±æ˜¯å°†æƒ³è¦æ³¨å…¥çš„ç±»é›†ä¸­å†™åœ¨ä¸€ä¸ªå›ºå®šä½ç½®çš„é…ç½®æ–‡ä»¶ä¸­<ul>
<li>åœ¨ 2.7.0 ä¹‹å‰ä½¿ç”¨çš„é…ç½®æ–‡ä»¶åç§°æ˜¯ <code>spring.factories</code>, è¿™ä¸ªæ–‡ä»¶çš„ä½ç½®æ˜¯  <code>META-INF/spring.factories</code></li>
<li>åœ¨ 2.7.0 ä¹‹åä½¿ç”¨çš„é…ç½®æ–‡ä»¶åç§°æ˜¯ <code>org.springframework.boot.autoconfigure.AutoConfiguration.imports</code>, è¿™ä¸ªæ–‡ä»¶çš„ä½ç½®æ˜¯  <code>META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</code></li>
</ul>
</li>
<li>å¯ä»¥è®¤ä¸ºé…ç½®æ–‡ä»¶æ˜¯å¼€å‘è€…éœ€è¦æä¾›çš„ï¼Œå½“ç„¶ <code>SpringBoot</code> å†…éƒ¨ä¹Ÿä½¿ç”¨äº†è¿™ç§æœºåˆ¶ï¼Œæ—¢ç„¶æä¾›äº†é…ç½®æ–‡ä»¶ï¼Œé‚£ä¹ˆ <code>Spring</code> æ¡†æ¶å°±éœ€è¦æŒ‰ç…§çº¦å®šçš„ä½ç½®å»æ‰¾è¿™äº›ç±»äº†ï¼Œè¿™ä¸ªåœ¨ <code>SpringBoot</code> ä¸­æ˜¯é€šè¿‡ <code>@Import</code> æ³¨è§£å¯¼å…¥äº†ä¸€ä¸ª <code>DeferredImportSelector</code> å®ç°ç±»æ¥å®ç°çš„ï¼Œè¿™ä¸ªå®ç°ç±»æ˜¯ <code>AutoConfigurationImportSelector</code></li>
<li>åœ¨ <code>SpringBoot</code> ä¸­è¿˜æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå°±æ˜¯é€šè¿‡ä¸€ç³»åˆ—çš„æ¡ä»¶åˆ¤æ–­æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å†™çš„è¿™äº›ç±»æ˜¯å¦çœŸçš„å¯ä»¥å¯¼å…¥ï¼Œè¿™ä¸€ç³»åˆ—æ¡ä»¶æ˜¯é€šè¿‡ <code>@ConditionalOnxxxx</code> æ³¨è§£æ¥å®ç°</li>
</ul>
<p>æ¥ä¸‹æ¥ç®€å•æ€»ç»“ä¸€ä¸‹ <code>SpringBoot3</code> çš„è‡ªåŠ¨è£…é…åŸç†</p>
<ol>
<li>é€šè¿‡ <code>@Import</code> å¯¼å…¥ <code>AutoConfigurationImportSelector</code> ç±»ï¼Œ å¯ä»¥å‚è€ƒ <ol><li><a href="/2023/73d35f59945c/index.html" title="Springä¸­Importæ³¨è§£æºç è§£æ">Springä¸­Importæ³¨è§£æºç è§£æ</a></li></ol></li>
<li><code>AutoConfigurationImportSelector</code> ä¼šå»æ‰¾æ‰€æœ‰ <code>classpath</code> ä¸‹æ‰€æœ‰ <code>jar</code> ä¸‹çš„ <code>META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</code> æ–‡ä»¶ï¼Œå°†æ–‡ä»¶é‡Œé¢çš„å…¨é™å®šç±»ååŠ è½½è¿›æ¥</li>
<li>å¯¹åŠ è½½åŠ æ¥çš„ç±»è¿›è¡Œä¸€ç³»åˆ—çš„æ¡ä»¶åˆ¤æ–­ï¼Œç¬¦åˆæ¡ä»¶çš„æ‰ä¼šçœŸçš„è¿›è¡ŒåŠ è½½åˆ° <code>Spring</code> å®¹å™¨ä¸­</li>
</ol>
<h2 id="è‡ªåŠ¨è£…é…çš„ç¤ºä¾‹"><a href="#è‡ªåŠ¨è£…é…çš„ç¤ºä¾‹" class="headerlink" title="è‡ªåŠ¨è£…é…çš„ç¤ºä¾‹"></a>è‡ªåŠ¨è£…é…çš„ç¤ºä¾‹</h2><ol><li><a href="/2023/ee343b448bf4/index.html" title="SpringBoot3è‡ªåŠ¨è£…é…æ¡ˆä¾‹">SpringBoot3è‡ªåŠ¨è£…é…æ¡ˆä¾‹</a></li></ol>

<h2 id="SpringBoot3-è‡ªåŠ¨è£…é…çš„æµç¨‹"><a href="#SpringBoot3-è‡ªåŠ¨è£…é…çš„æµç¨‹" class="headerlink" title="SpringBoot3 è‡ªåŠ¨è£…é…çš„æµç¨‹"></a>SpringBoot3 è‡ªåŠ¨è£…é…çš„æµç¨‹</h2><p><code>SpringBoot</code> é¡¹ç›®å¯åŠ¨ä¸»ç±»ä¸Šåªæœ‰ä¸€ä¸ª <code>SpringBootApplication</code> æ³¨è§£ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªæ³¨è§£çš„ä½“ç³»</p>
<pre class="mermaid">flowchart LR
    A["@SpringBootApplication"]
    style A fill:#8ff600
    B["@ComponentScan"]
    C["@EnableAutoConfiguration"]
    style C fill:#8ff600
    D["@SpringBootConfiguration"]

    A--> B & C & D

    E["@Configuration"]
    D-->E

    F["@AutoConfigurationPackage"]
    G["@Import(AutoConfigurationPackages.Registrar.class)"]
    C-->F
    F-->G

    H["@Import(AutoConfigurationImportSelector.class)"]
    style H fill:#8ff600
    C-->H</pre>

<p>æ¶‰åŠåˆ°è‡ªåŠ¨æ³¨å…¥çš„æ³¨è§£ä½¿ç”¨ç»¿è‰²æ ‡è®°å‡ºæ¥äº†ï¼Œæ‰€ä»¥æœ€ç»ˆéœ€è¦çœ‹çš„å°±æ˜¯ <code>AutoConfigurationImportSelector</code>ï¼Œ è€Œè¿™ä¸ªç±»æ˜¯ä¸€ä¸ª <code>DeferredImportSelector</code> æ¥å£çš„å®ç°ç±»ï¼Œå…·ä½“å‚è€ƒ <ol><li><a href="/2023/55186be8f39b/index.html" title="Springä¸­DeferredImportSelectoræºç è§£æ">Springä¸­DeferredImportSelectoræºç è§£æ</a></li></ol>ï¼Œ è¿™é‡Œå°±ç›´æ¥ç»™å‡º <code>DeferredImportSelector</code> æ¥å£çš„æ‰§è¡Œæµç¨‹</p>
<pre class="mermaid">flowchart TB
    A["Groupå®ç°ç±»ä¸­çš„ process() æ–¹æ³•"]
    B["DeferredImportSelectorå®ç°ç±» 
     ä¸­çš„ selectImports() æ–¹æ³• 
     ï¼ˆè¯¥æ–¹æ³•ä¸ä¸€å®šæ‰§è¡Œï¼Œå½“ Group å®ç°ç±»ä¸­
     æœ‰è°ƒç”¨çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œï¼Œæ²¡æœ‰è°ƒç”¨å°±æ²¡æœ‰æ‰§è¡Œ
     SpringBootè‡ªåŠ¨è£…é…æ—¶å°±æ²¡æœ‰æ‰§è¡Œ selectImports() æ–¹æ³•ï¼‰"]
    C["Groupå®ç°ç±»ä¸­çš„ selectImports() æ–¹æ³•
    è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼æ‰æ˜¯çœŸæ­£è¦è¢«
    å¯¼å…¥çš„ç±»"]
    A-->B-->C</pre>

<p>å…ˆçœ‹ä¸€ä¸‹ <code>AutoConfigurationImportSelector</code> è¿™ä¸ªç±»ä¸­ç›¸å…³çš„ä»£ç ï¼ˆåªå±•ç¤ºä¸»æµç¨‹éƒ¨åˆ†ï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoConfigurationImportSelector</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DeferredImportSelector</span>, BeanClassLoaderAware,<br>		ResourceLoaderAware, BeanFactoryAware, EnvironmentAware, Ordered &#123;<br><br>    <span class="hljs-comment">// æ ¹æ®è¿™ä¸ªæ–¹æ³•å¯ä»¥çŸ¥é“å½“å‰ DeferredImportSelector å®ç°ç±»å¯¹åº”çš„ Group ç±»æ˜¯ AutoConfigurationGroup</span><br>    <span class="hljs-comment">// æ­¥éª¤1ï¼š æ ¹æ®è¿™ä¸ªæ–¹æ³•å¾—åˆ°å…·ä½“çš„ Group å®ç°ç±»</span><br>	<span class="hljs-keyword">public</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Group</span>&gt; getImportGroup() &#123;<br>		<span class="hljs-keyword">return</span> AutoConfigurationGroup.class;<br>	&#125;<br><br>    <span class="hljs-comment">// æ­¥éª¤4ï¼š è¿™ä¸ªæ–¹æ³•æ˜¯ä» Group å®ç°ç±»ä¸­çš„ process() æ–¹æ³•è°ƒç”¨è¿‡æ¥çš„</span><br>    <span class="hljs-keyword">protected</span> AutoConfigurationEntry <span class="hljs-title function_">getAutoConfigurationEntry</span><span class="hljs-params">(AnnotationMetadata annotationMetadata)</span> &#123;<br>		<span class="hljs-keyword">if</span> (!isEnabled(annotationMetadata)) &#123;<br>			<span class="hljs-keyword">return</span> EMPTY_ENTRY;<br>		&#125;<br>		<span class="hljs-type">AnnotationAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> getAttributes(annotationMetadata);<br>        <span class="hljs-comment">// æ­¥éª¤5ï¼š getCandidateConfigurations æ–¹æ³•ä¼šä»é…ç½®æ–‡ä»¶åŠ è½½ç±»</span><br>		List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes);<br>		configurations = removeDuplicates(configurations);<br>        <span class="hljs-comment">// è·å–æ‰‹åŠ¨æ’é™¤æ‰çš„ç±»ï¼Œæ¯”å¦‚æˆ‘ä»¬é…ç½®äº† exclude ç›¸å…³çš„é…ç½®</span><br>		Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);<br>		checkExcludedClasses(configurations, exclusions);<br>		configurations.removeAll(exclusions);<br>        <span class="hljs-comment">// æ­¥éª¤6ï¼š è¿™é‡Œå°±æ˜¯æ ¹æ®æ¡ä»¶åˆ¤æ–­ï¼Œè¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„ç±»</span><br>		configurations = getConfigurationClassFilter().filter(configurations);<br>		fireAutoConfigurationImportEvents(configurations, exclusions);<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AutoConfigurationEntry</span>(configurations, exclusions);<br>	&#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoConfigurationGroup</span><br>			<span class="hljs-keyword">implements</span> <span class="hljs-title class_">DeferredImportSelector</span>.Group, BeanClassLoaderAware, BeanFactoryAware, ResourceLoaderAware &#123;<br>        <br>        <span class="hljs-comment">// æ­¥éª¤2ï¼š è°ƒç”¨ Group å®ç°ç±»ä¸­çš„ process() æ–¹æ³•</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(AnnotationMetadata annotationMetadata, DeferredImportSelector deferredImportSelector)</span> &#123;<br>            <span class="hljs-comment">// æ­¥éª¤3ï¼š è°ƒç”¨ AutoConfigurationImportSelector ç±»çš„ getAutoConfigurationEntry() æ–¹æ³•</span><br>            <span class="hljs-comment">// æ‰€ä»¥è¿™é‡Œå¹¶æ²¡æœ‰è°ƒç”¨ AutoConfigurationImportSelector ç±»çš„ selectImports() æ–¹æ³•</span><br>			<span class="hljs-type">AutoConfigurationEntry</span> <span class="hljs-variable">autoConfigurationEntry</span> <span class="hljs-operator">=</span> ((AutoConfigurationImportSelector) deferredImportSelector)<br>				.getAutoConfigurationEntry(annotationMetadata);<br>			<span class="hljs-built_in">this</span>.autoConfigurationEntries.add(autoConfigurationEntry);<br>			<span class="hljs-keyword">for</span> (String importClassName : autoConfigurationEntry.getConfigurations()) &#123;<br>				<span class="hljs-built_in">this</span>.entries.putIfAbsent(importClassName, annotationMetadata);<br>			&#125;<br>		&#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>æ­¥éª¤1</strong> å’Œ <strong>æ­¥éª¤2</strong> çš„è°ƒç”¨åœ¨è®²è§£ <code>DeferredImportSelector</code> æ¥å£çš„æ—¶å€™å·²ç»è®²è¿‡äº†ï¼Œè¿™é‡Œç®€å•è´´ä¸€ä¸‹è°ƒç”¨è¿‡ç¨‹</p>
<figure class="highlight leaf"><table><tr><td class="code"><pre><code class="hljs leaf">AbstractApplicationContext<span class="hljs-punctuation">#</span><span class="hljs-keyword">refresh</span><br>    AbstractApplicationContext<span class="hljs-punctuation">#</span><span class="hljs-keyword">invokeBeanFactoryPostProcessors</span><br>        public PostProcessorRegistrationDelegate<span class="hljs-punctuation">#</span><span class="hljs-keyword">invokeBeanFactoryPostProcessors</span><br>            private PostProcessorRegistrationDelegate<span class="hljs-punctuation">#</span><span class="hljs-keyword">invokeBeanDefinitionRegistryPostProcessors</span><br>                ConfigurationClassPostProcessor<span class="hljs-punctuation">#</span><span class="hljs-keyword">postProcessBeanDefinitionRegistry</span><br>                    ConfigurationClassPostProcessor<span class="hljs-punctuation">#</span><span class="hljs-keyword">processConfigBeanDefinitions</span><br>                        ConfigurationClassParser<span class="hljs-punctuation">#</span><span class="hljs-keyword">parse</span><br>                            for å¾ªç¯ start[è§£æå•ä¸ªç±»]<br>                                ConfigurationClassParser<span class="hljs-punctuation">#</span><span class="hljs-keyword">parse</span><span class="hljs-params">(<span class="hljs-variable">AnnotationMetadata</span>, <span class="hljs-variable">java</span>.<span class="hljs-variable">lang</span>.<span class="hljs-variable">String</span>)</span><br>                                    ConfigurationClassParser<span class="hljs-punctuation">#</span><span class="hljs-keyword">processImports</span>    (1)<br>                            for å¾ªç¯ç»“æŸ<br>                            DeferredImportSelectorHandler<span class="hljs-punctuation">#</span><span class="hljs-keyword">process</span>              (2)<br>                                DeferredImportSelectorGroupingHandler<span class="hljs-punctuation">#</span><span class="hljs-keyword">processGroupImports</span><br></code></pre></td></tr></table></figure>
<ol>
<li>åœ¨ <code>(1)</code> ä½ç½®ä¼šæ‰¾åˆ° <code>DeferredImportSelector</code> ç±»å‹çš„ç±»ï¼Œç„¶åç¼“å­˜èµ·æ¥ï¼Œè¿™ä¸ªæ˜¯åœ¨ <code>ConfigurationClassParser</code> çš„ <code>processImports()</code> æ–¹æ³•ä¸­å¤„ç†çš„</li>
<li>æ‰€ä»¥è‡ªå®šä¹‰çš„ç±»éƒ½è§£ææˆ <code>BeanDefiniton</code> ä¹‹å(ä¸Šé¢æµç¨‹ä¸­çš„ <code>for</code> å¾ªç¯ä¹‹å)ï¼Œå¼€å§‹æ‰§è¡Œ <code>DeferredImportSelectorHandler</code> ç±»çš„ <code>process()</code> æ–¹æ³•ï¼Œè¿™æ˜¯å› ä¸º <code>(1)</code> ä¸­ç¼“å­˜çš„ <code>DeferredImportSelector</code> å°±æ˜¯å­˜æ”¾åœ¨ <code>DeferredImportSelectorHandler</code> ç±»ä¸­ï¼Œä¹Ÿå°±æ˜¯åœ¨ <code>(2)</code> ä¸­è°ƒç”¨åˆ° <code>Group</code> ç±»çš„ <code>process()</code> æ–¹æ³•</li>
</ol>
<p>æ¥ä¸‹æ¥ç›´æ¥ä» <strong>æ­¥éª¤3</strong> å¼€å§‹çœ‹,</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  AutoConfigurationGroupç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(AnnotationMetadata annotationMetadata, DeferredImportSelector deferredImportSelector)</span> &#123;<br>    <span class="hljs-comment">// æ­¥éª¤3</span><br>	<span class="hljs-type">AutoConfigurationEntry</span> <span class="hljs-variable">autoConfigurationEntry</span> <span class="hljs-operator">=</span> ((AutoConfigurationImportSelector) deferredImportSelector)<br>	.getAutoConfigurationEntry(annotationMetadata);<br>&#125;<br><br><span class="hljs-comment">//  AutoConfigurationImportSelectorç±»</span><br><span class="hljs-comment">// æ­¥éª¤4ï¼š è¿™ä¸ªæ–¹æ³•æ˜¯ä» Group å®ç°ç±»ä¸­çš„ process() æ–¹æ³•è°ƒç”¨è¿‡æ¥çš„</span><br><span class="hljs-keyword">protected</span> AutoConfigurationEntry <span class="hljs-title function_">getAutoConfigurationEntry</span><span class="hljs-params">(AnnotationMetadata annotationMetadata)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!isEnabled(annotationMetadata)) &#123;<br>        <span class="hljs-keyword">return</span> EMPTY_ENTRY;<br>    &#125;<br>    <span class="hljs-type">AnnotationAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> getAttributes(annotationMetadata);<br>    <span class="hljs-comment">// æ­¥éª¤5ï¼š getCandidateConfigurations æ–¹æ³•ä¼šä»é…ç½®æ–‡ä»¶åŠ è½½ç±»</span><br>    List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes);<br>    configurations = removeDuplicates(configurations);<br>    <span class="hljs-comment">// è·å–æ‰‹åŠ¨æ’é™¤æ‰çš„ç±»ï¼Œæ¯”å¦‚æˆ‘ä»¬é…ç½®äº† exclude ç›¸å…³çš„é…ç½®</span><br>    Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);<br>    checkExcludedClasses(configurations, exclusions);<br>    configurations.removeAll(exclusions);<br>    <span class="hljs-comment">// æ­¥éª¤6ï¼š è¿™é‡Œå°±æ˜¯æ ¹æ®æ¡ä»¶åˆ¤æ–­ï¼Œè¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„ç±»</span><br>    configurations = getConfigurationClassFilter().filter(configurations);<br>    fireAutoConfigurationImportEvents(configurations, exclusions);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AutoConfigurationEntry</span>(configurations, exclusions);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>æ­¥éª¤5</strong> å®Œæˆçš„äº‹æƒ…â€“ä»é…ç½®æ–‡ä»¶è·å–æ•°æ®ï¼Œå¾—åˆ°çš„æ˜¯é…ç½®çš„å…¨é™å®šç±»å</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  AutoConfigurationImportSelector ç±»</span><br><span class="hljs-keyword">protected</span> List&lt;String&gt; <span class="hljs-title function_">getCandidateConfigurations</span><span class="hljs-params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> &#123;<br>    List&lt;String&gt; configurations = ImportCandidates.load(AutoConfiguration.class, getBeanClassLoader())<br>        .getCandidates();<br>    <span class="hljs-keyword">return</span> configurations;<br>&#125;<br><br><span class="hljs-comment">// ImportCandidates ç±»</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LOCATION</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;META-INF/spring/%s.imports&quot;</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ImportCandidates <span class="hljs-title function_">load</span><span class="hljs-params">(Class&lt;?&gt; annotation, ClassLoader classLoader)</span> &#123;<br>    <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoaderToUse</span> <span class="hljs-operator">=</span> decideClassloader(classLoader);<br>    <span class="hljs-comment">//  location = META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">location</span> <span class="hljs-operator">=</span> String.format(LOCATION, annotation.getName());<br>    <span class="hljs-comment">//  é€šè¿‡ ClassLoader è¯»å– META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</span><br>    <span class="hljs-comment">// æ–‡ä»¶, è¿™ä¸ªä¸æ˜¯æŸä¸ª jar åŒ…ï¼Œè€Œæ˜¯ classpath ä¸‹çš„æ‰€æœ‰jar åŒ…å¯¹åº”è·¯å¾„çš„æ–‡ä»¶</span><br>    <span class="hljs-comment">// æ‰€ä»¥è¿”å›çš„æ˜¯ url çš„é›†åˆ</span><br>    Enumeration&lt;URL&gt; urls = findUrlsInClasspath(classLoaderToUse, location);<br>    List&lt;String&gt; importCandidates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">while</span> (urls.hasMoreElements()) &#123;<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> urls.nextElement();<br>        <span class="hljs-comment">// éå†æ¯ä¸ª urlï¼Œ è¯»å–å¯¹åº”çš„æ–‡ä»¶å†…å®¹ï¼Œ ç„¶åå°†æ–‡ä»¶å†…å®¹ä¸­çš„å†…å®¹æ·»åŠ åˆ° importCandidates ä¸­</span><br>        importCandidates.addAll(readCandidateConfigurations(url));<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImportCandidates</span>(importCandidates);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ä¸‹é¢æˆªå– <code>spring-boot-autoconfigure</code> è¿™ä¸ªåŒ…ä¸‹ <code>org.springframework.boot.autoconfigure.AutoConfiguration.imports</code> æ–‡ä»¶çš„ä¸€éƒ¨åˆ†å†…å®¹çœ‹çœ‹</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.boot</span><span class="hljs-selector-class">.autoconfigure</span><span class="hljs-selector-class">.admin</span><span class="hljs-selector-class">.SpringApplicationAdminJmxAutoConfiguration</span><br>org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.boot</span><span class="hljs-selector-class">.autoconfigure</span><span class="hljs-selector-class">.aop</span><span class="hljs-selector-class">.AopAutoConfiguration</span><br>org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.boot</span><span class="hljs-selector-class">.autoconfigure</span><span class="hljs-selector-class">.amqp</span><span class="hljs-selector-class">.RabbitAutoConfiguration</span><br>org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.boot</span><span class="hljs-selector-class">.autoconfigure</span><span class="hljs-selector-class">.batch</span><span class="hljs-selector-class">.BatchAutoConfiguration</span><br>â€¦â€¦<br></code></pre></td></tr></table></figure>

<p>å°±æ˜¯ä¸€è¡Œä¸€ä¸ªå…¨é™å®šç±»åè€Œå·²ï¼Œå’Œ <code>SpringBoot2.7</code> ä¹‹å‰çš„ <code>spring.factories</code> æ–‡ä»¶æ˜¯ä¸åŒçš„ï¼Œè¿™é‡Œä¹Ÿæ‹¿ä¸€ä¸ª <code>spring.factories</code> æ–‡ä»¶å†…å®¹å¯¹æ¯”ä¸€ä¸‹</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment"># è¿™æ˜¯ä¸€ä¸ª key</span><br><span class="hljs-keyword">org.springframework.boot.autoconfigure.AutoConfigurationImportFilter=\</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">org.springframework.boot.autoconfigure.condition.OnBeanCondition,\</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">org.springframework.boot.autoconfigure.condition.OnClassCondition,\</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">org.springframework.boot.autoconfigure.condition.OnWebApplicationCondition</span><br><span class="hljs-keyword"></span><br><span class="hljs-comment"># Auto Configure</span><br><span class="hljs-comment"># è¿™æ˜¯è‡ªåŠ¨è£…é…çš„ key</span><br><span class="hljs-keyword">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span><br><span class="hljs-keyword"></span>â€¦â€¦<br></code></pre></td></tr></table></figure>

<p><strong>æ­¥éª¤6</strong>å®Œæˆçš„äº‹æƒ…ï¼Œå¯¹ <strong>æ­¥éª¤5</strong>ä¸­è·å–çš„å…¨é™å®šç±»åè¿›è¡Œè¿‡æ»¤</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  AutoConfigurationImportSelectorç±»</span><br><span class="hljs-comment">// æ­¥éª¤4ï¼š è¿™ä¸ªæ–¹æ³•æ˜¯ä» Group å®ç°ç±»ä¸­çš„ process() æ–¹æ³•è°ƒç”¨è¿‡æ¥çš„</span><br><span class="hljs-keyword">protected</span> AutoConfigurationEntry <span class="hljs-title function_">getAutoConfigurationEntry</span><span class="hljs-params">(AnnotationMetadata annotationMetadata)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!isEnabled(annotationMetadata)) &#123;<br>        <span class="hljs-keyword">return</span> EMPTY_ENTRY;<br>    &#125;<br>    <span class="hljs-type">AnnotationAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> getAttributes(annotationMetadata);<br>    <span class="hljs-comment">// æ­¥éª¤5ï¼š getCandidateConfigurations æ–¹æ³•ä¼šä»é…ç½®æ–‡ä»¶åŠ è½½ç±»</span><br>    List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes);<br>    configurations = removeDuplicates(configurations);<br>    <span class="hljs-comment">// è·å–æ‰‹åŠ¨æ’é™¤æ‰çš„ç±»ï¼Œæ¯”å¦‚æˆ‘ä»¬é…ç½®äº† exclude ç›¸å…³çš„é…ç½®</span><br>    Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);<br>    checkExcludedClasses(configurations, exclusions);<br>    configurations.removeAll(exclusions);<br>    <span class="hljs-comment">// æ­¥éª¤6ï¼š è¿™é‡Œå°±æ˜¯æ ¹æ®æ¡ä»¶åˆ¤æ–­ï¼Œè¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„ç±»</span><br>    configurations = getConfigurationClassFilter().filter(configurations);<br>    fireAutoConfigurationImportEvents(configurations, exclusions);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AutoConfigurationEntry</span>(configurations, exclusions);<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li>è°ƒç”¨ <code>getConfigurationClassFilter()</code> æ–¹æ³•è·å– <code>classFilter</code>, è¿™ä¸ªä¸è·Ÿä¸‹å»äº†ï¼Œç›´æ¥è¯´ç»“è®ºï¼Œå…¶å®ä¹Ÿæ˜¯æ ¹æ® <code>spi</code> æœºåˆ¶ä» <code>spring.factories</code> æ–‡ä»¶ä¸­è·å–çš„ï¼Œä»ä¸Šé¢åˆ—å‡ºçš„ <code>spring.factories</code> æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯ <code>key=values</code> çš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª <code>key</code> å¯ä»¥é…ç½®å¤šä¸ªå€¼ï¼Œè€Œè·å– <code>classFilter</code> çš„ <code>key</code> æ˜¯ <code>AutoConfigurationImportFilter</code>ï¼Œ å†çœ‹çœ‹ <code>spring.factories</code> æ–‡ä»¶ä¸­å…³äº <code>AutoConfigurationImportFilter</code> çš„é…ç½®</li>
</ol>
<figure class="highlight livescript"><table><tr><td class="code"><pre><code class="hljs livescript"><span class="hljs-comment"># è¿™ä¸ªé…ç½®æ–‡ä»¶ä¹Ÿæ˜¯åœ¨ spring-boot-autoconfigure åŒ…ä¸‹é¢</span><br><span class="hljs-comment"># Auto Configuration Import Filters</span><br>org.springframework.boot.autoconfigure.AutoConfigurationImportFilter=<span class="hljs-string">\</span><br>org.springframework.boot.autoconfigure.condition.OnBeanCondition,<span class="hljs-string">\</span><br>org.springframework.boot.autoconfigure.condition.OnClassCondition,<span class="hljs-string">\</span><br>org.springframework.boot.autoconfigure.condition.OnWebApplicationCondition<br></code></pre></td></tr></table></figure>

<ol start="2">
<li><code>getConfigurationClassFilter()</code> æ–¹æ³•çš„è¿”å›å€¼æ˜¯ <code>ConfigurationClassFilter</code>ï¼Œ çœ‹çœ‹è¿™ä¸ªç±»ï¼Œå…·ä½“çš„è¿‡æ»¤é€»è¾‘è¿™é‡Œå°±ä¸å†åˆ†æ</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationClassFilter</span> &#123;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AutoConfigurationMetadata autoConfigurationMetadata;<br>    <span class="hljs-comment">// ä¸Šé¢è®²åˆ°ä¼šä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½åˆ°ä¸‰ä¸ª AutoConfigurationImportFilter å®ç°ç±»ï¼Œä¼šä¿å­˜åœ¨è¿™é‡Œç„¶åè°ƒç”¨è¿‡æ»¤æ–¹æ³•</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;AutoConfigurationImportFilter&gt; filters;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="è§£ææ–‡ä»¶å’Œè¿‡æ»¤åçš„å¤„ç†"><a href="#è§£ææ–‡ä»¶å’Œè¿‡æ»¤åçš„å¤„ç†" class="headerlink" title="è§£ææ–‡ä»¶å’Œè¿‡æ»¤åçš„å¤„ç†"></a>è§£ææ–‡ä»¶å’Œè¿‡æ»¤åçš„å¤„ç†</h3><p>é…ç½®æ–‡ä»¶ä¹Ÿè§£æäº†ï¼Œè¿‡æ»¤ä¹Ÿè¿‡æ»¤å®Œäº†ï¼Œå›è¿‡å¤´å†çœ‹çœ‹ <code>Group</code> ç±»çš„ <code>process()</code> æ–¹æ³•æ˜¯ä»å“ªé‡Œè°ƒç”¨è¿‡æ¥çš„ï¼Œå‰é¢æœ‰ï¼Œè¿™é‡Œå†è´´ä¸€ä¸‹æµç¨‹</p>
<figure class="highlight leaf"><table><tr><td class="code"><pre><code class="hljs leaf">AbstractApplicationContext<span class="hljs-punctuation">#</span><span class="hljs-keyword">refresh</span><br>    AbstractApplicationContext<span class="hljs-punctuation">#</span><span class="hljs-keyword">invokeBeanFactoryPostProcessors</span><br>        public PostProcessorRegistrationDelegate<span class="hljs-punctuation">#</span><span class="hljs-keyword">invokeBeanFactoryPostProcessors</span><br>            private PostProcessorRegistrationDelegate<span class="hljs-punctuation">#</span><span class="hljs-keyword">invokeBeanDefinitionRegistryPostProcessors</span><br>                ConfigurationClassPostProcessor<span class="hljs-punctuation">#</span><span class="hljs-keyword">postProcessBeanDefinitionRegistry</span><br>                    ConfigurationClassPostProcessor<span class="hljs-punctuation">#</span><span class="hljs-keyword">processConfigBeanDefinitions</span><br>                        ConfigurationClassParser<span class="hljs-punctuation">#</span><span class="hljs-keyword">parse</span><br>                            for å¾ªç¯ start[è§£æå•ä¸ªç±»]<br>                                ConfigurationClassParser<span class="hljs-punctuation">#</span><span class="hljs-keyword">parse</span><span class="hljs-params">(<span class="hljs-variable">AnnotationMetadata</span>, <span class="hljs-variable">java</span>.<span class="hljs-variable">lang</span>.<span class="hljs-variable">String</span>)</span><br>                                    ConfigurationClassParser<span class="hljs-punctuation">#</span><span class="hljs-keyword">processImports</span><br>                            for å¾ªç¯ç»“æŸ<br>                            DeferredImportSelectorHandler<span class="hljs-punctuation">#</span><span class="hljs-keyword">process</span><br>                                DeferredImportSelectorGroupingHandler<span class="hljs-punctuation">#</span><span class="hljs-keyword">processGroupImports</span><br></code></pre></td></tr></table></figure>

<p>æ‰€ä»¥æ˜¯åœ¨ <strong>DeferredImportSelectorHandler</strong> çš„ç±» <code>process()</code> æ–¹æ³•ä¸­å¤„ç†çš„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  ConfigurationClassParser</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processGroupImports</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (DeferredImportSelectorGrouping grouping : <span class="hljs-built_in">this</span>.groupings.values()) &#123;<br>        Predicate&lt;String&gt; exclusionFilter = grouping.getCandidateFilter();<br>        <span class="hljs-comment">// å°±æ˜¯åœ¨ getImport() æ–¹æ³•ä¸­è°ƒç”¨åˆ° Group å®ç°ç±»çš„ process() æ–¹æ³•</span><br>        <span class="hljs-comment">// è¿”å›å€¼ Group å®ç°ç±»çš„ selectImports æ–¹æ³•</span><br>        grouping.getImports().forEach(entry -&gt; &#123;<br>            <span class="hljs-type">ConfigurationClass</span> <span class="hljs-variable">configurationClass</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.configurationClasses.get(entry.getMetadata());<br>            <span class="hljs-comment">// æ‹¿åˆ°ç»“æœä¹‹åè°ƒç”¨çš„åˆæ˜¯  processImportsæ–¹æ³•ï¼Œ è¿™ä¸ªå°±æ˜¯å’Œ</span><br>            <span class="hljs-comment">// @Import å¯¼å…¥çš„æ˜¯ä¸€ä¸ªæ™®é€šç±»çš„æµç¨‹ä¸€è‡´çš„</span><br>            processImports(configurationClass, asSourceClass(configurationClass, exclusionFilter),<br>                        Collections.singleton(asSourceClass(entry.getImportClassName(), exclusionFilter)),<br>                        exclusionFilter, <span class="hljs-literal">false</span>);<br>        &#125;);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//  ConfigurationClassParser</span><br><span class="hljs-keyword">public</span> Iterable&lt;Group.Entry&gt; getImports() &#123;<br>    <span class="hljs-keyword">for</span> (DeferredImportSelectorHolder deferredImport : <span class="hljs-built_in">this</span>.deferredImports) &#123;<br>        <span class="hljs-comment">//  å°±æ˜¯åœ¨è¿™é‡Œè°ƒç”¨åˆ° Group å®ç°ç±»çš„ process() æ–¹æ³•</span><br>        <span class="hljs-built_in">this</span>.group.process(deferredImport.getConfigurationClass().getMetadata(),<br>                deferredImport.getImportSelector());<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.group.selectImports();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢ä»£ç çœ‹åˆ°ï¼Œæ‹¿åˆ°è§£æå’Œç»“æœçš„ç»“æœä¹‹åï¼Œé€šè¿‡ <code>foreach</code> è°ƒç”¨ <code>processImports()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å¤„ç†å•ä¸ª <code>@Import</code> å¯¼å…¥çš„ç±»çš„æ–¹æ³•ï¼Œè‡³æ­¤æ•´ä¸ªæµç¨‹å°±ä¸²èµ·æ¥äº†</p>
]]></content>
      <categories>
        <category>java</category>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot3è‡ªåŠ¨è£…é…æ¡ˆä¾‹</title>
    <url>/2023/ee343b448bf4/index.html</url>
    <content><![CDATA[<p>åˆ›å»ºä¸¤ä¸ª <code>module</code></p>
<ol>
<li><code>demo-starter</code>, è¿™ä¸ª <code>module</code> æ˜¯ä¸ºäº†è®©åˆ«çš„ <code>module</code> å¼•å…¥çš„ <code>starter</code> åŒ…</li>
<li><code>demo-main</code>, è¿™ä¸ª <code>module</code> ä¼šå¼•å…¥ <code>demo-starter</code> åŒ…</li>
</ol>
<p>ä¸¤ä¸ª <code>module</code> çš„åŒ…ç»“æ„å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">demo-starter<br>â”‚  â”œâ”€<span class="hljs-attribute">src</span><br>â”‚  â”‚  â”œâ”€<span class="hljs-selector-tag">main</span><br>â”‚  â”‚  â”‚  â”œâ”€java<br>â”‚  â”‚  â”‚  â”‚  â””â”€com<br>â”‚  â”‚  â”‚  â”‚      â””â”€example<br>â”‚  â”‚  â”‚  â”‚          â””â”€demostarter åŒ…ä¸‹æœ‰ StarterDemo ç±»<br>â”‚  â”‚  â”‚  â””â”€resources<br>â”‚  â”‚  â”‚      â””â”€META-INF<br>â”‚  â”‚  â”‚          â””â”€spring  æ–‡ä»¶å¤¹ä¸‹æœ‰ org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.boot</span><span class="hljs-selector-class">.autoconfigure</span><span class="hljs-selector-class">.AutoConfiguration</span><span class="hljs-selector-class">.imports</span> æ–‡ä»¶<br><br></code></pre></td></tr></table></figure>

<p><code>StarterDemo</code> ç±»å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StarterDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">starterDemo</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;StarterDemo&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>org.springframework.boot.autoconfigure.AutoConfiguration.imports</code> æ–‡ä»¶å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.demostarter</span>.StarterDemo<br></code></pre></td></tr></table></figure>

<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">demo-main<br>â”‚  â”œâ”€.mvn<br>â”‚  â”‚  â””â”€<span class="hljs-keyword">wrapper</span><br>â”‚  â”œâ”€src<br>â”‚  â”‚  â”œâ”€main<br>â”‚  â”‚  â”‚  â”œâ”€java<br>â”‚  â”‚  â”‚  â”‚  â””â”€com<br>â”‚  â”‚  â”‚  â”‚      â””â”€example<br>â”‚  â”‚  â”‚  â”‚          â””â”€demomain åŒ…ä¸‹æœ‰ DemoMainApplication ç±»<br>â”‚  â”‚  â”‚  â””â”€resources<br><br></code></pre></td></tr></table></figure>

<p><code>DemoMainApplication</code> ç±»å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoMainApplication</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationContext context;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(DemoMainApplication.class, args);<br>        <span class="hljs-comment">// åªæ˜¯å¼•å…¥äº†ä¾èµ–è€Œå·²ï¼Œå¹¶æ²¡æœ‰æ‰‹åŠ¨æ³¨å…¥ StarterDemo ç±»</span><br>        <span class="hljs-comment">// ä½†æ˜¯è¿™ä¸ªç±»ä¹Ÿåœ¨ spring å®¹å™¨ä¸­ï¼Œå°±æ˜¯å› ä¸ºè‡ªåŠ¨è£…é…</span><br>        context.getBean(StarterDemo.class).starterDemo(); <span class="hljs-comment">// ä¼šè¾“å‡º â€œStarterDemoâ€</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        context = applicationContext;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>demo-main</code> çš„ <code>pom.xml</code> ä¾èµ–å¦‚ä¸‹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>demo-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBootå®ç°æ–‡ä»¶çš„ä¸Šä¼ ä¸‹è½½</title>
    <url>/2023/ca7a5b96a543/index.html</url>
    <content><![CDATA[<h2 id="æ–‡ä»¶ä¸Šä¼ "><a href="#æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="æ–‡ä»¶ä¸Šä¼ "></a>æ–‡ä»¶ä¸Šä¼ </h2><p><code>Controller</code> å±‚ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(value = &quot;/db/execute&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;files&quot;)</span> MultipartFile[] multipartFiles)</span> &#123;<br>    uploadService.uploadFile(multipartFiles);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>UploadService</code> ç±»ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UploadService</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(MultipartFile[] multipartFiles)</span> &#123;<br>        <span class="hljs-keyword">for</span> (MultipartFile multipartFile : multipartFiles) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">folder</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/tmp/upload&quot;</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> multipartFile.getOriginalFilename();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> createFile(folderPath, filename);<br>                multipartFile.transferTo(file);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                logger.error(<span class="hljs-string">&quot;store sql file error&quot;</span>, e);<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> File <span class="hljs-title function_">createFile</span><span class="hljs-params">(String folderPath, String filename)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> FileUtils.getFile(folderPath);<br>        <span class="hljs-keyword">if</span> (!file.exists()) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">boolean</span> <span class="hljs-variable">folderCreated</span> <span class="hljs-operator">=</span> file.mkdirs();<br>                <span class="hljs-keyword">if</span> (!folderCreated &amp;&amp; !file.exists()) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Unable to create path&quot;</span>);<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (SecurityException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Unable to create path&quot;</span>, e);<br>            &#125;<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fullFilePath</span> <span class="hljs-operator">=</span> folderPath + File.separator + filename;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(fullFilePath);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="æ–‡ä»¶ä¸‹è½½"><a href="#æ–‡ä»¶ä¸‹è½½" class="headerlink" title="æ–‡ä»¶ä¸‹è½½"></a>æ–‡ä»¶ä¸‹è½½</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileDownloadController</span> &#123;<br><br>    <span class="hljs-meta">@PostMapping(value = &quot;/package/batch/download&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchDownloadPackage</span><span class="hljs-params">(HttpServletResponse response,  <span class="hljs-meta">@RequestParam</span> String storePath)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> fileDownloadService.buildResource(storePath);<br>        fileDownloadService.writeResponse(response, resource);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<pre><code class="java">public class FileDownloadService &#123;
    // æ ¹æ®èµ„æºåœ°å€æ„å»º resource å¯¹è±¡æˆ–è€… fileå¯¹è±¡
    public Resource buildResource(String storePath) &#123;
        Path filePath = Paths.get(storePath);
        Resource resource = null;
        try &#123;
            resource = new UrlResource(filePath.toUri());
        &#125; catch (MalformedURLException e) &#123;
            logger.warn(&quot;Could not read file&quot;);
            return null;
        &#125;
        if (resource.exists() &amp;&amp; resource.isReadable()) &#123;
            return resource;
        &#125; else &#123;
            logger.warn(&quot;Could not read file&quot;);
            return null;
        &#125;
    &#125;

    // å“åº”ç»“æœ
    public void writeResponse(HttpServletResponse response, Resource resource) throws IOException &#123;
        if (Objects.isNull(resource)) &#123;
            buildResponseHeader(response, null);
            return;
        &#125;
        try (InputStream inputStream = new FileInputStream(resource.getFile())) &#123;
            buildResponseHeader(response, resource);
            ServletOutputStream outputStream = response.getOutputStream();
            byte[] b = new byte[1024];
            int len;
            //ä»è¾“å…¥æµä¸­è¯»å–ä¸€å®šæ•°é‡çš„å­—èŠ‚ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ç¼“å†²åŒºå­—èŠ‚æ•°ç»„ä¸­ï¼Œè¯»åˆ°æœ«å°¾è¿”å›-1
            while ((len = inputStream.read(b)) &gt; 0) &#123;
                outputStream.write(b, 0, len);
            &#125;
        &#125; catch (IOException ex) &#123;
            ex.printStackTrace();
        &#125;
    &#125;

    // è®¾ç½®å“åº”å¤´
    private void buildResponseHeader(HttpServletResponse response, Resource resource) throws IOException &#123;
        // è¯»åˆ°æµä¸­
        response.reset();
        response.setContentType(&quot;application/octet-stream&quot;);
        response.addHeader(&quot;Content-Disposition&quot;, &quot;attachment; filename=&quot; + URLEncoder.encode(Objects.isNull(resource) ? &quot;æ–‡ä»¶ä¸å­˜åœ¨&quot; : resource.getFilename(), &quot;UTF-8&quot;));
        /**
         * CORSè¯·æ±‚æ—¶ï¼ŒXMLHttpRequestå¯¹è±¡çš„getResponseHeader()æ–¹æ³•åªèƒ½æ‹¿åˆ°6ä¸ªåŸºæœ¬å­—æ®µï¼šCache-Controlã€Content-Languageã€
         * Content-Typeã€Expiresã€Last-Modifiedã€Pragmaã€‚å¦‚æœæƒ³æ‹¿åˆ°å…¶ä»–å­—æ®µï¼Œå°±å¿…é¡»åœ¨Access-Control-Expose-Headersé‡Œé¢æŒ‡å®š
         */
        response.setHeader(&quot;Access-Control-Expose-Headers&quot;, &quot;Content-disposition&quot;);
        response.addHeader(&quot;Content-Length&quot;, &quot;&quot; + (Objects.isNull(resource) ? 0 : resource.contentLength()));
    &#125;
&#125;
</code></pre>
]]></content>
      <categories>
        <category>java</category>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBootç¼–å†™æµ‹è¯•ç±»</title>
    <url>/2023/9cd70dc15320/index.html</url>
    <content><![CDATA[<p>ç‰ˆæœ¬è¯´æ˜ï¼š</p>
<ol>
<li>SpringBoot3.x</li>
</ol>
<h2 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h2><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="ç¼–å†™æµ‹è¯•ç±»"><a href="#ç¼–å†™æµ‹è¯•ç±»" class="headerlink" title="ç¼–å†™æµ‹è¯•ç±»"></a>ç¼–å†™æµ‹è¯•ç±»</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestRedis</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testOne</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;æµ‹è¯•ç±»&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="æ³¨æ„ç‚¹"><a href="#æ³¨æ„ç‚¹" class="headerlink" title="æ³¨æ„ç‚¹"></a>æ³¨æ„ç‚¹</h3><ol>
<li><code>SpringBoot2.5</code> ä¹‹åæµ‹è¯•ç±»ä¸­å·²ç»ä¸éœ€è¦æ·»åŠ  <code>RunWith</code> æ³¨è§£ï¼Œåªéœ€è¦ä¸€ä¸ª <code>SpringBootTest</code></li>
<li>éœ€è¦ä¿è¯æµ‹è¯•ç±»æ‰€åœ¨çš„åŒ…å’Œé¡¹ç›®ä¸»é…ç½®ç±»åŒ…ä¸€è‡´ï¼ˆé¡¹ç›® <code>main</code> æ–¹æ³•æ‰€åœ¨çš„åŒ…ï¼‰ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œåˆ™å¯ä»¥æŒ‰ç…§ä¸‹é¢æ–¹å¼é…ç½®</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest(classes = TestApplication.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestRedis</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testOne</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;æµ‹è¯•ç±»&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>è§£å†³SpringBootä¸­Request.getInputStreamåªèƒ½è°ƒç”¨ä¸€æ¬¡çš„é—®é¢˜</title>
    <url>/2023/ded68009e52a/index.html</url>
    <content><![CDATA[<p><a href="https://www.cnblogs.com/spll/p/9685686.html">ä»RequeståŸŸè·å–å‚æ•°çš„å‡ ç§æ–¹å¼</a></p>
<h2 id="è°ƒç”¨-Request-getInputStream-çš„é—®é¢˜"><a href="#è°ƒç”¨-Request-getInputStream-çš„é—®é¢˜" class="headerlink" title="è°ƒç”¨ Request.getInputStream çš„é—®é¢˜"></a>è°ƒç”¨ Request.getInputStream çš„é—®é¢˜</h2><p>è·å– <code>post</code> æ–¹æ³•å‚æ•° <code>content-type</code> ä¸º <code>application/json</code> æ—¶ <code>HttpServletRequest.getInputStream</code> æ–¹æ³•åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œ å¦‚æœåœ¨æ‹¦æˆªå™¨é‡Œé¢å·²ç»è°ƒç”¨äº†æ¥è·å–å‚æ•°ï¼Œæ¯”å¦‚è·å– <code>token</code> ä¿¡æ¯ç­‰ï¼Œåœ¨ <code>Controller</code> ä¸­è§£æå‚æ•°æ—¶å°±ä¼šæŠ¥é”™</p>
<h2 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h2><ul>
<li>å¯¹ <code>HttpServletRequest</code> åŒ…è£…ä¸€å±‚</li>
<li>ä½¿ç”¨ <code>filterChain.doFilter(request, response)</code> å‘ä¸‹ä¼ é€’ <code>request</code> çš„æ—¶å€™ä½¿ç”¨æˆ‘ä»¬åŒ…è£…çš„ <code>request</code></li>
</ul>
<h2 id="è‡ªå®šä¹‰ç±»å®ç°-HttpServletRequestWrapper"><a href="#è‡ªå®šä¹‰ç±»å®ç°-HttpServletRequestWrapper" class="headerlink" title="è‡ªå®šä¹‰ç±»å®ç° HttpServletRequestWrapper"></a>è‡ªå®šä¹‰ç±»å®ç° HttpServletRequestWrapper</h2><p>è‡ªå®šä¹‰ç»§æ‰¿ <code>HttpServletRequestWrapper</code> ç±»çš„ä½œç”¨æ˜¯å…ˆè°ƒç”¨ä¸€æ¬¡ <code>request.getInputStream()</code>ï¼Œå°†æµä¸­çš„ä¿¡æ¯è¯»å–åç¼“å­˜èµ·æ¥ï¼Œåç»­ä½¿ç”¨çš„æ—¶å€™å°±ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–å°±å¥½</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><span class="hljs-keyword">import</span> javax.servlet.ReadListener;<br><span class="hljs-keyword">import</span> javax.servlet.ServletInputStream;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequestWrapper;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * æ‰©å±• HttpServletRequestWrapperï¼Œ è§£å†³ request.getInputStream() æ–¹æ³•åªèƒ½è¯»å–ä¸€æ¬¡çš„é—®é¢˜</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServletRequestWrapper</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(RequestWrapper.class);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String body;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RequestWrapper</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>        <span class="hljs-built_in">super</span>(request);<br>        <span class="hljs-comment">//å¤šæ¬¡è¯»å–</span><br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">stringBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            inputStream = request.getInputStream();<br>            <span class="hljs-keyword">if</span> (inputStream != <span class="hljs-literal">null</span>) &#123;<br>                bufferedReader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream));<br>                <span class="hljs-type">char</span>[] charBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">128</span>];<br>                <span class="hljs-type">int</span> <span class="hljs-variable">bytesRead</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">while</span> ((bytesRead = bufferedReader.read(charBuffer)) &gt; <span class="hljs-number">0</span>) &#123;<br>                    stringBuilder.append(charBuffer, <span class="hljs-number">0</span>, bytesRead);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                stringBuilder.append(<span class="hljs-string">&quot;&quot;</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>            logger.error(<span class="hljs-string">&quot;è§£æ request.getInputStream æµå‡ºé”™:&#123;&#125;&quot;</span>, ex);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (inputStream != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    inputStream.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    logger.error(<span class="hljs-string">&quot;å…³é—­æµå‡ºé”™ï¼š&#123;&#125;&quot;</span>, e);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (bufferedReader != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    bufferedReader.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    logger.error(<span class="hljs-string">&quot;å…³é—­æµå‡ºé”™ï¼š&#123;&#125;&quot;</span>, e);<br>                &#125;<br>            &#125;<br>        &#125;<br>        body = stringBuilder.toString();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ServletInputStream <span class="hljs-title function_">getInputStream</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">byteArrayInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(body.getBytes(StandardCharsets.UTF_8));<br>        <span class="hljs-type">ServletInputStream</span> <span class="hljs-variable">servletInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletInputStream</span>() &#123;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFinished</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isReady</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setReadListener</span><span class="hljs-params">(ReadListener readListener)</span> &#123;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">read</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                <span class="hljs-keyword">return</span> byteArrayInputStream.read();<br>            &#125;<br>        &#125;;<br>        <span class="hljs-keyword">return</span> servletInputStream;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> BufferedReader <span class="hljs-title function_">getReader</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(<span class="hljs-built_in">this</span>.getInputStream()));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getBody</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.body;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="è‡ªå®šä¹‰-Filter"><a href="#è‡ªå®šä¹‰-Filter" class="headerlink" title="è‡ªå®šä¹‰ Filter"></a>è‡ªå®šä¹‰ Filter</h2><p>ä¸Šé¢å·²ç»è‡ªå®šä¹‰äº† <code>HttpServletRequestWrapper</code> å®ç°ç±»ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¦ä½¿ç”¨è¿™ä¸ªç±»æ¥æ›¿æ¢æ‰ <code>HttpServletRequest</code> äº†ï¼Œæ›¿æ¢çš„æ“ä½œæ˜¯åœ¨ <code>Filter</code> ç±»ä¸­å®Œæˆ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span><br>    <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-comment">// å°† HttpServletRequest è½¬æ¢æˆè‡ªå®šä¹‰çš„å®ç°äº† HttpServletRequestWrapper çš„ RequestWrapper</span><br>        <span class="hljs-type">RequestWrapper</span> <span class="hljs-variable">requestWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestWrapper</span>(request);<br>        <span class="hljs-comment">// è·å–å‚æ•°</span><br>        Map&lt;String, Object&gt; parameters = getParameters(requestWrapper);<br>        filterChain.doFilter(requestWrapper, response);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getParameters</span><span class="hljs-params">(RequestWrapper request)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> request.getBody();<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(body)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        &#125;<br>        Map&lt;String, Object&gt; resultMap = objectMapper.readValue(body,<br>             <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;Map&lt;String, Object&gt;&gt;() &#123;&#125;);<br>        <span class="hljs-keyword">return</span> resultMap;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>java</category>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloudAlibabaå’ŒSpringCloudå’ŒSpringBootä¹‹é—´ç‰ˆæœ¬å¯¹åº”å…³ç³»</title>
    <url>/2023/742b64bccf7c/index.html</url>
    <content><![CDATA[<h2 id="SpringClound-å’Œ-SpringBoot-çš„ç‰ˆæœ¬å¯¹åº”"><a href="#SpringClound-å’Œ-SpringBoot-çš„ç‰ˆæœ¬å¯¹åº”" class="headerlink" title="SpringClound å’Œ SpringBoot çš„ç‰ˆæœ¬å¯¹åº”"></a>SpringClound å’Œ SpringBoot çš„ç‰ˆæœ¬å¯¹åº”</h2><p><a href="https://spring.io/projects/spring-cloud">Springå®˜ç½‘ä¹‹SpringCloudé¡¹ç›®</a></p>
<h2 id="SpringCloundAlibaba-å’Œ-SpringCloud-çš„ç‰ˆæœ¬å¯¹åº”"><a href="#SpringCloundAlibaba-å’Œ-SpringCloud-çš„ç‰ˆæœ¬å¯¹åº”" class="headerlink" title="SpringCloundAlibaba å’Œ SpringCloud çš„ç‰ˆæœ¬å¯¹åº”"></a>SpringCloundAlibaba å’Œ SpringCloud çš„ç‰ˆæœ¬å¯¹åº”</h2><p><a href="https://sca.aliyun.com/zh-cn/">SpringCloundAlibabaå®˜ç½‘</a></p>
<p><a href="https://sca.aliyun.com/zh-cn/docs/2022.0.0.0/overview/version-explain">SpringCloundAlibaba2022ç‰ˆæœ¬å¯¹åº”æ–‡æ¡£è¯´æ˜</a></p>
]]></content>
      <categories>
        <category>java</category>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>RestTemplateè°ƒç”¨æ—¶æ·»åŠ è¯·æ±‚å¤´</title>
    <url>/2024/c0337b25d19d/index.html</url>
    <content><![CDATA[<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.http.HttpEntity;<br><span class="hljs-keyword">import</span> org.springframework.http.HttpHeaders;<br><span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RestTemplateTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">HttpHeaders</span> <span class="hljs-variable">httpHeaders</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpHeaders</span>();<br>        <span class="hljs-comment">// è‡ªå®šä¹‰è¯·æ±‚å¤´</span><br>        httpHeaders.add(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">requestBody</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">HttpEntity</span> <span class="hljs-variable">httpEntity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpEntity</span>(requestBody, httpHeaders);<br>        <span class="hljs-type">RestTemplate</span> <span class="hljs-variable">restTemplate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br>        restTemplate.postForObject(url, httpEntity, Boolean.class);<br>    &#125;<br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>java</category>
        <category>SpringWeb</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringWeb</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¼–è¯‘tomcat9æºç å¹¶å¯¼å…¥idea</title>
    <url>/2024/841970b953bf/index.html</url>
    <content><![CDATA[<blockquote>
<p>tomcatç‰ˆæœ¬ï¼š9.0.84<br>jdkç‰ˆæœ¬ï¼š17</p>
</blockquote>
<h2 id="ä¸‹è½½-tomcat9-æºç "><a href="#ä¸‹è½½-tomcat9-æºç " class="headerlink" title="ä¸‹è½½ tomcat9 æºç "></a>ä¸‹è½½ tomcat9 æºç </h2><p><a href="https://tomcat.apache.org/download-90.cgi">ä¸‹è½½tomcat9</a><br>é€‰æ‹©ä¸‹è½½é¡µé¢æœ€ä¸‹æ–¹çš„ <code>Source Code Distributions</code> ä¸‹çš„ <code>zip</code> åŒ…</p>
<h2 id="æºç å¯¼å…¥ideaä¹‹å‰çš„å‡†å¤‡"><a href="#æºç å¯¼å…¥ideaä¹‹å‰çš„å‡†å¤‡" class="headerlink" title="æºç å¯¼å…¥ideaä¹‹å‰çš„å‡†å¤‡"></a>æºç å¯¼å…¥ideaä¹‹å‰çš„å‡†å¤‡</h2><ol>
<li>è§£å‹ä¸‹è½½çš„æºç ï¼Œå¾—åˆ°ç›®å½• <code>apache-tomcat-9.0.84-src</code></li>
<li>è¿›å…¥ <code>apache-tomcat-9.0.84-src</code>  ç›®å½•ï¼Œåˆ›å»ºä¸€ä¸ª <code>pom.xml</code> æ–‡ä»¶ï¼Œ<code>pom</code> æ–‡ä»¶å†…å®¹ä¼šåœ¨ä¸‹æ–¹ç»™å‡º</li>
<li>åœ¨ <code>apache-tomcat-9.0.84-src</code> ç›®å½•ä¸­åˆ›å»º <code>source</code> æ–‡ä»¶å¤¹</li>
<li>å°† <code>conf</code>ã€<code>webapps</code> ç›®å½•ç§»åŠ¨åˆ°åˆšåˆšåˆ›å»ºçš„ <code>source</code> æ–‡ä»¶å¤¹ä¸­</li>
</ol>
<h3 id="åˆ›å»ºçš„-pom-xml-æ–‡ä»¶å†…å®¹"><a href="#åˆ›å»ºçš„-pom-xml-æ–‡ä»¶å†…å®¹" class="headerlink" title="åˆ›å»ºçš„ pom.xml æ–‡ä»¶å†…å®¹"></a>åˆ›å»ºçš„ pom.xml æ–‡ä»¶å†…å®¹</h3><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0</span></span><br><span class="hljs-string"><span class="hljs-tag">http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>apache-tomcat-9.0.84-src<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Tomcat9.0<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>Tomcat9.0<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">sourceDirectory</span>&gt;</span>java<span class="hljs-tag">&lt;/<span class="hljs-name">sourceDirectory</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--å¼•â¼Šç¼–è¯‘æ’ä»¶--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--tomcat ä¾èµ–çš„åŸºç¡€åŒ…--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.easymock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>easymock<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ant<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ant<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>wsdl4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>wsdl4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.6.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.xml<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jaxrpc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.eclipse.jdt.core.compiler<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ecj<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.5.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.xml.soap<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.xml.soap-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>biz.aQute.bnd<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>biz.aQute.bndlib<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>


<h2 id="å¯¼å…¥idea"><a href="#å¯¼å…¥idea" class="headerlink" title="å¯¼å…¥idea"></a>å¯¼å…¥idea</h2><p><code>idea</code> å¯¼å…¥ <code>tomcat9</code> æºç æ—¶åªéœ€è¦é€‰æ‹© <code>apache-tomcat-9.0.84-src</code> ç›®å½•æˆ–è€…é€‰æ‹©è¯¥ç›®å½•çš„çš„ <code>pom.xml</code> æ–‡ä»¶å³å¯</p>
<h2 id="ä¿®å¤ç¼–è¯‘é”™è¯¯"><a href="#ä¿®å¤ç¼–è¯‘é”™è¯¯" class="headerlink" title="ä¿®å¤ç¼–è¯‘é”™è¯¯"></a>ä¿®å¤ç¼–è¯‘é”™è¯¯</h2><h3 id="æ‰¾ä¸åˆ°-å˜é‡-VERSION-9"><a href="#æ‰¾ä¸åˆ°-å˜é‡-VERSION-9" class="headerlink" title="æ‰¾ä¸åˆ° å˜é‡ VERSION_9"></a>æ‰¾ä¸åˆ° å˜é‡ VERSION_9</h3><figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">java: æ‰¾ä¸åˆ°ç¬¦å·<br>  ç¬¦å·:   å˜é‡ VERSION_9<br>  ä½ç½®: ç±» org<span class="hljs-selector-class">.eclipse</span><span class="hljs-selector-class">.jdt</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.compiler</span><span class="hljs-selector-class">.impl</span>.CompilerOptions<br></code></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ <code>VERSION_9</code> æ˜¯ <code>CompilerOptions</code> ç±»ï¼Œä¸è¿‡åœ¨ <code>tomcat9</code> ç‰ˆæœ¬ä¸­æ²¡æœ‰è¿™ä¸ªå±æ€§ï¼Œå¯ä»¥æŠŠä½¿ç”¨åˆ°è¯¥å±æ€§çš„åœ°æ–¹æ³¨é‡Šæ‰ï¼Œä¸€å…±æœ‰ä¸¤å¤„ï¼Œéƒ½æ˜¯åœ¨ <code>JDTCompiler</code> ç±»ä¸­</p>
<h2 id="æ·»åŠ é…ç½®"><a href="#æ·»åŠ é…ç½®" class="headerlink" title="æ·»åŠ é…ç½®"></a>æ·»åŠ é…ç½®</h2><p>ç¼–è¯‘é—®é¢˜è§£å†³åï¼Œå¯ä»¥è¿è¡Œ <code>org.apache.catalina.startup.Bootstrap#main</code> æ–¹æ³•ï¼Œä¸è¿‡è¿˜éœ€è¦æ·»åŠ ä¸€äº› <code>jvm</code> å‚æ•°</p>
<p><img src="https://s2.loli.net/2024/01/05/bXTSsjfpHWYxe8V.png" alt="æ·»åŠ vmå‚æ•°"><br>å‚æ•°å†…å®¹å¦‚ä¸‹ï¼ˆ <code>tomcat</code> æ‰€åœ¨ç›®å½•éœ€è¦æ›¿æ¢ï¼‰</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><code class="hljs gradle">-Dcatalina.home=D:<span class="hljs-regexp">/code/</span>apache-tomcat-<span class="hljs-number">9.0</span>.<span class="hljs-number">84</span>-src/<span class="hljs-keyword">source</span><br>-Dcatalina.baseD:<span class="hljs-regexp">/code/</span>apache-tomcat-<span class="hljs-number">9.0</span>.<span class="hljs-number">84</span>-src/<span class="hljs-keyword">source</span><br>-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager<br>-Djava.util.logging.config.<span class="hljs-keyword">file</span>=D:<span class="hljs-regexp">/code/</span>apache-tomcat-<span class="hljs-number">9.0</span>.<span class="hljs-number">84</span>-src<span class="hljs-regexp">/source/</span>conf/logging.properties<br></code></pre></td></tr></table></figure>

<p><code>vm</code> å‚æ•°é…ç½®åå¯åŠ¨æœåŠ¡ï¼Œè®¿é—® <code>http://localhost:8080</code> å³å¯çœ‹åˆ° <code>tomcat</code> ç•Œé¢ï¼Œä¸è¿‡æ˜¯å¦‚ä¸‹å½¢å¼<br><img src="https://s2.loli.net/2024/01/05/lNh3deQmrjypJDV.png" alt="tomcaté¦–é¡µ"></p>
<p>åŸå› æ˜¯ <code>Jsp</code> å¼•æ“ <code>Jasper</code> æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œä»â½½â½†æ³•ç¼–è¯‘<code>JSP</code>ï¼Œæˆ‘ä»¬éœ€è¦åœ¨<code>tomcat</code>çš„æºç <code>ContextConfig</code>ç±»ä¸­çš„<code>configureStart</code>â½…æ³•ä¸­å¢åŠ â¼€â¾ä»£ç å°† <code>Jsp</code> å¼•æ“åˆå§‹åŒ–ï¼Œå¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LifecycleListener</span> &#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureStart</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// Called from StandardContext.start()</span><br><br>        <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>            log.debug(sm.getString(<span class="hljs-string">&quot;contextConfig.start&quot;</span>));<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>            log.debug(sm.getString(<span class="hljs-string">&quot;contextConfig.xmlSettings&quot;</span>,<br>                    context.getName(),<br>                    Boolean.valueOf(context.getXmlValidation()),<br>                    Boolean.valueOf(context.getXmlNamespaceAware())));<br>        &#125;<br><br>        webConfig();<br>        <span class="hljs-comment">// ä¸‹é¢è¿™ä¸€è¡Œä»£ç æ˜¯æ·»åŠ çš„</span><br>        context.addServletContainerInitializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JasperInitializer</span>(), <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">// çœç•¥åé¢ä»£ç â€¦â€¦</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ä¸»è¦æ˜¯æ·»åŠ  <code>context.addServletContainerInitializer(new JasperInitializer(), null);</code> è¿™ä¸€è¡Œ</p>
]]></content>
      <categories>
        <category>java</category>
        <category>tomcat</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>CompletableFutureçš„ä½¿ç”¨</title>
    <url>/2023/f31e3a7691d6/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p>ä»¥ä¸‹å†…å®¹å‚è€ƒã€ŠJavaå¹¶å‘ç¼–ç¨‹æ·±åº¦è§£æä¸å®æˆ˜ã€‹è°­é”‹ï¼ˆç¬¬11ç« ï¼‰</p>
<h2 id="ä¸ºä»€ä¹ˆè¦ç”¨-CompletableFuture"><a href="#ä¸ºä»€ä¹ˆè¦ç”¨-CompletableFuture" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ç”¨ CompletableFuture"></a>ä¸ºä»€ä¹ˆè¦ç”¨ <code>CompletableFuture</code></h2><p>ä½¿ç”¨ <code>CompletableFuture</code> æ˜¯å› ä¸º <code>Future</code> è™½ç„¶å¯ä»¥è·å–çº¿ç¨‹æ‰§è¡Œç»“æœï¼Œä½†æ˜¯æ— æ³•ä½¿ç”¨å›è°ƒå‡½æ•°ï¼Œåªèƒ½ä¾é é˜»å¡æ–¹æ³• <code>get()</code> æ¥è·å–çº¿ç¨‹ç»“æœï¼Œ<code>CompletableFuture</code> å°±æ˜¯å¯¹ <code>Future</code> çš„ä¼˜åŒ–å’Œå¢å¼ºï¼Œå…·ä½“å¯ä»¥å®ç°ä»¥ä¸‹åŠŸèƒ½</p>
<ol>
<li>æä¾›äº†ç±»ä¼¼ <code>Future</code> çš„é˜»å¡å¼è·å–ç»“æœå’ŒçŠ¶æ€çš„æ–¹æ³•</li>
<li>æä¾› <code>CompletionStage</code> ä»»åŠ¡æ‰§è¡Œä¹‹åå›è°ƒ</li>
<li>å¤šä¸ªå¼‚æ­¥ä»»åŠ¡çš„èšåˆï¼Œä¸²è¡Œï¼Œå¹¶è¡Œç­‰åŠŸèƒ½</li>
</ol>
<h2 id="æ„é€ å¼‚æ­¥æ–¹æ³•"><a href="#æ„é€ å¼‚æ­¥æ–¹æ³•" class="headerlink" title="æ„é€ å¼‚æ­¥æ–¹æ³•"></a>æ„é€ å¼‚æ­¥æ–¹æ³•</h2><p><code>CompletableFuture</code> æä¾›äº† 4 ä¸ªé™æ€æ–¹æ³•æ¥æ„é€ ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// å«æœ‰è¿”å›å€¼çš„å¼‚æ­¥æ–¹æ³•ï¼ˆè‡ªå®šä¹‰çº¿ç¨‹æ± å’Œé»˜è®¤çº¿ç¨‹æ± ï¼‰</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">supplyAsync</span><span class="hljs-params">(Supplier&lt;U&gt; supplier)</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="hljs-title function_">supplyAsync</span><span class="hljs-params">(Supplier&lt;U&gt; supplier, Executor executor)</span>;<br><span class="hljs-comment">// ä¸å«æœ‰è¿”å›å€¼çš„å¼‚æ­¥æ–¹æ³•ï¼ˆè‡ªå®šä¹‰çº¿ç¨‹æ± å’Œé»˜è®¤çº¿ç¨‹æ± ï¼‰</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">runAsync</span><span class="hljs-params">(Runnable runnable)</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">runAsync</span><span class="hljs-params">(Runnable runnable,Executor executor)</span><br></code></pre></td></tr></table></figure>
<div class="tabs" id="ä»£ç ç¤ºä¾‹"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="ä»£ç ç¤ºä¾‹-1">supplyAsync</button><button type="button" class="tab " data-href="ä»£ç ç¤ºä¾‹-2">runAsyncç¤ºä¾‹</button></ul><div class="tab-contents"><div class="tab-item-content active" id="ä»£ç ç¤ºä¾‹-1"><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>      CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;<br>          System.out.println(<span class="hljs-string">&quot;å½“å‰çº¿ç¨‹ï¼š&quot;</span> + Thread.currentThread().getName());<br>          <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>      &#125;);<br>      System.out.println(<span class="hljs-string">&quot;çº¿ç¨‹æ‰§è¡Œç»“æœï¼š&quot;</span> + future.get());<br>      System.out.println(<span class="hljs-string">&quot;ä¸»çº¿ç¨‹:&quot;</span> + Thread.currentThread().getName());<br>  &#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>æ‰§è¡Œç»“æœ</span></figcaption><table><tr><td class="code"><pre><code class="hljs java">å½“å‰çº¿ç¨‹ï¼šForkJoinPool.commonPool-worker-<span class="hljs-number">1</span><br>çº¿ç¨‹æ‰§è¡Œç»“æœï¼š<span class="hljs-number">1</span><br>ä¸»çº¿ç¨‹:main<br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="ä»£ç ç¤ºä¾‹-2"><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>      CompletableFuture&lt;Void&gt; future = CompletableFuture.runAsync(() -&gt; &#123;<br>          System.out.println(<span class="hljs-string">&quot;å½“å‰çº¿ç¨‹ï¼š&quot;</span> + Thread.currentThread().getName());<br>      &#125;);<br>      System.out.println(<span class="hljs-string">&quot;çº¿ç¨‹æ‰§è¡Œç»“æœï¼š&quot;</span> + future.get());<br>      System.out.println(<span class="hljs-string">&quot;ä¸»çº¿ç¨‹:&quot;</span> + Thread.currentThread().getName());<br>  &#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>æ‰§è¡Œç»“æœ</span></figcaption><table><tr><td class="code"><pre><code class="hljs java">å½“å‰çº¿ç¨‹ï¼šForkJoinPool.commonPool-worker-<span class="hljs-number">1</span><br>çº¿ç¨‹æ‰§è¡Œç»“æœï¼š<span class="hljs-literal">null</span><br>ä¸»çº¿ç¨‹:main<br></code></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h2 id="ä»»åŠ¡ä¸å’Œæˆ–çš„é™æ€æ–¹æ³•"><a href="#ä»»åŠ¡ä¸å’Œæˆ–çš„é™æ€æ–¹æ³•" class="headerlink" title="ä»»åŠ¡ä¸å’Œæˆ–çš„é™æ€æ–¹æ³•"></a>ä»»åŠ¡ä¸å’Œæˆ–çš„é™æ€æ–¹æ³•</h2><p><code>CompletableFuture</code> ä¸­è¿˜æœ‰å¦å¤–ä¸¤ä¸ªç‰¹æ®Šçš„é™æ€æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ¥æ”¶å¤šä¸ªCompletableFutureæ— è¿”å›å€¼ä»»åŠ¡ï¼Œå½“æ‰€æœ‰çš„CompletableFutureä»»åŠ¡æ‰§è¡Œç»“æŸåï¼Œè¿”å›ä¸€ä¸ªæ–°çš„CompletableFutureå¯¹è±¡</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">allOf</span><span class="hljs-params">(CompletableFuture&lt;?&gt;... cfs)</span>;<br><span class="hljs-comment">//æ¥æ”¶å¤šä¸ªCompletableFutureå¸¦æœ‰è¿”å›å€¼ä»»åŠ¡ï¼Œå½“ä»»ä½•ä¸€ä¸ªCompletableFutureä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œè¿”å›ä¸€ä¸ªæ–°çš„CompletableFutureå¯¹è±¡</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;Object&gt; <span class="hljs-title function_">anyOf</span><span class="hljs-params">(CompletableFuture&lt;?&gt;... cfs)</span>;<br></code></pre></td></tr></table></figure>
<div class="tabs" id="allof()å’Œanyof()"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="allof()å’Œanyof()-1">allOf()</button><button type="button" class="tab " data-href="allof()å’Œanyof()-2">anyOf()</button></ul><div class="tab-contents"><div class="tab-item-content active" id="allof()å’Œanyof()-1"><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>    CompletableFuture&lt;Void&gt; future1 = CompletableFuture.runAsync(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">3000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;å½“å‰çº¿ç¨‹ï¼š&quot;</span> + Thread.currentThread().getName());<br>    &#125;);<br>    CompletableFuture&lt;Void&gt; future2 = CompletableFuture.runAsync(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">5000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;å½“å‰çº¿ç¨‹ï¼š&quot;</span> + Thread.currentThread().getName());<br>    &#125;);<br>    <span class="hljs-type">LocalTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalTime.now();<br>    System.out.println(<span class="hljs-string">&quot;before time:&quot;</span> + now.getMinute() + <span class="hljs-string">&quot;:&quot;</span> + now.getSecond());<br>    CompletableFuture.allOf(future1, future2).join();<br>    now = LocalTime.now();<br>    System.out.println(<span class="hljs-string">&quot;after time:&quot;</span> + now.getMinute() + <span class="hljs-string">&quot;:&quot;</span> + now.getSecond());<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœï¼Œç”¨äº†5sæ‰è¿”å›ï¼Œå› ä¸ºè¦æ‰€æœ‰éƒ½æ‰§è¡Œå®Œæˆæ‰è¿”å›ï¼Œå°±éœ€è¦çœ‹è€—æ—¶æœ€é•¿çš„é‚£ä¸ªçº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">before time:<span class="hljs-number">50</span>:<span class="hljs-number">33</span><br>å½“å‰çº¿ç¨‹ï¼šForkJoinPool.commonPool-worker-<span class="hljs-number">1</span><br>å½“å‰çº¿ç¨‹ï¼šForkJoinPool.commonPool-worker-<span class="hljs-number">2</span><br>after time:<span class="hljs-number">50</span>:<span class="hljs-number">38</span><br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="allof()å’Œanyof()-2"><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>    CompletableFuture&lt;Void&gt; future1 = CompletableFuture.runAsync(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">3000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;å½“å‰çº¿ç¨‹ï¼š&quot;</span> + Thread.currentThread().getName());<br>    &#125;);<br>    CompletableFuture&lt;Void&gt; future2 = CompletableFuture.runAsync(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">5000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;å½“å‰çº¿ç¨‹ï¼š&quot;</span> + Thread.currentThread().getName());<br>    &#125;);<br>    <span class="hljs-type">LocalTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalTime.now();<br>    System.out.println(<span class="hljs-string">&quot;before time:&quot;</span> + now.getMinute() + <span class="hljs-string">&quot;:&quot;</span> + now.getSecond());<br>    CompletableFuture.anyOf(future1, future2).join();<br>    now = LocalTime.now();<br>    System.out.println(<span class="hljs-string">&quot;after time:&quot;</span> + now.getMinute() + <span class="hljs-string">&quot;:&quot;</span> + now.getSecond());<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœï¼Œåªç”¨äº†3så°±è¿”å›äº†ï¼Œå› ä¸ºæ˜¯å…¶ä¸­ä¸€ä¸ªæ‰§è¡Œå®Œæˆå°±è¡Œï¼Œæ‰€ä»¥çœ‹è€—æ—¶æœ€çŸ­çš„é‚£ä¸ªçº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">before time:<span class="hljs-number">53</span>:<span class="hljs-number">43</span><br>å½“å‰çº¿ç¨‹ï¼šForkJoinPool.commonPool-worker-<span class="hljs-number">1</span><br>after time:<span class="hljs-number">53</span>:<span class="hljs-number">46</span><br></code></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h2 id="CompletionStage-è¯¦è§£"><a href="#CompletionStage-è¯¦è§£" class="headerlink" title="CompletionStage è¯¦è§£"></a><code>CompletionStage</code> è¯¦è§£</h2><ol>
<li><code>CompletionStage</code> è¡¨ç¤ºä»»åŠ¡æ‰§è¡Œçš„ä¸€ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªå¼‚æ­¥ä»»åŠ¡éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ <code>CompletionStage</code> å¯¹è±¡</li>
<li>å¯ä»¥é’ˆå¯¹å¤šä¸ª <code>CompletionStage</code> å¯¹è±¡è¿›è¡Œä¸²è¡Œã€å¹¶è¡Œæˆ–è€…èšåˆæ¥è¿›è¡Œä¸‹ä¸€é˜¶æ®µçš„æ“ä½œ</li>
</ol>
<p><code>CompletionStage</code> ç±»ä¸­æä¾›äº†å¾ˆå¤šæ–¹æ³•æ¥å®ç°å¤šä¸ª <code>CompletionStage</code> çš„ä¸²è¡Œï¼Œå¹¶è¡Œç­‰åŠŸèƒ½ï¼Œå¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹å¼è¿›è¡Œåˆ†ç±»</p>
<pre class="mermaid">flowchart LR
    A[CompletionStage]
    B["çº¯æ¶ˆè´¹æ€§æ–¹æ³• \n (ä¸Šä¸€ä¸ªå¼‚æ­¥ç»“æœ \n ä½œä¸ºå½“å‰æ–¹æ³•çš„å‚æ•°è¿›è¡Œè®¡ç®— \n éƒ½å«æœ‰ Accept å…³é”®å­—)"]
        B1[ä¾èµ–å•ä¸ª CompletionStageä»»åŠ¡å®Œæˆ]
            B11["thenAccept(Consumer)"]
            B12["thenAcceptAsync(Consumer)"]
            B13["thenAcceptAsync(Consumer,Executor)"]
            B1-->B11 & B12 & B13
        B2[ä¾èµ–ä¸¤ä¸ª CompletionStageä»»åŠ¡å®Œæˆ]
            B21["thenAcceptBoth(CompletionStage,Consumer)"]
            B22["thenAcceptBothAsync(CompletionStage,Consumer)"]
            B23["thenAcceptBothAsync(CompletionStage,Consumer,Executor)"]
            B2-->B21 & B22 & B23
        B3[ä¾èµ–ä¸¤ä¸ª CompletionStageä»»åŠ¡ä¸­ä»»ä½•ä¸€ä¸ªå®Œæˆ]
            B31["acceptEither(CompletionStage,Consumer)"]
            B32["acceptEitherAsync(CompletionStage,Consumer)"]
            B33["acceptEitherAsync(CompletionStage,Consumer,Executor)"]
            B3-->B31 & B32 & B33
        B-->B1 & B2 & B3

    C["æœ‰è¿”å›å€¼ç±»å‹çš„æ–¹æ³• \n (ä¸Šä¸€ä¸ªå¼‚æ­¥ç»“æœ \n ä½œä¸ºå½“å‰æ–¹æ³•çš„å‚æ•°è¿›è¡Œè®¡ç®— \n å¹¶ä¸”ä¼šäº§ç”Ÿæ–°çš„æœ‰è¿”å›å€¼\nçš„CompletionStageå¯¹è±¡)"]
        C1[ä¾èµ–å•ä¸ª CompletionStageä»»åŠ¡å®Œæˆ]
            C11["thenApply(Function)"]
            C12["thenApplyAsync(Function)"]
            C13["thenApplyAsync(Function,Executor)"]
            C1-->C11 & C12 & C13
        C2[ä¾èµ–ä¸¤ä¸ª CompletionStageä»»åŠ¡å®Œæˆ]
            C21["thenCombine(CompletionStage,BiFunction)"]
            C22["thenCombineAsync(CompletionStage,BiFunction)"]
            C23["thenCombineAsync(CompletionStage,BiFunction,Executor)"]
            C2-->C21 & C22 & C23
        C3[ä¾èµ–ä¸¤ä¸ª CompletionStageä»»åŠ¡ä¸­ä»»ä½•ä¸€ä¸ªå®Œæˆ]
            C31["acceptToEither(CompletionStage,Function)"]
            C32["acceptToEitherAsync(CompletionStage,Function)"]
            C33["acceptToEitherAsync(CompletionStage,Function,Executor)"]
            C3-->C31 & C32 & C33
        C-->C1 & C2 & C3
    D["ä¸æ¶ˆè´¹ä¹Ÿæ²¡æœ‰è¿”å›å€¼ç±»å‹çš„æ–¹æ³•\nä¸ä¾èµ–ä¸Šä¸ªé˜¶æ®µçš„ç»“æœ\nä¸Šä¸€ä¸ªé˜¶æ®µå®Œæˆå°±æ‰§è¡ŒæŒ‡å®šçš„ä»»åŠ¡\nè¿™ç±»æ–¹æ³•éƒ½åŒ…å« run å…³é”®å­—"]
        D1[ä¾èµ–å•ä¸ª CompletionStageä»»åŠ¡å®Œæˆ]
            D11["thenRun(Runnable)"]
            D12["thenRunAsync(Runnable)"]
            D13["thenRunAsync(FuncRunnabletion,Executor)"]
            D1-->D11 & D12 & D13
        D2[ä¾èµ–ä¸¤ä¸ª CompletionStageä»»åŠ¡å®Œæˆ]
            D21["runAfterBoth(CompletionStage,Runnable)"]
            D22["runAfterBothAsync(CompletionStage,Runnable)"]
            D23["runAfterBothAsync(CompletionStage,Runnable,Executor)"]
            D2-->D21 & D22 & D23
        D3[ä¾èµ–ä¸¤ä¸ª CompletionStageä»»åŠ¡ä¸­ä»»ä½•ä¸€ä¸ªå®Œæˆ]
            D31["runAfterEither(CompletionStage,Runnable)"]
            D32["runAfterEitherAsync(CompletionStage,Runnable)"]
            D33["runAfterEitherAsync(CompletionStage,Runnable,Executor)"]
            D3-->D31 & D32 & D33
        D-->D1 & D2 & D3
    E[ç»„åˆç±»å‹çš„æ–¹æ³•]
        E1["thenCompose(Function,CompletionStage)"]
        E2["thenComposeAsync(Function,CompletionStage)"]
        E3["thenComposeAsync(Function,CompletionStage,Executor)"]
        E-->E1 & E2 & E3
    A-->B & C & D & E</pre>

<div class="tabs" id="ä»£ç ç¤ºä¾‹"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="ä»£ç ç¤ºä¾‹-1">çº¯æ¶ˆè´¹å‹</button><button type="button" class="tab " data-href="ä»£ç ç¤ºä¾‹-2">æœ‰è¿”å›å€¼ç±»å‹</button><button type="button" class="tab " data-href="ä»£ç ç¤ºä¾‹-3">ä¸æ¶ˆè´¹ä¹Ÿæ²¡æœ‰è¿”å›å€¼ç±»å‹</button><button type="button" class="tab " data-href="ä»£ç ç¤ºä¾‹-4">ç»„åˆç±»å‹</button></ul><div class="tab-contents"><div class="tab-item-content active" id="ä»£ç ç¤ºä¾‹-1"><figure class="highlight java"><figcaption><span>thenAccept</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>    System.out.println(<span class="hljs-string">&quot;thread main:&quot;</span> + Thread.currentThread().getName());<br>    CompletableFuture.supplyAsync(()-&gt;&#123;<br>        System.out.println(<span class="hljs-string">&quot;first stage:&quot;</span> + Thread.currentThread().getName());<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;).thenAccept((Integer v)-&gt; &#123;<br>        <span class="hljs-comment">// v å°±æ˜¯ç¬¬ä¸€æ­¥è¿”å›çš„ç»“æœ</span><br>        System.out.println(<span class="hljs-string">&quot;then accept thread:&quot;</span> + Thread.currentThread().getName());<br>        System.out.println(v + <span class="hljs-number">1</span>); <span class="hljs-comment">// 2</span><br>    &#125;).join();<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>æ‰§è¡Œç»“æœ</span></figcaption><table><tr><td class="code"><pre><code class="hljs java">thread main:main<br>first stage:ForkJoinPool.commonPool-worker-<span class="hljs-number">1</span><br>then accept thread:main<br><span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç è°ƒç”¨ <code>thenAccept()</code> ä½¿ç”¨çš„æ˜¯ <code>main</code> çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ä½¿ç”¨ <code>thenAcceptAsync()</code>, è°ƒç”¨ç»“æœå¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">thread main:main<br>first stage:ForkJoinPool.commonPool-worker-<span class="hljs-number">1</span><br>then accept thread:ForkJoinPool.commonPool-worker-<span class="hljs-number">1</span><br><span class="hljs-number">2</span><br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="ä»£ç ç¤ºä¾‹-2"><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>    System.out.println(<span class="hljs-string">&quot;thread main:&quot;</span> + Thread.currentThread().getName());<br>    CompletableFuture&lt;String&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;<br>        <span class="hljs-comment">// ç¬¬ä¸€ä¸ªé˜¶æ®µä»»åŠ¡è¿”å›çš„æ˜¯ int ç±»å‹</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;).thenCombineAsync(CompletableFuture.supplyAsync(() -&gt; &#123;<br>        <span class="hljs-comment">// ç¬¬äºŒä¸ªé˜¶æ®µä»»åŠ¡è¿”å›çš„æ˜¯ String ç±»å‹</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;2&quot;</span>;<br>    &#125;), (Integer i1, String s1) -&gt; &#123;<br>        <span class="hljs-keyword">return</span> i1 + s1;<br>    &#125;);<br>    System.out.println(completableFuture.get()); <span class="hljs-comment">// 12</span><br>&#125;<br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="ä»£ç ç¤ºä¾‹-3"><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<br>    CompletableFuture.supplyAsync(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// ç¬¬ä¸€ä¸ªé˜¶æ®µä»»åŠ¡ç­‰å¾…4s</span><br>            Thread.sleep(<span class="hljs-number">4000</span>);<br>            System.out.println(<span class="hljs-string">&quot;ç¬¬ä¸€ä¸ªé˜¶æ®µ:&quot;</span> + LocalDateTime.now().format(formatter));<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;).runAfterEitherAsync(CompletableFuture.supplyAsync(() -&gt; &#123;<br>        <span class="hljs-comment">// ç¬¬äºŒä¸ªé˜¶æ®µä»»åŠ¡ç­‰å¾…2s</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">2000</span>);<br>            System.out.println(<span class="hljs-string">&quot;ç¬¬äºŒä¸ªé˜¶æ®µï¼š&quot;</span> + LocalDateTime.now().format(formatter));<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;2&quot;</span>;<br>    &#125;), () -&gt; &#123;<br>        System.out.println(<span class="hljs-string">&quot;æœ€ç»ˆ:&quot;</span> + LocalDateTime.now().format(formatter));<br>        System.out.println(<span class="hljs-string">&quot;æœ€ç»ˆæ‰§è¡Œçš„ä»»åŠ¡&quot;</span>);<br>    &#125;).join();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">ç¬¬äºŒä¸ªé˜¶æ®µï¼š<span class="hljs-number">2023</span>-<span class="hljs-number">11</span>-<span class="hljs-number">20</span> <span class="hljs-number">23</span>:<span class="hljs-number">56</span>:<span class="hljs-number">32</span><br>æœ€ç»ˆ:<span class="hljs-number">2023</span>-<span class="hljs-number">11</span>-<span class="hljs-number">20</span> <span class="hljs-number">23</span>:<span class="hljs-number">56</span>:<span class="hljs-number">32</span><br>æœ€ç»ˆæ‰§è¡Œçš„ä»»åŠ¡<br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="ä»£ç ç¤ºä¾‹-4"><ol>
<li><code>thenCompose()</code>æ˜¯å¤šä»»åŠ¡ç»„åˆæ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨æ˜¯æŠŠä¸¤ä¸ª<code>CompletionStage</code>ä»»åŠ¡è¿›è¡Œç»„åˆè¾¾åˆ°ä¸²è¡Œæ‰§è¡Œçš„ç›®çš„ï¼Œä¹Ÿå°±æ˜¯æŠŠç¬¬ä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœä½œä¸ºå‚æ•°ä¼ é€’ç»™ç¬¬äºŒä¸ªä»»åŠ¡æ‰§è¡Œï¼Œå®ƒæœ‰ç‚¹ç±»ä¼¼äºå‰é¢æåˆ°çš„<code>thenCombine()</code>æ–¹æ³•ï¼Œæœ€å¤§çš„ä¸åŒåœ¨äº<code>thenCompose()</code>æ–¹æ³•ä¸­çš„ä»»åŠ¡å­˜åœ¨å…ˆåå…³ç³»ï¼Œè€Œ<code>thenCombine()</code>ä¸­ä¸¤ä¸ªä»»åŠ¡æ˜¯å¹¶è¡Œæ‰§è¡Œçš„</li>
</ol></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h2 id="å¼‚å¸¸å¤„ç†"><a href="#å¼‚å¸¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h2><p><code>CompletionStage</code> æ˜¯é“¾å¼å¤„ç†ï¼Œå½“å‰é¢çš„ä»»åŠ¡å‡ºç°å¼‚å¸¸çš„æ—¶å€™ï¼Œä¼šå¯¼è‡´åé¢çš„ä»»åŠ¡æ— æ³•å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    CompletableFuture.supplyAsync(() -&gt; &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;ç¬¬ä¸€ä¸ªä»»åŠ¡å‡ºç°å¼‚å¸¸&quot;</span>);<br>    &#125;).thenRun(()-&gt;&#123;<br>        <span class="hljs-comment">// è¿™é‡Œå¹¶ä¸ä¼šæ‰“å°ï¼Œå› ä¸ºå‰é¢ä¸€ä¸ªä»»åŠ¡å‡ºç°äº†å¼‚å¸¸ï¼Œå¯¼è‡´è¯¥ä»»åŠ¡æ— æ³•æ‰§è¡Œ</span><br>        System.out.println(<span class="hljs-string">&quot;ç¬¬äºŒä¸ªä»»åŠ¡&quot;</span>);<br>    &#125;).join();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ‰€ä»¥åœ¨ <code>CompletionStage</code> ä¸­ä¹Ÿæä¾›äº†å¼‚å¸¸å¤„ç†çš„ç›¸å…³æ–¹æ³•ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç±»</p>
<pre class="mermaid">flowchart LR
    A[CompletionStageå¼‚å¸¸å¤„ç†]
    B["ä»¥whenCompleteå‰ç¼€å¼€å¤´çš„æ–¹æ³•\nä¸è®ºå‰ç½®çš„CompletionStageä»»åŠ¡æ˜¯æ­£å¸¸æ‰§è¡Œç»“æŸ\nè¿˜æ˜¯å‡ºç°å¼‚å¸¸ï¼Œéƒ½èƒ½å¤Ÿè§¦å‘ç‰¹å®šçš„action\nè¿™äº›æ–¹æ³•éƒ½æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œ\nä¸€ä¸ªæ˜¯æ­£å¸¸çš„ç»“æœï¼Œä¸€ä¸ªæ˜¯å¼‚å¸¸\næ²¡æœ‰å¼‚å¸¸æ—¶ç¬¬äºŒä¸ªå°±æ˜¯null"]
        B1["whenComplete(BiConsumer)"]
        B2["whenCompleteAsync(BiConsumer)"]
        B3["whenCompleteAsync(BiConsumer,Executor)"]
        B-->B1 & B2 & B3
    C["ä»¥handleå‰ç¼€å¼€å¤´çš„æ–¹æ³•\nè¡¨ç¤ºå‰ç½®ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œ\nä¸ç®¡å‰ç½®ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€æ˜¯æ­£å¸¸è¿˜æ˜¯å¼‚å¸¸ï¼Œ\néƒ½ä¼šæ‰§è¡Œå…¶ä¸­çš„å‡½æ•°fnï¼Œ\nå®ƒå’ŒwhenCompleteç±»æ–¹æ³•çš„\nä½œç”¨å‡ ä¹ä¸€è‡´ï¼Œä¸åŒç‚¹åœ¨äºï¼Œ\nè¿™ç±»æ–¹æ³•æ˜¯æœ‰è¿”å›å€¼ç±»å‹çš„æ–¹æ³•"]
        C1["handle(BiFunction)"]
        C2["handleAsync(BiFunction)"]
        C3["handleAsync(BiFunction,Executor)"]
        C-->C1 & C2 & C3
    D["exceptionally()"]
        D1["exceptionally()æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå‡½æ•°fnï¼Œ\nå½“ä¸Šä¸€ä¸ªCompletionStageå‡ºç°å¼‚å¸¸æ—¶ï¼Œ\nä¼šæŠŠè¯¥å¼‚å¸¸ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°fnã€‚\nè¯¥æ–¹æ³•æœ‰ä¸€ä¸ªCompletionStageçš„è¿”å›å€¼ï¼Œ\nè¯´æ˜å½“å‰æ–¹æ³•å¯ä»¥åœ¨æ¥æ”¶åˆ°\nä¸Šä¸€ä¸ªé˜¶æ®µçš„å¼‚å¸¸æ—¶è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ï¼Œ\nè¿”å›ä¸€ä¸ªæ–°çš„CompletionStageå¯¹è±¡å®ä¾‹"]
        D-->D1
    A-->B & C & D</pre>

<h3 id="whenCompleteç±»å‹æ–¹æ³•"><a href="#whenCompleteç±»å‹æ–¹æ³•" class="headerlink" title="whenCompleteç±»å‹æ–¹æ³•"></a>whenCompleteç±»å‹æ–¹æ³•</h3><div class="tabs" id="whencompleteç±»å‹å¼‚å¸¸"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="whencompleteç±»å‹å¼‚å¸¸-1">æ²¡æœ‰å¼‚å¸¸çš„æƒ…å†µ</button><button type="button" class="tab " data-href="whencompleteç±»å‹å¼‚å¸¸-2">æœ‰å¼‚å¸¸çš„æƒ…å†µ</button></ul><div class="tab-contents"><div class="tab-item-content active" id="whencompleteç±»å‹å¼‚å¸¸-1"><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    CompletableFuture.supplyAsync(() -&gt; &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;).whenCompleteAsync((result, excep)-&gt;&#123;<br>        System.out.println(<span class="hljs-string">&quot;ä»»åŠ¡ç»“æœ:&quot;</span> + result);<br>        System.out.println(<span class="hljs-string">&quot;ç¬¬ä¸€ä¸ªä»»åŠ¡çš„å¼‚å¸¸:&quot;</span> + excep);<br>    &#125;).join();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">ä»»åŠ¡ç»“æœ:<span class="hljs-number">1</span><br>ç¬¬ä¸€ä¸ªä»»åŠ¡çš„å¼‚å¸¸:<span class="hljs-literal">null</span><br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="whencompleteç±»å‹å¼‚å¸¸-2"><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    CompletableFuture.supplyAsync(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;ç¬¬ä¸€ä¸ªä»»åŠ¡å‡ºç°å¼‚å¸¸&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;).whenCompleteAsync((result, excep)-&gt;&#123;<br>        System.out.println(<span class="hljs-string">&quot;ä»»åŠ¡ç»“æœ:&quot;</span> + result);<br>        System.out.println(<span class="hljs-string">&quot;ç¬¬ä¸€ä¸ªä»»åŠ¡çš„å¼‚å¸¸:&quot;</span> + excep);<br>    &#125;).join();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">ä»»åŠ¡ç»“æœ:<span class="hljs-literal">null</span><br>ç¬¬ä¸€ä¸ªä»»åŠ¡çš„å¼‚å¸¸:java.util.concurrent.CompletionException: java.lang.RuntimeException: ç¬¬ä¸€ä¸ªä»»åŠ¡å‡ºç°å¼‚å¸¸<br>Exception in thread <span class="hljs-string">&quot;main&quot;</span> java.util.concurrent.CompletionException: java.lang.RuntimeException: ç¬¬ä¸€ä¸ªä»»åŠ¡å‡ºç°å¼‚å¸¸<br></code></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h3 id="handle-ç±»å‹æ–¹æ³•"><a href="#handle-ç±»å‹æ–¹æ³•" class="headerlink" title="handle ç±»å‹æ–¹æ³•"></a>handle ç±»å‹æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    CompletableFuture&lt;String&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;ç¬¬ä¸€ä¸ªä»»åŠ¡å‡ºç°å¼‚å¸¸&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;).handle((result, excep) -&gt; &#123;<br>        System.out.println(<span class="hljs-string">&quot;ä»»åŠ¡ç»“æœ:&quot;</span> + result);<br>        System.out.println(<span class="hljs-string">&quot;ç¬¬ä¸€ä¸ªä»»åŠ¡çš„å¼‚å¸¸:&quot;</span> + excep.toString().substring(<span class="hljs-number">1</span>, <span class="hljs-number">70</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ç¬¬äºŒä¸ªä»»åŠ¡çš„ç»“æœ&quot;</span>;<br>    &#125;);<br>    <span class="hljs-comment">// æœ€ç»ˆçš„æ‰§è¡Œç»“æœ</span><br>    System.out.println(completableFuture.get());<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">ä»»åŠ¡ç»“æœ:<span class="hljs-literal">null</span><br>ç¬¬ä¸€ä¸ªä»»åŠ¡çš„å¼‚å¸¸:ava.util.concurrent.CompletionException: java.lang.RuntimeException: <br>ç¬¬äºŒä¸ªä»»åŠ¡çš„ç»“æœ<br></code></pre></td></tr></table></figure>
<h3 id="exceptionally-æ–¹æ³•"><a href="#exceptionally-æ–¹æ³•" class="headerlink" title="exceptionally()æ–¹æ³•"></a>exceptionally()æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    CompletableFuture&lt;Integer&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;ç¬¬ä¸€ä¸ªä»»åŠ¡å‡ºç°å¼‚å¸¸&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;).exceptionally(exec -&gt; &#123;<br>        <span class="hljs-comment">// exceptionally é‡Œé¢çš„è¿”å›å€¼éœ€è¦å’Œå‰é¢çš„ stage è¿”å›å€¼ä¿æŒä¸€è‡´</span><br>        <span class="hljs-keyword">return</span> Integer.valueOf(<span class="hljs-string">&quot;2&quot;</span>);<br>    &#125;);<br>    <span class="hljs-comment">// æœ€ç»ˆçš„æ‰§è¡Œç»“æœ</span><br>    System.out.println(completableFuture.get());<br>&#125;<br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>Futureçš„ä½¿ç”¨</title>
    <url>/2023/9f417cc2ea5e/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>java</code> ä¸­å¼‚æ­¥æ‰§è¡Œä»»åŠ¡å¯ä»¥è®©ä»»åŠ¡ç±»å®ç° <code>Runnable</code> æ¥å£å³å¯ï¼Œä½†æ˜¯ä½¿ç”¨ <code>Runnable</code> æ¥å£æ‰§è¡Œçš„ä»»åŠ¡æ— æ³•è·å–è¿”å›å€¼ï¼Œæ‰€ä»¥ <code>java</code> åœ¨ <code>jdk1.5</code> ç‰ˆæœ¬ä¸­å¢åŠ äº† <code>Future</code> æ¥å£å’Œ <code>Callable</code></p>
<span id="more"></span>
<h2 id="å…ˆç»™ç»“è®º"><a href="#å…ˆç»™ç»“è®º" class="headerlink" title="å…ˆç»™ç»“è®º"></a>å…ˆç»™ç»“è®º</h2><ol>
<li><code>Future</code> å¯ä»¥ä½¿ç”¨ <code>get()</code> æ–¹æ³•è·å–çº¿ç¨‹è°ƒç”¨çš„ç»“æœï¼Œè¯¥æ–¹æ³•ä¼šé˜»å¡ä¸»çº¿ç¨‹</li>
<li><code>Future</code> ç±»æœ‰æä¾› <code>isDone()</code> æ–¹æ³•æ¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦æ‰§è¡Œå®Œæˆï¼Œè¯¥æ–¹æ³•ä¸ä¼šé˜»å¡</li>
<li><code>Future</code> å¯ä»¥æ‹¿åˆ°çº¿ç¨‹ç»“æœæ˜¯å› ä¸ºåœ¨çº¿ç¨‹ä»»åŠ¡ç±»ï¼ˆ<code>FutureTask</code>ï¼‰ä¸­æ‰§è¡Œå®Œä»»åŠ¡ä¹‹åå°†ç»“æœè®¾ç½®åˆ°äº† <code>Future</code> ä¸­ã€å…ˆæœ‰ä¸ªæ¦‚å¿µï¼Œä¸‹æ–‡ä¼šåˆ†æã€‘</li>
</ol>
<h2 id="Future-çš„ä½¿ç”¨ç¤ºä¾‹"><a href="#Future-çš„ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="Future çš„ä½¿ç”¨ç¤ºä¾‹"></a>Future çš„ä½¿ç”¨ç¤ºä¾‹</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestThread</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();<br>        <span class="hljs-comment">// è¿™é‡Œsubmit æ–¹æ³•æ˜¯ &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task);</span><br>        Future&lt;String&gt; future = executorService.submit(() -&gt; &#123;<br>            System.out.println(<span class="hljs-string">&quot;start execute:&quot;</span> + DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(LocalDateTime.now()));<br>            Thread.sleep(<span class="hljs-number">3000</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>        &#125;);<br>        <span class="hljs-comment">// éé˜»å¡è°ƒç”¨ï¼Œä¸æ–­æŸ¥è¯¢ç»“æœæ˜¯å¦å®Œæˆ</span><br>        <span class="hljs-keyword">while</span> (!future.isDone()) &#123;<br>            System.out.println(<span class="hljs-string">&quot;çº¿ç¨‹æœªæ‰§è¡Œå®Œæˆ&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>        &#125;<br>        <span class="hljs-comment">// è‹¥ä»»åŠ¡æœªæ‰§è¡Œå®Œæˆï¼Œget æ–¹æ³•ä¼šé˜»å¡ä¸»çº¿ç¨‹</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get();<br>        System.out.println(<span class="hljs-string">&quot;after execute Time:&quot;</span> +  DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(LocalDateTime.now()));<br>        System.out.println(result);<br>        <span class="hljs-comment">// å…³é—­çº¿ç¨‹æ± ï¼Œå¦åˆ™jvmè¿›ç¨‹ä¼šä¸€ç›´åœ¨è¿è¡Œ</span><br>        executorService.shutdown();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">çº¿ç¨‹æœªæ‰§è¡Œå®Œæˆ<br>start execute:<span class="hljs-number">2023</span>-<span class="hljs-number">11</span>-<span class="hljs-number">17</span> <span class="hljs-number">15</span>:<span class="hljs-number">14</span>:<span class="hljs-number">35</span><br>çº¿ç¨‹æœªæ‰§è¡Œå®Œæˆ<br>çº¿ç¨‹æœªæ‰§è¡Œå®Œæˆ<br>çº¿ç¨‹æœªæ‰§è¡Œå®Œæˆ<br>after execute Time:<span class="hljs-number">2023</span>-<span class="hljs-number">11</span>-<span class="hljs-number">17</span> <span class="hljs-number">15</span>:<span class="hljs-number">14</span>:<span class="hljs-number">39</span><br>hello<br></code></pre></td></tr></table></figure>
<h2 id="æ ¸å¿ƒç±»"><a href="#æ ¸å¿ƒç±»" class="headerlink" title="æ ¸å¿ƒç±»"></a>æ ¸å¿ƒç±»</h2><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311172311584.png" alt="FutureTaskæ ¸å¿ƒç±»"></p>
<h3 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h3><p>ä»ä¸Šé¢ç±»å›¾çœ‹åˆ°æ ¸å¿ƒç±»æ˜¯ <code>FutureTask</code>, è¿™ä¸ªç±»å®ç°äº† <code>Future</code> å’Œ <code>Runnable</code>, å¹¶ä¸”åœ¨æ„é€ å‡½æ•°ä¸­éœ€è¦ä¼ å…¥ <code>Callable</code></p>
<ol>
<li><code>FutureTask</code> å’Œ <code>Runnable</code> æ¥å£çš„å…³ç³»æ˜¯å®ç°ï¼Œç›®çš„æ˜¯ä¾¿äºå‘ä¸Šè½¬å‹ä¼ å‚ï¼Œçº¿ç¨‹æ± ä¸­æ¥æ”¶ä»»åŠ¡çš„é¡¶å±‚æ¥å£å°±æ˜¯ <code>Runnable</code></li>
<li><code>FutureTask</code> ç±»å’Œ <code>Callable</code> å®ç°ç±»çš„å…³ç³»æ˜¯ <strong>ç»„åˆ</strong>ï¼Œä¸‹é¢æ˜¯ <code>FutureTask</code> çš„æ„é€ æ–¹æ³•</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">FutureTask</span><span class="hljs-params">(Callable&lt;V&gt; callable)</span> &#123;<br>    <span class="hljs-keyword">if</span> (callable == <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>    <span class="hljs-built_in">this</span>.callable = callable;<br>    <span class="hljs-built_in">this</span>.state = NEW;       <span class="hljs-comment">// ensure visibility of callable</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>æè¿°ä¸Šé¢ä¸¤ç‚¹æ˜¯å› ä¸ºå…ˆå¼„æ¸…æ¥š <code>FutureTask</code> å’Œ <code>Callable</code> å’Œ <code>Runnable</code> ä¸‰è€…ä¹‹é—´çš„å…³ç³»ï¼Œè¿™æ ·æ‰èƒ½çŸ¥é“æœ€ç»ˆçš„ä»»åŠ¡ç±»æ˜¯å“ªä¸ªï¼ˆä»»åŠ¡ç±»çš„ <code>run()</code> æ–¹æ³•å°±æ˜¯é‡ç‚¹äº†ï¼‰</p>
<pre class="mermaid">sequenceDiagram
    participant A as ExecutorService
    participant B as AbstractExecutorService
    participant C as ThreadPoolExecutor
    A->>B: submit(Callable)
    Note over A,B: å°†Callableè½¬æ¢æˆFutureTask
    B->>B: RunnableFuture = new FutureTask<T>(callable)
    Note over B,C: å°†FutureTaskè½¬æ¢æˆRunnableFuture
    B->>C: execute(Runnable command) {
    B->>A: return RunnableFuture</T></pre>
<p>ä¸‹é¢å†è·Ÿç€ä»£ç çœ‹ä¸€éè¿™ä¸ªè¿‡ç¨‹</p>
<ol>
<li><code>TestThread#main</code> ä¸­åˆ›å»ºçº¿ç¨‹æ± å¹¶è°ƒç”¨ <code>submit()</code> æ–¹æ³•<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();<br><span class="hljs-comment">// æ¥ä¸‹æ¥çœ‹submit(Callable) æ–¹æ³•</span><br>Future&lt;String&gt; future = executorService.submit(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;start execute:&quot;</span> + DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(LocalDateTime.now()));<br>    Thread.sleep(<span class="hljs-number">3000</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>&#125;);<br></code></pre></td></tr></table></figure></li>
<li><code>submit()</code> æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>java.util.concurrent.AbstractExecutorService#submit(java.util.concurrent.Callable&lt;T&gt;)</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;T&gt; Future&lt;T&gt; <span class="hljs-title function_">submit</span><span class="hljs-params">(Callable&lt;T&gt; task)</span> &#123;<br>    <span class="hljs-keyword">if</span> (task == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>    <span class="hljs-comment">// è¿™é‡Œå°±æ˜¯æ ¹æ® Callable ç”Ÿæˆ FutureTask ç±»</span><br>    RunnableFuture&lt;T&gt; ftask = newTaskFor(task);<br>    <span class="hljs-comment">// æ¥ä¸‹æ¥çœ‹ execute æ–¹æ³•ï¼Œè¿™ä¸ªå°±æ˜¯ ThreadPoolExecutor ä¸­çš„ execute() æ–¹æ³•</span><br>    execute(ftask);<br>    <span class="hljs-keyword">return</span> ftask;<br>&#125;<br><br><span class="hljs-keyword">protected</span> &lt;T&gt; RunnableFuture&lt;T&gt; <span class="hljs-title function_">newTaskFor</span><span class="hljs-params">(Callable&lt;T&gt; callable)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FutureTask</span>&lt;T&gt;(callable);<br>&#125;<br></code></pre></td></tr></table></figure>
<ol start="3">
<li><code>java.util.concurrent.ThreadPoolExecutor#execute(Runnable)</code> è¿™ä¸ªå°±æ˜¯çº¿ç¨‹æ± çš„æ‰§è¡Œé€»è¾‘ï¼Œå‚è€ƒ</li>
</ol>
<p><code>&#123;% post_path çº¿ç¨‹æ± å®ç°åŸç† %&#125;</code><br>é€šè¿‡ä¸Šé¢çš„æ­¥éª¤å·²ç»çŸ¥é“çº¿ç¨‹æ± ä¸­ä½¿ç”¨çš„ <strong>ä»»åŠ¡ç±»</strong> æ˜¯ <code>FutureTask</code>ï¼Œé‚£ä¹ˆå°±ä¸€å®šä¼šè°ƒç”¨ <code>FutureTask</code> ç±»ä¸­çš„ <code>run()</code> æ–¹æ³•</p>
<h2 id="FutureTask-ç±»ä¸­é‡è¦å±æ€§"><a href="#FutureTask-ç±»ä¸­é‡è¦å±æ€§" class="headerlink" title="FutureTask ç±»ä¸­é‡è¦å±æ€§"></a>FutureTask ç±»ä¸­é‡è¦å±æ€§</h2><p>ä½†æ˜¯åœ¨çœ‹ <code>run()</code> æ–¹æ³•ä¹‹å‰å…ˆçœ‹ä¸€ä¸‹ <code>FutureTask</code> ç±»ä¸­æ¯”è¾ƒé‡è¦çš„ä¸¤ä¸ªå±æ€§ï¼Œåœ¨åé¢çš„æ–¹æ³•ä¸­ä¼šé‡åˆ°</p>
<ol>
<li>æè¿°ä»»åŠ¡çŠ¶æ€çš„å­—æ®µ <code>state</code></li>
<li>ç»“æœä¿å­˜å­—æ®µ <code>Object outcome</code></li>
<li>ç­‰å¾…é˜Ÿåˆ— <code>volatile WaitNode waiters;</code></li>
</ol>
<h3 id="FutureTask-ä»»åŠ¡çŠ¶æ€å­—æ®µ-state"><a href="#FutureTask-ä»»åŠ¡çŠ¶æ€å­—æ®µ-state" class="headerlink" title="FutureTask ä»»åŠ¡çŠ¶æ€å­—æ®µ state"></a>FutureTask ä»»åŠ¡çŠ¶æ€å­—æ®µ state</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> state;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">NEW</span>          <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">COMPLETING</span>   <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">NORMAL</span>       <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">EXCEPTIONAL</span>  <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CANCELLED</span>    <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INTERRUPTING</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INTERRUPTED</span>  <span class="hljs-operator">=</span> <span class="hljs-number">6</span>;<br></code></pre></td></tr></table></figure>
<h4 id="state-çŠ¶æ€è½¬æ¢æµç¨‹"><a href="#state-çŠ¶æ€è½¬æ¢æµç¨‹" class="headerlink" title="state çŠ¶æ€è½¬æ¢æµç¨‹"></a>state çŠ¶æ€è½¬æ¢æµç¨‹</h4><pre class="mermaid">graph LR
    A[new]
    B[COMPLETING]
    C[NORMAL]
    D[EXCEPTIONAL]
    E[CANCELLED]
    F[INTERRUPTING]
    G[INTERRUPTED]
    A--"set() or setException()"-->B-->C & D
    A--"cancel(false)"-->E
    A--"cancel(true)"-->F-->G</pre>
<h3 id="Object-outcome"><a href="#Object-outcome" class="headerlink" title="Object outcome"></a><code>Object outcome</code></h3><p><code>outcome</code> å­—æ®µå°±æ˜¯ç”¨æ¥ä¿å­˜çº¿ç¨‹æ‰§è¡Œçš„ç»“æœçš„</p>
<h3 id="ç­‰å¾…é˜Ÿåˆ—-WaitNode-waiters"><a href="#ç­‰å¾…é˜Ÿåˆ—-WaitNode-waiters" class="headerlink" title="ç­‰å¾…é˜Ÿåˆ— WaitNode waiters"></a>ç­‰å¾…é˜Ÿåˆ— <code>WaitNode waiters</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WaitNode</span> &#123;<br>    <span class="hljs-keyword">volatile</span> Thread thread;<br>    <span class="hljs-keyword">volatile</span> WaitNode next;<br>    WaitNode() &#123; thread = Thread.currentThread(); &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>waiters æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œwaiters å­—æ®µå°±æ˜¯è¿™ä¸ªé“¾è¡¨çš„å¤´éƒ¨</li>
<li>å› ä¸ºå¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹å»è°ƒç”¨ <code>Future.get()</code> æ–¹æ³•ï¼Œå½“æ²¡æœ‰è·å–åˆ°ç»“æœæ—¶ï¼Œæ‰€æœ‰è°ƒç”¨ <code>get()</code> æ–¹æ³•çš„çº¿ç¨‹éƒ½æ˜¯éœ€è¦é˜»å¡çš„</li>
</ol>
<h2 id="FutureTask-çš„-run-æ–¹æ³•"><a href="#FutureTask-çš„-run-æ–¹æ³•" class="headerlink" title="FutureTask çš„ run() æ–¹æ³•"></a>FutureTask çš„ run() æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1. state è®°å½•çš„æ˜¯å½“å‰ä»»åŠ¡çš„çŠ¶æ€</span><br>    <span class="hljs-keyword">if</span> (state != NEW ||<br>        !RUNNER.compareAndSet(<span class="hljs-built_in">this</span>, <span class="hljs-literal">null</span>, Thread.currentThread()))<br>        <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        Callable&lt;V&gt; c = callable;<br>        <span class="hljs-keyword">if</span> (c != <span class="hljs-literal">null</span> &amp;&amp; state == NEW) &#123;<br>            V result;<br>            <span class="hljs-type">boolean</span> ran;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 2. æ„é€  FutureTask æ—¶å°† Callable ä¼ é€’è¿›æ¥äº†ï¼Œåœ¨è¿™é‡Œè¿›è¡Œè°ƒç”¨</span><br>                result = c.call();<br>                <span class="hljs-comment">// è®¾ç½®è°ƒç”¨å®Œæˆçš„æ ‡è¯†</span><br>                ran = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>                result = <span class="hljs-literal">null</span>;<br>                ran = <span class="hljs-literal">false</span>;<br>                setException(ex);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (ran)<br>                <span class="hljs-comment">// 3. è°ƒç”¨å®Œæˆä¹‹åè®¾ç½®ç»“æœ</span><br>                set(result);<br>        &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        runner = <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> state;<br>        <span class="hljs-keyword">if</span> (s &gt;= INTERRUPTING)<br>            handlePossibleCancellationInterrupt(s);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥çœ‹çœ‹æ³¨é‡Šä¸­çš„ç¬¬ <code>3</code> æ­¥ï¼Œ è°ƒç”¨å®Œæˆä¹‹åè®¾ç½®ç»“æœ</p>
<h3 id="set-V-v-æ–¹æ³•"><a href="#set-V-v-æ–¹æ³•" class="headerlink" title="set(V v) æ–¹æ³•"></a>set(V v) æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(V v)</span> &#123;<br>    <span class="hljs-keyword">if</span> (STATE.compareAndSet(<span class="hljs-built_in">this</span>, NEW, COMPLETING)) &#123;<br>        <span class="hljs-comment">// 1. å°†æ‰§è¡Œçš„ç»“æœèµ‹å€¼ç»™ outcome</span><br>        outcome = v;<br>        STATE.setRelease(<span class="hljs-built_in">this</span>, NORMAL); <span class="hljs-comment">// final state</span><br>        <span class="hljs-comment">// 2. é€šçŸ¥é˜»å¡çš„çº¿ç¨‹ï¼ˆå”¤é†’ï¼‰</span><br>        finishCompletion();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å°†ç»“æœèµ‹å€¼ç»™ <code>outcome</code> å±æ€§ä¹‹åï¼Œè¿˜è°ƒç”¨äº† <code>finishCompletion()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¸ªå…¶å®å°±æ˜¯ <strong>ç”Ÿäº§è€…æ¶ˆè´¹è€…</strong> æ¨¡å‹çš„åº”ç”¨</p>
<h2 id="Future-ä¸­ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"><a href="#Future-ä¸­ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹" class="headerlink" title="Future ä¸­ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"></a>Future ä¸­ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</h2><ol>
<li>è°ƒç”¨ <code>Future.get()</code> æ–¹æ³•è‹¥çº¿ç¨‹è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæˆï¼Œä¸»çº¿ç¨‹ä¼š <strong>é˜»å¡</strong>ï¼Œå½“ä»»åŠ¡å®Œæˆåä¼šä»»åŠ¡ç±»ä¸­ä¼š <strong>å”¤é†’</strong> é˜»å¡çš„çº¿ç¨‹</li>
<li>é˜»å¡æ˜¯é˜»å¡åœ¨ <code>get()</code> æ–¹æ³•ï¼Œé‚£å”¤é†’å‘¢ï¼Ÿ å…¶å®å°±æ˜¯ä¸Šé¢çš„ <code>finishCompletion()</code> çŸ¥é“äº†æ–¹æ³•çš„ä½œç”¨ä¹‹åï¼Œæˆ‘ä»¬å†çœ‹çœ‹çœ‹ <code>get()</code> æ–¹æ³•å’Œ <code>finishCompletion()</code> æ–¹æ³•</li>
</ol>
<h3 id="get-æ–¹æ³•"><a href="#get-æ–¹æ³•" class="headerlink" title="get() æ–¹æ³•"></a>get() æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> state;<br>    <span class="hljs-comment">// å…ˆè·å–ä»»åŠ¡çŠ¶æ€ï¼Œä»»åŠ¡æ²¡æœ‰å®Œæˆï¼Œå°±è¿›è¡Œé˜»å¡ç­‰å¾…</span><br>    <span class="hljs-keyword">if</span> (s &lt;= COMPLETING)<br>        s = awaitDone(<span class="hljs-literal">false</span>, <span class="hljs-number">0L</span>);<br>    <span class="hljs-keyword">return</span> report(s);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>é˜»å¡ç­‰å¾…æ˜¯è°ƒç”¨çš„ <code>awaitDone()</code> æ–¹æ³•, è¿˜æ˜¯å…ˆæ€»ç»“ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å†çœ‹æºç </p>
<ol>
<li>ä»»åŠ¡æœªå®Œæˆæ—¶ï¼Œå°†å½“å‰çº¿ç¨‹å°è£…æˆä¸€ä¸ª <code>WaitNode</code> å¯¹è±¡ï¼Œæ·»åŠ åˆ° <code>WaitNode waiters</code> æ•°å±æ€§çš„åé¢</li>
<li>ä¿å­˜åˆ°ç­‰å¾…é“¾è¡¨ä¹‹åï¼Œå°±ä½¿ç”¨ <code>LockSupport.park(this)</code> æ¥é˜»å¡å½“å‰çº¿ç¨‹</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">awaitDone</span><span class="hljs-params">(<span class="hljs-type">boolean</span> timed, <span class="hljs-type">long</span> nanos)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">0L</span>;    <span class="hljs-comment">// Special value 0L means not yet parked</span><br>    <span class="hljs-type">WaitNode</span> <span class="hljs-variable">q</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">queued</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> state;<br>        <span class="hljs-keyword">if</span> (s &gt; COMPLETING) &#123;<br>            <span class="hljs-keyword">if</span> (q != <span class="hljs-literal">null</span>)<br>                q.thread = <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">return</span> s;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (s == COMPLETING)<br>            Thread.<span class="hljs-keyword">yield</span>();<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Thread.interrupted()) &#123;<br>            removeWaiter(q);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (q == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="hljs-number">0L</span>)<br>                <span class="hljs-keyword">return</span> s;<br>            <span class="hljs-comment">// ç”±å½“å‰çº¿ç¨‹æ„æˆä¸€ä¸ª WaitNode å¯¹è±¡</span><br>            q = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WaitNode</span>();<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!queued)<br>            <span class="hljs-comment">// å°†æ„é€ çš„ waitNode å¯¹è±¡æ·»åŠ åˆ° waiters é“¾è¡¨ä¸­ã€å¯èƒ½æœ‰äººæœ‰ç‚¹ç–‘æƒ‘ï¼Œè¿™ä¸¤ä¸ªé€»è¾‘å¤„åœ¨ä¸åŒ else if æ¡ä»¶ä¸­ï¼Œä¸ºä»€ä¹ˆä¼šåŒæ—¶æ‰§è¡Œåˆ°ï¼Œå…¶å®è¿™é‡Œä¸æ˜¯åŒæ—¶æ‰§è¡Œåˆ°ï¼Œè€Œæ˜¯ä¸²è¡Œçš„ï¼Œå› ä¸ºè¿™æ•´å—ä»£ç åœ¨ä¸€ä¸ªforå¾ªç¯ä¸­ï¼Œå‰é¢è¿›è¡Œä¸€ä¸ªelseåˆ†æ”¯åï¼Œä¸‹ä¸€æ¬¡å¾ªç¯æ¡ä»¶å°±æ”¹å˜äº†ï¼Œå¯¼è‡´è¿›å…¥åˆ°äº†ä¸åŒçš„elseåˆ†æ”¯ä¸­ã€‘</span><br>            queued = WAITERS.weakCompareAndSet(<span class="hljs-built_in">this</span>, q.next = waiters, q);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (timed) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> parkNanos;<br>            <span class="hljs-keyword">if</span> (startTime == <span class="hljs-number">0L</span>) &#123; <span class="hljs-comment">// first time</span><br>                startTime = System.nanoTime();<br>                <span class="hljs-keyword">if</span> (startTime == <span class="hljs-number">0L</span>)<br>                    startTime = <span class="hljs-number">1L</span>;<br>                parkNanos = nanos;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">elapsed</span> <span class="hljs-operator">=</span> System.nanoTime() - startTime;<br>                <span class="hljs-keyword">if</span> (elapsed &gt;= nanos) &#123;<br>                    removeWaiter(q);<br>                    <span class="hljs-keyword">return</span> state;<br>                &#125;<br>                parkNanos = nanos - elapsed;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (state &lt; COMPLETING)<br>                LockSupport.parkNanos(<span class="hljs-built_in">this</span>, parkNanos);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-comment">// é˜»å¡å½“å‰çº¿ç¨‹</span><br>            LockSupport.park(<span class="hljs-built_in">this</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="finishCompletion-æ–¹æ³•"><a href="#finishCompletion-æ–¹æ³•" class="headerlink" title="finishCompletion() æ–¹æ³•"></a><code>finishCompletion()</code> æ–¹æ³•</h3><p>çœ‹å®Œäº† <code>get()</code> é˜»å¡æ–¹æ³•ï¼Œå°±å¯ä»¥æ¥çœ‹çœ‹å”¤é†’é˜»å¡çš„çº¿ç¨‹æ–¹æ³• <code>finishCompletion()</code> äº†, åŒæ ·çš„å…ˆç®€å•æ€»ç»“ä¸€ä¸‹è¯¥æ–¹æ³•åšçš„äº‹æƒ…</p>
<ol>
<li>éå† <code>waiters</code> ä»é‡Œé¢è·å–é˜»å¡çš„çº¿ç¨‹</li>
<li>è·å–åˆ°é˜»å¡çš„çº¿ç¨‹ä¹‹åï¼Œè°ƒç”¨ <code>LockSupport.unpark(thread)</code> æ¥å”¤é†’å¯¹åº”çš„çº¿ç¨‹<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finishCompletion</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (WaitNode q; (q = waiters) != <span class="hljs-literal">null</span>;) &#123;<br>        <span class="hljs-keyword">if</span> (WAITERS.weakCompareAndSet(<span class="hljs-built_in">this</span>, q, <span class="hljs-literal">null</span>)) &#123;<br>            <span class="hljs-keyword">for</span> (;;) &#123;<br>                <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> q.thread;<br>                <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>) &#123;<br>                    q.thread = <span class="hljs-literal">null</span>;<br>                    <span class="hljs-comment">// å”¤é†’çº¿ç¨‹</span><br>                    LockSupport.unpark(t);<br>                &#125;<br>                <span class="hljs-type">WaitNode</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> q.next;<br>                <span class="hljs-keyword">if</span> (next == <span class="hljs-literal">null</span>)<br>                    <span class="hljs-keyword">break</span>;<br>                q.next = <span class="hljs-literal">null</span>; <span class="hljs-comment">// unlink to help gc</span><br>                q = next;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    done();<br>    callable = <span class="hljs-literal">null</span>;        <span class="hljs-comment">// to reduce footprint</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>Semaphoreä½¿ç”¨å’ŒåŸç†</title>
    <url>/2023/1dbf4f386c66/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p><code>Semaphore</code> çš„ä¸»è¦åŠŸèƒ½æ˜¯ç”¨æ¥é™åˆ¶å¯¹æŸä¸ªèµ„æºåŒæ—¶è®¿é—®çš„çº¿ç¨‹æ•°é‡ï¼Œå®ƒæœ‰ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•</p>
<ol>
<li><code>acquire()</code>ï¼šè·å–ä¸€ä¸ªè®¸å¯ï¼Œå¦‚æœæ²¡æœ‰å°±é˜»å¡</li>
<li><code>release()</code>ï¼šé‡Šæ”¾ä¸€ä¸ªè®¸å¯ ç„¶åå”¤é†’ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹</li>
</ol>
<h2 id="Semaphore-å¸¸ç”¨æ–¹æ³•"><a href="#Semaphore-å¸¸ç”¨æ–¹æ³•" class="headerlink" title="Semaphore å¸¸ç”¨æ–¹æ³•"></a>Semaphore å¸¸ç”¨æ–¹æ³•</h2><ol>
<li><code>Semaphore(permits,fair)</code>ï¼Œ<code>permits</code> è¡¨ç¤ºä»¤ç‰Œæ•°ï¼Œ<code>fair</code> è¡¨ç¤ºå…¬å¹³æ€§</li>
<li><code>acquire(permits)</code>ï¼Œè·å–æŒ‡å®š <code>permits</code> æ•°é‡çš„ä»¤ç‰Œï¼Œå¦‚æœè®¸å¯è¯æ•°é‡ä¸è¶³ï¼Œåˆ™ä¼šé˜»å¡å½“å‰çº¿ç¨‹</li>
<li><code>tryAcquire(permits)</code>ï¼Œå°è¯•è·å–æŒ‡å®š <code>permits</code> æ•°é‡çš„ä»¤ç‰Œï¼Œæ­¤è¿‡ç¨‹æ˜¯éé˜»å¡çš„ï¼Œå¦‚æœä»¤ç‰Œæ•°ä¸å¤Ÿï¼Œåˆ™è¿”å› <code>false</code>ï¼Œå¦åˆ™è¿”å› <code>true</code></li>
<li><code>release(permits)</code>ï¼Œé‡Šæ”¾æŒ‡å®š <code>permits</code> æ•°é‡çš„ä»¤ç‰Œ</li>
<li><code>drainPermits()</code>ï¼Œå½“å‰çº¿ç¨‹è·å¾—å‰©ä¸‹çš„æ‰€æœ‰å¯ç”¨ä»¤ç‰Œã€‚</li>
<li><code>hasQueuedThread()</code>ï¼Œåˆ¤æ–­å½“å‰ <code>Semaphore</code> å®ä¾‹ä¸Šæ˜¯å¦å­˜åœ¨æ­£åœ¨ç­‰å¾…ä»¤ç‰Œçš„çº¿ç¨‹ã€‚</li>
</ol>
<h2 id="Semaphoreçš„ä½¿ç”¨åŸç†å›¾"><a href="#Semaphoreçš„ä½¿ç”¨åŸç†å›¾" class="headerlink" title="Semaphoreçš„ä½¿ç”¨åŸç†å›¾"></a>Semaphoreçš„ä½¿ç”¨åŸç†å›¾</h2><pre class="mermaid">flowchart TB
    subgraph A["Threads"]
        direction LR
        A1["thread"]
        A2["thread"]
        A3["......"]
        A4["thread"]
        A1~~~A2~~~A3~~~A4
    end
    subgraph B["Semaphore"]
        B1["1 (permits=2)"]
        B2["2 (permits=2)"]
        B1~~~B2
    end
    C[resources]
    A--"acquire()"-->B
    A--"acquire()"-->B
    A--"......"-->B
    A--"acquire()"-->B
    B--"åŒæ—¶åªå…è®¸ä¸¤ä¸ªçº¿ç¨‹è®¿é—®"-->C
    B--"åŒæ—¶åªå…è®¸ä¸¤ä¸ªçº¿ç¨‹è®¿é—®"-->C</pre>

<h2 id="Semaphoreçš„ä½¿ç”¨åœºæ™¯"><a href="#Semaphoreçš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="Semaphoreçš„ä½¿ç”¨åœºæ™¯"></a>Semaphoreçš„ä½¿ç”¨åœºæ™¯</h2><ol>
<li>é™æµï¼Œé™åˆ¶åŒæ—¶è®¿é—®æŸä¸ªèµ„æºçš„çº¿ç¨‹æ•°é‡</li>
<li>å¹¶å‘æ§åˆ¶ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥æ± ï¼Œé™åˆ¶åŒæ—¶è®¿é—®æ•°æ®åº“çš„çº¿ç¨‹æ•°é‡</li>
<li>ä¿¡å·é‡ï¼Œç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®æŸä¸ªèµ„æºçš„çº¿ç¨‹æ•°é‡</li>
</ol>
<h2 id="Semaphore-ä½¿ç”¨æ¡ˆä¾‹"><a href="#Semaphore-ä½¿ç”¨æ¡ˆä¾‹" class="headerlink" title="Semaphore ä½¿ç”¨æ¡ˆä¾‹"></a>Semaphore ä½¿ç”¨æ¡ˆä¾‹</h2><p>å¦‚ä¸‹ä»£ç ï¼Œåˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæäº¤äº†20ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡ä¸­éƒ½ç­‰å¾…1sï¼Œæ¨¡æ‹Ÿæ–¹æ³•è°ƒç”¨è€—æ—¶ï¼Œæ­£å¸¸æ¥è¯´å¯ä»¥20ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œä½†æ˜¯ç°åœ¨åªå…è®¸2ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œå¯ä»¥çœ‹åˆ°æ‰“å°çš„ç»“æœæ˜¯2ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œå‰©ä¸‹çš„ä»»åŠ¡éƒ½è¢«é˜»å¡äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestSemaphore</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();<br>        <span class="hljs-type">Semaphore</span> <span class="hljs-variable">semaphore</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) &#123;<br>            executorService.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SemaphoreThread</span>(semaphore));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SemaphoreThread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Semaphore semaphore;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">SemaphoreThread</span><span class="hljs-params">(Semaphore semaphore)</span> &#123;<br>            <span class="hljs-built_in">this</span>.semaphore = semaphore;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                semaphore.acquire();<br>                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; è¿›å…¥&quot;</span>);<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; ç¦»å¼€&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                semaphore.release();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœï¼š</p>
<figure class="highlight subunit"><table><tr><td class="code"><pre><code class="hljs subunit">pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-4</span> è¿›å…¥<br>pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-1</span> è¿›å…¥<br>pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-1</span> ç¦»å¼€<br>pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-4</span> ç¦»å¼€<br>pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-3</span> è¿›å…¥<br>pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-8</span> è¿›å…¥<br>pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-3</span> ç¦»å¼€<br>pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-7</span> è¿›å…¥<br>pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-8</span> ç¦»å¼€<br>â€¦â€¦<br></code></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æœ€å¤šå…è®¸ä¸¤ä¸ªçº¿ç¨‹è¿›å…¥æ‰§è¡Œï¼Œå‰©ä¸‹çš„çº¿ç¨‹éƒ½è¢«é˜»å¡äº†ã€‚</p>
<h2 id="Semaphore-å®ç°åŸç†"><a href="#Semaphore-å®ç°åŸç†" class="headerlink" title="Semaphore å®ç°åŸç†"></a>Semaphore å®ç°åŸç†</h2><ol>
<li><code>Semaphore</code> å®é™…ä¸Šä¹Ÿæ˜¯åŸºäº <code>AQS</code> ä¸­çš„å…±äº«é”æ¥å®ç°çš„</li>
<li>åœ¨ <code>Semaphore</code> ä¸­å…è®¸å¤šä¸ªçº¿ç¨‹è·å¾—ä»¤ç‰Œè¢«å”¤é†’<br>ä»¥ä¸‹é¢ä»£ç ä¸ºä¾‹</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  ä½¿ç”¨éƒ¨åˆ†</span><br><span class="hljs-type">Semaphore</span> <span class="hljs-variable">semaphore</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">2</span>);<br>semaphore.acquire();<br><br><span class="hljs-comment">// æºç éƒ¨åˆ†ï¼Œ new Semaphore å®é™…åˆ›å»ºäº†ä¸€ä¸ª NonfairSync ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">Semaphore</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>)</span> &#123;<br>    sync = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NonfairSync</span>(<span class="hljs-keyword">permits</span>);<br>&#125;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NonfairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">2694183684443567898L</span>;<br><br>    NonfairSync(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>) &#123;<br>        <span class="hljs-comment">// è¿™é‡Œå®é™…æ˜¯è®¾ç½® AQS çš„ state å˜é‡çš„å€¼</span><br>        <span class="hljs-built_in">super</span>(<span class="hljs-keyword">permits</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// è¿™é‡Œæ˜¯é‡å†™äº†è·å–éå…±äº«é”çš„é€»è¾‘</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> &#123;<br>        <span class="hljs-keyword">return</span> nonfairTryAcquireShared(acquires);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1192457210091910933L</span>;<br><br>    Sync(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>) &#123;<br>        setState(<span class="hljs-keyword">permits</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getPermits</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> getState();<br>    &#125;<br><br>    <span class="hljs-comment">//  è·å–éå…±äº«é”å®é™…å°±æ˜¯è·å– AQS ä¸­å˜é‡çš„å€¼ï¼Œç„¶åå‡å»æ­¤æ¬¡éœ€è¦è·å–åˆ°  permits æ•°é‡ï¼Œ å¦‚æœè¿™ä¸ªæ•°é‡&lt;0 ä»£è¡¨è·å–ä»¤ç‰Œå¤±è´¥</span><br>    <span class="hljs-comment">//  å¦åˆ™å°±æ˜¯è®¾ç½®ä»¤ç‰ŒæˆåŠŸï¼ŒåŒæ—¶å°†å‰©ä½™ä»¤ç‰Œæ•°é‡ä½¿ç”¨ cas æ–¹å¼æ›´æ–°çš„ state å˜é‡ä¸­</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nonfairTryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> &#123;<br>        <span class="hljs-keyword">for</span> (;;) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> getState();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> available - acquires;<br>            <span class="hljs-keyword">if</span> (remaining &lt; <span class="hljs-number">0</span> ||<br>                compareAndSetState(available, remaining))<br>                <span class="hljs-keyword">return</span> remaining;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//  è¯¥æ–¹æ³•æ˜¯é‡Šæ”¾ä»¤ç‰Œçš„é€»è¾‘ï¼Œå’Œè·å–é”æ˜¯ç±»ä¼¼çš„ï¼Œä¹Ÿæ˜¯å…ˆè·å– AQS ä¸­ state å˜é‡çš„å€¼ï¼Œç„¶ååŠ ä¸Šé‡Šæ”¾çš„ä»¤ç‰Œæ•°é‡</span><br>    <span class="hljs-comment">//  ç„¶åå†ä½¿ç”¨ cas æ–¹å¼æ›´æ–° state å˜é‡çš„å€¼å³å¯</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> &#123;<br>        <span class="hljs-keyword">for</span> (;;) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> getState();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> current + releases;<br>            <span class="hljs-keyword">if</span> (next &lt; current) <span class="hljs-comment">// overflow</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Maximum permit count exceeded&quot;</span>);<br>            <span class="hljs-keyword">if</span> (compareAndSetState(current, next))<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>ThreadLocalçš„ä½¿ç”¨å’ŒåŸç†</title>
    <url>/2023/15c7fbcaf228/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="ThreadLocalçš„ä½¿ç”¨åœºæ™¯"><a href="#ThreadLocalçš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="ThreadLocalçš„ä½¿ç”¨åœºæ™¯"></a>ThreadLocalçš„ä½¿ç”¨åœºæ™¯</h2><ul>
<li>è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå› ä¸º <code>ThreadLocal</code> å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª <code>ThreadLocalMap</code>ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥å°†è‡ªå·±çš„å˜é‡å­˜å‚¨åˆ° <code>ThreadLocalMap</code> ä¸­ï¼Œä»è€Œå®ç°äº†çº¿ç¨‹é—´çš„å˜é‡å…±äº«ã€‚</li>
<li>è§£å†³èµ„æºå…±äº«é—®é¢˜</li>
<li>è§£å†³çº¿ç¨‹é—´æ•°æ®ä¼ é€’é—®é¢˜</li>
</ul>
<h2 id="2-ThreadLocalçš„ä½¿ç”¨"><a href="#2-ThreadLocalçš„ä½¿ç”¨" class="headerlink" title="2. ThreadLocalçš„ä½¿ç”¨"></a>2. ThreadLocalçš„ä½¿ç”¨</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocalDemo</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Integer&gt; threadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            threadLocal.set(<span class="hljs-number">100</span>);<br>            System.out.println(threadLocal.get());<br>        &#125;).start();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            threadLocal.set(<span class="hljs-number">200</span>);<br>            System.out.println(threadLocal.get());<br>        &#125;).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç ä¸­å®šä¹‰çš„ <code>threadLocal</code> æ˜¯ä¸€ä¸ªé™æ€å˜é‡ï¼Œå¹¶ä¸”ä¸¤ä¸ªçº¿ç¨‹éƒ½ä½¿ç”¨äº†ï¼Œä½†æ˜¯ä¸åŒçº¿ç¨‹ä¸­ä½¿ç”¨çš„ <code>threadLocal</code> è¿›è¡Œ <code>set</code> å’Œ <code>get</code> çš„éƒ½æ˜¯å¯¹åº”çº¿ç¨‹çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹æ“ä½œ <code>threadLocal</code> ä¸ä¼šå½±å“åˆ°å½“å‰çº¿ç¨‹çš„å€¼ã€‚</p>
<h2 id="ThreadLocal-ç›¸å…³å¯¹è±¡çš„å…³è”å…³ç³»"><a href="#ThreadLocal-ç›¸å…³å¯¹è±¡çš„å…³è”å…³ç³»" class="headerlink" title="ThreadLocal ç›¸å…³å¯¹è±¡çš„å…³è”å…³ç³»"></a>ThreadLocal ç›¸å…³å¯¹è±¡çš„å…³è”å…³ç³»</h2><pre class="mermaid">graph LR
    subgraph A[" Thread å¯¹è±¡"]
        subgraph B1["ThreadLocalMap æˆå‘˜å˜é‡"]
            subgraph C["Entry å¯¹è±¡"]
                C1["key å¼•ç”¨"]
                C2["value å¼•ç”¨"]
            end
        end
    end
    B["ThreadLocal å¯¹è±¡"]
    C1-. "è™šå¼•ç”¨" .->B
    C2--"å¼ºå¼•ç”¨"-->D
    D["value å€¼"]</pre>

<p>æ ¹æ®ä¸Šè¿°å¯¹è±¡å…³è”å›¾æˆ‘ä»¬å†æ¥çœ‹çœ‹ <code>ThreadLocal</code> æºç </p>
<h2 id="ThreadLocal-æºç "><a href="#ThreadLocal-æºç " class="headerlink" title="ThreadLocal æºç "></a>ThreadLocal æºç </h2><p>ä»ä¸Šé¢ ThreadLocal çš„ä½¿ç”¨ç¤ºä¾‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ¶‰åŠçš„å‡ ä¸ªé‡è¦çš„æ–¹æ³•å¦‚ä¸‹</p>
<ol>
<li>new ThreadLocal()</li>
<li>ThreadLocal.set()</li>
<li>ThreadLocal.get()</li>
<li>ThreadLocal.remove()</li>
</ol>
<p>å…ˆçœ‹åˆ›å»º set æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocal</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(T value)</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>        <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);<br>        <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) &#123;<br>            map.set(<span class="hljs-built_in">this</span>, value);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// ç¬¬ä¸€æ¬¡ä½¿ç”¨æ˜¯èµ°è¿™ä¸ªåˆ†æ”¯ï¼Œåˆ›å»º ThreadLocalMap å¯¹è±¡</span><br>            createMap(t, value);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//  ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ Thread å¯¹è±¡ï¼Œè¿™é‡Œæ˜¯å°† åˆ›å»ºçš„ ThreadLocalMap å¯¹è±¡èµ‹å€¼ç»™ Thread å¯¹è±¡ä¸­çš„ threadLocals å±æ€§</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">createMap</span><span class="hljs-params">(Thread t, T firstValue)</span> &#123;<br>        t.threadLocals = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalMap</span>(<span class="hljs-built_in">this</span>, firstValue);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥å†çœ‹çœ‹åˆ›å»º ThreadLocalMap æ–¹æ³•, ä»ä¸Šé¢å¯¹è±¡å…³è”å›¾å¯çŸ¥ï¼ŒThreadLocalMap ç±»æ˜¯ ThreadLocal çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼ŒEntry åˆæ˜¯ä¸€ä¸ª ThreadLocalMap çš„ä¸€ä¸ªå†…éƒ¨ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocal</span>&lt;T&gt; &#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocalMap</span> &#123;<br>        <span class="hljs-keyword">private</span> Entry[] table;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         Entry æœ‰ä¸¤ä¸ªå±æ€§ï¼Œä¸€ä¸ªç”¨æ¥å­˜å‚¨ key, ä¸€ä¸ªç”¨æ¥å­˜å‚¨ value,è¿™ä¸ªkeyå°±æ˜¯ ThreadLocal å¯¹è±¡ï¼Œ</span><br><span class="hljs-comment">         value å°±æ˜¯ ThreadLocal å¯¹è±¡ä¸­å­˜å‚¨çš„å€¼, ä»ä¸‹é¢çœ‹ Entry ä¸­åªæœ‰ä¸€ä¸ª value å±æ€§ï¼Œ</span><br><span class="hljs-comment">         æ˜¯å› ä¸º Entry ç»§æ‰¿äº† WeakReferenceï¼Œ æ‰€ä»¥åœ¨çˆ¶ç±»ä¸­æœ€ç»ˆè¿˜æœ‰ä¸€ä¸ª private T referent;  å±æ€§ï¼Œkey å°±æ˜¯å­˜åœ¨è¿™ä¸ªå±æ€§ä¸­</span><br><span class="hljs-comment">        */</span><br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Entry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; &#123;<br>            Object value;<br><br>            Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;<br>                <span class="hljs-built_in">super</span>(k);<br>                value = v;<br>            &#125;<br>        &#125;<br><br><br>        <span class="hljs-comment">/* åˆ›å»º ThreadLocalMap ç›¸å…³çš„é€»è¾‘ï¼Œ å…¶å®å°±æ˜¯å°† key å’Œ value ç»„åˆèµ·æ¥å˜æˆä¸€ä¸ª Entry å¯¹è±¡,</span><br><span class="hljs-comment">         ç„¶åå°†è¿™ä¸ª Entry å¯¹è±¡æ”¾åˆ°ä¸€ä¸ª ThreadLocalMap çš„æ•°ç»„ä¸­</span><br><span class="hljs-comment">        */</span><br>        ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;<br>            table = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>[INITIAL_CAPACITY];<br>            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="hljs-number">1</span>);<br>            table[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(firstKey, firstValue);<br>            size = <span class="hljs-number">1</span>;<br>            setThreshold(INITIAL_CAPACITY);<br>        &#125;<br>    <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="ThreadLocal-çš„å†…å­˜æ³„éœ²é—®é¢˜"><a href="#ThreadLocal-çš„å†…å­˜æ³„éœ²é—®é¢˜" class="headerlink" title="ThreadLocal çš„å†…å­˜æ³„éœ²é—®é¢˜"></a>ThreadLocal çš„å†…å­˜æ³„éœ²é—®é¢˜</h2><p>æ‰§è¡Œå®Œä¸‹é¢çš„ä»£ç ä¹‹åæœ‰å †ä¸­çš„ ThreadLocal æœ‰å‡ ä¸ªå¼•ç”¨å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> ThreadLocal&lt;Integer&gt; tl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br>tl.set(<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>
<p>è¡¨é¢çœ‹åªæœ‰æ ˆä¸­çš„ <code>tl</code>å˜é‡æŒ‡å‘äº† <code>ThreadLocal</code> å®ä¾‹ï¼Œå…¶å®ä¸æ˜¯çš„ï¼Œä»ä¸Šé¢å¯¹è±¡å…³è”å›¾ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œ<code>Entry</code> å¯¹è±¡çš„ <code>key</code> å°±æ˜¯ä¸€ä¸ª <code>ThreadLocal</code> å®ä¾‹çš„å¼•ç”¨ï¼Œæ‰€ä»¥å³ä½¿æ ˆä¸­çš„å¼•ç”¨æ–­å¼€äº†ï¼Œä½†æ˜¯ <code>Entry</code> ä¸­çš„å¼•ç”¨è¿˜åœ¨ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ <code>Entry</code> ä¸­çš„ <code>key</code> è¦ä½¿ç”¨å¼±å¼•ç”¨çš„åŸå› ã€‚</p>
<p>å³ä½¿ <code>Entry</code> ä¸­çš„ <code>key</code> ä½¿ç”¨äº†å¼±å¼•ç”¨ï¼Œå¯ä»¥è®© <code>Key</code> è¢«å›æ”¶ï¼Œä½†æ˜¯ <code>Entry</code> ä¸­çš„ <code>value</code> æ˜¯ä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œä¾ç„¶ä¸ä¼šè¢«å›æ”¶ï¼Œè¿™ä¸ªåº”è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ</p>
<p>åœ¨ <code>ThreadLocal</code> ä¸­æä¾›äº† <code>remove()</code> æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬åœ¨ä½¿ç”¨å®Œ <code>ThreadLocal</code> ä¹‹åè°ƒç”¨ <code>remove()</code> æ–¹æ³•</p>
<h2 id="çº¿ç¨‹æ± ä½¿ç”¨-ThreadLocal-çš„å‘"><a href="#çº¿ç¨‹æ± ä½¿ç”¨-ThreadLocal-çš„å‘" class="headerlink" title="çº¿ç¨‹æ± ä½¿ç”¨ ThreadLocal çš„å‘"></a>çº¿ç¨‹æ± ä½¿ç”¨ ThreadLocal çš„å‘</h2><p>å¦‚æœåœ¨çº¿ç¨‹ä¸­ä½¿ç”¨äº† <code>ThreadLocal</code> é‚£ä¹ˆä¸€å®šè¦åœ¨ä½¿ç”¨å®Œä¹‹åï¼ˆä¹Ÿå°±æ˜¯åœ¨æ­¤æ¬¡å¤„ç†ä¸å†éœ€è¦ä» <code>ThreadLocal</code> ä¸­è°ƒç”¨ <code>get()</code> æ–¹æ³•è·å–å€¼äº†ï¼‰è°ƒç”¨ <code>remove()</code> æ–¹æ³•ï¼Œ å› ä¸ºçº¿ç¨‹æ± ä¸­çº¿ç¨‹æ˜¯å¤ç”¨çš„ï¼Œå¦‚æœæ²¡æœ‰è°ƒç”¨ <code>remove()</code> æ–¹æ³•å½“ä¸‹æ¬¡å¤ç”¨åˆ°ä¹‹å‰çš„çº¿ç¨‹æ—¶ä» <code>ThreadLocal</code> ä¸­è·å–çš„å°±å¯èƒ½æ˜¯ä¹‹å‰è®¾ç½®çš„å€¼</p>
]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>synchronizedçš„ä½œç”¨å’Œå®ç°åŸç†</title>
    <url>/2023/138a9fb1d57d/index.html</url>
    <content><![CDATA[<p>å‚è€ƒ ã€ŠJavaå¹¶å‘ç¼–ç¨‹æ·±åº¦è§£æä¸å®æˆ˜ã€‹</p>
<h2 id="ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸å®‰å…¨"><a href="#ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸å®‰å…¨" class="headerlink" title="ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸å®‰å…¨"></a>ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸å®‰å…¨</h2><p>å°±æ˜¯å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æŸä¸ªæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•æ— æ³•æŒ‰ç…§æˆ‘ä»¬é¢„æœŸçš„è¡Œä¸ºæ¥æ‰§è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬è®¤ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„</p>
<h2 id="å¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨çš„åŸå› "><a href="#å¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨çš„åŸå› " class="headerlink" title="å¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨çš„åŸå› "></a>å¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨çš„åŸå› </h2><ol>
<li>åŸå­æ€§</li>
<li>æœ‰åºæ€§</li>
<li>å¯è§æ€§</li>
</ol>
<h2 id="åŸå­æ€§é—®é¢˜"><a href="#åŸå­æ€§é—®é¢˜" class="headerlink" title="åŸå­æ€§é—®é¢˜"></a>åŸå­æ€§é—®é¢˜</h2><blockquote>
<p>åŸå­æ€§æ˜¯æŒ‡ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡ä»¤æ“ä½œåœ¨CPUæ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­</p>
</blockquote>
<h3 id="åŸå­æ€§é—®é¢˜çš„æœ¬è´¨"><a href="#åŸå­æ€§é—®é¢˜çš„æœ¬è´¨" class="headerlink" title="åŸå­æ€§é—®é¢˜çš„æœ¬è´¨"></a>åŸå­æ€§é—®é¢˜çš„æœ¬è´¨</h3><ol>
<li><code>cpu</code> æ—¶é—´ç‰‡åˆ‡æ¢</li>
<li>æ‰§è¡ŒæŒ‡ä»¤çš„åŸå­æ€§ï¼Œå³çº¿ç¨‹è¿è¡Œçš„ç¨‹åºæˆ–æŒ‡ä»¤æ˜¯å¦å…·å¤‡åŸå­æ€§</li>
</ol>
<h3 id="åŸå­æ€§é—®é¢˜çš„è§£å†³"><a href="#åŸå­æ€§é—®é¢˜çš„è§£å†³" class="headerlink" title="åŸå­æ€§é—®é¢˜çš„è§£å†³"></a>åŸå­æ€§é—®é¢˜çš„è§£å†³</h3><ol>
<li>ä¸å…è®¸å½“å‰éåŸå­æŒ‡ä»¤åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«ä¸­æ–­ã€‚æ¯”å¦‚ä¿è¯ <code>i++</code> æ“ä½œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å­˜åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
<li>å¤šçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œå¯¼è‡´çš„åŸå­æ€§é—®é¢˜å¯ä»¥é€šè¿‡äº’æ–¥æ¡ä»¶æ¥å®ç°ä¸²è¡Œæ‰§è¡Œ</li>
</ol>
<h2 id="åŒæ­¥é”ä¹‹-synchronized"><a href="#åŒæ­¥é”ä¹‹-synchronized" class="headerlink" title="åŒæ­¥é”ä¹‹ synchronized"></a>åŒæ­¥é”ä¹‹ synchronized</h2><h3 id="synchronized-å…³é”®å­—çš„ä½œç”¨"><a href="#synchronized-å…³é”®å­—çš„ä½œç”¨" class="headerlink" title="synchronized å…³é”®å­—çš„ä½œç”¨"></a>synchronized å…³é”®å­—çš„ä½œç”¨</h3><ol>
<li>ä½œç”¨åœ¨æ–¹æ³•çº§åˆ«ï¼šé”å®šçš„æ˜¯å½“å‰ <code>class</code></li>
<li>ä½œç”¨åœ¨ä»£ç å—ï¼šé”å®šæŸä¸ªå¯¹è±¡å®ä¾‹</li>
</ol>
<h3 id="synchronized-éœ€è¦å®ç°çš„åŠŸèƒ½"><a href="#synchronized-éœ€è¦å®ç°çš„åŠŸèƒ½" class="headerlink" title="synchronized éœ€è¦å®ç°çš„åŠŸèƒ½"></a>synchronized éœ€è¦å®ç°çš„åŠŸèƒ½</h3><ol>
<li><code>synchronized</code> æ˜¯åŒæ­¥æ’ä»–é”ï¼Œè¦æƒ³è¾¾åˆ°æ’ä»–ï¼Œå°±éœ€è¦å¤šä¸ªçº¿ç¨‹æŠ¢å¤ºåŒä¸€ä¸ªèµ„æº</li>
<li>åŒä¸€ä¸ªæ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŠ¢åˆ°é”ï¼Œå…¶ä»–æ²¡æœ‰æŠ¢åˆ°é”çš„çº¿ç¨‹å°±éœ€è¦ç­‰å¾…</li>
<li>å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ä¸èƒ½ä¸€ç›´å ç”¨ <code>cpu</code>, æ‰€ä»¥éœ€è¦é˜»å¡èµ·æ¥ï¼Œå¹¶ä¸”é‡Šæ”¾ <code>cpu</code> èµ„æº</li>
<li>å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è¢«é˜»å¡ï¼Œå°±è¿˜éœ€è¦ä¸€ä¸ªå®¹å™¨æ¥å­˜å‚¨è¿™äº›è¢«é˜»å¡çš„çº¿ç¨‹ï¼Œå½“è·å¾—é”çš„çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡å¹¶é‡Šæ”¾é”ä¹‹åï¼Œå°±éœ€è¦ä»å®¹å™¨ä¸­å”¤é†’é˜»å¡çš„çº¿ç¨‹ï¼Œè¢«å”¤é†’çš„çº¿ç¨‹å†æ¬¡å°è¯•è·å–é”</li>
</ol>
<h3 id="synchronized-ä¹‹é”èµ„æº"><a href="#synchronized-ä¹‹é”èµ„æº" class="headerlink" title="synchronized ä¹‹é”èµ„æº"></a>synchronized ä¹‹é”èµ„æº</h3><p>å‰é¢è®²åˆ° <code>synchronized</code> å¯ä»¥ä¿®é¥°æ–¹æ³•å’Œä¿®é¥°ä»£ç å—</p>
<ol>
<li>ä¿®é¥°æ–¹æ³•æ—¶ï¼Œå¯¹åº”çš„èµ„æºå°±æ˜¯å½“å‰ <code>class</code> ï¼ˆé™æ€æ–¹æ³•ï¼‰æˆ–å½“å‰å¯¹è±¡å®ä¾‹</li>
<li>ä¿®é¥°ä»£ç å—æ—¶ï¼Œæ˜¯ <code>synchronized(lock)</code> ä¸­çš„ <code>lock</code> å°±æ˜¯èµ„æº</li>
</ol>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœå¤šä¸ªçº¿ç¨‹è®¿é—®å¤šä¸ªé”èµ„æºï¼Œå°±ä¸å­˜åœ¨ç«äº‰å…³ç³»ï¼Œä¹Ÿå°±è¾¾ä¸åˆ°äº’æ–¥çš„æ•ˆæœ</strong></p>
<h3 id="æŠ¢åˆ°é”çš„æ ‡è®°ä¹‹-Mark-Word"><a href="#æŠ¢åˆ°é”çš„æ ‡è®°ä¹‹-Mark-Word" class="headerlink" title="æŠ¢åˆ°é”çš„æ ‡è®°ä¹‹ Mark Word"></a>æŠ¢åˆ°é”çš„æ ‡è®°ä¹‹ Mark Word</h3><p>å‰é¢è®²åˆ° <strong>åŒä¸€ä¸ªæ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŠ¢åˆ°é”</strong>ï¼Œ å¯¹äºæŠ¢åˆ°é”çš„çº¿ç¨‹å°±éœ€è¦è¿›è¡Œæ ‡è®°åˆ°åº•æ˜¯é‚£ä¸ªçº¿ç¨‹æŠ¢åˆ°äº†é”ï¼Œè¿™ä¸ªæ ‡è®°å°±æ˜¯å­˜å‚¨åœ¨<strong>å¯¹è±¡å¤´</strong>ä¸­çš„</p>
<h4 id="java-å¯¹è±¡å­˜å‚¨ç»“æ„"><a href="#java-å¯¹è±¡å­˜å‚¨ç»“æ„" class="headerlink" title="java å¯¹è±¡å­˜å‚¨ç»“æ„"></a>java å¯¹è±¡å­˜å‚¨ç»“æ„</h4><p><code>java</code> å¯¹è±¡å­˜å‚¨ç»“æ„åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†</p>
<ol>
<li>å¯¹è±¡å¤´</li>
<li>å®ä¾‹æ•°æ®</li>
<li>å¯¹å…¶å¡«å……</li>
</ol>
<p>æ¯”å¦‚åˆ›å»ºä¸€ä¸ªå¯¹è±¡ <code>Object lock = new Object();</code>ï¼Œ åœ¨å †ä¸­ <code>lock</code> å®ä¾‹æœ€ç»ˆçš„å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311282221986.webp" alt="å¯¹è±¡å­˜å‚¨ç»“æ„"></p>
<h4 id="å¯¹è±¡å¤´"><a href="#å¯¹è±¡å¤´" class="headerlink" title="å¯¹è±¡å¤´"></a>å¯¹è±¡å¤´</h4><p>å¯¹è±¡å¤´åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†</p>
<ol>
<li><code>Mark Word</code></li>
<li><code>Klass Pointer</code></li>
<li><code>Lenght</code></li>
</ol>
<p><strong>Mark Word</strong><br><code>Mark Word</code> è®°å½•äº†ä¸å¯¹è±¡å’Œé”ç›¸å…³çš„ä¿¡æ¯ï¼Œå½“è¿™ä¸ªå¯¹è±¡ä½œä¸ºé”å¯¹è±¡æ¥å®ç°<code>synchronized</code> çš„åŒæ­¥æ“ä½œæ—¶ï¼Œé”æ ‡è®°å’Œç›¸å…³ä¿¡æ¯éƒ½æ˜¯å­˜å‚¨åœ¨ <code>Mark Word</code>ä¸­çš„</p>
<div class="tabs" id="mark-wordå­˜å‚¨ç»“æ„"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="mark-wordå­˜å‚¨ç»“æ„-1">32ä½Mark</button><button type="button" class="tab " data-href="mark-wordå­˜å‚¨ç»“æ„-2">64ä½Mark Wordå­˜å‚¨ç»“æ„</button></ul><div class="tab-contents"><div class="tab-item-content active" id="mark-wordå­˜å‚¨ç»“æ„-1"><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311282227201.webp" alt="32ä½Mark Wordå­˜å‚¨ç»“æ„"></p></div><div class="tab-item-content" id="mark-wordå­˜å‚¨ç»“æ„-2"><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311282225221.webp" alt="64ä½Mark Wordå­˜å‚¨ç»“æ„"></p></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<ol>
<li>ä¸ç®¡åœ¨32ä½è¿˜æ˜¯64ä½ç³»ç»Ÿä¸­ï¼Œ<code>Mark Word</code>ä¸­éƒ½ä¼šåŒ…å«<code>GC</code>åˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡è®°</li>
<li>é”çŠ¶æ€çš„å­—æ®µï¼Œå®ƒåŒ…å«äº”ç§çŠ¶æ€åˆ†åˆ«æ˜¯æ— é”ã€åå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”ã€GCæ ‡è®°</li>
<li>æ— é”å’Œåå‘é”çš„ é”æ ‡è®°ä½éƒ½æ˜¯ 01ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå•ç‹¬çš„ <code>bit</code> å­˜å‚¨ <strong>æ˜¯å¦åå‘é”</strong></li>
</ol>
<p><strong>Klass Pointer</strong><br><code>Klass Pointer</code> è®°å½•äº†å¯¹è±¡æ‰€å±çš„ <code>class</code> ä¿¡æ¯ï¼Œå½“å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œä¼šå°† <code>Klass Pointer</code> æŒ‡å‘ <code>class</code> ä¿¡æ¯</p>
<p><strong>Length</strong><br>è¡¨ç¤ºæ•°ç»„é•¿åº¦ï¼Œåªæœ‰æ„å»ºå¯¹è±¡æ•°ç»„æ—¶æ‰ä¼šæœ‰æ•°ç»„é•¿åº¦å±æ€§</p>
<h4 id="å†…å­˜ä¸­å¯¹è±¡å­˜å‚¨ç¤ºä¾‹"><a href="#å†…å­˜ä¸­å¯¹è±¡å­˜å‚¨ç¤ºä¾‹" class="headerlink" title="å†…å­˜ä¸­å¯¹è±¡å­˜å‚¨ç¤ºä¾‹"></a>å†…å­˜ä¸­å¯¹è±¡å­˜å‚¨ç¤ºä¾‹</h4><p>æ¯”å¦‚ä¸‹é¢ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MarkWordExample</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">MarkWordExample</span> <span class="hljs-variable">example</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarkWordExample</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>åœ¨ <code>jvm</code> è¿è¡Œæ—¶å†…å­˜ä¸­ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311282236608.webp" alt="å¯¹è±¡ç»“æ„ç¤ºä¾‹"></p>
<h2 id="é”å‡çº§è¿‡ç¨‹"><a href="#é”å‡çº§è¿‡ç¨‹" class="headerlink" title="é”å‡çº§è¿‡ç¨‹"></a>é”å‡çº§è¿‡ç¨‹</h2><p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311282252724.webp" alt="é”å‡çº§"></p>
<div class="tabs" id="é”å‡çº§è¿‡ç¨‹"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="é”å‡çº§è¿‡ç¨‹-1">åå‘é”</button><button type="button" class="tab " data-href="é”å‡çº§è¿‡ç¨‹-2">åå‘é”çš„æ‰¹é‡é‡åå‘</button><button type="button" class="tab " data-href="é”å‡çº§è¿‡ç¨‹-3">è½»é‡çº§é”</button><button type="button" class="tab " data-href="é”å‡çº§è¿‡ç¨‹-4">é‡é‡çº§é”</button></ul><div class="tab-contents"><div class="tab-item-content active" id="é”å‡çº§è¿‡ç¨‹-1"><p>åå‘é”å…¶å®å¯ä»¥è®¤ä¸ºæ˜¯åœ¨æ²¡æœ‰å¤šçº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹è®¿é—®<code>synchronized</code>ä¿®é¥°çš„ä»£ç å—çš„åŠ é”åœºæ™¯ï¼Œä¹Ÿå°±æ˜¯åœ¨å•çº¿ç¨‹æ‰§è¡Œçš„æƒ…å†µä¸‹</p>
<p>çº¿ç¨‹åœ¨æ²¡æœ‰çº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹å»è®¿é—®synchronizedåŒæ­¥ä»£ç å—æ—¶ï¼Œä¼šå°è¯•å…ˆé€šè¿‡åå‘é”æ¥æŠ¢å è®¿é—®èµ„æ ¼ï¼Œè¿™ä¸ªæŠ¢å è¿‡ç¨‹æ˜¯åŸºäºCASæ¥å®Œæˆçš„ï¼Œå¦‚æœæŠ¢å é”æˆåŠŸï¼Œåˆ™ç›´æ¥ä¿®æ”¹å¯¹è±¡å¤´ä¸­çš„é”æ ‡è®°ã€‚å…¶ä¸­ï¼Œåå‘é”æ ‡è®°ä¸º1ï¼Œé”æ ‡è®°ä¸º01ï¼Œä»¥åŠå­˜å‚¨å½“å‰è·å¾—é”çš„çº¿ç¨‹IDã€‚è€Œåå‘çš„æ„æ€å°±æ˜¯ï¼Œå¦‚æœçº¿ç¨‹Xè·å¾—äº†åå‘é”ï¼Œé‚£ä¹ˆå½“çº¿ç¨‹Xåç»­å†è®¿é—®è¿™ä¸ªåŒæ­¥æ–¹æ³•æ—¶ï¼Œåªéœ€è¦åˆ¤æ–­å¯¹è±¡å¤´ä¸­çš„çº¿ç¨‹IDå’Œçº¿ç¨‹Xæ˜¯å¦ç›¸ç­‰å³å¯ã€‚å¦‚æœç›¸ç­‰ï¼Œå°±ä¸éœ€è¦å†æ¬¡å»æŠ¢å é”ï¼Œç›´æ¥è·å¾—è®¿é—®èµ„æ ¼å³å¯</p></div><div class="tab-item-content" id="é”å‡çº§è¿‡ç¨‹-2"><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BiasedLock</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        List&lt;BiasedLock&gt; locks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-type">BiasedLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BiasedLock</span>();<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>                <span class="hljs-type">BiasedLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BiasedLock</span>();<br>                <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>                    locks.add(lock);<br>                &#125;<br>            &#125;<br>        &#125;);<br>        thread.start();<br>        thead.join();<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) &#123;<br>                <span class="hljs-type">BiasedLock</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span> locks.get(i);<br>                <span class="hljs-keyword">synchronized</span> (lock2) &#123;<br>                    <br>                &#125;<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br>ä¸Šé¢ä»£ç åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºäº† <span class="hljs-number">100</span>ä¸ªé”å¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæˆä¹‹åï¼Œç¬¬äºŒä¸ªçº¿ç¨‹è·å– <span class="hljs-number">100</span>ä¸ªé”å¯¹è±¡ä¸­çš„å‰é¢<span class="hljs-number">20</span>ä¸ªè¿›è¡ŒåŠ é”ï¼Œè¿™æ—¶ä¼šè§¦å‘è¿™äº›é”å¯¹è±¡çš„å‡çº§è¿‡ç¨‹ï¼Œä¼šä»åå‘é”å‡çº§åˆ°è½»é‡çº§é”ï¼Œ ä½†æ˜¯å½“æ‰§è¡Œåˆ°<span class="hljs-number">20</span>å¾ªç¯åï¼Œè¿™ä¸ªé”å¯¹è±¡åˆä¼šå˜æˆåå‘é”<br><br>åœ¨`JVM`ä¸­ï¼Œä»¥`class`ï¼ˆè¿™é‡ŒæŒ‡ `BiasedLock`ï¼‰ä¸ºå•ä½ï¼Œä¸ºæ¯ä¸ª`class`ç»´æŠ¤äº†ä¸€ä¸ªåå‘é”æ’¤é”€çš„è®¡æ•°å™¨ï¼Œå½“è¿™ä¸ª`class`çš„å¯¹è±¡å‘ç”Ÿåå‘æ’¤é”€æ“ä½œæ—¶ï¼Œè®¡æ•°å™¨ä¼šè¿›è¡Œç´¯åŠ ï¼Œå½“ç´¯åŠ çš„å€¼è¾¾åˆ°é‡åå‘çš„é˜ˆå€¼æ—¶ï¼Œ`JVM`ä¼šè®¤ä¸ºè¿™ä¸ª`class`çš„åå‘é”æœ‰é—®é¢˜ï¼Œéœ€è¦é‡æ–°åå‘<br><br>åå‘é”æ’¤é”€å¹¶æ‰¹é‡é‡åå‘çš„è§¦å‘é˜ˆå€¼å¯ä»¥é€šè¿‡`XX:BiasedLockingBulkRebiasThreshold = <span class="hljs-number">20</span>`æ¥é…ç½®ï¼Œé»˜è®¤æ˜¯<span class="hljs-number">20</span><br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="é”å‡çº§è¿‡ç¨‹-3"><p>è½»é‡çº§é”å°±æ˜¯æ²¡æœ‰æŠ¢å åˆ°é”çš„çº¿ç¨‹ï¼Œè¿›è¡Œä¸€å®šæ¬¡æ•°çš„é‡è¯•ï¼ˆè‡ªæ—‹ï¼‰ã€‚æ¯”å¦‚çº¿ç¨‹ç¬¬ä¸€æ¬¡æ²¡æŠ¢åˆ°é”åˆ™é‡è¯•å‡ æ¬¡ï¼Œå¦‚æœåœ¨é‡è¯•çš„è¿‡ç¨‹ä¸­æŠ¢å åˆ°äº†é”ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±ä¸éœ€è¦é˜»å¡ï¼Œè¿™ç§å®ç°æ–¹å¼æˆ‘ä»¬ç§°ä¸ºè‡ªæ—‹é”</p>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311282243489.webp" alt="è½»é‡çº§é”"></p>
<p>è·å¾—è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­å¯èƒ½éœ€è¦ä¸æ–­è‡ªæ—‹æ“ä½œï¼Œè¿™ä¹Ÿæ˜¯æœ‰ä»£ä»·çš„ï¼Œæ‰€ä»¥ä¹Ÿä¸å¯èƒ½ä¸€ç›´è‡ªæ—‹ä¸‹å»</p>
<p>åœ¨<code>JDK 1.6</code>ä¸­é»˜è®¤çš„è‡ªæ—‹æ¬¡æ•°æ˜¯10æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>-XX:PreBlockSpin</code>å‚æ•°æ¥è°ƒæ•´è‡ªæ—‹æ¬¡æ•°ã€‚åŒæ—¶å¼€å‘è€…åœ¨<code>JDK 1.6</code>ä¸­è¿˜å¯¹è‡ªæ—‹é”åšäº†ä¼˜åŒ–ï¼Œå¼•å…¥äº†è‡ªé€‚åº”è‡ªæ—‹é”ï¼Œè‡ªé€‚åº”è‡ªæ—‹é”çš„è‡ªæ—‹æ¬¡æ•°ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯æ ¹æ®å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹æ¬¡æ•°åŠé”æŒæœ‰è€…çš„çŠ¶æ€æ¥å†³å®šçš„ã€‚å¦‚æœåœ¨åŒä¸€ä¸ªé”å¯¹è±¡ä¸Šï¼Œé€šè¿‡è‡ªæ—‹ç­‰å¾…æˆåŠŸè·å¾—è¿‡é”ï¼Œå¹¶ä¸”æŒæœ‰é”çš„çº¿ç¨‹æ­£åœ¨è¿è¡Œä¸­ï¼Œé‚£ä¹ˆ<code>JVM</code>ä¼šè®¤ä¸ºæ­¤æ¬¡è‡ªæ—‹ä¹Ÿæœ‰å¾ˆå¤§çš„æœºä¼šè·å¾—é”ï¼Œå› æ­¤ä¼šå°†è¿™ä¸ªçº¿ç¨‹çš„è‡ªæ—‹æ—¶é—´ç›¸å¯¹å»¶é•¿ã€‚åä¹‹ï¼Œå¦‚æœåœ¨ä¸€ä¸ªé”å¯¹è±¡ä¸­ï¼Œé€šè¿‡è‡ªæ—‹é”è·å¾—é”å¾ˆå°‘æˆåŠŸï¼Œé‚£ä¹ˆ<code>JVM</code>ä¼šç¼©çŸ­è‡ªæ—‹æ¬¡æ•°</p></div><div class="tab-item-content" id="é”å‡çº§è¿‡ç¨‹-4"><p>è½»é‡çº§é”èƒ½å¤Ÿé€šè¿‡ä¸€å®šæ¬¡æ•°çš„é‡è¯•è®©æ²¡æœ‰è·å¾—é”çš„çº¿ç¨‹æœ‰å¯èƒ½æŠ¢å åˆ°é”èµ„æºï¼Œä½†æ˜¯è½»é‡çº§é”åªæœ‰åœ¨è·å¾—é”çš„çº¿ç¨‹æŒæœ‰é”çš„æ—¶é—´è¾ƒçŸ­çš„æƒ…å†µä¸‹æ‰èƒ½èµ·åˆ°æå‡åŒæ­¥é”æ€§èƒ½çš„æ•ˆæœï¼Œå¦‚æœæ²¡æŠ¢å åˆ°é”èµ„æºçš„çº¿ç¨‹é€šè¿‡ä¸€å®šæ¬¡æ•°çš„è‡ªæ—‹åï¼Œå‘ç°ä»ç„¶æ²¡æœ‰è·å¾—é”ï¼Œå°±åªèƒ½é˜»å¡ç­‰å¾…äº†ï¼Œæ‰€ä»¥æœ€ç»ˆä¼šå‡çº§åˆ°é‡é‡çº§é”ï¼Œé€šè¿‡ç³»ç»Ÿå±‚é¢çš„äº’æ–¥é‡æ¥æŠ¢å é”èµ„æº</p></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h2 id="CASåŸç†"><a href="#CASåŸç†" class="headerlink" title="CASåŸç†"></a>CASåŸç†</h2><p>å‰é¢ä»‹ç» <code>synchronized</code> çš„ è½»é‡çº§é”å°±æ˜¯é€šè¿‡ <code>cas</code> å®ç°çš„ï¼Œ<code>cas</code> æ˜¯ä¸€ç§æ— é”ç®—æ³•ï¼Œå®ƒæ˜¯é€šè¿‡ CPU æŒ‡ä»¤å®ç°çš„ï¼Œ<code>cas</code> æŒ‡ä»¤æ˜¯ä¸€æ¡ CPU æŒ‡ä»¤ï¼Œå®ƒåŒ…å«ä¸‰ä¸ªæ“ä½œæ•°ï¼Œåˆ†åˆ«æ˜¯å†…å­˜åœ°å€ã€é¢„æœŸçš„å€¼ã€æ›´æ–°çš„å€¼ï¼Œå½“ä¸”ä»…å½“å†…å­˜åœ°å€çš„å€¼ä¸é¢„æœŸçš„å€¼ç›¸åŒæ—¶ï¼Œå°†è¯¥å€¼æ›´æ–°ä¸ºæ›´æ–°å€¼ï¼Œå¦åˆ™ä¸åšä»»ä½•æ“ä½œã€‚</p>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311282249030.webp" alt="casæ“ä½œè¿‡ç¨‹"></p>
]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>volatileè§£å†³å¯è§æ€§å’Œæœ‰åºæ€§</title>
    <url>/2023/d41d7b790ebc/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="ä»€ä¹ˆæ˜¯å¯è§æ€§"><a href="#ä»€ä¹ˆæ˜¯å¯è§æ€§" class="headerlink" title="ä»€ä¹ˆæ˜¯å¯è§æ€§"></a>ä»€ä¹ˆæ˜¯å¯è§æ€§</h2><blockquote>
<p>å¦‚æœä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªå…±äº«å˜é‡è¿›è¡Œäº†ä¿®æ”¹ï¼Œè€Œå…¶ä»–çº¿ç¨‹ä¸èƒ½åŠæ—¶åœ°è¯»å–ä¿®æ”¹ä¹‹åçš„å€¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬è®¤ä¸ºåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è¯¥å…±äº«å˜é‡å­˜åœ¨å¯è§æ€§é—®é¢˜</p>
</blockquote>
<h2 id="å¯è§æ€§é—®é¢˜çš„æ ¹æº"><a href="#å¯è§æ€§é—®é¢˜çš„æ ¹æº" class="headerlink" title="å¯è§æ€§é—®é¢˜çš„æ ¹æº"></a>å¯è§æ€§é—®é¢˜çš„æ ¹æº</h2><p><code>cpu</code> çš„é€Ÿåº¦è¿œè¿œé«˜äºå†…å­˜ï¼Œä½†æ˜¯<code>cpu</code> æ‰§è¡Œçš„æŒ‡ä»¤å’Œæ•°æ®éƒ½æ˜¯æ¥æºäºå†…å­˜ï¼Œæ‰€ä»¥åœ¨ <code>cpu</code> åœ¨ç­‰å¾…å†…å­˜çš„æ•°æ®æ—¶ï¼Œä¸€ç›´å¤„äºç©ºé—²çŠ¶æ€ï¼Œè¿™ä¸ªè¿‡ç¨‹å¾ˆæ˜¾ç„¶ä¼šå¯¼è‡´<code>CPU</code>èµ„æºçš„æµªè´¹ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼€å‘è€…åœ¨ç¡¬ä»¶è®¾å¤‡ã€æ“ä½œç³»ç»ŸåŠç¼–è¯‘å™¨å±‚é¢åšäº†å¾ˆå¤šä¼˜åŒ–</p>
<ul>
<li>åœ¨<code>CPU</code>å±‚é¢å¢åŠ äº†å¯„å­˜å™¨ï¼Œæ¥ä¿å­˜ä¸€äº›å…³é”®å˜é‡å’Œä¸´æ—¶æ•°æ®ï¼Œè¿˜å¢åŠ äº†<code>CPU</code>é«˜é€Ÿç¼“å­˜ï¼Œä»¥å‡å°‘<code>CPU</code>å’Œå†…å­˜çš„I&#x2F;Oç­‰å¾…æ—¶é—´</li>
<li>åœ¨æ“ä½œç³»ç»Ÿå±‚é¢å¼•å…¥äº†è¿›ç¨‹å’Œçº¿ç¨‹ï¼Œåœ¨å½“å‰è¿›ç¨‹æˆ–çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€æ—¶ï¼Œ<code>CPU</code>ä¼šæŠŠè‡ªå·±çš„æ—¶é—´ç‰‡åˆ†é…ç»™å…¶ä»–çº¿ç¨‹æˆ–è¿›ç¨‹ä½¿ç”¨ï¼Œä»è€Œå‡å°‘<code>CPU</code>çš„ç©ºé—²æ—¶é—´ï¼Œæœ€å¤§åŒ–åœ°æå‡<code>CPU</code>çš„ä½¿ç”¨ç‡</li>
<li>åœ¨ç¼–è¯‘å™¨å±‚é¢å¢åŠ æŒ‡ä»¤ä¼˜åŒ–ï¼Œå‡å°‘ä¸å†…å­˜çš„äº¤äº’æ¬¡æ•°</li>
</ul>
<p>ä¸Šè¿°ä¼˜åŒ–éƒ½æ˜¯ä¸ºäº†æå‡ <code>cpu</code> åˆ©ç”¨ç‡ï¼Œä½†æ˜¯è¿™äº›ä¼˜åŒ–ä¹Ÿä¼šå¯¼è‡´å¯è§æ€§é—®é¢˜</p>
<h2 id="cpu-ç¼“å­˜"><a href="#cpu-ç¼“å­˜" class="headerlink" title="cpu ç¼“å­˜"></a>cpu ç¼“å­˜</h2><h3 id="cpu-ç¼“å­˜ä¼ªå…±äº«é—®é¢˜"><a href="#cpu-ç¼“å­˜ä¼ªå…±äº«é—®é¢˜" class="headerlink" title="cpu ç¼“å­˜ä¼ªå…±äº«é—®é¢˜"></a>cpu ç¼“å­˜ä¼ªå…±äº«é—®é¢˜</h3><ol>
<li><code>cpu</code> çš„ç¼“å­˜æ˜¯ä»¥ç¼“å­˜è¡Œä¸ºå•ä½è¿›è¡Œç¼“å­˜çš„ï¼Œåœ¨ 32 ä½å’Œ 64 ä½æ¶æ„ä¸­ <code>cpu</code> ç¼“å­˜è¡Œçš„å¤§å°éƒ½æ˜¯ 64 å­—èŠ‚</li>
<li>å‡è®¾æœ‰ä¸¤ä¸ª å­—æ®µ <code>int x = 0, int y =0</code> ç°åœ¨æœ‰ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«ä¿®æ”¹ <code>x</code> å’Œ ä¿®æ”¹ <code>y</code>ï¼Œå‡è®¾è¿™ä¸¤ä¸ªçº¿ç¨‹æ˜¯åœ¨ä¸åŒçš„ <code>cpu</code> æ‰§è¡Œï¼Œé‚£ä¹ˆæ¯ä¸ª <code>cpu</code> éƒ½ä¼šåŠ è½½å¯¹åº”çš„å˜é‡åˆ°è‡ªå·±çš„ <code>cpu</code> ç¼“å­˜ä¸­ï¼Œä½†æ˜¯ <code>x</code> å’Œ <code>y</code> åŠ èµ·æ¥æ‰ 8 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå˜é‡ä¸€å®šæ˜¯åœ¨åŒä¸€ä¸ªç¼“å­˜è¡Œä¸­ï¼Œ å½“çº¿ç¨‹1ï¼ˆä¿®æ”¹ <code>x</code> çš„çº¿ç¨‹ï¼‰ä¿®æ”¹äº†<code>x</code> åï¼Œå› ä¸ºç¼“å­˜ä¸€è‡´æ€§åŸç†ï¼Œå¯¼è‡´ç¬¬äºŒä¸ª <code>cpu</code> ä¸­çš„ <code>x</code> éœ€è¦å¤±æ•ˆï¼Œé—´æ¥å¯¼è‡´ ç¬¬äºŒä¸ª <code>cpu</code> ä¸­çš„ <code>y</code> çš„ç¼“å­˜ä¹Ÿå¤±æ•ˆäº†ï¼Œè¿™å°±æ˜¯ç¼“å­˜ä¼ªå…±äº«é—®é¢˜</li>
<li>åœ¨ <code>java</code> ä¸­å¯ä»¥å¯¹å­—æ®µæˆ–ç±»æ·»åŠ  <code>@Contented</code> æ³¨è§£è®©æ¯ä¸ªå­—æ®µç‹¬è‡ªå ç”¨ä¸€ä¸ªç¼“å­˜è¡Œ</li>
</ol>
<h3 id="cpu-é«˜é€Ÿç¼“å­˜"><a href="#cpu-é«˜é€Ÿç¼“å­˜" class="headerlink" title="cpu é«˜é€Ÿç¼“å­˜"></a>cpu é«˜é€Ÿç¼“å­˜</h3><p>ç°ä»£ <code>cpu</code> ä¸€èˆ¬éƒ½æœ‰ä¸‰çº§ç¼“å­˜</p>
<ol>
<li>1ï¼Œ2 çº§ç¼“å­˜æ˜¯åœ¨ <code>cpu</code> å†…éƒ¨</li>
<li>ä¸‰çº§ç¼“å­˜æ˜¯æ‰€æœ‰ <code>cpu</code> å…±äº«</li>
<li>ä¸€çº§ç¼“å­˜åŒ…å« <code>L1D</code>ï¼ˆæ•°æ®ç¼“å­˜ï¼‰å’Œ <code>L1I</code>(æŒ‡ä»¤ç¼“å­˜)</li>
</ol>
<h3 id="ç¼“å­˜ä¸€è‡´æ€§çš„è§£å†³æ–¹æ¡ˆ"><a href="#ç¼“å­˜ä¸€è‡´æ€§çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ç¼“å­˜ä¸€è‡´æ€§çš„è§£å†³æ–¹æ¡ˆ"></a>ç¼“å­˜ä¸€è‡´æ€§çš„è§£å†³æ–¹æ¡ˆ</h3><ol>
<li>æ‰€è°“çš„ç¼“å­˜ä¸€è‡´æ€§æ˜¯æŒ‡ä¸åŒçš„çº¿ç¨‹åŠ è½½åŒä¸€ä¸ªå…±äº«å˜é‡åˆ°ä¸åŒçš„ <code>cpu</code> è¿›è¡Œä¿®æ”¹ï¼Œè¿™å°±ä¼šå¯¼è‡´ä¸åŒ <code>cpu</code> ç¼“å­˜ä¸­ç›¸åŒå˜é‡çš„ç¼“å­˜å€¼å†…å®¹ä¸åŒ</li>
<li>ä¸ºäº†è§£å†³ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ åœ¨ <code>cpu</code> å±‚é¢å¼•å…¥äº† <strong>æ€»çº¿é”</strong> å’Œ <strong>ç¼“å­˜é”æœºåˆ¶</strong></li>
</ol>
<blockquote>
<p>ä¸ºäº†è§£å†³ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼Œå¼€å‘è€…åœ¨ CPU å±‚é¢å¼•å…¥äº†æ€»çº¿é”å’Œç¼“å­˜é”æœºåˆ¶ã€‚</p>
<p>åœ¨äº†è§£é”ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸‹æ€»çº¿ã€‚æ‰€è°“çš„æ€»çº¿ï¼Œå°±æ˜¯ CPU ä¸å†…å­˜ã€è¾“å…¥&#x2F;è¾“å‡ºè®¾å¤‡ä¼ ä¸“é€’ä¿¡æ¯çš„å…¬å…±é€šé“ï¼ˆä¹Ÿå«å‰ç«¯æ€»çº¿ï¼‰ï¼Œå½“CPUè®¿é—®å†…å­˜è¿›è¡Œæ•°æ®äº¤äº’æ—¶ï¼Œå¿…é¡»ç»è¿‡æ€»çº¿æ¥ä¼ è¾“ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯æ€»çº¿é”å‘¢ï¼Ÿ</p>
<p>ç®€å•æ¥è¯´ï¼Œæ€»çº¿é”å°±æ˜¯åœ¨æ€»çº¿ä¸Šå£°æ˜ä¸€ä¸ª L0ck# ä¿¡å·ï¼Œè¿™ä¸ªä¿¡å·èƒ½å¤Ÿç¡®ä¿å…±äº«å†…å­˜åªæœ‰å½“å‰ CPU å¯ä»¥è®¿é—®ï¼Œå…¶ä»–çš„å¤„ç†å™¨è¯·æ±‚ä¼šè¢«é˜»å¡ï¼Œè¿™å°±ä½¿å¾—åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªå¤„ç†èƒ½å¤Ÿè®¿é—®å…±äº«å†…å­˜ï¼Œä»è€Œè§£å†³äº†ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ä½†æ˜¯è¿™ç§åšæ³•äº§ç”Ÿçš„ä»£ä»·æ˜¯ï¼ŒCPU çš„åˆ©ç”¨ç‡ç›´çº¿ä¸‹é™ï¼Œå¾ˆæ˜¾ç„¶è¿™æ˜¯æ— æ³•è®©äººæ¥å—çš„ï¼Œäºæ˜¯ä» P6 ç³»åˆ—çš„å¤„ç†å™¨å¼€å§‹å¢åŠ äº†ç¼“å­˜é”çš„æœºåˆ¶ã€‚</p>
<p>ç¼“å­˜é”æŒ‡çš„æ˜¯ï¼Œå¦‚æœå½“å‰ CPU è®¿é—®çš„æ•°æ®å·²ç»ç¼“å­˜åœ¨å…¶ä»– CPU çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œé‚£ä¹ˆ CPU ä¸ä¼šåœ¨æ€»çº¿ä¸Šå‘å‡º Lock# ä¿¡å·ï¼Œè€Œæ˜¯é‡‡ç”¨<strong>ç¼“å­˜ä¸€è‡´æ€§åè®®</strong>æ¥ä¿è¯å¤šä¸ª CPU çš„ç¼“å­˜ä¸€è‡´æ€§ã€‚</p>
<p>CPU æœ€ç»ˆç”¨å“ªç§é”æ¥è§£å†³ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼Œå–å†³äºå½“å‰ CPU æ˜¯å¦æ”¯æŒç¼“å­˜é”ï¼Œå¦‚æœä¸æ”¯æŒï¼Œå°±ä¼šé‡‡ç”¨æ€»çº¿é”ã€‚è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯ï¼Œå½“å‰æ“ä½œçš„æ•°æ®ä¸èƒ½è¢«ç¼“å­˜åœ¨å¤„ç†å™¨å†…éƒ¨ï¼Œæˆ–è€…æ“ä½œçš„æ•°æ®è·¨å¤šä¸ªç¼“å­˜è¡Œæ—¶ï¼Œä¹Ÿä¼šä½¿ç”¨æ€»çº¿é”ã€‚</p>
</blockquote>
<h3 id="ç¼“å­˜ä¸€è‡´æ€§åè®®"><a href="#ç¼“å­˜ä¸€è‡´æ€§åè®®" class="headerlink" title="ç¼“å­˜ä¸€è‡´æ€§åè®®"></a>ç¼“å­˜ä¸€è‡´æ€§åè®®</h3><ol>
<li>ç¼“å­˜é”é€šè¿‡ç¼“å­˜ä¸€è‡´æ€§åè®®æ¥ä¿è¯ç¼“å­˜çš„ä¸€è‡´æ€§ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯ç¼“å­˜ä¸€è‡´æ€§åè®®å‘¢</li>
<li>ä¸åŒçš„ <code>CPU</code> ç±»å‹æ”¯æŒçš„ç¼“å­˜ä¸€è‡´æ€§åè®®ä¹Ÿæœ‰åŒºåˆ«ï¼Œæ¯”å¦‚<code>MSIã€MESIã€MOSIã€MESIF</code>åè®®ç­‰ï¼Œæ¯”è¾ƒå¸¸è§çš„æ˜¯MESIï¼ˆ<code>Modified Exclusive Shared Or Invalid</code>ï¼‰åè®®</li>
</ol>
<h4 id="MESI-ç¼“å­˜ä¸€è‡´æ€§åè®®å®šä¹‰çš„-cpu-ç¼“å­˜è¡Œçš„å››ç§çŠ¶æ€"><a href="#MESI-ç¼“å­˜ä¸€è‡´æ€§åè®®å®šä¹‰çš„-cpu-ç¼“å­˜è¡Œçš„å››ç§çŠ¶æ€" class="headerlink" title="MESI ç¼“å­˜ä¸€è‡´æ€§åè®®å®šä¹‰çš„ cpu ç¼“å­˜è¡Œçš„å››ç§çŠ¶æ€"></a>MESI ç¼“å­˜ä¸€è‡´æ€§åè®®å®šä¹‰çš„ cpu ç¼“å­˜è¡Œçš„å››ç§çŠ¶æ€</h4><ol>
<li><code>M (Modified)</code>: åªæœ‰å½“å‰ <code>cpu</code> å«æœ‰æ•°æ®çš„ç¼“å­˜ï¼Œå¹¶ä¸”ç¼“å­˜æ•°æ®å·²ç»è¢«ä¿®æ”¹äº†ï¼Œå’Œä¸»å†…å­˜æ•°æ®ä¸ä¸€è‡´ </li>
<li><code>E (Exclusive)</code>: åªæœ‰å½“å‰ <code>cpu</code> å«æœ‰æ•°æ®çš„ç¼“å­˜, ç¼“å­˜è¿˜æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œå’Œä¸»å†…å­˜æ•°æ®ä¸€è‡´</li>
<li><code>S (Shared)</code>: å¤šä¸ª <code>cpu</code> éƒ½å«æœ‰åŒä¸€ä»½æ•°æ®çš„ç¼“å­˜ï¼Œæ‰€æœ‰ <code>cpu</code> ä¸Šçš„ç¼“å­˜éƒ½æ²¡æœ‰è¢«ä¿®æ”¹</li>
<li><code>I (Invalid)</code>: ç¼“å­˜å·²å¤±æ•ˆ</li>
</ol>
<h4 id="MESI-åè®®é’ˆå¯¹ç¼“å­˜è¡Œçš„äº‹ä»¶ç›‘å¬"><a href="#MESI-åè®®é’ˆå¯¹ç¼“å­˜è¡Œçš„äº‹ä»¶ç›‘å¬" class="headerlink" title="MESI åè®®é’ˆå¯¹ç¼“å­˜è¡Œçš„äº‹ä»¶ç›‘å¬"></a>MESI åè®®é’ˆå¯¹ç¼“å­˜è¡Œçš„äº‹ä»¶ç›‘å¬</h4><p>éšç€ <code>cpu</code> å¯¹ç¼“å­˜è¡Œçš„æ“ä½œï¼Œç¼“å­˜è¡Œä¼šå‘ç”ŸçŠ¶æ€è½¬ç§»ï¼Œä¹Ÿå°±æ˜¯ä»ä¸€ç§çŠ¶æ€åˆ°å¦å¤–ä¸€ç§çŠ¶æ€ï¼Œæ‰€ä»¥ <code>MESI</code> åè®®å¯¹ç¼“å­˜è¡Œçš„ä¸åŒçŠ¶æ€æœ‰ä¸åŒçš„äº‹ä»¶ç›‘å¬</p>
<ol>
<li><code>M</code> çŠ¶æ€çš„ç›‘å¬ï¼š å¦‚æœä¸€ä¸ªç¼“å­˜è¡Œå¤„äº <code>M</code> çŠ¶æ€ï¼Œåˆ™å¿…é¡»ç›‘å¬æ‰€æœ‰è¯•å›¾è¯»å–è¯¥ç¼“å­˜è¡Œå¯¹åº”çš„ä¸»å†…å­˜åœ°å€çš„æ“ä½œï¼Œå¦‚æœç›‘å¬åˆ°æœ‰è¿™ç±»æ“ä½œçš„å‘ç”Ÿï¼Œåˆ™å¿…é¡»åœ¨è¯¥æ“ä½œæ‰§è¡Œä¹‹å‰æŠŠç¼“å­˜è¡Œä¸­çš„æ•°æ®å†™å›ä¸»å†…å­˜</li>
<li><code>S</code> çŠ¶æ€çš„ç›‘å¬ï¼š å¦‚æœä¸€ä¸ªç¼“å­˜è¡Œå¤„äº <code>S</code> çŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒå¿…é¡»è¦ç›‘å¬ä½¿è¯¥ç¼“å­˜è¡ŒçŠ¶æ€è®¾ç½®ä¸º <code>Invalid</code> æˆ–è€…å¯¹ç¼“å­˜è¡Œæ‰§è¡Œ <code>Exclusive</code> æ“ä½œçš„è¯·æ±‚ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å¿…é¡»è¦æŠŠå½“å‰ç¼“å­˜è¡ŒçŠ¶æ€è®¾ç½®ä¸º <code>Invalid</code></li>
<li><code>E</code> çŠ¶æ€çš„ç›‘å¬ï¼š å¦‚æœä¸€ä¸ªç¼“å­˜è¡Œå¤„äº <code>E</code> çŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒå¿…é¡»è¦ç›‘å¬å…¶ä»–è¯•å›¾è¯»å–è¯¥ç¼“å­˜è¡Œå¯¹åº”çš„ä¸»å†…å­˜åœ°å€çš„æ“ä½œï¼Œä¸€æ—¦æœ‰è¿™ç§æ“ä½œï¼Œé‚£ä¹ˆè¯¥ç¼“å­˜è¡Œéœ€è¦è®¾ç½®ä¸º <code>Shared</code></li>
</ol>
<h4 id="ç¼“å­˜è¡Œäº‹ä»¶ç›‘å¬çš„å®ç°åŸç†"><a href="#ç¼“å­˜è¡Œäº‹ä»¶ç›‘å¬çš„å®ç°åŸç†" class="headerlink" title="ç¼“å­˜è¡Œäº‹ä»¶ç›‘å¬çš„å®ç°åŸç†"></a>ç¼“å­˜è¡Œäº‹ä»¶ç›‘å¬çš„å®ç°åŸç†</h4><ol>
<li>ç›‘å¬è¿‡ç¨‹æ˜¯åŸºäº <code>CPU</code> ä¸­çš„ <code>Snoopy</code> å—…æ¢åè®®æ¥å®Œæˆçš„ï¼Œè¯¥åè®®è¦æ±‚æ¯ä¸ª <code>CPU</code> ç¼“å­˜éƒ½å¯ä»¥ç›‘å¬åˆ°æ€»çº¿ä¸Šçš„æ•°æ®äº‹ä»¶å¹¶åšå‡ºç›¸åº”çš„ååº”</li>
<li>æ‰€æœ‰ <code>CPU</code> éƒ½ä¼šç›‘å¬åœ°å€æ€»çº¿ä¸Šçš„äº‹ä»¶ï¼Œå½“æŸä¸ªå¤„ç†å™¨å‘å‡ºè¯·æ±‚æ—¶ï¼Œå…¶ä»– <code>CPU</code> ä¼šç›‘å¬åˆ°åœ°å€æ€»çº¿çš„è¯·æ±‚ï¼Œæ ¹æ®å½“å‰ç¼“å­˜è¡Œçš„çŠ¶æ€åŠç›‘å¬çš„è¯·æ±‚ç±»å‹å¯¹ç¼“å­˜è¡ŒçŠ¶æ€è¿›è¡Œæ›´æ–°</li>
</ol>
<h4 id="MESI-çŠ¶æ€å˜åŒ–ç¤ºä¾‹"><a href="#MESI-çŠ¶æ€å˜åŒ–ç¤ºä¾‹" class="headerlink" title="MESI çŠ¶æ€å˜åŒ–ç¤ºä¾‹"></a>MESI çŠ¶æ€å˜åŒ–ç¤ºä¾‹</h4><p>å‚è€ƒ ã€ŠJavaå¹¶å‘ç¼–ç¨‹æ·±åº¦è§£æä¸å®æˆ˜ã€‹â€“ è°­å³° 3.2 èŠ‚ï¼ˆæ·±åº¦ç†è§£å¯è§æ€§é—®é¢˜çš„æœ¬è´¨ï¼‰</p>
<h2 id="volatile-å®ç°åŸç†"><a href="#volatile-å®ç°åŸç†" class="headerlink" title="volatile å®ç°åŸç†"></a>volatile å®ç°åŸç†</h2><ol>
<li><code>volatile</code> å¯ä»¥è§£å†³å†…å­˜å¯è§æ€§é—®é¢˜å°±æ˜¯åŸºäº<strong>ç¼“å­˜é”&#x2F;æ€»çº¿é”</strong>çš„æ–¹å¼è¾¾åˆ°çš„ä¸€è‡´æ€§</li>
<li>æ€»çº¿é”å’Œç¼“å­˜é”é€šè¿‡ <code>Lock#</code> ä¿¡å·è§¦å‘ï¼Œå¦‚æœå½“å‰<code>CPU</code>æ”¯æŒç¼“å­˜é”ï¼Œåˆ™ä¸ä¼šåœ¨æ€»çº¿ä¸Šå£°æ˜<code>Lock#</code>ä¿¡å·ï¼Œè€Œæ˜¯åŸºäºç¼“å­˜ä¸€è‡´æ€§åè®®æ¥ä¿è¯ç¼“å­˜çš„ä¸€è‡´æ€§ã€‚å¦‚æœ<code>CPU</code>ä¸æ”¯æŒç¼“å­˜é”ï¼Œåˆ™ä¼šåœ¨æ€»çº¿ä¸Šå£°æ˜<code>Lock#</code>ä¿¡å·é”å®šæ€»çº¿ï¼Œä»è€Œä¿è¯åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ª<code>CPU</code>å¯¹å…±äº«å†…å­˜çš„è¯»å†™æ“ä½œ</li>
</ol>
<h2 id="å†…å­˜å±éšœ-è§£å†³cpuå±‚é¢çš„æŒ‡ä»¤é‡æ’"><a href="#å†…å­˜å±éšœ-è§£å†³cpuå±‚é¢çš„æŒ‡ä»¤é‡æ’" class="headerlink" title="å†…å­˜å±éšœ-è§£å†³cpuå±‚é¢çš„æŒ‡ä»¤é‡æ’"></a>å†…å­˜å±éšœ-è§£å†³cpuå±‚é¢çš„æŒ‡ä»¤é‡æ’</h2><blockquote>
<p>CPU æœ¬èº«åªæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå®ƒä¸»è¦ç”¨äºæ¥æ”¶å’Œæ‰§è¡ŒæŒ‡ä»¤ï¼Œå¹¶ä¸æ¸…æ¥šä»€ä¹ˆæ—¶å€™åº”è¯¥ä¼˜åŒ–ï¼Œä»€ä¹ˆæ—¶å€™ä¸åº”è¯¥ä¼˜åŒ–ï¼Œå› æ­¤ CPU è®¾è®¡è€…ä»¬æä¾›äº†ä¸€ä¸ªå†…å­˜å±éšœæŒ‡ä»¤ï¼Œå¼€å‘è€…å¯ä»¥åœ¨åˆé€‚çš„ä½ç½®æ’å…¥å†…å­˜å±éšœæŒ‡ä»¤ï¼Œç›¸å½“äºå‘Šè¯‰ CPUæŒ‡ä»¤ä¹‹é—´çš„å…³ç³»ï¼Œé¿å… CPU å†…å­˜ç³»ç»Ÿé‡æ’åºé—®é¢˜çš„å‘ç”Ÿã€‚</p>
</blockquote>
<h3 id="ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’"><a href="#ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’" class="headerlink" title="ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’"></a>ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’</h3><p>æŒ‡ä»¤é‡æ’åºæ˜¯æŒ‡ç¼–è¯‘å™¨æˆ–<code>CPU</code>ä¸ºäº†ä¼˜åŒ–ç¨‹åºçš„æ‰§è¡Œæ€§èƒ½è€Œå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ–°æ’åºçš„ä¸€ç§æ‰‹æ®µï¼Œé‡æ’åºä¼šå¸¦æ¥å¯è§æ€§é—®é¢˜ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹å¼€å‘ä¸­å¿…é¡»è¦å…³æ³¨å¹¶è§„é¿é‡æ’åºï¼Œ<code>java</code> ä»æºä»£ç åˆ°è¿è¡Œä¼šç»è¿‡ä¸¤ä¸ªé˜¶æ®µçš„é‡æ’</p>
<ol>
<li>ç¼–è¯‘å™¨é‡æ’åºï¼Œå°±æ˜¯åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨æ ¹æ®ä¸Šä¸‹æ–‡åˆ†æå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œç›®çš„æ˜¯å‡å°‘<code>CPU</code>å’Œå†…å­˜çš„äº¤äº’ï¼Œé‡æ’åºä¹‹åå°½å¯èƒ½ä¿è¯<code>CPU</code>ä»å¯„å­˜å™¨æˆ–ç¼“å­˜è¡Œä¸­è¯»å–æ•°æ®</li>
<li>å¤„ç†å™¨é‡æ’åºï¼Œå¤„ç†å™¨é‡æ’åºåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†</li>
<li>å¹¶è¡ŒæŒ‡ä»¤é›†é‡æ’åºï¼Œè¿™æ˜¯å¤„ç†å™¨ä¼˜åŒ–çš„ä¸€ç§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåº</li>
<li>å†…å­˜ç³»ç»Ÿé‡æ’åºï¼Œè¿™æ˜¯å¤„ç†å™¨å¼•å…¥<code>Store Buffer</code>ç¼“å†²åŒºå»¶æ—¶å†™å…¥äº§ç”Ÿçš„æŒ‡ä»¤æ‰§è¡Œé¡ºåºä¸ä¸€è‡´çš„é—®é¢˜</li>
</ol>
<h3 id="æŒ‡ä»¤é‡æ’éœ€è¦éµå¾ª-as-if-serialè¯­ä¹‰"><a href="#æŒ‡ä»¤é‡æ’éœ€è¦éµå¾ª-as-if-serialè¯­ä¹‰" class="headerlink" title="æŒ‡ä»¤é‡æ’éœ€è¦éµå¾ª as-if-serialè¯­ä¹‰"></a>æŒ‡ä»¤é‡æ’éœ€è¦éµå¾ª as-if-serialè¯­ä¹‰</h3><p><code>as-if-serial</code> è¡¨ç¤ºæ‰€æœ‰çš„ç¨‹åºæŒ‡ä»¤éƒ½å¯ä»¥å› ä¸ºä¼˜åŒ–è€Œè¢«é‡æ’åºï¼Œä½†æ˜¯åœ¨ä¼˜åŒ–çš„è¿‡ç¨‹ä¸­å¿…é¡»è¦ä¿è¯æ˜¯åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œé‡æ’åºä¹‹åçš„è¿è¡Œç»“æœå’Œç¨‹åºä»£ç æœ¬èº«é¢„æœŸçš„æ‰§è¡Œç»“æœä¸€è‡´ï¼Œ<code>Java</code> ç¼–è¯‘å™¨ã€<code>CPU</code> æŒ‡ä»¤é‡æ’åºéƒ½éœ€è¦ä¿è¯åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹çš„ <code>as-if-serial</code> è¯­ä¹‰æ˜¯æ­£ç¡®çš„</p>
<p><code>as-if-serial</code>è¯­ä¹‰å…è®¸é‡æ’åºï¼Œ<code>CPU</code>å±‚é¢çš„æŒ‡ä»¤ä¼˜åŒ–ä¾ç„¶å­˜åœ¨ã€‚åœ¨å•çº¿ç¨‹ä¸­ï¼Œè¿™äº›ä¼˜åŒ–å¹¶ä¸ä¼šå½±å“æ•´ä½“çš„æ‰§è¡Œç»“æœï¼Œåœ¨å¤šçº¿ç¨‹ä¸­ï¼Œé‡æ’åºä¼šå¸¦æ¥å¯è§æ€§é—®é¢˜</p>
<h3 id="é‡è°ˆ-MESI-è¿‡ç¨‹"><a href="#é‡è°ˆ-MESI-è¿‡ç¨‹" class="headerlink" title="é‡è°ˆ MESI è¿‡ç¨‹"></a>é‡è°ˆ MESI è¿‡ç¨‹</h3><p>å‡è®¾å­˜åœ¨ä¸€ä¸ª <code>S</code> çŠ¶æ€çš„ç¼“å­˜è¡Œï¼ˆå°±æ˜¯è¯´ <code>CPU0</code> å’Œ <code>CPU1</code> å…±äº«åŒä¸€ä¸ªç¼“å­˜è¡Œï¼‰ï¼Œå¦‚æœ <code>CPU0</code> å¯¹è¿™ä¸ªç¼“å­˜è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆ <code>CPU0</code> éœ€è¦å‘é€ä¸€ä¸ª <code>Invalidate</code> æ¶ˆæ¯åˆ° <code>CPU1</code>ï¼Œåœ¨ç­‰å¾… <code>CPU1</code> è¿”å›<code>Acknowledgement</code> æ¶ˆæ¯ä¹‹å‰ï¼Œ<code>CPU0</code> ä¸€ç›´å¤„äºç©ºé—²çŠ¶æ€</p>
<pre class="mermaid">sequenceDiagram
    participant A as CPU0
    participant B as CPU1
    A->>A: "åŠ è½½å˜é‡, ç¼“å­˜è¡ŒçŠ¶æ€S"
    B->>B: "åŠ è½½å˜é‡ï¼Œç¼“å­˜è¡ŒçŠ¶æ€S"
    A->>A: "ä¿®æ”¹å…±äº«så˜é‡"
    A->>B: "Invalidate"
    A->>A: "ç©ºé—²ç­‰å¾…"
    B->>A: "Acknowledgement"</pre>

<h4 id="Store-Buffers"><a href="#Store-Buffers" class="headerlink" title="Store Buffers"></a>Store Buffers</h4><ol>
<li><p>ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œå½“ä¸€ä¸ª <code>cpu</code> ä»å‘å‡º <code>Invalidate</code> æŒ‡ä»¤åˆ°æ”¶åˆ° <code>Acknowledgement</code> æŒ‡ä»¤ä¹‹é—´ï¼Œè¿™ä¸ª <code>cpu</code> æ˜¯éœ€è¦é˜»å¡çš„</p>
</li>
<li><p><code>Store Buffer</code> æ˜¯ä¸€ä¸ªå­˜å‚¨å™¨ï¼Œå®ƒå­˜å‚¨ç€é‚£äº›è¢«ä¿®æ”¹è¿‡çš„ç¼“å­˜è¡Œã€‚å½“ä¸€ä¸ª <code>cpu</code> è¦ä¿®æ”¹ä¸€ä¸ªç¼“å­˜è¡Œï¼Œå®ƒä¼šå°†è¿™ä¸ªç¼“å­˜è¡Œçš„å‰¯æœ¬æ”¾åˆ° <code>Store Buffer</code> ä¸­ï¼Œç„¶åå‘å‡ºä¸€ä¸ª <code>Invalidate</code> æŒ‡ä»¤ï¼Œè®©å…¶ä»– <code>cpu</code> çŸ¥é“è¿™ä¸ªç¼“å­˜è¡Œ</p>
</li>
</ol>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311292320073.webp" alt="Store Buffers"></p>
<p>åœ¨ <code>CPU</code> ä¸­å¼•å…¥<code>Store Buffers</code>çš„è®¾è®¡åï¼Œ<code>CPU0</code>ä¼šå…ˆå‘é€ä¸€ä¸ª<code>Invalidate</code>æ¶ˆæ¯ç»™å…¶ä»–åŒ…å«è¯¥ç¼“å­˜è¡Œçš„<code>CPU1</code>ï¼Œå¹¶æŠŠå½“å‰ä¿®æ”¹çš„æ•°æ®å†™å…¥<code>Store Buffers</code>ä¸­ï¼Œç„¶åç»§ç»­æ‰§è¡Œåç»­çš„æŒ‡ä»¤ã€‚ç­‰æ”¶åˆ°<code>CPU1</code>çš„<code>Acknowledgement</code>æ¶ˆæ¯åï¼Œ<code>CPU0</code>å†æŠŠ<code>Store Buffers</code>ç§»åˆ°ç¼“å­˜è¡Œä¸­, å› ä¸ºåŠ å…¥äº† <code>Store Buffers</code>ï¼Œå°±ä¼šå¯¼è‡´å†…å­˜å¯è§æ€§é—®é¢˜</p>
<h4 id="ä½¿ç”¨-Store-Forwarding-ä¼˜åŒ–-Store-Buffers-é—®é¢˜"><a href="#ä½¿ç”¨-Store-Forwarding-ä¼˜åŒ–-Store-Buffers-é—®é¢˜" class="headerlink" title="ä½¿ç”¨ Store Forwarding ä¼˜åŒ– Store Buffers é—®é¢˜"></a>ä½¿ç”¨ Store Forwarding ä¼˜åŒ– Store Buffers é—®é¢˜</h4><ol>
<li><p><code>Store Buffers</code> ä¹‹æ‰€ä»¥å­˜åœ¨é—®é¢˜æ˜¯å› ä¸ºï¼Œåœ¨ å…¶ä»– <code>cpu</code> è¿”å› <code>Acknowledgement</code> ä¹‹å‰ï¼Œæ•°æ®æ˜¯å­˜æ”¾åœ¨ <code>Store Buffer</code> ä¸­çš„ï¼Œ<code>cpu</code> ç¼“å­˜è¡Œä¸­å¹¶æ²¡æœ‰æœ€æ–°çš„æ•°æ®ï¼Œ<code>cpu</code> æ‰§è¡ŒæŒ‡ä»¤æ—¶å°±ä¼šç”¨åˆ°ç¼“å­˜è¡Œä¸­çš„æ—§æ•°æ®</p>
</li>
<li><p><code>Store Forwarding</code> æ˜¯æŒ‡æ¯ä¸ª <code>CPU</code> åœ¨åŠ è½½æ•°æ®ä¹‹å‰ï¼Œä¼šå…ˆå¼•ç”¨å½“å‰ <code>CPU</code> çš„ <code>Store Buffers</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æ”¯æŒå°† <code>CPU</code> å­˜å…¥<code>Store Buffers</code> çš„æ•°æ®ä¼ é€’ç»™åç»­çš„åŠ è½½æ“ä½œï¼Œè€Œä¸éœ€è¦ç»è¿‡ <code>Cache</code></p>
</li>
</ol>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311292327246.webp" alt="Store Forwarding"></p>
<h4 id="ä½¿ç”¨-Invalidate-Queues-ä¼˜åŒ–-Store-Buffers-é—®é¢˜"><a href="#ä½¿ç”¨-Invalidate-Queues-ä¼˜åŒ–-Store-Buffers-é—®é¢˜" class="headerlink" title="ä½¿ç”¨ Invalidate Queues ä¼˜åŒ– Store Buffers é—®é¢˜"></a>ä½¿ç”¨ Invalidate Queues ä¼˜åŒ– Store Buffers é—®é¢˜</h4><ol>
<li><p>å‰é¢è®²åˆ°çš„ <code>Store Forwarding</code> é’ˆå¯¹çš„æ—¶å‘å‡º <code>Invalidate</code> æŒ‡ä»¤çš„ <code>cpu</code>ï¼Œè€Œæ¥ä¸‹æ¥è¦è®²è§£çš„ <code>Invalidate Queues</code> åˆ™æ˜¯é’ˆå¯¹æ¥æ”¶åˆ° <code>Invalidate</code> æŒ‡ä»¤å¹¶ä¸”è¦å“åº” <code>Acknowledgement</code> æŒ‡ä»¤çš„ <code>cpu</code>ï¼Œ å…·ä½“åŸå› å¦‚ä¸‹</p>
</li>
<li><p><code>Store Buffers</code>æœ¬èº«çš„å­˜å‚¨å®¹é‡æ˜¯æœ‰é™çš„ï¼Œåœ¨å½“å‰<code>CPU</code>çš„æ‰€æœ‰å†™å…¥æ“ä½œéƒ½å­˜åœ¨ç¼“å­˜æœªå‘½ä¸­çš„æƒ…å†µæ—¶ï¼Œå°±ä¼šå¯¼è‡´<code>Store Buffers</code>å¾ˆå®¹æ˜“è¢«å¡«å……æ»¡ã€‚è¢«å¡«æ»¡ä¹‹åï¼Œå¿…é¡»è¦ç­‰åˆ°<code>CPU</code>è¿”å›<code>Invalidate Acknowledge</code>æ¶ˆæ¯ï¼Œ<code>Store Buffers</code>ä¸­å¯¹åº”çš„æŒ‡ä»¤æ‰èƒ½è¢«æ¸…ç†ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹<code>CPU</code>å¿…é¡»è¦ç­‰å¾…ï¼Œæ— è®ºè¯¥<code>CPU</code>ä¸­åç»­æŒ‡ä»¤æ˜¯å¦å­˜åœ¨ç¼“å­˜æœªå‘½ä¸­çš„æƒ…å†µ</p>
</li>
<li><p>å¦‚æœæ”¶åˆ°<code>Invalidate</code>æ¶ˆæ¯çš„<code>CPU</code>æ­¤æ—¶å¤„äºç¹å¿™çŠ¶æ€ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´<code>Invalidate Acknowledge</code>æ¶ˆæ¯è¿”å›å»¶è¿Ÿ</p>
</li>
<li><p>å¢åŠ ä¸€ä¸ª<code>Invalidate Queues</code>ï¼Œç”¨äºå­˜å‚¨è®©ç¼“å­˜è¡Œå¤±æ•ˆçš„æ¶ˆæ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>CPU</code>æ”¶åˆ°<code>Invalidate</code>æ¶ˆæ¯æ—¶ï¼ŒæŠŠè®©è¯¥ç¼“å­˜è¡Œå¤±æ•ˆçš„æ¶ˆæ¯æ”¾å…¥<code>Invalidate Queues</code>ï¼Œç„¶ååŒæ­¥è¿”å›ä¸€ä¸ª<code>Invalidate Acknowledge</code>æ¶ˆæ¯ã€‚è¿™æ ·å°±å¤§å¤§ç¼©çŸ­äº†å“åº”çš„æ—¶é—´</p>
</li>
</ol>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311292336827.webp" alt="Invalidate Queues"></p>
<h3 id="å†…å­˜å±éšœæŒ‡ä»¤"><a href="#å†…å­˜å±éšœæŒ‡ä»¤" class="headerlink" title="å†…å­˜å±éšœæŒ‡ä»¤"></a>å†…å­˜å±éšœæŒ‡ä»¤</h3><ol>
<li>è¯»å±éšœæŒ‡ä»¤(Ifence)</li>
<li>å°† <code>Invalidate Queues</code>ä¸­çš„æŒ‡ä»¤ç«‹å³å¤„ç†ï¼Œå¹¶ä¸”å¼ºåˆ¶è¯»å–<code>CPU</code>çš„ç¼“å­˜è¡Œ, æ‰§è¡Œ<code>lfence</code>æŒ‡ä»¤ä¹‹åçš„è¯»æ“ä½œä¸ä¼šè¢«é‡æ’åºåˆ°æ‰§è¡Œ<code>lfence</code>æŒ‡ä»¤ä¹‹å‰ï¼Œè¿™æ„å‘³ç€å…¶ä»–<code>CPU</code>æš´éœ²å‡ºæ¥çš„ç¼“å­˜è¡ŒçŠ¶æ€å¯¹å½“å‰<code>CPU</code>å¯è§</li>
<li>å†™å±éšœæŒ‡ä»¤(sfence)</li>
<li>å®ƒä¼šæŠŠ<code>Store Buffers</code>ä¸­çš„ä¿®æ”¹åˆ·æ–°åˆ°æœ¬åœ°ç¼“å­˜ä¸­ï¼Œä½¿å¾—å…¶ä»–<code>CPU</code>èƒ½å¤Ÿçœ‹åˆ°è¿™äº›ä¿®æ”¹ï¼Œè€Œä¸”åœ¨æ‰§è¡Œ<code>sfence</code>æŒ‡ä»¤ä¹‹åçš„å†™æ“ä½œä¸ä¼šè¢«é‡æ’åºåˆ°æ‰§è¡Œ<code>sfence</code>æŒ‡ä»¤ä¹‹å‰ï¼Œè¿™æ„å‘³ç€æ‰§è¡Œ<code>sfence</code>æŒ‡ä»¤ä¹‹å‰çš„å†™æ“ä½œä¸€å®šè¦å…¨å±€å¯è§ï¼ˆå†…å­˜å¯è§æ€§åŠç¦æ­¢é‡æ’åºï¼‰</li>
<li>è¯»å†™å±éšœæŒ‡ä»¤(mfenceï¼‰</li>
<li>ç›¸å½“äº<code>lfence</code>å’Œ<code>sfence</code>çš„æ··åˆä½“ï¼Œä¿è¯<code>mfence</code>æŒ‡ä»¤æ‰§è¡Œå‰åçš„è¯»å†™æ“ä½œçš„é¡ºåºï¼ŒåŒæ—¶è¦æ±‚æ‰§è¡Œ<code>mfence</code>æŒ‡ä»¤ä¹‹åçš„å†™æ“ä½œçš„ç»“æœå…¨å±€å¯è§ï¼Œæ‰§è¡Œ<code>mfence</code>æŒ‡ä»¤ä¹‹å‰çš„å†™æ“ä½œç»“æœå…¨å±€å¯è§</li>
</ol>
<h3 id="JVM-å†…å­˜å±éšœæŒ‡ä»¤"><a href="#JVM-å†…å­˜å±éšœæŒ‡ä»¤" class="headerlink" title="JVM å†…å­˜å±éšœæŒ‡ä»¤"></a>JVM å†…å­˜å±éšœæŒ‡ä»¤</h3><p>å‰é¢è®²åˆ°çš„å†…å­˜å±éšœæŒ‡ä»¤æ˜¯ <code>cpu</code> å¯ä»¥æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œä½†æ˜¯è¿™äº›æŒ‡ä»¤æ˜¯éœ€è¦åº”ç”¨æ¥è°ƒç”¨çš„ï¼ŒåŒæ ·çš„åº”ç”¨ä¹Ÿéœ€è¦æä¾›ç›¸åº”çš„æŒ‡ä»¤ç»™å¼€å‘è€…è°ƒç”¨ï¼Œå¯¹åº”åˆ° <code>JVM</code> ä¸­ï¼Œæä¾›äº†å¦‚ä¸‹å‡ ç§æŒ‡ä»¤</p>
<ol>
<li>loadload</li>
<li>storestore</li>
<li>loadstore</li>
<li>storeload</li>
</ol>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311292348303.webp" alt="å†…å­˜å±éšœ"></p>
]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>å¤šçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢åŒ…å«å“ªäº›å†…å®¹</title>
    <url>/2023/c51368ba5d47/index.html</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>cpu</code> ä¸çŸ¥é“ä»€ä¹ˆæ˜¯è¿›ç¨‹å’Œçº¿ç¨‹ï¼Œ<code>cpu</code> åªçŸ¥é“ä¸¤ä»¶äº‹æƒ…</p>
<ol>
<li>ä»å†…å­˜ä¸­å–å‡ºæŒ‡ä»¤</li>
<li>æ‰§è¡ŒæŒ‡ä»¤</li>
<li>ä¸€ç›´é‡å¤ä¸Šé¢ä¸¤ä¸ªæ­¥éª¤ï¼Œæ‰€ä»¥ <strong>å–æŒ‡ä»¤</strong>-&gt; <strong>æ‰§è¡ŒæŒ‡ä»¤</strong> å°±æ˜¯ <code>cpu</code> æ‰€èƒ½åšçš„æ‰€æœ‰äº‹æƒ…</li>
</ol>
<h2 id="cpu-è·å–æŒ‡ä»¤æ‰§è¡Œçš„æµç¨‹"><a href="#cpu-è·å–æŒ‡ä»¤æ‰§è¡Œçš„æµç¨‹" class="headerlink" title="cpu è·å–æŒ‡ä»¤æ‰§è¡Œçš„æµç¨‹"></a>cpu è·å–æŒ‡ä»¤æ‰§è¡Œçš„æµç¨‹</h2><ol>
<li>ç¼–å†™æºä»£ç ï¼Œæºä»£ç ä¸­éƒ½ä¼šæœ‰ main å‡½æ•°ï¼Œè¿™ä¸ª main å‡½æ•°å°±æ˜¯æ‰§è¡Œå…¥å£</li>
<li>ç¨‹åºå¯åŠ¨åï¼Œä¼šå°† main å‡½æ•°çš„ç¬¬ä¸€æ¡æœºå™¨æŒ‡ä»¤æ”¾å…¥ pc å¯„å­˜å™¨ä¸­ï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰</li>
<li>pc å¯„å­˜å™¨çš„åœ°å€é»˜è®¤æ˜¯è‡ªåŠ¨ +1ï¼Œ åˆå§‹åœ°å€å°±æ˜¯ main å‡½æ•°çš„æŒ‡ä»¤åœ°å€</li>
<li>å½“é‡åˆ° if else ç­‰è¯­å¥æ—¶ç¨‹åºä¼šæ ¹æ®è®¡ç®—ç»“æœæˆ–è€…æŒ‡ä»¤ä¸­æŒ‡å®šçš„è·³è½¬åœ°å€æ¥åŠ¨æ€æ”¹å˜ pc å¯„å­˜å™¨ä¸­çš„å€¼</li>
</ol>
<h2 id="è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«"><a href="#è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«" class="headerlink" title="è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«"></a>è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«</h2><ol>
<li>è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿåˆ†é…èµ„æºçš„æœ€å°å•ä½</li>
<li>çº¿ç¨‹æ˜¯è°ƒç”¨çš„åŸºæœ¬å•ä½ï¼Œçº¿ç¨‹ä¹‹é—´å…±äº«è¿›ç¨‹èµ„æº<ol>
<li>çº¿ç¨‹ä¹‹é—´å…±äº«äº†å“ªäº›èµ„æº<ol>
<li>å †åŒº</li>
<li>ä»£ç åŒº</li>
<li>æ•°æ®åŒºï¼šå­˜æ”¾çš„å°±æ˜¯å…¨å±€å˜é‡</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡"><a href="#ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡" class="headerlink" title="ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡"></a>ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡</h2><ol>
<li>çº¿ç¨‹ä¸Šä¸‹æ–‡å°±æ˜¯æŒ‡çº¿ç¨‹åœ¨æŸä¸ªæ—¶åˆ»çš„çŠ¶æ€ï¼Œæˆ–è€…è¯´æŸä¸ªæ—¶åˆ»çš„æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®æ˜¯çº¿ç¨‹ç§æœ‰çš„æ‰èƒ½ç§°ä¸ºæ˜¯çº¿ç¨‹çš„ä¸Šä¸‹æ–‡</li>
<li>è¦çœ‹çº¿ç¨‹ä¸Šä¸‹æ–‡åŒ…å«å“ªäº›ä¿¡æ¯ï¼Œå°±éœ€è¦çœ‹å“ªäº›æ•°æ®éƒ½æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œè¿™äº›çº¿ç¨‹ç§æœ‰çš„æ•°æ®æ•´ä½“å°±æ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡</li>
</ol>
<h3 id="çº¿ç¨‹çš„ç§æœ‰æ•°æ®æœ‰å“ªäº›"><a href="#çº¿ç¨‹çš„ç§æœ‰æ•°æ®æœ‰å“ªäº›" class="headerlink" title="çº¿ç¨‹çš„ç§æœ‰æ•°æ®æœ‰å“ªäº›"></a>çº¿ç¨‹çš„ç§æœ‰æ•°æ®æœ‰å“ªäº›</h3><p>çº¿ç¨‹æœ¬è´¨å°±æ˜¯å‡½æ•°çš„æ‰§è¡Œï¼Œå‡½æ•°æ‰§è¡Œçš„ä¿¡æ¯éƒ½æ˜¯æ”¾åœ¨æ ˆå¸§ä¸­ï¼Œæ ˆå¸§ä¸»è¦åŒ…å«å¦‚ä¸‹å†…å®¹</p>
<ol>
<li>å½“å‰å‡½æ•°çš„è¿”å›å€¼</li>
<li>è°ƒç”¨å…¶ä»–å‡½æ•°çš„å‚æ•°ï¼ˆå¯„å­˜å™¨ä¸å¤Ÿæ—¶å‚æ•°æ˜¯ä¼šæ”¾åœ¨æ ˆå¸§ä¸­çš„ï¼‰</li>
<li>å‡½æ•°ä½¿ç”¨çš„å±€éƒ¨å˜é‡</li>
<li>å‡½æ•°ä½¿ç”¨çš„å¯„å­˜å™¨ä¿¡æ¯</li>
<li>ç¨‹åºè®¡æ•°å™¨æ˜¯çº¿ç¨‹ç§æœ‰çš„</li>
<li>æ ˆæŒ‡é’ˆï¼ˆè¯¥çº¿ç¨‹æ ˆåŒºçš„æ ˆé¡¶ä½ç½®ï¼‰</li>
<li>æ‰§è¡Œå‡½æ•°æ—¶æ‰€ä½¿ç”¨çš„å¯„å­˜å™¨ä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„</li>
</ol>
<p>æ‰€æœ‰ä¸Šé¢è¿™äº›ä¿¡æ¯åŒ…å«åœ¨ä¸€èµ·å°±æ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡</p>
<h2 id="å¸¸ç”¨çš„å‡ ç§å¯„å­˜å™¨"><a href="#å¸¸ç”¨çš„å‡ ç§å¯„å­˜å™¨" class="headerlink" title="å¸¸ç”¨çš„å‡ ç§å¯„å­˜å™¨"></a>å¸¸ç”¨çš„å‡ ç§å¯„å­˜å™¨</h2><ol>
<li>æ ˆå¯„å­˜å™¨<ol>
<li>å‡½æ•°è¿è¡Œæ—¶éƒ½æœ‰ä¸€ä¸ªæ ˆå¸§ï¼Œå¯¹äºæ ˆæ¥è¯´é‡è¦çš„ä¿¡æ¯ä¹‹ä¸€å°±æ˜¯æ ˆé¡¶ï¼Œæ ˆå¯„å­˜å™¨å°±æ˜¯ä¿å­˜æ ˆé¡¶ä¿¡æ¯çš„</li>
</ol>
</li>
<li>æŒ‡ä»¤å¯„å­˜å™¨ï¼ˆpcå¯„å­˜å™¨ï¼‰</li>
<li>çŠ¶æ€å¯„å­˜å™¨ï¼Œçº¿ç¨‹æ˜¯è¿è¡Œåœ¨å†…æ ¸æ€è¿˜æ˜¯ç”¨æˆ·æ€çš„ä¿¡æ¯ä¿å­˜åœ¨çŠ¶æ€å¯„å­˜å™¨ä¸­</li>
</ol>
]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>çº¿ç¨‹æ± å®ç°åŸç†</title>
    <url>/2023/63b6d22fbd8f/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="1-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± "><a href="#1-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± " class="headerlink" title="1. ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± "></a>1. ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± </h2><ol>
<li>çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯éƒ½éœ€è¦æ¶ˆè€—èµ„æºï¼ˆcpuï¼Œå†…å­˜ï¼‰</li>
<li>ä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥é¢„å…ˆåˆ›å»ºå¥½çº¿ç¨‹ï¼Œå¼€å§‹ä½¿ç”¨æ—¶é€Ÿåº¦æ›´å¿«<span id="more"></span></li>
</ol>
<h2 id="2-çº¿ç¨‹æ± çš„è®¾è®¡æ€æƒ³"><a href="#2-çº¿ç¨‹æ± çš„è®¾è®¡æ€æƒ³" class="headerlink" title="2. çº¿ç¨‹æ± çš„è®¾è®¡æ€æƒ³"></a>2. çº¿ç¨‹æ± çš„è®¾è®¡æ€æƒ³</h2><h3 id="2-1-å¦‚ä½•åšåˆ°çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»»åŠ¡åä¸å›æ”¶"><a href="#2-1-å¦‚ä½•åšåˆ°çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»»åŠ¡åä¸å›æ”¶" class="headerlink" title="2.1. å¦‚ä½•åšåˆ°çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»»åŠ¡åä¸å›æ”¶"></a>2.1. å¦‚ä½•åšåˆ°çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»»åŠ¡åä¸å›æ”¶</h3><p>çº¿ç¨‹æ± å°±æ˜¯è¦ç¼“å­˜çº¿ç¨‹ï¼Œå½“ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åï¼Œæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹å¯ä»¥ä¸ç”¨å›æ”¶ï¼Œå½“æœ‰æ–°çš„ä»»åŠ¡æ¥åˆ°æ—¶å¤ç”¨å½“å‰çº¿ç¨‹æ¥æ‰§è¡Œï¼Œå¹³æ—¶çº¿ç¨‹æ‰§è¡Œçš„ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯å®é™…æ˜¯åº•å±‚çš„æ“ä½œç³»ç»Ÿæ¥å®ç°çš„ï¼Œå½“å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œ<code>run()</code> æ–¹æ³•å°±ä¼šæ‰§è¡Œï¼Œå½“ <code>run()</code> æ‰§è¡Œå®Œæˆä¹‹åå½“å‰çš„çº¿ç¨‹ä¼šè‡ªåŠ¨é”€æ¯<br>é‚£ä¹ˆå¦‚ä½•åšåˆ°çº¿ç¨‹ä¸è¢«é”€æ¯å‘¢ï¼Ÿå…¶å®åªè¦è®© <code>run()</code> æ–¹æ³•ä¸€ç›´åœ¨æ‰§è¡Œå°±å¥½äº†ï¼Œæ¯”å¦‚åŠ ä¸ª <code>while</code> å¾ªç¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-2-çº¿ç¨‹ç©ºé—²æ—¶ä¹Ÿæ¶ˆè€—èµ„æºæ€ä¹ˆå¤„ç†"><a href="#2-2-çº¿ç¨‹ç©ºé—²æ—¶ä¹Ÿæ¶ˆè€—èµ„æºæ€ä¹ˆå¤„ç†" class="headerlink" title="2.2. çº¿ç¨‹ç©ºé—²æ—¶ä¹Ÿæ¶ˆè€—èµ„æºæ€ä¹ˆå¤„ç†"></a>2.2. çº¿ç¨‹ç©ºé—²æ—¶ä¹Ÿæ¶ˆè€—èµ„æºæ€ä¹ˆå¤„ç†</h3><ol>
<li>ä¸ºäº†åšåˆ°å°†çº¿ç¨‹ä¸å›æ”¶ï¼Œä¸€ç›´æ‰§è¡Œï¼Œæ‰€ä»¥ä½¿ç”¨å°†ä»»åŠ¡ä»£ç æ”¾åœ¨ <code>while(true)</code> é‡Œé¢ï¼Œä½†æ˜¯è¿™æ ·åšä¼šå‡ºç°å³ä½¿æ²¡æœ‰ä»»åŠ¡æ—¶ï¼Œè¿™ä¸ªçº¿ç¨‹ä¹Ÿä¼šä¸€ç›´æ¶ˆè€— cpu èµ„æºï¼Œæ‰€ä»¥éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–</li>
<li>ä¼˜åŒ–æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æ²¡æœ‰ä»»åŠ¡æ—¶å°±é˜»å¡å½“å‰çº¿ç¨‹å°±å¥½äº†ï¼Œå½“æœ‰ä»»åŠ¡æ¥åˆ°æ—¶å†å”¤èµ·å½“å‰çº¿ç¨‹è¿›è¡Œæ‰§è¡Œ</li>
<li>æ‰€ä»¥çº¿ç¨‹æ± å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ª <code>ç”Ÿäº§è€…--æ¶ˆè´¹è€…</code> æ¨¡å‹ï¼Œæäº¤ä»»åŠ¡çš„çº¿ç¨‹å°±æ˜¯ç”Ÿäº§è€…ï¼Œçº¿ç¨‹æ± è‡ªèº«å°±æ˜¯æ¶ˆè´¹è€…ï¼Œçº¿ç¨‹æ± ä»é˜»å¡é˜Ÿåˆ—ä¸­ä¸æ–­è·å–ä»»åŠ¡ï¼Œæœ‰ä»»åŠ¡å°±æ‰§è¡Œï¼Œæ²¡æœ‰ä»»åŠ¡å°±é˜»å¡è‡ªå·±</li>
</ol>
<h2 id="3-çº¿ç¨‹æ± åˆ›å»ºæ–¹å¼"><a href="#3-çº¿ç¨‹æ± åˆ›å»ºæ–¹å¼" class="headerlink" title="3. çº¿ç¨‹æ± åˆ›å»ºæ–¹å¼"></a>3. çº¿ç¨‹æ± åˆ›å»ºæ–¹å¼</h2><h3 id="3-1-Executors-ç±»"><a href="#3-1-Executors-ç±»" class="headerlink" title="3.1. Executors ç±»"></a>3.1. Executors ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Executors</span> &#123;<br>    <span class="hljs-comment">// åˆ›å»ºå›ºå®šæ•°é‡çº¿ç¨‹çš„çº¿ç¨‹æ± </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">newFixedThreadPool</span><span class="hljs-params">(<span class="hljs-type">int</span> nThreads)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(nThreads, nThreads,<br>                                      <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,<br>                                      <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());<br>    &#125;<br><br>    <span class="hljs-comment">// åˆ›å»ºå•ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ±  </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">newSingleThreadExecutor</span><span class="hljs-params">(ThreadFactory threadFactory)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FinalizableDelegatedExecutorService</span><br>            (<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>,<br>                                    <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,<br>                                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(),<br>                                    threadFactory));<br>    &#125;<br>    â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-2-ThreadPoolExecutor"><a href="#3-2-ThreadPoolExecutor" class="headerlink" title="3.2. ThreadPoolExecutor"></a>3.2. ThreadPoolExecutor</h3><p>é€šè¿‡ä¸Šé¢ <code>Executors</code> ç±»åˆ›å»ºçš„çº¿ç¨‹æ± å¯ä»¥çœ‹åˆ°æœ€ç»ˆè¿˜æ˜¯ <code>new ThreadPoolExecutor</code>, ä½†æ˜¯ç›´æ¥ä½¿ç”¨ <code>Executors</code> åˆ›å»ºçš„çº¿ç¨‹æ± å­˜åœ¨çš„é—®é¢˜æ—¶ï¼Œè¦ä¹ˆçº¿ç¨‹æ•°é‡æ²¡æœ‰é™åˆ¶ï¼Œè¦ä¹ˆæ˜¯é˜Ÿåˆ—çš„å¤§å°æ²¡æœ‰é™åˆ¶ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹éƒ½ä¸æ¨èä½¿ç”¨ <code>Executors</code> æ¥ç›´æ¥åˆ›å»ºçº¿ç¨‹æ± ï¼Œè€Œæ˜¯æ‰‹åŠ¨é€šè¿‡ <code>ThreadPoolExecutor</code> æ¥åˆ›å»ºï¼Œ æ¯”å¦‚ä¸‹é¢è¿™ç§æ–¹å¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">threadPoolExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<br>        <span class="hljs-number">5</span>,  <span class="hljs-comment">// çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°</span><br>        <span class="hljs-number">10</span>,  <span class="hljs-comment">// çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°</span><br>        <span class="hljs-number">1000</span>,  <span class="hljs-comment">// çº¿ç¨‹æ± ä¸­è¶…è¿‡corePoolSizeæ•°ç›®çš„ç©ºé—²çº¿ç¨‹æœ€å¤§å­˜æ´»æ—¶é—´</span><br>        TimeUnit.MILLISECONDS,  <span class="hljs-comment">// æ—¶é—´å•ä½ï¼Œæ¯«ç§’</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">50</span>),  <span class="hljs-comment">// å·¥ä½œçº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—</span><br>        Executors.defaultThreadFactory(),  <span class="hljs-comment">// è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.AbortPolicy());  <span class="hljs-comment">// çº¿ç¨‹æ± æ»¡æ—¶çš„æ‹’ç»ç­–ç•¥</span><br></code></pre></td></tr></table></figure>

<h2 id="çº¿ç¨‹æ± çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#çº¿ç¨‹æ± çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="çº¿ç¨‹æ± çš„ç”Ÿå‘½å‘¨æœŸ"></a>çº¿ç¨‹æ± çš„ç”Ÿå‘½å‘¨æœŸ</h2><pre class="mermaid">flowchart LR
    A[running]-- "æ‰§è¡Œshutdown()æ–¹æ³•"--> B[Shutdown]
    A-- "æ‰§è¡ŒshutdonwNow() æ–¹æ³•"--> C[Stop]
    B--"ä»»åŠ¡åˆ—è¡¨ä¸ºç©ºï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆ"-->D[TIDYING]
    B--"shutdownNow()"-->C
    C--æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆ-->D
    D--"æ‰§è¡Œ terminated() æ–¹æ³•"-->E[TERMINATED]</pre>
<ul>
<li>RUNNINGï¼šèƒ½æ¥å—æ–°ä»»åŠ¡ï¼Œå¹¶å¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</li>
<li>SHUTDOWNï¼šä¸æ¥å—æ–°ä»»åŠ¡ï¼Œä½†æ˜¯å¯ä»¥å¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</li>
<li>STOPï¼šæ‰€æœ‰ä»»åŠ¡éƒ½ä¸å¤„ç†ï¼ˆæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹å‡†å¤‡ä¸­æ–­ï¼Œé˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸å†å¤„ç†ï¼Œæ–°çš„ä»»åŠ¡ä¸ä¼šå†æ¥æ”¶ï¼‰</li>
<li>TIDYINGï¼šæ‰€æœ‰ä»»åŠ¡éƒ½ç»ˆæ­¢ï¼Œå¹¶ä¸”å·¥ä½œçº¿ç¨‹ä¹Ÿä¸º0ï¼Œå¤„äºå…³é—­ä¹‹å‰çš„çŠ¶æ€</li>
<li>TERMINATEDï¼šå·²å…³é—­ã€‚</li>
</ul>
<h2 id="çº¿ç¨‹æ± çš„å¤„ç†æµç¨‹"><a href="#çº¿ç¨‹æ± çš„å¤„ç†æµç¨‹" class="headerlink" title="çº¿ç¨‹æ± çš„å¤„ç†æµç¨‹"></a>çº¿ç¨‹æ± çš„å¤„ç†æµç¨‹</h2><pre class="mermaid">flowchart LR
    A[æäº¤ä»»åŠ¡] --> B{æ ¸å¿ƒçº¿ç¨‹æ± æ˜¯å¦å·²æ»¡}
    B --å¦--> C[åˆ›å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡]
    B --æ˜¯--> D{é˜Ÿåˆ—æ˜¯å¦å·²æ»¡}
    D --å¦--> E[å°†ä»»åŠ¡å­˜å‚¨åœ¨é˜Ÿåˆ—ä¸­]
    D --æ˜¯--> F{æ˜¯å¦è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ± }
    F --å¦--> G[åˆ›å»ºçº¿ç¨‹æ‰§è¡Œ]
    F --æ˜¯--> J[æ‰§è¡Œæ‹’ç»ç­–ç•¥]</pre>

<h3 id="çº¿ç¨‹æ± ç›¸å…³æ ¸å¿ƒå˜é‡"><a href="#çº¿ç¨‹æ± ç›¸å…³æ ¸å¿ƒå˜é‡" class="headerlink" title="çº¿ç¨‹æ± ç›¸å…³æ ¸å¿ƒå˜é‡"></a>çº¿ç¨‹æ± ç›¸å…³æ ¸å¿ƒå˜é‡</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractExecutorService</span> &#123;<br>    <span class="hljs-comment">// ctl å˜é‡ä¿å­˜äº†ä¸¤ä¸ªä¿¡æ¯ï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€ï¼ˆé«˜3ä½ï¼‰å’Œçº¿ç¨‹æ•°é‡ï¼ˆä½29ä½ï¼‰</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">ctl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="hljs-number">0</span>));<br>    <span class="hljs-comment">// ç»Ÿè®¡çº¿ç¨‹æ•°é‡çš„ä½æ•°ï¼Œè¿™é‡Œè¡¨ç¤ºä½¿ç”¨32-3 = 29 ä½æ¥è¡¨ç¤ºçº¿ç¨‹çš„æ•°é‡</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">COUNT_BITS</span> <span class="hljs-operator">=</span> Integer.SIZE - <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">COUNT_MASK</span> <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; COUNT_BITS) - <span class="hljs-number">1</span>;<br><br>    <span class="hljs-comment">// çº¿ç¨‹æ± çš„å‡ ç§çŠ¶æ€</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">RUNNING</span>    <span class="hljs-operator">=</span> -<span class="hljs-number">1</span> &lt;&lt; COUNT_BITS;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHUTDOWN</span>   <span class="hljs-operator">=</span>  <span class="hljs-number">0</span> &lt;&lt; COUNT_BITS;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">STOP</span>       <span class="hljs-operator">=</span>  <span class="hljs-number">1</span> &lt;&lt; COUNT_BITS;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TIDYING</span>    <span class="hljs-operator">=</span>  <span class="hljs-number">2</span> &lt;&lt; COUNT_BITS;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TERMINATED</span> <span class="hljs-operator">=</span>  <span class="hljs-number">3</span> &lt;&lt; COUNT_BITS;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ä¸‹é¢é‡ç‚¹çœ‹ä¸€ä¸‹ ctl å˜é‡æ˜¯å¦‚ä½•é€šè¿‡ä¸€ä¸ªå˜é‡å­˜å‚¨ä¸¤ç§ä¿¡æ¯çš„</p>
<h3 id="çº¿ç¨‹æ•°é‡"><a href="#çº¿ç¨‹æ•°é‡" class="headerlink" title="çº¿ç¨‹æ•°é‡"></a>çº¿ç¨‹æ•°é‡</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">COUNT_BITS</span> <span class="hljs-operator">=</span> Integer.SIZE - <span class="hljs-number">3</span>;<br></code></pre></td></tr></table></figure>
<ol>
<li>å…¶ä¸­ <code>Integer.SIZE</code> &#x3D; 32, æ‰€ä»¥ <code>COUNT_BITS</code> å°±æ˜¯29ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ 29 ä½æ¥è¡¨ç¤ºçº¿ç¨‹çš„æ•°é‡<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">COUNT_MASK</span> <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; COUNT_BITS) - <span class="hljs-number">1</span>;<br><br>     <span class="hljs-number">1</span> &lt;&lt; COUNT_BITS<br>      â€‹<br>      <span class="hljs-number">1</span>çš„<span class="hljs-number">32</span>ä½<span class="hljs-number">2</span>è¿›åˆ¶æ˜¯<br>      <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0001</span><br>      â€‹<br>      å·¦ç§»<span class="hljs-number">29</span>ä½<br>      <span class="hljs-number">0010</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br>      â€‹<br>      å†è¿›è¡Œå‡ä¸€<br>      <span class="hljs-number">000</span> <span class="hljs-number">11111</span> <span class="hljs-number">1111</span> <span class="hljs-number">1111</span> <span class="hljs-number">1111</span> <span class="hljs-number">1111</span> <span class="hljs-number">1111</span> <span class="hljs-number">1111</span><br>      â€‹<br>      æ‰€ä»¥çº¿ç¨‹æ± æœ€å¤§æ•°ç›®å°±æ˜¯<br>      <span class="hljs-number">000</span> <span class="hljs-number">11111</span> <span class="hljs-number">11111111</span> <span class="hljs-number">11111111</span> <span class="hljs-number">11111111</span><br></code></pre></td></tr></table></figure></li>
<li>é‚£æ€ä¹ˆé€šè¿‡è¿™ 29 ä½æ¥è·å–çº¿ç¨‹çš„æ•°é‡å‘¢ï¼Œé€šè¿‡ <code>workderCountOf(int c)</code> æ–¹æ³•å¯ä»¥çœ‹åˆ°å®é™…æ˜¯é€šè¿‡ä½è¿ç®—ä¸­çš„ <code>ä¸</code> æ“ä½œæ¥å»é™¤æœ€é«˜ä½æ¥è¿›è¡Œè·å–çš„</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">workerCountOf</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span>  &#123; <br>    <span class="hljs-keyword">return</span> c &amp; COUNT_MASK; <br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="çº¿ç¨‹æ± çš„çŠ¶æ€"><a href="#çº¿ç¨‹æ± çš„çŠ¶æ€" class="headerlink" title="çº¿ç¨‹æ± çš„çŠ¶æ€"></a>çº¿ç¨‹æ± çš„çŠ¶æ€</h3><p>è·å–çº¿ç¨‹æ± çŠ¶æ€çš„æ–¹æ³•æ˜¯ <code>runStateOf()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">runStateOf</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span>     &#123;<br>     <span class="hljs-keyword">return</span> c &amp; ~COUNT_MASK; <br>&#125;<br></code></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°åˆ†æˆäº†ä¸¤æ­¥</p>
<ol>
<li>å¯¹ <code>COUNT_MASK</code> å–åï¼Œå‰é¢å·²ç»çŸ¥é“ <code>COUNT_MASK</code> å‰é¢ä¸‰ä½æ˜¯0ï¼Œæœ€å29ä½æ˜¯1ï¼Œ å–ååˆ™æ˜¯å‰é¢ä¸‰ä½æ˜¯1ï¼Œæœ€å29ä½æ˜¯0</li>
<li><code>ä¸</code> æ“ä½œå’Œè®¡ç®—çº¿ç¨‹æ•°é‡æ—¶æ˜¯ä¸€æ ·çš„ï¼Œæ˜¯ä¸ºäº†å»é™¤åé¢29ä½æ•°ï¼Œåªéœ€è¦è®¡ç®—å‰é¢ä¸‰ä½çš„æ•°å³å¯</li>
</ol>
<h2 id="çº¿ç¨‹æ± æ ¸å¿ƒé—®é¢˜"><a href="#çº¿ç¨‹æ± æ ¸å¿ƒé—®é¢˜" class="headerlink" title="çº¿ç¨‹æ± æ ¸å¿ƒé—®é¢˜"></a>çº¿ç¨‹æ± æ ¸å¿ƒé—®é¢˜</h2><h3 id="çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹ä»€ä¹ˆæ—¶å€™åˆ›å»º"><a href="#çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹ä»€ä¹ˆæ—¶å€™åˆ›å»º" class="headerlink" title="çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹ä»€ä¹ˆæ—¶å€™åˆ›å»º"></a>çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹ä»€ä¹ˆæ—¶å€™åˆ›å»º</h3><ol>
<li>é»˜è®¤æƒ…å†µä¸‹ä¸ä¼šé¢„å…ˆåˆ›å»ºçº¿ç¨‹ï¼Œæ‰€ä»¥æ ¸å¿ƒçº¿ç¨‹ä¹Ÿæ˜¯åœ¨æœ‰ä»»åŠ¡æ¥çš„æ—¶å€™æ‰ä¼šåˆ›å»º</li>
<li>åœ¨ <code>ThreadPoolExecutor</code> ç±»ä¸­æä¾›äº†ä¸¤ä¸ªæ–¹æ³•</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractExecutorService</span> &#123;<br>    <span class="hljs-comment">// é¢„å…ˆå¯åŠ¨ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">prestartCoreThread</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> workerCountOf(ctl.get()) &lt; corePoolSize &amp;&amp;<br>            addWorker(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// é¢„å…ˆå¯åŠ¨æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">prestartAllCoreThreads</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (addWorker(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>))<br>            ++n;<br>        <span class="hljs-keyword">return</span> n;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•å¯çŸ¥ï¼Œåœ¨åˆ›å»ºçº¿ç¨‹æ± ä¹‹åï¼ˆæäº¤ä»»åŠ¡ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ execute ä¹‹å‰ï¼‰æ˜¯å¯ä»¥è°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•æ¥é¢„å…ˆåˆ›å»ºæ ¸å¿ƒçº¿ç¨‹çš„</p>
<h3 id="çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦ä¼šè¢«å›æ”¶"><a href="#çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦ä¼šè¢«å›æ”¶" class="headerlink" title="çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦ä¼šè¢«å›æ”¶"></a>çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦ä¼šè¢«å›æ”¶</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractExecutorService</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">allowCoreThreadTimeOut</span><span class="hljs-params">(<span class="hljs-type">boolean</span> value)</span> &#123;<br>        <span class="hljs-keyword">if</span> (value &amp;&amp; keepAliveTime &lt;= <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Core threads must have nonzero keep alive times&quot;</span>);<br>        <span class="hljs-keyword">if</span> (value != allowCoreThreadTimeOut) &#123;<br>            allowCoreThreadTimeOut = value;<br>            <span class="hljs-keyword">if</span> (value)<br>                interruptIdleWorkers();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>åœ¨ <code>ThreadPoolExecutor</code> ç±»ä¸­æœ‰æä¾› <code>allowCoreThreadTimeOut(boolean)</code> æ–¹æ³•æ¥è®¾ç½®å½“è¾¾åˆ°è¶…æ—¶æ—¶é—´æ—¶ï¼Œæ ¸å¿ƒçº¿ç¨‹ä¹Ÿå¯ä»¥è¢«å›æ”¶æ‰</p>
<h3 id="æ ¸å¿ƒçº¿ç¨‹æ•°é‡å’Œæœ€å¤§å…ˆåƒæ•°é‡åŠ¨æ€ä¿®æ”¹"><a href="#æ ¸å¿ƒçº¿ç¨‹æ•°é‡å’Œæœ€å¤§å…ˆåƒæ•°é‡åŠ¨æ€ä¿®æ”¹" class="headerlink" title="æ ¸å¿ƒçº¿ç¨‹æ•°é‡å’Œæœ€å¤§å…ˆåƒæ•°é‡åŠ¨æ€ä¿®æ”¹"></a>æ ¸å¿ƒçº¿ç¨‹æ•°é‡å’Œæœ€å¤§å…ˆåƒæ•°é‡åŠ¨æ€ä¿®æ”¹</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åŠ¨æ€ä¿®æ”¹æ ¸å¿ƒçº¿ç¨‹æ•°é‡</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCorePoolSize</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize)</span> &#123;<br>    â€¦â€¦<br>&#125;<br><br><span class="hljs-comment">// åŠ¨æ€ä¿®æ”¹æœ€å¤§çº¿ç¨‹æ•°é‡</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMaximumPoolSize</span><span class="hljs-params">(<span class="hljs-type">int</span> maximumPoolSize)</span> &#123;<br>    â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ä¸Šé¢æœ‰å†™åˆ°å¯ä»¥åŠ¨æ€ä¿®æ”¹çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹å’Œæœ€å¤§çº¿ç¨‹æ•°é‡ï¼Œé‚£ä¹ˆè¿™ä¹ˆè®¾è®¡çš„åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¯´åˆ°è¿™ä¸ªé—®é¢˜å°±ç‰µæ‰¯åˆ°å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•åˆç†è®¾ç½®çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡å¤§å°ï¼Ÿå¯¹äºçº¿ç¨‹æ± æ•°é‡å¤§å°çš„è®¾ç½®é—®é¢˜æœ‰å¤šç§å»ºè®®ï¼Œæ¯”å¦‚</p>
<ol>
<li>CPUå¯†é›†å‹ï¼Œçº¿ç¨‹æ± å¤§å°è®¾ç½®ä¸ºN+1ï¼Œ IOå¯†é›†å‹ï¼Œçº¿ç¨‹æ± å¤§å°è®¾ç½®ä¸º2N+1ï¼ˆNæŒ‡çš„æ˜¯cpuæ ¸å¿ƒæ•°ï¼‰</li>
<li>çº¿ç¨‹æ•°&#x3D;CPUæ ¸æ•° *ï¼ˆ1+çº¿ç¨‹ç­‰å¾…æ—¶é—´ &#x2F; çº¿ç¨‹æ—¶é—´è¿è¡Œæ—¶é—´ï¼‰</li>
</ol>
<p>å¯¹äºæ–¹å¼2æ˜¯ç»“åˆäº†å®é™…çš„ä¸šåŠ¡ï¼Œä½†æ˜¯çº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼Œçº¿ç¨‹è¿è¡Œæ—¶é—´éƒ½æ˜¯éœ€è¦ <code>ç›‘æ§</code> çº¿ç¨‹ç¯å¢ƒæ‰å¯ä»¥å¾—çŸ¥çš„ï¼Œæ—¢ç„¶æ¶‰åŠåˆ° <code>ç›‘æ§</code> å°±è¯´æ˜è¿™ä¸ªå€¼æ˜¯éœ€è¦åŠ¨æ€å»ä¿®æ”¹çš„ï¼Œæ‰€ä»¥æ‰ä¼šéœ€è¦æä¾›è¿™æ ·ä¸¤ä¸ªä¿®æ”¹çº¿ç¨‹æ•°é‡çš„æ–¹æ³•</p>
<h3 id="ç›¸åŒçš„ä»»åŠ¡å¦‚ä½•èˆå¼ƒ"><a href="#ç›¸åŒçš„ä»»åŠ¡å¦‚ä½•èˆå¼ƒ" class="headerlink" title="ç›¸åŒçš„ä»»åŠ¡å¦‚ä½•èˆå¼ƒ"></a>ç›¸åŒçš„ä»»åŠ¡å¦‚ä½•èˆå¼ƒ</h3><ol>
<li>åœ¨æŸäº›åœºæ™¯ä¸‹ä¼šæœ‰ä»»åŠ¡ä¸æ–­çš„å¾€çº¿ç¨‹æ± ä¸­æ·»åŠ ï¼Œä½†æ˜¯å¯¹äºæ·»åŠ çš„ç›¸åŒçš„ä»»åŠ¡å¦‚æœä¹‹å‰è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæˆï¼Œåç»­æ·»åŠ çš„ä»»åŠ¡å¯ä»¥ç›´æ¥èˆå¼ƒï¼Œè¿™é‡Œæ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹æ˜¯ <code>é˜Ÿåˆ—</code> å’Œ <code>å¯¹è±¡ç›¸ç­‰çš„åˆ¤æ–­</code></li>
<li>å¦‚æœæ¯æ¬¡æ·»åŠ æ–°ä»»åŠ¡ä¹‹å‰æ—§çš„ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæˆï¼Œå°±ä¸å­˜åœ¨ç›¸åŒçš„ä»»åŠ¡èˆå¼ƒè¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œçš„åœºæ™¯æ˜¯æäº¤çš„ä»»åŠ¡å¤ªå¤šï¼Œçº¿ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œæˆçš„ä»»åŠ¡ä¿ç•™åœ¨é˜Ÿåˆ—ä¸­</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTask</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span>&#123;<br>    <span class="hljs-keyword">private</span> String account;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        doSomething();<br>    &#125;<br><br>    <span class="hljs-comment">// é‡å†™ equals æ–¹æ³•ï¼Œè¿™ä¸ªå°±æ˜¯åˆ¤æ–­ä»»åŠ¡ç›¸åŒçš„å…³é”®</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> == o) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span> || getClass() != o.getClass()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-type">MyTask</span> <span class="hljs-variable">that</span> <span class="hljs-operator">=</span> (MyTask) o;<br>        <span class="hljs-comment">// è¿™é‡Œæ˜¯ç”¨è´¦å·æ¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦ç›¸åŒ</span><br>        <span class="hljs-keyword">return</span> account.equals(that.account);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ol start="3">
<li>æäº¤ä»»åŠ¡ä¹‹å‰å…ˆè·å–é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œçœ‹æ˜¯å¦æœ‰æ­£åœ¨æ’é˜Ÿçš„ç›¸åŒè´¦å·çš„ä»»åŠ¡</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è·å–é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</span><br>BlockingQueue&lt;Runnable&gt; queue = threadPoolExecutor.getQueue();<br><span class="hljs-comment">// æ„å»ºå½“å‰ä»»åŠ¡</span><br><span class="hljs-type">MyTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTask</span>(<span class="hljs-string">&quot;currentTaskAccount&quot;</span>);<br><span class="hljs-keyword">if</span> (queue.size() &gt; <span class="hljs-number">0</span> &amp;&amp; queue.contains(authSymbolTask)) &#123;<br>    logger.info(<span class="hljs-string">&quot;é˜Ÿåˆ—ä¸­å«æœ‰:&#123;&#125;çš„ä»»åŠ¡,å½“å‰ä»»åŠ¡è¢«ä¸¢å¼ƒ&quot;</span>, task.getAccount());<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// é˜Ÿåˆ—ä¸­ä¸åŒ…å«å½“å‰è´¦å·çš„ä»»åŠ¡å°±æäº¤å½“å‰ä»»åŠ¡</span><br>    threadPoolExecutor.execute(task);<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹"><a href="#çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹" class="headerlink" title="çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹"></a>çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹</h3><p>ä¸‹é¢ä»£ç æ˜¯ <code>ThreadPoolExecutor</code> ç±»</p>
<figure class="highlight java"><figcaption><span>executeæ–¹æ³•</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Runnable command)</span> &#123;<br>    <span class="hljs-keyword">if</span> (command == <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> ctl.get();<br>    <span class="hljs-comment">// çº¿ç¨‹æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹æ•°</span><br>    <span class="hljs-keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;<br>        <span class="hljs-comment">// 1. åˆ›å»ºçº¿ç¨‹çš„æ ¸å¿ƒæ–¹æ³•</span><br>        <span class="hljs-keyword">if</span> (addWorker(command, <span class="hljs-literal">true</span>))<br>            <span class="hljs-keyword">return</span>;<br>        c = ctl.get();<br>    &#125;<br>    <span class="hljs-comment">// çº¿ç¨‹æ•°é‡å¤§äºæ ¸å¿ƒæ•°é‡ï¼Œåˆ™å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­</span><br>    <span class="hljs-keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">recheck</span> <span class="hljs-operator">=</span> ctl.get();<br>        <span class="hljs-comment">// å†æ¬¡æ£€æŸ¥å¦‚æœçº¿ç¨‹æ± ä¸æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œåˆ™å°†æ·»åŠ åˆ°é˜Ÿåˆ—çš„ä»»åŠ¡ç§»é™¤æ‰ï¼Œå¹¶ä¸”æ‰§è¡Œæ‹’ç»ç­–ç•¥</span><br>        <span class="hljs-keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))<br>            reject(command);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (workerCountOf(recheck) == <span class="hljs-number">0</span>)<br>            addWorker(<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!addWorker(command, <span class="hljs-literal">false</span>))<br>        reject(command);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ·»åŠ çº¿ç¨‹è¿›è¡Œæ‰§è¡Œä¸»è¦æ˜¯åœ¨ <code>addWorker()</code> æ–¹æ³•ä¸­ï¼Œæ‰€ä»¥ç»§ç»­çœ‹ <code>addWorkder()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">addWorker</span><span class="hljs-params">(Runnable firstTask, <span class="hljs-type">boolean</span> core)</span> &#123;<br>    retry:<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> ctl.get();;) &#123;<br>        <span class="hljs-comment">// çº¿ç¨‹æ± æ­£åœ¨å…³é—­æˆ–å·²ç»å…³é—­æ—¶å°±ä¸è¿è¡Œæ·»åŠ æ–°ä»»åŠ¡</span><br>        <span class="hljs-keyword">if</span> (runStateAtLeast(c, SHUTDOWN)<br>            &amp;&amp; (runStateAtLeast(c, STOP)<br>                || firstTask != <span class="hljs-literal">null</span><br>                || workQueue.isEmpty()))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">for</span> (;;) &#123;<br>            <span class="hljs-keyword">if</span> (workerCountOf(c)<br>                &gt;= ((core ? corePoolSize : maximumPoolSize) &amp; COUNT_MASK))<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">if</span> (compareAndIncrementWorkerCount(c))<br>                <span class="hljs-keyword">break</span> retry;<br>            c = ctl.get();  <span class="hljs-comment">// Re-read ctl</span><br>            <span class="hljs-keyword">if</span> (runStateAtLeast(c, SHUTDOWN))<br>                <span class="hljs-keyword">continue</span> retry;<br>            <span class="hljs-comment">// else CAS failed due to workerCount change; retry inner loop</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">workerStarted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">workerAdded</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">Worker</span> <span class="hljs-variable">w</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// workerç±»åŒ…å«Thread å’Œ Runnable Task</span><br>        w = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(firstTask);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> w.thread;<br>        <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">mainLock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.mainLock;<br>            mainLock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> ctl.get();<br>                <span class="hljs-comment">// çº¿ç¨‹æ± è¿˜åœ¨è¿è¡ŒçŠ¶æ€</span><br>                <span class="hljs-keyword">if</span> (isRunning(c) ||<br>                    (runStateLessThan(c, STOP) &amp;&amp; firstTask == <span class="hljs-literal">null</span>)) &#123;<br>                    <span class="hljs-keyword">if</span> (t.getState() != Thread.State.NEW)<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalThreadStateException</span>();<br>                    workers.add(w);<br>                    workerAdded = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> workers.size();<br>                    <span class="hljs-keyword">if</span> (s &gt; largestPoolSize)<br>                        largestPoolSize = s;<br>                &#125;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                mainLock.unlock();<br>            &#125;<br>            <span class="hljs-keyword">if</span> (workerAdded) &#123;<br>                <span class="hljs-comment">// æ·»åŠ æˆåŠŸå°±å¯åŠ¨çº¿ç¨‹å¼€å§‹æ‰§è¡Œ</span><br>                t.start();<br>                workerStarted = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (! workerStarted)<br>            addWorkerFailed(w);<br>    &#125;<br>    <span class="hljs-keyword">return</span> workerStarted;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>Worker ç±»ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">Worker(Runnable firstTask) &#123;<br>    setState(-<span class="hljs-number">1</span>); <span class="hljs-comment">// inhibit interrupts until runWorker</span><br>    <span class="hljs-built_in">this</span>.firstTask = firstTask;<br>    <span class="hljs-built_in">this</span>.thread = getThreadFactory().newThread(<span class="hljs-built_in">this</span>);<br>&#125;<br><br><span class="hljs-comment">/** Delegates main run loop to outer runWorker. */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    runWorker(<span class="hljs-built_in">this</span>);<br>&#125;<br><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runWorker</span><span class="hljs-params">(Worker w)</span> &#123;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">wt</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>    <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> w.firstTask;<br>    w.firstTask = <span class="hljs-literal">null</span>;<br>    w.unlock(); <span class="hljs-comment">// allow interrupts</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">completedAbruptly</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// å¦‚ä½•ä¿è¯çº¿ç¨‹ä¸ä¼šè¢«å›æ”¶å‘¢ï¼Ÿå°±æ˜¯é€šè¿‡ä¸€ä¸ª while å¾ªç¯ï¼Œä¸è®©çº¿ç¨‹é€€å‡º run æ–¹æ³•</span><br>        <span class="hljs-comment">// å¦‚ä½•ä¿è¯çº¿ç¨‹åœ¨ç©ºé—²æ—¶ä¸å ç”¨cpuå‘¢ï¼Œå®ç°é€»è¾‘å°±æ˜¯åœ¨ getTask() æ–¹æ³•é‡Œé¢ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ä»»åŠ¡å°±é˜»å¡å½“å‰çº¿ç¨‹</span><br>        <span class="hljs-comment">// å¦‚ä½•å®ç°çº¿ç¨‹çš„å›æ”¶å‘¢ï¼Ÿè¿™ä¸ªå…³é”®ç‚¹å°±æ˜¯ while æ¡ä»¶çš„åˆ¤æ–­ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶å°±ä¼šé€€å‡º while å¾ªç¯ï¼Œå½“å‰çº¿ç¨‹æ‰§è¡Œå®Œäº†ï¼Œçº¿ç¨‹å°±ä¼šè¢«jvmå›æ”¶æ‰</span><br>        <span class="hljs-keyword">while</span> (task != <span class="hljs-literal">null</span> || (task = getTask()) != <span class="hljs-literal">null</span>) &#123;<br>            w.lock();<br>            <span class="hljs-keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||<br>                    (Thread.interrupted() &amp;&amp;<br>                    runStateAtLeast(ctl.get(), STOP))) &amp;&amp;<br>                !wt.isInterrupted())<br>                wt.interrupt();<br>            <span class="hljs-keyword">try</span> &#123;<br>                beforeExecute(wt, task);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    task.run();<br>                    afterExecute(task, <span class="hljs-literal">null</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>                    afterExecute(task, ex);<br>                    <span class="hljs-keyword">throw</span> ex;<br>                &#125;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                task = <span class="hljs-literal">null</span>;<br>                w.completedTasks++;<br>                w.unlock();<br>            &#125;<br>        &#125;<br>        completedAbruptly = <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-comment">// çº¿ç¨‹æ± ä¸­çº¿ç¨‹è¢«å›æ”¶çš„é€»è¾‘</span><br>        processWorkerExit(w, completedAbruptly);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«å›æ”¶çš„"><a href="#çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«å›æ”¶çš„" class="headerlink" title="çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«å›æ”¶çš„"></a>çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«å›æ”¶çš„</h3><pre class="mermaid">sequenceDiagram
    participant A as ThreadPoolExecutor[A]
    participant B as ThreadPoolExecutor[B]
    participant C as Worker[C]
    participant D as Worker[D]
    participant E as Worker[E]
    A->>B: execute()
    B->>C: addWorker(Runnable firstTask, boolean core)
    Note over B,C: Workerç±»åŒ…å«Threadå’ŒTask
    C->>D: runWorker(Worker)
    Note over C,D: runWorker()ä¸­æœ‰whileï¼Œä¿è¯çº¿ç¨‹çš„å¤ç”¨
    D->>E: getTask()
    Note over D,E: è·å–ä¸åˆ°ä»»åŠ¡ä¼šé˜»å¡</pre>
<p>åœ¨ä¸Šé¢æ—¶åºå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ <code>Worker.runWorker()</code>  æ–¹æ³•ä¸­ä¼šä¸æ–­çš„å¾ªç¯ï¼Œä¿è¯çº¿ç¨‹å¯ä»¥å¤ç”¨ï¼ŒåŒæ—¶åœ¨ <code>getTask()</code> ä¸­åšæ˜¯å¦è¦é€€å‡ºå¾ªç¯çš„æ¡ä»¶çš„åˆ¤æ–­</p>
<ol>
<li>é˜»å¡é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡äº†</li>
<li>å·²ç»è¶…è¿‡äº†è®¾ç½®çš„ç©ºé—²æ—¶é—´</li>
</ol>
<p>è¿™æ ·å°±å¯ä»¥é€€å‡ºè®© Thread çš„run æ–¹æ³•æµç¨‹èµ°å®Œï¼Œé€€å‡º run æ–¹æ³•ä¹‹åç›¸å½“äºè¿™ä¸ªçº¿ç¨‹å°±è¢«å›æ”¶äº†</p>
]]></content>
      <categories>
        <category>java</category>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu23.04ä¸­è®¾ç½®å…¶ä»–ç”¨æˆ·ä½¿ç”¨sudoæ— éœ€è¾“å…¥å¯†ç </title>
    <url>/2023/a60a9dfd0dd7/index.html</url>
    <content><![CDATA[<p>ç»™ <code>/etc/sudoers</code> æ·»åŠ å†™å…¥æƒé™</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sudo <span class="hljs-built_in">chmod</span> +w /etc/sudoers<br></code></pre></td></tr></table></figure>

<p>æ·»åŠ ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sudo vim /etc/sudoers<br><span class="hljs-comment"># Allow members of group sudo to execute any command, è¿™é‡Œçš„lgå°±æ˜¯å½“å‰éœ€è¦å…è¾“å…¥å¯†ç çš„ç”¨æˆ·</span><br>%lg ALL=(ALL:ALL) NOPASSWD:ALL<br></code></pre></td></tr></table></figure>

<p>å»é™¤å†™å…¥æƒé™</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sudo <span class="hljs-built_in">chmod</span> -w /etc/sudoers<br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu23.04å®‰è£…jdkå’Œmaven</title>
    <url>/2023/e6e83576f25e/index.html</url>
    <content><![CDATA[<h2 id="å®‰è£…-jdk17"><a href="#å®‰è£…-jdk17" class="headerlink" title="å®‰è£… jdk17"></a>å®‰è£… jdk17</h2><p><a href="http://www.codebaoku.com/jdk/jdk-index.html">jdké•œåƒä¸‹è½½åœ°å€</a></p>
<ul>
<li>ä¸‹è½½ <code>jdk-17.0.7_linux-x64_bin.tar.gz</code></li>
<li>å°†åŒ…ä¸Šä¼ åˆ° <code>Ubuntu</code> ä¸­ï¼Œæ¯”å¦‚è¿™é‡Œä¸Šä¼ åˆ°äº† <code>/opt/software</code> ç›®å½•ä¸‹<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /opt/software<br>tar -zxvf jdk-17.0.7_linux-x64_bin.tar.gz<br>sudo vim /etc/profile<br></code></pre></td></tr></table></figure>
ç„¶åå°†ä¸‹é¢å†…å®¹å¤åˆ¶åˆ° <code>/etc/profile</code> ä¸­<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># /opt/software/jdk-17.0.7 å°±æ˜¯ä¸Šé¢è§£å‹çš„ jdk ç›®å½•</span><br><span class="hljs-built_in">export</span> JAVA_HOME=/opt/software/jdk-17.0.7<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> CLASSPATH=.:<span class="hljs-variable">$JAVA_HOME</span>/lib/dt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar<br></code></pre></td></tr></table></figure>
ä¿å­˜é€€å‡ºï¼Œæ‰§è¡Œ <code>source /etc/profile</code> </li>
<li>éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">java -version<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="å®‰è£…-maven"><a href="#å®‰è£…-maven" class="headerlink" title="å®‰è£… maven"></a>å®‰è£… maven</h2><p><a href="https://mirrors.aliyun.com/apache/maven/">é˜¿é‡Œäº‘mavneé•œåƒç«™</a><br><a href="https://maven.apache.org/download.cgi">mavenå®˜ç½‘ä¸‹è½½</a></p>
<ul>
<li>ä¸‹è½½ <code>apache-maven-3.9.6-bin.tar.gz</code></li>
<li>ä¸Šä¼ åˆ° <code>Ubuntu</code> ä¸­ï¼Œè¿™é‡Œæ˜¯ä¸Šä¼ åˆ° <code>/opt/software</code> ç›®å½•ä¸‹<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /opt/software<br>tar -zxvf apache-maven-3.9.6-bin.tar.gz<br>sudo vim /etc/profile<br></code></pre></td></tr></table></figure>
ç„¶åå°†ä¸‹é¢å†…å®¹å¤åˆ¶åˆ° <code>/etc/profile</code> æœ«å°¾<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> MAVEN_HOME=/opt/software/apache-maven-3.9.6<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$MAVEN_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br></code></pre></td></tr></table></figure>
éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">mvn -v<br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntuä¸­è®¾ç½®ç¯å¢ƒå˜é‡çš„å‡ ç§æ–¹å¼</title>
    <url>/2023/1f7648c2ff11/index.html</url>
    <content><![CDATA[<h2 id="å½“å‰ç»ˆç«¯æœ‰æ•ˆ"><a href="#å½“å‰ç»ˆç«¯æœ‰æ•ˆ" class="headerlink" title="å½“å‰ç»ˆç«¯æœ‰æ•ˆ"></a>å½“å‰ç»ˆç«¯æœ‰æ•ˆ</h2> <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#  ç›´æ¥åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œï¼Œåˆ™å¯ä»¥åœ¨å½“å‰ç»ˆç«¯çš„ä»»æ„ç›®å½•ä½¿ç”¨ mysql å‘½ä»¤</span><br><span class="hljs-built_in">export</span> PATH=/opt/mysql/bin:PATH<br></code></pre></td></tr></table></figure>

<h2 id="å½“å‰ç”¨æˆ·æœ‰æ•ˆ"><a href="#å½“å‰ç”¨æˆ·æœ‰æ•ˆ" class="headerlink" title="å½“å‰ç”¨æˆ·æœ‰æ•ˆ"></a>å½“å‰ç”¨æˆ·æœ‰æ•ˆ</h2><h3 id="ä¿®æ”¹-bashrc-æ–‡ä»¶"><a href="#ä¿®æ”¹-bashrc-æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ ~/.bashrc æ–‡ä»¶"></a>ä¿®æ”¹ <code>~/.bashrc</code> æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">vim ~/.bashrc<br><span class="hljs-built_in">export</span> PATH=/opt/mysql/bin:PATH<br><br><span class="hljs-comment"># ä¿å­˜é€€å‡ºåï¼Œæ‰§è¡Œ source ~/.bashrc å‘½ä»¤ä½¿å…¶ç«‹å³ç”Ÿæ•ˆ</span><br><span class="hljs-built_in">source</span> ~/.bashrc<br></code></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹å¼æ°¸ä¹…ç”Ÿæ•ˆ</p>
<h2 id="ç³»ç»Ÿçº§åˆ«æœ‰æ•ˆ"><a href="#ç³»ç»Ÿçº§åˆ«æœ‰æ•ˆ" class="headerlink" title="ç³»ç»Ÿçº§åˆ«æœ‰æ•ˆ"></a>ç³»ç»Ÿçº§åˆ«æœ‰æ•ˆ</h2><h3 id="ä¿®æ”¹-etc-profile-æ–‡ä»¶"><a href="#ä¿®æ”¹-etc-profile-æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ /etc/profile æ–‡ä»¶"></a>ä¿®æ”¹ <code>/etc/profile</code> æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">vim /etc/profile<br><span class="hljs-built_in">export</span> PATH=/opt/mysql/bin:PATH<br><br><span class="hljs-comment"># ä¿å­˜é€€å‡ºåï¼Œæ‰§è¡Œ source /etc/profile å‘½ä»¤ä½¿å…¶ç«‹å³ç”Ÿæ•ˆ</span><br><span class="hljs-built_in">source</span> /etc/profile<br></code></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹å¼æ°¸ä¹…ç”Ÿæ•ˆï¼Œå¹¶ä¸”å¯¹æ‰€æœ‰ç”¨æˆ·æœ‰æ•ˆ</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>vmwareä¸­Ubuntu23.04è®¾ç½®é™æ€ip</title>
    <url>/2023/928cb00f8073/index.html</url>
    <content><![CDATA[<h2 id="æŸ¥çœ‹ç½‘å¡åç§°"><a href="#æŸ¥çœ‹ç½‘å¡åç§°" class="headerlink" title="æŸ¥çœ‹ç½‘å¡åç§°"></a>æŸ¥çœ‹ç½‘å¡åç§°</h2><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ip a<br></code></pre></td></tr></table></figure>
<p>æ¯”å¦‚æŸ¥è¯¢çš„ç»“æœæ˜¯ <code>ens33</code></p>
<h2 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h2><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">lg@lg:~$ <span class="hljs-built_in">cd</span> /etc/netplan/<br>lg@lg:/etc/netplan$ ll<br>total 12<br>drwxr-xr-x  2 root root 4096 Dec 13 15:56 ./<br>drwxr-xr-x 98 root root 4096 Dec 13 15:32 ../<br>-rw-r--r--  1 root root  301 Dec 13 15:56 00-installer-config.yaml<br></code></pre></td></tr></table></figure>
<p>åœ¨ <code>/etc/netplan</code> ç›®å½•ä¸‹ï¼Œçœ‹åˆ°æœ‰ä¸€ä¸ª <code>00-installer-config.yaml</code> æ–‡ä»¶ï¼Œé…ç½®é™æ€ <code>ip</code> å°±æ˜¯è¦ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶</p>
<p>åˆ é™¤è¿™ä¸ªæ–‡ä»¶å†…å®¹ï¼Œç„¶åå°†ä¸‹é¢å†…å®¹å¤åˆ¶åˆ°æ–‡ä»¶ä¸­, éœ€è¦</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">network:</span><br>  <span class="hljs-attr">ethernets:</span><br>    <span class="hljs-comment"># è¿™é‡Œçš„ ens33 æ˜¯ç½‘å¡åç§°ï¼Œå°±æ˜¯ç¬¬ä¸€æ­¥ä¸­ä½¿ç”¨ ip a æŸ¥çœ‹çš„ç»“æœ</span><br>    <span class="hljs-attr">ens33:</span><br>      <span class="hljs-attr">dhcp4:</span> <span class="hljs-literal">no</span><br>      <span class="hljs-attr">dhcp6:</span> <span class="hljs-literal">no</span><br>      <span class="hljs-attr">addresses:</span><br>        <span class="hljs-comment"># è¿™é‡Œçš„ 192.168.119.129 æ˜¯é™æ€ ip åœ°å€ï¼Œå¯¹åº”çš„ç½‘æ®µæ˜¯æ ¹æ®ç½‘å…³æ¥è®¾ç½®çš„ï¼Œç½‘å…³åœ°å€æ˜¯åœ¨ vmwareä¸­æŸ¥çœ‹</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.119</span><span class="hljs-number">.129</span><span class="hljs-string">/24</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">to:</span> <span class="hljs-string">default</span><br>          <span class="hljs-comment"># è¿™ä¸ªæ˜¯ç½‘å…³çš„åœ°å€ï¼Œéœ€è¦åˆ° vmware ä¸­å»æŸ¥çœ‹</span><br>          <span class="hljs-attr">via:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.119</span><span class="hljs-number">.2</span><br>      <span class="hljs-attr">nameservers:</span><br>        <span class="hljs-attr">addresses:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-number">180.76</span><span class="hljs-number">.76</span><span class="hljs-number">.76</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-number">114.114</span><span class="hljs-number">.114</span><span class="hljs-number">.114</span><br>  <span class="hljs-attr">version:</span> <span class="hljs-number">2</span><br>  <span class="hljs-attr">renderer:</span> <span class="hljs-string">networkd</span><br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨pythonä»mqæ¥æ”¶æ•°æ®ä»¥åŠå‘é€æ•°æ®åˆ°mq</title>
    <url>/2024/8ac8e7b68ec2/index.html</url>
    <content><![CDATA[<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*-coding:utf-8-*-</span><br><span class="hljs-keyword">import</span> stomp<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> struct<br><span class="hljs-keyword">import</span> uuid<br><br><span class="hljs-comment"># å®šä¹‰çš„æ¶ˆæ¯å¤´çš„æ ¼å¼ï¼Œå¯ä»¥è‡ªå·±å®šä¹‰</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageHeader</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, topic : <span class="hljs-built_in">str</span>, timestamp = time.time(<span class="hljs-params"></span>)</span>):<br>        self.topic = topic<br>        self.timestamp = <span class="hljs-built_in">int</span>(time.time())<br><br><span class="hljs-comment"># æ¶ˆæ¯çš„æ ¼å¼ï¼ŒåŒ…å«æ¶ˆæ¯å¤´å’Œå­—èŠ‚æ•°ç»„ç±»å‹çš„æ¶ˆæ¯ä½“</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, header, payload : <span class="hljs-built_in">bytes</span></span>):<br>        self.header = header<br>        self.payload = payload<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SampleListener</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">on_message</span>(<span class="hljs-params">self, frame</span>):<br>        <span class="hljs-comment"># frame.body æ˜¯æ¶ˆæ¯ä½“çš„å†…å®¹ï¼Œè¿™é‡Œéœ€è¦æŒ‰ç…§å®é™…æ ¼å¼æ¥è§£æ</span><br>        <span class="hljs-built_in">print</span>(frame.body)<br>        <span class="hljs-comment"># æ”¶åˆ°æ¶ˆæ¯ä¹‹ååˆç«‹å³å‘é€æ¶ˆæ¯</span><br>        reply_login_command()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">reply_login_command</span>():<br>    parameter= &#123;<br>        <span class="hljs-string">&quot;account&quot;</span>: <span class="hljs-string">&quot;test_account&quot;</span>,<br>        <span class="hljs-string">&quot;msg&quot;</span>: <span class="hljs-string">&quot;test_mesg&quot;</span><br>    &#125;<br>    header = MessageHeader(topic=<span class="hljs-string">&quot;send_topic&quot;</span>)<br>    reply_str = <span class="hljs-string">&quot;message=&quot;</span> + json.dumps(parameter)<br>    message = Message(header, reply_str.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br><br>    header = message.header<br>    topic = header.topic<br>    payload = message.payload<br><br>    bytesToSend = struct.pack(<span class="hljs-string">&#x27;!qqi&#x27;</span>, header.messageId, header.timestamp, <span class="hljs-built_in">len</span>(payload))<br>    bytesToSend += writeMUTF(topic)<br>    bytesToSend += payload<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Messenger.connection.send topic=%s, bytesToSend=%s&quot;</span> % (topic, bytesToSend))<br>    conn.send(body = bytesToSend, destination=topic)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">writeMUTF</span>(<span class="hljs-params">toWrite: <span class="hljs-built_in">str</span></span>):    <span class="hljs-comment"># å°†Pythonçš„å€¼æ ¹æ®æ ¼å¼ç¬¦ï¼Œè½¬æ¢ä¸ºå­—èŠ‚(Byte)ç±»å‹</span><br>    toWriteLen = <span class="hljs-built_in">len</span>(toWrite)<br>    composeFormat = <span class="hljs-string">&#x27;!H&#x27;</span> + <span class="hljs-built_in">str</span>(toWriteLen) + <span class="hljs-string">&#x27;s&#x27;</span>   <span class="hljs-comment"># æ ¼å¼ç¬¦, !è¡¨ç¤ºç½‘ç»œå¤§ç«¯å­—èŠ‚å¯¹é½ç”¨äºé…åˆCè¯­è¨€ï¼ŒHè¡¨ç¤ºintegeræ˜¯Cè¯­è¨€ä¸­çš„unsigned short, sè¡¨ç¤ºstringæ˜¯Cè¯­è¨€ä¸­çš„char[]å‹</span><br>    <span class="hljs-keyword">return</span> struct.pack(composeFormat, toWriteLen, toWrite.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">receive_from_queue</span>():<br>    <span class="hljs-comment"># å¦‚æœæ¥å—æ•°æ®,å°±è°ƒç”¨è¿™ä¸ªç±»,é‡Œé¢çš„å‚æ•°æ˜¯ç±»åå’Œç±»,åç§°å¿…é¡»ä¸€è‡´</span><br>    conn.set_listener(<span class="hljs-string">&#x27;SampleListener&#x27;</span>, SampleListener())<br>    <span class="hljs-comment"># ä»é€‰æ‹©çš„ç®¡é“ä¸­åŒºæ•°æ®,ç®¡é“å,id(éšä¾¿å†™ä¸€ä¸ªæ•°å­—å°±è¡Œ)</span><br>    conn.subscribe(location_queue, <span class="hljs-number">12</span>)<br>    <span class="hljs-comment"># ä¸èƒ½è®©ç¨‹åºåœæ­¢,è´Ÿè´£æ¯ä¼ ä¸€æ¬¡æ•°æ®éƒ½å¾—æ¥æ”¶ä¸€æ¬¡</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-comment"># è®¢é˜…çš„ topic åç§°</span><br>    location_queue = <span class="hljs-string">&quot;subscribe_topic&quot;</span><br>    conn = stomp.Connection([(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-number">61616</span>)])<br>    conn.connect(username=<span class="hljs-string">&#x27;user&#x27;</span>, passcode=<span class="hljs-string">&#x27;password&#x27;</span>, wait=<span class="hljs-literal">True</span>)<br>    receive_from_queue()<br>    conn.disconnect()<br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>è§£å†³vscodeæ‰¾ä¸åˆ°Pythonè‡ªå®šä¹‰æ¨¡å—æŠ¥é”™no module named</title>
    <url>/2023/05b28e23ee5b/index.html</url>
    <content><![CDATA[<p>åœ¨ <code>.vscode</code> ç›®å½•ä¸‹ï¼ˆè‹¥æ²¡æœ‰åˆ™æ–°å»ºï¼‰çš„ <code>launch.json</code> ä¸­æ·»åŠ  <code>env</code> ç›¸å…³å†…å®¹ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;0.2.0&quot;</span>,<br>    <span class="hljs-string">&quot;configurations&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;update_package&quot;</span>,<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;python&quot;</span>,<br>            <span class="hljs-string">&quot;request&quot;</span>: <span class="hljs-string">&quot;launch&quot;</span>,<br>            <span class="hljs-string">&quot;program&quot;</span>: <span class="hljs-string">&quot;timeline\\ssh\\win_command.py&quot;</span>,<br>            <span class="hljs-string">&quot;console&quot;</span>: <span class="hljs-string">&quot;integratedTerminal&quot;</span>,<br>            <span class="hljs-string">&quot;justMyCode&quot;</span>: true,<br>            <span class="hljs-comment"># ä¸‹é¢è¿™éƒ¨åˆ†æ˜¯æ–°å¢çš„å†…å®¹</span><br>            <span class="hljs-string">&quot;env&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;PYTHONPATH&quot;</span>: <span class="hljs-string">&quot;$&#123;workspaceRoot&#125;&quot;</span><br>            &#125;<br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>dubboçš„spiæœºåˆ¶ä½¿ç”¨æ¡ˆä¾‹</title>
    <url>/2023/30c57ac8b6c7/index.html</url>
    <content><![CDATA[<h2 id="dubboä¸ºä»€ä¹ˆéœ€è¦spiæœºåˆ¶"><a href="#dubboä¸ºä»€ä¹ˆéœ€è¦spiæœºåˆ¶" class="headerlink" title="dubboä¸ºä»€ä¹ˆéœ€è¦spiæœºåˆ¶"></a>dubboä¸ºä»€ä¹ˆéœ€è¦spiæœºåˆ¶</h2><p>ä¸€ä¸ªå¥½çš„ç¨‹åºæ˜¯è¦éµå¾ªä¸€å®šçš„è®¾è®¡è§„èŒƒæ¯”å¦‚è®¾è®¡æ¨¡å¼ä¸­çš„å¼€é—­åŸåˆ™</p>
<ol>
<li><strong>å¯¹æ‰©å±•å¼€æ”¾</strong>ï¼šæŒ‡çš„æ˜¯æˆ‘ä»¬ç³»ç»Ÿä¸­çš„æ¨¡å—ã€ç±»ã€æ–¹æ³•å¯¹å®ƒä»¬çš„æä¾›è€…ï¼ˆå¼€å‘è€…ï¼‰åº”è¯¥æ˜¯å¼€æ”¾çš„ï¼Œæä¾›è€…å¯ä»¥å¯¹ç³»ç»Ÿè¿›è¡Œæ‰©å±•ï¼ˆæ–°å¢ï¼‰æ–°çš„åŠŸèƒ½ã€‚</li>
<li><strong>å¯¹ä¿®æ”¹å…³é—­</strong>ï¼šæŒ‡çš„æ˜¯ç³»ç»Ÿä¸­çš„æ¨¡å—ã€ç±»ã€æ–¹æ³•å¯¹å®ƒä»¬çš„ä½¿ç”¨è€…ï¼ˆè°ƒç”¨è€…ï¼‰åº”è¯¥æ˜¯â€¢ å…³é—­çš„ã€‚ä½¿ç”¨è€…ä½¿ç”¨è¿™äº›åŠŸèƒ½æ—¶ï¼Œä¸ä¼šå› ä¸ºæä¾›æ–¹æ–°å¢äº†åŠŸèƒ½è€Œå¯¼è‡´ä½¿ç”¨è€…ä¹Ÿè¿›è¡Œç›¸åº”ä¿®æ”¹<blockquote>
<p>Apache Dubbo æ˜¯ä¸€æ¬¾å¾®æœåŠ¡å¼€å‘æ¡†æ¶ï¼Œå®ƒæä¾›äº† RPC é€šä¿¡ä¸å¾®æœåŠ¡æ²»ç†ä¸¤å¤§å…³é”®èƒ½åŠ›ã€‚è¿™æ„å‘³ç€ï¼Œä½¿ç”¨ Dubbo å¼€å‘çš„å¾®æœåŠ¡ï¼Œå°†å…·å¤‡ç›¸äº’ä¹‹é—´çš„è¿œç¨‹å‘ç°ä¸é€šä¿¡èƒ½åŠ›ï¼ŒåŒæ—¶åˆ©ç”¨ Dubbo æä¾›çš„ä¸°å¯ŒæœåŠ¡æ²»ç†èƒ½åŠ›ï¼Œå¯ä»¥å®ç°è¯¸å¦‚æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æµé‡è°ƒåº¦ç­‰æœåŠ¡æ²»ç†è¯‰æ±‚ã€‚åŒæ—¶ Dubbo æ˜¯é«˜åº¦å¯æ‰©å±•çš„ï¼Œç”¨æˆ·å‡ ä¹å¯ä»¥åœ¨ä»»æ„åŠŸèƒ½ç‚¹å»å®šåˆ¶è‡ªå·±çš„å®ç°ï¼Œä»¥æ”¹å˜æ¡†æ¶çš„é»˜è®¤è¡Œä¸ºæ¥æ»¡è¶³è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚</p>
<p>å¯¹äº Apache Dubbo æ¥è¯´ä¸å˜çš„æ˜¯ RPC è°ƒç”¨æµç¨‹ï¼Œå¾®æœåŠ¡æ²»ç†ç›¸å…³çš„æ¦‚å¿µå’Œæµç¨‹ï¼Œä½†æ˜¯åœ¨æµç¨‹ä¸­æ¯ä¸ªç¯èŠ‚çš„å…·ä½“å®ç°æ–¹å¼å¯ä»¥æ˜¯åŠ¨æ€æ”¹å˜çš„ï¼ŒDubbo ä½¿ç”¨å¾®å†…æ ¸çš„æ¶æ„ï¼Œå°†å…·ä½“çš„å®ç°å¼€æ”¾å‡ºæ¥ï¼Œè®©ä½¿ç”¨è€…å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥é€‰æ‹©</p>
</blockquote>
</li>
</ol>
<h3 id="å¾®å†…æ ¸æ¶æ„"><a href="#å¾®å†…æ ¸æ¶æ„" class="headerlink" title="å¾®å†…æ ¸æ¶æ„"></a>å¾®å†…æ ¸æ¶æ„</h3><p>å¾®å†…æ ¸æ¶æ„ç”±ä¸¤å¤§æ¶æ„æ¨¡å—ç»„æˆï¼šæ ¸å¿ƒç³»ç»Ÿä¸æ’ä»¶æ¨¡å—</p>
<ol>
<li><strong>æ ¸å¿ƒç³»ç»Ÿ</strong>ï¼š è´Ÿè´£å’Œå…·ä½“ä¸šåŠ¡åŠŸèƒ½æ— å…³çš„é€šç”¨åŠŸèƒ½ï¼Œä¾‹å¦‚æ¨¡å—åŠ è½½ã€æ¨¡å—é—´é€šä¿¡ç­‰ï¼ŒDubbo å†…æ ¸çš„å·¥ä½œåŸç†ç”±å››éƒ¨åˆ†ç»„æˆ<ol>
<li>æœåŠ¡å‘ç°æœºåˆ¶ <code>spi</code></li>
<li>è‡ªé€‚åº”æœºåˆ¶ <code>Adaptive</code></li>
<li>åŒ…è£…æœºåˆ¶ <code>Wrapper</code></li>
<li>æ¿€æ´»æœºåˆ¶ <code>Activate</code><br><code>Dubbo</code> é€šè¿‡ä¸Šé¢å››ç§æœºåˆ¶å®ç°äº†å¯¹æ’ä»¶çš„ <code>IOC</code>, <code>AOP</code> å®ç°äº†å¯¹è‡ªåŠ¨ç”Ÿæˆç±»çš„åŠ¨æ€ç¼–è¯‘ <code>Compile</code></li>
</ol>
</li>
<li><strong>æ’ä»¶æ¨¡å—</strong>ï¼š è´Ÿè´£å®ç°å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨ <code>Dubbo</code> ä¸­å°±æ˜¯ <code>Dubbo SPI</code> æ¥å£ä¸å®ç°</li>
</ol>
<h2 id="Dubbo-ä¸­çš„-spi-è§„èŒƒ"><a href="#Dubbo-ä¸­çš„-spi-è§„èŒƒ" class="headerlink" title="Dubbo ä¸­çš„ spi è§„èŒƒ"></a>Dubbo ä¸­çš„ spi è§„èŒƒ</h2><ol>
<li>æ¥å£åï¼š å¯ä»¥éšæ„å®šä¹‰ï¼Œä½†æ˜¯éœ€è¦è¢« <code>@SPI</code> æ³¨è§£ä¿®é¥°</li>
<li>å®ç°ç±»å: åœ¨æ¥å£åå‰é¢æ·»åŠ ä¸€ä¸ªç”¨äºè¡¨ç¤ºè‡ªèº«åŠŸèƒ½çš„ â€œæ ‡è¯†å‰ç¼€â€ å­—ç¬¦ä¸²</li>
<li>æä¾›è€…é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œä¾æ¬¡æŸ¥æ‰¾ç›®å½•ä¸º<ol>
<li><code>META-INF/dubbo/internal</code></li>
<li><code>META-INF/dubbo</code></li>
<li><code>META-INF/services</code></li>
</ol>
</li>
<li>æä¾›è€…é…ç½®æ–‡ä»¶åç§°ï¼šæ¥å£çš„å…¨é™å®šæ€§ç±»å</li>
<li>æä¾›è€…é…ç½®æ–‡ä»¶å†…å®¹ï¼šæ–‡ä»¶çš„å†…å®¹ä¸º <code>key=value</code> å½¢å¼ï¼Œ<code>value</code> ä¸ºè¯¥æ¥å£çš„å®ç°ç±»çš„å…¨é™ç±»æ€§ç±»åï¼Œ<code>key</code> å¯ä»¥éšæ„ï¼Œä½†ä¸€èˆ¬ä¸ºè¯¥å®ç°ç±»çš„â€œæ ‡è¯†å‰è¾â€ï¼ˆé¦–å­—æ¯å°å†™ï¼‰ã€‚ä¸€ä¸ªç±»åå ä¸€è¡Œ</li>
<li><code>æä¾›è€…åŠ è½½ï¼šExtensionLoader</code> ç±»ç›¸å½“äº <code>JDK SP</code>I ä¸­ <code>ServiceLoader</code> ç±»ï¼Œç”¨äºåŠ è½½æä¾›è€…é…ç½®æ–‡ä»¶ä¸­æ‰€æœ‰çš„å®ç°ç±»ï¼Œå¹¶åˆ›å»ºç›¸åº”çš„å®ä¾‹</li>
</ol>
<p>dubbo spi æœºåˆ¶éƒ½æ˜¯ç”Ÿæˆä»£ç†ç±»ï¼Œä¸€èˆ¬ä½¿ç”¨ <code>javaassist</code> æ–¹æ³•ç”Ÿæˆï¼Œå¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/d513f5c497bd/index.html" title="javaè¾“å‡ºè¿è¡Œè¿‡ç¨‹ä¸­çš„ä»£ç†ç±»">javaè¾“å‡ºè¿è¡Œè¿‡ç¨‹ä¸­çš„ä»£ç†ç±»</a></li></ol> æ¥è·å–ä»£ç†ç±»

<h2 id="dubbo-spi-ä½¿ç”¨æ¡ˆä¾‹"><a href="#dubbo-spi-ä½¿ç”¨æ¡ˆä¾‹" class="headerlink" title="dubbo spi ä½¿ç”¨æ¡ˆä¾‹"></a>dubbo spi ä½¿ç”¨æ¡ˆä¾‹</h2><figure class="highlight java"><figcaption><span>æ¥å£å’Œå¯¹åº”å®ç°ç±»</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SPI</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> &#123;<br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-comment">//  ç¬¬ä¸€ä¸ªå®ç°ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirstHello</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hello</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;first&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ç¬¬äºŒä¸ªå®ç°ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecondHello</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hello</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;second&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ·»åŠ é…ç½®æ–‡ä»¶ï¼Œåœ¨ <code>resource</code> ä¸‹åˆ›å»ºç›®å½• <code>META-INF/services</code>, ç„¶ååˆ›å»ºæ–‡ä»¶</p>
<p>æ–‡ä»¶åä¸ºæ¥å£å…¨é™å®šæ€§ç±»å ï¼š <code>com.example.dubbodemo.spi.Hello</code> </p>
<p>æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">first=com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.dubbodemo</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.FirstHello</span><br>second=com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.dubbodemo</span><span class="hljs-selector-class">.spi</span>.SecondHello<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><figcaption><span>ä»£ç æµ‹è¯•</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSpi</span><span class="hljs-params">()</span> &#123;<br>    ExtensionLoader&lt;Hello&gt; loader = ExtensionLoader.getExtensionLoader(Hello.class);<br>    <span class="hljs-type">Hello</span> <span class="hljs-variable">firstHello</span> <span class="hljs-operator">=</span> loader.getExtension(<span class="hljs-string">&quot;first&quot;</span>);<br>    System.out.println(firstHello.sayHello()); <span class="hljs-comment">// first</span><br>    <span class="hljs-type">Hello</span> <span class="hljs-variable">secondHello</span> <span class="hljs-operator">=</span> loader.getExtension(<span class="hljs-string">&quot;second&quot;</span>);<br>    System.out.println(secondHello.sayHello()); <span class="hljs-comment">// second</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="dubbo-Adaptive-æœºåˆ¶"><a href="#dubbo-Adaptive-æœºåˆ¶" class="headerlink" title="dubbo Adaptive æœºåˆ¶"></a>dubbo Adaptive æœºåˆ¶</h2><ol>
<li>ä»ä¸Šé¢ <code>spi</code> ä»£ç ç¤ºä¾‹ä¸­å¯ä»¥çœ‹åˆ°å½“æœ‰å¤šä¸ªå®ç°ç±»çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ ¹æ® <code>key</code> æ¥é€‰æ‹©å…·ä½“æ˜¯ä½¿ç”¨å“ªä¸ªå®ç°ç±»</li>
<li><code>dubbo</code> ä¸­æ˜¯ä»¥ <code>url</code> æ¥è´¯ç©¿æ•´ä¸ªè°ƒç”¨è·¯å¾„çš„ï¼Œæ‰€è°“çš„ <code>adaptive</code> æœºåˆ¶å°±æ˜¯æ ¹æ® <code>url</code> ä¸­çš„å‚æ•°æ¥è‡ªåŠ¨å¸®æˆ‘ä»¬åˆ¤æ–­åº”è¯¥ä½¿ç”¨å“ªä¸ªå®ç°ç±»ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨æŒ‡å®š <code>key</code></li>
<li><code>@Adaptive</code> å¯ä»¥ç”¨æ¥ä¿®é¥°ç±»å’Œä¿®é¥°æ–¹æ³•ï¼Œ å¦‚æœæ˜¯ä¿®é¥°æ–¹æ³•ï¼Œé‚£ä¹ˆ <code>@Adaptive</code> ä¿®é¥°çš„æ–¹æ³•å°±å¿…é¡»åŒ…å« <code>url</code> å‚æ•°ï¼Œå¦‚æœæ˜¯ä¿®é¥°æ–¹æ³•ï¼Œåˆ™æ²¡æœ‰è¦æ±‚æ¥å£ä¸­çš„æ–¹æ³•å¿…é¡»æœ‰ <code>url</code> å‚æ•°</li>
</ol>
<p>ä¸‹é¢ç¤ºä¾‹ä¸­åŒ…å«ä¸€ä¸ª æ‰“æ‹›å‘¼çš„æ¥å£ <code>Hello</code>ï¼Œ ç„¶åè¿˜æœ‰ä¸¤ç§æ‰“æ‹›å‘¼çš„å®ç°ï¼Œåˆ†åˆ«æ˜¯ <code>FirstHello</code> å’Œ <code>SecondHello</code></p>
<div class="tabs" id="dubboçš„adaptiveæœºåˆ¶ç¤ºä¾‹"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="dubboçš„adaptiveæœºåˆ¶ç¤ºä¾‹-1">ä¿®é¥°æ–¹æ³•ç¤ºä¾‹</button><button type="button" class="tab " data-href="dubboçš„adaptiveæœºåˆ¶ç¤ºä¾‹-2">adaptiveä¿®é¥°ç±»ç¤ºä¾‹</button></ul><div class="tab-contents"><div class="tab-item-content active" id="dubboçš„adaptiveæœºåˆ¶ç¤ºä¾‹-1"><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  æ¥å£å®šä¹‰</span><br><span class="hljs-meta">@SPI</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> &#123;<br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-meta">@Adaptive</span><br>    String <span class="hljs-title function_">adaptiveHello</span><span class="hljs-params">(URL url)</span>;<br>&#125;<br><br><span class="hljs-comment">//  ç¬¬ä¸€ä¸ªå®ç°ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirstHello</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hello</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;first normal&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">adaptiveHello</span><span class="hljs-params">(URL url)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;first adaptive&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ç¬¬äºŒä¸ªå®ç°ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecondHello</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hello</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;second normal&quot;</span>;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">adaptiveHello</span><span class="hljs-params">(URL url)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;second adaptive&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ·»åŠ é…ç½®æ–‡ä»¶ï¼Œåœ¨ <code>resource</code> ä¸‹åˆ›å»ºç›®å½• <code>META-INF/services</code>, ç„¶ååˆ›å»ºæ–‡ä»¶</p>
<p>æ–‡ä»¶åä¸ºæ¥å£å…¨é™å®šæ€§ç±»å ï¼š <code>com.example.dubbodemo.spi.Hello</code> </p>
<p>æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">first=com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.dubbodemo</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.FirstHello</span><br>second=com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.dubbodemo</span><span class="hljs-selector-class">.spi</span>.SecondHello<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  æµ‹è¯•ç±»</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAdaptive</span><span class="hljs-params">()</span> &#123;<br>    ExtensionLoader&lt;Hello&gt; loader = ExtensionLoader.getExtensionLoader(Hello.class);<br>    <span class="hljs-type">Hello</span> <span class="hljs-variable">iHello</span> <span class="hljs-operator">=</span> loader.getAdaptiveExtension();<br>    <span class="hljs-comment">// è¿™ä¸ªç›¸å½“äºåœ¨urlä¸­è®¾ç½®äº† key=hello(ä¹Ÿå°±æ˜¯æ¥å£åç§°)ï¼Œ value=second, è¿™é‡Œçš„secondæ˜¯å’Œé…ç½®æ–‡ä»¶ä¸­çš„keyå¯¹åº”çš„ï¼Œè¡¨ç¤º</span><br>    <span class="hljs-comment">// å…·ä½“é€‰æ‹©çš„æ˜¯å“ªä¸ªå®ç°ç±»</span><br>    <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> URL.valueOf(<span class="hljs-string">&quot;http://localhost?hello=second&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> iHello.adaptiveHello(url);<br>    System.out.println(s); <span class="hljs-comment">// ä¼šæ‰“å° second adaptive</span><br>&#125;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAdaptive2</span><span class="hljs-params">()</span> &#123;<br>    ExtensionLoader&lt;Hello&gt; loader = ExtensionLoader.getExtensionLoader(Hello.class);<br>    <span class="hljs-type">Hello</span> <span class="hljs-variable">iHello</span> <span class="hljs-operator">=</span> loader.getAdaptiveExtension();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> iHello.sayHello(); <span class="hljs-comment">// è¿™é‡Œä¼šæŠ¥é”™ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•å¹¶æ²¡æœ‰ä½¿ç”¨ @Adaptive æ³¨è§£ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨ adaptive æ–¹æ³•æ¥è¿›è¡Œè°ƒç”¨</span><br>    System.out.println(s);<br>&#125;<br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="dubboçš„adaptiveæœºåˆ¶ç¤ºä¾‹-2"><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  æ¥å£å®šä¹‰, å…¶ä¸­æœ‰é»˜è®¤å€¼</span><br><span class="hljs-meta">@SPI(&quot;first&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> &#123;<br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-comment">// ç¬¬ä¸€ä¸ªå®ç°ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirstHello</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hello</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;first hello&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ç¬¬äºŒä¸ªå®ç°ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecondHello</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hello</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;second hello&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// è‡ªé€‚åº”ç±»ï¼Œè¿™ä¸ªç±»éœ€è¦ä½¿ç”¨ @Adaptive æ³¨è§£ä¿®é¥°</span><br><span class="hljs-meta">@Adaptive</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdaptiveHello</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hello</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String type;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setType</span><span class="hljs-params">(String type)</span> &#123;<br>        <span class="hljs-built_in">this</span>.type = type;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        ExtensionLoader&lt;Hello&gt; loader = ExtensionLoader.getExtensionLoader(Hello.class);<br>        Hello hello;<br>        <span class="hljs-keyword">if</span> (StringUtils.hasText(type)) &#123;<br>            hello = loader.getExtension(type);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// æ²¡æœ‰æŒ‡å®šçš„ç±»å‹ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„ç±»å‹ï¼Œå°±æ˜¯æ¥å£ä¸Š @SPI æ³¨è§£ä¸­çš„å€¼</span><br>            hello = loader.getDefaultExtension();<br>        &#125;<br>        <span class="hljs-keyword">return</span> hello.sayHello();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ·»åŠ é…ç½®æ–‡ä»¶ï¼Œåœ¨ <code>resource</code> ä¸‹åˆ›å»ºç›®å½• <code>META-INF/services</code>, ç„¶ååˆ›å»ºæ–‡ä»¶</p>
<p>æ–‡ä»¶åä¸ºæ¥å£å…¨é™å®šæ€§ç±»å ï¼š <code>com.example.dubbodemo.spi.Hello</code> </p>
<p>æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">first=com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.dubbodemo</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.FirstHello</span><br>second=com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.dubbodemo</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.SecondHello</span><br>adaptive=com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.dubbodemo</span><span class="hljs-selector-class">.spi</span>.AdaptiveHello<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æµ‹è¯•ç±»</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAdaptiveClass</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Hello</span> <span class="hljs-variable">hello</span> <span class="hljs-operator">=</span> ExtensionLoader.getExtensionLoader(Hello.class).getAdaptiveExtension();<br>    System.out.println(hello.sayHello());<span class="hljs-comment">// è¾“å‡º first hello, é»˜è®¤å€¼å°±æ˜¯ æ¥å£ä¸Šçš„ @SPI æ³¨è§£ä¸­çš„å€¼</span><br><br>    ((AdaptiveHello)hello).setType(<span class="hljs-string">&quot;second&quot;</span>);<br>    System.out.println(hello.sayHello());  <span class="hljs-comment">// è¾“å‡º second hello, å› ä¸ºé€šè¿‡ type è®¾ç½®äº†æƒ³è¦çš„ç±»å‹</span><br>&#125;<br></code></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h2 id="dubbo-ä¸­-wrapper-æœºåˆ¶æ¡ˆä¾‹"><a href="#dubbo-ä¸­-wrapper-æœºåˆ¶æ¡ˆä¾‹" class="headerlink" title="dubbo ä¸­ wrapper æœºåˆ¶æ¡ˆä¾‹"></a>dubbo ä¸­ wrapper æœºåˆ¶æ¡ˆä¾‹</h2><h3 id="wrapper-æ˜¯ä»€ä¹ˆ"><a href="#wrapper-æ˜¯ä»€ä¹ˆ" class="headerlink" title="wrapper æ˜¯ä»€ä¹ˆ"></a>wrapper æ˜¯ä»€ä¹ˆ</h3><ol>
<li>ä½œç”¨ä¸Š <code>wrapper</code> å’Œ <code>aop</code> æ˜¯ç±»ä¼¼çš„ï¼Œä¹Ÿæ˜¯å¯¹ä¸€ä¸ªç±»çš„åŠŸèƒ½è¿›è¡Œå¢å¼ºï¼Œä½†æ˜¯ <code>wrapper</code> ä¸æ˜¯é€šè¿‡ <code>aop</code> çš„å½¢å¼å®ç°çš„ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ç³»åˆ—è§„èŒƒæ¥å®šä¹‰ä¸€ä¸ª <code>wrapper</code> ç±»</li>
<li>ç¬¬ä¸€ç‚¹è¯´çš„æ˜¯ <code>wrapper</code> ç±»å¯ä»¥å¢å¼ºï¼Œä½†æ˜¯æ²¡è¯´å¢å¼ºçš„æ˜¯ä»€ä¹ˆï¼Ÿ å…¶å® <code>wrapper</code> ç±»å¢å¼ºçš„å°±æ˜¯ <code>spi</code> æ¥å£çš„å®ç°ç±»</li>
</ol>
<h3 id="wrapper-ç±»è§„èŒƒ"><a href="#wrapper-ç±»è§„èŒƒ" class="headerlink" title="wrapper ç±»è§„èŒƒ"></a>wrapper ç±»è§„èŒƒ</h3><ol>
<li>å®šä¹‰çš„ <code>wrapper</code> ç±»è¦å®ç° <code>spi</code> æ¥å£</li>
<li>å®šä¹‰çš„ <code>wrapper</code> ç±»å¿…é¡»è¦åŒ…å« <code>spi</code> æ¥å£çš„å¼•ç”¨</li>
<li><code>wrapper</code> ç±»ä¸­ <code>spi</code> æ¥å£çš„å®ç°æ˜¯é€šè¿‡ä»…åŒ…å«ä¸€ä¸ª <code>spi</code> æ¥å£å‚æ•°çš„å¸¦å‚æ„é€ å™¨ä¼ å…¥çš„</li>
<li>åœ¨æ¥å£å®ç°æ–¹æ³•ä¸­æ‰€éœ€è¦è°ƒç”¨ <code>spi</code> æ¥å£å¼•ç”¨å¯¹è±¡çš„ç›¸åº”æ–¹æ³•</li>
<li><code>wrapper</code> ç±»åç§°éœ€è¦ä»¥ <code>Wrapper</code> ç»“å°¾</li>
</ol>
<h3 id="wrapper-ç±»ç¤ºä¾‹"><a href="#wrapper-ç±»ç¤ºä¾‹" class="headerlink" title="wrapper ç±»ç¤ºä¾‹"></a>wrapper ç±»ç¤ºä¾‹</h3><p>ä¸‹é¢æ˜¯ <code>wrapper</code> æ¡ˆä¾‹ä»£ç ï¼Œä¾ç„¶ä½¿ç”¨çš„æ˜¯å‰é¢çš„ <code>Hello</code> æ¥å£å’Œä¸¤ä¸ªå®ç°ç±»ä»¥åŠå¯¹è¿™ä¸¤ä¸ªå®ç°ç±»è¿›è¡Œå¢å¼ºçš„ä¸¤ä¸ª <code>wrapper</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// SPI æ¥å£å®šä¹‰ï¼Œé»˜è®¤å®ç°ç±»æ˜¯ FirstHello</span><br><span class="hljs-meta">@SPI(&quot;first&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> &#123;<br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-comment">// ç¬¬ä¸€ä¸ªå®ç°ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirstHello</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hello</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;first hello&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ç¬¬äºŒä¸ªå®ç°ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecondHello</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hello</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;second hello&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ç¬¬ä¸€ä¸ªå¢å¼ºç±»</span><br><span class="hljs-comment">// 1. æ»¡è¶³ç¬¬ä¸€ç‚¹è¦æ±‚ï¼ŒWrapper ç±»éœ€è¦å®ç° SPI æ¥å£</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWrapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hello</span>&#123;<br><br>    <span class="hljs-comment">// 2. æ»¡è¶³ç¬¬äºŒç‚¹ å®šä¹‰çš„ `wrapper` ç±»å¿…é¡»è¦åŒ…å« `spi` æ¥å£çš„å¼•ç”¨</span><br>    <span class="hljs-keyword">private</span> Hello hello;<br><br>    <span class="hljs-comment">// 3. æ»¡è¶³ç¬¬ä¸‰ç‚¹ `wrapper` ç±»ä¸­ `spi` æ¥å£çš„å®ç°æ˜¯é€šè¿‡ä»…åŒ…å«ä¸€ä¸ª `spi` æ¥å£å‚æ•°çš„å¸¦å‚æ„é€ å™¨ä¼ å…¥çš„</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HelloWrapper</span><span class="hljs-params">(Hello hello)</span> &#123;<br>        <span class="hljs-built_in">this</span>.hello = hello;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;wrapper1çš„æ–¹æ³•å¢å¼ºå¼€å§‹&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> hello.sayHello();<br>        System.out.println(<span class="hljs-string">&quot;Wrapper1çš„æ–¹æ³•å¢å¼ºç»“æŸ&quot;</span>);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">// ç¬¬äºŒä¸ªå¢å¼ºç±»</span><br><span class="hljs-comment">// 1. æ»¡è¶³ç¬¬ä¸€ç‚¹è¦æ±‚ï¼ŒWrapper ç±»éœ€è¦å®ç° SPI æ¥å£</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWrapper2</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hello</span>&#123;<br><br>    <span class="hljs-comment">// 2. æ»¡è¶³ç¬¬äºŒç‚¹ å®šä¹‰çš„ `wrapper` ç±»å¿…é¡»è¦åŒ…å« `spi` æ¥å£çš„å¼•ç”¨</span><br>    <span class="hljs-keyword">private</span> Hello hello;<br><br>    <span class="hljs-comment">// 3. æ»¡è¶³ç¬¬ä¸‰ç‚¹ `wrapper` ç±»ä¸­ `spi` æ¥å£çš„å®ç°æ˜¯é€šè¿‡ä»…åŒ…å«ä¸€ä¸ª `spi` æ¥å£å‚æ•°çš„å¸¦å‚æ„é€ å™¨ä¼ å…¥çš„</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HelloWrapper2</span><span class="hljs-params">(Hello hello)</span> &#123;<br>        <span class="hljs-built_in">this</span>.hello = hello;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;wrapper2çš„æ–¹æ³•å¢å¼ºå¼€å§‹&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> hello.sayHello();<br>        System.out.println(<span class="hljs-string">&quot;Wrapper2çš„æ–¹æ³•å¢å¼ºç»“æŸ&quot;</span>);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>com.example.dubbodemo.spi.Hello</code> é…ç½®æ–‡ä»¶å†…å®¹</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">first=com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.dubbodemo</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.FirstHello</span><br>second=com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.dubbodemo</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.SecondHello</span><br>wrapper=com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.dubbodemo</span><span class="hljs-selector-class">.spi</span><span class="hljs-selector-class">.HelloWrapper</span><br>wrapper2=com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.dubbodemo</span><span class="hljs-selector-class">.spi</span>.HelloWrapper2<br></code></pre></td></tr></table></figure>

<p>æµ‹è¯•ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testWrapper</span><span class="hljs-params">()</span> &#123;<br>    ExtensionLoader&lt;Hello&gt; loader = ExtensionLoader.getExtensionLoader(Hello.class);<br>    <span class="hljs-type">Hello</span> <span class="hljs-variable">firstHello</span> <span class="hljs-operator">=</span> loader.getExtension(<span class="hljs-string">&quot;first&quot;</span>);<br>    System.out.println(firstHello.sayHello());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript">wrapper2çš„æ–¹æ³•å¢å¼ºå¼€å§‹<br>wrapper1çš„æ–¹æ³•å¢å¼ºå¼€å§‹<br>Wrapper1çš„æ–¹æ³•å¢å¼ºç»“æŸ<br>Wrapper2çš„æ–¹æ³•å¢å¼ºç»“æŸ<br><span class="hljs-keyword">first</span> hello<br></code></pre></td></tr></table></figure>

<h2 id="dubbo-spi-æœºåˆ¶æºç è§£æ"><a href="#dubbo-spi-æœºåˆ¶æºç è§£æ" class="headerlink" title="dubbo spi æœºåˆ¶æºç è§£æ"></a>dubbo spi æœºåˆ¶æºç è§£æ</h2><p><a href="https://cn.dubbo.apache.org/zh-cn/overview/mannual/java-sdk/reference-manual/spi/description/dubbo-spi/">dubboå®˜ç½‘spiæºç è§£æ</a></p>
<h2 id="dubbo3-æ¨¡å—é¢†åŸŸæ¨¡å‹"><a href="#dubbo3-æ¨¡å—é¢†åŸŸæ¨¡å‹" class="headerlink" title="dubbo3 æ¨¡å—é¢†åŸŸæ¨¡å‹"></a>dubbo3 æ¨¡å—é¢†åŸŸæ¨¡å‹</h2><p>å‰é¢åœ¨è®²è§£åŠ è½½ <code>spi</code> æ‰©å±•ç‚¹æ—¶ç”¨åˆ°çš„æ˜¯å¦‚ä¸‹ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">ExtensionLoader&lt;Hello&gt; loader = ExtensionLoader.getExtensionLoader(Hello.class);<br></code></pre></td></tr></table></figure>
<p>ä½†æ˜¯åœ¨ <code>dubbo3</code> ä¸­å·²ç»å°† <code>ExtensionLoader.getExtensionLoader</code> æ ‡è®°ä¸º <strong>å¼ƒç”¨</strong>ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ <code>dubbo3</code> ä¸­å¢åŠ äº†æ¨¡å—é¢†åŸŸæ¨¡å‹ï¼Œç®€å•ç†è§£å°±æ˜¯ <strong>æ¯ä¸€ä¸ªæ‰©å±•ç‚¹éƒ½æ˜¯æœ‰èŒƒå›´çš„ï¼Œè€Œä¹‹å‰çš„æ–¹å¼ç›¸å½“äºæ‰€æœ‰æ‰©å±•ç‚¹éƒ½åœ¨ä¸€ä¸ªèŒƒå›´ä¸­</strong></p>
<blockquote>
<p>ä¸»è¦æœ‰å¦‚ä¸‹åŸå›  ä¹‹å‰dubbo éƒ½æ˜¯åªæœ‰ä¸€ä¸ªä½œç”¨åŸŸçš„ï¼Œé€šè¿‡é™æ€ç±» å±æ€§å…±äº« å¢åŠ åŸŸæ¨¡å‹æ˜¯ä¸ºäº†:</p>
<ol>
<li>è®©Dubboæ”¯æŒå¤šåº”ç”¨çš„éƒ¨ç½²ï¼Œè¿™å—ä¸€äº›å¤§ä¼ä¸šæœ‰è¯‰æ±‚  </li>
<li>ä»æ¶æ„è®¾è®¡ä¸Šï¼Œè§£å†³é™æ€å±æ€§èµ„æºå…±äº«ã€æ¸…ç†çš„é—®é¢˜</li>
<li>åˆ†å±‚æ¨¡å‹å°†åº”ç”¨çš„ç®¡ç†å’ŒæœåŠ¡çš„ç®¡ç†åˆ†å¼€</li>
</ol>
<p>å¯èƒ½æ¯”è¾ƒæŠ½è±¡ï¼Œå¯ä»¥å…·ä½“ç‚¹æ¥çœ‹ã€‚Dubbo3ä¸­åœ¨å¯åŠ¨æ—¶å€™éœ€è¦å¯åŠ¨é…ç½®ä¸­å¿ƒã€å…ƒæ•°æ®ä¸­å¿ƒï¼Œè¿™ä¸ªé…ç½®ä¸­å¿ƒå’Œå…ƒæ•°æ®ä¸­å¿ƒå¯ä»¥å½’åº”ç”¨æ¨¡å‹æ¥ç®¡ç†ã€‚Dubboä½œä¸ºRPCæ¡†æ¶åˆéœ€è¦å¯åŠ¨æœåŠ¡å’Œå¼•ç”¨æœåŠ¡ï¼ŒæœåŠ¡çº§åˆ«çš„ç®¡ç†å°±äº¤ç»™äº†è¿™ä¸ªæ¨¡å—æ¨¡å‹æ¥ç®¡ç†ã€‚åˆ†å±‚æ¬¡çš„ç®¡ç†æ–¹ä¾¿æˆ‘ä»¬ç†è§£å’Œå¤„ç†é€»è¾‘ï¼Œçˆ¶å­çº§åˆ«çš„æ¨¡å‹åˆæ–¹ä¾¿äº†æ•°æ®ä¼ é€’ã€‚</p>
</blockquote>
<p><a href="https://cn.dubbo.apache.org/zh-cn/blog/2022/08/03/03-%E6%A1%86%E6%9E%B6%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%A8%A1%E5%9D%97%E9%A2%86%E5%9F%9F%E6%A8%A1%E5%9E%8Bmodel%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96/">å®˜ç½‘dubbo3æ¨¡å—é¢†åŸŸæ¨¡å‹</a></p>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>dubbo</category>
      </categories>
      <tags>
        <tag>dubbo</tag>
      </tags>
  </entry>
  <entry>
    <title>nacos2.2.3é€šè¿‡æ’ä»¶æœºåˆ¶æ”¯æŒpostgres</title>
    <url>/2023/4c25a01a2388/index.html</url>
    <content><![CDATA[<h2 id="ä½¿ç”¨-nacos2-2-3-ç‰ˆæœ¬"><a href="#ä½¿ç”¨-nacos2-2-3-ç‰ˆæœ¬" class="headerlink" title="ä½¿ç”¨ nacos2.2.3 ç‰ˆæœ¬"></a>ä½¿ç”¨ nacos2.2.3 ç‰ˆæœ¬</h2><ol>
<li>ä» <a href="https://github.com/alibaba/nacos/releases">githubä¸‹è½½nacosæºç </a></li>
<li>åˆ‡æ¢åˆ° 2.2.3 ç‰ˆæœ¬<ol>
<li><code>git checkout -b 2.2.3 2.2.3</code>ï¼Œ <code>nacos</code> æºç ä¸­ 2.2.3 æ˜¯ <code>tag</code>, è¯¥å‘½ä»¤æ˜¯ä»å¯¹åº” <code>tag</code> åˆ›å»ºåˆ†æ”¯</li>
</ol>
</li>
</ol>
<h2 id="æ·»åŠ -postgres-ä¾èµ–"><a href="#æ·»åŠ -postgres-ä¾èµ–" class="headerlink" title="æ·»åŠ  postgres ä¾èµ–"></a>æ·»åŠ  postgres ä¾èµ–</h2><p>åœ¨ <code>nacos</code> çš„æ ¹ç›®å½•ä¸‹çš„ <code>pom.xml</code> ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- æ·»åŠ  postgres ç‰ˆæœ¬çº¦æŸ --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">postgresql-version</span>&gt;</span>42.3.8<span class="hljs-tag">&lt;/<span class="hljs-name">postgresql-version</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- é»˜è®¤æ˜¯1.8ï¼Œç›®å‰ä½¿ç”¨ jdk11 ç¼–è¯‘ --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>config</code> æ¨¡å—ä¸‹çš„ <code>pom.xml</code> ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- æ·»åŠ  postgresql ä¾èµ– --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;postgresql-version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="é€šè¿‡-spi-æœºåˆ¶æ·»åŠ -postgres-ç›¸å…³æ”¯æŒ"><a href="#é€šè¿‡-spi-æœºåˆ¶æ·»åŠ -postgres-ç›¸å…³æ”¯æŒ" class="headerlink" title="é€šè¿‡ spi æœºåˆ¶æ·»åŠ  postgres ç›¸å…³æ”¯æŒ"></a>é€šè¿‡ spi æœºåˆ¶æ·»åŠ  postgres ç›¸å…³æ”¯æŒ</h2><p>æ‰¾åˆ° <code>plugin</code> æ¨¡å—ï¼Œé‡Œé¢è¿˜åŒ…å«ä¸€ä¸ª <code>datasource</code> æ¨¡å—ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹<br>ã€datasourceã€‘æ¨¡å—çš„ç›®å½•è·¯å¾„ä¸ºï¼š <code>nacosæºç æ‰€åœ¨çš„ç›®å½•ä½ç½®\nacos\plugin\datasource</code></p>
<figure class="highlight stata"><table><tr><td class="code"><pre><code class="hljs stata">â”œâ”€datasource<br>â”‚  â”œâ”€src<br>â”‚  â”‚  â”œâ”€main<br>â”‚  â”‚  â”‚  â”œâ”€java<br>â”‚  â”‚  â”‚  â”‚  â””â”€com<br>â”‚  â”‚  â”‚  â”‚      â””â”€alibaba<br>â”‚  â”‚  â”‚  â”‚          â””â”€nacos<br>â”‚  â”‚  â”‚  â”‚              â””â”€<span class="hljs-keyword">plugin</span><br>â”‚  â”‚  â”‚  â”‚                  â””â”€datasource<br>â”‚  â”‚  â”‚  â”‚                      â”œâ”€constants<br>â”‚  â”‚  â”‚  â”‚                      â”œâ”€impl<br>â”‚  â”‚  â”‚  â”‚                      â”‚  â”œâ”€derby<br>â”‚  â”‚  â”‚  â”‚                      â”‚  â”œâ”€mysql<br>â”‚  â”‚  â”‚  â”‚                      â”‚  â””â”€postgresqlã€è¿™ä¸ªç›®å½•æ˜¯æ–°å¢çš„ã€‘<br>â”‚  â”‚  â”‚  â”‚                      â”œâ”€mapper<br>â”‚  â”‚  â”‚  â”‚                      â””â”€proxy<br>â”‚  â”‚  â”‚  â””â”€resources<br>â”‚  â”‚  â”‚      â””â”€<span class="hljs-keyword">META</span>-<span class="hljs-keyword">INF</span><br>â”‚  â”‚  â”‚          â””â”€services<br><br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>com.alibaba.nacos.plugin.datasource.impl</code> åŒ…ä¸‹å·²ç»æœ‰çš„ä¸¤ä¸ªå®ç°åŒ…æ˜¯ <code>mysql</code> å’Œ <code>derby</code>, å¯ä»¥æ‹·è´ä¸€ä¸‹ <code>mysql</code> æ•´ä¸ªåŒ…å¤åˆ¶åˆ° <code>mysql</code> åŒçº§ç›®å½•ä¸‹å¹¶ä¸”æ”¹åä¸º <code>postgres</code>, åŒ…é‡Œé¢çš„æ¯ä¸ªç±»çš„åç¼€æ”¹ä¸º <code>Postgres</code>, æ”¹å®Œå <code>postgres</code> ç›®å½•ä¸‹çš„ç±»æœ‰å¦‚ä¸‹ 9 ä¸ª</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ConfigInfoAggrMapperByPostgreSql</span><br><span class="hljs-attribute">ConfigInfoBetaMapperByPostgreSql</span><br><span class="hljs-attribute">ConfigInfoMapperByPostgreSql</span><br><span class="hljs-attribute">ConfigInfoTagMapperByPostgreSql</span><br><span class="hljs-attribute">ConfigTagsRelationMapperByPostgreSql</span><br><span class="hljs-attribute">GroupCapacityMapperByPostgreSql</span><br><span class="hljs-attribute">HistoryConfigInfoMapperByPostgreSql</span><br><span class="hljs-attribute">TenantCapacityMapperByPostgreSql</span><br><span class="hljs-attribute">TenantInfoMapperByPostgreSql</span><br></code></pre></td></tr></table></figure>

<p>è¿›è¡Œä¸Šè¿°æ“ä½œååªæ˜¯å°† <code>mysql</code> ç›®å½•æ•´ä¸ªæ‹·è´äº†ä¸€ä»½ä¿®æ”¹ç›®å½•åå’Œç±»åï¼Œä½†æ˜¯é‡Œé¢çš„å†…å®¹å…¶å®æ²¡æœ‰å˜åŒ–ï¼Œæˆ‘ä»¬ä»¥ <code>ConfigInfoMapperByPostgreSql</code>ï¼ˆmysql ç›®å½•ä¸‹ï¼‰ ä¸ºä¾‹ï¼Œçœ‹çœ‹éœ€è¦ä¿®æ”¹ä»€ä¹ˆå†…å®¹</p>
<figure class="highlight java"><figcaption><span>ConfigInfoMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigInfoAggrMapperByMySql</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigInfoAggrMapper</span> &#123;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findConfigInfoAggrByPageFetchRows</span><span class="hljs-params">(<span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SELECT data_id,group_id,tenant_id,datum_id,app_name,content FROM config_info_aggr WHERE data_id= ? AND &quot;</span><br>                + <span class="hljs-string">&quot;group_id= ? AND tenant_id= ? ORDER BY datum_id LIMIT &quot;</span> + startRow + <span class="hljs-string">&quot;,&quot;</span> + pageSize;  <span class="hljs-comment">// ä¿®æ”¹ç‚¹1</span><br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDataSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> DataSourceConstant.MYSQL;  <span class="hljs-comment">// ä¿®æ”¹ç‚¹2</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>ä¿®æ”¹ç‚¹1</strong><br>è¿™é‡Œçš„ä¿®æ”¹æ˜¯å› ä¸º <code>mysql</code> å’Œ <code>postgres</code> çš„åˆ†é¡µè¯­æ³•ä¸åŒ<br><code>mysql</code> åˆ†é¡µï¼š<code>LIMIT startRow,pageSize</code><br><code>postgres</code> åˆ†é¡µï¼š<code>LIMIT pageSize OFFSET startRow</code></p>
<p><strong>ä¿®æ”¹ç‚¹2</strong><br><code>getDataSource()</code> æ–¹æ³•è¿”å›çš„æ˜¯æ•°æ®æºç±»å‹ï¼Œ<code>mysql</code> ä¸­è¿”å›çš„æ˜¯ <code>DataSourceConstant.MYSQL</code>ï¼Œçœ‹ä¸€ä¸‹ <code>DataSourceConstant</code>ç±»ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConstant</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYSQL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mysql&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DERBY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;derby&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>é»˜è®¤åªæœ‰ä¸¤ä¸ªï¼Œç°åœ¨æ–°å¢ä¸€ä¸ª <code>postgres</code> ç±»å‹ï¼Œå˜æˆ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConstant</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYSQL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mysql&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DERBY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;derby&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">POSTGRESQL</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;postgresql&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸¤å¤„éƒ½ä¿®æ”¹å®Œæˆä¹‹åï¼Œ<code>postgres</code> ç›®å½•ä¸‹å¯¹åº”çš„ <code>ConfigInfoAggrMapperByPostgreSql</code> ç±»ç»è¿‡ä¿®æ”¹åå˜æˆå¦‚ä¸‹å½¢å¼</p>
<figure class="highlight java"><figcaption><span>ConfigInfoAggrMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigInfoAggrMapperByPostgreSql</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigInfoAggrMapper</span> &#123;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findConfigInfoAggrByPageFetchRows</span><span class="hljs-params">(<span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SELECT data_id,group_id,tenant_id,datum_id,app_name,content FROM config_info_aggr WHERE data_id= ? AND &quot;</span><br>                + <span class="hljs-string">&quot;group_id= ? AND tenant_id= ? ORDER BY datum_id LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDataSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> DataSourceConstant.POSTGRESQL;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="æ·»åŠ spiç±»é…ç½®"><a href="#æ·»åŠ spiç±»é…ç½®" class="headerlink" title="æ·»åŠ spiç±»é…ç½®"></a>æ·»åŠ spiç±»é…ç½®</h2><p>ä¸‹é¢ä¼šåˆ—å‡ºä¿®æ”¹åæ‰€æœ‰ <code>postgres</code> ç›®å½•ä¸‹æ‰€æœ‰ç±»ä»£ç ï¼Œä¸è¿‡è¿™é‡Œå…ˆå°†å…¶ä»–éœ€è¦ä¿®æ”¹çš„é…ç½®æ”¹å®Œ</p>
<p>æ‰¾åˆ° <code>plugin/datasource</code> æ¨¡å—ä¸‹ <code>resources/META-INF/services</code> ç›®å½•ï¼Œè¯¥ç›®å½•ä¸‹æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶åä¸º <code>com.alibaba.nacos.plugin.datasource.mapper.Mapper</code><br>å°†å¦‚ä¸‹å†…å®¹æ·»åŠ åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">com<span class="hljs-selector-class">.alibaba</span><span class="hljs-selector-class">.nacos</span><span class="hljs-selector-class">.plugin</span><span class="hljs-selector-class">.datasource</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.postgresql</span><span class="hljs-selector-class">.ConfigInfoAggrMapperByPostgreSql</span><br>com<span class="hljs-selector-class">.alibaba</span><span class="hljs-selector-class">.nacos</span><span class="hljs-selector-class">.plugin</span><span class="hljs-selector-class">.datasource</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.postgresql</span><span class="hljs-selector-class">.ConfigInfoBetaMapperByPostgreSql</span><br>com<span class="hljs-selector-class">.alibaba</span><span class="hljs-selector-class">.nacos</span><span class="hljs-selector-class">.plugin</span><span class="hljs-selector-class">.datasource</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.postgresql</span><span class="hljs-selector-class">.ConfigInfoMapperByPostgreSql</span><br>com<span class="hljs-selector-class">.alibaba</span><span class="hljs-selector-class">.nacos</span><span class="hljs-selector-class">.plugin</span><span class="hljs-selector-class">.datasource</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.postgresql</span><span class="hljs-selector-class">.ConfigInfoTagMapperByPostgreSql</span><br>com<span class="hljs-selector-class">.alibaba</span><span class="hljs-selector-class">.nacos</span><span class="hljs-selector-class">.plugin</span><span class="hljs-selector-class">.datasource</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.postgresql</span><span class="hljs-selector-class">.ConfigTagsRelationMapperByPostgreSql</span><br>com<span class="hljs-selector-class">.alibaba</span><span class="hljs-selector-class">.nacos</span><span class="hljs-selector-class">.plugin</span><span class="hljs-selector-class">.datasource</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.postgresql</span><span class="hljs-selector-class">.HistoryConfigInfoMapperByPostgreSql</span><br>com<span class="hljs-selector-class">.alibaba</span><span class="hljs-selector-class">.nacos</span><span class="hljs-selector-class">.plugin</span><span class="hljs-selector-class">.datasource</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.postgresql</span><span class="hljs-selector-class">.TenantInfoMapperByPostgreSql</span><br>com<span class="hljs-selector-class">.alibaba</span><span class="hljs-selector-class">.nacos</span><span class="hljs-selector-class">.plugin</span><span class="hljs-selector-class">.datasource</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.postgresql</span><span class="hljs-selector-class">.TenantCapacityMapperByPostgreSql</span><br>com<span class="hljs-selector-class">.alibaba</span><span class="hljs-selector-class">.nacos</span><span class="hljs-selector-class">.plugin</span><span class="hljs-selector-class">.datasource</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.postgresql</span>.GroupCapacityMapperByPostgreSql<br></code></pre></td></tr></table></figure>

<h2 id="ä¿®æ”¹-db-é…ç½®"><a href="#ä¿®æ”¹-db-é…ç½®" class="headerlink" title="ä¿®æ”¹ db é…ç½®"></a>ä¿®æ”¹ db é…ç½®</h2><p>åœ¨ <code>console</code> æ¨¡å—ä¸‹çš„ <code>application.properties</code> æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.sql.init.platform</span>=<span class="hljs-string">postgresql</span><br><span class="hljs-attr">db.num</span>=<span class="hljs-string">1</span><br><span class="hljs-attr">&lt;!--</span> <span class="hljs-string">åœ°å€å’Œç”¨æˆ·åå¯†ç æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ --&gt;</span><br><span class="hljs-attr">db.url.0</span>=<span class="hljs-string">jdbc:postgresql://127.0.0.1:5432/nacos</span><br><span class="hljs-attr">db.user.0</span>=<span class="hljs-string">postgres</span><br><span class="hljs-attr">db.password.0</span>=<span class="hljs-string">postgres</span><br><span class="hljs-attr">db.pool.config.driverClassName</span>=<span class="hljs-string">org.postgresql.Driver</span><br></code></pre></td></tr></table></figure>

<h2 id="postgres-ç›®å½•ä¸‹æ‰€æœ‰ç±»"><a href="#postgres-ç›®å½•ä¸‹æ‰€æœ‰ç±»" class="headerlink" title="postgres ç›®å½•ä¸‹æ‰€æœ‰ç±»"></a>postgres ç›®å½•ä¸‹æ‰€æœ‰ç±»</h2><p>ä¸‹é¢å·²ç»è¯´æ˜äº†æ¯ä¸ªç±»éœ€è¦ä¿®æ”¹çš„ç‚¹ï¼Œä¸‹é¢å°±ç»™å‡ºä¿®æ”¹åæ‰€æœ‰ <code>postgres</code> ç›®å½•ä¸‹æ‰€æœ‰ç±»çš„å†…å®¹<br>ConfigInfoAggrMapperByPostgreSqlç±»</p>
<figure class="highlight java"><figcaption><span>ConfigInfoAggrMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigInfoAggrMapperByPostgreSql</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigInfoAggrMapper</span> &#123;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findConfigInfoAggrByPageFetchRows</span><span class="hljs-params">(<span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SELECT data_id,group_id,tenant_id,datum_id,app_name,content FROM config_info_aggr WHERE data_id= ? AND &quot;</span><br>                + <span class="hljs-string">&quot;group_id= ? AND tenant_id= ? ORDER BY datum_id LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDataSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> DataSourceConstant.POSTGRESQL;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ConfigInfoBetaMapperByPostgreSqlç±»</p>
<figure class="highlight java"><figcaption><span>ConfigInfoBetaMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigInfoBetaMapperByPostgreSql</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigInfoBetaMapper</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findAllConfigInfoBetaForDumpAllFetchRows</span><span class="hljs-params">(<span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot; SELECT t.id,data_id,group_id,tenant_id,app_name,content,md5,gmt_modified,beta_ips,encrypted_data_key &quot;</span><br>                + <span class="hljs-string">&quot; FROM ( SELECT id FROM config_info_beta  ORDER BY id LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow + <span class="hljs-string">&quot; )&quot;</span><br>                + <span class="hljs-string">&quot;  g, config_info_beta t WHERE g.id = t.id &quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDataSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> DataSourceConstant.POSTGRESQL;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ConfigInfoMapperByPostgreSqlç±»</p>
<figure class="highlight java"><figcaption><span>ConfigInfoMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigInfoMapperByPostgreSql</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigInfoMapper</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATA_ID</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dataId&quot;</span>;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">GROUP</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;group&quot;</span>;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">APP_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;appName&quot;</span>;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CONTENT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;content&quot;</span>;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TENANT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;tenant&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findConfigInfoByAppFetchRows</span><span class="hljs-params">(<span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SELECT id,data_id,group_id,tenant_id,app_name,content FROM config_info&quot;</span><br>                + <span class="hljs-string">&quot; WHERE tenant_id LIKE ? AND app_name= ?&quot;</span> + <span class="hljs-string">&quot; LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getTenantIdList</span><span class="hljs-params">(<span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SELECT tenant_id FROM config_info WHERE tenant_id != &#x27;&quot;</span> + NamespaceUtil.getNamespaceDefaultId()<br>                + <span class="hljs-string">&quot;&#x27; GROUP BY tenant_id LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getGroupIdList</span><span class="hljs-params">(<span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SELECT group_id FROM config_info WHERE tenant_id =&#x27;&quot;</span> + NamespaceUtil.getNamespaceDefaultId()<br>                + <span class="hljs-string">&quot;&#x27; GROUP BY group_id LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findAllConfigKey</span><span class="hljs-params">(<span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot; SELECT data_id,group_id,app_name  FROM ( &quot;</span><br>                + <span class="hljs-string">&quot; SELECT id FROM config_info WHERE tenant_id LIKE ? ORDER BY id LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow<br>                + <span class="hljs-string">&quot; )&quot;</span> + <span class="hljs-string">&quot; g, config_info t WHERE g.id = t.id  &quot;</span>;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findAllConfigInfoBaseFetchRows</span><span class="hljs-params">(<span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SELECT t.id,data_id,group_id,content,md5&quot;</span><br>                + <span class="hljs-string">&quot; FROM ( SELECT id FROM config_info ORDER BY id LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow + <span class="hljs-string">&quot;  ) &quot;</span><br>                + <span class="hljs-string">&quot; g, config_info t  WHERE g.id = t.id &quot;</span>;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findAllConfigInfoFragment</span><span class="hljs-params">(<span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SELECT id,data_id,group_id,tenant_id,app_name,content,md5,gmt_modified,type,encrypted_data_key &quot;</span><br>                + <span class="hljs-string">&quot;FROM config_info WHERE id &gt; ? ORDER BY id ASC LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findChangeConfigFetchRows</span><span class="hljs-params">(Map&lt;String, String&gt; params, <span class="hljs-keyword">final</span> Timestamp startTime,</span><br><span class="hljs-params">            <span class="hljs-keyword">final</span> Timestamp endTime, <span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize, <span class="hljs-type">long</span> lastMaxId)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">tenant</span> <span class="hljs-operator">=</span> params.get(TENANT);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">dataId</span> <span class="hljs-operator">=</span> params.get(DATA_ID);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> params.get(GROUP);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">appName</span> <span class="hljs-operator">=</span> params.get(APP_NAME);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">tenantTmp</span> <span class="hljs-operator">=</span> StringUtils.isBlank(tenant) ? StringUtils.EMPTY : tenant;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">sqlFetchRows</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SELECT id,data_id,group_id,tenant_id,app_name,content,type,md5,gmt_modified FROM config_info WHERE &quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">where</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot; 1=1 &quot;</span>;<br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(dataId)) &#123;<br>            where += <span class="hljs-string">&quot; AND data_id LIKE ? &quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(group)) &#123;<br>            where += <span class="hljs-string">&quot; AND group_id LIKE ? &quot;</span>;<br>        &#125;<br>        <br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(tenantTmp)) &#123;<br>            where += <span class="hljs-string">&quot; AND tenant_id = ? &quot;</span>;<br>        &#125;<br>        <br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(appName)) &#123;<br>            where += <span class="hljs-string">&quot; AND app_name = ? &quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (startTime != <span class="hljs-literal">null</span>) &#123;<br>            where += <span class="hljs-string">&quot; AND gmt_modified &gt;=? &quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (endTime != <span class="hljs-literal">null</span>) &#123;<br>            where += <span class="hljs-string">&quot; AND gmt_modified &lt;=? &quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> sqlFetchRows + where + <span class="hljs-string">&quot; AND id &gt; &quot;</span> + lastMaxId + <span class="hljs-string">&quot; ORDER BY id ASC&quot;</span> + <span class="hljs-string">&quot; LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset 0 &quot;</span>;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">listGroupKeyMd5ByPageFetchRows</span><span class="hljs-params">(<span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SELECT t.id,data_id,group_id,tenant_id,app_name,md5,type,gmt_modified,encrypted_data_key FROM &quot;</span><br>                + <span class="hljs-string">&quot;( SELECT id FROM config_info ORDER BY id LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow<br>                + <span class="hljs-string">&quot; ) g, config_info t WHERE g.id = t.id&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findConfigInfoBaseLikeFetchRows</span><span class="hljs-params">(Map&lt;String, String&gt; params, <span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">sqlFetchRows</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SELECT id,data_id,group_id,tenant_id,content FROM config_info WHERE &quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">where</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot; 1=1 AND tenant_id=&#x27;&quot;</span> + NamespaceUtil.getNamespaceDefaultId() + <span class="hljs-string">&quot;&#x27; &quot;</span>;<br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(params.get(DATA_ID))) &#123;<br>            where += <span class="hljs-string">&quot; AND data_id LIKE ? &quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(params.get(GROUP))) &#123;<br>            where += <span class="hljs-string">&quot; AND group_id LIKE &quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(params.get(CONTENT))) &#123;<br>            where += <span class="hljs-string">&quot; AND content LIKE ? &quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> sqlFetchRows + where + <span class="hljs-string">&quot; LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findConfigInfo4PageFetchRows</span><span class="hljs-params">(Map&lt;String, String&gt; params, <span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">appName</span> <span class="hljs-operator">=</span> params.get(APP_NAME);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">dataId</span> <span class="hljs-operator">=</span> params.get(DATA_ID);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> params.get(GROUP);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> params.get(CONTENT);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SELECT id,data_id,group_id,tenant_id,app_name,content,type,encrypted_data_key FROM config_info&quot;</span>;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">where</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot; WHERE &quot;</span>);<br>        where.append(<span class="hljs-string">&quot; tenant_id=? &quot;</span>);<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(dataId)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND data_id=? &quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(group)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND group_id=? &quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(appName)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND app_name=? &quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(content)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND content LIKE ? &quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> sql + where + <span class="hljs-string">&quot; LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findConfigInfoBaseByGroupFetchRows</span><span class="hljs-params">(<span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SELECT id,data_id,group_id,content FROM config_info WHERE group_id=? AND tenant_id=?&quot;</span> + <span class="hljs-string">&quot; LIMIT &quot;</span><br>                + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findConfigInfoLike4PageFetchRows</span><span class="hljs-params">(Map&lt;String, String&gt; params, <span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">dataId</span> <span class="hljs-operator">=</span> params.get(DATA_ID);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> params.get(GROUP);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">appName</span> <span class="hljs-operator">=</span> params.get(APP_NAME);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> params.get(CONTENT);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">sqlFetchRows</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SELECT id,data_id,group_id,tenant_id,app_name,content,encrypted_data_key FROM config_info&quot;</span>;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">where</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot; WHERE &quot;</span>);<br>        where.append(<span class="hljs-string">&quot; tenant_id LIKE ? &quot;</span>);<br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(dataId)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND data_id LIKE ? &quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(group)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND group_id LIKE ? &quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(appName)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND app_name = ? &quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(content)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND content LIKE ? &quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> sqlFetchRows + where + <span class="hljs-string">&quot; LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findAllConfigInfoFetchRows</span><span class="hljs-params">(<span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SELECT t.id,data_id,group_id,tenant_id,app_name,content,md5 &quot;</span><br>                + <span class="hljs-string">&quot; FROM (  SELECT id FROM config_info WHERE tenant_id LIKE ? ORDER BY id LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow + <span class="hljs-string">&quot; )&quot;</span><br>                + <span class="hljs-string">&quot; g, config_info t  WHERE g.id = t.id &quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDataSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> DataSourceConstant.POSTGRESQL;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ConfigInfoTagMapperByPostgreSqlç±»</p>
<figure class="highlight java"><figcaption><span>ConfigInfoTagMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigInfoTagMapperByPostgreSql</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigInfoTagMapper</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findAllConfigInfoTagForDumpAllFetchRows</span><span class="hljs-params">(<span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot; SELECT t.id,data_id,group_id,tenant_id,tag_id,app_name,content,md5,gmt_modified &quot;</span><br>                + <span class="hljs-string">&quot; FROM (  SELECT id FROM config_info_tag  ORDER BY id LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow + <span class="hljs-string">&quot; ) &quot;</span><br>                + <span class="hljs-string">&quot;g, config_info_tag t  WHERE g.id = t.id  &quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDataSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> DataSourceConstant.POSTGRESQL;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ConfigTagsRelationMapperByPostgreSqlç±»</p>
<figure class="highlight java"><figcaption><span>ConfigTagsRelationMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigTagsRelationMapperByPostgreSql</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigTagsRelationMapper</span> &#123;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findConfigInfo4PageFetchRows</span><span class="hljs-params">(Map&lt;String, String&gt; params, <span class="hljs-type">int</span> tagSize, <span class="hljs-type">int</span> startRow, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">appName</span> <span class="hljs-operator">=</span> params.get(<span class="hljs-string">&quot;appName&quot;</span>);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">dataId</span> <span class="hljs-operator">=</span> params.get(<span class="hljs-string">&quot;dataId&quot;</span>);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> params.get(<span class="hljs-string">&quot;group&quot;</span>);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> params.get(<span class="hljs-string">&quot;content&quot;</span>);<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">where</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot; WHERE &quot;</span>);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span><br>                <span class="hljs-string">&quot;SELECT a.id,a.data_id,a.group_id,a.tenant_id,a.app_name,a.content FROM config_info  a LEFT JOIN &quot;</span><br>                        + <span class="hljs-string">&quot;config_tags_relation b ON a.id=b.id&quot;</span>;<br>        <br>        where.append(<span class="hljs-string">&quot; a.tenant_id=? &quot;</span>);<br>        <br>        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(dataId)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND a.data_id=? &quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(group)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND a.group_id=? &quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(appName)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND a.app_name=? &quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(content)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND a.content LIKE ? &quot;</span>);<br>        &#125;<br>        where.append(<span class="hljs-string">&quot; AND b.tag_name IN (&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; tagSize; i++) &#123;<br>            <span class="hljs-keyword">if</span> (i != <span class="hljs-number">0</span>) &#123;<br>                where.append(<span class="hljs-string">&quot;, &quot;</span>);<br>            &#125;<br>            where.append(<span class="hljs-string">&#x27;?&#x27;</span>);<br>        &#125;<br>        where.append(<span class="hljs-string">&quot;) &quot;</span>);<br>        <span class="hljs-keyword">return</span> sql + where + <span class="hljs-string">&quot; LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findConfigInfoLike4PageFetchRows</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Map&lt;String, String&gt; params, <span class="hljs-type">int</span> tagSize, <span class="hljs-type">int</span> startRow,</span><br><span class="hljs-params">            <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">appName</span> <span class="hljs-operator">=</span> params.get(<span class="hljs-string">&quot;appName&quot;</span>);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> params.get(<span class="hljs-string">&quot;content&quot;</span>);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">dataId</span> <span class="hljs-operator">=</span> params.get(<span class="hljs-string">&quot;dataId&quot;</span>);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> params.get(<span class="hljs-string">&quot;group&quot;</span>);<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">where</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot; WHERE &quot;</span>);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">sqlFetchRows</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SELECT a.id,a.data_id,a.group_id,a.tenant_id,a.app_name,a.content &quot;</span><br>                + <span class="hljs-string">&quot;FROM config_info a LEFT JOIN config_tags_relation b ON a.id=b.id &quot;</span>;<br>        <br>        where.append(<span class="hljs-string">&quot; a.tenant_id LIKE ? &quot;</span>);<br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(dataId)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND a.data_id LIKE ? &quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(group)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND a.group_id LIKE ? &quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(appName)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND a.app_name = ? &quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(content)) &#123;<br>            where.append(<span class="hljs-string">&quot; AND a.content LIKE ? &quot;</span>);<br>        &#125;<br>        <br>        where.append(<span class="hljs-string">&quot; AND b.tag_name IN (&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; tagSize; i++) &#123;<br>            <span class="hljs-keyword">if</span> (i != <span class="hljs-number">0</span>) &#123;<br>                where.append(<span class="hljs-string">&quot;, &quot;</span>);<br>            &#125;<br>            where.append(<span class="hljs-string">&#x27;?&#x27;</span>);<br>        &#125;<br>        where.append(<span class="hljs-string">&quot;) &quot;</span>);<br>        <span class="hljs-keyword">return</span> sqlFetchRows + where + <span class="hljs-string">&quot; LIMIT &quot;</span> + pageSize + <span class="hljs-string">&quot; offset &quot;</span> + startRow;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDataSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> DataSourceConstant.POSTGRESQL;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>GroupCapacityMapperByPostgreSqlç±»</p>
<figure class="highlight java"><figcaption><span>GroupCapacityMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GroupCapacityMapperByPostgreSql</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GroupCapacityMapper</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDataSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> DataSourceConstant.POSTGRESQL;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">selectGroupInfoBySize</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SELECT id, group_id FROM group_capacity WHERE id &gt; ? LIMIT ?&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>HistoryConfigInfoMapperByPostgreSqlç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HistoryConfigInfoMapperByPostgreSql</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HistoryConfigInfoMapper</span> &#123;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">removeConfigHistory</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;DELETE FROM his_config_info WHERE gmt_modified &lt; ? LIMIT ?&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">pageFindConfigHistoryFetchRows</span><span class="hljs-params">(<span class="hljs-type">int</span> pageNo, <span class="hljs-type">int</span> pageSize)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> (pageNo - <span class="hljs-number">1</span>) * pageSize;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">limit</span> <span class="hljs-operator">=</span> pageSize;<br>        <span class="hljs-keyword">return</span>  <span class="hljs-string">&quot;SELECT nid,data_id,group_id,tenant_id,app_name,src_ip,src_user,op_type,gmt_create,gmt_modified FROM his_config_info &quot;</span><br>                + <span class="hljs-string">&quot;WHERE data_id = ? AND group_id = ? AND tenant_id = ? ORDER BY nid DESC  LIMIT &quot;</span> + limit + <span class="hljs-string">&quot; offset &quot;</span> + offset;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDataSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> DataSourceConstant.POSTGRESQL;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>TenantCapacityMapperByPostgreSqlç±»</p>
<figure class="highlight java"><figcaption><span>TenantCapacityMapperByPostgreSqlç±»</span></figcaption><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TenantCapacityMapperByPostgreSql</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TenantCapacityMapper</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDataSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> DataSourceConstant.POSTGRESQL;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCapacityList4CorrectUsage</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SELECT id, tenant_id FROM tenant_capacity WHERE id&gt;? LIMIT ?&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>TenantInfoMapperByPostgreSqlç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TenantInfoMapperByPostgreSql</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TenantInfoMapper</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDataSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> DataSourceConstant.POSTGRESQL;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>nacos</category>
      </categories>
      <tags>
        <tag>nacos</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨mavenç¼–è¯‘nacos2.2.3æºç </title>
    <url>/2023/235410d42872/index.html</url>
    <content><![CDATA[<p>ä½¿ç”¨ <code>maven</code> å‘½ä»¤è¿›å…¥ <code>nacos</code> æ ¹ç›®å½•ç¼–è¯‘</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">mvn clean install -DskipTests<br></code></pre></td></tr></table></figure>

<p>å‡ºç°</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">Execution pmd of goal org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.maven</span><span class="hljs-selector-class">.plugins</span>:maven-pmd-plugin:<span class="hljs-number">3.8</span>:pmd failed: org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.maven</span><span class="hljs-selector-class">.reporting</span><span class="hljs-selector-class">.MavenReportException</span>:<br> Unsupported targetJdk value <span class="hljs-string">&#x27;11&#x27;</span>. <br></code></pre></td></tr></table></figure>
<p>é”™è¯¯ï¼Œè¿™æ˜¯å› ä¸ºå¢åŠ äº† <code>pmd</code> æ ¡éªŒï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤è·³è¿‡æ ¡éªŒ</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><code class="hljs ada">mvn clean install &#x27;-DskipTests<span class="hljs-string">&#x27; &#x27;</span>-Dpmd.skip=<span class="hljs-literal">true</span><span class="hljs-string">&#x27; &#x27;</span>-Dcheckstyle.skip=<span class="hljs-literal">true</span>&#x27;<br></code></pre></td></tr></table></figure>

<p>å‡ºç° </p>
<figure class="highlight smali"><table><tr><td class="code"><pre><code class="hljs smali">[ERROR] Failed to<span class="hljs-built_in"> execute </span>goal org.apache.maven.plugins:maven-compiler-plugin:3.5.1:testCompile (default-testCompile) on project nacos-config: Compilation failure<br>[ERROR] /D:/code/nacos/config/src/test/java/com/alibaba/nacos/config/server/utils/ResponseUtilTest.java:[28,29] ç¨‹åºåŒ… sun.security.action ä¸å¯è§<br>[ERROR]   (ç¨‹åºåŒ… sun.security.action å·²åœ¨æ¨¡å— java.base ä¸­å£°æ˜, ä½†è¯¥æ¨¡å—æœªå°†å®ƒå¯¼å‡ºåˆ°æœªå‘½åæ¨¡å—)<br></code></pre></td></tr></table></figure>
<p>é”™è¯¯ï¼Œè§£å†³æ–¹å¼æ˜¯åœ¨ <code>maven-compiler-plugin</code> é…ç½®ä¸­æ·»åŠ  <code>--add-exports=java.base/sun.security.action=ALL-UNNAMED</code> å‚æ•°ï¼Œå…·ä½“é…ç½®ä¸ºåœ¨æ ¹ç›®å½•ä¸‹çš„ <code>pom.xml</code> ä¸­æ·»åŠ ä¸‹é¢ä»£ç </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"> <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;maven-compiler-plugin.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>$&#123;maven.compiler.source&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>$&#123;maven.compiler.target&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">compilerVersion</span>&gt;</span>$&#123;maven.compiler.source&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">compilerVersion</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">showDeprecation</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">showDeprecation</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">showWarnings</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">showWarnings</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- ä¸‹é¢è¿™ä¸€æ®µæ–°æ·»åŠ çš„ç”¨äºè§£å†³ç¼–è¯‘é”™è¯¯çš„å…³é”® --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">compilerArgs</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">arg</span>&gt;</span>--add-exports=java.base/sun.security.action=ALL-UNNAMED<span class="hljs-tag">&lt;/<span class="hljs-name">arg</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">compilerArgs</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼š å› ä¸ºæç¤ºå‡ºç°é”™è¯¯çš„åŒ…æ˜¯ <code>sun.security.action</code>ï¼Œ æ‰€ä»¥æ·»åŠ çš„æ—¶å€™æ‰æ·»åŠ  <code>java.base/sun.security.action</code>ï¼Œ å¦‚æœæç¤ºçš„æ˜¯å…¶ä»–åŒ…ï¼Œåˆ™éœ€è¦å¯¹åº”ä¿®æ”¹</p>
<h2 id="æœ€ç»ˆæ‰“åŒ…å‘½ä»¤"><a href="#æœ€ç»ˆæ‰“åŒ…å‘½ä»¤" class="headerlink" title="æœ€ç»ˆæ‰“åŒ…å‘½ä»¤"></a>æœ€ç»ˆæ‰“åŒ…å‘½ä»¤</h2><p>æœ€ç»ˆæ‰“åŒ…éœ€è¦é€‰æ‹© profileï¼Œ è¿™ä¸ª profile åœ¨ <code>nacos-console</code> æ¨¡å—çš„ <code>pom.xml</code> æ–‡ä»¶ä¸­å·²ç»å†™äº†æ˜¯  <code>release-nacos</code>ï¼Œ æ‰€ä»¥æœ€ç»ˆæ‰“åŒ…å‘½ä»¤æ˜¯</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><code class="hljs ada">mvn clean install &#x27;-DskipTests=<span class="hljs-literal">true</span><span class="hljs-string">&#x27; &#x27;</span>-Dpmd.skip=<span class="hljs-literal">true</span><span class="hljs-string">&#x27; &#x27;</span>-Dcheckstyle.skip=<span class="hljs-literal">true</span>&#x27; -Prelease-nacos<br></code></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>nacos</category>
      </categories>
      <tags>
        <tag>nacos</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQ4ä¸­Nameserverè¯¦è§£</title>
    <url>/2023/e17cf930f952/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<blockquote>
<p>RocketMQç‰ˆæœ¬ï¼š 4.9.7<br>JDKç‰ˆæœ¬ï¼š 17</p>
</blockquote>
<h2 id="Nameserver-åœ¨-RocketMQ-æ•´ä½“æ¶æ„ä¸­çš„ä½œç”¨"><a href="#Nameserver-åœ¨-RocketMQ-æ•´ä½“æ¶æ„ä¸­çš„ä½œç”¨" class="headerlink" title="Nameserver åœ¨ RocketMQ æ•´ä½“æ¶æ„ä¸­çš„ä½œç”¨"></a>Nameserver åœ¨ RocketMQ æ•´ä½“æ¶æ„ä¸­çš„ä½œç”¨</h2><p>ä¸€å¥è¯æè¿°ï¼š<code>Nameserver</code> å°±ç›¸å½“äºæ˜¯ <code>RocketMQ</code> ä¸­çš„æ³¨å†Œä¸­å¿ƒï¼Œ <code>Broker</code> ä¼šå°†è‡ªèº«ä¿¡æ¯æ³¨å†Œåˆ° <code>Nameserver</code> ä¸­ï¼Œ<code>Producer</code> å’Œ <code>Consumer</code> ä¼šä» <code>Nameserver</code> ä¸­ä¸æ–­è·å– <code>Broker</code> ç›¸å…³ä¿¡æ¯</p>
<h2 id="ä»ä»£ç å±‚é¢æ¥çœ‹-Nameserver-çš„åŠŸèƒ½"><a href="#ä»ä»£ç å±‚é¢æ¥çœ‹-Nameserver-çš„åŠŸèƒ½" class="headerlink" title="ä»ä»£ç å±‚é¢æ¥çœ‹ Nameserver çš„åŠŸèƒ½"></a>ä»ä»£ç å±‚é¢æ¥çœ‹ Nameserver çš„åŠŸèƒ½</h2><p>æ€»ç»“ï¼š<code>Nameserver</code> ä¸»è¦å®Œæˆä¸¤ä»¶äº‹æƒ…</p>
<ol>
<li>ä½œä¸º <code>NettyServer</code> æ¥æ”¶ç½‘ç»œè¯·æ±‚, å› ä¸ºå¯¹äº <code>Produer</code>, <code>Consumer</code>, <code>Broker</code> è€Œè¨€ï¼Œ<code>Nameserver</code> å°±æ˜¯æœåŠ¡ç«¯ï¼Œå®ƒä»¬ä¹‹é—´çš„é€šä¿¡æ˜¯é€šè¿‡ <code>Netty</code> å®ç°</li>
<li>å¤„ç†æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œæ¯”å¦‚æ›´æ–° <code>Broker</code> ä¿¡æ¯ï¼Œè·å– <code>Broker</code> ä¿¡æ¯ç­‰</li>
</ol>
<h2 id="Nameserver-çš„å¯åŠ¨æµç¨‹"><a href="#Nameserver-çš„å¯åŠ¨æµç¨‹" class="headerlink" title="Nameserver çš„å¯åŠ¨æµç¨‹"></a>Nameserver çš„å¯åŠ¨æµç¨‹</h2><pre class="mermaid">graph TB
    subgraph ONE["createNamesrvControlle åˆ›å»º NamesrvController"]
        A1["è§£æå‘½ä»¤è¡Œå‚æ•°
        å˜æˆ CommandLine"]
        A2["æ ¹æ®è§£æçš„å‚æ•°
        è®¾ç½® NamesrvConfig å’Œ
        NettyServerConfig"]
        A3["å®ä¾‹åŒ– NamesrvController "]
        A1-->A2-->A3
    end
    subgraph TWO["NamesrvController.initialize åˆå§‹åŒ– NamesrvController"]
        B1["åŠ è½½ KVConfig é…ç½®"]
        B2["åˆå§‹åŒ– NettyRemotingServer "]
        B3["æ³¨å†Œ DefaultRequestProcessor å¤„ç†å™¨"]
        B4["å¯åŠ¨å®šæ—¶ä»»åŠ¡
        æ¸…ç†ä¸‹çº¿çš„ Broker "]
        B1-->B2-->B3-->B4
    end
    subgraph THREE["NamesrvController.start å¯åŠ¨ NamesrvController"]
        C1["å¯åŠ¨ Nettry æœåŠ¡
        NettyRemotingServer.start()"]
    end
    ONE-->TWO-->THREE</pre>

<p><code>Nameserver</code> æ•´ä½“ä»£ç (åªå±•ç¤ºéƒ¨åˆ†é‡ç‚¹ä»£ç )</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NamesrvStartup</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> InternalLogger log;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">CommandLine</span> <span class="hljs-variable">commandLine</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        main0(args);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NamesrvController <span class="hljs-title function_">main0</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// åˆ›å»º NamesrvController</span><br>        <span class="hljs-type">NamesrvController</span> <span class="hljs-variable">controller</span> <span class="hljs-operator">=</span> createNamesrvController(args);<br>        start(controller);<br>        <span class="hljs-keyword">return</span> controller;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NamesrvController <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-keyword">final</span> NamesrvController controller)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// åˆå§‹åŒ– NamesrvController</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">initResult</span> <span class="hljs-operator">=</span> controller.initialize();<br>        <span class="hljs-keyword">if</span> (!initResult) &#123;<br>            controller.shutdown();<br>            System.exit(-<span class="hljs-number">3</span>);<br>        &#125;<br><br>        Runtime.getRuntime().addShutdownHook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ShutdownHookThread</span>(log, (Callable&lt;Void&gt;) () -&gt; &#123;<br>            controller.shutdown();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;));<br>        <span class="hljs-comment">// å¯åŠ¨ NamesrvController</span><br>        controller.start();<br>        <span class="hljs-keyword">return</span> controller;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="é…ç½®è§£æ"><a href="#é…ç½®è§£æ" class="headerlink" title="é…ç½®è§£æ"></a>é…ç½®è§£æ</h3><ol>
<li>é…ç½®è§£æä¸»è¦é€»è¾‘å°±æ˜¯å°† å‘½ä»¤è¡Œå‚æ•°è¯»å–å‡ºæ¥è§£ææˆ <code>CommandLine</code> å¯¹è±¡</li>
<li>åˆ¤æ–­é€‰é¡¹ä¸­æ˜¯å¦åŒ…å« <code>-c</code> é€‰é¡¹( <code>-c</code> æ˜¯ç”¨æ¥æŒ‡å®šé…ç½®æ–‡ä»¶çš„ )ï¼Œ è‹¥åŒ…å«ï¼Œåˆ™éœ€è¦è¯»å–æ–‡ä»¶å†…å®¹åˆ° <code>Properties</code> ä¸­</li>
<li>å°†æ‰€æœ‰é…ç½®ä¿¡æ¯è®¾ç½®åˆ° <code>NamesrvConfig</code> å’Œ <code>NettyServerConfig</code> ä¸­ï¼Œè®¾ç½®çš„æ–¹å¼å°±æ˜¯é€šè¿‡åå°„è·å–è¿™ä¸¤ä¸ªå¯¹è±¡çš„ <code>set</code> æ–¹æ³•ï¼Œç„¶åå°†è·å–çš„å±æ€§å’Œé…ç½®ä¸­çš„ <code>key</code> è¿›è¡Œå¯¹æ¯”ï¼Œç›¸åŒåˆ™è®¾ç½®å€¼</li>
</ol>
<h3 id="æ³¨å†Œ-DefaultRequestProcessor-å¤„ç†å™¨ï¼ˆé‡ç‚¹ï¼‰"><a href="#æ³¨å†Œ-DefaultRequestProcessor-å¤„ç†å™¨ï¼ˆé‡ç‚¹ï¼‰" class="headerlink" title="æ³¨å†Œ DefaultRequestProcessor å¤„ç†å™¨ï¼ˆé‡ç‚¹ï¼‰"></a>æ³¨å†Œ DefaultRequestProcessor å¤„ç†å™¨ï¼ˆé‡ç‚¹ï¼‰</h3><p><code>Nameserver</code> éœ€è¦å’Œ <code>RocketMQ</code> ä¸­å…¶ä»–ç»„ä»¶é€šä¿¡ï¼Œä¹Ÿå°±æ˜¯éœ€è¦å¤„ç†å„ç§è¯·æ±‚ï¼Œè¿™äº›è¯·æ±‚æœ€ç»ˆéƒ½æ˜¯é€šè¿‡ <code>DefaultRequestProcessor</code> è¿›è¡Œå¤„ç†çš„ï¼Œ æ¥ä¸‹æ¥å°±æ˜¯çœ‹ <code>DefaultRequestProcessor</code> çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultRequestProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AsyncNettyRequestProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NettyRequestProcessor</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">InternalLogger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> InternalLoggerFactory.getLogger(LoggerName.NAMESRV_LOGGER_NAME);<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> NamesrvController namesrvController;<br><br>    <span class="hljs-comment">// åˆ›å»º DefaultRequestProcessor çš„æ—¶å€™ä¼šå°† NamesrvController ä¼ å…¥</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultRequestProcessor</span><span class="hljs-params">(NamesrvController namesrvController)</span> &#123;<br>        <span class="hljs-built_in">this</span>.namesrvController = namesrvController;<br>    &#125;<br><br>    <span class="hljs-comment">// è¿™é‡Œå°±æ˜¯æ ¸å¿ƒçš„é€»è¾‘ï¼ŒNameserver å¯ä»¥å¤„ç†å“ªäº›è¯·æ±‚è¿™é‡Œéƒ½æœ‰åˆ—ä¸¾å‡ºæ¥</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> RemotingCommand <span class="hljs-title function_">processRequest</span><span class="hljs-params">(ChannelHandlerContext ctx,</span><br><span class="hljs-params">        RemotingCommand request)</span> <span class="hljs-keyword">throws</span> RemotingCommandException &#123;<br>        <span class="hljs-keyword">switch</span> (request.getCode()) &#123;<br>            <span class="hljs-keyword">case</span> RequestCode.PUT_KV_CONFIG:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.putKVConfig(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.GET_KV_CONFIG:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getKVConfig(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.DELETE_KV_CONFIG:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.deleteKVConfig(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.QUERY_DATA_VERSION:<br>                <span class="hljs-keyword">return</span> queryBrokerTopicConfig(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.REGISTER_BROKER:<br>                <span class="hljs-type">Version</span> <span class="hljs-variable">brokerVersion</span> <span class="hljs-operator">=</span> MQVersion.value2Version(request.getVersion());<br>                <span class="hljs-keyword">if</span> (brokerVersion.ordinal() &gt;= MQVersion.Version.V3_0_11.ordinal()) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.registerBrokerWithFilterServer(ctx, request);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.registerBroker(ctx, request);<br>                &#125;<br>            <span class="hljs-keyword">case</span> RequestCode.UNREGISTER_BROKER:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.unregisterBroker(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.GET_ROUTEINFO_BY_TOPIC:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getRouteInfoByTopic(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.GET_BROKER_CLUSTER_INFO:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getBrokerClusterInfo(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.WIPE_WRITE_PERM_OF_BROKER:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.wipeWritePermOfBroker(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.ADD_WRITE_PERM_OF_BROKER:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.addWritePermOfBroker(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.GET_ALL_TOPIC_LIST_FROM_NAMESERVER:<br>                <span class="hljs-keyword">return</span> getAllTopicListFromNameserver(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.DELETE_TOPIC_IN_NAMESRV:<br>                <span class="hljs-keyword">return</span> deleteTopicInNamesrv(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.GET_KVLIST_BY_NAMESPACE:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getKVListByNamespace(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.GET_TOPICS_BY_CLUSTER:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getTopicsByCluster(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.GET_SYSTEM_TOPIC_LIST_FROM_NS:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getSystemTopicListFromNs(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.GET_UNIT_TOPIC_LIST:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getUnitTopicList(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.GET_HAS_UNIT_SUB_TOPIC_LIST:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getHasUnitSubTopicList(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getHasUnitSubUnUnitTopicList(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.UPDATE_NAMESRV_CONFIG:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.updateConfig(ctx, request);<br>            <span class="hljs-keyword">case</span> RequestCode.GET_NAMESRV_CONFIG:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getConfig(ctx, request);<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥æ ¹æ®å®é™…åœºæ™¯çœ‹ä¸‹ç‰¹å®šè¯·æ±‚çš„å®ç°é€»è¾‘</p>
<h4 id="åœºæ™¯1ï¼šBroker-æ³¨å†Œåˆ°-NameServer-RequestCode-REGISTER-BROKER"><a href="#åœºæ™¯1ï¼šBroker-æ³¨å†Œåˆ°-NameServer-RequestCode-REGISTER-BROKER" class="headerlink" title="åœºæ™¯1ï¼šBroker æ³¨å†Œåˆ° NameServer (RequestCode.REGISTER_BROKER)"></a>åœºæ™¯1ï¼šBroker æ³¨å†Œåˆ° NameServer (RequestCode.REGISTER_BROKER)</h4><p>åœ¨ <code>NameServer</code> ä¸­å¤„ç† <code>Broker</code> æ³¨å†Œå’Œä¿å­˜ <code>Broker</code>ï¼Œ<code>Topic</code>, <code>Queue</code> ç›¸å…³æ•°æ®çš„ç±»æ˜¯ <code>RouteInfoManager</code>, çœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„å‡ ä¸ªå±æ€§</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RouteInfoManager</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">BROKER_CHANNEL_EXPIRED_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReadWriteLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();<br>    <span class="hljs-comment">// è®°å½• topicï¼Œbroker, queue çš„å…³ç³»</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;String<span class="hljs-comment">/* topic */</span>, Map&lt;String <span class="hljs-comment">/* brokerName */</span> , QueueData&gt;&gt; topicQueueTable;<br>    <span class="hljs-comment">// è®°å½• broker çš„åœ°å€</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;String<span class="hljs-comment">/* brokerName */</span>, BrokerData&gt; brokerAddrTable;<br>    <span class="hljs-comment">// è®°å½•æ¯ä¸ªé›†ç¾¤ä¸­ broker çš„åç§°</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;String<span class="hljs-comment">/* clusterName */</span>, Set&lt;String<span class="hljs-comment">/* brokerName */</span>&gt;&gt; clusterAddrTable;<br>    <span class="hljs-comment">// è®°å½•å­˜æ´»çš„broker åˆ—è¡¨ï¼Œ brokerAddr æ˜¯ç±»ä¼¼ 192.168.0.100:10911 è¿™æ ·çš„å€¼</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;String<span class="hljs-comment">/* brokerAddr */</span>, BrokerLiveInfo&gt; brokerLiveTable;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;String<span class="hljs-comment">/* brokerAddr */</span>, List&lt;String&gt;<span class="hljs-comment">/* Filter Server */</span>&gt; filterServerTable;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>çŸ¥é“äº† <code>RouteInfoManager</code> ç±»é‡è¦çš„å±æ€§ï¼Œæ¥ä¸‹æ¥å…ˆç»™å‡ºæ³¨å†Œçš„ç»“è®ºç„¶åå†å»çœ‹æ³¨å†Œçš„é€»è¾‘<br><strong>æ³¨å†Œæµç¨‹æ€»ç»“</strong></p>
<pre class="mermaid">graph LR
    A["è§£æè¯·æ±‚å¤´ï¼Œè·å–
    Broker ç›¸å…³æ•°æ®"]
    B["è§£æè¯·æ±‚ä½“ï¼Œè·å–
    Topic ç›¸å…³æ•°æ®"]
    C["æ³¨å†Œ Broker ç›¸å…³æ•°æ®"]
    D["æ³¨å†Œ Topic ç›¸å…³æ•°æ®"]
    A-->B-->C-->D</pre>


<ul>
<li>æ ¹æ® <code>RemotingCommand</code> è¯·æ±‚æŒ‡ä»¤è§£æå‡º <code>RegisterBrokerRequestHeader</code>ï¼Œ è¿™ä¸ªä¸»è¦æ˜¯ä»è¯·æ±‚ä¸­è·å– <code>BrokerName</code>, <code>BrokerAddr</code>, <code>BrokerId</code> ç­‰ä¿¡æ¯ï¼Œè¿™ä¸ªæ˜¯è·å–<strong>è¯·æ±‚å¤´</strong>çš„æ•°æ®</li>
<li>æ ¹æ® <code>RemotingCommand</code> è¯·æ±‚æŒ‡ä»¤è§£æå‡º <code>RegisterBrokerBody</code>ï¼Œ è¿™ä¸ªå°±æ˜¯è¦è·å– <strong>è¯·æ±‚ä½“</strong> çš„æ•°æ®äº†ï¼Œä¸»è¦æ˜¯è·å– <code>ConcurrentMap&lt;String, TopicConfig&gt; topicConfigTable =new ConcurrentHashMap&lt;String, TopicConfig&gt;()</code>ï¼Œ ä¹Ÿå°±æ˜¯ <code>Topic</code> ç›¸å…³çš„æ•°æ®</li>
<li>è¯·æ±‚ä¸­çš„æ•°æ®éƒ½æ‹¿å‡ºæ¥äº†ï¼Œå°±éœ€è¦è°ƒç”¨ <code>RouteInfoManager.registerBroker()</code> æ–¹æ³•å°†è¿™äº›æ•°æ®æ”¾å…¥ <code>RouteInfoManager</code> ç±»çš„ç›¸å…³å±æ€§ä¸­äº†ï¼Œæ³¨å†Œä¹Ÿæ˜¯åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†<ul>
<li>æ³¨å†Œ <code>Broker</code> ç›¸å…³æ•°æ®</li>
<li>æ³¨å†Œ <code>Topic</code> ç›¸å…³æ•°æ®</li>
</ul>
</li>
</ul>
<p><strong>æ³¨å†Œæµç¨‹ä»£ç ï¼ˆä¸‹é¢ä»£ç åªå±•ç¤ºäº†æ–¹æ³•ä¸­ä¸æ³¨å†Œç›¸å…³çš„ä»£ç ï¼‰</strong><br><code>DefaultRequestProcessor</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> RemotingCommand <span class="hljs-title function_">processRequest</span><span class="hljs-params">(ChannelHandlerContext ctx,</span><br><span class="hljs-params">    RemotingCommand request)</span> <span class="hljs-keyword">throws</span> RemotingCommandException &#123;<br>    <span class="hljs-keyword">switch</span> (request.getCode()) &#123;<br>        <span class="hljs-keyword">case</span> RequestCode.REGISTER_BROKER:<br>            <span class="hljs-type">Version</span> <span class="hljs-variable">brokerVersion</span> <span class="hljs-operator">=</span> MQVersion.value2Version(request.getVersion());<br>            <span class="hljs-keyword">if</span> (brokerVersion.ordinal() &gt;= MQVersion.Version.V3_0_11.ordinal()) &#123;<br>                <span class="hljs-comment">// ä½¿ç”¨çš„ RocketMQ4.9.7 ç‰ˆæœ¬ä¼šæ˜¯èµ°è¿™ä¸ªé€»è¾‘</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.registerBrokerWithFilterServer(ctx, request);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.registerBroker(ctx, request);<br>            &#125;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> RemotingCommand <span class="hljs-title function_">registerBrokerWithFilterServer</span><span class="hljs-params">(ChannelHandlerContext ctx, RemotingCommand request)</span><br>        <span class="hljs-keyword">throws</span> RemotingCommandException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">RemotingCommand</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> RemotingCommand.createResponseCommand(RegisterBrokerResponseHeader.class);<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">RegisterBrokerResponseHeader</span> <span class="hljs-variable">responseHeader</span> <span class="hljs-operator">=</span> (RegisterBrokerResponseHeader) response.readCustomHeader();<br>    <span class="hljs-comment">// è·å–è¯·æ±‚å¤´çš„æ•°æ®ï¼Œä¸»è¦æ˜¯è·å– BrokerName, BrokerAddr, BrokerId ç­‰æ•°æ®</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">RegisterBrokerRequestHeader</span> <span class="hljs-variable">requestHeader</span> <span class="hljs-operator">=</span><br>        (RegisterBrokerRequestHeader) request.decodeCommandCustomHeader(RegisterBrokerRequestHeader.class);<br><br>    <span class="hljs-keyword">if</span> (!checksum(ctx, request, requestHeader)) &#123;<br>        response.setCode(ResponseCode.SYSTEM_ERROR);<br>        response.setRemark(<span class="hljs-string">&quot;crc32 not match&quot;</span>);<br>        <span class="hljs-keyword">return</span> response;<br>    &#125;<br><br>    <span class="hljs-type">RegisterBrokerBody</span> <span class="hljs-variable">registerBrokerBody</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegisterBrokerBody</span>();<br><br>    <span class="hljs-keyword">if</span> (request.getBody() != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// è·å–è¯·æ±‚ä½“çš„æ•°æ®ï¼Œä¸»è¦æ˜¯è·å– Topic ç›¸å…³çš„æ•°æ®</span><br>            registerBrokerBody = RegisterBrokerBody.decode(request.getBody(), requestHeader.isCompressed());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemotingCommandException</span>(<span class="hljs-string">&quot;Failed to decode RegisterBrokerBody&quot;</span>, e);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        registerBrokerBody.getTopicConfigSerializeWrapper().getDataVersion().setCounter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>));<br>        registerBrokerBody.getTopicConfigSerializeWrapper().getDataVersion().setTimestamp(<span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// è¿™é‡Œå°±æ˜¯å°†è¯·æ±‚ä¸­çš„æ•°æ®è·å–å‡ºæ¥åè¿›è¡Œæ³¨å†Œ(æ‰€è°“çš„æ³¨å†Œå°±æ˜¯å°†è¿™äº›ä¿¡æ¯ä¿å­˜åœ¨å†…å­˜ä¸­)</span><br>    <span class="hljs-comment">// ã€é‡ç‚¹ä»£ç 1ã€‘</span><br>    <span class="hljs-type">RegisterBrokerResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.namesrvController.getRouteInfoManager().registerBroker(<br>        requestHeader.getClusterName(),<br>        requestHeader.getBrokerAddr(),<br>        requestHeader.getBrokerName(),<br>        requestHeader.getBrokerId(),<br>        requestHeader.getHaServerAddr(),<br>        registerBrokerBody.getTopicConfigSerializeWrapper(),<br>        registerBrokerBody.getFilterServerList(),<br>        ctx.channel());<br><br>    responseHeader.setHaServerAddr(result.getHaServerAddr());<br>    responseHeader.setMasterAddr(result.getMasterAddr());<br><br>    <span class="hljs-type">byte</span>[] jsonValue = <span class="hljs-built_in">this</span>.namesrvController.getKvConfigManager().getKVListByNamespace(NamesrvUtil.NAMESPACE_ORDER_TOPIC_CONFIG);<br>    response.setBody(jsonValue);<br><br>    response.setCode(ResponseCode.SUCCESS);<br>    response.setRemark(<span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">return</span> response;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°± <strong>ã€é‡ç‚¹ä»£ç 1ã€‘</strong>ï¼Œ å³å°†è§£æå‡ºæ¥çš„è¯·æ±‚ä¸­çš„æ•°æ®ä¿å­˜åœ¨ <code>RouteInfoManager</code> ç±»çš„ç›¸å…³å±æ€§ä¸­çš„é€»è¾‘</p>
<p><code>RouteInfoManager</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> RegisterBrokerResult <span class="hljs-title function_">registerBroker</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> String clusterName,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> String brokerAddr,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> String brokerName,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> brokerId,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> String haServerAddr,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> TopicConfigSerializeWrapper topicConfigWrapper,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> List&lt;String&gt; filterServerList,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> Channel channel)</span> &#123;<br>    <span class="hljs-type">RegisterBrokerResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegisterBrokerResult</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.lock.writeLock().lockInterruptibly();<br><br>            Set&lt;String&gt; brokerNames = <span class="hljs-built_in">this</span>.clusterAddrTable.computeIfAbsent(clusterName, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;());<br>            brokerNames.add(brokerName);<br><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">registerFirst</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>            <span class="hljs-type">BrokerData</span> <span class="hljs-variable">brokerData</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.brokerAddrTable.get(brokerName);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == brokerData) &#123;<br>                registerFirst = <span class="hljs-literal">true</span>;<br>                <span class="hljs-comment">// å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ³¨å†Œï¼Œåˆ™æ„é€  BrokerData å¯¹è±¡ï¼Œä¿å­˜åœ¨ brokerAddrTable ä¸­</span><br>                brokerData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrokerData</span>(clusterName, brokerName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());<br>                <span class="hljs-built_in">this</span>.brokerAddrTable.put(brokerName, brokerData);<br>            &#125;<br>            Map&lt;Long, String&gt; brokerAddrsMap = brokerData.getBrokerAddrs();<br>            <span class="hljs-comment">//Switch slave to master: first remove &lt;1, IP:PORT&gt; in namesrv, then add &lt;0, IP:PORT&gt;</span><br>            <span class="hljs-comment">//The same IP:PORT must only have one record in brokerAddrTable</span><br>            Iterator&lt;Entry&lt;Long, String&gt;&gt; it = brokerAddrsMap.entrySet().iterator();<br>            <span class="hljs-keyword">while</span> (it.hasNext()) &#123;<br>                Entry&lt;Long, String&gt; item = it.next();<br>                <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != brokerAddr &amp;&amp; brokerAddr.equals(item.getValue()) &amp;&amp; brokerId != item.getKey()) &#123;<br>                    log.debug(<span class="hljs-string">&quot;remove entry &#123;&#125; from brokerData&quot;</span>, item);<br>                    it.remove();<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">oldAddr</span> <span class="hljs-operator">=</span> brokerData.getBrokerAddrs().put(brokerId, brokerAddr);<br>            <span class="hljs-keyword">if</span> (MixAll.MASTER_ID == brokerId) &#123;<br>                log.info(<span class="hljs-string">&quot;cluster [&#123;&#125;] brokerName [&#123;&#125;] master address change from &#123;&#125; to &#123;&#125;&quot;</span>,<br>                        brokerData.getCluster(), brokerData.getBrokerName(), oldAddr, brokerAddr);<br>            &#125;<br><br>            registerFirst = registerFirst || (<span class="hljs-literal">null</span> == oldAddr);<br><br>            <span class="hljs-comment">// å‰é¢æ˜¯æ³¨å†Œ Broker ç›¸å…³çš„é€»è¾‘ï¼ˆå³ä¿å­˜ Brokerç›¸å…³æ•°æ®ï¼‰</span><br>            <span class="hljs-comment">// æ¥ä¸‹æ¥å°±æ˜¯å¤„ç† Topic ç›¸å…³çš„æ³¨å†Œ</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != topicConfigWrapper &amp;&amp; MixAll.MASTER_ID == brokerId) &#123;<br>                <span class="hljs-comment">// åªæœ‰ Topic æ•°æ®å˜åŒ–äº†ï¼Œæˆ–è€…æ˜¯ç¬¬ä¸€æ¬¡æ³¨å†Œæ‰éœ€è¦å¤„ç†</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isBrokerTopicConfigChanged(brokerAddr, topicConfigWrapper.getDataVersion())<br>                        || registerFirst) &#123;<br>                    ConcurrentMap&lt;String, TopicConfig&gt; tcTable =<br>                            topicConfigWrapper.getTopicConfigTable();<br>                    <span class="hljs-keyword">if</span> (tcTable != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, TopicConfig&gt; entry : tcTable.entrySet()) &#123;<br>                            <span class="hljs-comment">// æ³¨å†Œ Topic , å®é™…å°±æ˜¯å°†æ•°æ®å­˜å‚¨ RouteInfoManager ç±»çš„</span><br>                            <span class="hljs-comment">// HashMap&lt;String/* topic */, Map&lt;String /* brokerName */ , QueueData&gt;&gt; topicQueueTable; å±æ€§ä¸­</span><br>                            <span class="hljs-built_in">this</span>.createAndUpdateQueueData(brokerName, entry.getValue());<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-type">BrokerLiveInfo</span> <span class="hljs-variable">prevBrokerLiveInfo</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.brokerLiveTable.put(brokerAddr,<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrokerLiveInfo</span>(<br>                            System.currentTimeMillis(),<br>                            topicConfigWrapper.getDataVersion(),<br>                            channel,<br>                            haServerAddr));<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == prevBrokerLiveInfo) &#123;<br>                log.info(<span class="hljs-string">&quot;new broker registered, &#123;&#125; HAServer: &#123;&#125;&quot;</span>, brokerAddr, haServerAddr);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (filterServerList != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (filterServerList.isEmpty()) &#123;<br>                    <span class="hljs-built_in">this</span>.filterServerTable.remove(brokerAddr);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-built_in">this</span>.filterServerTable.put(brokerAddr, filterServerList);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (MixAll.MASTER_ID != brokerId) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">masterAddr</span> <span class="hljs-operator">=</span> brokerData.getBrokerAddrs().get(MixAll.MASTER_ID);<br>                <span class="hljs-keyword">if</span> (masterAddr != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-type">BrokerLiveInfo</span> <span class="hljs-variable">brokerLiveInfo</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.brokerLiveTable.get(masterAddr);<br>                    <span class="hljs-keyword">if</span> (brokerLiveInfo != <span class="hljs-literal">null</span>) &#123;<br>                        result.setHaServerAddr(brokerLiveInfo.getHaServerAddr());<br>                        result.setMasterAddr(masterAddr);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-built_in">this</span>.lock.writeLock().unlock();<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        log.error(<span class="hljs-string">&quot;registerBroker Exception&quot;</span>, e);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="åœºæ™¯2ï¼šProducer-å¯åŠ¨æ—¶è·å–-Broker-ç›¸å…³ä¿¡æ¯-RequestCode-GET-ROUTEINFO-BY-TOPIC"><a href="#åœºæ™¯2ï¼šProducer-å¯åŠ¨æ—¶è·å–-Broker-ç›¸å…³ä¿¡æ¯-RequestCode-GET-ROUTEINFO-BY-TOPIC" class="headerlink" title="åœºæ™¯2ï¼šProducer å¯åŠ¨æ—¶è·å– Broker ç›¸å…³ä¿¡æ¯ (RequestCode.GET_ROUTEINFO_BY_TOPIC)"></a>åœºæ™¯2ï¼šProducer å¯åŠ¨æ—¶è·å– Broker ç›¸å…³ä¿¡æ¯ (RequestCode.GET_ROUTEINFO_BY_TOPIC)</h4><p>è·å–ä¿¡æ¯å‘½ä»¤æ˜¯ <code>RequestCode.GET_ROUTEINFO_BY_TOPIC</code>ï¼Œ è°ƒç”¨çš„æ˜¯ <code>DefaultRequestProcessor#getRouteInfoByTopic</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> RemotingCommand <span class="hljs-title function_">getRouteInfoByTopic</span><span class="hljs-params">(ChannelHandlerContext ctx,</span><br><span class="hljs-params">    RemotingCommand request)</span> <span class="hljs-keyword">throws</span> RemotingCommandException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">RemotingCommand</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> RemotingCommand.createResponseCommand(<span class="hljs-literal">null</span>);<br>    <span class="hljs-comment">// åŒæ ·æ˜¯è§£æè¯·æ±‚å¤´çš„æ•°æ®ï¼Œè½¬æ¢æˆ GetRouteInfoRequestHeader</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">GetRouteInfoRequestHeader</span> <span class="hljs-variable">requestHeader</span> <span class="hljs-operator">=</span><br>        (GetRouteInfoRequestHeader) request.decodeCommandCustomHeader(GetRouteInfoRequestHeader.class);<br><br>    <span class="hljs-comment">// æ ¹æ®ä»è¯·æ±‚å¤´ä¸­è§£æå‡ºæ¥çš„ Topic åç§°ä» RouteInfoManager ä¸­è·å–æ•°æ® ã€é‡ç‚¹ä»£ç 2ã€‘</span><br>    <span class="hljs-type">TopicRouteData</span> <span class="hljs-variable">topicRouteData</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.namesrvController.getRouteInfoManager().pickupTopicRouteData(requestHeader.getTopic());<br>    <span class="hljs-comment">// çœç•¥æ„é€ ç›¸åº”çš„ä»£ç  â€¦â€¦</span><br>    response.setCode(ResponseCode.TOPIC_NOT_EXIST);<br>    response.setRemark(<span class="hljs-string">&quot;No topic route info in name server for the topic: &quot;</span> + requestHeader.getTopic()<br>        + FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL));<br>    <span class="hljs-keyword">return</span> response;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°±çœ‹ <strong>ã€é‡ç‚¹ä»£ç 2ã€‘</strong>ï¼Œ è¿™æ˜¯ä» <code>RouteInfoManager</code> ä¸­è·å–æ•°æ®, å‰é¢è®²è§£ <strong>Brokeræ³¨å†Œ</strong> æ—¶å·²ç»è®²åˆ° <code>Topic</code> ç›¸å…³çš„æ•°æ®æ˜¯æ”¾å…¥ <code>RouteInfoManager</code> ç±»çš„ <code>private final HashMap&lt;String/* topic */, Map&lt;String /* brokerName */ , QueueData&gt;&gt; topicQueueTable;</code> ç»“æ„ä¸­ï¼Œ<code>Broker</code> çš„åœ°å€ä¿¡æ¯æ˜¯æ”¾å…¥ <code>private final HashMap&lt;String/* brokerName */, BrokerData&gt; brokerAddrTable;</code> ç»“æ„ä¸­ï¼Œæ‰€ä»¥è·å– <code>Topic</code> ä¸»è¦å°±æ˜¯ä»è¿™ä¸¤ä¸ªç»“æ„ä¸­è·å–æ•°æ®ã€‚</p>
<h3 id="å¯åŠ¨å®šæ—¶ä»»åŠ¡æ¸…ç†ä¸‹çº¿çš„-Broker"><a href="#å¯åŠ¨å®šæ—¶ä»»åŠ¡æ¸…ç†ä¸‹çº¿çš„-Broker" class="headerlink" title="å¯åŠ¨å®šæ—¶ä»»åŠ¡æ¸…ç†ä¸‹çº¿çš„ Broker"></a>å¯åŠ¨å®šæ—¶ä»»åŠ¡æ¸…ç†ä¸‹çº¿çš„ Broker</h3><p>æ¸…ç†ä¸‹çº¿çš„ <code>Broker</code> è°ƒç”¨æµç¨‹å¦‚ä¸‹, ä»¥ä¸‹ä»£ç çœç•¥ä¸æ­¤æ¬¡åˆ†ææ— å…³çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NamesrvController <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-keyword">final</span> NamesrvController controller)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">initResult</span> <span class="hljs-operator">=</span> controller.initialize();<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//  å®šæ—¶æ¸…é™¤çš„é€»è¾‘æ˜¯åœ¨ RouteInfoManager#scanNotActiveBroker æ–¹æ³•ä¸­è¿›è¡Œçš„</span><br>    <span class="hljs-built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(NamesrvController.<span class="hljs-built_in">this</span>.routeInfoManager::scanNotActiveBroker, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>RouteInfoManager</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  2åˆ†é’Ÿ</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">BROKER_CHANNEL_EXPIRED_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">2</span>;<br><span class="hljs-comment">// brokerLiveTable ä¿å­˜çš„æ˜¯å­˜æ´»çš„ Broker æ•°æ®</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;String<span class="hljs-comment">/* brokerAddr */</span>, BrokerLiveInfo&gt; brokerLiveTable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">scanNotActiveBroker</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">removeCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//  é¦–å…ˆå°†æ‰€æœ‰å­˜æ´»çš„ Broker æ•°æ®è¿›è¡Œéå†</span><br>    Iterator&lt;Entry&lt;String, BrokerLiveInfo&gt;&gt; it = <span class="hljs-built_in">this</span>.brokerLiveTable.entrySet().iterator();<br>    <span class="hljs-keyword">while</span> (it.hasNext()) &#123;<br>        Entry&lt;String, BrokerLiveInfo&gt; next = it.next();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> next.getValue().getLastUpdateTimestamp();<br>        <span class="hljs-comment">// åˆ¤æ–­æœ€æ–°æ›´æ–°æ—¶é—´æ˜¯å¦å·²ç»è¶…è¿‡ 2 åˆ†é’Ÿï¼Œå¦‚æœè¶…è¿‡ 2 åˆ†é’Ÿåˆ™ç§»é™¤</span><br>        <span class="hljs-keyword">if</span> ((last + BROKER_CHANNEL_EXPIRED_TIME) &lt; System.currentTimeMillis()) &#123;<br>            RemotingUtil.closeChannel(next.getValue().getChannel());<br>            it.remove();<br>            log.warn(<span class="hljs-string">&quot;The broker channel expired, &#123;&#125; &#123;&#125;ms&quot;</span>, next.getKey(), BROKER_CHANNEL_EXPIRED_TIME);<br>            <span class="hljs-built_in">this</span>.onChannelDestroy(next.getKey(), next.getValue().getChannel());<br>            removeCount++;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> removeCount;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è‡³æ­¤ <code>Nameserver</code> ç›¸å…³åŠŸèƒ½æ¢³ç†å®Œæˆï¼Œæ ¸å¿ƒç‚¹åœ¨ä¸¤ä¸ªç±»</p>
<ul>
<li><code>DefaultRequestProcessor</code> çš„ <code>processRequest</code> æ–¹æ³•ï¼Œè¿™æ˜¯æ‰€æœ‰è¯·æ±‚é€»è¾‘å¤„ç†çš„å…¥å£</li>
<li><code>RouteInfoManager</code> ç±»ï¼Œ<code>Broker</code> æ³¨å†Œæ•°æ®æ˜¯æ”¾åœ¨è¯¥ç±»ä¸­ï¼Œ<code>Produer</code> å’Œ <code>Consumer</code> è·å– <code>Broker</code> æ•°æ®æ—¶ä¹Ÿæ˜¯ä»è¯¥ç±»è·å–</li>
</ul>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQ4.xä¸­é¡ºåºæ¶ˆæ¯çš„å‘é€å’Œæ¶ˆè´¹</title>
    <url>/2023/0479976f9bff/index.html</url>
    <content><![CDATA[<p>RocketMQç‰ˆæœ¬ï¼š 4.9.7</p>
<h3 id="å…¨å±€æœ‰åº"><a href="#å…¨å±€æœ‰åº" class="headerlink" title="å…¨å±€æœ‰åº"></a>å…¨å±€æœ‰åº</h3><ol>
<li>åªæœ‰ä¸€ä¸ªç”Ÿäº§è€…ï¼Œå¹¶ä¸”ç”Ÿäº§è€…ä¹Ÿæ˜¯å•çº¿ç¨‹å‘é€</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—åªæœ‰ä¸€ä¸ª</li>
<li>æ¶ˆè´¹è€…åªæœ‰ä¸€ä¸ªå¹¶ä¸”æ˜¯å•çº¿ç¨‹æ¶ˆè´¹</li>
</ol>
<h3 id="åˆ†åŒºæœ‰åº"><a href="#åˆ†åŒºæœ‰åº" class="headerlink" title="åˆ†åŒºæœ‰åº"></a>åˆ†åŒºæœ‰åº</h3><p>å¦‚æœåªæ˜¯è¦æ±‚å±€éƒ¨æœ‰åºï¼Œå°±å¯ä»¥å°†åŒä¸€ç±»æœ‰åºçš„æ¶ˆæ¯å‘é€åˆ°åŒä¸€ä¸ª <code>Queue</code>, æ‰€ä»¥å¯¹äºå‘é€ç«¯è€Œè¨€é‡è¦çš„å°±æ˜¯å¦‚ä½•é€‰æ‹© <code>Queue</code>, å¯ä»¥å‚è€ƒæºç ä¸­ <code>example</code> å­æ¨¡å—ä¸‹çš„ <code>org.apache.rocketmq.example.ordermessage.Producer</code> ç±»ï¼Œè¯¥ç±»çš„ä»£ç å°±æ˜¯æµ‹è¯•åˆ†åŒºæœ‰åºæ¶ˆæ¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> UnsupportedEncodingException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">DefaultMQProducer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQProducer</span>(<span class="hljs-string">&quot;please_rename_unique_group_name&quot;</span>);<br>            producer.start();<br><br>            String[] tags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123;<span class="hljs-string">&quot;TagA&quot;</span>, <span class="hljs-string">&quot;TagB&quot;</span>, <span class="hljs-string">&quot;TagC&quot;</span>, <span class="hljs-string">&quot;TagD&quot;</span>, <span class="hljs-string">&quot;TagE&quot;</span>&#125;;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> i % <span class="hljs-number">10</span>;<br>                <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span><br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(<span class="hljs-string">&quot;TopicTestjjj&quot;</span>, tags[i % tags.length], <span class="hljs-string">&quot;KEY&quot;</span> + i,<br>                        (<span class="hljs-string">&quot;Hello RocketMQ &quot;</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));<br>                <span class="hljs-comment">// è°ƒç”¨ send æ–¹æ³•æ—¶ï¼Œè®¾ç½®ä¸€ä¸ª MessageQueueSelector ç±»å‹çš„å›è°ƒå‡½æ•°ï¼Œç”¨äºæŒ‡å®šæ¶ˆæ¯å‘é€åˆ°å“ªä¸ªé˜Ÿåˆ—</span><br>                <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> producer.send(msg, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageQueueSelector</span>() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> MessageQueue <span class="hljs-title function_">select</span><span class="hljs-params">(List&lt;MessageQueue&gt; mqs, Message msg, Object arg)</span> &#123;<br>                        <span class="hljs-type">Integer</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (Integer) arg;<br>                        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> id % mqs.size();<br>                        <span class="hljs-keyword">return</span> mqs.get(index);<br>                    &#125;<br>                &#125;, orderId);<br><br>                System.out.printf(<span class="hljs-string">&quot;%s%n&quot;</span>, sendResult);<br>            &#125;<br><br>            producer.shutdown();<br>        &#125; <span class="hljs-keyword">catch</span> (MQClientException | RemotingException | MQBrokerException | InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQ4ä½¿ç”¨jdk17å¯åŠ¨å‡ºç°çš„é—®é¢˜</title>
    <url>/2023/69cb00fc039e/index.html</url>
    <content><![CDATA[<blockquote>
<p>RocketMQç‰ˆæœ¬ï¼š 4.9.7<br>JDKç‰ˆæœ¬ï¼š 17</p>
</blockquote>
<p>å½“ä½¿ç”¨è¶…è¿‡ <code>jdk8</code> çš„ç‰ˆæœ¬è¿è¡Œ <code>RocketMQ</code> æ—¶ï¼Œå¯åŠ¨ <code>Broker</code> å¯èƒ½ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">ERROR <span class="hljs-selector-tag">main</span> - load exception<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.IllegalStateException</span>: java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.InaccessibleObjectException</span>: Unable to make public java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Object</span> java<span class="hljs-selector-class">.nio</span><span class="hljs-selector-class">.DirectByteBuffer</span><span class="hljs-selector-class">.attachment</span>() accessible: module java<span class="hljs-selector-class">.base</span> does not <span class="hljs-string">&quot;opens java.nio&quot;</span> to unnamed module @<span class="hljs-number">276438</span>c9<br>	at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.MappedFile</span>.lambda<span class="hljs-variable">$invoke</span>$<span class="hljs-number">0</span>(MappedFile<span class="hljs-selector-class">.java</span>:<span class="hljs-number">116</span>)<br>	at java.base/java<span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.AccessController</span><span class="hljs-selector-class">.doPrivileged</span>(AccessController<span class="hljs-selector-class">.java</span>:<span class="hljs-number">318</span>)<br>	at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.MappedFile</span><span class="hljs-selector-class">.invoke</span>(MappedFile<span class="hljs-selector-class">.java</span>:<span class="hljs-number">110</span>)<br>	at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.MappedFile</span><span class="hljs-selector-class">.viewed</span>(MappedFile<span class="hljs-selector-class">.java</span>:<span class="hljs-number">140</span>)<br>	at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.MappedFile</span><span class="hljs-selector-class">.clean</span>(MappedFile<span class="hljs-selector-class">.java</span>:<span class="hljs-number">106</span>)<br>	at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.MappedFile</span><span class="hljs-selector-class">.cleanup</span>(MappedFile<span class="hljs-selector-class">.java</span>:<span class="hljs-number">449</span>)<br>	at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.ReferenceResource</span><span class="hljs-selector-class">.release</span>(ReferenceResource<span class="hljs-selector-class">.java</span>:<span class="hljs-number">63</span>)<br>	at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.ReferenceResource</span><span class="hljs-selector-class">.shutdown</span>(ReferenceResource<span class="hljs-selector-class">.java</span>:<span class="hljs-number">47</span>)<br>	at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.MappedFile</span><span class="hljs-selector-class">.destroy</span>(MappedFile<span class="hljs-selector-class">.java</span>:<span class="hljs-number">457</span>)<br>	at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.index</span><span class="hljs-selector-class">.IndexFile</span><span class="hljs-selector-class">.destroy</span>(IndexFile<span class="hljs-selector-class">.java</span>:<span class="hljs-number">85</span>)<br>	at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.index</span><span class="hljs-selector-class">.IndexService</span><span class="hljs-selector-class">.load</span>(IndexService<span class="hljs-selector-class">.java</span>:<span class="hljs-number">71</span>)<br>	at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.DefaultMessageStore</span><span class="hljs-selector-class">.load</span>(DefaultMessageStore<span class="hljs-selector-class">.java</span>:<span class="hljs-number">210</span>)<br>	at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.broker</span><span class="hljs-selector-class">.BrokerController</span><span class="hljs-selector-class">.initialize</span>(BrokerController<span class="hljs-selector-class">.java</span>:<span class="hljs-number">268</span>)<br>	at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.broker</span><span class="hljs-selector-class">.BrokerStartup</span><span class="hljs-selector-class">.createBrokerController</span>(BrokerStartup<span class="hljs-selector-class">.java</span>:<span class="hljs-number">219</span>)<br>	at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.broker</span><span class="hljs-selector-class">.BrokerStartup</span><span class="hljs-selector-class">.main</span>(BrokerStartup<span class="hljs-selector-class">.java</span>:<span class="hljs-number">57</span>)<br></code></pre></td></tr></table></figure>

<p>ä»¥åŠ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">ERROR main - load exception<br>java.lang.IllegalStateException: java.lang.reflect.InaccessibleObjectException: Unable to make <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> jdk.internal.ref.Cleaner.clean() accessible: <span class="hljs-keyword">module</span> java.base does not <span class="hljs-string">&quot;exports jdk.internal.ref&quot;</span> to unnamed <span class="hljs-keyword">module</span> @4e4aea35<br>	at org.apache.rocketmq.store.MappedFile.lambda$invoke$<span class="hljs-number">0</span>(MappedFile.java:<span class="hljs-number">116</span>)<br>	at java.base/java.security.AccessController.doPrivileged(AccessController.java:<span class="hljs-number">318</span>)<br>	at org.apache.rocketmq.store.MappedFile.invoke(MappedFile.java:<span class="hljs-number">110</span>)<br>	at org.apache.rocketmq.store.MappedFile.clean(MappedFile.java:<span class="hljs-number">106</span>)<br>	at org.apache.rocketmq.store.MappedFile.cleanup(MappedFile.java:<span class="hljs-number">449</span>)<br>	at org.apache.rocketmq.store.ReferenceResource.release(ReferenceResource.java:<span class="hljs-number">63</span>)<br>	at org.apache.rocketmq.store.ReferenceResource.shutdown(ReferenceResource.java:<span class="hljs-number">47</span>)<br>	at org.apache.rocketmq.store.MappedFile.destroy(MappedFile.java:<span class="hljs-number">457</span>)<br>	at org.apache.rocketmq.store.index.IndexFile.destroy(IndexFile.java:<span class="hljs-number">85</span>)<br>	at org.apache.rocketmq.store.index.IndexService.load(IndexService.java:<span class="hljs-number">71</span>)<br>	at org.apache.rocketmq.store.DefaultMessageStore.load(DefaultMessageStore.java:<span class="hljs-number">210</span>)<br>	at org.apache.rocketmq.broker.BrokerController.initialize(BrokerController.java:<span class="hljs-number">268</span>)<br>	at org.apache.rocketmq.broker.BrokerStartup.createBrokerController(BrokerStartup.java:<span class="hljs-number">219</span>)<br>	at org.apache.rocketmq.broker.BrokerStartup.main(BrokerStartup.java:<span class="hljs-number">57</span>)<br>Caused by: java.lang.reflect.InaccessibleObjectException: Unable to make <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> jdk.internal.ref.Cleaner.clean() accessible: <span class="hljs-keyword">module</span> java.base does not <span class="hljs-string">&quot;exports jdk.internal.ref&quot;</span> to unnamed <span class="hljs-keyword">module</span> @4e4aea35<br>	at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:<span class="hljs-number">354</span>)<br>	at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:<span class="hljs-number">297</span>)<br>	at java.base/java.lang.reflect.Method.checkCanSetAccessible(Method.java:<span class="hljs-number">199</span>)<br>	at java.base/java.lang.reflect.Method.setAccessible(Method.java:<span class="hljs-number">193</span>)<br>	at org.apache.rocketmq.store.MappedFile.lambda$invoke$<span class="hljs-number">0</span>(MappedFile.java:<span class="hljs-number">113</span>)<br></code></pre></td></tr></table></figure>

<p>è¿™æ˜¯å› ä¸º <code>jdk8</code> ä»¥ä¸Šå°±ä½¿ç”¨æ¨¡å—åŒ–ï¼Œæ‰€ä»¥éœ€è¦æ·»åŠ  <code>jvm</code> å‚æ•°</p>
<p><img src="https://s2.loli.net/2023/12/21/H3dfjZbrRGDAsKP.png" alt="Brokeræ·»åŠ vmå‚æ•°"></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><code class="hljs csharp">--<span class="hljs-keyword">add</span>-opens java.<span class="hljs-keyword">base</span>/java.nio=ALL-UNNAMED --<span class="hljs-keyword">add</span>-exports java.<span class="hljs-keyword">base</span>/jdk.<span class="hljs-keyword">internal</span>.<span class="hljs-keyword">ref</span>=ALL-UNNAMED<br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQ4ç‰ˆæœ¬ä»¥é›†ç¾¤æ¨¡å¼å¯åŠ¨Broker</title>
    <url>/2023/f0b30d177028/index.html</url>
    <content><![CDATA[<blockquote>
<p>RocketMQç‰ˆæœ¬: 4.9.7<br>JDKç‰ˆæœ¬ï¼š 17</p>
</blockquote>
<p>å¯¹äºå•æœºç‰ˆè¿è¡Œ <code>RocketMQ4</code> æˆ– <code>RocketMQ5</code> ç‰ˆæœ¬éƒ½å¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/49fb249febb6/index.html" title="RocketMQå®‰è£…ä½¿ç”¨å’ŒåŸºæœ¬æ¦‚å¿µ">RocketMQå®‰è£…ä½¿ç”¨å’ŒåŸºæœ¬æ¦‚å¿µ</a></li></ol>

<p>å¯¹äºæºç ç¼–è¯‘å‡ºç°çš„é—®é¢˜å¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/2adf4cc6108b/index.html" title="ä½¿ç”¨ideaç¼–è¯‘RocketMQ5æºç ">ä½¿ç”¨ideaç¼–è¯‘RocketMQ5æºç </a></li></ol>

<p>å¯¹äº <code>RocketMQ4</code> ç‰ˆæœ¬ä½¿ç”¨ <code>jdk17</code> å‡ºç°çš„é—®é¢˜è§£å†³æ–¹æ¡ˆå¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/69cb00fc039e/index.html" title="RocketMQ4ä½¿ç”¨jdk17å¯åŠ¨å‡ºç°çš„é—®é¢˜">RocketMQ4ä½¿ç”¨jdk17å¯åŠ¨å‡ºç°çš„é—®é¢˜</a></li></ol>

<h2 id="åˆ›å»ºå„è‡ª-Broker-çš„-ROCKETMQ-HOME-ç›®å½•"><a href="#åˆ›å»ºå„è‡ª-Broker-çš„-ROCKETMQ-HOME-ç›®å½•" class="headerlink" title="åˆ›å»ºå„è‡ª Broker çš„ ROCKETMQ_HOME ç›®å½•"></a>åˆ›å»ºå„è‡ª Broker çš„ ROCKETMQ_HOME ç›®å½•</h2><p>è¿™é‡Œä¸»è¦è®²è§£çš„æ˜¯æœ¬åœ°ä½¿ç”¨æºç å¯åŠ¨ä¸¤ä¸ª(ä¸¤ä¸ªä»¥ä¸Šä¹Ÿä¸€æ ·) <code>Broker</code>ï¼Œè¿™æ ·åœ¨è°ƒè¯•æºç çš„æ—¶å€™å¯ä»¥çœ‹åˆ° <code>Broker</code> å¤„äºé›†ç¾¤çŠ¶æ€çš„ä¸€äº›å¤„ç†æ–¹å¼</p>
<p>åˆ›å»º <code>ROCKETMQ_HOME</code> ç›®å½•ï¼Œå› ä¸ºè¦åœ¨åŒä¸€å°ç”µè„‘ä¸Šå¯åŠ¨ä¸¤ä¸ª <code>Broker</code>, æ‰€ä»¥æ¯ä¸€ä¸ª <code>Broker</code> éƒ½ç»™ä¸€ä¸ªç‹¬ç«‹çš„ç›®å½•å’Œé…ç½®ï¼Œè¿™é‡Œåˆ›å»ºäº† <code>D:\data\rocketmq</code>(ä»¥ä¸‹ç®€ç§° <code>rocketmq</code> ) å’Œ <code>D:\data\rocketmq2</code>(ä»¥ä¸‹ç®€ç§° <code>rocketmq2</code>)ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="https://s2.loli.net/2023/12/21/SQEnai8qe1ILJhp.png" alt="ROCKETMQ_HOME"><br>åœ¨ <code>conf</code> å­ç›®å½•ä¸­éƒ½æœ‰ä¸‰ä¸ªé…ç½®æ–‡ä»¶</p>
<ul>
<li><code>broker.conf</code></li>
<li><code>logback_broker.xml</code> è¿™ä¸ªæ–‡ä»¶å¯ä»¥ç›´æ¥ä» <code>rokcetmq</code> æºç çš„ <code>distribution</code> å­æ¨¡å—çš„ <code>conf</code> ç›®å½•ä¸­æ‹·è´</li>
<li><code>logback_namesrv.xml</code> è¿™ä¸ªæ–‡ä»¶å¯ä»¥ç›´æ¥ä» <code>rokcetmq</code> æºç çš„ <code>distribution</code> å­æ¨¡å—çš„ <code>conf</code> ç›®å½•ä¸­æ‹·è´</li>
</ul>
<div class="tabs" id="broker.conf-æ–‡ä»¶å†…å®¹"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="broker.conf-æ–‡ä»¶å†…å®¹-1">rocketmqä¸‹broker.conf</button><button type="button" class="tab " data-href="broker.conf-æ–‡ä»¶å†…å®¹-2">rocketmq2ä¸‹broker.conf</button></ul><div class="tab-contents"><div class="tab-item-content active" id="broker.conf-æ–‡ä»¶å†…å®¹-1"><p><code>rocketmq</code> ä¸‹ <code>conf</code> ä¸‹çš„ <code>broker.conf</code> å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs conf">brokerClusterName = DefaultCluster<br>brokerName = broker-a<br>brokerId = 0<br>deleteWhen = 04<br>fileReservedTime = 48<br>brokerRole = ASYNC_MASTER<br>flushDiskType = ASYNC_FLUSH<br><br>namesrvAddr = 127.0.0.1:9876<br>storePathRootDir = D:\\data\\rocketmq\\store<br>storePathCommitLog = D:\\data\\rocketmq\\store\\commitlog<br>storePathConsumeQueue = D:\\data\\rocketmq\\store\\consumequeue<br>storePathIndex = D:\\data\\rocketmq\\store\\index<br>storeCheckpoint = D:\\data\\rocketmq\\store\\checkpoint<br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="broker.conf-æ–‡ä»¶å†…å®¹-2"><p><code>rocketmq2</code> ä¸‹ <code>conf</code> ä¸‹çš„ <code>broker.conf</code> å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs conf">brokerClusterName = DefaultCluster<br>brokerName = broker-b<br>brokerId = 0<br>deleteWhen = 04<br>fileReservedTime = 48<br>brokerRole = ASYNC_MASTER<br>flushDiskType = ASYNC_FLUSH<br>listenPort = 10915<br><br>namesrvAddr = 127.0.0.1:9876<br>storePathRootDir = D:\\data\\rocketmq2\\store<br>storePathCommitLog = D:\\data\\rocketmq2\\store\\commitlog<br>storePathConsumeQueue = D:\\data\\rocketmq2\\store\\consumequeue<br>storePathIndex = D:\\data\\rocketmq2\\store\\index<br>storeCheckpoint = D:\\data\\rocketmq2\\store\\checkpoint<br></code></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>


<p><code>logback_broker.xml</code> å’Œ <code>logback_namesrv.xml</code> æ–‡ä»¶çš„ä¿®æ”¹<br>å¯¹äºè¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œåªéœ€è¦å°† <code>$&#123;user.home&#125;</code> ä¿®æ”¹æˆå¯¹åº”çš„ <code>ROCKETMQ_HOME</code> ç›®å½•å³å¯ï¼Œæ¯”å¦‚å¯¹äº <code>D:\data\rocketmq\conf</code> ä¸‹çš„æ—¥å¿—é…ç½®æ–‡ä»¶ï¼Œå°† <code>$&#123;user.home&#125;</code> éƒ½æ›¿æ¢æˆ <code>D:\data\rocketmq</code>ï¼Œå¯¹äº<code>D:\data\rocketmq2\conf</code> ä¸‹çš„æ—¥å¿—é…ç½®æ–‡ä»¶ï¼Œå°† <code>$&#123;user.home&#125;</code> éƒ½æ›¿æ¢æˆ <code>D:\data\rocketmq2</code></p>
<h2 id="ä¿®æ”¹-idea-ä¸­çš„é…ç½®"><a href="#ä¿®æ”¹-idea-ä¸­çš„é…ç½®" class="headerlink" title="ä¿®æ”¹ idea ä¸­çš„é…ç½®"></a>ä¿®æ”¹ idea ä¸­çš„é…ç½®</h2><p>åœ¨ <code>idea</code> çš„ <code>run/debug configuration</code> ä¸­ï¼Œæ·»åŠ  <code>Application</code>, æ¨¡å—é€‰æ‹© <code>rocketmq-broker</code>, ç±»é€‰æ‹© <code>org.apache.rocketmq.broker.BrokerStartup</code>ï¼Œéœ€è¦æ·»åŠ ä¸¤æ¬¡ï¼Œæœ€ç»ˆé…ç½®å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://s2.loli.net/2023/12/21/vFZh5J3qxVTXCSo.png" alt="Broker1çš„é…ç½®"></p>
<p><img src="https://s2.loli.net/2023/12/21/9VhWeDbRQZjuHES.png" alt="Broker2çš„é…ç½®"></p>
<p>é…ç½®å®Œæˆå°±å¯ä»¥å¯åŠ¨äº†</p>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQä¸­Brokeræ³¨å†Œåˆ°Nameserverè¯¦è§£</title>
    <url>/2023/e44019fc2e8a/index.html</url>
    <content><![CDATA[<blockquote>
<p>RocketMQç‰ˆæœ¬ï¼š4.9.7<br>JDKç‰ˆæœ¬ï¼š 17</p>
</blockquote>
<p>å¯ä»¥å…ˆå‚è€ƒ</p>
<ol><li><a href="/2023/5398bb79bdb5/index.html" title="RocketMQä¹‹Brokerè¯¦è§£">RocketMQä¹‹Brokerè¯¦è§£</a></li></ol>
<ol><li><a href="/2023/e17cf930f952/index.html" title="RocketMQ4ä¸­Nameserverè¯¦è§£">RocketMQ4ä¸­Nameserverè¯¦è§£</a></li></ol>

<h2 id="æ³¨å†Œçš„æ•´ä½“é€»è¾‘"><a href="#æ³¨å†Œçš„æ•´ä½“é€»è¾‘" class="headerlink" title="æ³¨å†Œçš„æ•´ä½“é€»è¾‘"></a>æ³¨å†Œçš„æ•´ä½“é€»è¾‘</h2><p><code>Broker</code> å°†ä¿¡æ¯æ³¨å†Œåˆ° <code>NameServer</code> ä¸­çš„ä»£ç æ˜¯åœ¨ <code>BrokerController#registerBrokerAll(boolean checkOrderConfig, boolean oneway, boolean forceRegister)</code> æ–¹æ³•ä¸­å®Œæˆçš„</p>
<p>æ³¨å†Œçš„é€»è¾‘ä¸­ä¸»è¦å®Œæˆä¸‰ä»¶äº‹æƒ…</p>
<ul>
<li>è·å–å½“å‰ <code>Broker</code> ä¸­ä¿å­˜çš„ <code>Topic</code> ä¿¡æ¯ï¼Œå°†å…¶å˜æˆ <code>ConcurrentHashMap&lt;String, TopicConfig&gt; topicConfigTable</code> ç»“æœå¹¶æ”¾å…¥ <code>TopicConfigSerializeWrapper</code> ç±»ä¸­</li>
<li>è·å– <code>Broker</code> ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚ <code>BrokerName</code>, <code>BrokerId</code>, <code>BrokerAddr</code></li>
<li>å°†å‰é¢ä¸¤æ­¥è·å–çš„ä¿¡æ¯ç»“åˆèµ·æ¥é€šè¿‡ <code>Netty</code> å‘é€åˆ° <code>NameServer</code> ä¸­</li>
</ul>
<p>æ¥ä¸‹æ¥å°±çœ‹ä¸‹å®é™…çš„ä»£ç å®ç°</p>
<p><code>BrokerController</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBrokerAll</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> checkOrderConfig, <span class="hljs-type">boolean</span> oneway, <span class="hljs-type">boolean</span> forceRegister)</span> &#123;<br>    <span class="hljs-comment">// ã€æ­¥éª¤1ã€‘è·å– Topic ä¿¡æ¯</span><br>    <span class="hljs-type">TopicConfigSerializeWrapper</span> <span class="hljs-variable">topicConfigWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getTopicConfigManager().buildTopicConfigSerializeWrapper();<br><br>    <span class="hljs-keyword">if</span> (!PermName.isWriteable(<span class="hljs-built_in">this</span>.getBrokerConfig().getBrokerPermission())<br>        || !PermName.isReadable(<span class="hljs-built_in">this</span>.getBrokerConfig().getBrokerPermission())) &#123;<br>        ConcurrentHashMap&lt;String, TopicConfig&gt; topicConfigTable = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (TopicConfig topicConfig : topicConfigWrapper.getTopicConfigTable().values()) &#123;<br>            <span class="hljs-type">TopicConfig</span> <span class="hljs-variable">tmp</span> <span class="hljs-operator">=</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicConfig</span>(topicConfig.getTopicName(), topicConfig.getReadQueueNums(), topicConfig.getWriteQueueNums(),<br>                    <span class="hljs-built_in">this</span>.brokerConfig.getBrokerPermission());<br>            topicConfigTable.put(topicConfig.getTopicName(), tmp);<br>        &#125;<br>        topicConfigWrapper.setTopicConfigTable(topicConfigTable);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (forceRegister || needRegister(<span class="hljs-built_in">this</span>.brokerConfig.getBrokerClusterName(),<br>        <span class="hljs-built_in">this</span>.getBrokerAddr(),<br>        <span class="hljs-built_in">this</span>.brokerConfig.getBrokerName(),<br>        <span class="hljs-built_in">this</span>.brokerConfig.getBrokerId(),<br>        <span class="hljs-built_in">this</span>.brokerConfig.getRegisterBrokerTimeoutMills())) &#123;<br>        doRegisterBrokerAll(checkOrderConfig, oneway, topicConfigWrapper);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doRegisterBrokerAll</span><span class="hljs-params">(<span class="hljs-type">boolean</span> checkOrderConfig, <span class="hljs-type">boolean</span> oneway,</span><br><span class="hljs-params">    TopicConfigSerializeWrapper topicConfigWrapper)</span> &#123;<br>    <span class="hljs-comment">// ã€æ­¥éª¤2ã€‘ this.brokerOuterAPI.registerBrokerAll æ–¹æ³•çš„å‚æ•°</span><br>    <span class="hljs-comment">// å°±åŒ…å«äº† Broker ä¿¡æ¯å’Œ Topic ä¿¡æ¯ï¼Œ ç»„è£…å‘½ä»¤å’Œå‘é€çš„é€»è¾‘</span><br>    <span class="hljs-comment">// æ˜¯åœ¨ brokerOuterAPI ä¸­å®Œæˆçš„</span><br>    List&lt;RegisterBrokerResult&gt; registerBrokerResultList = <span class="hljs-built_in">this</span>.brokerOuterAPI.registerBrokerAll(<br>        <span class="hljs-built_in">this</span>.brokerConfig.getBrokerClusterName(),<br>        <span class="hljs-built_in">this</span>.getBrokerAddr(),<br>        <span class="hljs-built_in">this</span>.brokerConfig.getBrokerName(),<br>        <span class="hljs-built_in">this</span>.brokerConfig.getBrokerId(),<br>        <span class="hljs-built_in">this</span>.getHAServerAddr(),<br>        topicConfigWrapper,<br>        <span class="hljs-built_in">this</span>.filterServerManager.buildNewFilterServerList(),<br>        oneway,<br>        <span class="hljs-built_in">this</span>.brokerConfig.getRegisterBrokerTimeoutMills(),<br>        <span class="hljs-built_in">this</span>.brokerConfig.isCompressedRegister());<br><br>    <span class="hljs-keyword">if</span> (registerBrokerResultList.size() &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-type">RegisterBrokerResult</span> <span class="hljs-variable">registerBrokerResult</span> <span class="hljs-operator">=</span> registerBrokerResultList.get(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (registerBrokerResult != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.updateMasterHAServerAddrPeriodically &amp;&amp; registerBrokerResult.getHaServerAddr() != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-built_in">this</span>.messageStore.updateHaMasterAddress(registerBrokerResult.getHaServerAddr());<br>            &#125;<br><br>            <span class="hljs-built_in">this</span>.slaveSynchronize.setMasterAddr(registerBrokerResult.getMasterAddr());<br><br>            <span class="hljs-keyword">if</span> (checkOrderConfig) &#123;<br>                <span class="hljs-built_in">this</span>.getTopicConfigManager().updateOrderTopicConfig(registerBrokerResult.getKvTable());<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>BrokerOuterAPI</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BrokerOuterAPI</span> &#123;<br>    <span class="hljs-comment">// ã€æ­¥éª¤3ã€‘è¿™é‡Œé¢ä¼šå®é™…ç»„è£… RemotingCommand å¹¶æ‰§è¡Œå‘é€çš„é€»è¾‘</span><br>    <span class="hljs-keyword">private</span> RegisterBrokerResult <span class="hljs-title function_">registerBroker</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> String namesrvAddr,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> oneway,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> timeoutMills,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> RegisterBrokerRequestHeader requestHeader,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] body</span><br><span class="hljs-params">    )</span> <span class="hljs-keyword">throws</span> RemotingCommandException, MQBrokerException, RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException,<br>        InterruptedException &#123;<br>        <span class="hljs-comment">// è¿™é‡Œæ„å»ºçš„ Command æŒ‡ä»¤æ˜¯ RequestCode.REGISTER_BROKER</span><br>        <span class="hljs-type">RemotingCommand</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> RemotingCommand.createRequestCommand(RequestCode.REGISTER_BROKER, requestHeader);<br>        request.setBody(body);<br><br>        <span class="hljs-keyword">if</span> (oneway) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-built_in">this</span>.remotingClient.invokeOneway(namesrvAddr, request, timeoutMills);<br>            &#125; <span class="hljs-keyword">catch</span> (RemotingTooMuchRequestException e) &#123;<br>                <span class="hljs-comment">// Ignore</span><br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-type">RemotingCommand</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.remotingClient.invokeSync(namesrvAddr, request, timeoutMills);<br>        <span class="hljs-keyword">assert</span> response != <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">switch</span> (response.getCode()) &#123;<br>            <span class="hljs-keyword">case</span> ResponseCode.SUCCESS: &#123;<br>                <span class="hljs-type">RegisterBrokerResponseHeader</span> <span class="hljs-variable">responseHeader</span> <span class="hljs-operator">=</span><br>                    (RegisterBrokerResponseHeader) response.decodeCommandCustomHeader(RegisterBrokerResponseHeader.class);<br>                <span class="hljs-type">RegisterBrokerResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegisterBrokerResult</span>();<br>                result.setMasterAddr(responseHeader.getMasterAddr());<br>                result.setHaServerAddr(responseHeader.getHaServerAddr());<br>                <span class="hljs-keyword">if</span> (response.getBody() != <span class="hljs-literal">null</span>) &#123;<br>                    result.setKvTable(KVTable.decode(response.getBody(), KVTable.class));<br>                &#125;<br>                <span class="hljs-keyword">return</span> result;<br>            &#125;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MQBrokerException</span>(response.getCode(), response.getRemark(), requestHeader == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : requestHeader.getBrokerAddr());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ã€æ­¥éª¤1ã€‘è·å–-Topic-ä¿¡æ¯"><a href="#ã€æ­¥éª¤1ã€‘è·å–-Topic-ä¿¡æ¯" class="headerlink" title="ã€æ­¥éª¤1ã€‘è·å– Topic ä¿¡æ¯"></a>ã€æ­¥éª¤1ã€‘è·å– Topic ä¿¡æ¯</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// BrokerController ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BrokerController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBrokerAll</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> checkOrderConfig, <span class="hljs-type">boolean</span> oneway, <span class="hljs-type">boolean</span> forceRegister)</span> &#123;<br>        <span class="hljs-type">TopicConfigSerializeWrapper</span> <span class="hljs-variable">topicConfigWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getTopicConfigManager().buildTopicConfigSerializeWrapper();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// TopicConfigManager ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TopicConfigManager</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;String, TopicConfig&gt; topicConfigTable =<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;String, TopicConfig&gt;(<span class="hljs-number">1024</span>);<br><br>    <span class="hljs-keyword">public</span> TopicConfigSerializeWrapper <span class="hljs-title function_">buildTopicConfigSerializeWrapper</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">TopicConfigSerializeWrapper</span> <span class="hljs-variable">topicConfigSerializeWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicConfigSerializeWrapper</span>();<br>        topicConfigSerializeWrapper.setTopicConfigTable(<span class="hljs-built_in">this</span>.topicConfigTable);<br>        topicConfigSerializeWrapper.setDataVersion(<span class="hljs-built_in">this</span>.dataVersion);<br>        <span class="hljs-keyword">return</span> topicConfigSerializeWrapper;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œè·å– <code>Topic</code> ä¿¡æ¯çš„ä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯è·å– <code>TopicConfigManager</code> ç±»ä¸­çš„ <code>topicConfigTable</code> å±æ€§ï¼Œæ—¢ç„¶è¿™é‡Œæ˜¯ç›´æ¥è·å–çš„ï¼Œå°±è¯´æ˜å‰é¢å·²ç»æœ‰åœ°æ–¹è®¾ç½®å€¼ï¼Œé‚£ä¹ˆæ˜¯åœ¨å“ªé‡Œè®¾ç½®å€¼çš„å‘¢ï¼Ÿ</p>
<p>ä¸€ä¸ªç®€å•å¿«é€Ÿçš„æ–¹æ³•å°±æ˜¯ç›´æ¥åœ¨æºç ä¸­æ‰¾åˆ° <code>TopicConfigManager</code>ï¼Œ ç„¶ååœ¨ç±»ä¸­æœç´¢ <code>topicConfigTable.put</code>, åœ¨å«æœ‰æ·»åŠ çš„åœ°æ–¹æ‰“ä¸Šæ–­ç‚¹ï¼Œè¿™æ ·å°±å¯ä»¥çŸ¥é“æ·»åŠ  <code>Topic</code> çš„è°ƒç”¨é“¾ï¼Œé€šè¿‡è¿™ç§æ–¹å¼åœ¨ <code>Broker</code> å¯åŠ¨è¿‡ç¨‹ä¸­ ä¼šæœ‰ä¸¤ä¸ªåœ°æ–¹æ·»åŠ  <code>Topic</code> æ•°æ®<br><strong>ç¬¬ä¸€ä¸ªæ·»åŠ  <code>Toipc</code> çš„åœ°æ–¹</strong></p>
<figure class="highlight haxe"><table><tr><td class="code"><pre><code class="hljs haxe">BrokerStartup<span class="hljs-meta">#main</span><br>    BrokerStartup<span class="hljs-meta">#createBrokerController</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-type">BrokerController</span>()<br>            <span class="hljs-keyword">new</span> <span class="hljs-type">TopicConfigManager</span>()<br></code></pre></td></tr></table></figure>
<p>åœ¨åˆ›å»º <code>TopicConfigManager</code> å¯¹è±¡çš„æ—¶å€™å°±ä¼šåŠ è½½ä¸€ç³»åˆ—å†…éƒ¨çš„ <code>Topic</code>ï¼Œ ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">TopicConfigManager</span><span class="hljs-params">(BrokerController brokerController)</span> &#123;<br>    <span class="hljs-built_in">this</span>.brokerController = brokerController;<br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">topic</span> <span class="hljs-operator">=</span> TopicValidator.RMQ_SYS_SELF_TEST_TOPIC;<br>        <span class="hljs-type">TopicConfig</span> <span class="hljs-variable">topicConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicConfig</span>(topic);<br>        TopicValidator.addSystemTopic(topic);<br>        topicConfig.setReadQueueNums(<span class="hljs-number">1</span>);<br>        topicConfig.setWriteQueueNums(<span class="hljs-number">1</span>);<br>        <span class="hljs-built_in">this</span>.topicConfigTable.put(topicConfig.getTopicName(), topicConfig);<br>    &#125;<br>    <span class="hljs-comment">// â€¦â€¦ çœç•¥å…¶ä»–å†…éƒ¨ topic åˆ›å»ºè¿‡ç¨‹</span><br>&#125;<br></code></pre></td></tr></table></figure>


<p><strong>ç¬¬äºŒä¸ªæ·»åŠ  <code>Topic</code> çš„åœ°æ–¹</strong></p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><code class="hljs 1c">BrokerStartup<span class="hljs-meta">#main</span><br>    BrokerStartup<span class="hljs-meta">#createBrokerController</span><br>        BrokerController<span class="hljs-meta">#initialize</span><br>            ConfigManager<span class="hljs-meta">#load</span><br></code></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ <code>load</code> æ˜¯ä» <code>ROCKETMQ_HOME/store/config/topics.json</code> ä¸­åŠ è½½æ•°æ®ï¼Œå¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡éƒ¨ç½²ï¼Œè€Œæ˜¯å·²ç»åˆ›å»ºæœ‰ <code>topic</code> ç„¶åé‡å¯ <code>Broker</code> çš„è¯å°±ä¼šä»è¿™é‡Œé¢åŠ è½½ <code>Topic</code> æ•°æ®</p>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQä¸­MessageQueueè¯¦è§£</title>
    <url>/2023/0137d652ba85/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<blockquote>
<p>RocketMQç‰ˆæœ¬ï¼š 4.9.7<br>JDKç‰ˆæœ¬ï¼š 17</p>
</blockquote>
<h2 id="MessageQueue-ç®€ä»‹"><a href="#MessageQueue-ç®€ä»‹" class="headerlink" title="MessageQueue ç®€ä»‹"></a>MessageQueue ç®€ä»‹</h2><p>åœ¨ <code>RokcetMQ</code> ä¸­æœ‰å‡ ä¸ªæ ¸å¿ƒçš„æ¦‚å¿µï¼Œå…¶ä¸­å°±åŒ…å« <code>Topic</code> å’Œ <code>Queue</code></p>
<ul>
<li><code>Topic</code> æ˜¯ä¸šåŠ¡ä¸Šçš„é€»è¾‘åˆ†ç±»ï¼Œä¸€ç±»æ¶ˆæ¯åˆ›å‘å¾€åŒä¸€ä¸ª <code>Topic</code></li>
<li><code>Queue</code> åˆ™æ˜¯æ¶ˆæ¯å®é™…å‘é€çš„åœ°æ–¹ï¼Œä¸€ä¸ª <code>Topic</code> å¯¹åº”å¤šä¸ª <code>Queue</code></li>
</ul>
<h2 id="MessageQueue-ç»“æ„"><a href="#MessageQueue-ç»“æ„" class="headerlink" title="MessageQueue ç»“æ„"></a>MessageQueue ç»“æ„</h2><p><code>MessageQueue</code> ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageQueue</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparable</span>&lt;MessageQueue&gt;, Serializable &#123;<br>    <span class="hljs-keyword">private</span> String topic;<br>    <span class="hljs-keyword">private</span> String brokerName;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> queueId;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ç”±ä¸Šé¢ <code>MessageQueue</code> å±æ€§å¯çŸ¥ï¼Œæƒ³è¦ç¡®å®šæ¶ˆæ¯åˆ°åº•å‘é€åˆ°é‚£ä¸ª <code>Queue</code> ä¸­éœ€è¦çŸ¥é“ä¸‰ä¸ªä¿¡æ¯</p>
<ul>
<li><code>topic</code>: è¿™ä¸ªä¸ç”¨å¤šè¯´ï¼Œå‘é€è‚¯å®šéœ€è¦å…ˆçŸ¥é“å‘å¾€å“ªä¸ª <code>Topic</code></li>
<li><code>brokerName</code>: ä¸ºä»€ä¹ˆè¿˜éœ€è¦çŸ¥é“ <code>BrokerName</code> å‘¢ï¼Ÿä¸»è¦æ˜¯æŸä¸ª <code>Topic</code> å¯ä»¥åˆ›å»ºåœ¨é›†ç¾¤ä¸­çš„å¤šä¸ª <code>Broker</code> ä¸­ï¼Œæ¯”å¦‚é›†ç¾¤ä¸­æœ‰ 5 ä¸ª <code>Broker</code>, æˆ‘ä»¬å¯ä»¥å°† <code>Topic</code> åˆ›å»ºåœ¨ä»»æ„å‡ ä¸ªæˆ–å…¨éƒ¨çš„ <code>Broker</code> ä¸­</li>
<li><code>queueId</code>ï¼š<code>Broker</code> ä¸­åˆ›å»ºçš„ <code>Topic</code> é»˜è®¤æ˜¯ä¼šæœ‰å››ä¸ª <code>Queue</code>, æ‰€ä»¥éœ€è¦çŸ¥é“å…·ä½“æ˜¯å‘é€åˆ°å“ªä¸ª <code>Queue</code> ä¸­</li>
</ul>
<p>æ¥ä¸‹æ¥ä¼šéœ€è¦åœ¨ <code>Broker</code> é›†ç¾¤ä¸­æ¥æŸ¥çœ‹ <code>MessageQueue</code> ç»“æ„çš„æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥å…ˆå‚è€ƒä¸‹é¢æ–‡ç« ä»æºç å¯åŠ¨ <code>Broker</code> é›†ç¾¤ ã€å› ä¸ºéœ€è¦åˆ†ææºç ï¼Œæ‰€ä»¥ä»æºç å¯åŠ¨ã€‘</p>
<ol><li><a href="/2023/f0b30d177028/index.html" title="RocketMQ4ç‰ˆæœ¬ä»¥é›†ç¾¤æ¨¡å¼å¯åŠ¨Broker">RocketMQ4ç‰ˆæœ¬ä»¥é›†ç¾¤æ¨¡å¼å¯åŠ¨Broker</a></li></ol>

<h3 id="é€šè¿‡-Producer-å‘é€æ•°æ®æŸ¥çœ‹-MessageQueue-å†…å®¹"><a href="#é€šè¿‡-Producer-å‘é€æ•°æ®æŸ¥çœ‹-MessageQueue-å†…å®¹" class="headerlink" title="é€šè¿‡ Producer å‘é€æ•°æ®æŸ¥çœ‹ MessageQueue å†…å®¹"></a>é€šè¿‡ Producer å‘é€æ•°æ®æŸ¥çœ‹ MessageQueue å†…å®¹</h3><p>æ¥ä¸‹æ¥å°±æ˜¯åœ¨ <code>idea</code> ä¸­é€šè¿‡æºç å¯åŠ¨ 1 ä¸ª <code>NameServer</code>, 2 ä¸ª <code>Broker</code><br>ç„¶åæ‰¾åˆ°æºç ä¸‹çš„ <code>exmaple</code> å­æ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—ä¸»è¦æ˜¯æµ‹è¯•ä»£ç ï¼Œæ‰¾åˆ° <code>org.apache.rocketmq.example.simple.Producer</code> ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼ˆæœ‰éƒ¨åˆ†è°ƒæ•´ï¼Œæ¯”å¦‚å¾ªç¯æ¬¡æ•°æ”¹åˆ°äº†10ï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException, InterruptedException &#123;<br><br>        <span class="hljs-type">DefaultMQProducer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQProducer</span>(<span class="hljs-string">&quot;ProducerGroupName&quot;</span>);<br>        producer.setNamesrvAddr(<span class="hljs-string">&quot;127.0.0.1:9876&quot;</span>);<br>        producer.start();<br>        <span class="hljs-comment">// è¿™é‡Œå¾ªç¯é»˜è®¤æ˜¯ 128ï¼Œ æ”¹æˆ10 ä¾¿äºè§‚å¯Ÿ MessageQueue é‡Œé¢çš„å†…å®¹</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                &#123;<br>                    <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(<span class="hljs-string">&quot;TopicTest&quot;</span>,<br>                            <span class="hljs-string">&quot;TagA&quot;</span>,<br>                            <span class="hljs-string">&quot;OrderID188&quot;</span>,<br>                            <span class="hljs-string">&quot;Hello world&quot;</span>.getBytes(RemotingHelper.DEFAULT_CHARSET));<br>                    <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> producer.send(msg);<br>                    System.out.printf(<span class="hljs-string">&quot;%s%n&quot;</span>, sendResult);<br>                &#125;<br><br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        producer.shutdown();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>NameServer</code> å’Œ 2 ä¸ª <code>Broker</code> éƒ½å¯åŠ¨ä¹‹åå°±å¯åŠ¨ä¸Šé¢è¯´çš„ <code>Producer</code> ç±»ï¼Œç„¶åè§‚å¯Ÿæ§åˆ¶å°æ‰“å°çš„ç»“æœï¼Œéƒ¨åˆ†ç»“æœå¦‚ä¸‹</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">SendResult [<span class="hljs-attribute">sendStatus</span>=SEND_OK, <span class="hljs-attribute">offsetMsgId</span>=C0A8EF0100002A9F0000000000000000, <span class="hljs-attribute">messageQueue</span>=MessageQueue [<span class="hljs-attribute">topic</span>=TopicTest, <span class="hljs-attribute">brokerName</span>=broker-a, <span class="hljs-attribute">queueId</span>=2], <span class="hljs-attribute">queueOffset</span>=0]<br>SendResult [<span class="hljs-attribute">sendStatus</span>=SEND_OK, <span class="hljs-attribute">offsetMsgId</span>=C0A8EF0100002A9F00000000000000C9, <span class="hljs-attribute">messageQueue</span>=MessageQueue [<span class="hljs-attribute">topic</span>=TopicTest, <span class="hljs-attribute">brokerName</span>=broker-a, <span class="hljs-attribute">queueId</span>=3], <span class="hljs-attribute">queueOffset</span>=0]<br>SendResult [<span class="hljs-attribute">sendStatus</span>=SEND_OK, <span class="hljs-attribute">offsetMsgId</span>=C0A8EF0100002AA30000000000000000, <span class="hljs-attribute">messageQueue</span>=MessageQueue [<span class="hljs-attribute">topic</span>=TopicTest, <span class="hljs-attribute">brokerName</span>=broker-b, <span class="hljs-attribute">queueId</span>=0], <span class="hljs-attribute">queueOffset</span>=0]<br>SendResult [<span class="hljs-attribute">sendStatus</span>=SEND_OK, <span class="hljs-attribute">offsetMsgId</span>=C0A8EF0100002AA300000000000000C9, <span class="hljs-attribute">messageQueue</span>=MessageQueue [<span class="hljs-attribute">topic</span>=TopicTest, <span class="hljs-attribute">brokerName</span>=broker-b, <span class="hljs-attribute">queueId</span>=1], <span class="hljs-attribute">queueOffset</span>=0]<br>SendResult [<span class="hljs-attribute">sendStatus</span>=SEND_OK, <span class="hljs-attribute">offsetMsgId</span>=C0A8EF0100002AA30000000000000192, <span class="hljs-attribute">messageQueue</span>=MessageQueue [<span class="hljs-attribute">topic</span>=TopicTest, <span class="hljs-attribute">brokerName</span>=broker-b, <span class="hljs-attribute">queueId</span>=2], <span class="hljs-attribute">queueOffset</span>=0]<br>SendResult [<span class="hljs-attribute">sendStatus</span>=SEND_OK, <span class="hljs-attribute">offsetMsgId</span>=C0A8EF0100002AA3000000000000025B, <span class="hljs-attribute">messageQueue</span>=MessageQueue [<span class="hljs-attribute">topic</span>=TopicTest, <span class="hljs-attribute">brokerName</span>=broker-b, <span class="hljs-attribute">queueId</span>=3], <span class="hljs-attribute">queueOffset</span>=0]<br>SendResult [<span class="hljs-attribute">sendStatus</span>=SEND_OK, <span class="hljs-attribute">offsetMsgId</span>=C0A8EF0100002A9F0000000000000192, <span class="hljs-attribute">messageQueue</span>=MessageQueue [<span class="hljs-attribute">topic</span>=TopicTest, <span class="hljs-attribute">brokerName</span>=broker-a, <span class="hljs-attribute">queueId</span>=0], <span class="hljs-attribute">queueOffset</span>=0]<br>SendResult [<span class="hljs-attribute">sendStatus</span>=SEND_OK, <span class="hljs-attribute">offsetMsgId</span>=C0A8EF0100002A9F000000000000025B, <span class="hljs-attribute">messageQueue</span>=MessageQueue [<span class="hljs-attribute">topic</span>=TopicTest, <span class="hljs-attribute">brokerName</span>=broker-a, <span class="hljs-attribute">queueId</span>=1], <span class="hljs-attribute">queueOffset</span>=0]<br>SendResult [<span class="hljs-attribute">sendStatus</span>=SEND_OK, <span class="hljs-attribute">offsetMsgId</span>=C0A8EF0100002A9F0000000000000324, <span class="hljs-attribute">messageQueue</span>=MessageQueue [<span class="hljs-attribute">topic</span>=TopicTest, <span class="hljs-attribute">brokerName</span>=broker-a, <span class="hljs-attribute">queueId</span>=2], <span class="hljs-attribute">queueOffset</span>=1]<br>SendResult [<span class="hljs-attribute">sendStatus</span>=SEND_OK, <span class="hljs-attribute">offsetMsgId</span>=C0A8EF0100002A9F00000000000003ED, <span class="hljs-attribute">messageQueue</span>=MessageQueue [<span class="hljs-attribute">topic</span>=TopicTest, <span class="hljs-attribute">brokerName</span>=broker-a, <span class="hljs-attribute">queueId</span>=3], <span class="hljs-attribute">queueOffset</span>=1]<br></code></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢è¾“å‡ºçš„ç»“æœå¯ä»¥å¾—åˆ°ä»¥ä¸‹å‡ ä¸ªç»“è®º</p>
<ol>
<li>è¿™ä¸ª <code>Topic</code> åœ¨æ¯ä¸ª <code>Broker</code> ä¸­éƒ½æœ‰åˆ›å»ºï¼ˆé»˜è®¤ <code>Tppic</code> æ˜¯ä¼šè‡ªåŠ¨åˆ›å»ºçš„ï¼Œå¯ä»¥åœ¨ <code>broker.conf</code> é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  <code>autoCreateTopicEnable=false</code> æ¥ç¦æ­¢è‡ªåŠ¨åˆ›å»º <code>topic</code>ï¼‰</li>
<li>æ¯ä¸€ä¸ª <code>Broker</code> ä¸­é»˜è®¤æœ‰åˆ›å»º 4 ä¸ª <code>Queue</code>ï¼Œåˆ†åˆ«æ˜¯ <code>0</code>ã€<code>1</code>ã€<code>2</code>ã€<code>3</code></li>
</ol>
<h2 id="ä¸ºä»€ä¹ˆä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨åˆ›å»º-Topic"><a href="#ä¸ºä»€ä¹ˆä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨åˆ›å»º-Topic" class="headerlink" title="ä¸ºä»€ä¹ˆä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨åˆ›å»º Topic"></a>ä¸ºä»€ä¹ˆä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨åˆ›å»º Topic</h2><ul>
<li>å®‰å…¨æ€§é—®é¢˜ï¼šè‡ªåŠ¨åˆ›å»º <code>Topic</code> å¯èƒ½ä¼šå¯¼è‡´æœªç»æˆæƒçš„ <code>Topic</code> è¢«åˆ›å»ºï¼Œä»è€Œå¢åŠ äº†ç³»ç»Ÿçš„å®‰å…¨é£é™©ã€‚</li>
<li>é£é™©æ§åˆ¶é—®é¢˜ï¼šå¦‚æœå…è®¸è‡ªåŠ¨åˆ›å»º <code>Topic</code>ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿä¸­å‡ºç°å¤§é‡ä¸å¿…è¦çš„ <code>Topic</code>ï¼Œå¢åŠ äº†ç®¡ç†å’Œç»´æŠ¤çš„éš¾åº¦ã€‚</li>
<li>é…ç½®ç®¡ç†é—®é¢˜ï¼šæ‰‹åŠ¨åˆ›å»º <code>Topic</code> å¯ä»¥æ›´å¥½åœ°æ§åˆ¶ <code>Topic</code> çš„é…ç½®ï¼ŒåŒ…æ‹¬åˆ†åŒºæ•°ã€å‰¯æœ¬æ•°ç­‰ï¼Œè€Œè‡ªåŠ¨åˆ›å»º <code>Topic</code> åˆ™å¯èƒ½ä¼šå¯¼è‡´é…ç½®çš„æ··ä¹±å’Œä¸ä¸€è‡´ã€‚</li>
<li>æ€§èƒ½é—®é¢˜ï¼šå¤§é‡çš„ä¸å¿…è¦çš„ <code>Topic</code> ä¼šå¢åŠ ç³»ç»Ÿçš„è´Ÿè½½å’Œèµ„æºæ¶ˆè€—ï¼Œå½±å“ç³»ç»Ÿçš„æ€§èƒ½è¡¨ç°</li>
</ul>
<h2 id="Producer-é€‰æ‹©-MessageQueue-çš„é€»è¾‘"><a href="#Producer-é€‰æ‹©-MessageQueue-çš„é€»è¾‘" class="headerlink" title="Producer é€‰æ‹© MessageQueue çš„é€»è¾‘"></a>Producer é€‰æ‹© MessageQueue çš„é€»è¾‘</h2><p><code>Producer</code> å‘é€æ¶ˆæ¯çš„æ ¸å¿ƒé€»è¾‘æ˜¯åœ¨ <code>DefaultMQProducerImpl#sendDefaultImpl</code> æ–¹æ³•ä¸­ï¼Œ æ¥ä¸‹æ¥å°±çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultMQProducerImpl</span> &#123;<br>    <span class="hljs-keyword">private</span> SendResult <span class="hljs-title function_">sendDefaultImpl</span><span class="hljs-params">(</span><br><span class="hljs-params">        Message msg,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> CommunicationMode communicationMode,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> SendCallback sendCallback,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> timeout</span><br><span class="hljs-params">    )</span> <span class="hljs-keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;<br>        <span class="hljs-built_in">this</span>.makeSureStateOK();<br>        Validators.checkMessage(msg, <span class="hljs-built_in">this</span>.defaultMQProducer);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">invokeID</span> <span class="hljs-operator">=</span> random.nextLong();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">beginTimestampFirst</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">beginTimestampPrev</span> <span class="hljs-operator">=</span> beginTimestampFirst;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">endTimestamp</span> <span class="hljs-operator">=</span> beginTimestampFirst;<br>        <span class="hljs-comment">// è·å– Topic, MessageQueue ç­‰æ•°æ®</span><br>        <span class="hljs-type">TopicPublishInfo</span> <span class="hljs-variable">topicPublishInfo</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.tryToFindTopicPublishInfo(msg.getTopic());<br>        <span class="hljs-keyword">if</span> (topicPublishInfo != <span class="hljs-literal">null</span> &amp;&amp; topicPublishInfo.ok()) &#123;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">callTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-type">MessageQueue</span> <span class="hljs-variable">mq</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-type">Exception</span> <span class="hljs-variable">exception</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">timesTotal</span> <span class="hljs-operator">=</span> communicationMode == CommunicationMode.SYNC ? <span class="hljs-number">1</span> + <span class="hljs-built_in">this</span>.defaultMQProducer.getRetryTimesWhenSendFailed() : <span class="hljs-number">1</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">times</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            String[] brokersSent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[timesTotal];<br>            <span class="hljs-keyword">for</span> (; times &lt; timesTotal; times++) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">lastBrokerName</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span> == mq ? <span class="hljs-literal">null</span> : mq.getBrokerName();<br>                <span class="hljs-comment">// selectOneMessageQueue æ–¹æ³•å°±æ˜¯é€‰æ‹© ä¸€ä¸ª MessageQueue è¿›è¡Œå‘é€</span><br>                <span class="hljs-type">MessageQueue</span> <span class="hljs-variable">mqSelected</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.selectOneMessageQueue(topicPublishInfo, lastBrokerName);<br>                <span class="hljs-comment">// åç»­ä»£ç çœç•¥...</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="é€‰æ‹©-MessageQueue-é€»è¾‘é‡ç‚¹1-â€“-Topicå’ŒQueueæ•°æ®çš„æ¥æº"><a href="#é€‰æ‹©-MessageQueue-é€»è¾‘é‡ç‚¹1-â€“-Topicå’ŒQueueæ•°æ®çš„æ¥æº" class="headerlink" title="é€‰æ‹© MessageQueue é€»è¾‘é‡ç‚¹1 â€“ Topicå’ŒQueueæ•°æ®çš„æ¥æº"></a>é€‰æ‹© MessageQueue é€»è¾‘é‡ç‚¹1 â€“ Topicå’ŒQueueæ•°æ®çš„æ¥æº</h3><p>é€‰æ‹©çš„ <code>MessageQueue</code> æ•°æ®æ¥æºæ˜¯ä»  <code>this.tryToFindTopicPublishInfo(msg.getTopic());</code> æ–¹æ³•çš„è¿”å›å€¼ä¸­è·å–çš„ï¼Œ è¿”å›å€¼æ˜¯ <code>TopicPublishInfo</code>ï¼Œ æ¯”å¦‚è¿˜æ˜¯ä»¥å‰é¢ä¸¤ä¸ª <code>Broker</code> ä¸ºä¾‹ï¼Œè·å–çš„ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://s2.loli.net/2023/12/22/PCEi9JLVpn1KeZY.png" alt="Topicå’ŒQueueæ•°æ®æ¥æº"><br>è€Œ <code>tryToFindTopicPublishInfo</code> æ–¹æ³•ä¹Ÿæ˜¯ä» <code>NameServer</code> ä¸­è·å–çš„ï¼Œå‘é€çš„æŒ‡ä»¤ç±»å‹æ˜¯ <code>RequestCode.GET_ROUTEINFO_BY_TOPIC</code>ï¼Œ è¿™é‡Œå¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/e17cf930f952/index.html" title="RocketMQ4ä¸­Nameserverè¯¦è§£">RocketMQ4ä¸­Nameserverè¯¦è§£</a></li></ol>

<p>è¿™é‡Œç®€å•æè¿°ä¸€ä¸‹æ•´ä½“çš„é€»è¾‘</p>
<ol>
<li><code>Broker</code> å¯åŠ¨æ—¶ä¼šåŠ è½½ <code>ROCKETMQ_HOME/store/config/topics.json</code> æ–‡ä»¶ï¼Œè¿™é‡Œé¢ä¿å­˜çš„å°±æ˜¯å½“å‰ <code>Broker</code> ä¸­åˆ›å»ºçš„ <code>Topic</code> æ•°æ®, å°±åƒä¸‹é¢è¿™ç§å½¢å¼(çœç•¥äº†å…¶ä»– <code>Topic</code> çš„æ•°æ®)</li>
</ol>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>	<span class="hljs-attr">&quot;dataVersion&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>		<span class="hljs-attr">&quot;counter&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1703223338653</span><br>	<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>	<span class="hljs-attr">&quot;topicConfigTable&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>		<span class="hljs-attr">&quot;TopicTest&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;order&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;perm&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">6</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;readQueueNums&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;topicFilterType&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;SINGLE_TAG&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;topicName&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;TopicTest&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;topicSysFlag&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;writeQueueNums&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">4</span><br>		<span class="hljs-punctuation">&#125;</span><br>	<span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<ol start="2">
<li><code>Broker</code> åŠ è½½å®Œ <code>Topic</code> æ•°æ®åä¼šå‘é€ <code>RequestCode.REGISTER_BROKER</code> æŒ‡ä»¤ï¼Œå°†è‡ªèº«çš„æ•°æ®å‘é€åˆ° <code>NameServer</code> ä¸­</li>
<li><code>NameServer</code> æ¥æ”¶åˆ° <code>RequestCode.REGISTER_BROKER</code> ä¼šè§£æå‡ºè¯·æ±‚ä¸­çš„æ•°æ®ä¿å­˜åˆ° <code>RouteInfoManager</code> ç±»ä¸­</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RouteInfoManager</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">InternalLogger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> InternalLoggerFactory.getLogger(LoggerName.NAMESRV_LOGGER_NAME);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">BROKER_CHANNEL_EXPIRED_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReadWriteLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();<br>    <span class="hljs-comment">//  ä¿å­˜ topicï¼Œ broker, queue ç›¸å…³çš„æ•°æ®</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;String<span class="hljs-comment">/* topic */</span>, Map&lt;String <span class="hljs-comment">/* brokerName */</span> , QueueData&gt;&gt; topicQueueTable;<br>    <span class="hljs-comment">// ä¿å­˜ broker åœ°å€ç›¸å…³æ•°æ®</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;String<span class="hljs-comment">/* brokerName */</span>, BrokerData&gt; brokerAddrTable;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;String<span class="hljs-comment">/* clusterName */</span>, Set&lt;String<span class="hljs-comment">/* brokerName */</span>&gt;&gt; clusterAddrTable;<br>    <span class="hljs-comment">// ä¿å­˜å­˜æ´»çš„ broker æ•°æ®</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;String<span class="hljs-comment">/* brokerAddr */</span>, BrokerLiveInfo&gt; brokerLiveTable;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;String<span class="hljs-comment">/* brokerAddr */</span>, List&lt;String&gt;<span class="hljs-comment">/* Filter Server */</span>&gt; filterServerTable;<br>&#125;<br></code></pre></td></tr></table></figure>
<ol start="4">
<li><code>Producer</code> å‘é€ <code>RequestCode.GET_ROUTEINFO_BY_TOPIC</code> æŒ‡ä»¤ä» <code>NameServer</code> æŸ¥è¯¢æ•°æ®å…¶å®å°±æ˜¯è·å– <code>Broker</code> æ³¨å†Œæ—¶ç»™ <code>NameServer</code> çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä» <code>RouteInfoManager</code> ç±»ä¸­ç›¸å…³å±æ€§è·å–</li>
</ol>
<h3 id="é€‰æ‹©-MessageQueue-é€»è¾‘é‡ç‚¹2-â€“-Brokerçš„é¿è®©"><a href="#é€‰æ‹©-MessageQueue-é€»è¾‘é‡ç‚¹2-â€“-Brokerçš„é¿è®©" class="headerlink" title="é€‰æ‹© MessageQueue é€»è¾‘é‡ç‚¹2 â€“ Brokerçš„é¿è®©"></a>é€‰æ‹© MessageQueue é€»è¾‘é‡ç‚¹2 â€“ Brokerçš„é¿è®©</h3><p>å¯¹äºé€‰æ‹© <code>MessageQueue</code> è¿˜éœ€è¦å…³æ³¨çš„å°±æ˜¯æœ‰ä¸€ä¸ªé€‰æ‹© <code>Broker</code> æ—¶çš„ <strong>é¿è®©</strong> é€»è¾‘ï¼Œå³å½“å‰é¢å‘é€æ¶ˆæ¯å¤±è´¥æ—¶ï¼Œåœ¨é‡è¯•çš„æ—¶å€™ä¸ä¼šé€‰æ‹©åˆ°ä¸Šä¸€æ¬¡å‘é€çš„ <code>Broker</code> ( å› ä¸º <code>Queue</code> æ˜¯åˆ†é…åœ¨ <code>Broker</code> ä¸Šçš„ï¼Œæ‰€ä»¥é€‰æ‹© <code>Queue</code> ä¹Ÿå¯ä»¥è®¤ä¸ºå°±æ˜¯é€‰æ‹© <code>Broker</code> )</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// org.apache.rocketmq.client.latency.MQFaultStrategy#selectOneMessageQueue ç±»</span><br><span class="hljs-keyword">public</span> MessageQueue <span class="hljs-title function_">selectOneMessageQueue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> TopicPublishInfo tpInfo, <span class="hljs-keyword">final</span> String lastBrokerName, <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> resetIndex)</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœæ˜¯é‡è¯•çš„è¯ï¼ŒlastBrokerNameå°±ä¸ä¸ºç©ºï¼ŒBrokerFilter ä¸­å°±åŒ…å« lastBrokerName å­—æ®µ</span><br>    <span class="hljs-type">BrokerFilter</span> <span class="hljs-variable">brokerFilter</span> <span class="hljs-operator">=</span> threadBrokerFilter.get();<br>    brokerFilter.setLastBrokerName(lastBrokerName);<br>    <span class="hljs-comment">// çœç•¥éƒ¨åˆ†ä»£ç </span><br><br>    <span class="hljs-comment">// è¿™é‡Œ BrokerFilter å°±æ˜¯ç”¨æ¥è¿‡æ»¤ä¸Šä¸€æ¬¡å‘é€å¤±è´¥çš„ Broker çš„</span><br>    <span class="hljs-type">MessageQueue</span> <span class="hljs-variable">mq</span> <span class="hljs-operator">=</span> tpInfo.selectOneMessageQueue(brokerFilter);<br>    <span class="hljs-keyword">if</span> (mq != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> mq;<br>    &#125;<br>    <span class="hljs-keyword">return</span> tpInfo.selectOneMessageQueue();<br>&#125;<br><br><span class="hljs-comment">//  selectOneMessageQueue ç±»çš„å†…éƒ¨ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BrokerFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">QueueFilter</span> &#123;<br>    <span class="hljs-keyword">private</span> String lastBrokerName;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLastBrokerName</span><span class="hljs-params">(String lastBrokerName)</span> &#123;<br>        <span class="hljs-built_in">this</span>.lastBrokerName = lastBrokerName;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">filter</span><span class="hljs-params">(MessageQueue mq)</span> &#123;<br>        <span class="hljs-keyword">if</span> (lastBrokerName != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> !mq.getBrokerName().equals(lastBrokerName);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  TopicPublishInfo ç±»</span><br><span class="hljs-keyword">private</span> MessageQueue <span class="hljs-title function_">selectOneMessageQueue</span><span class="hljs-params">(List&lt;MessageQueue&gt; messageQueueList, ThreadLocalIndex sendQueue, QueueFilter ...filter)</span> &#123;<br>    <span class="hljs-keyword">if</span> (messageQueueList == <span class="hljs-literal">null</span> || messageQueueList.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (filter != <span class="hljs-literal">null</span> &amp;&amp; filter.length != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; messageQueueList.size(); i++) &#123;<br>            <span class="hljs-comment">//  å¯¹é˜Ÿåˆ—çš„æ•°é‡è¿›è¡Œå–æ¨¡è¿ç®—</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> Math.abs(sendQueue.incrementAndGet() % messageQueueList.size());<br>            <span class="hljs-type">MessageQueue</span> <span class="hljs-variable">mq</span> <span class="hljs-operator">=</span> messageQueueList.get(index);<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">filterResult</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>            <span class="hljs-comment">// è¿›è¡Œè¿‡æ»¤ï¼Œè°ƒç”¨ QueueFilterçš„filter æ–¹æ³•</span><br>            <span class="hljs-keyword">for</span> (QueueFilter f: filter) &#123;<br>                Preconditions.checkNotNull(f);<br>                filterResult &amp;= f.filter(mq);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (filterResult) &#123;<br>                <span class="hljs-keyword">return</span> mq;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> Math.abs(sendQueue.incrementAndGet() % messageQueueList.size());<br>    <span class="hljs-keyword">return</span> messageQueueList.get(index);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="ä¸ºä»€ä¹ˆéœ€è¦é¿è®©é€»è¾‘è€Œä¸æ˜¯ç›´æ¥åˆ é™¤-Broker-ä¿¡æ¯"><a href="#ä¸ºä»€ä¹ˆéœ€è¦é¿è®©é€»è¾‘è€Œä¸æ˜¯ç›´æ¥åˆ é™¤-Broker-ä¿¡æ¯" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦é¿è®©é€»è¾‘è€Œä¸æ˜¯ç›´æ¥åˆ é™¤ Broker ä¿¡æ¯"></a>ä¸ºä»€ä¹ˆéœ€è¦é¿è®©é€»è¾‘è€Œä¸æ˜¯ç›´æ¥åˆ é™¤ Broker ä¿¡æ¯</h4><p>å½“é€‰æ‹©ä¸€ä¸ª <code>Broker</code> å‘é€æ¶ˆæ¯æ—¶è‹¥å‘é€å¤±è´¥ï¼Œè¯´æ˜ <code>Broker</code> å¯èƒ½å®•æœºäº†ï¼Œå¯¹äºæ­¤æ¬¡æ¶ˆæ¯å‘é€è€Œå†æ¬¡é€‰æ‹©æ—¶æœ€å¥½æ—¶é¿å…é€‰åˆ°è¯¥ <code>Broker</code>ï¼Œæ‰€ä»¥éœ€è¦è®°å½•ä¸Šä¸€æ¬¡å‘é€çš„ <code>Broker</code>, å†æ¬¡é€‰æ‹©æ—¶é¿å…é€‰æ‹©åˆ°</p>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆè¦è®°å½•ä¸Šä¸€æ¬¡å‘é€å¤±è´¥çš„ <code>Broker</code>ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ é™¤å¤±è´¥çš„ <code>Broker</code> ä¿¡æ¯å‘¢ï¼Ÿå› ä¸º <code>Producer</code> ä¼šå®šæœŸä» <code>NameServer</code> è·å– <code>Broker</code> çš„çŠ¶æ€ï¼Œæ‰€ä»¥ç»´æŠ¤ <code>Broker</code> çŠ¶æ€çš„è¿™ä»¶äº‹æƒ…å…¶å®æ˜¯æœ‰å¦å¤–çš„çº¿ç¨‹åœ¨åšï¼Œé‚£ä¹ˆå¯¹äºæ­¤æ¬¡å‘é€æ¶ˆæ¯çš„çº¿ç¨‹æ¥è¯´åªè¦ç®€å•æ’é™¤ä¸€ä¸‹å‘é€å¤±è´¥çš„ <code>Broker</code> å³å¯</p>
<h2 id="readQueue-å’Œ-writeQueue-çš„ä½œç”¨"><a href="#readQueue-å’Œ-writeQueue-çš„ä½œç”¨" class="headerlink" title="readQueue å’Œ writeQueue çš„ä½œç”¨"></a>readQueue å’Œ writeQueue çš„ä½œç”¨</h2><p>åœ¨ <code>RocketMQ</code> ä¸­ <code>Queue</code> çš„æ•°é‡åˆ†ä¸º <code>readQueueNums</code> å’Œ <code>writeQueueNums</code>ï¼Œ é€šè¿‡ <code>org.apache.rocketmq.common.protocol.route.QueueData</code> çš„å±æ€§ä¹Ÿèƒ½çœ‹å‡ºæ¥</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QueueData</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparable</span>&lt;QueueData&gt; &#123;<br>    <span class="hljs-keyword">private</span> String brokerName;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> readQueueNums;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> writeQueueNums;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> perm;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> topicSysFlag;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>ä¸è¿‡è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™å¹¶ä¸ä»£è¡¨æœ‰ä¸¤ç§ç±»å‹çš„ Queue, è¿™é‡Œçš„ readQueueNums å’Œ writeQueueNums åªæ˜¯å•çº¯çš„ä»£è¡¨æ•°é‡</strong></p>
<p><strong>readQueueNums</strong><br><code>readQueueNums</code> æ˜¯å¯¹æ¶ˆè´¹è€…èµ·ä½œç”¨ï¼Œå› ä¸ºæ¶ˆè´¹è€…å¯åŠ¨æ—¶éœ€è¦è¯»å– <code>Queue</code> çš„æ•°é‡ï¼ˆè¿™ä¸ªæ•°é‡å°±æ˜¯ <code>readQueueNums</code> ï¼‰ï¼Œç„¶åå°†æ¶ˆè´¹è€…ä¸ <code>Queue</code> è¿›è¡Œç»‘å®šï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªæ¶ˆè´¹è€…éœ€è¦æ¶ˆè´¹å“ªäº› <code>Queue</code> çš„æ¶ˆæ¯ï¼Œç‰©ç†ä¸Šå®é™…å­˜åœ¨çš„ <code>Queue</code> çš„æ•°é‡</p>
<p><strong>writeQueueNums</strong><br><code>writeQueueNums</code> æ˜¯å¯¹ç”Ÿäº§è€…èµ·ä½œç”¨ï¼Œå› ä¸ºç”Ÿäº§è€…å¯åŠ¨æ—¶éœ€è¦çŸ¥é“ <code>Queue</code> çš„æ•°é‡ï¼ˆè¿™ä¸ªæ•°é‡å°±æ˜¯ <code>writeQueueNums</code> ï¼‰ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ª <code>Queue</code> å°†æ¶ˆæ¯å†™å…¥ï¼Œç‰©ç†ä¸Šä¼šåˆ›å»ºçš„ <code>Queue</code> çš„æ•°é‡æ˜¯ç­‰äº <code>writeQueueNums</code> çš„ã€‚</p>
<ul>
<li>ä¸€èˆ¬æƒ…å†µä¸‹ <code>readQueueNums = writeQueueNums</code></li>
<li>å½“ <code>readQueueNums &gt; writeQueueNums</code>, æ¯”å¦‚ <code>readQueueNums=5</code>ï¼Œ <code>writeQueueNums=3</code> æ—¶ï¼Œæ­¤æ—¶çš„åœºæ™¯å¦‚ä¸‹å›¾æ‰€ç¤º<pre class="mermaid">graph LR
  subgraph B["é˜Ÿåˆ—"]
      direction TB
          B1["Queue0 (çœŸå®å­˜åœ¨)"]
          B2["Queue1 (çœŸå®å­˜åœ¨)"]
          B3["Queue2 (çœŸå®å­˜åœ¨)"]
          style B1 fill:#70b224
          style B2 fill:#70b224
          style B3 fill:#70b224
          B4["Queue3 (ä¸å­˜åœ¨)"]
          B5["Queue4 (ä¸å­˜åœ¨)"]
          style B4 fill:#f9f
          style B5 fill:#f9f
  end

  subgraph C["æ¶ˆè´¹è€…ç»„"]
      direction TB
      C1["æ¶ˆè´¹è€…1"]
      C2["æ¶ˆè´¹è€…2"]
      
  end
  C1-->B1
  C1-->B2
  C2-->B3
  C2-..->B4
  C2-..->B5</pre></li>
</ul>
<p>ä»ä¸Šå›¾å¯çŸ¥ï¼Œè™½ç„¶ <code>Queue3</code> å’Œ <code>Queue4</code> è¢«åˆ†é…ç»™äº† <strong>æ¶ˆè´¹è€…2</strong>ï¼Œ ä½†æ˜¯è¿™ä¸¤ä¸ª <code>Queue</code> å®é™…å¹¶ä¸å­˜åœ¨ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ª <code>Queue</code> ä¸­ä¹Ÿä¸ä¼šæœ‰æ•°æ®ï¼Œå¦‚æœæç«¯ä¸€ç‚¹ï¼Œæœ‰äº”ä¸ªæ¶ˆè´¹è€…ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªæ¶ˆè´¹è€…éƒ½ä¼šåˆ†é…åˆ°ä¸€ä¸ª <code>Queue</code>,è¿™æ ·å°±ä¼šæœ‰ä¸¤ä¸ªæ¶ˆè´¹è€…æ ¹æœ¬æ²¡æœ‰æ•°æ®æ¶ˆè´¹</p>
<h3 id="readQueueNums-writeQueueNums-çš„åœºæ™¯"><a href="#readQueueNums-writeQueueNums-çš„åœºæ™¯" class="headerlink" title="readQueueNums &gt; writeQueueNums çš„åœºæ™¯"></a><code>readQueueNums &gt; writeQueueNums</code> çš„åœºæ™¯</h3><ul>
<li>è¿™ç§åœºæ™¯æ˜¯ä¸ºäº†å¹³æ»‘<strong>æ‰©å®¹æ¶ˆè´¹è€…</strong>çš„åœºæ™¯å‡†å¤‡çš„ï¼Œ æ¶ˆè´¹è€…çš„å¹¶å‘é‡æ˜¯ä¸å¯èƒ½è¶…è¿‡ <code>Queue</code> çš„æ•°é‡çš„ï¼Œè¦æƒ³å¢åŠ æ¶ˆè´¹è€…ï¼Œå¾ˆå¯èƒ½å°±è¦å¢åŠ  <code>Queue</code>, å‡å¦‚åªæœ‰ä¸€ç§ç±»å‹çš„ <code>Queue</code>, å½“å¢åŠ  <code>Queue</code> ä¹‹åï¼ŒåŸæ¥æ¯ä¸ªæ¶ˆè´¹è€…çš„å‹åŠ›å¯èƒ½ä¼šå¢å¤§ï¼Œè¿™æ˜¯æœ‰ä¸€å®šé£é™©çš„</li>
<li><code>readQueue</code> å’Œ <code>writeQueue</code> åˆ†å¼€ä¹‹åï¼Œå°±å¯ä»¥åœ¨ä¸åœæœºçš„æƒ…å†µä¸‹å…ˆå¢åŠ  <code>readQueue</code> çš„æ•°é‡ï¼Œè¿™äº›å¢åŠ çš„ <code>readQueue</code> æ˜¯æ²¡æœ‰æ•°æ®çš„ï¼Œç„¶åå†å¢åŠ æ¶ˆè´¹è€…ï¼Œè¿™æ ·æ¶ˆè´¹è€…å‹åŠ›å¹¶æ²¡æœ‰å¢å¤§ï¼Œæœ€åå†å¢åŠ  <code>writeQueue</code> æ•°é‡å’Œ <code>readQueue</code> æ•°é‡ä¸€è‡´ï¼Œå°±å®Œæˆäº†æ‰©å®¹</li>
</ul>
<h3 id="writeQueueNums-readQueueNums-çš„åœºæ™¯"><a href="#writeQueueNums-readQueueNums-çš„åœºæ™¯" class="headerlink" title="writeQueueNums &gt; readQueueNums çš„åœºæ™¯"></a><code>writeQueueNums &gt; readQueueNums</code> çš„åœºæ™¯</h3><ul>
<li>è¿™ç§åœºæ™¯æ˜¯ä¸ºäº†ç¼©å®¹çš„åœºæ™¯å‡†å¤‡çš„ï¼Œ å…ˆå‡å°‘ <code>writeQueue</code> çš„æ•°é‡ï¼Œ æ¯”å¦‚ä» 5 -&gt; 3, å½“ 4 å·å’Œ 5 å· <code>Queue</code> æ¶ˆè´¹å®Œæˆåï¼Œå†å°† <code>readQueue</code> æ•°é‡å‡å°‘åˆ° 3ï¼Œ æœ€å¥½åœæ‰éƒ¨åˆ†æ¶ˆè´¹è€…ï¼Œå°±å®Œæˆäº†ç¼©å®¹</li>
</ul>
<h2 id="æ‰¹é‡æ¶ˆæ¯"><a href="#æ‰¹é‡æ¶ˆæ¯" class="headerlink" title="æ‰¹é‡æ¶ˆæ¯"></a>æ‰¹é‡æ¶ˆæ¯</h2><ul>
<li>æ‰¹é‡æ¶ˆæ¯å‘é€æ˜¯å°†åŒä¸€ä¸»é¢˜çš„å¤šæ¡æ¶ˆæ¯ä¸€èµ·æ‰“åŒ…å‘é€åˆ°æ¶ˆæ¯æœåŠ¡ç«¯ï¼Œå‡å°‘ç½‘ç»œè°ƒç”¨æ¬¡æ•°ï¼Œæé«˜ç½‘ç»œä¼ è¾“æ•ˆç‡</li>
<li>å•æ‰¹æ¬¡æ¶ˆæ¯å‘é€æ€»é•¿åº¦ä¸èƒ½è¶…è¿‡ <code>MQProducer#maxMessageSize</code></li>
<li>æ‰¹é‡æ¶ˆæ¯å‘é€è¦è§£å†³çš„æ˜¯å¦‚ä½•å°†è¿™äº›æ¶ˆæ¯ç¼–ç ä»¥ä¾¿æœåŠ¡ç«¯èƒ½å¤Ÿæ­£ç¡®è§£ç å‡ºæ¯æ¡æ¶ˆæ¯çš„æ¶ˆæ¯å†…å®¹</li>
</ul>
<p>éæ‰¹é‡æ¶ˆæ¯ä½¿ç”¨çš„æ¶ˆæ¯æ‰¿è½½ç»“æ„æ˜¯ <code>Message</code> ç±»<br>æ‰¹é‡æ¶ˆæ¯ä½¿ç”¨çš„æ¶ˆæ¯æ‰¿è½½ç»“æ„æ˜¯ <code>MessageBatch</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">8445773977080406428L</span>;<br><br>    <span class="hljs-keyword">private</span> String topic;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> flag;<br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; properties;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] body;<br>    <span class="hljs-keyword">private</span> String transactionId;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageBatch</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Message</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Iterable</span>&lt;Message&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">621335151046335557L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Message&gt; messages;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">MessageBatch</span><span class="hljs-params">(List&lt;Message&gt; messages)</span> &#123;<br>        <span class="hljs-built_in">this</span>.messages = messages;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>MessageBatch</code> ç»§æ‰¿äº† <code>Message</code>, åŒæ—¶å«æœ‰ <code>List&lt;Message&gt; messages</code> å±æ€§ï¼Œæ‰€ä»¥æ¶ˆæ¯å‘é€å’Œå•æŒ‘æ¶ˆæ¯å‘é€é€»è¾‘æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼ˆ <code>java</code> å¤šæ€çš„ä½¿ç”¨ï¼Œæ–¹æ³•ä¸­æ¥æ”¶ <code>Message</code> ç±»å‹çš„å‚æ•°ä¹Ÿå¯ä»¥æ¥æ”¶ <code>MessageBatch</code> ï¼‰</p>
<p>æ¯ä¸€æ¡æ¶ˆæ¯ä¼ é€’çš„æ—¶å€™æœ€ç»ˆæ˜¯è¦åºåˆ—åŒ–æˆ <code>byte[]</code>, æ‰¹é‡æ¶ˆæ¯çš„å‘é€æµç¨‹æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œä½†æ˜¯æ¶ˆæ¯ç¼–ç å’Œè§£ææ˜¯ä¸åŒçš„ï¼Œåœ¨ <code>MessageBatch</code> ä¸­æœ‰ä¸€ä¸ªæ ¸å¿ƒæ–¹æ³•å°±æ˜¯å¯¹æ¶ˆæ¯è¿›è¡Œç¼–ç çš„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageBatch</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Message</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Iterable</span>&lt;Message&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">621335151046335557L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Message&gt; messages;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">MessageBatch</span><span class="hljs-params">(List&lt;Message&gt; messages)</span> &#123;<br>        <span class="hljs-built_in">this</span>.messages = messages;<br>    &#125;<br><br>    <span class="hljs-comment">// å¯¹æ¶ˆæ¯è¿›è¡Œç¼–ç ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯ MessageDecoder.encodeMessages æ–¹æ³•</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] encode() &#123;<br>        <span class="hljs-keyword">return</span> MessageDecoder.encodeMessages(messages);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageDecoder</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] encodeMessages(List&lt;Message&gt; messages) &#123;<br>        <span class="hljs-comment">//TO DO refactor, accumulate in one buffer, avoid copies</span><br>        List&lt;<span class="hljs-type">byte</span>[]&gt; encodedMessages = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;<span class="hljs-type">byte</span>[]&gt;(messages.size());<br>        <span class="hljs-type">int</span> <span class="hljs-variable">allSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (Message message : messages) &#123;<br>            <span class="hljs-type">byte</span>[] tmp = encodeMessage(message);<br>            encodedMessages.add(tmp);<br>            allSize += tmp.length;<br>        &#125;<br>        <span class="hljs-type">byte</span>[] allBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[allSize];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">pos</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span>[] bytes : encodedMessages) &#123;<br>            System.arraycopy(bytes, <span class="hljs-number">0</span>, allBytes, pos, bytes.length);<br>            pos += bytes.length;<br>        &#125;<br>        <span class="hljs-keyword">return</span> allBytes;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] encodeMessage(Message message) &#123;<br>        <span class="hljs-comment">//only need flag, body, properties</span><br>        <span class="hljs-type">byte</span>[] body = message.getBody();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">bodyLen</span> <span class="hljs-operator">=</span> body.length;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> messageProperties2String(message.getProperties());<br>        <span class="hljs-type">byte</span>[] propertiesBytes = properties.getBytes(CHARSET_UTF8);<br>        <span class="hljs-comment">//note properties length must not more than Short.MAX</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">propsLen</span> <span class="hljs-operator">=</span> propertiesBytes.length;<br>        <span class="hljs-keyword">if</span> (propsLen &gt; Short.MAX_VALUE)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(String.format(<span class="hljs-string">&quot;Properties size of message exceeded, properties size: &#123;&#125;, maxSize: &#123;&#125;.&quot;</span>, propsLen, Short.MAX_VALUE));<br>        <span class="hljs-type">short</span> <span class="hljs-variable">propertiesLength</span> <span class="hljs-operator">=</span> (<span class="hljs-type">short</span>) propsLen;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">sysFlag</span> <span class="hljs-operator">=</span> message.getFlag();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">storeSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span> <span class="hljs-comment">// 1 TOTALSIZE</span><br>            + <span class="hljs-number">4</span> <span class="hljs-comment">// 2 MAGICCOD</span><br>            + <span class="hljs-number">4</span> <span class="hljs-comment">// 3 BODYCRC</span><br>            + <span class="hljs-number">4</span> <span class="hljs-comment">// 4 FLAG</span><br>            + <span class="hljs-number">4</span> + bodyLen <span class="hljs-comment">// 4 BODY</span><br>            + <span class="hljs-number">2</span> + propertiesLength;<br>        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">byteBuffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(storeSize);<br>        <span class="hljs-comment">// 1 TOTALSIZE</span><br>        byteBuffer.putInt(storeSize);<br><br>        <span class="hljs-comment">// 2 MAGICCODE</span><br>        byteBuffer.putInt(<span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">// 3 BODYCRC</span><br>        byteBuffer.putInt(<span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">// 4 FLAG</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> message.getFlag();<br>        byteBuffer.putInt(flag);<br><br>        <span class="hljs-comment">// 5 BODY</span><br>        byteBuffer.putInt(bodyLen);<br>        byteBuffer.put(body);<br><br>        <span class="hljs-comment">// 6 properties</span><br>        byteBuffer.putShort(propertiesLength);<br>        byteBuffer.put(propertiesBytes);<br><br>        <span class="hljs-keyword">return</span> byteBuffer.array();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æœ€ç»ˆæ‰€æœ‰çš„æ¶ˆæ¯å†…å®¹å­˜æ”¾åœ¨ <code>byte[]</code> ä¸­ï¼Œé‚£ä¹ˆè¦æ€ä¹ˆåŒºåˆ†æ¯ä¸€ä¸ªæ¶ˆæ¯å ç”¨çš„éƒ¨åˆ†æ˜¯å¤šå°‘å‘¢ï¼Ÿ æ¯”å¦‚ä¸€å…± 80 å­—èŠ‚ï¼Œ5ä¸ªæ¶ˆæ¯ï¼Œè¦çŸ¥é“æ¯ä¸ªæ¶ˆæ¯çš„å†…å®¹ä¸åŒï¼Œæ¶ˆæ¯é•¿åº¦è‚¯å®šä¸åŒï¼Œæ‰€ä»¥ä¸å¯èƒ½æ˜¯å¹³åˆ†ï¼Œæ‰€ä»¥å¿…ç„¶æ˜¯è¦è®¾è®¡å‡º <strong>ä¸å˜çš„ç»“æ„ + å¯å˜çš„å†…å®¹</strong></p>
<h3 id="ä¸å˜çš„ç»“æ„"><a href="#ä¸å˜çš„ç»“æ„" class="headerlink" title="ä¸å˜çš„ç»“æ„"></a>ä¸å˜çš„ç»“æ„</h3><p>ä»ä¸Šé¢ <code>encodeMessage</code> è¿™ä¸ªæ–¹æ³•å¯ä»¥çœ‹å‡ºæ˜¯å¦‚ä½•å¯¹å•æŒ‘æ¶ˆæ¯è¿›è¡Œç¼–ç çš„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">byteBuffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(storeSize);<br><span class="hljs-comment">// 1 TOTALSIZE</span><br>byteBuffer.putInt(storeSize);<br><span class="hljs-comment">// 2 MAGICCODE</span><br>byteBuffer.putInt(<span class="hljs-number">0</span>);<br><span class="hljs-comment">// 3 BODYCRC</span><br>byteBuffer.putInt(<span class="hljs-number">0</span>);<br><span class="hljs-comment">// 4 FLAG</span><br><span class="hljs-type">int</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> message.getFlag();<br>byteBuffer.putInt(flag);<br><span class="hljs-comment">// 5 BODY</span><br>byteBuffer.putInt(bodyLen);<br>byteBuffer.put(body);<br><span class="hljs-comment">// 6 properties</span><br>byteBuffer.putShort(propertiesLength);<br>byteBuffer.put(propertiesBytes);<br><span class="hljs-keyword">return</span> byteBuffer.array();<br></code></pre></td></tr></table></figure>
<p>é‚£ä¹ˆé‚£éƒ¨åˆ†æ˜¯ä¸å˜çš„å‘¢ï¼Ÿ å…¶å®çœ‹ <code>byteBuffer.putInt()</code>, <code>byteBuffer.putShort()</code> ç­‰æ–¹æ³•å°±çŸ¥é“è¿™æ˜¯ä¸å˜çš„éƒ¨åˆ†ï¼Œå› ä¸ºè¿™é‡Œæ˜¯æ·»åŠ å›ºå®šé•¿åº¦çš„å­—èŠ‚ï¼Œè€Œå¯¹äº <code>byteBuffer.putï¼ˆï¼‰</code> æ–¹æ³•å°±æ˜¯å¯å˜çš„éƒ¨åˆ†</p>
<pre class="mermaid">graph LR
    subgraph M1["ç¬¬ä¸€æ¡æ¶ˆæ¯"]
        A["æ€»é•¿åº¦(TOTALSIZE) å›ºå®šé•¿åº¦ï¼Œ4å­—èŠ‚"]
        B["é­”æ•°ï¼ˆMAGICCODEï¼‰å›ºå®šé•¿åº¦ 4å­—èŠ‚"]
        C["(BODYCRC) å›ºå®šé•¿åº¦ 4å­—èŠ‚"]
        D["(FLAG) å›ºå®šé•¿åº¦ 4å­—èŠ‚"]
        subgraph E["æ¶ˆæ¯ä¸»ä½“"]
            E1["æ¶ˆæ¯é•¿åº¦ï¼ˆbody_lengthï¼‰å›ºå®šé•¿åº¦ 4å­—èŠ‚"]
            E2["å…·ä½“æ¶ˆæ¯å†…å®¹ï¼Œé•¿åº¦å¯å˜ï¼Œå…·ä½“é•¿åº¦
            ç”±å‰é¢æ¶ˆæ¯é•¿åº¦å­—æ®µå®šä¹‰"]
        end
        subgraph F["properties å±æ€§"]
            F1["å±æ€§é•¿åº¦ï¼ˆproperties_lengthï¼‰å›ºå®šé•¿åº¦ 2å­—èŠ‚"]
            F2["å…·ä½“å±æ€§å†…å®¹ï¼Œé•¿åº¦å¯å˜ï¼Œå…·ä½“é•¿åº¦
            ç”±å‰é¢å±æ€§é•¿åº¦å­—æ®µå®šä¹‰"]
        end
    end
    subgraph M2["ç¬¬ä¸€æ¡æ¶ˆæ¯"]
        A2["æ€»é•¿åº¦(TOTALSIZE) å›ºå®šé•¿åº¦ï¼Œ4å­—èŠ‚"]
        B2["é­”æ•°ï¼ˆMAGICCODEï¼‰å›ºå®šé•¿åº¦ 4å­—èŠ‚"]
        C2["(BODYCRC) å›ºå®šé•¿åº¦ 4å­—èŠ‚"]
        D2["(FLAG) å›ºå®šé•¿åº¦ 4å­—èŠ‚"]
        subgraph EE["æ¶ˆæ¯ä¸»ä½“"]
            EE1["æ¶ˆæ¯é•¿åº¦ï¼ˆbody_lengthï¼‰å›ºå®šé•¿åº¦ 4å­—èŠ‚"]
            EE2["å…·ä½“æ¶ˆæ¯å†…å®¹ï¼Œé•¿åº¦å¯å˜ï¼Œå…·ä½“é•¿åº¦
            ç”±å‰é¢æ¶ˆæ¯é•¿åº¦å­—æ®µå®šä¹‰"]
        end
        subgraph FF["properties å±æ€§"]
            FF1["å±æ€§é•¿åº¦ï¼ˆproperties_lengthï¼‰å›ºå®šé•¿åº¦ 2å­—èŠ‚"]
            FF2["å…·ä½“å±æ€§å†…å®¹ï¼Œé•¿åº¦å¯å˜ï¼Œå…·ä½“é•¿åº¦
            ç”±å‰é¢å±æ€§é•¿åº¦å­—æ®µå®šä¹‰"]
        end
    end</pre>]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQä¸­Messageè¯¦è§£</title>
    <url>/2023/cd2da7828738/index.html</url>
    <content><![CDATA[<h2 id="Message-ç±»ç»“æ„"><a href="#Message-ç±»ç»“æ„" class="headerlink" title="Message ç±»ç»“æ„"></a>Message ç±»ç»“æ„</h2><p>åœ¨ <code>RocketMQ</code> çš„å­æ¨¡å— <code>Common</code> ä¸­æœ‰ <code>org.apache.rocketmq.common.message.Message</code> ç±»ï¼Œ åŒ…å«çš„å±æ€§æœ‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">8445773977080406428L</span>;<br><br>    <span class="hljs-keyword">private</span> String topic;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> flag;<br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; properties;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] body;<br>    <span class="hljs-keyword">private</span> String transactionId;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>topic</code>ï¼š æ¶ˆæ¯è¦å‘å¾€åˆ°é‚£ä¸ª <code>topic</code> ä¸­</li>
<li><code>flag</code>: ä½¿ç”¨æ—¶è‡ªå·±è®¾ç½®ï¼Œ<code>RocketMQ</code> æœ¬èº«å¹¶ä¸ä¼šä½¿ç”¨è¿™ä¸ªå­—æ®µï¼Œä½†æ˜¯ä¼šå¸®æˆ‘ä»¬ä»ç”Ÿäº§è€…ç«¯ç›´æ¥ä¼ é€’åˆ°æ¶ˆè´¹è€…ç«¯</li>
<li><code>properties</code>ï¼š è¿™ä¸ªå±æ€§æ˜¯ç”¨æ¥ä¼ é€’ä¸€äº›é¢å¤–çš„ä¿¡æ¯ï¼Œæœ¬è´¨å°±æ˜¯ä¸€ä¸ª <code>Map</code></li>
<li><code>body</code>ï¼š æ¶ˆæ¯ä½“</li>
<li><code>transactionId</code>ï¼š äº‹åŠ¡æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ï¼Œå¦‚æœæ˜¯æ™®é€šæ¶ˆæ¯ï¼Œåˆ™ä¸ºç©º</li>
</ul>
<h2 id="Message-æ„é€ æ–¹æ³•"><a href="#Message-æ„é€ æ–¹æ³•" class="headerlink" title="Message æ„é€ æ–¹æ³•"></a>Message æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">8445773977080406428L</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Message</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Message</span><span class="hljs-params">(String topic, <span class="hljs-type">byte</span>[] body)</span> &#123;&#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Message</span><span class="hljs-params">(String topic, String tags, <span class="hljs-type">byte</span>[] body)</span> &#123;&#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Message</span><span class="hljs-params">(String topic, String tags, String keys, <span class="hljs-type">byte</span>[] body)</span> &#123;&#125;<br><br>    <span class="hljs-comment">// å‰é¢æ‰€æœ‰æ„é€ æ–¹æ³•æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨è¿™ä¸ªæ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥åªåˆ—å‡ºæ¥æœ€ç»ˆçš„è¿™ä¸ªæ„é€ æ–¹æ³•ä»£ç </span><br>    <span class="hljs-comment">// waitStoreMsgOK è¡¨ç¤ºæ˜¯å¦è¦åœ¨è¿™æ¡ Message è½åˆ°ç£ç›˜ä¸Šä¹‹åæ‰è¿”å›åº”ç­”è¿™é‡Œè¯¥å˜é‡çš„å€¼é»˜è®¤ä¸º true</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Message</span><span class="hljs-params">(String topic, String tags, String keys, <span class="hljs-type">int</span> flag, <span class="hljs-type">byte</span>[] body, <span class="hljs-type">boolean</span> waitStoreMsgOK)</span> &#123;<br>        <span class="hljs-built_in">this</span>.topic = topic;<br>        <span class="hljs-built_in">this</span>.flag = flag;<br>        <span class="hljs-built_in">this</span>.body = body;<br><br>        <span class="hljs-comment">// é’ˆå¯¹ Tag å­—æ®µçš„å¤„ç†å®é™…æ˜¯å°†å…¶ä¿å­˜åœ¨ properties ä¸­</span><br>        <span class="hljs-keyword">if</span> (tags != <span class="hljs-literal">null</span> &amp;&amp; tags.length() &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">this</span>.setTags(tags);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (keys != <span class="hljs-literal">null</span> &amp;&amp; keys.length() &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">this</span>.setKeys(keys);<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.setWaitStoreMsgOK(waitStoreMsgOK);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTags</span><span class="hljs-params">(String tags)</span> &#123;<br>        <span class="hljs-built_in">this</span>.putProperty(MessageConst.PROPERTY_TAGS, tags);<br>    &#125;<br><br>    <span class="hljs-comment">// å¯ä»¥çœ‹åˆ°ä¸Šé¢è°ƒç”¨ setTags() æ–¹æ³•æ—¶å®é™…æ˜¯å°†å…¶ä¿å­˜åœ¨ properties ä¸­</span><br>    <span class="hljs-comment">// åªæ˜¯è¿™ä¸ª key æ˜¯å†…éƒ¨ä½¿ç”¨çš„keyï¼Œå†…éƒ¨ key ä¸€èˆ¬éƒ½å®šä¹‰åœ¨ MessageConst ç±»ä¸­</span><br>    <span class="hljs-comment">// æ‰€ä»¥å¦‚æœæˆ‘ä»¬è¦è‡ªå®šä¹‰å­—æ®µï¼Œä¹Ÿæ˜¯é€šè¿‡ propertiesä¼ é€’ï¼Œä½†æ˜¯key å°±ä¸è¦ä½¿ç”¨å†…éƒ¨keyäº†</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">putProperty</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String name, <span class="hljs-keyword">final</span> String value)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == <span class="hljs-built_in">this</span>.properties) &#123;<br>            <span class="hljs-built_in">this</span>.properties = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.properties.put(name, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQä¸­Producerå’ŒProducerGroup</title>
    <url>/2023/254af85a97af/index.html</url>
    <content><![CDATA[<p>RocketMQç‰ˆæœ¬: 5.1.4</p>
<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="Producer-å’Œ-ProducerGroup"><a href="#Producer-å’Œ-ProducerGroup" class="headerlink" title="Producer å’Œ ProducerGroup"></a>Producer å’Œ ProducerGroup</h2><h3 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h3><ul>
<li>Producer æ˜¯ RocketMQ å®¢æˆ·ç«¯ï¼Œè´Ÿè´£å‘ RocketMQ é›†ç¾¤å‘é€æ¶ˆæ¯ã€‚</li>
</ul>
<h3 id="ProducerGroup"><a href="#ProducerGroup" class="headerlink" title="ProducerGroup"></a>ProducerGroup</h3><ul>
<li><code>ProducerGroup</code> æ˜¯ä¸€ç±» <code>Producer</code>, æ¯”å¦‚ç°åœ¨å¤§å¤šéƒ½æ˜¯å¾®æœåŠ¡æ¶æ„ï¼Œè€Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½æ˜¯å¤šå®ä¾‹çš„ï¼Œ å¦‚ä¸‹æ‰€ç¤º</li>
</ul>
<pre class="mermaid">graph LR
    PA["ProducerGroupA"]
    PA--> A1 & A2 & A3 & A4
    subgraph A["æœåŠ¡A"]
        A1("å®ä¾‹1ï¼ˆProducerGroup=GroupAï¼‰")
        A2("å®ä¾‹2ï¼ˆProducerGroup=GroupAï¼‰")
        A3("å®ä¾‹ â€¦â€¦ ")
        A4("å®ä¾‹Mï¼ˆProducerGroup=GroupAï¼‰")
    end
    subgraph B["MessageQueue"]
        B1("MessageQueue1")
        B2("MessageQueue2")
        B3("â€¦â€¦")
        B4("MessageQueue3")
    end
    A1-->B1
    A2-->B2
    A2-->B3
    A4-->B4</pre>

<ul>
<li><p>åŒä¸€ä¸ªæœåŠ¡çš„ä¸åŒå®ä¾‹å±äºåŒä¸€ä¸ª <code>ProducerGroup</code></p>
</li>
<li><p>æ¯ä¸€ä¸ªå®ä¾‹å¯ä»¥å°†æ¶ˆæ¯å‘å¾€å¯¹åº”  <code>Topic</code> çš„å¤šä¸ª <code>Queue</code> ä¸­</p>
</li>
<li><p><code>ProducerGroup</code> çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</p>
</li>
</ul>
<p>ä¸Šé¢æœ‰æåˆ° <code>ProducerGroup</code> æ˜¯ä¸ºäº†å°†ç”Ÿäº§è€…å½’ç±»ï¼Œæ—¢ç„¶æ˜¯å½’ç±»ï¼Œé‚£å°±æ˜¯ä¸ºäº†æ–¹ä¾¿æ‰¾åˆ°åŒç±»ç”Ÿäº§è€…ï¼Ÿé‚£ä¸ºä»€ä¹ˆè¦æ‰¾åˆ°åŒç±»ç”Ÿäº§è€…å‘¢ï¼Ÿè¿™é‡Œå’Œ <strong>äº‹åŠ¡æ¶ˆæ¯</strong> æœ‰å…³ï¼Œäº‹åŠ¡æ¶ˆæ¯æ˜¯åˆ†æˆäº†å¤šä¸ªé˜¶æ®µï¼Œå¦‚æœæŸä¸ªç”Ÿäº§è€…åœ¨äº‹åŠ¡æ¶ˆæ¯çš„å…¶ä¸­ä¸€ä¸ªé˜¶æ®µå¤±è´¥äº†ï¼Œé‚£å°±å¯ä»¥æ‰¾åˆ°åŒç±»ç”Ÿäº§è€…ï¼ˆä¹Ÿå°±æ˜¯åŒä¸€ä¸ªæœåŠ¡çš„å…¶ä»–å®ä¾‹ï¼‰æ¥è¿›è¡Œåç»­çš„æ“ä½œ <strong>è¿™é‡Œè¦è®°ä½çš„é‡ç‚¹æ˜¯å±äºåŒä¸€ä¸ªç»„çš„ç”Ÿäº§è€…ä»–ä»¬å‘é€æ¶ˆæ¯çš„topicå’Œå¯¹åº”çš„æ“ä½œéƒ½æ˜¯ç›¸åŒçš„</strong></p>
<h2 id="ç”Ÿäº§è€…åˆå§‹åŒ–æµç¨‹"><a href="#ç”Ÿäº§è€…åˆå§‹åŒ–æµç¨‹" class="headerlink" title="ç”Ÿäº§è€…åˆå§‹åŒ–æµç¨‹"></a>ç”Ÿäº§è€…åˆå§‹åŒ–æµç¨‹</h2><p>åœ¨ <code>RocketMQ</code> æºç çš„ <code>example</code> æ¨¡å—ä¸‹å¯ä»¥æ‰¾åˆ° <code>org.apache.rocketmq.example.simple.Producer</code> æµ‹è¯•ç±»ï¼Œè¯¥ç±»å°±æ˜¯æµ‹è¯•æ¶ˆæ¯å‘é€æµç¨‹çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRODUCER_GROUP</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ProducerGroupName&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMESRVADDR</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;127.0.0.1:9876&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TopicTest&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TagA&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException, InterruptedException &#123;<br>        <span class="hljs-comment">// 1. å®ä¾‹åŒ–</span><br>        <span class="hljs-type">DefaultMQProducer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQProducer</span>(PRODUCER_GROUP);<br>        producer.setNamesrvAddr(DEFAULT_NAMESRVADDR);<br><br>        <span class="hljs-comment">// 2. åˆå§‹åŒ–</span><br>        producer.start();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">128</span>; i++) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(TOPIC, TAG, <span class="hljs-string">&quot;OrderID188&quot;</span>, <span class="hljs-string">&quot;Hello world&quot;</span>.getBytes(StandardCharsets.UTF_8));<br><br>                <span class="hljs-comment">// 3. å‘é€æ¶ˆæ¯</span><br>                <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> producer.send(msg);<br>                System.out.printf(<span class="hljs-string">&quot;%s%n&quot;</span>, sendResult);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        producer.shutdown();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ä½¿ç”¨ ç”Ÿäº§è€…çš„ä½¿ç”¨ä¸»è¦å¦‚ä¸‹ä¸‰ä¸ªæ­¥éª¤</p>
<ol>
<li>å®ä¾‹åŒ– <code>Producer</code></li>
<li>åˆå§‹åŒ– <code>Producer</code></li>
<li>å‘é€æ¶ˆæ¯</li>
</ol>
<h3 id="å®ä¾‹åŒ–"><a href="#å®ä¾‹åŒ–" class="headerlink" title="å®ä¾‹åŒ–"></a>å®ä¾‹åŒ–</h3><p>å®ä¾‹åŒ– <code>Producer</code>, è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>DefaultMQProducer</code>, ä½†æ˜¯çœŸæ­£æ‰§è¡Œæ¶ˆæ¯å‘é€çš„è¿˜æ˜¯ <code>DefaultMQProducerImpl</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultMQProducer</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String namespace, <span class="hljs-keyword">final</span> String producerGroup, RPCHook rpcHook)</span> &#123;<br>    <span class="hljs-built_in">this</span>.namespace = namespace;<br>    <span class="hljs-built_in">this</span>.producerGroup = producerGroup;<br>    defaultMQProducerImpl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQProducerImpl</span>(<span class="hljs-built_in">this</span>, rpcHook);<br>    <span class="hljs-comment">// produceAccumulator å’Œæ‰¹é‡æ¶ˆæ¯æœ‰å…³</span><br>    produceAccumulator = MQClientManager.getInstance().getOrCreateProduceAccumulator(<span class="hljs-built_in">this</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p>åœ¨è®²è§£åˆå§‹åŒ–ä¹‹å‰éœ€è¦å¯ä»¥å…ˆäº†è§£ä¸‹ç›¸å…³çš„ç±»</p>
<ul>
<li><code>MQClientInstance</code>ï¼š ä»£è¡¨çš„æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯å®ä¾‹ï¼ˆ <code>Producer</code> å’Œ <code>Consumer</code> éƒ½æ˜¯å®¢æˆ·ç«¯å®ä¾‹ï¼‰ï¼Œé‡Œé¢ä¼šä¿å­˜æœ‰å®¢æˆ·ç«¯ç›¸å…³çš„é…ç½®ï¼Œæ¯”å¦‚ <code>namesrvAddr</code>ï¼Œ <code>clientIP</code>ï¼Œ å‘é€æ¶ˆæ¯ç›¸å…³çš„ <code>Topic</code> ç­‰ä¿¡æ¯</li>
<li><code>MQClientManager</code>ï¼š ä»£è¡¨çš„æ˜¯å®¢æˆ·ç«¯ç®¡ç†å™¨ï¼ŒåŒä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¯åŠ¨å¤šä¸ª <code>Producer</code> å’Œ <code>Consumer</code> å®ä¾‹ï¼Œå³å¯ä»¥è®¤ä¸ºæœ‰å¤šä¸ª <code>MQClientInstance</code>ï¼Œ <code>MQClientManager</code> å°±æ˜¯ç®¡ç†å¤šä¸ª <code>MQClientInstance</code></li>
</ul>
<p>åˆå§‹åŒ– <code>Producer</code>, ä¸»è¦æ˜¯è°ƒç”¨ <code>DefaultMQProducer#start()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> MQClientException &#123;<br>    <span class="hljs-built_in">this</span>.setProducerGroup(withNamespace(<span class="hljs-built_in">this</span>.producerGroup));<br>    <span class="hljs-comment">// å› ä¸ºå®é™…å‘é€æ¶ˆæ¯çš„æ˜¯ DefaultMQProducerImplï¼Œ æ‰€ä»¥é‡ç‚¹çœ‹è¿™ä¸ª</span><br>    <span class="hljs-built_in">this</span>.defaultMQProducerImpl.start();<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.produceAccumulator != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-built_in">this</span>.produceAccumulator.start();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != traceDispatcher) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            traceDispatcher.start(<span class="hljs-built_in">this</span>.getNamesrvAddr(), <span class="hljs-built_in">this</span>.getAccessChannel());<br>        &#125; <span class="hljs-keyword">catch</span> (MQClientException e) &#123;<br>            logger.warn(<span class="hljs-string">&quot;trace dispatcher start failed &quot;</span>, e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥çœ‹ <code>this.defaultMQProducerImpl.start();</code>ï¼Œ ä¹Ÿå°±æ˜¯ <code>DefaultMQProducerImpl#start()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> startFactory)</span> <span class="hljs-keyword">throws</span> MQClientException &#123;<br>    <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">this</span>.serviceState) &#123;<br>        <span class="hljs-keyword">case</span> CREATE_JUST:<br>            <span class="hljs-comment">// è®¾ç½®é»˜è®¤çŠ¶æ€æ—¶å¯åŠ¨å¤±è´¥ï¼Œå¦‚æœå¯åŠ¨æˆåŠŸå†ä¿®æ”¹çŠ¶æ€</span><br>            <span class="hljs-built_in">this</span>.serviceState = ServiceState.START_FAILED;<br>            <span class="hljs-comment">// æ£€æŸ¥ç”Ÿäº§è€…ç»„çš„é…ç½®</span><br>            <span class="hljs-built_in">this</span>.checkConfig();<br>            <span class="hljs-comment">// ä¿®æ”¹ instanceName, å¦‚æœæ²¡æœ‰è‡ªå·±è®¾ç½®åˆ™å°†å…¶ä¿®æ”¹ä¸º â€œthis.instanceName = UtilAll.getPid() + &quot;#&quot; + System.nanoTime()â€</span><br>            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.defaultMQProducer.getProducerGroup().equals(MixAll.CLIENT_INNER_PRODUCER_GROUP)) &#123;<br>                <span class="hljs-built_in">this</span>.defaultMQProducer.changeInstanceNameToPID();<br>            &#125;<br>            <span class="hljs-comment">// è¿™é‡Œå°±æ˜¯åˆ›å»º MQClientInstanceï¼Œå¹¶ä¸”å°†å…¶å­˜å…¥ MQClientManager</span><br>            <span class="hljs-built_in">this</span>.mQClientFactory = MQClientManager.getInstance().getOrCreateMQClientInstance(<span class="hljs-built_in">this</span>.defaultMQProducer, rpcHook);<br>            <span class="hljs-comment">// è¿™é‡Œçš„æ³¨å†Œå®é™…æ˜¯å°† Producer å­˜å…¥ MQClientInstance çš„ ConcurrentMap&lt;String, MQProducerInner&gt; producerTable å±æ€§ä¸­</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">registerOK</span> <span class="hljs-operator">=</span> mQClientFactory.registerProducer(<span class="hljs-built_in">this</span>.defaultMQProducer.getProducerGroup(), <span class="hljs-built_in">this</span>);<br>            <span class="hljs-keyword">if</span> (!registerOK) &#123;<br>                <span class="hljs-built_in">this</span>.serviceState = ServiceState.CREATE_JUST;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MQClientException</span>(<span class="hljs-string">&quot;The producer group[&quot;</span> + <span class="hljs-built_in">this</span>.defaultMQProducer.getProducerGroup()<br>                    + <span class="hljs-string">&quot;] has been created before, specify another name please.&quot;</span> + FAQUrl.suggestTodo(FAQUrl.GROUP_NAME_DUPLICATE_URL),<br>                    <span class="hljs-literal">null</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (startFactory) &#123;<br>                <span class="hljs-comment">/**</span><br><span class="hljs-comment">                 *  ã€ä»£ç 1ã€‘</span><br><span class="hljs-comment">                 * </span><br><span class="hljs-comment">                 *  è¿™é‡Œçš„å¯åŠ¨ä¹Ÿæ˜¯æ ¸å¿ƒï¼Œä¸»è¦åŒ…å«</span><br><span class="hljs-comment">                 * 1. å¯åŠ¨åº•å±‚ Netty æœåŠ¡è¿›è¡Œé€šä¿¡</span><br><span class="hljs-comment">                 * 2. å¯åŠ¨å®šæ—¶ä»»åŠ¡ä¸æ–­ä» Nameserve è·å–æœ€æ–°çš„æ•°æ®</span><br><span class="hljs-comment">                 * 3. å¯åŠ¨æ‹‰å–æ¶ˆæ¯çš„å®šæ—¶ä»»åŠ¡æœåŠ¡</span><br><span class="hljs-comment">                 * 4. å¯åŠ¨ RebalanceService æœåŠ¡</span><br><span class="hljs-comment">                 * 5. å¯åŠ¨æ¸…é™¤ä¸‹çº¿çš„ broker å®šæ—¶ä»»åŠ¡çº¿ç¨‹</span><br><span class="hljs-comment">                 * 6. å¯åŠ¨å®šæ—¶ä»»åŠ¡å‘é€å¿ƒè·³åˆ° broker ä¸­</span><br><span class="hljs-comment">                 * 7. å¦‚æœæ˜¯ consumerï¼Œ è¿˜ä¼šæœ‰å®šæ—¶æŒä¹…åŒ–çš„æ“ä½œ</span><br><span class="hljs-comment">                 */</span><br>                mQClientFactory.start();<br>            &#125;<br><br>            <span class="hljs-built_in">this</span>.mqFaultStrategy.startDetector();<br><br>            log.info(<span class="hljs-string">&quot;the producer [&#123;&#125;] start OK. sendMessageWithVIPChannel=&#123;&#125;&quot;</span>, <span class="hljs-built_in">this</span>.defaultMQProducer.getProducerGroup(),<br>                <span class="hljs-built_in">this</span>.defaultMQProducer.isSendMessageWithVIPChannel());<br>            <span class="hljs-built_in">this</span>.serviceState = ServiceState.RUNNING;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> RUNNING:<br>        <span class="hljs-keyword">case</span> START_FAILED:<br>        <span class="hljs-keyword">case</span> SHUTDOWN_ALREADY:<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MQClientException</span>(<span class="hljs-string">&quot;The producer service state not OK, maybe started once, &quot;</span><br>                + <span class="hljs-built_in">this</span>.serviceState<br>                + FAQUrl.suggestTodo(FAQUrl.CLIENT_SERVICE_NOT_OK),<br>                <span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-comment">// å‘é€æ‰€æœ‰å¿ƒè·³åˆ° Broker ä¸­</span><br>    <span class="hljs-built_in">this</span>.mQClientFactory.sendHeartbeatToAllBrokerWithLock();<br><br>    RequestFutureHolder.getInstance().startScheduledTask(<span class="hljs-built_in">this</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="ç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„æµç¨‹"><a href="#ç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„æµç¨‹" class="headerlink" title="ç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„æµç¨‹"></a>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„æµç¨‹</h2><ol><li><a href="/2023/22987494ce74/index.html" title="RocketMQä¸­åŒæ­¥å’Œå¼‚æ­¥æ¶ˆæ¯å‘é€æµç¨‹">RocketMQä¸­åŒæ­¥å’Œå¼‚æ­¥æ¶ˆæ¯å‘é€æµç¨‹</a></li></ol>

<h2 id="ç”Ÿäº§è€…çš„é«˜å¯ç”¨"><a href="#ç”Ÿäº§è€…çš„é«˜å¯ç”¨" class="headerlink" title="ç”Ÿäº§è€…çš„é«˜å¯ç”¨"></a>ç”Ÿäº§è€…çš„é«˜å¯ç”¨</h2><h3 id="å®¢æˆ·ç«¯ä¿è¯"><a href="#å®¢æˆ·ç«¯ä¿è¯" class="headerlink" title="å®¢æˆ·ç«¯ä¿è¯"></a>å®¢æˆ·ç«¯ä¿è¯</h3><ul>
<li>é‡è¯•æœºåˆ¶ï¼Œ é€šè¿‡ä¸‹é¢å‚æ•°é…ç½®</li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">rocketmq.producer.retry-times-when-send-failed</span>=<span class="hljs-string">2</span><br><span class="hljs-attr">rocketmq.producer.retry-times-when-send-async-failed</span>=<span class="hljs-string">2</span><br></code></pre></td></tr></table></figure>
<p><strong>åŒæ­¥å‘é€é‡è¯•</strong>çš„æ ¸å¿ƒä»£ç æ˜¯åœ¨ <code>org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl#sendDefaultImpl()</code> æ–¹æ³•ï¼Œ ä¸‹é¢åªå±•ç¤ºè¯¥æ–¹æ³•ä¸é‡è¯•ç›¸å…³çš„ä»£ç </p>
<p><code>DefaultMQProducerImpl</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> SendResult <span class="hljs-title function_">sendDefaultImpl</span><span class="hljs-params">(</span><br><span class="hljs-params">        Message msg,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> CommunicationMode communicationMode,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> SendCallback sendCallback,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> timeout</span><br><span class="hljs-params">    )</span> <span class="hljs-keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;<br>    <span class="hljs-keyword">if</span> (topicPublishInfo != <span class="hljs-literal">null</span> &amp;&amp; topicPublishInfo.ok()) &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">callTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-type">MessageQueue</span> <span class="hljs-variable">mq</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">Exception</span> <span class="hljs-variable">exception</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// è·å–è°ƒç”¨çš„æ€»æ¬¡æ•°</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">timesTotal</span> <span class="hljs-operator">=</span> communicationMode == CommunicationMode.SYNC ? <span class="hljs-number">1</span> + <span class="hljs-built_in">this</span>.defaultMQProducer.getRetryTimesWhenSendFailed() : <span class="hljs-number">1</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">times</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        String[] brokersSent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[timesTotal];<br>        <span class="hljs-keyword">for</span> (; times &lt; timesTotal; times++) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">lastBrokerName</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span> == mq ? <span class="hljs-literal">null</span> : mq.getBrokerName();<br>            <span class="hljs-type">MessageQueue</span> <span class="hljs-variable">mqSelected</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.selectOneMessageQueue(topicPublishInfo, lastBrokerName);<br>            <span class="hljs-keyword">if</span> (mqSelected != <span class="hljs-literal">null</span>) &#123;<br>                mq = mqSelected;<br>                brokersSent[times] = mq.getBrokerName();<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">// å‘é€æ¶ˆæ¯å¹¶è·å–è¿”å›ç»“æœ</span><br>                    sendResult = <span class="hljs-built_in">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout - costTime);<br>                    endTimestamp = System.currentTimeMillis();<br>                    <span class="hljs-built_in">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class="hljs-literal">false</span>);<br>                    <span class="hljs-keyword">switch</span> (communicationMode) &#123;<br>                        <span class="hljs-comment">// å¼‚æ­¥å‘é€çš„ç»“æœä¸æ˜¯åœ¨è¿™é‡Œè·å–,æ‰€ä»¥ç›´æ¥è¿”å› null</span><br>                        <span class="hljs-keyword">case</span> ASYNC:<br>                            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                        <span class="hljs-comment">// åªå‘é€ä¸€æ¬¡ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦é‡è¯•</span><br>                        <span class="hljs-keyword">case</span> ONEWAY:<br>                            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                        <span class="hljs-comment">// åŒæ­¥å‘é€ï¼Œç»“æœåœ¨è¿™é‡Œè·å–</span><br>                        <span class="hljs-keyword">case</span> SYNC:<br>                            <span class="hljs-keyword">if</span> (sendResult.getSendStatus() != SendStatus.SEND_OK) &#123;<br>                                <span class="hljs-comment">// å‘é€ä¸æˆåŠŸï¼Œå¹¶ä¸”å¼€å¯äº†é‡è¯•ï¼Œåˆ™è¿›è¡Œé‡è¯•ï¼Œä¹Ÿå°±æ˜¯è¿›å…¥ for å¾ªç¯çš„ä¸‹ä¸€æ¬¡å¾ªç¯</span><br>                                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.defaultMQProducer.isRetryAnotherBrokerWhenNotStoreOK()) &#123;<br>                                    <span class="hljs-keyword">continue</span>;<br>                                &#125;<br>                            &#125;<br><br>                            <span class="hljs-keyword">return</span> sendResult;<br>                        <span class="hljs-keyword">default</span>:<br>                            <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>å¼‚æ­¥å‘é€é‡è¯•</strong>çš„æ ¸å¿ƒä»£ç æ˜¯åœ¨ <code>org.apache.rocketmq.client.impl.MQClientAPIImpl#sendMessageAsync()</code> æ–¹æ³•ä¸­<br><code>MQClientAPIImpl</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessageAsync</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> String addr,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> String brokerName,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> Message msg,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> timeoutMillis,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> RemotingCommand request,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> SendCallback sendCallback,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> TopicPublishInfo topicPublishInfo,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> MQClientInstance instance,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> retryTimesWhenSendFailed,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> AtomicInteger times,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> SendMessageContext context,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> DefaultMQProducerImpl producer</span><br><span class="hljs-params">    )</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">beginStartTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// new InvokeCallback() å°±æ˜¯æ‰§è¡Œå‘é€æ¶ˆæ¯çš„å›è°ƒ</span><br>        <span class="hljs-built_in">this</span>.remotingClient.invokeAsync(addr, request, timeoutMillis, <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokeCallback</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">operationComplete</span><span class="hljs-params">(ResponseFuture responseFuture)</span> &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">cost</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - beginStartTime;<br>                <span class="hljs-type">RemotingCommand</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> responseFuture.getResponseCommand();<br>                <span class="hljs-comment">// response != null ä»£è¡¨æ¶ˆæ¯å‘é€æˆåŠŸ</span><br>                <span class="hljs-keyword">if</span> (response != <span class="hljs-literal">null</span>) &#123;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">// response == null ä»£è¡¨æ¶ˆæ¯å‘é€å¤±è´¥, åœ¨ onExceptionImpl é‡Œé¢å°±ä¼šè¿›è¡Œå‘é€æ–¹æ³•çš„é‡è¯•</span><br>                    producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), <span class="hljs-literal">true</span>);<br>                    <span class="hljs-keyword">if</span> (!responseFuture.isSendRequestOK()) &#123;<br>                        <span class="hljs-type">MQClientException</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MQClientException</span>(<span class="hljs-string">&quot;send request failed&quot;</span>, responseFuture.getCause());<br>                        onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,<br>                            retryTimesWhenSendFailed, times, ex, context, <span class="hljs-literal">true</span>, producer);<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (responseFuture.isTimeout()) &#123;<br>                        <span class="hljs-type">MQClientException</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MQClientException</span>(<span class="hljs-string">&quot;wait response timeout &quot;</span> + responseFuture.getTimeoutMillis() + <span class="hljs-string">&quot;ms&quot;</span>,<br>                            responseFuture.getCause());<br>                        onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,<br>                            retryTimesWhenSendFailed, times, ex, context, <span class="hljs-literal">true</span>, producer);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-type">MQClientException</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MQClientException</span>(<span class="hljs-string">&quot;unknow reseaon&quot;</span>, responseFuture.getCause());<br>                        onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,<br>                            retryTimesWhenSendFailed, times, ex, context, <span class="hljs-literal">true</span>, producer);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="å®¢æˆ·ç«¯å®¹é”™"><a href="#å®¢æˆ·ç«¯å®¹é”™" class="headerlink" title="å®¢æˆ·ç«¯å®¹é”™"></a>å®¢æˆ·ç«¯å®¹é”™</h3><p><code>RocketMQ Client</code> ä¼šç»´æŠ¤ä¸€ä¸ª â€œBroker-å‘é€å»¶è¿Ÿâ€ å…³ç³»ï¼Œæ ¹æ®è¿™ä¸ªå…³ç³»é€‰æ‹©ä¸€ä¸ªå‘é€å»¶è¿Ÿçº§åˆ«è¾ƒä½çš„ <code>Broker</code> æ¥å‘é€æ¶ˆæ¯ï¼Œè¿™æ ·èƒ½æœ€å¤§é™åº¦åœ°åˆ©ç”¨ <code>Broker</code> çš„èƒ½åŠ›ï¼Œå‰”é™¤å·²ç»å®•æœºã€ä¸å¯ç”¨æˆ–è€…å‘é€å»¶è¿Ÿçº§åˆ«è¾ƒé«˜çš„ <code>Broker</code>ï¼Œå°½é‡ä¿è¯æ¶ˆæ¯çš„æ­£å¸¸å‘é€</p>
<p>é€‰æ‹© <code>Broker</code> å…¶å®å°±æ˜¯é€‰æ‹© <code>MessageQueue</code> å‘é€æ¶ˆæ¯, å…·ä½“å®ç°åœ¨ <code>org.apache.rocketmq.client.latency.MQFaultStrategy#selectOneMessageQueue()</code> æ–¹æ³•ä¸­ï¼Œå‰é¢è®²åˆ°åŒæ­¥å‘é€æ¶ˆæ¯çš„æ–¹æ³•é»˜è®¤æ˜¯ <code>org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl#sendDefaultImpl()</code>ï¼Œ è€Œ <code>selectOneMessageQueue</code> æ–¹æ³•å°±æ˜¯åœ¨ <code>sendDefaultImpl</code> æ–¹æ³•ä¸­è¿›è¡Œè°ƒç”¨çš„</p>
<p><code>selectOneMessageQueue</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> MessageQueue <span class="hljs-title function_">selectOneMessageQueue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> TopicPublishInfo tpInfo, <span class="hljs-keyword">final</span> String lastBrokerName)</span> &#123;<br>    <span class="hljs-comment">// 1. å¦‚æœå¼€å¯äº†å‘é€å»¶è¿Ÿå®¹é”™ï¼Œæ‰ä¼šè°ƒç”¨å®¹é”™ç›¸å…³çš„é€»è¾‘</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sendLatencyFaultEnable) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> tpInfo.getSendWhichQueue().incrementAndGet();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; tpInfo.getMessageQueueList().size(); i++) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">pos</span> <span class="hljs-operator">=</span> Math.abs(index++) % tpInfo.getMessageQueueList().size();<br>                <span class="hljs-keyword">if</span> (pos &lt; <span class="hljs-number">0</span>)<br>                    pos = <span class="hljs-number">0</span>;<br>                <span class="hljs-type">MessageQueue</span> <span class="hljs-variable">mq</span> <span class="hljs-operator">=</span> tpInfo.getMessageQueueList().get(pos);<br>                <span class="hljs-keyword">if</span> (latencyFaultTolerance.isAvailable(mq.getBrokerName()))<br>                    <span class="hljs-keyword">return</span> mq;<br>            &#125;<br><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">notBestBroker</span> <span class="hljs-operator">=</span> latencyFaultTolerance.pickOneAtLeast();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">writeQueueNums</span> <span class="hljs-operator">=</span> tpInfo.getQueueIdByBroker(notBestBroker);<br>            <span class="hljs-keyword">if</span> (writeQueueNums &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">MessageQueue</span> <span class="hljs-variable">mq</span> <span class="hljs-operator">=</span> tpInfo.selectOneMessageQueue();<br>                <span class="hljs-keyword">if</span> (notBestBroker != <span class="hljs-literal">null</span>) &#123;<br>                    mq.setBrokerName(notBestBroker);<br>                    mq.setQueueId(tpInfo.getSendWhichQueue().incrementAndGet() % writeQueueNums);<br>                &#125;<br>                <span class="hljs-keyword">return</span> mq;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                latencyFaultTolerance.remove(notBestBroker);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;Error occurred when selecting message queue&quot;</span>, e);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> tpInfo.selectOneMessageQueue();<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> tpInfo.selectOneMessageQueue(lastBrokerName);<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>è·å–ä¸€ä¸ªåœ¨å»¶è¿Ÿä¸Šå¯ä»¥æ¥å—ï¼Œå¹¶ä¸”å’Œä¸Šæ¬¡å‘é€ç›¸åŒçš„ <code>Broker</code>ã€‚é¦–å…ˆè·å–ä¸€ä¸ªè‡ªå¢åºå·<code>index</code>ï¼Œé€šè¿‡å–æ¨¡è·å–<code>Queue</code>çš„ä½ç½®ä¸‹æ ‡ <code>Pos</code>ã€‚å¦‚æœ <code>Pos</code>å¯¹åº”çš„ <code>Broker</code>çš„å»¶è¿Ÿæ—¶é—´æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå¹¶ä¸”æ˜¯ç¬¬ä¸€æ¬¡å‘é€ï¼Œæˆ–è€…å’Œä¸Šæ¬¡å‘é€çš„<code>Broker</code>ç›¸åŒï¼Œåˆ™å°†<code>Queue</code>è¿”å›</li>
<li>å¦‚æœç¬¬ä¸€æ­¥æ²¡æœ‰é€‰ä¸­ä¸€ä¸ª<code>Broker</code>ï¼Œåˆ™é€‰æ‹©ä¸€ä¸ªå»¶è¿Ÿè¾ƒä½çš„<code>Broker</code></li>
<li>å¦‚æœç¬¬ä¸€ã€äºŒæ­¥éƒ½æ²¡æœ‰é€‰ä¸­ä¸€ä¸ª<code>Broker</code>ï¼Œåˆ™éšæœºé€‰æ‹©ä¸€ä¸ª<code>Broker</code></li>
</ul>
<h3 id="Broker-ç«¯ä¿è¯"><a href="#Broker-ç«¯ä¿è¯" class="headerlink" title="Broker ç«¯ä¿è¯"></a>Broker ç«¯ä¿è¯</h3><ul>
<li><code>Broker</code> ç«¯åŒ…å« <code>Master</code> å’Œ <code>Slave</code></li>
<li><code>Master</code> å’Œ <code>Slave</code> ä¹‹é—´æœ‰<strong>åŒæ­¥å¤åˆ¶</strong> å’Œ <strong>å¼‚æ­¥å¤åˆ¶</strong>ï¼Œå¦‚æœè¦æƒ³åšåˆ°é«˜å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ <strong>åŒæ­¥å¤åˆ¶</strong></li>
</ul>
<h2 id="ç”Ÿäº§è€…-DefaultMQProducer-æ ¸å¿ƒæ–¹æ³•"><a href="#ç”Ÿäº§è€…-DefaultMQProducer-æ ¸å¿ƒæ–¹æ³•" class="headerlink" title="ç”Ÿäº§è€… (DefaultMQProducer) æ ¸å¿ƒæ–¹æ³•"></a>ç”Ÿäº§è€… (DefaultMQProducer) æ ¸å¿ƒæ–¹æ³•</h2><ul>
<li><code>long searchOffsetï¼ˆfinal MessageQueue mq, final long timestampï¼‰</code> æ ¹æ®æ—¶é—´æˆ³ä»é˜Ÿåˆ—ä¸­æŸ¥æ‰¾å…¶åç§»é‡</li>
<li><code>List&lt;MessageQueue&gt; fetchPublishMessageQueues(String topic)</code> æŸ¥æ‰¾è¯¥ä¸»é¢˜ä¸‹æ‰€æœ‰çš„æ¶ˆæ¯é˜Ÿåˆ—</li>
<li></li>
</ul>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQä¹‹Brokerè¯¦è§£</title>
    <url>/2023/5398bb79bdb5/index.html</url>
    <content><![CDATA[<blockquote>
<p>RocketMQç‰ˆæœ¬ï¼š 4.9.7<br>JDKç‰ˆæœ¬ï¼š 17</p>
</blockquote>
<p>ä»¥ä¸‹ä»£ç åœ¨ <code>broker</code> å­æ¨¡å—ä¸­</p>
<h2 id="è·å–å¯åŠ¨æ–‡ä»¶"><a href="#è·å–å¯åŠ¨æ–‡ä»¶" class="headerlink" title="è·å–å¯åŠ¨æ–‡ä»¶"></a>è·å–å¯åŠ¨æ–‡ä»¶</h2><p>å¯åŠ¨ <code>broker</code> çš„è„šæœ¬æ˜¯ <code>bin/mqbroker</code>, è¿™ä¸ªæ‰§è¡Œæ–‡ä»¶çš„æœ€åä¸€è¡Œæ˜¯ <code>sh $&#123;ROCKETMQ_HOME&#125;/bin/runbroker.sh org.apache.rocketmq.broker.BrokerStartup $@</code>ï¼Œ æ‰€ä»¥åœ¨æºç ä¸­å¯åŠ¨ <code>broker</code> çš„æ–‡ä»¶å…¶å®æ˜¯ <code>BrokerStartup</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BrokerStartup</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        start(createBrokerController(args));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†</p>
<ul>
<li>åˆ›å»º <code>BrokerController</code></li>
<li>å¯åŠ¨ <code>BrokerController</code></li>
</ul>
<h2 id="BrokerController-åˆ›å»ºæµç¨‹"><a href="#BrokerController-åˆ›å»ºæµç¨‹" class="headerlink" title="BrokerController åˆ›å»ºæµç¨‹"></a>BrokerController åˆ›å»ºæµç¨‹</h2><h2 id="BrokerControlelr-å¯åŠ¨æµç¨‹"><a href="#BrokerControlelr-å¯åŠ¨æµç¨‹" class="headerlink" title="BrokerControlelr å¯åŠ¨æµç¨‹"></a>BrokerControlelr å¯åŠ¨æµç¨‹</h2>]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQä¸­åŒæ­¥å’Œå¼‚æ­¥æ¶ˆæ¯å‘é€æµç¨‹</title>
    <url>/2023/22987494ce74/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="Producer-åˆå§‹åŒ–æµç¨‹"><a href="#Producer-åˆå§‹åŒ–æµç¨‹" class="headerlink" title="Producer åˆå§‹åŒ–æµç¨‹"></a>Producer åˆå§‹åŒ–æµç¨‹</h2><p>æ¶ˆæ¯åœ¨å‘é€ä¹‹å‰éœ€è¦å…ˆåˆå§‹åŒ– <code>Producer</code>, å…·ä½“å¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/254af85a97af/index.html" title="RocketMQä¸­Producerå’ŒProducerGroup">RocketMQä¸­Producerå’ŒProducerGroup</a></li></ol>

<h2 id="æ¶ˆæ¯ç±»å‹"><a href="#æ¶ˆæ¯ç±»å‹" class="headerlink" title="æ¶ˆæ¯ç±»å‹"></a>æ¶ˆæ¯ç±»å‹</h2><pre class="mermaid">mindmap
Root("Producer(ç”Ÿäº§è€…)")
    A("æ™®é€šæ¶ˆæ¯")
        A1("åŒæ­¥å‘é€")
        A2("å¼‚æ­¥å‘é€")
        A3("å•å‘å‘é€")
    B("é¡ºåºæ¶ˆæ¯")
    C("å»¶è¿Ÿæ¶ˆæ¯")
    D("æ‰¹é‡æ¶ˆæ¯")
    E("äº‹åŠ¡æ¶ˆæ¯")</pre>


<h2 id="æ™®é€š-åŒæ­¥æ¶ˆæ¯å‘é€æµç¨‹"><a href="#æ™®é€š-åŒæ­¥æ¶ˆæ¯å‘é€æµç¨‹" class="headerlink" title="æ™®é€š-åŒæ­¥æ¶ˆæ¯å‘é€æµç¨‹"></a>æ™®é€š-åŒæ­¥æ¶ˆæ¯å‘é€æµç¨‹</h2><p>æ™®é€šæ¶ˆæ¯å‘é€ä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRODUCER_GROUP</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ProducerGroupName&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMESRVADDR</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;192.168.208.130:9876&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TopicTest&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TagA&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException, InterruptedException &#123;<br>        <span class="hljs-comment">// 1. å®ä¾‹åŒ–</span><br>        <span class="hljs-type">DefaultMQProducer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQProducer</span>(PRODUCER_GROUP);<br>        producer.setNamesrvAddr(DEFAULT_NAMESRVADDR);<br><br>        <span class="hljs-comment">// 2. åˆå§‹åŒ–</span><br>        producer.start();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">128</span>; i++) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 3. æ„é€ æ¶ˆæ¯</span><br>                <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(TOPIC, TAG, <span class="hljs-string">&quot;OrderID188&quot;</span>, <span class="hljs-string">&quot;Hello world&quot;</span>.getBytes(StandardCharsets.UTF_8));<br>                <span class="hljs-comment">// 4. å‘é€æ¶ˆæ¯</span><br>                <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> producer.send(msg);<br>                System.out.printf(<span class="hljs-string">&quot;%s%n&quot;</span>, sendResult);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        producer.shutdown();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å‘é€æ¶ˆæ¯çš„æ ¸å¿ƒæµç¨‹</p>
<figure class="highlight leaf"><table><tr><td class="code"><pre><code class="hljs leaf">DefaultMQProducer<span class="hljs-punctuation">#</span><span class="hljs-keyword">send</span><span class="hljs-params">(<span class="hljs-variable">Message</span>)</span><br>    DefaultMQProducer<span class="hljs-punctuation">#</span><span class="hljs-keyword">sendDirect</span><span class="hljs-params">()</span><br>        DefaultMQProducerImpl<span class="hljs-punctuation">#</span><span class="hljs-keyword">send</span><span class="hljs-params">(<span class="hljs-variable">org</span>.<span class="hljs-variable">apache</span>.<span class="hljs-variable">rocketmq</span>.<span class="hljs-variable">common</span>.<span class="hljs-variable">message</span>.<span class="hljs-variable">Message</span>, <span class="hljs-variable">long</span>)</span><br>            DefaultMQProducerImpl<span class="hljs-punctuation">#</span><span class="hljs-keyword">sendDefaultImpl</span><span class="hljs-params">()</span><br></code></pre></td></tr></table></figure>

<p>å¯¹äºæ™®é€šåŒæ­¥æ¶ˆæ¯ï¼Œæœ€ç»ˆçš„ä¸»æµç¨‹ä»£ç æ˜¯åœ¨ <code>DefaultMQProducerImpl#sendDefaultImpl()</code> ä¸­ï¼Œæ¥ä¸‹æ¥å°±çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•ï¼ˆåªå±•ç¤ºäº†ä¸»è¦ç›¸å…³ä»£ç ï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> SendResult <span class="hljs-title function_">sendDefaultImpl</span><span class="hljs-params">(</span><br><span class="hljs-params">        Message msg,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> CommunicationMode communicationMode,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> SendCallback sendCallback,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> timeout</span><br><span class="hljs-params">    )</span> <span class="hljs-keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;<br>        <span class="hljs-built_in">this</span>.makeSureStateOK();<br>        Validators.checkMessage(msg, <span class="hljs-built_in">this</span>.defaultMQProducer);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">invokeID</span> <span class="hljs-operator">=</span> random.nextLong();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">beginTimestampFirst</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">beginTimestampPrev</span> <span class="hljs-operator">=</span> beginTimestampFirst;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">endTimestamp</span> <span class="hljs-operator">=</span> beginTimestampFirst;<br>        <span class="hljs-comment">// æ ¸å¿ƒæ­¥éª¤1ï¼šæ„é€  TopicPublishInfo</span><br>        <span class="hljs-type">TopicPublishInfo</span> <span class="hljs-variable">topicPublishInfo</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.tryToFindTopicPublishInfo(msg.getTopic());<br>        <span class="hljs-keyword">if</span> (topicPublishInfo != <span class="hljs-literal">null</span> &amp;&amp; topicPublishInfo.ok()) &#123;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">callTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-type">MessageQueue</span> <span class="hljs-variable">mq</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-comment">// è·å–é‡è¯•æ­¤æ—¶ï¼Œæ€»æ¬¡æ•° = 1+é‡è¯•æ¬¡æ•°ï¼ˆåŒæ­¥çš„æ—¶å€™æ‰ä¼šé‡è¯•ï¼‰</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">timesTotal</span> <span class="hljs-operator">=</span> communicationMode == CommunicationMode.SYNC ? <span class="hljs-number">1</span> + <span class="hljs-built_in">this</span>.defaultMQProducer.getRetryTimesWhenSendFailed() : <span class="hljs-number">1</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">times</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            String[] brokersSent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[timesTotal];<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">resetIndex</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">for</span> (; times &lt; timesTotal; times++) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">lastBrokerName</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span> == mq ? <span class="hljs-literal">null</span> : mq.getBrokerName();<br>                <span class="hljs-keyword">if</span> (times &gt; <span class="hljs-number">0</span>) &#123;<br>                    resetIndex = <span class="hljs-literal">true</span>;<br>                &#125;<br>                <span class="hljs-comment">// æ ¸å¿ƒæ­¥éª¤2ï¼šé€‰æ‹©ä¸€ä¸ª MessageQueue</span><br>                <span class="hljs-type">MessageQueue</span> <span class="hljs-variable">mqSelected</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.selectOneMessageQueue(topicPublishInfo, lastBrokerName, resetIndex);<br>                <span class="hljs-keyword">if</span> (mqSelected != <span class="hljs-literal">null</span>) &#123;<br>                    mq = mqSelected;<br>                    brokersSent[times] = mq.getBrokerName();<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">// æ ¸å¿ƒæ­¥éª¤3ï¼š æ‰§è¡Œæ¶ˆæ¯çš„å‘é€é€»è¾‘</span><br>                        sendResult = <span class="hljs-built_in">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout - costTime);<br>                        endTimestamp = System.currentTimeMillis();<br>                        <span class="hljs-built_in">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>                        <span class="hljs-keyword">switch</span> (communicationMode) &#123;<br>                            <span class="hljs-keyword">case</span> ASYNC:<br>                                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                            <span class="hljs-keyword">case</span> ONEWAY:<br>                                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                            <span class="hljs-keyword">case</span> SYNC:<br>                                <span class="hljs-comment">// å¦‚æœå‘é€ä¸æˆåŠŸï¼Œä½¿ç”¨continueå°±ä¼šè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯é‡è¯•</span><br>                                <span class="hljs-keyword">if</span> (sendResult.getSendStatus() != SendStatus.SEND_OK) &#123;<br>                                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.defaultMQProducer.isRetryAnotherBrokerWhenNotStoreOK()) &#123;<br>                                        <span class="hljs-keyword">continue</span>;<br>                                    &#125;<br>                                &#125;<br>                                <span class="hljs-comment">// å¦‚æœå‘é€æˆåŠŸï¼Œå°±ç›´æ¥è¿”å›ç»“æœ</span><br>                                <span class="hljs-keyword">return</span> sendResult;<br>                            <span class="hljs-keyword">default</span>:<br>                                <span class="hljs-keyword">break</span>;<br>                        &#125;<br>                    &#125; <br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (sendResult != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> sendResult;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>æ ¸å¿ƒæµç¨‹çš„é€»è¾‘å¦‚ä¸‹</p>
<ol>
<li>æ„é€  <code>TopicPublishInfo</code>, è¯¥ç»“æ„åŒ…å«é˜Ÿåˆ—(<code>Queue</code>, <code>Broker</code>)</li>
<li>é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆ<code>MessageQueue</code>ï¼‰è¿›è¡Œå‘é€ï¼Œå› ä¸ºæ¶ˆæ¯å®é™…æ˜¯å‘å¾€é˜Ÿåˆ—çš„ï¼Œ<code>Topic</code> æ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µ</li>
<li>æ ¹æ® <code>MessageQueue</code> è·å–å¯¹åº”çš„ <code>BrokerName</code> å’Œ <code>BrokerAddr</code></li>
<li>åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦éœ€è¦å‹ç¼©ï¼ˆæ¶ˆæ¯å¤§äº 4K åˆ™å‹ç¼©ï¼‰</li>
<li>æ‰§è¡Œæ¶ˆæ¯å‘é€ï¼Œè‹¥å‘é€å¤±è´¥ï¼Œåˆ™è¿›è¡Œé‡è¯•</li>
</ol>
<p>ä¸‹é¢çœ‹ä¸€ä¸‹è¿™å‡ ä¸ªæ ¸å¿ƒæ­¥éª¤</p>
<p><strong>æ„é€  TopicPublishInfo</strong><br>å…ˆçœ‹ä¸€ä¸‹ <code>TopicPublishInfo</code> ç»“æ„ï¼Œ <code>TopicPublishInfo</code> åŒ…å«äº† <code>Lis&lt;MessageQueue&gt;</code> å’Œ <code>TopicRouteData</code><br><code>TopicPublishInfo</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TopicPublishInfo</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">orderTopic</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">haveTopicRouterInfo</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">private</span> List&lt;MessageQueue&gt; messageQueueList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> TopicRouteData topicRouteData;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>TopicRouteData</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TopicRouteData</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RemotingSerializable</span> &#123;<br>    <span class="hljs-keyword">private</span> List&lt;QueueData&gt; queueDatas;<br>    <span class="hljs-keyword">private</span> List&lt;BrokerData&gt; brokerDatas;<br>    <span class="hljs-keyword">private</span> Map&lt;String<span class="hljs-comment">/*brokerName*/</span>, TopicQueueMappingInfo&gt; topicQueueMappingByBroker;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>MessageQueue</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageQueue</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparable</span>&lt;MessageQueue&gt;, Serializable &#123;<br>    <span class="hljs-keyword">private</span> String topic;<br>    <span class="hljs-keyword">private</span> String brokerName;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> queueId;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>æ ¸å¿ƒæ­¥éª¤1</strong> è°ƒç”¨çš„ä»£ç æ˜¯ <code>TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());</code> æ‰€ä»¥éœ€è¦çœ‹ <code>tryToFindTopicPublishInfo</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> TopicPublishInfo <span class="hljs-title function_">tryToFindTopicPublishInfo</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String topic)</span> &#123;<br>    <span class="hljs-comment">// ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯è‚¯å®šæ²¡æœ‰å€¼ï¼Œæ‰€ä»¥æ˜¯èµ°ä¸‹é¢çš„æµç¨‹</span><br>    <span class="hljs-type">TopicPublishInfo</span> <span class="hljs-variable">topicPublishInfo</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.topicPublishInfoTable.get(topic);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == topicPublishInfo || !topicPublishInfo.ok()) &#123;<br>        <span class="hljs-built_in">this</span>.topicPublishInfoTable.putIfAbsent(topic, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicPublishInfo</span>());<br>        <span class="hljs-built_in">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(topic);<br>        topicPublishInfo = <span class="hljs-built_in">this</span>.topicPublishInfoTable.get(topic);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (topicPublishInfo.isHaveTopicRouterInfo() || topicPublishInfo.ok()) &#123;<br>        <span class="hljs-keyword">return</span> topicPublishInfo;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// ç¬¬ä¸€æ¬¡å¾€æŸä¸ª topic ä¸­å‘é€æ•°æ®æ—¶èµ°è¿™ä¸ªé€»è¾‘ï¼Œæ³¨æ„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’çš„æ˜¯ true</span><br>        <span class="hljs-comment">// è¿™ä¸ªå‚æ•°ä»£è¡¨çš„æ˜¯å¦æ˜¯é»˜è®¤çš„ topic</span><br>        <span class="hljs-built_in">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(topic, <span class="hljs-literal">true</span>, <span class="hljs-built_in">this</span>.defaultMQProducer);<br>        topicPublishInfo = <span class="hljs-built_in">this</span>.topicPublishInfoTable.get(topic);<br>        <span class="hljs-keyword">return</span> topicPublishInfo;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ„å»º <code>TopicPublishInfo</code> ç±»çš„è¿‡ç¨‹å®é™…æ˜¯å…ˆä» <code>Nameserver</code> è·å–æ•°æ®ï¼Œ<code>updateTopicRouteInfoFromNameServer()</code> æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ <code>true</code>, æ‰€ä»¥æœ€ç»ˆæ˜¯è°ƒç”¨åˆ°ä¸‹é¢æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">AUTO_CREATE_TOPIC_KEY_TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TBW102&quot;</span>; <br><span class="hljs-keyword">public</span> TopicRouteData <span class="hljs-title function_">getDefaultTopicRouteInfoFromNameServer</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">long</span> timeoutMillis)</span><br>        <span class="hljs-keyword">throws</span> RemotingException, MQClientException, InterruptedException &#123;<br>    <span class="hljs-keyword">return</span> getTopicRouteInfoFromNameServer(TopicValidator.AUTO_CREATE_TOPIC_KEY_TOPIC, timeoutMillis, <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å› æ­¤å®é™…è·å–çš„æ˜¯ <code>TBW102</code> è¿™ä¸ªå†…éƒ¨ <code>Topic</code> çš„ç›¸å…³æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰çš„ <code>Topic</code> çš„ç›¸å…³æ•°æ®å®é™…æ˜¯ä» <code>TBW102</code> ä¸­æ‹·è´è¿‡æ¥çš„ï¼Œ <code>TBW102</code> çš„ <code>ReadQueue</code> å’Œ <code>WriteQueue</code> éƒ½æ˜¯ 8ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªå®šä¹‰çš„ <code>Topic</code> è¯»å†™é˜Ÿåˆ—ä¹Ÿæ˜¯ 8 ä¹ˆï¼Ÿ å®é™…ä¸æ˜¯çš„ï¼Œå¤„ç†è¯»å†™é˜Ÿåˆ—çš„ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// MQClientInstance ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">updateTopicRouteInfoFromNameServer</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String topic, <span class="hljs-type">boolean</span> isDefault,</span><br><span class="hljs-params">        DefaultMQProducer defaultMQProducer)</span> &#123;<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.lockNamesrv.tryLock(LOCK_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS)) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            TopicRouteData topicRouteData;<br>            <span class="hljs-keyword">if</span> (isDefault &amp;&amp; defaultMQProducer != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// default=true æ—¶ä¼šèµ°ä¸‹é¢é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯ä¼šæŸ¥è¯¢ TBW102 topic çš„æ•°æ®</span><br>                topicRouteData = <span class="hljs-built_in">this</span>.mQClientAPIImpl.getDefaultTopicRouteInfoFromNameServer(clientConfig.getMqClientApiTimeout());<br>                <span class="hljs-keyword">if</span> (topicRouteData != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">for</span> (QueueData data : topicRouteData.getQueueDatas()) &#123;<br>                        <span class="hljs-comment">// è¿™é‡Œè·å–è¯»å†™é˜Ÿåˆ—çš„é€»è¾‘æ˜¯æœ€é…ç½®çš„ å€¼å’Œ TBW102 topic readQueueNum çš„æœ€å°å€¼</span><br>                        <span class="hljs-comment">// å‰é¢è¯´ TBW102 topic readQueueNum æ˜¯8ï¼Œ ä½†æ˜¯ getDefaultTopicQueueNums é»˜è®¤æ˜¯ 4</span><br>                        <span class="hljs-comment">// private volatile int defaultTopicQueueNums = 4; ï¼ˆDefaultMQProducer ç±»ï¼‰</span><br>                        <span class="hljs-type">int</span> <span class="hljs-variable">queueNums</span> <span class="hljs-operator">=</span> Math.min(defaultMQProducer.getDefaultTopicQueueNums(), data.getReadQueueNums());<br>                        data.setReadQueueNums(queueNums);<br>                        data.setWriteQueueNums(queueNums);<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// å…¶ä»–ä»£ç çœç•¥</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åé¢ä»£ç å°±ä¸åˆ†æäº†ï¼ŒåŸºæœ¬ä¼šæ˜¯ä» <code>TopicRouteData</code> ä¸­è·å–æ•°æ®å¡«å……åˆ° <code>TopicPublishInfo</code> ä¸­</p>
<p><strong>é€‰æ‹© MessageQueue</strong><br>å¯¹äº <code>MessageQueue</code> çš„å†…å®¹å¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/0137d652ba85/index.html" title="RocketMQä¸­MessageQueueè¯¦è§£">RocketMQä¸­MessageQueueè¯¦è§£</a></li></ol>

<h3 id="æ¶ˆæ¯å‘é€æ•´ä½“æµç¨‹æ€»ç»“"><a href="#æ¶ˆæ¯å‘é€æ•´ä½“æµç¨‹æ€»ç»“" class="headerlink" title="æ¶ˆæ¯å‘é€æ•´ä½“æµç¨‹æ€»ç»“"></a>æ¶ˆæ¯å‘é€æ•´ä½“æµç¨‹æ€»ç»“</h3><pre class="mermaid">sequenceDiagram
    participant A as DefaultMQProducer
    participant B as DefaultMQProducerImpl
    participant C as MQClientAPIImpl
    participant D as RemotingClient
    A->>B: è°ƒç”¨å‘é€æ¶ˆæ¯æ–¹æ³•send()
    B->>B: sendDefaultImpl()
    B->>B: sendKernelImpl()
    B->>B: å‘é€requestå°è£…
    B->>C: sendMessage()
    C->>D: invokeSync()
    Note over D: å‘é€ç½‘ç»œè¯·æ±‚</pre>


<h2 id="æ™®é€š-å•å‘æ¶ˆæ¯å‘é€"><a href="#æ™®é€š-å•å‘æ¶ˆæ¯å‘é€" class="headerlink" title="æ™®é€š-å•å‘æ¶ˆæ¯å‘é€"></a>æ™®é€š-å•å‘æ¶ˆæ¯å‘é€</h2><p>å•å‘å‘é€å’ŒåŒæ­¥å‘é€çš„å·®å¼‚æ˜¯ï¼šå•å‘å‘é€æ¶ˆæ¯ä¸éœ€è¦å¤„ç†å‘é€ç»“æœï¼Œä¸ç”¨ç®¡æ˜¯å‘é€æˆåŠŸè¿˜æ˜¯å‘é€å¤±è´¥ï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡æœ‰é‡è¯•çš„é€»è¾‘</p>
<p><strong>å•å‘å‘é€çš„ä½¿ç”¨åœºæ™¯</strong><br>ä»€ä¹ˆæƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨å•å‘å‘é€å‘¢ï¼Ÿ å› ä¸ºå•å‘å‘é€å¯èƒ½ä¼šä¸¢å¤±æ•°æ®ï¼Œæ‰€ä»¥å…è®¸ä¸¢å¤±æ•°æ®çš„åœºæ™¯å°±å¯ä»¥ä½¿ç”¨ï¼Œä¸€èˆ¬æ¥è¯´åƒæ—¥å¿—æ”¶é›†ä¹‹ç±»çš„å¯ä»¥ä½¿ç”¨å•å‘å‘é€</p>
<h2 id="æ™®é€š-å¼‚æ­¥æ¶ˆæ¯å‘é€"><a href="#æ™®é€š-å¼‚æ­¥æ¶ˆæ¯å‘é€" class="headerlink" title="æ™®é€š-å¼‚æ­¥æ¶ˆæ¯å‘é€"></a>æ™®é€š-å¼‚æ­¥æ¶ˆæ¯å‘é€</h2><p>å¯ä»¥ä» <code>RocketMQ</code> æºç çš„ <code>example</code> æ¨¡å—ä¸‹æ‰¾åˆ° <code>org.apache.rocketmq.example.simple.AsyncProducer</code> ç±»ï¼Œè¿™æ˜¯å¼‚æ­¥å‘é€çš„ç¤ºä¾‹ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncProducer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(</span><br><span class="hljs-params">        String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException, InterruptedException, UnsupportedEncodingException &#123;<br><br>        <span class="hljs-type">DefaultMQProducer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQProducer</span>(<span class="hljs-string">&quot;Jodie_Daily_test&quot;</span>);<br>        producer.start();<br>        <span class="hljs-comment">// suggest to on enableBackpressureForAsyncMode in heavy traffic, default is false</span><br>        producer.setEnableBackpressureForAsyncMode(<span class="hljs-literal">true</span>);<br>        producer.setRetryTimesWhenSendAsyncFailed(<span class="hljs-number">0</span>);<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">messageCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">countDownLatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(messageCount);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; messageCount; i++) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> i;<br>                <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(<span class="hljs-string">&quot;Jodie_topic_1023&quot;</span>,<br>                    <span class="hljs-string">&quot;TagA&quot;</span>,<br>                    <span class="hljs-string">&quot;OrderID188&quot;</span>,<br>                    <span class="hljs-string">&quot;Hello world&quot;</span>.getBytes(RemotingHelper.DEFAULT_CHARSET));<br>                producer.send(msg, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendCallback</span>() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(SendResult sendResult)</span> &#123;<br>                        countDownLatch.countDown();<br>                        System.out.printf(<span class="hljs-string">&quot;%-10d OK %s %n&quot;</span>, index, sendResult.getMsgId());<br>                    &#125;<br><br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onException</span><span class="hljs-params">(Throwable e)</span> &#123;<br>                        countDownLatch.countDown();<br>                        System.out.printf(<span class="hljs-string">&quot;%-10d Exception %s %n&quot;</span>, index, e);<br>                        e.printStackTrace();<br>                    &#125;<br>                &#125;);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        countDownLatch.await(<span class="hljs-number">5</span>, TimeUnit.SECONDS);<br>        producer.shutdown();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åŒæ­¥æ¶ˆæ¯ä½¿ç”¨çš„ <code>public SendResult send(Message msg)</code> æ–¹æ³•<br>å¼‚æ­¥æ¶ˆæ¯ä½¿ç”¨çš„ <code>public void send(Message msg,SendCallback sendCallback)</code> æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æœ‰å›è°ƒå‡½æ•°<br>é‚£ä¹ˆå¼‚æ­¥æ¶ˆæ¯æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ æ¥ä¸‹æ¥å°±çœ‹å¼‚æ­¥æ¶ˆæ¯çš„æ ¸å¿ƒå®ç°åŸç†, ä¸‹é¢å…ˆçŒœæƒ³ä¸€ä¸‹ï¼Œç„¶åçœ‹æºç å»éªŒè¯</p>
<ol>
<li>æ—¢ç„¶æ˜¯å¼‚æ­¥ï¼Œé‚£ä¹ˆä¸šåŠ¡çº¿ç¨‹å’Œå®é™…å‘é€æ¶ˆæ¯çš„çº¿ç¨‹è‚¯å®šä¸æ˜¯åŒä¸€ä¸ªï¼ŒåŸºæœ¬ä¸Šå°±å¯ä»¥è‚¯å®šå‘é€çº¿ç¨‹æ˜¯ä½¿ç”¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ± æ¥å®ç°çš„</li>
<li>å¼‚æ­¥è°ƒç”¨æ—¶ä¼ å…¥äº† <code>SendCallback</code>ï¼Œ é‚£ä¹ˆåœ¨å‘é€çº¿ç¨‹å¾—åˆ°å‘é€ç»“æœåå°±éœ€è¦è°ƒç”¨è¿™ä¸ª <code>SendCallback</code>ï¼Œè¿™æ ·å°±å¯ä»¥æ‹¿åˆ°è¿”å›ç»“æœ</li>
</ol>
<p>å¼‚æ­¥è°ƒç”¨æµç¨‹</p>
<figure class="highlight leaf"><table><tr><td class="code"><pre><code class="hljs leaf">DefaultMQProducer<span class="hljs-punctuation">#</span><span class="hljs-keyword">send</span><span class="hljs-params">(<span class="hljs-variable">Message</span>, <span class="hljs-variable">SendCallback</span>)</span><br>    DefaultMQProducer<span class="hljs-punctuation">#</span><span class="hljs-keyword">sendDirect</span><span class="hljs-params">(<span class="hljs-variable">Message</span>, <span class="hljs-variable">MessageQueue</span>,<span class="hljs-variable">SendCallback</span>)</span><br>        DefaultMQProducerImpl<span class="hljs-punctuation">#</span><span class="hljs-keyword">send</span><span class="hljs-params">(<span class="hljs-variable">Message</span>, <span class="hljs-variable">SendCallback</span>)</span><br>            DefaultMQProducerImpl<span class="hljs-punctuation">#</span><span class="hljs-keyword">send</span><span class="hljs-params">(<span class="hljs-variable">Message</span>, <span class="hljs-variable">SendCallback</span>, <span class="hljs-variable">long</span>)</span>  ã€é‡ç‚¹ä»£ç 1ã€‘<br>                DefaultMQProducerImpl<span class="hljs-punctuation">#</span><span class="hljs-keyword">executeAsyncMessageSend</span><span class="hljs-params">(<span class="hljs-variable">Runnable</span>, <span class="hljs-variable">Message</span>, <span class="hljs-variable">BackpressureSendCallBack</span>,<span class="hljs-variable">long</span>, <span class="hljs-variable">long</span>)</span> ã€é‡ç‚¹ä»£ç 2ã€‘<br>                    DefaultMQProducerImpl<span class="hljs-punctuation">#</span><span class="hljs-keyword">sendDefaultImpl</span><br></code></pre></td></tr></table></figure>

<p>æ ¹æ®ä¸Šé¢çš„è°ƒç”¨æµç¨‹ï¼Œç›´æ¥çœ‹ <strong>é‡ç‚¹ä»£ç 1</strong> éƒ¨åˆ†ï¼Œ å³ <code>DefaultMQProducerImpl#send(Message, SendCallback, long)</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  DefaultMQProducerImpl ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">send</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Message msg, <span class="hljs-keyword">final</span> MessageQueue mq, <span class="hljs-keyword">final</span> SendCallback sendCallback, <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> timeout)</span><br>        <span class="hljs-keyword">throws</span> MQClientException, RemotingException, InterruptedException &#123;<br>    <span class="hljs-type">BackpressureSendCallBack</span> <span class="hljs-variable">newCallBack</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BackpressureSendCallBack</span>(sendCallback);<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">beginStartTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-comment">// æ„é€ ä»»åŠ¡ï¼Œè¿™é‡Œåªæ˜¯åˆ›å»ºäº†ä¸€ä¸ª Runnable å¯¹è±¡ï¼Œå¹¶æ²¡æœ‰è°ƒç”¨ start æ–¹æ³•</span><br>    <span class="hljs-comment">// å®é™…ä¼šå°†è¿™ä¸ªä»»åŠ¡äº¤ç»™ çº¿ç¨‹æ±  å»æ‰§è¡Œ</span><br>    <span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                makeSureStateOK();<br>                Validators.checkMessage(msg, defaultMQProducer);<br><br>                <span class="hljs-keyword">if</span> (!msg.getTopic().equals(mq.getTopic())) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MQClientException</span>(<span class="hljs-string">&quot;Topic of the message does not match its target message queue&quot;</span>, <span class="hljs-literal">null</span>);<br>                &#125;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">costTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - beginStartTime;<br>                <span class="hljs-keyword">if</span> (timeout &gt; costTime) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">// åœ¨ä»»åŠ¡é‡Œé¢æ‰§è¡Œæ¶ˆæ¯çš„å‘é€ï¼ŒåŒæ—¶å°† callback å›è°ƒå‡½æ•°ä¼ å…¥ï¼Œè¿™æ ·å°†æ”¶åˆ°æ¶ˆæ¯çš„ç»“æœ</span><br>                        <span class="hljs-comment">// ä¹‹åå°±å¯ä»¥è°ƒç”¨å›è°ƒå‡½æ•°</span><br>                        sendKernelImpl(msg, mq, CommunicationMode.ASYNC, newCallBack, <span class="hljs-literal">null</span>,<br>                            timeout - costTime);<br>                    &#125; <span class="hljs-keyword">catch</span> (MQBrokerException e) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MQClientException</span>(<span class="hljs-string">&quot;unknown exception&quot;</span>, e);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    newCallBack.onException(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RemotingTooMuchRequestException</span>(<span class="hljs-string">&quot;call timeout&quot;</span>));<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                newCallBack.onException(e);<br>            &#125;<br>        &#125;<br><br>    &#125;;<br>    <span class="hljs-comment">// è¿™é‡Œé¢å°±æ˜¯å°†ä»»åŠ¡äº¤ç»™ çº¿ç¨‹æ±  å»æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢åˆ—å‡ºçš„ **é‡ç‚¹ä»£ç 2**</span><br>    executeAsyncMessageSend(runnable, msg, newCallBack, timeout, beginStartTime);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeAsyncMessageSend</span><span class="hljs-params">(Runnable runnable, <span class="hljs-keyword">final</span> Message msg, <span class="hljs-keyword">final</span> BackpressureSendCallBack sendCallback,</span><br><span class="hljs-params">        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> timeout, <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> beginStartTime)</span><br>    <span class="hljs-keyword">throws</span> MQClientException, InterruptedException &#123;<br>    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getAsyncSenderExecutor();<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isEnableBackpressureForAsyncMode</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getDefaultMQProducer().isEnableBackpressureForAsyncMode();<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isSemaphoreAsyncNumAquired</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isSemaphoreAsyncSizeAquired</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">msgLen</span> <span class="hljs-operator">=</span> msg.getBody() == <span class="hljs-literal">null</span> ? <span class="hljs-number">1</span> : msg.getBody().length;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (isEnableBackpressureForAsyncMode) &#123;<br>            <span class="hljs-comment">// çœç•¥â€¦â€¦</span><br>        &#125;<br>        sendCallback.isSemaphoreAsyncSizeAquired = isSemaphoreAsyncSizeAquired;<br>        sendCallback.isSemaphoreAsyncNumAquired = isSemaphoreAsyncNumAquired;<br>        sendCallback.msgLen = msgLen;<br>        <span class="hljs-comment">//  å°†å‘é€æ¶ˆæ¯çš„ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± ä¸­</span><br>        executor.submit(runnable);<br>    &#125; <span class="hljs-keyword">catch</span> (RejectedExecutionException e) &#123;<br>        <span class="hljs-keyword">if</span> (isEnableBackpressureForAsyncMode) &#123;<br>            runnable.run();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MQClientException</span>(<span class="hljs-string">&quot;executor rejected &quot;</span>, e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>è‡³æ­¤å¼‚æ­¥æ¶ˆæ¯ä»»åŠ¡æäº¤å°±å®Œæˆäº†ï¼Œè‡³äºå‘é€é€»è¾‘å…¶å®å’ŒåŒæ­¥å°±æ²¡ä»€ä¹ˆåŒºåˆ«äº†ï¼Œåªæ˜¯åœ¨ç»“æœå¤„ç†çš„åœ°æ–¹ä¼šæœ‰åŒºåˆ«ï¼ŒåŒæ­¥çš„è¯ä¼šéœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå¼‚æ­¥çš„è¯ç›´æ¥è¿”å› <code>null</code>, å½“æ”¶åˆ°å“åº”åç›´æ¥è°ƒç”¨å›è°ƒå‡½æ•°</p>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQå®‰è£…ä½¿ç”¨å’ŒåŸºæœ¬æ¦‚å¿µ</title>
    <url>/2023/49fb249febb6/index.html</url>
    <content><![CDATA[<p>jdkç‰ˆæœ¬ï¼š17<br>rocketmqç‰ˆæœ¬ï¼š4.9.7 å’Œ 5.1.4</p>
<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå‡ºç°äº†å¦‚ä¸‹å‡ ä¸ªåè¯</p>
<ul>
<li><code>Broker</code></li>
<li><code>Producer</code></li>
<li><code>Consumer</code></li>
<li><code>Topic</code></li>
<li><code>Queue</code></li>
<li><code>NameServer</code></li>
</ul>
<pre class="mermaid">flowchart TB
    MP["Producer"]
    MC["Consumer"]
    style MP fill:#ca108c
    style MC fill:#ca108c
    subgraph A["æ¶ˆæ¯é˜Ÿåˆ—é›†ç¾¤"]
        style A fill:#8a5dca
        subgraph AA["Master"]
            subgraph A1["BrokerA"]
                style A1 fill:#7bed9f
                A11["queue 0 \n (TopicA)"]
                style A11 fill:#5dcac1
                A12["queue 0 \n (TopicB)"]
                style A12 fill:#ca8a5d
                A13["queue 0 \n (TopicC)"]
                style A13 fill:#f9d3e3
            end
            subgraph A2["BrokerB"]
                style A2 fill:#7bed9f
                A21["queue 1 \n (TopicA)"]
                style A21 fill:#5dcac1
                A22["queue 1 \n (TopicB)"]
                style A22 fill:#ca8a5d
                A23["queue 1 \n (TopicC)"]
                style A23 fill:#f9d3e3
            end
            subgraph A3["BrokerC"]
                style A3 fill:#7bed9f
                A31["queue 2 \n (TopicA)"]
                style A31 fill:#5dcac1
                A32["queue 2 \n (TopicB)"]
                style A32 fill:#ca8a5d
                A33["queue 2 \n (TopicC)"]
                style A33 fill:#f9d3e3
            end
            
        end
        subgraph BB["Slave"]
            subgraph B1["BrokerA"]
                B11["Message"]
            end
            subgraph B2["BrokerB"]
                B21["Message"]
            end
            subgraph B3["BrokerC"]
                B31["Message"]
            end
        end
        A1--åŒæ­¥-->B1
        A2--åŒæ­¥-->B2
        A3--åŒæ­¥-->B3
    end
    subgraph C["NameServeré›†ç¾¤"]
        style C fill:#c0d695
        direction LR
        C1["NameServerA"]
        C2["NameServerB"]
        C3["NameServerC"]
        C1~~~C2~~~C3
    end
    A--"BrokerAæ³¨å†Œ"-->C
    A--"BrokerBæ³¨å†Œ"-->C
    A--"BrokerCæ³¨å†Œ"-->C
    MP--"æŠ•é€’æ¶ˆæ¯"-->A
    A--"è·å–æ¶ˆæ¯"-->MC
    MP--"è·å–å…ƒæ•°æ®"-->C
    MC--"è·å–å…ƒæ•°æ®"-->C</pre>

<p>ä¸‹é¢å°±é’ˆå¯¹è¿™äº›æ¦‚å¿µæ¥è¿›è¡Œè®²è§£</p>
<h3 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h3><p><code>Broker</code> å°±æ˜¯ <code>RocketMq</code> æœåŠ¡ç«¯ç¨‹åºï¼Œåç§°å«åš <code>Broker</code> è€Œå·²ï¼Œ<code>Broker</code> æ˜¯ <code>RocketMQ</code> ä¸­çš„æ ¸å¿ƒï¼Œç®€å•æ¥è¯´å®ƒè´Ÿè´£æ¥æ”¶ <code>Producer</code> å‘é€è¿‡æ¥çš„ <code>Message</code> ã€å¹¶å°†å…¶æŒä¹…åŒ–èµ·æ¥ï¼ŒåŒæ—¶è´Ÿè´£å¤„ç† <code>Consumer</code> çš„æ¶ˆè´¹è¯·æ±‚</p>
<pre class="mermaid">graph LR
    A["ç”Ÿäº§è€…(Producer)"]
    B["æ¶ˆæ¯é˜Ÿåˆ—(Broker)"]
    C["æ¶ˆè´¹è€…(Consumer)"]
    A--"æŠ•é€’æ¶ˆæ¯"-->B--"æ‹‰å–æ¶ˆæ¯"-->C</pre>

<h3 id="Producer-å’Œ-Consumer"><a href="#Producer-å’Œ-Consumer" class="headerlink" title="Producer å’Œ Consumer"></a>Producer å’Œ Consumer</h3><ul>
<li><code>Producer</code> å°±æ˜¯å‘é€æ¶ˆæ¯çš„ç¨‹åºï¼Œä¸€èˆ¬éƒ½æ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡ç¨‹åºä½œä¸º <code>Producer</code></li>
<li><code>Consuemr</code> å°±æ˜¯æ¶ˆè´¹æ¶ˆæ¯çš„ç¨‹åºï¼Œä¸€èˆ¬éƒ½æ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡ç¨‹åºä½œä¸º <code>Consumer</code></li>
</ul>
<h3 id="Topic"><a href="#Topic" class="headerlink" title="Topic"></a>Topic</h3><p><code>Topic</code> æ˜¯ <code>RocketMQ</code> ä¸­æ¶ˆæ¯ä¼ è¾“å’Œå­˜å‚¨çš„é¡¶å±‚å®¹å™¨ï¼Œç”¨äºæ ‡è¯†åŒä¸€ç±»ä¸šåŠ¡é€»è¾‘çš„æ¶ˆæ¯ã€‚ ä¸»é¢˜çš„ä½œç”¨ä¸»è¦å¦‚ä¸‹ï¼š</p>
<ul>
<li>å®šä¹‰æ•°æ®çš„åˆ†ç±»éš”ç¦»ï¼š åœ¨ <code>RocketMQ</code> çš„æ–¹æ¡ˆè®¾è®¡ä¸­ï¼Œå»ºè®®å°†ä¸åŒä¸šåŠ¡ç±»å‹çš„æ•°æ®æ‹†åˆ†åˆ°ä¸åŒçš„ä¸»é¢˜ä¸­ç®¡ç†ï¼Œé€šè¿‡ä¸»é¢˜å®ç°å­˜å‚¨çš„éš”ç¦»æ€§å’Œè®¢é˜…éš”ç¦»æ€§</li>
<li>å®šä¹‰æ•°æ®çš„èº«ä»½å’Œæƒé™ï¼š <code>RocketMQ</code> çš„æ¶ˆæ¯æœ¬èº«æ˜¯åŒ¿åæ— èº«ä»½çš„ï¼ŒåŒä¸€åˆ†ç±»çš„æ¶ˆæ¯ä½¿ç”¨ç›¸åŒçš„ä¸»é¢˜æ¥åšèº«ä»½è¯†åˆ«å’Œæƒé™ç®¡ç†</li>
<li><code>Topic</code> å®é™…æ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œæ¶ˆæ¯å®é™…æ˜¯å‘é€åˆ° <code>MessageQueue</code> ä¸­</li>
</ul>
<h3 id="MessageQueue"><a href="#MessageQueue" class="headerlink" title="MessageQueue"></a>MessageQueue</h3><p>ç›´æ¥ä½¿ç”¨ <code>Topic</code> å¸¦æ¥çš„é—®é¢˜è´Ÿè½½ä¸å¹³è¡¡ï¼Œæ¯”å¦‚æœ‰çš„ <code>Topic</code> æ•°æ®é‡å¾ˆå¤§ï¼Œæœ‰çš„ <code>Topic</code> æ•°æ®é‡å¾ˆå°ï¼Œå°±ä¼šå¯¼è‡´æœ‰çš„ <code>Broker</code> å‹åŠ›å¤§ï¼Œæœ‰çš„ <code>Broker</code> å‹åŠ›å°ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¶ˆæ¯å®é™…ä¸Šä¸æ˜¯ç›´æ¥å‘å¾€ <code>Topic</code> çš„ï¼Œè€Œæ˜¯å‘å¾€ <code>MessageQueue</code>, å¯¹åº”çš„å…³ç³»å›¾å¦‚ä¸‹</p>
<pre class="mermaid">graph TB
    A["TopicA"]
    subgraph B["Brokeré›†ç¾¤"]
        subgraph B1["Broker1"]
            B11["MessageQueue-1"]
        end
        subgraph B2["Broker2"]
            B21["MessageQueue-2"]
        end
        subgraph B3["Broker3"]
            B31["MessageQueue-3"]
        end
    end
    style B11 fill:#7bed9f
    style B21 fill:#7bed9f
    style B31 fill:#7bed9f
    A-->B11
    A-->B21
    A-->B31</pre>

<p>ä¸Šé¢æœ‰æåˆ° <code>Topic</code> çš„ä½œç”¨æ˜¯å¯¹æ¶ˆæ¯è¿›è¡Œåˆ†ç±»ï¼Œ<code>MessageQueue</code> æ˜¯æ¶ˆæ¯å­˜å‚¨å’Œä¼ è¾“çš„å®é™…å®¹å™¨ï¼Œä¹Ÿæ˜¯ <code>RocketMQ</code> æ¶ˆæ¯çš„æœ€å°å­˜å‚¨å•å…ƒï¼Œ æ ¹æ®ä¸Šå›¾å°±èƒ½çœ‹å‡ºæ¥ï¼ŒåŒä¸€ç±»æ¶ˆæ¯å°±å¯ä»¥åˆ†æ•£å­˜å‚¨åœ¨ä¸åŒçš„ <code>Broker</code> ä¸­ï¼Œæœºå™¨å‹åŠ›å°±åˆ†æ•£äº†</p>
<h3 id="NameServer"><a href="#NameServer" class="headerlink" title="NameServer"></a>NameServer</h3><ul>
<li><code>NameServer</code> ç”¨äºå­˜å‚¨æ•´ä¸ª <code>RocketMQ</code> é›†ç¾¤çš„ å…ƒæ•°æ®</li>
<li><code>NameServer</code> ä¸­çš„å…ƒæ•°æ®å¤§æ¦‚åŒ…å«å¦‚ä¸‹å‡ ç±»<ul>
<li>é›†ç¾¤é‡Œéƒ½åŒ…å«å“ªäº› <code>Topic</code></li>
<li>è¿™äº› <code>Topic</code> çš„ <code>MessageQueue</code> åˆ†åˆ«åœ¨å“ªäº› <code>Broker</code> ä¸Š</li>
<li>é›†ç¾¤é‡Œéƒ½æœ‰å“ªäº›æ´»è·ƒçš„ <code>Broker</code></li>
</ul>
</li>
<li>ä¸ºäº†é¿å… <code>NameServer</code> å•ç‚¹æ•…éšœï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥å°† <code>NameServer</code> éƒ¨ç½²æˆé›†ç¾¤ï¼Œä½†æ˜¯ <code>NameServer</code> ä¹‹é—´å¹¶æ²¡æœ‰æ•°æ®ä¼ é€’ï¼Œ æ¯ä¸€ä¸ª <code>NameServer</code> éƒ½åŒ…å«å®Œæ•´çš„æ•°æ®</li>
<li><code>Producer</code>,<code>Consumer</code>,<code>Broker</code> éƒ½éœ€è¦è‡ªè¡Œå°†æ•°æ®æ³¨å†Œåˆ° <code>NameServer</code> ä¸Šï¼Œå¦‚æœæ˜¯ <code>NameServer</code> æ˜¯é›†ç¾¤ï¼Œåˆ™éœ€è¦å°†æ•°æ®æ³¨å†Œåˆ°æ¯ä¸€ä¸ª <code>NameServer</code> ä¸­</li>
</ul>
<pre class="mermaid">graph TB
    subgraph A["ç”Ÿäº§è€…/æ¶ˆè´¹è€…"]
        A1["ç”Ÿäº§è€…(Producer)"]
        A2["æ¶ˆè´¹è€…(Consumer)"]
    end
    style A1 fill:#7bed9f
    style A2 fill:#7bed9f
    subgraph B["Brokeré›†ç¾¤"]
        B1["Broker1"]
        B2["Broker2"]
    end
    style B1 fill:#5dcac1
    style B2 fill:#5dcac1
    subgraph D["NameServeré›†ç¾¤"]
        D1["NameServer1"]
        D2["NameServer2"]
    end
    style D1 fill:#c0d695
    style D2 fill:#c0d695
    A1-->D1
    A1-->D2
    A2-->D1
    A2-->D2
    B1-->D1
    B1-->D2
    B2-->D1
    B2-->D2</pre>


<h2 id="RocketMQ4-å®‰è£…å’Œä½¿ç”¨"><a href="#RocketMQ4-å®‰è£…å’Œä½¿ç”¨" class="headerlink" title="RocketMQ4 å®‰è£…å’Œä½¿ç”¨"></a>RocketMQ4 å®‰è£…å’Œä½¿ç”¨</h2><p>å®‰è£… <code>RocketMQ</code> ä¹‹å‰éœ€è¦ä¸‹å®‰è£… <code>JDK</code> ç¯å¢ƒ</p>
<ol><li><a href="/2023/e6e83576f25e/index.html" title="Ubuntu23.04å®‰è£…jdkå’Œmaven">Ubuntu23.04å®‰è£…jdkå’Œmaven</a></li></ol>

<p><a href="https://rocketmq.apache.org/download/">RocketMQå®˜æ–¹ä¸‹è½½åœ°å€</a>ï¼Œé€‰æ‹© <code>binary</code> ç±»å‹ï¼Œæœ¬æ¬¡ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯ <code>4.9.7</code></p>
<p><a href="https://mirrors.aliyun.com/apache/rocketmq/">RocketMQé˜¿é‡Œäº‘é•œåƒç«™ç‚¹</a></p>
<p>è¿™é‡Œä¸‹è½½çš„æ˜¯ <code>rocketmq-all-4.9.7-bin-release.zip</code> ç„¶åå°†å…¶ä¸Šä¼ åˆ° <code>Ubuntu</code> æœåŠ¡å™¨ä¸­ï¼Œ è¿™é‡Œä¸Šä¼ çš„ä½ç½®æ˜¯ <code>/opt/software</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /opt/software<br>unzip rocketmq-all-4.9.7-bin-release.zip<br><br><span class="hljs-built_in">cd</span> rocketmq-all-4.9.7-bin-release/<br><span class="hljs-comment"># å¯åŠ¨ namesrv</span><br><span class="hljs-built_in">nohup</span> bash bin/mqnamesrv &amp;<br><br><span class="hljs-comment"># å¯åŠ¨ broker</span><br><span class="hljs-built_in">nohup</span> bash bin/mqbroker -n localhost:9876 &amp;<br><br><span class="hljs-comment"># namesrv å’Œ broker å¯åŠ¨çš„æ—¥å¿—éƒ½æ˜¯å­˜åœ¨ ~/logs/rocketmq-logs/ ä¸‹é¢</span><br><br><span class="hljs-comment"># åœæ­¢ broker</span><br><span class="hljs-built_in">cd</span> /opt/software/rocketmq-all-4.9.7-bin-release/<br>bash bin/mqshutdown broker<br><br><span class="hljs-comment"># åœæ­¢ namesrv</span><br><span class="hljs-built_in">cd</span> /opt/software/rocketmq-all-4.9.7-bin-release/<br>bash bin/mqshutdown namesrv<br></code></pre></td></tr></table></figure>
<h3 id="å¯åŠ¨é”™è¯¯é—®é¢˜æ”¶é›†"><a href="#å¯åŠ¨é”™è¯¯é—®é¢˜æ”¶é›†" class="headerlink" title="å¯åŠ¨é”™è¯¯é—®é¢˜æ”¶é›†"></a>å¯åŠ¨é”™è¯¯é—®é¢˜æ”¶é›†</h3><p><strong>å†…å­˜ä¸è¶³</strong></p>
<p>å¯åŠ¨ <code>namesrv</code> æˆ– <code>broker</code> å‡ºç°</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">os</span>::commit_memory(<span class="hljs-number">0</span>x0000000600000000, <span class="hljs-number">8589934592</span>, <span class="hljs-number">0</span>) failed; error=&#x27;Not enough space&#x27; (errno=<span class="hljs-number">12</span>)<br><span class="hljs-comment">#</span><br><span class="hljs-comment"># There is insufficient memory for the Java Runtime Environment to continue.</span><br><span class="hljs-comment"># Native memory allocation (mmap) failed to map 8589934592 bytes for committing reserved memory.</span><br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ˜¯è¯´æ˜å†…å­˜ä¸è¶³ï¼Œå¯ä»¥è°ƒå° <code>jvm</code> å†…å­˜ï¼Œ æ‰¾åˆ° <code>/opt/software/rocketmq-all-4.9.7-bin-release/bin/runserver.sh</code> å’Œ <code>/opt/software/rocketmq-all-4.9.7-bin-release/bin/runbroker.sh</code>ï¼Œ æ‰¾åˆ°ç±»ä¼¼ <code> -Xms8g -Xmx8g -Xmn4g</code> çš„é…ç½®ï¼Œ ç„¶åå°† <code>8g</code> æ”¹æˆ <code>2g</code> å³å¯</p>
<p><strong>å‚æ•°ä¸å¯¹</strong><br>å¯åŠ¨ <code>broker</code> å‡ºç°</p>
<figure class="highlight subunit"><table><tr><td class="code"><pre><code class="hljs subunit">Unrecognized VM option &#x27;UseBiasedLocking&#x27;<br><span class="hljs-keyword">Error: </span>Could not create the Java Virtual Machine.<br><span class="hljs-keyword">Error: </span>A fatal exception has occurred. Program will exit.<br></code></pre></td></tr></table></figure>
<p>é”™è¯¯ä¸­å·²ç»æœ‰æç¤ºæ— æ³•è¯†åˆ« <code>jvm</code> å‚æ•°  <code>UseBiasedLocking</code>ï¼Œ è¿™ä¸ªåŸºæœ¬ä¸Šéƒ½æ˜¯å’Œä½¿ç”¨çš„ <code>jdk</code> ç‰ˆæœ¬æœ‰å…³ï¼Œ<code>broker</code> å¯åŠ¨è„šæœ¬æ˜¯ <code>bin</code> ç›®å½•ä¸‹çš„ <code>runbroker.sh</code>ï¼Œ å¯ä»¥æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶å°†æ— æ³•è¯†åˆ«çš„å‚æ•°å»æ‰</p>
<h3 id="åŸºäºé…ç½®æ–‡ä»¶å¯åŠ¨-Broker"><a href="#åŸºäºé…ç½®æ–‡ä»¶å¯åŠ¨-Broker" class="headerlink" title="åŸºäºé…ç½®æ–‡ä»¶å¯åŠ¨ Broker"></a>åŸºäºé…ç½®æ–‡ä»¶å¯åŠ¨ Broker</h3><p>å‰é¢è®²è§£çš„æ—¶å€™ä½¿ç”¨ <code>nohup bash bin/mqbroker -n localhost:9876 &amp;</code> çš„æ–¹å¼æ¥å¯åŠ¨ <code>Broker</code>, å¦‚æœæ˜¯ä½¿ç”¨ <code>Broker</code> é›†ç¾¤ï¼Œè¿™ç§å¯åŠ¨æ–¹å¼æ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥å¯ä»¥å¯åŠ¨å‚æ•°æ”¾å…¥é…ç½®æ–‡ä»¶ä¸­ï¼Œ é»˜è®¤åœ¨ <code>RocketMQ</code> å®‰è£…ç›®å½•ä¸‹çš„ <code>conf</code> ç›®å½•ä¸‹ï¼Œ å¯åŠ¨é…ç½®æ–‡ä»¶ä¸º <code>broker.conf</code></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">#broker.conf</span><br><span class="hljs-attr">brokerClusterName</span> = <span class="hljs-string">DefaultCluster</span><br><span class="hljs-attr">brokerName</span> = <span class="hljs-string">broker-a</span><br><span class="hljs-attr">brokerId</span> = <span class="hljs-string">0</span><br><span class="hljs-attr">deleteWhen</span> = <span class="hljs-string">04</span><br><span class="hljs-attr">fileReservedTime</span> = <span class="hljs-string">48</span><br><span class="hljs-attr">brokerRole</span> = <span class="hljs-string">ASYNC_MASTER</span><br><span class="hljs-attr">flushDiskType</span> = <span class="hljs-string">ASYNC_FLUSH</span><br></code></pre></td></tr></table></figure>
<p>è¿™ä¸ªé»˜è®¤çš„é…ç½®æ–‡ä»¶å¹¶æ²¡æœ‰æŒ‡å®š <code>namesrv</code> çš„åœ°å€ï¼Œæ‰€ä»¥å¯ä»¥ä¿®æ”¹æˆå¦‚ä¸‹å½¢å¼</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">&lt;!--</span> <span class="hljs-string">é…ç½®namesrvåœ°å€ï¼Œå¯ä»¥æ˜¯å¤šä¸ª --&gt;</span><br><span class="hljs-attr">namesrvAddr</span>=<span class="hljs-string">192.168.100.131:9876; 192.168.100.132:9876</span><br><span class="hljs-attr">&lt;!--</span> <span class="hljs-string">é›†ç¾¤çš„åç§°ï¼ŒåŒä¸€ä¸ªé›†ç¾¤ä¸­çš„å¤šä¸ª brokeré…ç½®æ–‡ä»¶çš„é›†ç¾¤åç§°è¦ç›¸åŒ --&gt;</span><br><span class="hljs-attr">brokerClusterName</span>=<span class="hljs-string">DefaultCluster</span><br><span class="hljs-attr">&lt;!--</span> <span class="hljs-string">å½“å‰ broker çš„åç§° --&gt;</span><br><span class="hljs-attr">brokerName</span>=<span class="hljs-string">broker-a</span><br><span class="hljs-attr">&lt;!--</span> <span class="hljs-string">ä¸€ä¸ªMaster Borkerå¯ä»¥æœ‰å¤šä¸ªSlave,0è¡¨ç¤ºMasterï¼Œå¤§äº0è¡¨ç¤ºä¸åŒSlaveçš„ID --&gt;</span><br><span class="hljs-attr">brokerId</span>=<span class="hljs-string">0</span><br><span class="hljs-attr">&lt;!--</span> <span class="hljs-string">ä¸fileReservedTimeå‚æ•°å‘¼åº”ï¼Œè¡¨æ˜åœ¨å‡ ç‚¹åšæ¶ˆæ¯åˆ é™¤åŠ¨ä½œï¼Œé»˜è®¤å€¼04è¡¨ç¤ºå‡Œæ™¨4ç‚¹ --&gt;</span><br><span class="hljs-attr">deleteWhen</span>=<span class="hljs-string">04</span><br><span class="hljs-attr">&lt;!--</span> <span class="hljs-string">åœ¨ç£ç›˜ä¸Šä¿å­˜æ¶ˆæ¯çš„æ—¶é•¿ï¼Œå•ä½æ˜¯å°æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤è¶…æ—¶çš„æ¶ˆæ¯ --&gt;</span><br><span class="hljs-attr">fileReservedTime</span>=<span class="hljs-string">48</span><br><span class="hljs-attr">&lt;!--</span> <span class="hljs-string">brokerRoleæœ‰3ç§ï¼šSYNC_MASTERã€ASYNC_MASTERã€SLAVEã€‚å…³é”®è¯SYNCå’ŒASYNCè¡¨ç¤ºMasterå’ŒSlave</span><br><span class="hljs-attr">ä¹‹é—´åŒæ­¥æ¶ˆæ¯çš„æœºåˆ¶ï¼ŒSYNCçš„æ„æ€æ˜¯å½“Slaveå’ŒMasteræ¶ˆæ¯åŒæ­¥å®Œæˆåï¼Œå†è¿”å›å‘é€æˆåŠŸçš„çŠ¶æ€</span> <span class="hljs-string">--&gt;</span><br><span class="hljs-attr">brokerRole</span>=<span class="hljs-string">SYNC_MASTER</span><br><span class="hljs-attr">&lt;!--</span> <span class="hljs-string">flushDiskTypeè¡¨ç¤ºåˆ·ç›˜ç­–ç•¥ï¼Œåˆ†ä¸ºSYNC_FLUSHå’ŒASYNC_FLUSHä¸¤ç§ï¼Œ</span><br><span class="hljs-attr">åˆ†åˆ«ä»£è¡¨åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜ã€‚åŒæ­¥åˆ·ç›˜æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯çœŸæ­£å†™å…¥ç£ç›˜åå†è¿”å›æˆåŠŸçŠ¶æ€ï¼›</span><br><span class="hljs-attr">å¼‚æ­¥åˆ·ç›˜æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯å†™å…¥page_cacheåå°±è¿”å›æˆåŠŸçŠ¶æ€</span> <span class="hljs-string">--&gt;</span><br><span class="hljs-attr">flushDiskType</span>=<span class="hljs-string">ASYNC_FLUSH</span><br><span class="hljs-attr">&lt;!--</span> <span class="hljs-string">Brokerç›‘å¬çš„ç«¯å£å·ï¼Œå¦‚æœä¸€å°æœºå™¨ä¸Šå¯åŠ¨äº†å¤šä¸ªBrokerï¼Œåˆ™è¦è®¾ç½®ä¸åŒçš„ç«¯å£å·ï¼Œé¿å…å†²çª --&gt;</span><br><span class="hljs-attr">listenPort</span>=<span class="hljs-string">10911</span><br><span class="hljs-attr">&lt;!--</span> <span class="hljs-string">å­˜å‚¨æ¶ˆæ¯ä»¥åŠä¸€äº›é…ç½®ä¿¡æ¯çš„æ ¹ç›®å½• --&gt;</span><br><span class="hljs-attr">storePathRootDir</span>=<span class="hljs-string">/home/rocketmq/store-a</span><br></code></pre></td></tr></table></figure>
<p>ç„¶ååœ¨å¯åŠ¨å¤šä¸ª <code>namesrv</code> ä¹‹åå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼æ¥å¯åŠ¨ <code>broker</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /opt/software/rocketmq-all-4.9.7-bin-release/<br><span class="hljs-built_in">nohup</span> bash ./bin/mqbroker -c  ./conf/broker.conf &amp;<br></code></pre></td></tr></table></figure>

<h2 id="ä½¿ç”¨è„šæœ¬å¿«é€Ÿå¯åŠ¨RocketMQ-å•æœºç‰ˆæœ¬"><a href="#ä½¿ç”¨è„šæœ¬å¿«é€Ÿå¯åŠ¨RocketMQ-å•æœºç‰ˆæœ¬" class="headerlink" title="ä½¿ç”¨è„šæœ¬å¿«é€Ÿå¯åŠ¨RocketMQ å•æœºç‰ˆæœ¬"></a>ä½¿ç”¨è„šæœ¬å¿«é€Ÿå¯åŠ¨RocketMQ å•æœºç‰ˆæœ¬</h2><p>å‰é¢å·²ç»å†™äº†æ€ä¹ˆé€šè¿‡å‘½ä»¤æ¥å¯åŠ¨&#x2F;åœæ­¢ <code>RocketMQ</code>ï¼Œ ä½†æ˜¯æ¯æ¬¡éœ€è¦è¿›å…¥ç‰¹å®šçš„ç›®å½•ï¼Œè€Œä¸”å¯åŠ¨å’Œåœæ­¢çš„å‘½ä»¤ä¹Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥å¯ä»¥å†™ä¸€ä¸ªè„šæœ¬æ¥ç®€åŒ–æ“ä½œï¼ˆå½“å‰ <code>RocketMQ</code> æ ¹ç›®å½•æ˜¯ <code>/opt/software/rocketmq-all-4.9.7-bin-release/</code> ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /opt/software/rocketmq-all-4.9.7-bin-release/<br>vim rocketmq.sh<br></code></pre></td></tr></table></figure>
<p><code>rocketmq.sh</code> è„šæœ¬å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br>ROCKETMQ_HOME=/opt/software/rocketmq-all-4.9.7-bin-release<br><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> = <span class="hljs-string">&quot;start&quot;</span> ]; <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">nohup</span> sh <span class="hljs-variable">$ROCKETMQ_HOME</span>/bin/mqnamesrv &gt;  /dev/null 2&gt;&amp;1 &amp;<br>  <span class="hljs-built_in">sleep</span> 3<br>  <span class="hljs-built_in">nohup</span> sh <span class="hljs-variable">$ROCKETMQ_HOME</span>/bin/mqbroker -n localhost:9876 &gt; /dev/null 2&gt;&amp;1 &amp;<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;RocketMQ nameserver and broker started&quot;</span><br><span class="hljs-keyword">elif</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> = <span class="hljs-string">&quot;stop&quot;</span> ]; <span class="hljs-keyword">then</span><br>  sh <span class="hljs-variable">$ROCKETMQ_HOME</span>/bin/mqshutdown broker<br>  <span class="hljs-built_in">sleep</span> 3<br>  sh <span class="hljs-variable">$ROCKETMQ_HOME</span>/bin/mqshutdown namesrv<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;RocketMQ broker and nameserver stopped&quot;</span><br><span class="hljs-keyword">else</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-variable">$0</span> start|stop&quot;</span><br>  <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure>

<p>ç„¶åå°†è„šæœ¬çš„æƒé™è®¾ç½®ä¸ºå¯æ‰§è¡Œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> +x rocketmq.sh<br></code></pre></td></tr></table></figure>

<p>åˆ›å»ºè½¯è¿æ¥ï¼Œåœ¨ä»»æ„ä½ç½®éƒ½å¯ä»¥æ‰§è¡Œè¿™ä¸ªè„šæœ¬</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sudo <span class="hljs-built_in">ln</span> -s /opt/software/rocketmq-all-4.9.7-bin-release/rocketmq.sh /usr/local/bin/rocketmq.sh<br><span class="hljs-comment"># æ¥ä¸‹æ¥çš„å‘½ä»¤æ˜¯å¯ä»¥åœ¨ä»»æ„ä½ç½®æ‰§è¡Œ</span><br><span class="hljs-comment"># å¯åŠ¨ rocketmq</span><br>rocketmq.sh start<br><br><span class="hljs-comment"># åœæ­¢ rocketmq</span><br>rocketmq.sh stop<br></code></pre></td></tr></table></figure>

<h2 id="å®‰è£…-RocketMQ-dashboardï¼ˆrocketmq-consoleï¼‰"><a href="#å®‰è£…-RocketMQ-dashboardï¼ˆrocketmq-consoleï¼‰" class="headerlink" title="å®‰è£… RocketMQ dashboardï¼ˆrocketmq-consoleï¼‰"></a>å®‰è£… RocketMQ dashboardï¼ˆrocketmq-consoleï¼‰</h2><p>ä»¥å‰ <code>RokcetMQ</code> ç•Œé¢ç›‘æ§æœåŠ¡å«åš <code>rocketmq-console</code>ï¼Œ ç°åœ¨å·²ç»æ”¹æˆ <code>rocketmq-dashboard</code>ï¼Œ æ‰€ä»¥éœ€è¦å®‰è£… <code>rocketmq-dashboard</code></p>
<p><a href="https://rocketmq.apache.org/zh/docs/4.x/deployment/03Dashboard">rocketmq-dashboardå®˜æ–¹å®‰è£…è¯´æ˜</a></p>
<p>ä½¿ç”¨ <code>docker</code> å®‰è£…æ›´ç®€å•ï¼Œæ‰€ä»¥å°±ä½¿ç”¨ <code>docker</code> å®‰è£…çš„æ–¹å¼</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker pull apacherocketmq/rocketmq-dashboard:latest<br>docker run -d --name rocketmq-dashboard -e <span class="hljs-string">&quot;JAVA_OPTS=-Drocketmq.namesrv.addr=192.168.208.130:9876&quot;</span> -p 8080:8080 -t apacherocketmq/rocketmq-dashboard:latest<br></code></pre></td></tr></table></figure>
<p>å› ä¸º <code>RocketMQ</code> æ˜¯å®‰è£…åœ¨ <code>Ubuntu</code> è™šæ‹Ÿæœºä¸­ï¼Œä½†æ˜¯è®¿é—®æ˜¯åœ¨ <code>Window</code> ä¸­ï¼Œæ‰€ä»¥è¿™é‡Œ <code>rocketmq.namesrv.addr</code> å¡«å†™çš„å°±æ˜¯è™šæ‹Ÿæœºçš„ <code>ip</code></p>
<p>ç„¶ååœ¨ <code>Window</code> ä¸­è®¿é—® <code>http://192.168.208.130:8080</code> å³å¯çœ‹åˆ° <code>RocketMQ</code> çš„ç›‘æ§é¡µé¢</p>
<h3 id="ä¿®æ”¹è„šæœ¬ä¸€æ¬¡æ€§å¯åŠ¨-RocketMQ-å’Œ-Dashboard"><a href="#ä¿®æ”¹è„šæœ¬ä¸€æ¬¡æ€§å¯åŠ¨-RocketMQ-å’Œ-Dashboard" class="headerlink" title="ä¿®æ”¹è„šæœ¬ä¸€æ¬¡æ€§å¯åŠ¨ RocketMQ å’Œ Dashboard"></a>ä¿®æ”¹è„šæœ¬ä¸€æ¬¡æ€§å¯åŠ¨ <code>RocketMQ</code> å’Œ <code>Dashboard</code></h3><p>å‰ææ¡ä»¶æ˜¯å·²ç»ä½¿ç”¨ä¸Šé¢ <code>docker</code> çš„æ–¹å¼å¯åŠ¨è¿‡ä¸€æ¬¡ <code>rocketq-dashboard</code>, è¿™æ ·å¯¹åº”å®¹å™¨çš„åç§°å°±æ˜¯ <code>rocketmq-dashboard</code>ï¼Œ ä¹Ÿå°±å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è„šæœ¬ä¸€æ¬¡æ€§å¯åŠ¨å’Œå…³é—­</p>
<p><code>rocketmq.sh</code> è„šæœ¬å†…å®¹ä¿®æ”¹æˆå¦‚ä¸‹å½¢å¼</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br>ROCKETMQ_HOME=/opt/software/rocketmq-all-4.9.7-bin-release<br><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> = <span class="hljs-string">&quot;start&quot;</span> ]; <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">nohup</span> sh <span class="hljs-variable">$ROCKETMQ_HOME</span>/bin/mqnamesrv &gt;  /dev/null 2&gt;&amp;1 &amp;<br>  ecgi <span class="hljs-string">&quot;RocketMQ namesrv started&quot;</span><br>  <span class="hljs-built_in">sleep</span> 3<br>  <span class="hljs-built_in">nohup</span> sh <span class="hljs-variable">$ROCKETMQ_HOME</span>/bin/mqbroker -n localhost:9876 &gt; /dev/null 2&gt;&amp;1 &amp;<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;RocketMQ broker started&quot;</span><br>  <span class="hljs-built_in">sleep</span> 3<br>  docker start rocketmq-dashboard<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;rocketmq-dashboard started&quot;</span><br><span class="hljs-keyword">elif</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> = <span class="hljs-string">&quot;stop&quot;</span> ]; <span class="hljs-keyword">then</span><br>  sh <span class="hljs-variable">$ROCKETMQ_HOME</span>/bin/mqshutdown broker<br>  <span class="hljs-built_in">sleep</span> 3<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;rocketmq broker stopped&quot;</span><br>  sh <span class="hljs-variable">$ROCKETMQ_HOME</span>/bin/mqshutdown namesrv<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;RocketMQ nameserver stopped&quot;</span><br>  <span class="hljs-built_in">sleep</span> 2<br>  docker stop rocketmq-dashboard<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;rocketmq-dashboard stopped&quot;</span><br><span class="hljs-keyword">else</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-variable">$0</span> start|stop&quot;</span><br>  <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure>
<ul>
<li>ä½¿ç”¨ <code>rocketmq.sh start</code> å¯åŠ¨ <code>Namesrv</code> å’Œ <code>Broker</code> å’Œ <code>Dashboard</code></li>
<li>ä½¿ç”¨ <code>rocketmq.sh stop</code> åœæ­¢ <code>Namesrv</code> å’Œ <code>Broker</code> å’Œ <code>Dashboard</code></li>
</ul>
<h2 id="ä¸‹è½½-RocketMQ-æºç æµ‹è¯•"><a href="#ä¸‹è½½-RocketMQ-æºç æµ‹è¯•" class="headerlink" title="ä¸‹è½½ RocketMQ æºç æµ‹è¯•"></a>ä¸‹è½½ RocketMQ æºç æµ‹è¯•</h2><p>å‰é¢ä¸‹è½½å’Œå®‰è£…çš„éƒ½æ˜¯ <code>binary</code> ç±»å‹ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ <code>RocketMQ</code> çš„æœåŠ¡ç«¯ç¨‹åº( <code>Namesrv</code> å’Œ <code>Broker</code> )ï¼Œ æ¥ä¸‹æ¥ä½¿ç”¨æºç æ˜¯ä½œä¸º <code>Producer</code> å’Œ <code>Consumer</code> è¿›è¡Œæ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶çš„</p>
<blockquote>
<p>RocketMQ æºç ä¹Ÿæ˜¯å¯ä»¥åŸæ¥å¯åŠ¨ Namesrv å’Œ Broker çš„ï¼Œä¸è¿‡å¦‚æœä¸æ˜¯è¦çœ‹å¯¹åº”çš„æºç ï¼Œè¿˜æ˜¯ä½¿ç”¨ Binary æ–¹å¼å¯åŠ¨ Namesrv å’Œ broker æ¯”è¾ƒæ–¹ä¾¿</p>
</blockquote>
<p><a href="https://rocketmq.apache.org/download/">RocketMQå®˜æ–¹ä¸‹è½½åœ°å€</a>ï¼Œé€‰æ‹© <code>Source</code> ç±»å‹ï¼Œæœ¬æ¬¡ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯ <code>4.9.7</code>ï¼Œ è§£å‹åç›´æ¥ç”¨ <code>idea</code> å¯¼å…¥å³å¯</p>
<h3 id="å‘é€æ¶ˆæ¯æµ‹è¯•"><a href="#å‘é€æ¶ˆæ¯æµ‹è¯•" class="headerlink" title="å‘é€æ¶ˆæ¯æµ‹è¯•"></a>å‘é€æ¶ˆæ¯æµ‹è¯•</h3><ul>
<li>æ‰“å¼€ <code>rocket</code> æºç åæ‰¾åˆ° <code>example</code> å­é¡¹ç›®ï¼Œåœ¨è¯¥å­é¡¹ç›®ä¸‹æ‰¾åˆ° <code>org.apache.rocketmq.example.simple.Producer</code> ç±»</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException, InterruptedException &#123;<br><br>        <span class="hljs-type">DefaultMQProducer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQProducer</span>(<span class="hljs-string">&quot;ProducerGroupName&quot;</span>);<br>        <span class="hljs-comment">// è¿™ä¸€è¡Œæ˜¯è‡ªå·±æ·»åŠ çš„ï¼ŒæŒ‡å®š Namesrv çš„åœ°å€</span><br>        producer.setNamesrvAddr(<span class="hljs-string">&quot;192.168.208.130:9876&quot;</span>);<br>        producer.start();<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">128</span>; i++)<br>            <span class="hljs-keyword">try</span> &#123;<br>                &#123;<br>                    <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(<span class="hljs-string">&quot;TopicTest&quot;</span>,<br>                        <span class="hljs-string">&quot;TagA&quot;</span>,<br>                        <span class="hljs-string">&quot;OrderID188&quot;</span>,<br>                        <span class="hljs-string">&quot;Hello world&quot;</span>.getBytes(RemotingHelper.DEFAULT_CHARSET));<br>                    <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> producer.send(msg);<br>                    System.out.printf(<span class="hljs-string">&quot;%s%n&quot;</span>, sendResult);<br>                &#125;<br><br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        producer.shutdown();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ç›´æ¥å¯åŠ¨å°±å¯ä»¥å‘é€æ¶ˆæ¯åˆ° <code>RocketMQ</code> ä¸­ï¼Œ å¯ä»¥æ‰“å¼€ <code>RocketMQ dashboard</code> è¿›è¡ŒæŸ¥çœ‹</p>
<h3 id="æ¥æ”¶æ¶ˆæ¯æµ‹è¯•"><a href="#æ¥æ”¶æ¶ˆæ¯æµ‹è¯•" class="headerlink" title="æ¥æ”¶æ¶ˆæ¯æµ‹è¯•"></a>æ¥æ”¶æ¶ˆæ¯æµ‹è¯•</h3><ul>
<li>æ‰“å¼€ <code>rocket</code> æºç åæ‰¾åˆ° <code>example</code> å­é¡¹ç›®ï¼Œåœ¨è¯¥å­é¡¹ç›®ä¸‹æ‰¾åˆ° <code>org.apache.rocketmq.example.simple.PullConsumer</code> ç±»</li>
</ul>
<p>ä¸»è¦æ˜¯ä¿®æ”¹è¿æ¥ <code>Namesrv</code> çš„åœ°å€å’Œå¢åŠ æ¶ˆæ¯æ¥æ”¶åçš„æ‰“å°ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PullConsumer</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException &#123;<br><br>        <span class="hljs-type">DefaultMQPullConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQPullConsumer</span>(<span class="hljs-string">&quot;please_rename_unique_group_name_5&quot;</span>);<br>        <span class="hljs-comment">// ä¿®æ”¹ namesrv çš„åœ°å€</span><br>        consumer.setNamesrvAddr(<span class="hljs-string">&quot;192.168.208.130:9876&quot;</span>);<br>        Set&lt;String&gt; topics = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>        <span class="hljs-comment">//You would better to register topics,It will use in rebalance when starting</span><br>        topics.add(<span class="hljs-string">&quot;TopicTest&quot;</span>);<br>        consumer.setRegisterTopics(topics);<br>        consumer.start();<br><br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executors</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(topics.size(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactory</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Thread <span class="hljs-title function_">newThread</span><span class="hljs-params">(Runnable r)</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r, <span class="hljs-string">&quot;PullConsumerThread&quot;</span>);<br>            &#125;<br>        &#125;);<br>        <span class="hljs-keyword">for</span> (String topic : consumer.getRegisterTopics()) &#123;<br><br>            executors.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">(List&lt;MessageExt&gt; msgs)</span> &#123;<br>                    <span class="hljs-comment">// æ‰“å°æ¥æ”¶åˆ°çš„æ¶ˆæ¯</span><br>                    System.out.println(<span class="hljs-string">&quot;æ¥æ”¶åˆ°æ¶ˆæ¯&quot;</span> + msgs.toString());<br><br>                &#125;<br><br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                            Set&lt;MessageQueue&gt; messageQueues = consumer.fetchMessageQueuesInBalance(topic);<br>                            <span class="hljs-keyword">if</span> (messageQueues == <span class="hljs-literal">null</span> || messageQueues.isEmpty()) &#123;<br>                                Thread.sleep(<span class="hljs-number">1000</span>);<br>                                <span class="hljs-keyword">continue</span>;<br>                            &#125;<br>                            <span class="hljs-type">PullResult</span> <span class="hljs-variable">pullResult</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                            <span class="hljs-keyword">for</span> (MessageQueue messageQueue : messageQueues) &#123;<br>                                <span class="hljs-keyword">try</span> &#123;<br>                                    <span class="hljs-type">long</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.consumeFromOffset(messageQueue);<br>                                    pullResult = consumer.pull(messageQueue, <span class="hljs-string">&quot;*&quot;</span>, offset, <span class="hljs-number">32</span>);<br>                                    <span class="hljs-keyword">switch</span> (pullResult.getPullStatus()) &#123;<br>                                        <span class="hljs-keyword">case</span> FOUND:<br>                                            List&lt;MessageExt&gt; msgs = pullResult.getMsgFoundList();<br><br>                                            <span class="hljs-keyword">if</span> (msgs != <span class="hljs-literal">null</span> &amp;&amp; !msgs.isEmpty()) &#123;<br>                                                <span class="hljs-built_in">this</span>.doSomething(msgs);<br>                                                <span class="hljs-comment">//update offset to broker</span><br>                                                consumer.updateConsumeOffset(messageQueue, pullResult.getNextBeginOffset());<br>                                                <span class="hljs-comment">//print pull tps</span><br>                                                <span class="hljs-built_in">this</span>.incPullTPS(topic, pullResult.getMsgFoundList().size());<br>                                            &#125;<br>                                            <span class="hljs-keyword">break</span>;<br>                                        <span class="hljs-keyword">case</span> OFFSET_ILLEGAL:<br>                                            consumer.updateConsumeOffset(messageQueue, pullResult.getNextBeginOffset());<br>                                            <span class="hljs-keyword">break</span>;<br>                                        <span class="hljs-keyword">case</span> NO_NEW_MSG:<br>                                            Thread.sleep(<span class="hljs-number">1</span>);<br>                                            consumer.updateConsumeOffset(messageQueue, pullResult.getNextBeginOffset());<br>                                            <span class="hljs-keyword">break</span>;<br>                                        <span class="hljs-keyword">case</span> NO_MATCHED_MSG:<br>                                            consumer.updateConsumeOffset(messageQueue, pullResult.getNextBeginOffset());<br>                                            <span class="hljs-keyword">break</span>;<br>                                        <span class="hljs-keyword">default</span>:<br>                                    &#125;<br>                                &#125; <span class="hljs-keyword">catch</span> (RemotingException e) &#123;<br>                                    e.printStackTrace();<br>                                &#125; <span class="hljs-keyword">catch</span> (MQBrokerException e) &#123;<br>                                    e.printStackTrace();<br>                                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                                    e.printStackTrace();<br>                                &#125;<br>                            &#125;<br>                        &#125; <span class="hljs-keyword">catch</span> (MQClientException e) &#123;<br>                            <span class="hljs-comment">//reblance error</span><br>                            e.printStackTrace();<br>                        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                            e.printStackTrace();<br>                        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                            e.printStackTrace();<br>                        &#125;<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">consumeFromOffset</span><span class="hljs-params">(MessageQueue messageQueue)</span> <span class="hljs-keyword">throws</span> MQClientException &#123;<br>                    <span class="hljs-comment">//-1 when started</span><br>                    <span class="hljs-type">long</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> consumer.getOffsetStore().readOffset(messageQueue, ReadOffsetType.READ_FROM_MEMORY);<br>                    <span class="hljs-keyword">if</span> (offset &lt; <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-comment">//query from broker</span><br>                        offset = consumer.getOffsetStore().readOffset(messageQueue, ReadOffsetType.READ_FROM_STORE);<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (offset &lt; <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-comment">//first time start from last offset</span><br>                        offset = consumer.maxOffset(messageQueue);<br>                    &#125;<br>                    <span class="hljs-comment">//make sure</span><br>                    <span class="hljs-keyword">if</span> (offset &lt; <span class="hljs-number">0</span>) &#123;<br>                        offset = <span class="hljs-number">0</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">return</span> offset;<br>                &#125;<br><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">incPullTPS</span><span class="hljs-params">(String topic, <span class="hljs-type">int</span> pullSize)</span> &#123;<br>                    consumer.getDefaultMQPullConsumerImpl().getRebalanceImpl().getmQClientFactory()<br>                            .getConsumerStatsManager().incPullTPS(consumer.getConsumerGroup(), topic, pullSize);<br>                &#125;<br>            &#125;);<br><br>        &#125;<br><span class="hljs-comment">//        executors.shutdown();</span><br><span class="hljs-comment">//        consumer.shutdown();</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="å®‰è£…-RocketMQ5-ç‰ˆæœ¬"><a href="#å®‰è£…-RocketMQ5-ç‰ˆæœ¬" class="headerlink" title="å®‰è£… RocketMQ5 ç‰ˆæœ¬"></a>å®‰è£… RocketMQ5 ç‰ˆæœ¬</h2><p>å’Œ <code>RocketMQ</code> æµç¨‹ä¸€æ ·ï¼Œå½“å¯åŠ¨ <code>broker</code> çš„æ—¶å€™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.IllegalAccessError</span>: class org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.UtilAll</span> (<span class="hljs-keyword">in</span> unnamed module @<span class="hljs-number">0</span>x74582ff6) cannot access class sun<span class="hljs-selector-class">.nio</span><span class="hljs-selector-class">.ch</span><span class="hljs-selector-class">.DirectBuffer</span> (<span class="hljs-keyword">in</span> module java.base) because module java<span class="hljs-selector-class">.base</span> does not export sun<span class="hljs-selector-class">.nio</span><span class="hljs-selector-class">.ch</span> to unnamed module @<span class="hljs-number">0</span>x74582ff6<br>        at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.UtilAll</span><span class="hljs-selector-class">.viewed</span>(UtilAll<span class="hljs-selector-class">.java</span>:<span class="hljs-number">741</span>)<br>        at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.UtilAll</span><span class="hljs-selector-class">.cleanBuffer</span>(UtilAll<span class="hljs-selector-class">.java</span>:<span class="hljs-number">705</span>)<br>        at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.logfile</span><span class="hljs-selector-class">.DefaultMappedFile</span><span class="hljs-selector-class">.cleanup</span>(DefaultMappedFile<span class="hljs-selector-class">.java</span>:<span class="hljs-number">540</span>)<br>        at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.ReferenceResource</span><span class="hljs-selector-class">.release</span>(ReferenceResource<span class="hljs-selector-class">.java</span>:<span class="hljs-number">63</span>)<br>        at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.ReferenceResource</span><span class="hljs-selector-class">.shutdown</span>(ReferenceResource<span class="hljs-selector-class">.java</span>:<span class="hljs-number">47</span>)<br>        at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.logfile</span><span class="hljs-selector-class">.DefaultMappedFile</span><span class="hljs-selector-class">.destroy</span>(DefaultMappedFile<span class="hljs-selector-class">.java</span>:<span class="hljs-number">551</span>)<br>        at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.index</span><span class="hljs-selector-class">.IndexFile</span><span class="hljs-selector-class">.destroy</span>(IndexFile<span class="hljs-selector-class">.java</span>:<span class="hljs-number">110</span>)<br>        at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.index</span><span class="hljs-selector-class">.IndexService</span><span class="hljs-selector-class">.load</span>(IndexService<span class="hljs-selector-class">.java</span>:<span class="hljs-number">72</span>)<br>        at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.store</span><span class="hljs-selector-class">.DefaultMessageStore</span><span class="hljs-selector-class">.load</span>(DefaultMessageStore<span class="hljs-selector-class">.java</span>:<span class="hljs-number">341</span>)<br>        at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.broker</span><span class="hljs-selector-class">.BrokerController</span><span class="hljs-selector-class">.recoverAndInitService</span>(BrokerController<span class="hljs-selector-class">.java</span>:<span class="hljs-number">806</span>)<br>        at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.broker</span><span class="hljs-selector-class">.BrokerController</span><span class="hljs-selector-class">.initialize</span>(BrokerController<span class="hljs-selector-class">.java</span>:<span class="hljs-number">792</span>)<br>        at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.broker</span><span class="hljs-selector-class">.BrokerStartup</span><span class="hljs-selector-class">.createBrokerController</span>(BrokerStartup<span class="hljs-selector-class">.java</span>:<span class="hljs-number">240</span>)<br>        at org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.broker</span><span class="hljs-selector-class">.BrokerStartup</span><span class="hljs-selector-class">.main</span>(BrokerStartup<span class="hljs-selector-class">.java</span>:<span class="hljs-number">50</span>)<br></code></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ˜¯å’Œä½¿ç”¨çš„ <code>jdk</code> ç‰ˆæœ¬é«˜äº 8 çš„åŸå› å¯¼è‡´ï¼Œè¿™é‡Œä½¿ç”¨çš„ <code>jdk</code> ç‰ˆæœ¬æ˜¯ 17</p>
<p>è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼šæ‰“å¼€ <code>bin</code> ä¸‹é¢çš„ <code>runbroker.sh</code></p>
<p>åŸæ¥çš„ <code>runbroker.sh</code> æ˜¯è¿™æ ·</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">if</span> [ $? -eq 0 ]<br><span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$RMQ_NUMA_NODE</span>&quot;</span> ] ; <span class="hljs-keyword">then</span><br>                numactl --interleave=all <span class="hljs-variable">$JAVA</span> <span class="hljs-variable">$&#123;JAVA_OPT&#125;</span> <span class="hljs-variable">$@</span><br>        <span class="hljs-keyword">else</span><br>                numactl --cpunodebind=<span class="hljs-variable">$RMQ_NUMA_NODE</span> --membind=<span class="hljs-variable">$RMQ_NUMA_NODE</span> <span class="hljs-variable">$JAVA</span> <span class="hljs-variable">$&#123;JAVA_OPT&#125;</span> <span class="hljs-variable">$@</span><br>        <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">else</span><br>        <span class="hljs-string">&quot;<span class="hljs-variable">$JAVA</span>&quot;</span> <span class="hljs-variable">$&#123;JAVA_OPT&#125;</span>   <span class="hljs-variable">$@</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure>
<p>ä¿®æ”¹åå˜æˆå¦‚ä¸‹å½¢å¼ï¼Œä¸»è¦æ˜¯åœ¨å¯åŠ¨å‘½ä»¤ä¸­å¢åŠ  <code>--add-exports=java.base/sun.nio.ch=ALL-UNNAMED</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">if</span> [ $? -eq 0 ]<br><span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$RMQ_NUMA_NODE</span>&quot;</span> ] ; <span class="hljs-keyword">then</span><br>                numactl --interleave=all <span class="hljs-variable">$JAVA</span> <span class="hljs-variable">$&#123;JAVA_OPT&#125;</span> --add-exports=java.base/sun.nio.ch=ALL-UNNAMED <span class="hljs-variable">$@</span><br>        <span class="hljs-keyword">else</span><br>                numactl --cpunodebind=<span class="hljs-variable">$RMQ_NUMA_NODE</span> --membind=<span class="hljs-variable">$RMQ_NUMA_NODE</span> <span class="hljs-variable">$JAVA</span> <span class="hljs-variable">$&#123;JAVA_OPT&#125;</span> --add-exports=java.base/sun.nio.ch=ALL-UNNAMED <span class="hljs-variable">$@</span><br>        <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">else</span><br>        <span class="hljs-string">&quot;<span class="hljs-variable">$JAVA</span>&quot;</span> <span class="hljs-variable">$&#123;JAVA_OPT&#125;</span> --add-exports=java.base/sun.nio.ch=ALL-UNNAMED  <span class="hljs-variable">$@</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure>


<h2 id="é€šè¿‡RocketMQ5æºç å¯åŠ¨å•æœºç‰ˆ-Nameserver-å’Œ-Broker"><a href="#é€šè¿‡RocketMQ5æºç å¯åŠ¨å•æœºç‰ˆ-Nameserver-å’Œ-Broker" class="headerlink" title="é€šè¿‡RocketMQ5æºç å¯åŠ¨å•æœºç‰ˆ Nameserver å’Œ Broker"></a>é€šè¿‡RocketMQ5æºç å¯åŠ¨å•æœºç‰ˆ Nameserver å’Œ Broker</h2><p>ä½¿ç”¨çš„ç³»ç»Ÿæ˜¯ <code>win11</code>, å¯åŠ¨å‰éœ€è¦å…ˆç¼–è¯‘ï¼Œå‚è€ƒ</p>
<ol><li><a href="/2023/2adf4cc6108b/index.html" title="ä½¿ç”¨ideaç¼–è¯‘RocketMQ5æºç ">ä½¿ç”¨ideaç¼–è¯‘RocketMQ5æºç </a></li></ol>

<p>æ‰¾ä¸€ä¸ªä½ç½®åˆ›å»ºä¸€ä¸ªç›®å½•ä½œä¸º <code>ROCKETMQ_HOME</code>, æ¯”å¦‚åˆ›å»ºç›®å½• <code>D:\data\rocketmq</code>ï¼Œ ç°åœ¨ <code>ROCKETMQ_HOME=D:\data\rocketmq</code><br>åœ¨ <code>ROCKETMQ_HOME</code> ç›®å½•ä¸‹åˆ›å»º <code>conf</code> å’Œ <code>store</code> ç›®å½•ï¼Œ åœ¨ <code>conf</code> ç›®å½•ä¸‹åˆ›å»º <code>broker.conf</code> æ–‡ä»¶ï¼Œç°åœ¨ <code>ROCKETMQ_HOME</code> ç›®å½•ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">D:\data\rocketmq<br>.<br>â”œâ”€â”€ conf<br>â”‚Â Â  â”œâ”€â”€ broker.conf<br>â””â”€â”€ store<br></code></pre></td></tr></table></figure>
<p><code>broker.conf</code> æ–‡ä»¶å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs conf"># é›†ç¾¤åç§°<br>brokerClusterName = DefaultCluster<br># broker åç§°<br>brokerName = broker-a<br># brokerId=0è¡¨ç¤ºmasterï¼Œå…¶ä»–å€¼è¡¨ç¤º slave<br>brokerId = 0<br># ä¸fileReservedTimeå‚æ•°å‘¼åº”ï¼Œè¡¨æ˜åœ¨å‡ ç‚¹åšæ¶ˆæ¯åˆ é™¤åŠ¨ä½œï¼Œé»˜è®¤å€¼04è¡¨ç¤ºå‡Œæ™¨4ç‚¹<br>deleteWhen = 04<br># åœ¨ç£ç›˜ä¸Šä¿å­˜æ¶ˆæ¯çš„æ—¶é•¿ï¼Œå•ä½æ˜¯å°æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤è¶…æ—¶çš„æ¶ˆæ¯<br>fileReservedTime = 48<br># brokerRoleæœ‰3ç§ï¼šSYNC_MASTERã€ASYNC_MASTERã€SLAVEã€‚å…³é”®è¯SYNCå’ŒASYNCè¡¨ç¤ºMasterå’ŒSlave<br># ä¹‹é—´åŒæ­¥æ¶ˆæ¯çš„æœºåˆ¶ï¼ŒSYNCçš„æ„æ€æ˜¯å½“Slaveå’ŒMasteræ¶ˆæ¯åŒæ­¥å®Œæˆåï¼Œå†è¿”å›å‘é€æˆåŠŸçš„çŠ¶æ€<br>brokerRole = ASYNC_MASTER<br># flushDiskTypeè¡¨ç¤ºåˆ·ç›˜ç­–ç•¥ï¼Œåˆ†ä¸ºSYNC_FLUSHå’ŒASYNC_FLUSHä¸¤ç§ï¼Œ<br># åˆ†åˆ«ä»£è¡¨åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜ã€‚åŒæ­¥åˆ·ç›˜æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯çœŸæ­£å†™å…¥ç£ç›˜åå†è¿”å›æˆåŠŸçŠ¶æ€ï¼›<br># å¼‚æ­¥åˆ·ç›˜æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯å†™å…¥page_cacheåå°±è¿”å›æˆåŠŸçŠ¶æ€<br>flushDiskType = ASYNC_FLUSH<br><br>namesrvAddr = 127.0.0.1:9876<br>storePathRootDir = D:\\data\\rocketmq\\store<br>storePathCommitLog = D:\\data\\rocketmq\\store\\commitlog<br>storePathConsumeQueue = D:\\data\\rocketmq\\store\\consumequeue<br>storePathIndex = D:\\data\\rocketmq\\store\\index<br>storeCheckpoint = D:\\data\\rocketmq\\store\\checkpoint<br></code></pre></td></tr></table></figure>

<h3 id="æºç å¯åŠ¨-nameserver"><a href="#æºç å¯åŠ¨-nameserver" class="headerlink" title="æºç å¯åŠ¨ nameserver"></a>æºç å¯åŠ¨ nameserver</h3><p>æœ€ç»ˆæ˜¯è¦æ‰¾åˆ° <code>rocketmq-namesrv</code> å­æ¨¡å—ä¸‹çš„ <code>org.apache.rocketmq.namesrv.NamesrvStartup</code>ï¼Œ æ‰§è¡Œè¿™ä¸ªç±»çš„ <code>main</code> æ–¹æ³•ï¼Œä¸è¿‡è¿˜éœ€è¦ä¸€äº›é…ç½®<br>åœ¨ <code>idea</code> ä¸­é…ç½® <code>NamesrvStartup</code> å¯åŠ¨ç±»çš„ <code>ROCKETMQ_HOME</code> ç¯å¢ƒå˜é‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º  <code>ROCKETMQ_HOME=D:\\data\\rocketmq</code><br><img src="https://s2.loli.net/2023/12/20/8NsrKgcuALHDBbf.png" alt="Namesrvé…ç½®"></p>
<h3 id="æºç å¯åŠ¨-Broker"><a href="#æºç å¯åŠ¨-Broker" class="headerlink" title="æºç å¯åŠ¨ Broker"></a>æºç å¯åŠ¨ Broker</h3><p>æœ€ç»ˆæ˜¯è¦æ‰¾åˆ° <code>rocketmq-broker</code> å­æ¨¡å—ä¸‹çš„ <code>org.apache.rocketmq.broker.BrokerStartup</code> ç±»çš„ <code>main</code> æ–¹æ³•ï¼ŒåŒæ ·ä¹Ÿæ˜¯éœ€è¦è®¾ç½®ä¸€äº›å‚æ•°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://s2.loli.net/2023/12/20/G3Ql5mBXafALdIt.png" alt="Brokeré…ç½®"></p>
<p><code>program arguments</code>ï¼š<code>-c D:\\data\\rocketmq\\conf\\broker.conf</code><br><code>Environment variables</code>: <code>ROCKETMQ_HOME=D:\\data\\rocketmq</code></p>
<h2 id="é€šè¿‡-RocketMQ4æºç å¯åŠ¨-Nameserver-å’Œ-broker"><a href="#é€šè¿‡-RocketMQ4æºç å¯åŠ¨-Nameserver-å’Œ-broker" class="headerlink" title="é€šè¿‡ RocketMQ4æºç å¯åŠ¨ Nameserver å’Œ broker"></a>é€šè¿‡ RocketMQ4æºç å¯åŠ¨ Nameserver å’Œ broker</h2><p><code>RocketMQ4</code> ç‰ˆæœ¬ä¹Ÿæ˜¯å’Œ 5 ç‰ˆæœ¬ä¸€æ ·éœ€è¦åˆ›å»º <code>ROCKETMQ_HOME</code> ç›®å½•ï¼Œåªæ˜¯åœ¨ <code>conf</code> ç›®å½•ä¸‹ä¼šå¤šä¸¤ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯</p>
<ul>
<li><code>logback_broker.xml</code></li>
<li><code>logback_namesrv.xml</code></li>
</ul>
<p>è¿™ä¸¤ä¸ªæ–‡ä»¶å¯ä»¥ä» <code>rocketmq-distribution</code> æ¨¡å—ä¸‹çš„ <code>conf</code> ç›®å½•ä¸­å¤åˆ¶è¿‡æ¥ï¼Œ ç„¶åå°†è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­çš„ <code>$&#123;user.home&#125;</code> ä¿®æ”¹æˆå¯¹åº”çš„ <code>ROCKETMQ_HOME</code> åœ°å€å°±å¥½äº†ï¼Œåœ¨ä¸Šé¢ç¤ºä¾‹ä¸­ <code>ROCKETMQ_HOME=D:\data\rocketmq</code></p>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQæ•´åˆSpringBoot3</title>
    <url>/2023/1a12a33976fc/index.html</url>
    <content><![CDATA[<p>SpringBootç‰ˆæœ¬ï¼š 3.2.0</p>
<p><a href="https://github.com/apache/rocketmq-spring/wiki">å®˜æ–¹æ–‡æ¡£</a></p>
<blockquote>
<p>SpringBoot3 ç‰ˆæœ¬ç›´æ¥ä½¿ç”¨ç¤ºä¾‹ä¼šæç¤º RocketMQTemplate æ³¨å…¥å¤±è´¥ï¼Œè§£å†³æ–¹å¼åœ¨æ–‡æœ«</p>
</blockquote>
<p>ä½¿ç”¨ <code>idea</code> åˆ›å»º <code>SpringBoot</code> é¡¹ç›®, é¡¹ç›®åç§°æ˜¯ <code>rocket-spring-boot</code></p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><code class="hljs mipsasm">rocket-spring-<span class="hljs-keyword">boot</span><br><span class="hljs-keyword"></span>â”œâ”€src<br>â”‚  â”œâ”€main<br>â”‚  â”‚  â”œâ”€<span class="hljs-keyword">java</span><br><span class="hljs-keyword"></span>â”‚  â”‚  â”‚  â””â”€<span class="hljs-keyword">org</span><br><span class="hljs-keyword"></span>â”‚  â”‚  â”‚      â””â”€example<br>â”‚  â”‚  â”‚          â””â”€rocketmqspringboot<br>â”‚  â”‚  â”‚              â””â”€RocketmqSpringBootApplication.<span class="hljs-keyword">java</span><br><span class="hljs-keyword"></span>â”‚  â”‚  â””â”€resources<br>â”‚  â”‚      â””â”€application.properties<br>â””â”€pom.xml<br></code></pre></td></tr></table></figure>

<p>ä¸»è¦æœ‰ä¸‰ä¸ªæ–‡ä»¶</p>
<ul>
<li><code>pom.xml</code> ä¾èµ–æ–‡ä»¶</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rocketmq-spring-boot<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>rocketmq-spring-boot<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>rocketmq-spring-boot<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- è¿™é‡Œæ·»åŠ  rocketmq-spring-boot-starter ä¾èµ– --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.rocketmq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rocketmq-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>
<ul>
<li><p><code>RocketmqSpringBootApplication.java</code>, é»˜è®¤åªæœ‰ <code>main</code> æ–¹æ³•ï¼Œè¿™é‡ŒæŒ‰ç…§å®˜æ–¹æ–‡æ¡£ç¤ºä¾‹ï¼Œå®ç° <code>CommandLineRunner</code> æ¥å£ï¼Œåœ¨é¡¹ç›®å¯åŠ¨ä¹‹åå°±è¿›è¡Œæ¶ˆæ¯çš„å‘é€</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RocketmqSpringBootApplication</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommandLineRunner</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(RocketmqSpringBootApplication.class, args);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(String... args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//send message synchronously</span><br>        rocketMQTemplate.convertAndSend(<span class="hljs-string">&quot;test-topic-1&quot;</span>, <span class="hljs-string">&quot;Hello, World!&quot;</span>);<br>        <span class="hljs-comment">//send spring message</span><br>        rocketMQTemplate.send(<span class="hljs-string">&quot;test-topic-1&quot;</span>, MessageBuilder.withPayload(<span class="hljs-string">&quot;Hello, World! I&#x27;m from spring message&quot;</span>).build());<br>        <span class="hljs-comment">//send messgae asynchronously</span><br>        rocketMQTemplate.asyncSend(<span class="hljs-string">&quot;test-topic-2&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderPaidEvent</span>(<span class="hljs-string">&quot;T_001&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;88.00&quot;</span>)), <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendCallback</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(SendResult var1)</span> &#123;<br>                System.out.printf(<span class="hljs-string">&quot;async onSucess SendResult=%s %n&quot;</span>, var1);<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onException</span><span class="hljs-params">(Throwable var1)</span> &#123;<br>                System.out.printf(<span class="hljs-string">&quot;async onException Throwable=%s %n&quot;</span>, var1);<br>            &#125;<br><br>        &#125;);<br>        <span class="hljs-comment">//Send messages orderly</span><br>        rocketMQTemplate.syncSendOrderly(<span class="hljs-string">&quot;orderly_topic&quot;</span>, MessageBuilder.withPayload(<span class="hljs-string">&quot;Hello, World&quot;</span>).build(),<span class="hljs-string">&quot;hashkey&quot;</span>);<br><br>        <span class="hljs-comment">//rocketMQTemplate.destroy(); // notes:  once rocketMQTemplate be destroyed, you can not send any message again with this rocketMQTemplate</span><br>    &#125;<br><br>    <span class="hljs-meta">@Data</span><br>    <span class="hljs-meta">@AllArgsConstructor</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderPaidEvent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>        <span class="hljs-keyword">private</span> String orderId;<br><br>        <span class="hljs-keyword">private</span> BigDecimal paidMoney;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>æ·»åŠ  <code>application.properties</code> é…ç½®æ–‡ä»¶</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">rocketmq.name-server</span>=<span class="hljs-string">192.168.119.129:9876</span><br><span class="hljs-attr">rocketmq.producer.group</span>=<span class="hljs-string">my-group</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="è§£å†³-SpringBoot3-ä¸­-RocketMQTemplate-æ³¨å…¥å¤±è´¥é—®é¢˜"><a href="#è§£å†³-SpringBoot3-ä¸­-RocketMQTemplate-æ³¨å…¥å¤±è´¥é—®é¢˜" class="headerlink" title="è§£å†³ SpringBoot3 ä¸­ RocketMQTemplate æ³¨å…¥å¤±è´¥é—®é¢˜"></a>è§£å†³ SpringBoot3 ä¸­ RocketMQTemplate æ³¨å…¥å¤±è´¥é—®é¢˜</h2><p><code>SpringBoot3</code> è‡ªåŠ¨è£…é…æ–‡ä»¶ä¸æ˜¯ä½¿ç”¨ <code>spring.factories</code> æ–‡ä»¶ï¼Œè€Œæ˜¯éœ€è¦åœ¨ <code>META-INF/spring</code> ç›®å½•ä¸‹åˆ›å»º <code>org.springframework.boot.autoconfigure.AutoConfiguration.imports</code> æ–‡ä»¶ï¼Œç„¶åå°†éœ€è¦è‡ªåŠ¨è£…é…çš„ç±»å…¨åæ”¾å…¥è¿™ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªç±»ä¸€è¡Œå³å¯ï¼Œ æ‰€ä»¥éœ€è¦åœ¨ <code>resources</code> ç›®å½•ä¸‹åˆ›å»º <code>META-INF/spring</code> ç›®å½•ï¼Œç„¶ååˆ›å»º <code>org.springframework.boot.autoconfigure.AutoConfiguration.imports</code> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.spring</span><span class="hljs-selector-class">.autoconfigure</span>.RocketMQAutoConfiguration<br></code></pre></td></tr></table></figure>
<p>è‡³æ­¤å°±å¯ä»¥æŒ‰ç…§ç¤ºä¾‹ä½¿ç”¨äº†ï¼Œ ç›´æ¥å¯åŠ¨ <code>SpringBoot</code> é¡¹ç›®å°±å¯ä»¥çœ‹åˆ°æ¶ˆæ¯å‘é€æˆåŠŸçš„æ—¥å¿—äº†</p>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQæ¶ˆæ¯å­˜å‚¨æœºåˆ¶</title>
    <url>/2023/c3210ca00e5d/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<blockquote>
<p>RocketMQç‰ˆæœ¬ï¼š 4.9.7<br>JDKç‰ˆæœ¬ï¼š 17</p>
</blockquote>
<h2 id="å­˜å‚¨ç›¸å…³åŸºç¡€çŸ¥è¯†"><a href="#å­˜å‚¨ç›¸å…³åŸºç¡€çŸ¥è¯†" class="headerlink" title="å­˜å‚¨ç›¸å…³åŸºç¡€çŸ¥è¯†"></a>å­˜å‚¨ç›¸å…³åŸºç¡€çŸ¥è¯†</h2><ul>
<li><code>RocketMQ</code> ä¸»è¦å­˜å‚¨çš„æ–‡ä»¶åŒ…æ‹¬ <code>Comitlog</code> æ–‡ä»¶ã€<code>ConsumeQueue</code>æ–‡ä»¶ã€<code>IndexFile</code>æ–‡ä»¶</li>
<li><code>RocketMQ</code> å°†æ‰€æœ‰ä¸»é¢˜çš„æ¶ˆæ¯å­˜å‚¨åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå³ä¸€ä¸ª <code>Commitlog</code> æ–‡ä»¶ï¼Œ<strong>è¿™ä¹ˆåšçš„ä¼˜åŠ¿æ˜¯ç¡®ä¿æ¶ˆæ¯å‘é€æ—¶é¡ºåºå†™æ–‡ä»¶ï¼Œæé«˜æ¶ˆæ¯å‘é€çš„æ€§èƒ½å’Œååé‡</strong>, <code>Commitlog</code> æ–‡ä»¶å­˜å‚¨ç›®å½•é»˜è®¤ä¸º <code>$&#123;ROCKET_HOME&#125;/store/commitlog</code> ç›®å½•ä¸‹</li>
<li><code>ConsumerQueue</code> åˆ™æ˜¯ä¸ºäº†æé«˜æ¶ˆè´¹è€…çš„æ¶ˆè´¹èƒ½åŠ›è€Œè®¾è®¡çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œ<code>Commitlog</code> åŒ…å«æ‰€æœ‰ <code>Topic</code> çš„æ¶ˆæ¯ï¼Œä½†æ˜¯æ¶ˆè´¹è€…æ˜¯åŸºäºæŸä¸ª <code>Topic</code> çš„è®¢é˜…æœºåˆ¶ï¼Œæ‰€ä»¥å°±å¢åŠ äº† <code>ConsumerQueue</code> æ¶ˆæ¯é˜Ÿåˆ—æ–‡ä»¶ï¼Œæ¶ˆæ¯å­˜å‚¨åœ¨ <code>Commitlog</code> æ–‡ä»¶åï¼Œå°†<strong>å¼‚æ­¥</strong>è½¬å‘åˆ°æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—</li>
<li><code>IndexFile</code> ç´¢å¼•æ–‡ä»¶åˆ™æ˜¯ä¸ºäº†åŠ é€Ÿæ¶ˆæ¯çš„æ£€ç´¢æ€§èƒ½ï¼Œæ ¹æ®æ¶ˆæ¯çš„å±æ€§å¿«é€Ÿä» <code>Commitlog</code> æ–‡ä»¶å¤¹ä¸­æ£€ç´¢æ¶ˆæ¯</li>
<li><code>$&#123;ROCKET_HOME&#125;/store/config</code> ç›®å½•ä¸»è¦å­˜å‚¨è¿è¡ŒæœŸé—´çš„é…ç½®ä¿¡æ¯<ul>
<li><code>consumerFilter.json</code>ï¼šä¸»é¢˜æ¶ˆæ¯è¿‡æ»¤ä¿¡æ¯</li>
<li><code>consumerOffset.json</code>ï¼šé›†ç¾¤æ¶ˆè´¹æ¨¡å¼æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦</li>
<li><code>delayOffset.json</code>ï¼šå»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–è¿›åº¦</li>
<li><code>subscriptionGroup.json</code>ï¼šæ¶ˆæ¯æ¶ˆè´¹ç»„é…ç½®ä¿¡æ¯</li>
<li><code>topics.json</code>: <code>topic</code> é…ç½®å±æ€§</li>
</ul>
</li>
<li><code>$&#123;ROCKET_HOME&#125;/store/abort</code> ï¼š å¦‚æœå­˜åœ¨ <code>abort</code> æ–‡ä»¶è¯´æ˜ <code>Broker</code> éæ­£å¸¸å…³é—­ï¼Œè¯¥æ–‡ä»¶åœ¨é»˜è®¤å¯åŠ¨æ—¶åˆ›å»ºï¼Œæ­£å¸¸é€€å‡ºä¹‹å‰åˆ é™¤</li>
<li><code>$&#123;ROCKET_HOME&#125;/store/checkpoint</code>: æ–‡ä»¶æ£€æµ‹ç‚¹ï¼Œå­˜å‚¨<code>commitlog</code>æ–‡ä»¶æœ€åä¸€æ¬¡åˆ·ç›˜æ—¶é—´æˆ³ã€<code>consumequeue</code>æœ€åä¸€æ¬¡åˆ·ç›˜æ—¶é—´ã€<code>index</code>ç´¢å¼•æ–‡ä»¶æœ€åä¸€æ¬¡åˆ·ç›˜æ—¶é—´æˆ³</li>
<li>å­˜å‚¨ç›®å½•ç›¸å…³çš„å‚æ•°å¯ä»¥é€šè¿‡ <code>broker.conf</code> è¿›è¡Œé…ç½®ï¼Œç¤ºä¾‹å¦‚ä¸‹</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs conf">storePathRootDir = E:\\config\\rocketmq\\store<br>storePathCommitLog = E:\\config\\rocketmq\\store\\commitlog<br>storePathConsumeQueue = E:\\config\\rocketmq\\store\\consumequeue<br>storePathIndex = E:\\config\\rocketmq\\store\\index<br>storeCheckpoint = E:\\config\\rocketmq\\store\\checkpoint<br></code></pre></td></tr></table></figure>

<p><strong>äº‹åŠ¡çŠ¶æ€æœåŠ¡</strong><br>å­˜å‚¨æ¯æ¡æ¶ˆæ¯çš„äº‹åŠ¡çŠ¶æ€</p>
<p><strong>å®šæ—¶æ¶ˆæ¯æœåŠ¡</strong><br>æ¯ä¸€ä¸ªå»¶è¿Ÿçº§åˆ«å¯¹åº”ä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œå­˜å‚¨å»¶è¿Ÿé˜Ÿåˆ—çš„æ¶ˆæ¯æ‹‰å–è¿›åº¦</p>
<h2 id="Commitlog-æ–‡ä»¶"><a href="#Commitlog-æ–‡ä»¶" class="headerlink" title="Commitlog æ–‡ä»¶"></a>Commitlog æ–‡ä»¶</h2><p><code>Commitlog</code> ç›®å½•ä¸‹çš„æ–‡ä»¶ä¸»è¦ç”¨äºå­˜å‚¨æ¶ˆæ¯ï¼Œæ¯ä¸€æ¡ä¿¡æ¯çš„é•¿åº¦éƒ½ä¸ç›¸åŒï¼Œä½†æ˜¯æ¯ä¸€æ¡æ¶ˆæ¯çš„é•¿åº¦éƒ½ä¼šä½¿ç”¨ 4 ä¸ªå­—èŠ‚å­˜å‚¨ä¸‹æ¥ï¼Œé€»è¾‘å›¾å¦‚ä¸‹</p>
<pre class="mermaid">graph LR
    subgraph A["TopicA:Msg1"]
        A1["TotalSize(4å­—èŠ‚å­˜å‚¨)"]
        A2["æ¶ˆæ¯å†…å®¹"]
    end
    subgraph B["TopicB:Msg2"]
        B1["TotalSize(4å­—èŠ‚å­˜å‚¨)"]
        B2["æ¶ˆæ¯å†…å®¹"]
    end
    subgraph C["TopicA:Msg3"]
        C1["TotalSize(4å­—èŠ‚å­˜å‚¨)"]
        C2["æ¶ˆæ¯å†…å®¹"]
    end
    A-->B-->C</pre>

<h2 id="ConsumerQueue-æ–‡ä»¶"><a href="#ConsumerQueue-æ–‡ä»¶" class="headerlink" title="ConsumerQueue æ–‡ä»¶"></a>ConsumerQueue æ–‡ä»¶</h2><ul>
<li><code>Commitlog</code> æ–‡ä»¶æ˜¯æ­¤æ—¶çš„æ‰€æœ‰æ¶ˆæ¯çš„å†…å®¹ï¼Œ<code>ConsumerQueue</code> æ–‡ä»¶å¯ä»¥è®¤ä¸ºæ˜¯æŒ‰ç…§ <code>Topic</code> å¯¹ <code>Commitlog</code> è¿›è¡Œåˆ†ç±»å’Œç´¢å¼•(å› ä¸º <code>ConsumerQueue</code> å¹¶ä¸ä¼šå­˜å‚¨å®Œæ•´çš„æ¶ˆæ¯å†…å®¹ï¼Œåªæ˜¯ä¼šå­˜å‚¨æ¶ˆæ¯åœ¨ <code>Commitlog</code> æ–‡ä»¶ä¸­çš„åç§»é‡ï¼Œæƒ³è¦è·å–å®Œæ•´çš„æ¶ˆæ¯è¿˜æ˜¯éœ€è¦åˆ° <code>Commitlog</code>æ–‡ä»¶ä¸­è·å–)</li>
</ul>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202312252303487.webp" alt="ConsumerQueueæ–‡ä»¶"></p>
<ul>
<li><code>ConsumerQueue</code> æ–‡ä»¶å­˜å‚¨çš„å†…å®¹ä¹Ÿæ˜¯ç»“æ„æ€§çš„ï¼Œè¯¥æ–‡ä»¶ä¸­çš„æ¯ä¸€æ¡æ•°æ®ç§°ä¸º <code>ConsumerQueue</code> æ¡ç›®ï¼Œæ¯ä¸€ä¸ª <code>ConsumerQueue</code> æ¡ç›®çš„ç»“æ„å¦‚ä¸‹<br><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202312252308083.webp" alt="ConsumerQueueæ¡ç›®ç»“æ„"></li>
<li>å•ä¸ª <code>ConsumerQueue</code> æ–‡ä»¶é»˜è®¤åŒ…å« 30ä¸‡ä¸ªæ¡ç›®ï¼Œå•ä¸ªæ–‡ä»¶çš„å¤§å°å°±æ˜¯ 30w * 20å­—èŠ‚</li>
<li>å› ä¸º <code>ConsumerQueue</code> æ¡ç›®å¤§å°æ˜¯å›ºå®šçš„(8+4+8 å­—èŠ‚)ï¼Œæ‰€ä»¥å¯ä»¥å°† <code>ConsumerQueue</code> æ–‡ä»¶çœ‹æˆæ˜¯ <code>ConsumerQueue</code> æ¡ç›®çš„æ•°ç»„ï¼Œä¸‹æ ‡å°±æ˜¯ <code>ConsumerQueue</code> çš„é€»è¾‘åç§»é‡ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¿›åº¦å­˜å‚¨çš„åç§»é‡ä¹Ÿæ˜¯é€»è¾‘åç§»é‡</li>
<li><code>ConsumerQueue</code> æ–‡ä»¶æ–°å¢çš„æ—¶æœºæ˜¯å½“æ¶ˆæ¯åˆ°è¾¾ <code>Commitlog</code> æ–‡ä»¶åï¼Œä¼šæœ‰ä¸“é—¨å‘çº¿ç¨‹äº§ç”Ÿæ¶ˆæ¯è½¬å‘ä»»åŠ¡ï¼Œæ­¤æ—¶ä¼šæ·»åŠ æ•°æ®åˆ° <code>ConsumerQueue</code> ä¸­</li>
</ul>
<h2 id="Index-ç´¢å¼•æ–‡ä»¶"><a href="#Index-ç´¢å¼•æ–‡ä»¶" class="headerlink" title="Index ç´¢å¼•æ–‡ä»¶"></a>Index ç´¢å¼•æ–‡ä»¶</h2><p>ç´¢å¼•æ–‡ä»¶çš„ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿æ ¹æ® <code>MessageKey</code> æ¥æŸ¥è¯¢æ¶ˆæ¯ï¼Œçœ‹ä¸€ä¸‹ä¸‹é¢çš„ <code>Producer</code> å‘é€æ¶ˆæ¯çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException, InterruptedException &#123;<br>    <span class="hljs-type">DefaultMQProducer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQProducer</span>(<span class="hljs-string">&quot;ProducerGroupName&quot;</span>);<br>    producer.setNamesrvAddr(<span class="hljs-string">&quot;127.0.0.1:9876&quot;</span>);<br>    producer.start();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            &#123;<br>                <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(<span class="hljs-string">&quot;TopicTest&quot;</span>,<br>                        <span class="hljs-string">&quot;TagA&quot;</span>,<br>                        <span class="hljs-string">&quot;OrderID188&quot;</span>, <span class="hljs-comment">// è¿™ä¸ªå‚æ•°å°±æ˜¯ keys</span><br>                        <span class="hljs-string">&quot;Hello world&quot;</span>.getBytes(RemotingHelper.DEFAULT_CHARSET));<br>                <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> producer.send(msg);<br>                System.out.printf(<span class="hljs-string">&quot;%s%n&quot;</span>, sendResult);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>    producer.shutdown();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ä¸‹é¢æˆªå›¾å°±æ˜¯åœ¨ <code>RokcetMQ-dashboard</code> ä¸­æŒ‰ç…§ <code>Keys</code> æ¥æŸ¥è¯¢æ¶ˆæ¯<br><img src="https://s2.loli.net/2023/12/26/CjOyVWS38BvEmhL.png" alt="æ ¹æ®KeyæŸ¥è¯¢æ¶ˆæ¯"></p>
<h3 id="ç´¢å¼•æ–‡ä»¶ç»“æ„"><a href="#ç´¢å¼•æ–‡ä»¶ç»“æ„" class="headerlink" title="ç´¢å¼•æ–‡ä»¶ç»“æ„"></a>ç´¢å¼•æ–‡ä»¶ç»“æ„</h3><p>æ¥ä¸‹æ¥å°±çœ‹ä¸€ä¸‹ç´¢å¼•æ–‡ä»¶ç»“æœï¼Œä¸‹å›¾æ¥è‡ª ã€ŠRocketMQæŠ€æœ¯å†…å¹•:RocketMQæ¶æ„è®¾è®¡ä¸å®ç°åŸç†ã€‹ ä¸€ä¹¦<br><img src="https://s2.loli.net/2023/12/26/ign4Iwm8Lv3ftlZ.png" alt="IndexFileç»“æ„"></p>
<p>æ•´ä½“çœ‹ <code>Index</code> ç´¢å¼•æ–‡ä»¶åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†</p>
<ul>
<li><code>head</code>ï¼š æ–‡ä»¶å¤´</li>
<li><code>slot</code>ï¼š å“ˆå¸Œæ§½</li>
<li><code>index content</code>ï¼š ç´¢å¼•å†…å®¹</li>
</ul>
<h4 id="æ–‡ä»¶å¤´-40å­—èŠ‚"><a href="#æ–‡ä»¶å¤´-40å­—èŠ‚" class="headerlink" title="æ–‡ä»¶å¤´(40å­—èŠ‚)"></a>æ–‡ä»¶å¤´(40å­—èŠ‚)</h4><p>æ–‡ä»¶å¤´ä¸€å…±åŒ…å« 40 å­—èŠ‚ï¼Œä»å‰å¾€åä»£è¡¨çš„å«ä¹‰å¦‚ä¸‹</p>
<ol>
<li>å¼€å§‹æ—¶é—´( <code>beginTimestamp</code> ), å ç”¨ 8 å­—èŠ‚</li>
<li>ç»“æŸæ—¶é—´( <code>endTimestamp</code> ), å ç”¨ 8 å­—èŠ‚</li>
<li>æ¶ˆæ¯æœ€å°ç‰©ç†åç§»é‡( <code>beginPhyoffset</code> ), å ç”¨ 8 å­—èŠ‚ï¼Œæœ€å°ç‰©ç†åç§»é‡åœ¨å¾€ç´¢å¼•æ–‡ä»¶æ·»åŠ ç¬¬ä¸€ä¸ªæ¡ç›®çš„æ—¶å€™å°±å¯ä»¥ç¡®å®šï¼Œå› ä¸ºæ¶ˆæ¯æ˜¯é¡ºåºæ·»åŠ çš„ï¼Œç¬¬ä¸€ä¸ªæ·»åŠ çš„æ¶ˆæ¯å°±æ˜¯ç‰©ç†åç§»é‡æœ€å°çš„</li>
<li>æ¶ˆæ¯æœ€å¤§ç‰©ç†åç§»é‡( <code>endPhyoffset</code> ), å ç”¨ 8 å­—èŠ‚ï¼Œæœ€å¤§ç‰©ç†åç§»é‡æ˜¯éšç€å¾€ç´¢å¼•æ–‡ä»¶ä¸æ–­æ·»åŠ æ¡ç›®è€Œé€’å¢çš„</li>
<li>æœ‰æ•ˆ <code>hash slot count</code>, å ç”¨ 4 å­—èŠ‚ï¼Œæœ€åçš„æƒ…å†µä¸‹æœ‰æ•ˆçš„å“ˆå¸Œæ§½åªæœ‰ä¸€ä¸ªï¼ˆæ‰€æœ‰æ¶ˆæ¯çš„ <code>Keys</code> å­—æ®µéƒ½ç›¸åŒï¼Œå¯¼è‡´ <code>key</code> çš„ <code>hash</code> å†²çªï¼‰ï¼Œæœ€ç†æƒ³çš„æƒ…å†µä¸‹æ¯ä¸ª ç´¢å¼•æ–‡ä»¶å¯ä»¥åŒ…å« 500w ä¸ª <code>hash slot</code></li>
<li><code>index</code> ç´¢å¼•æ•°é‡ï¼Œå ç”¨ 4 å­—èŠ‚ï¼Œé»˜è®¤ä¸€ä¸ªç´¢å¼•æ–‡ä»¶å¯ä»¥åŒ…å« 2000ä¸‡ä¸ª <code>index content</code>, <code>index count</code> å°±æ˜¯è®°å½•çš„å·²ç»ä½¿ç”¨çš„ <code>index content</code> æ•°é‡</li>
</ol>
<h4 id="slot"><a href="#slot" class="headerlink" title="slot"></a>slot</h4><ul>
<li><code>slot</code> åŒºåŸŸé»˜è®¤å¯ä»¥å­˜æ”¾ 500ä¸‡ä¸ªï¼Œå¯ä»¥è®¤ä¸ºæ˜¯é•¿åº¦ä¸º 500w çš„æ•°ç»„</li>
<li><code>slot</code> ä¸­å­˜æ”¾çš„æ˜¯å½“å‰ <code>index content</code> çš„ä½ç½®ï¼Œè¿™ä¸ªä½ç½®æ˜¯é€»è¾‘åç§»é‡ï¼Œä¸ºä»€ä¹ˆå¯ä»¥è®°å½•é€»è¾‘åç§»é‡å‘¢ï¼Ÿå…ˆç»™å‡ºè®¡ç®—å…¬å¼å†è¿›è¡Œè¯´æ˜</li>
</ul>
<figure class="highlight axapta"><table><tr><td class="code"><pre><code class="hljs axapta">å½“å‰ slot è®°å½•çš„ <span class="hljs-keyword">index</span> å®é™…ä½ç½® = å¤´éƒ¨å­—èŠ‚é•¿åº¦(<span class="hljs-number">40</span>) + (hash slotæ•°é‡(é»˜è®¤<span class="hljs-number">500</span>w)) * å•ä¸ªhash slotå¤§å°(é»˜è®¤<span class="hljs-number">4</span>å­—èŠ‚) + å½“å‰slotå­˜å‚¨çš„<span class="hljs-keyword">index</span>æ•°é‡ * å•ä¸ª<span class="hljs-keyword">index</span> contentå¤§å°(é»˜è®¤<span class="hljs-number">20</span>å­—èŠ‚)<br></code></pre></td></tr></table></figure>
<p>ä¸Šé¢å…¬å¼å¯ä»¥æˆç«‹çš„åŸå› å°±æ˜¯ <strong>å¤´éƒ¨é•¿åº¦å›ºå®š</strong>ï¼Œ <strong>slotåŒºåŸŸæ€»é•¿åº¦ä¹Ÿå›ºå®š</strong>ï¼Œ<strong>æ¯ä¸€ä¸ªindex contenté•¿åº¦å›ºå®š</strong>ï¼Œæ‰€ä»¥å°±å¯ä»¥æ ¹æ®ç´¢å¼•ä¸‹æ ‡æ¥è®¡ç®—å®é™…ä½ç½®</p>
<h5 id="å¦‚ä½•æ ¹æ®keyç¡®å®šslotä½ç½®"><a href="#å¦‚ä½•æ ¹æ®keyç¡®å®šslotä½ç½®" class="headerlink" title="å¦‚ä½•æ ¹æ®keyç¡®å®šslotä½ç½®"></a>å¦‚ä½•æ ¹æ®keyç¡®å®šslotä½ç½®</h5><ol>
<li>æ ¹æ® <code>Message</code> ä¸­çš„ <code>Keys</code> è®¡ç®— <code>hashcode</code></li>
<li>ä½¿ç”¨ <code>hashcode</code> å¯¹ <code>slot</code> æ€»æ•°å–æ¨¡</li>
</ol>
<h5 id="keys-hash-å†²çªå¦‚ä½•è§£å†³"><a href="#keys-hash-å†²çªå¦‚ä½•è§£å†³" class="headerlink" title="keys hash å†²çªå¦‚ä½•è§£å†³"></a>keys hash å†²çªå¦‚ä½•è§£å†³</h5><p>åœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µä¸‹éƒ½å¯èƒ½å­˜åœ¨ <code>keys</code> çš„å“ˆå¸Œå†²çª</p>
<ol>
<li>ä¸åŒæ¶ˆæ¯çš„ <code>Keys</code> å­—æ®µç›¸åŒï¼Œæ­¤æ—¶è®¡ç®—å‡ºæ¥çš„ <code>hashcode</code> ç›¸åŒ</li>
<li>æ ¹æ® <code>keys</code> è®¡ç®—å‡ºæ¥çš„ <code>hashcode</code> ä¸åŒï¼Œä½†æ˜¯å¯¹ <code>slot</code> é•¿åº¦å–æ¨¡åå¾—å‡ºçš„ç»“æœç›¸åŒ</li>
</ol>
<p>å½“å‡ºç°è¿™ç§å†²çªæ—¶ï¼Œ<code>slot</code> ä¸­å­˜æ”¾çš„æ˜¯æœ€åä¸€æ¬¡ <code>index content</code> çš„ä½ç½®ï¼Ÿä¹Ÿå°±æ˜¯è¯´å­˜æ”¾çš„ä¹‹å‰çš„ <code>index content</code> ä½ç½®è¢«è¦†ç›–äº†ï¼Œä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·å‘¢ï¼Ÿè¿™æ˜¯å› ä¸º <code>index content</code> ä¸­ä¼šæœ‰å­—æ®µæ¥å­˜å‚¨ä¹‹å‰çš„ <code>index content</code> çš„ä½ç½®</p>
<h4 id="index-content-ä¸€å…±20å­—èŠ‚"><a href="#index-content-ä¸€å…±20å­—èŠ‚" class="headerlink" title="index content (ä¸€å…±20å­—èŠ‚)"></a>index content (ä¸€å…±20å­—èŠ‚)</h4><ul>
<li><code>hashcode</code> å€¼ï¼š 4å­—èŠ‚</li>
<li>æ¶ˆæ¯çš„ç‰©ç†åœ°å€(<code>phyoffset</code>): 8å­—èŠ‚ï¼Œæ¶ˆæ¯çš„ç‰©ç†åœ°å€æŒ‡å‘çš„æ˜¯ <code>Commitlog</code> æ–‡ä»¶ä¸­çš„åç§»é‡</li>
<li>å½“å‰æ¶ˆæ¯ä¸æœ€æ—©æ¶ˆæ¯çš„æ—¶é—´å·®ï¼ˆ<code>timedif</code>ï¼‰: 4å­—èŠ‚ï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†æ—¶é—´çš„èŒƒå›´æŸ¥è¯¢</li>
<li>ä¸Šä¸€æ¡ <code>index content</code> çš„ä½ç½®ï¼ˆ<code>pre index no</code>ï¼‰:4å­—èŠ‚ï¼Œå‰é¢è®² <code>slot</code> å†²çªæ—¶ï¼Œ<code>slot</code> ä¸­è®°å½•çš„æ˜¯æœ€åä¸€ä¸ª <code>index content</code> çš„ä½ç½®ï¼Œç„¶åå†ç”±è¿™ä¸ª <code>index content</code> æŒ‡å‘ä¹‹å‰é‚£ä¸ª <code>index conent</code></li>
</ul>
<p>ä¸‹é¢ä»¥ä¸¤æ¬¡å¾€ <code>Index</code> ç´¢å¼•æ–‡ä»¶æ·»åŠ å†…å®¹ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹å½“ <code>key</code> ç›¸åŒæ—¶æ˜¯å¦‚ä½•å¤„ç†å†²çªçš„<br><strong>ç¬¬ä¸€æ¬¡</strong><br>å‡è®¾æ ¹æ® <code>keys</code> è®¡ç®—å‡ºæ¥çš„ <code>slot</code> ä¸‹æ ‡æ˜¯5ï¼Œå› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡æ·»åŠ ï¼Œæ‰€ä»¥ <code>index content</code> å°±æ”¾åœ¨ç¬¬ä¸€ä¸ªä½ç½®(<code>index content</code> å’Œ <code>slot</code> ä¸åŒï¼Œ<code>slot</code> éœ€è¦è®¡ç®—ä¸‹æ ‡ä½ç½®ï¼Œ<code>index content</code> ç›´æ¥ä¾æ¬¡é€’å¢å­˜æ”¾)ï¼Œæ­¤æ—¶ç»“æ„å›¾å¦‚ä¸‹æ‰€ç¤º<br><img src="https://s2.loli.net/2023/12/26/mWP2QeVNpgoGBEy.png" alt="ç¬¬ä¸€æ¬¡æ·»åŠ ç´¢å¼•æ–‡ä»¶å†…å®¹"></p>
<p><strong>ç¬¬äºŒæ¬¡</strong><br>ç¬¬äºŒä¸ªå‘é€ <code>Message</code> æ—¶è¿˜æ˜¯ä½¿ç”¨ç›¸åŒçš„ <code>keys</code>, é‚£ä¹ˆè®¡ç®—å‡ºæ¥çš„ <code>slot</code> ä½ç½®è‚¯å®šè¿˜æ˜¯ 5<br><img src="https://s2.loli.net/2023/12/26/jNigTfp7ECZVosS.png" alt="ç¬¬äºŒæ¬¡å‘é€"><br>é¦–å…ˆï¼Œ<code>slot</code> åŒºåŸŸä¸­ä¸‹æ ‡ä¸º5çš„ä½ç½®å­˜å‚¨çš„å†…å®¹æ”¹å˜äº†ï¼Œå˜æˆå½“å‰æ–°å¢çš„ <code>index content</code> çš„é€»è¾‘åç§»é‡(å³ <code>index content</code> åŒºåŸŸçš„ä¸‹æ ‡)<br>å…¶æ¬¡ï¼Œå½“å‰ <code>index content</code> ä¸­çš„ <code>pre index no</code> åŒºåŸŸä¸­ä¼šå­˜å‚¨ä¹‹å‰çš„ <code>index content</code> çš„é€»è¾‘åç§»é‡(å› ä¸ºæœ‰å“ˆå¸Œå†²çªäº†ï¼Œå¦‚æœæ²¡æœ‰å†²çªå°±ä¸ç”¨å­˜å‚¨)</p>
<h2 id="MappedFile-å’Œ-MappedFileQueue"><a href="#MappedFile-å’Œ-MappedFileQueue" class="headerlink" title="MappedFile å’Œ MappedFileQueue"></a>MappedFile å’Œ MappedFileQueue</h2><ul>
<li><code>Commitlog</code> æ–‡ä»¶å­˜å‚¨ç›®å½•ä¸º <code>$&#123;ROCKET_HOME&#125;/store/commitlog</code>ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶é»˜è®¤éƒ½æ˜¯ 1G, å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202312252113697.webp" alt="Commitlogæ–‡ä»¶"></li>
<li><code>Commitlog</code> æ–‡ä»¶åå°±æ˜¯æ–‡ä»¶ä¸­ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ç‰©ç†é‡åç§»é‡</li>
<li><code>MappedFile</code> å°±æ˜¯å¯¹åº”è¿™ä¸€ä¸ªä¸ªçš„ <code>Commitlog</code> æ–‡ä»¶ï¼Œ<strong>æ˜¯å†…å­˜æ˜ å°„æ–‡ä»¶çš„å…·ä½“å®ç°</strong></li>
<li><code>MappedFileQueue</code> æ˜¯ <code>MappedFile</code>çš„ç®¡ç†å®¹å™¨ï¼Œå¯¹åº” <code>$&#123;ROCKET_HOME&#125;/store/commitlog</code> æ–‡ä»¶å¤¹</li>
</ul>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨ideaç¼–è¯‘RocketMQ5æºç </title>
    <url>/2023/2adf4cc6108b/index.html</url>
    <content><![CDATA[<blockquote>
<p>Jdkç‰ˆæœ¬ï¼š 17<br>RocketMQç‰ˆæœ¬ï¼š 5.1.4<br>ideaç‰ˆæœ¬ï¼š 2023.2</p>
</blockquote>
<p>å‚è€ƒ <ol><li><a href="/2023/49fb249febb6/index.html" title="RocketMQå®‰è£…ä½¿ç”¨å’ŒåŸºæœ¬æ¦‚å¿µ">RocketMQå®‰è£…ä½¿ç”¨å’ŒåŸºæœ¬æ¦‚å¿µ</a></li></ol></p>
<p>ç›´æ¥åœ¨ <code>idea</code> å¯¼å…¥ <code>RocketMQ5</code> æºç å¹¶ç¼–è¯‘ä¼šç±»ä¼¼ä¸‹é¢çš„é”™è¯¯</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">java: ç¨‹åºåŒ…sun<span class="hljs-selector-class">.nio</span><span class="hljs-selector-class">.ch</span> ä¸å­˜åœ¨<br></code></pre></td></tr></table></figure>

<p>è¿™æ˜¯å› ä¸ºä½¿ç”¨ <code>jdk8</code> ä»¥ä¸Šçš„ç‰ˆæœ¬è¿›è¡Œç¼–è¯‘ï¼Œ8 ä»¥ä¸Šçš„ <code>jdk</code> å¼€å§‹ä½¿ç”¨æ¨¡å—åŒ–ï¼Œæ‰€ä»¥æœ‰äº›æ¨¡å—éœ€è¦è‡ªå·±å¯¼å…¥ï¼Œè§£å†³æ–¹å¼å¦‚ä¸‹</p>
<ul>
<li>æ‰“å¼€ <code>settings -&gt; Build,Execution,Deployment -&gt; Compile -&gt; java compile</code></li>
</ul>
<p><img src="https://s2.loli.net/2023/12/19/9z8Tkuhes7FR1wy.png" alt="æ·»åŠ ç¼–è¯‘å‚æ•°"></p>
<p>ç»™ <code>rocketmq-common</code> å’Œ <code>rocketmq-store</code> æ¨¡å—æ·»åŠ å¦‚ä¸‹å‚æ•°</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><code class="hljs csharp">--<span class="hljs-keyword">add</span>-exports java.<span class="hljs-keyword">base</span>/sun.nio.ch=ALL-UNNAMED<br></code></pre></td></tr></table></figure>

<p>ç»™ <code>rocketmq-test</code> æ¨¡å—æ·»åŠ å¦‚ä¸‹å‚æ•°</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><code class="hljs csharp">--<span class="hljs-keyword">add</span>-exports java.<span class="hljs-keyword">base</span>/sun.util.locale=ALL-UNNAMED<br></code></pre></td></tr></table></figure>
<p>ç„¶åé‡æ–°ç¼–è¯‘å³å¯</p>
<p>Tips: ä¸ºä»€ä¹ˆè¦å»æ‰ <code>use --release</code> çš„é€‰é¡¹å‘¢ï¼Ÿ<br>ä½¿ç”¨ <code>javac --help</code> çœ‹çœ‹æ”¯æŒçš„å‚æ•°è¯´æ˜</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">javac --<span class="hljs-built_in">help</span><br>--release &lt;release&gt;<br>    Compile <span class="hljs-keyword">for</span> a specific VM version. Supported targets: 6, 7, 8, 9, 10, 11<br>-<span class="hljs-built_in">source</span> &lt;release&gt;<br>    Provide <span class="hljs-built_in">source</span> compatibility with specified release<br>-target &lt;release&gt;            Generate class files <span class="hljs-keyword">for</span> specific VM version<br></code></pre></td></tr></table></figure>
<p>æ‰€ä»¥ <code>--release</code> ä¸»è¦æ˜¯ä¸ºäº†å‘ä¸‹å…¼å®¹ï¼Œæ¯”å¦‚ä½¿ç”¨ <code>jdk13</code> å¼€å‘ï¼Œä½†æ˜¯è¿è¡Œç¯å¢ƒä½¿ç”¨çš„æ˜¯ <code>jdk11</code>, ä½¿ç”¨ <code>--release</code> ç¼–è¯‘å°±ä¸ä¼šæœ‰é—®é¢˜</p>
<p>ä¸è¿‡ <code>--release</code> å’Œ æ·»åŠ çš„ ç¼–è¯‘å‚æ•°æœ‰å†²çªï¼Œæ‰€ä»¥å°±å…ˆå–æ¶ˆäº† <code>--release</code> é€‰é¡¹</p>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBootä¸­ä½¿ç”¨Redis</title>
    <url>/2023/5ef02c37afab/index.html</url>
    <content><![CDATA[<p>ç‰ˆæœ¬è¯´æ˜ï¼š</p>
<ol>
<li>SpringBoot 3.x</li>
</ol>
<h2 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h2><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- springboot ç‰ˆæœ¬ --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><span class="hljs-comment">&lt;!-- å¼•å…¥redisä¾èµ– --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="redis-é…ç½®"><a href="#redis-é…ç½®" class="headerlink" title="redis é…ç½®"></a>redis é…ç½®</h2><ol>
<li>ä¸‹é¢ <code>redis</code> é…ç½®çš„å‰ç¼€éƒ½æ˜¯ <code>spring.data.redis</code>, å¦‚æœä½¿ç”¨çš„æ˜¯ <code>SpringBoot2.x</code> ç‰ˆæœ¬ï¼Œå‰ç¼€æ˜¯ <code>spring.redis</code><figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">#é»˜è®¤æ˜¯0å·åº“</span><br><span class="hljs-attr">spring.data.redis.database</span>=<span class="hljs-string">3</span><br><span class="hljs-comment"># RedisæœåŠ¡å™¨åœ°å€</span><br><span class="hljs-attr">spring.data.redis.host</span>=<span class="hljs-string">192.168.0.236</span><br><span class="hljs-comment"># RedisæœåŠ¡å™¨è¿æ¥ç«¯å£</span><br><span class="hljs-attr">spring.data.redis.port</span>=<span class="hljs-string">6379</span><br><span class="hljs-attr">spring.data.redis.username</span>=<span class="hljs-string">default</span><br><span class="hljs-comment"># RedisæœåŠ¡å™¨è¿æ¥å¯†ç ,é»˜è®¤ä¸ºç©º</span><br><span class="hljs-attr">spring.data.redis.password</span>=<span class="hljs-string">123456</span><br><span class="hljs-comment"># è¿æ¥æ± æœ€å¤§è¿æ¥æ•°</span><br><span class="hljs-attr">spring.data.redis.lettuce.pool.max-active</span>=<span class="hljs-string">10</span><br><span class="hljs-comment"># è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´,é»˜è®¤-1è¡¨ç¤ºæ²¡æœ‰é™åˆ¶</span><br><span class="hljs-attr">spring.data.redis.lettuce.pool.max-wait</span>=<span class="hljs-string">-1</span><br><span class="hljs-comment"># è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥</span><br><span class="hljs-attr">spring.data.redis.lettuce.pool.max-idle</span>=<span class="hljs-string">10</span><br><span class="hljs-comment"># è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥,é»˜è®¤æ˜¯0</span><br><span class="hljs-attr">spring.data.redis.lettuce.pool.min-idle</span>=<span class="hljs-string">0</span><br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="ç¼–å†™æµ‹è¯•ç±»"><a href="#ç¼–å†™æµ‹è¯•ç±»" class="headerlink" title="ç¼–å†™æµ‹è¯•ç±»"></a>ç¼–å†™æµ‹è¯•ç±»</h2><ol><li><a href="/2023/9cd70dc15320/index.html" title="SpringBootç¼–å†™æµ‹è¯•ç±»">SpringBootç¼–å†™æµ‹è¯•ç±»</a></li></ol>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest(classes = TestApplication.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestRedis</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testRedis</span><span class="hljs-params">()</span>&#123;<br>        redisTemplate.opsForValue().set(<span class="hljs-string">&quot;key1&quot;</span>, <span class="hljs-string">&quot;value1&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(<span class="hljs-string">&quot;key1&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;è·å–redis key1 çš„ç»“æœ:&quot;</span> + o);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ä½¿ç”¨ <code>redis</code> å®¢æˆ·ç«¯çœ‹ä¸€ä¸‹è¿™ä¸ª <code>key</code> å’Œ <code>value</code></p>
<figure class="highlight wren"><table><tr><td class="code"><pre><code class="hljs wren">[<span class="hljs-variable">db3</span>] <span class="hljs-operator">&gt;</span> <span class="hljs-variable">get</span> <span class="hljs-title function_">key1</span><br>(<span class="hljs-variable">nil</span>)<br><br>[<span class="hljs-variable">db3</span>] <span class="hljs-operator">&gt;</span> <span class="hljs-variable">keys</span> <span class="hljs-operator">*</span><span class="hljs-variable">key1</span><span class="hljs-operator">*</span><br><span class="hljs-number">1</span>) <span class="hljs-string">&quot;\xac\xed<span class="hljs-char escape_">\x00</span><span class="hljs-char escape_">\x05</span>t<span class="hljs-char escape_">\x00</span><span class="hljs-char escape_">\x04</span>key1&quot;</span><br><br>[<span class="hljs-variable">db3</span>] <span class="hljs-operator">&gt;</span> <span class="hljs-variable">keys</span> <span class="hljs-operator">*</span><span class="hljs-variable">key1</span><span class="hljs-operator">*</span><br><span class="hljs-number">1</span>) <span class="hljs-string">&quot;\xac\xed<span class="hljs-char escape_">\x00</span><span class="hljs-char escape_">\x05</span>t<span class="hljs-char escape_">\x00</span><span class="hljs-char escape_">\x04</span>key1&quot;</span><br></code></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ç›´æ¥ä½¿ç”¨ <code>key1</code> ç«Ÿç„¶è·å–ä¸åˆ°æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹ŸåŒ¹é…åèƒ½çœ‹åˆ°ï¼Œå‘ç°éƒ½æ˜¯è¿›è¡Œäº†ç¼–ç ï¼Œè¿™æ˜¯å› ä¸º <code>RedisTemplate</code> é»˜è®¤ä½¿ç”¨ <code>jdk</code> çš„åºåˆ—åŒ–æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡è‡ªå®šä¹‰ <code>RedisTemplate</code> æ–¹å¼æ¥ä¿®æ”¹åºåˆ—åŒ–æ–¹å¼</p>
<h2 id="è‡ªå®šä¹‰-RedisTemplate"><a href="#è‡ªå®šä¹‰-RedisTemplate" class="headerlink" title="è‡ªå®šä¹‰ RedisTemplate"></a>è‡ªå®šä¹‰ RedisTemplate</h2><p>ä¸‹é¢ä»£ç å°† <code>RedisTemplate</code> ä¿®æ”¹æˆä½¿ç”¨ <code>json</code> æ–¹å¼è¿›è¡Œåºåˆ—åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CusConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;all&quot;)</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory factory)</span> &#123;<br>        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        template.setConnectionFactory(factory);<br>        <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>(Object.class);<br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">om</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);<br>        om.activateDefaultTyping(LaissezFaireSubTypeValidator.instance , ObjectMapper.DefaultTyping.NON_FINAL);<br>        om.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="hljs-literal">false</span>);<br>        jackson2JsonRedisSerializer.setObjectMapper(om);<br>        <span class="hljs-type">StringRedisSerializer</span> <span class="hljs-variable">stringRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>();<br>        <span class="hljs-comment">// keyé‡‡ç”¨Stringçš„åºåˆ—åŒ–æ–¹å¼</span><br>        template.setKeySerializer(stringRedisSerializer);<br>        <span class="hljs-comment">// hashçš„keyä¹Ÿé‡‡ç”¨Stringçš„åºåˆ—åŒ–æ–¹å¼</span><br>        template.setHashKeySerializer(stringRedisSerializer);<br>        <span class="hljs-comment">// valueåºåˆ—åŒ–æ–¹å¼é‡‡ç”¨jackson</span><br>        template.setValueSerializer(jackson2JsonRedisSerializer);<br>        <span class="hljs-comment">// hashçš„valueåºåˆ—åŒ–æ–¹å¼é‡‡ç”¨jackson</span><br>        template.setHashValueSerializer(jackson2JsonRedisSerializer);<br>        template.afterPropertiesSet();<br>        <span class="hljs-keyword">return</span> template;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ‰§è¡Œæµ‹è¯•ä»£ç åå†æ¬¡æŸ¥çœ‹ç»“æœ</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><code class="hljs swift">[db3] <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">get</span> key1<br><span class="hljs-string">&quot;<span class="hljs-subst">\&quot;</span>value1<span class="hljs-subst">\&quot;</span>&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>redisåˆ†å¸ƒå¼é”</title>
    <url>/2023/c21b41047d75/index.html</url>
    <content><![CDATA[<h2 id="redis-åˆ†å¸ƒå¼é”è¦åšåˆ°çš„äº‹æƒ…"><a href="#redis-åˆ†å¸ƒå¼é”è¦åšåˆ°çš„äº‹æƒ…" class="headerlink" title="redis åˆ†å¸ƒå¼é”è¦åšåˆ°çš„äº‹æƒ…"></a>redis åˆ†å¸ƒå¼é”è¦åšåˆ°çš„äº‹æƒ…</h2><ol>
<li>ç‹¬å æ€§ï¼š ä»»ä½•æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰</li>
<li>é«˜å¯ç”¨ï¼š è‹¥åœ¨ <code>redis</code> é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œä¸èƒ½å› ä¸ºæŸä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†è€Œå‡ºç°è·å–é”å’Œé‡Šæ”¾é”å¤±è´¥çš„æƒ…å†µ</li>
<li>é˜²æ­¢æ­»é”ï¼š è¦æœ‰è¶…æ—¶æ§åˆ¶æœºåˆ¶æˆ–è€…æ’¤é”€æ“ä½œ</li>
<li>æ­£ç¡®æ€§ï¼š ä¸èƒ½ <code>unlock</code> åˆ«äººçš„é”ï¼Œè‡ªå·±çš„é”åªèƒ½è‡ªå·±é‡Šæ”¾</li>
<li>å¯é‡å…¥</li>
</ol>
<h2 id="åˆ†å¸ƒå¼é”çš„å®ç°"><a href="#åˆ†å¸ƒå¼é”çš„å®ç°" class="headerlink" title="åˆ†å¸ƒå¼é”çš„å®ç°"></a>åˆ†å¸ƒå¼é”çš„å®ç°</h2><p><a href="https://redis.io/docs/manual/patterns/distributed-locks/">redisåˆ†å¸ƒå¼é”å®˜æ–¹æ–‡æ¡£</a><br>ä¸‹é¢ä¸€æ®µæ˜¯å®˜ç½‘å¯¹ <code>redis</code> åˆ†å¸ƒå¼é”çš„ç©†æè¿°</p>
<ol>
<li>ä½¿ç”¨çš„ç®—æ³•æ˜¯ <code>Redlock</code></li>
<li><code>Java</code> ç‰ˆæœ¬å¯¹ <code>Redlock</code> çš„å®ç°æ˜¯ <code>Redisson</code><blockquote>
<p>This page describes a more canonical algorithm to implement distributed locks with Redis. We propose an algorithm, called Redlock, which implements a DLM which we believe to be safer than the vanilla single instance approach. We hope that the community will analyze it, provide feedback, and use it as a starting point for the implementations or more complex or alternative designs.</p>
</blockquote>
</li>
</ol>
<p><a href="https://github.com/redisson/redisson">å®˜ç½‘æè¿°çš„redissonåˆ†å¸ƒå¼å®ç°</a><br>è¿™é‡Œé¢æœ‰å¾ˆå¤šå®ç°ï¼Œæ¯”å¦‚ <code>Spring Data Redis</code>, <code>Spring Boot Starter</code> ç­‰ï¼Œæˆ‘ä»¬é€‰æ‹©<a href="https://github.com/redisson/redisson/tree/master/redisson-spring-boot-starter">Spring Boot Starter</a> è¿™ä¸ª</p>
<h3 id="æ·»åŠ ä¾èµ–"><a href="#æ·»åŠ ä¾èµ–" class="headerlink" title="æ·»åŠ ä¾èµ–"></a>æ·»åŠ ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.24.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="rediså‚æ•°é…ç½®"><a href="#rediså‚æ•°é…ç½®" class="headerlink" title="rediså‚æ•°é…ç½®"></a>rediså‚æ•°é…ç½®</h3><div class="tabs" id="rediså‚æ•°é…ç½®"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="rediså‚æ•°é…ç½®-1">SpringBoot3.xç‰ˆæœ¬</button><button type="button" class="tab " data-href="rediså‚æ•°é…ç½®-2">SpringBoot2.xç‰ˆæœ¬</button></ul><div class="tab-contents"><div class="tab-item-content active" id="rediså‚æ•°é…ç½®-1"><ol>
<li><p>redis å‚æ•°é…ç½®</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.data.redis.database</span>=<span class="hljs-string">3</span><br><span class="hljs-attr">spring.data.redis.host</span>=<span class="hljs-string">127.0.0.1</span><br><span class="hljs-attr">spring.data.redis.port</span>=<span class="hljs-string">6379</span><br><span class="hljs-attr">spring.data.redis.username</span>=<span class="hljs-string">default</span><br><span class="hljs-attr">spring.data.redis.password</span>=<span class="hljs-string">123456</span><br><span class="hljs-attr">spring.data.redis.lettuce.pool.max-active</span>=<span class="hljs-string">10</span><br><span class="hljs-attr">spring.data.redis.lettuce.pool.max-wait</span>=<span class="hljs-string">-1</span><br><span class="hljs-attr">spring.data.redis.lettuce.pool.max-idle</span>=<span class="hljs-string">10</span><br><span class="hljs-attr">spring.data.redis.lettuce.pool.min-idle</span>=<span class="hljs-string">0</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>redisson é…ç½®</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.data.redis.redisson.singleServerConfig.pool.max-active</span>=<span class="hljs-string">10</span><br><span class="hljs-attr">spring.data.redis.redisson.singleServerConfig.pool.max-wait</span>=<span class="hljs-string">-1</span><br><span class="hljs-attr">spring.data.redis.redisson.singleServerConfig.pool.max-idle</span>=<span class="hljs-string">10</span><br><span class="hljs-attr">spring.data.redis.redisson.singleServerConfig.pool.min-idle</span>=<span class="hljs-string">0</span><br><span class="hljs-attr">spring.data.redis.redisson.singleServerConfig.address</span>=<span class="hljs-string">&quot;redis://127.0.0.1:6379&quot;</span><br><span class="hljs-attr">spring.data.redis.redisson.singleServerConfig.databse</span>=<span class="hljs-string">3</span><br><span class="hljs-attr">spring.data.redis.redisson.singleServerConfig.password</span>=<span class="hljs-string">123456</span><br></code></pre></td></tr></table></figure></li>
</ol></div><div class="tab-item-content" id="rediså‚æ•°é…ç½®-2"><ol>
<li><p>redis å‚æ•°é…ç½®</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.data.redis.database</span>=<span class="hljs-string">3</span><br><span class="hljs-attr">spring.redis.host</span>=<span class="hljs-string">127.0.0.1</span><br><span class="hljs-attr">spring.redis.port</span>=<span class="hljs-string">6379</span><br><span class="hljs-attr">spring.redis.username</span>=<span class="hljs-string">default</span><br><span class="hljs-attr">spring.redis.password</span>=<span class="hljs-string">123456</span><br><span class="hljs-attr">spring.redis.lettuce.pool.max-active</span>=<span class="hljs-string">10</span><br><span class="hljs-attr">spring.redis.lettuce.pool.max-wait</span>=<span class="hljs-string">-1</span><br><span class="hljs-attr">spring.redis.lettuce.pool.max-idle</span>=<span class="hljs-string">10</span><br><span class="hljs-attr">spring.redis.lettuce.pool.min-idle</span>=<span class="hljs-string">0</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>redisson é…ç½®</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.redis.redisson.singleServerConfig.pool.max-active</span>=<span class="hljs-string">10</span><br><span class="hljs-attr">spring.redis.redisson.singleServerConfig.pool.max-wait</span>=<span class="hljs-string">-1</span><br><span class="hljs-attr">spring.redis.redisson.singleServerConfig.pool.max-idle</span>=<span class="hljs-string">10</span><br><span class="hljs-attr">spring.redis.redisson.singleServerConfig.pool.min-idle</span>=<span class="hljs-string">0</span><br><span class="hljs-attr">spring.redis.redisson.singleServerConfig.address</span>=<span class="hljs-string">&quot;redis://127.0.0.1:6379&quot;</span><br><span class="hljs-attr">spring.redis.redisson.singleServerConfig.databse</span>=<span class="hljs-string">3</span><br><span class="hljs-attr">spring.redis.redisson.singleServerConfig.password</span>=<span class="hljs-string">123456</span><br></code></pre></td></tr></table></figure></li>
</ol></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<p>ä½¿ç”¨ä¸Šè¿°é…ç½®ä¹‹åï¼Œåœ¨ <code>Spring Boot</code> ç¯å¢ƒä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨å¦‚ä¸‹çš„å‡ ä¸ª <code>Bean</code> </p>
<ul>
<li><code>RedissonClient</code></li>
<li><code>RedissonRxClient</code></li>
<li><code>RedissonReactiveClient</code></li>
<li><code>RedisTemplate</code></li>
<li><code>ReactiveRedisTemplate</code></li>
</ul>
<h3 id="åˆ†å¸ƒå¼é”ä»£ç ç¤ºä¾‹"><a href="#åˆ†å¸ƒå¼é”ä»£ç ç¤ºä¾‹" class="headerlink" title="åˆ†å¸ƒå¼é”ä»£ç ç¤ºä¾‹"></a>åˆ†å¸ƒå¼é”ä»£ç ç¤ºä¾‹</h3><p>ä¸‹é¢ä»£ç å®é™…ä½¿ç”¨çš„è¿˜æ˜¯å•æœºä¸­çš„ç¨‹åºï¼Œä¸è¿‡ç”¨æ¥æµ‹è¯•åˆ†å¸ƒå¼é”çš„ä½¿ç”¨å·²ç»è¶³å¤Ÿäº†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestRedis</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedissonClient redisson;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testRedisLock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        List&lt;Thread&gt; threads = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">10</span>; j++) &#123;<br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; k &lt; <span class="hljs-number">100</span>; k++) &#123;<br>                  <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        lock = redisson.getLock(<span class="hljs-string">&quot;lock&quot;</span>);<br>                        Thread.sleep(<span class="hljs-number">10</span>);<br>                        lock.lock();<br>                        i++;<br>                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>                    &#125; <span class="hljs-keyword">finally</span> &#123;<br>                        <span class="hljs-keyword">if</span> (lock!= <span class="hljs-literal">null</span>) &#123;<br>                            lock.unlock();<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br>            thread.start();<br>            threads.add(thread);<br>        &#125;<br>        <span class="hljs-keyword">for</span> (Thread thread : threads) &#123;<br>            thread.join();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;æœ€ç»ˆç»“æœ:&quot;</span> + i);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>




]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>rediså‘å¸ƒè®¢é˜…</title>
    <url>/2023/2d9e56a00163/index.html</url>
    <content><![CDATA[<p>å‚è€ƒ <a href="https://docs.spring.io/spring-data/redis/reference/redis/pubsub.html">Springå®˜ç½‘å¯¹rediså‘å¸ƒè®¢é˜…çš„ä»£ç å®ç°</a><br>è¯´æ˜ï¼š</p>
<ol>
<li><code>SpringBoot3.x</code> ä½¿ç”¨ <code>Redis</code> å¯ä»¥å…ˆå‚è€ƒä¸‹é¢çš„æ–‡ç« </li>
</ol>
<ol><li><a href="/2023/5ef02c37afab/index.html" title="SpringBootä¸­ä½¿ç”¨Redis">SpringBootä¸­ä½¿ç”¨Redis</a></li></ol>
<ol start="2">
<li>æ•´ä½“ä»£ç åˆ†ä¸ºä¸‰éƒ¨åˆ†</li>
<li>æ¶ˆæ¯ç›‘å¬è€… (è¿™éƒ¨åˆ†æ˜¯ä¸šåŠ¡ä»£ç ä¸­éœ€è¦ç¼–å†™çš„æ¶ˆæ¯æ¥æ”¶çš„é€»è¾‘)</li>
<li>æ³¨å†Œæ¶ˆæ¯ç›‘å¬è€… ï¼ˆè¿™éƒ¨åˆ†æ˜¯å°†è‡ªå·±ç¼–å†™çš„æ¶ˆæ¯ç›‘å¬è€…æ³¨å†Œåˆ° redis ä¸­ï¼Œä¾¿äº redis å¯ä»¥è°ƒç”¨åˆ°æˆ‘ä»¬çš„æ¶ˆæ¯ç›‘å¬ç±»ï¼‰</li>
<li>æ¶ˆæ¯å‘é€è€…</li>
</ol>
<h2 id="æ¶ˆæ¯ç›‘å¬è€…"><a href="#æ¶ˆæ¯ç›‘å¬è€…" class="headerlink" title="æ¶ˆæ¯ç›‘å¬è€…"></a>æ¶ˆæ¯ç›‘å¬è€…</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisMessageListener</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String message)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;ç›‘å¬åˆ°çš„æ¶ˆæ¯:&quot;</span> + message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="æ³¨å†Œæ¶ˆæ¯ç›‘å¬"><a href="#æ³¨å†Œæ¶ˆæ¯ç›‘å¬" class="headerlink" title="æ³¨å†Œæ¶ˆæ¯ç›‘å¬"></a>æ³¨å†Œæ¶ˆæ¯ç›‘å¬</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisMessageListener</span> &#123;<br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">REDIS_SUBSCRIBE_CHANNEL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;redis.subscribe.channel&quot;</span>;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisMessageListenerContainer <span class="hljs-title function_">listenerContainer</span><span class="hljs-params">(RedisConnectionFactory factory,</span><br><span class="hljs-params">                                                           MessageListenerAdapter messageListenerAdapter)</span>&#123;<br>        <span class="hljs-type">RedisMessageListenerContainer</span> <span class="hljs-variable">container</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisMessageListenerContainer</span>();<br>        container.setConnectionFactory(factory);<br>        <span class="hljs-comment">//redis.subscribe.channel æ˜¯é…ç½®çš„è®¢é˜…çš„ channel, å‘é€æ—¶ä¹Ÿéœ€è¦å¾€è¿™ä¸ª channel ä¸­å‘é€</span><br>        container.addMessageListener(messageListenerAdapter, <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternTopic</span>(REDIS_SUBSCRIBE_CHANNEL));<br>        <span class="hljs-keyword">return</span> container;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MessageListenerAdapter <span class="hljs-title function_">messageListenerAdapter</span><span class="hljs-params">(RedisMessageListener listener)</span>&#123;<br>        <span class="hljs-type">MessageListenerAdapter</span> <span class="hljs-variable">messageListenerAdapter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageListenerAdapter</span>(listener,<br>                <span class="hljs-string">&quot;onMessage&quot;</span>);<br>        <span class="hljs-keyword">return</span> messageListenerAdapter;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢ä»£ç ä¸­çœ‹åˆ°å¾€ <code>RedisMessageListenerContainer</code> ç±»ä¸­æ³¨å†Œçš„å¹¶ä¸æ˜¯æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„ <code>RedisMessageListener</code>ï¼Œ è€Œæ˜¯ <code>MessageListenerAdapter</code>ï¼ˆ<code>MessageListenerAdapter</code> åŒ…è£¹äº† <code>RedisMessageListener</code>ï¼‰ï¼Œè¿™æ˜¯å› ä¸ºéœ€è¦é€šè¿‡ <code>MessageListenerAdapter</code> æ¥åšæ¶ˆæ¯é€‚é…ï¼Œæ¯”å¦‚æˆ‘ä»¬ç¼–å†™çš„ <code>RedisMessageListener</code> ç±»ä¸­ <code>onMessage(String)</code> æ–¹æ³•æ¥æ”¶ <code>String</code> ç±»å‹å‚æ•°ï¼Œä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥æ¥æ”¶ <code>String</code> ç±»å‹å‚æ•°å‘¢ï¼Ÿ å°±æ˜¯ <code>MessageListenerAdapter</code> åšäº†è½¬æ¢</p>
<h2 id="æ¶ˆæ¯å‘é€è€…"><a href="#æ¶ˆæ¯å‘é€è€…" class="headerlink" title="æ¶ˆæ¯å‘é€è€…"></a>æ¶ˆæ¯å‘é€è€…</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisPublish</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; stringRedisTemplate;<br><br>    <span class="hljs-comment">//è¿™é‡Œä½¿ç”¨convertAndSendæ–¹æ³•ï¼Œå‚æ•°ä¸º channel é€šé“å’Œå†…å®¹</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMsg</span><span class="hljs-params">(String channel, String msg)</span> &#123;<br>        stringRedisTemplate.convertAndSend(channel, msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="ä¸»ç±»å¯åŠ¨å¹¶æµ‹è¯•"><a href="#ä¸»ç±»å¯åŠ¨å¹¶æµ‹è¯•" class="headerlink" title="ä¸»ç±»å¯åŠ¨å¹¶æµ‹è¯•"></a>ä¸»ç±»å¯åŠ¨å¹¶æµ‹è¯•</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> SpringApplication.run(TestApplication.class, args);<br>        <span class="hljs-comment">// ä¸ºäº†è®©æ—¥å¿—åœ¨æœ€åæ‰“å°ï¼Œä¾¿äºå±•ç¤ºæ‰€ä»¥å»¶è¿Ÿ5så†å‘é€</span><br>        Thread.sleep(<span class="hljs-number">5000</span>);<br>        <span class="hljs-type">RedisPublish</span> <span class="hljs-variable">redisPublish</span> <span class="hljs-operator">=</span> applicationContext.getBean(RedisPublish.class);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            redisPublish.sendMsg(RedisConfig.REDIS_SUBSCRIBE_CHANNEL, <span class="hljs-string">&quot;æµ‹è¯•å‘é€æ•°æ®&quot;</span> + i);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æµ‹è¯•ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">ç›‘å¬åˆ°çš„æ¶ˆæ¯:<span class="hljs-string">&quot;æµ‹è¯•å‘é€æ•°æ®1&quot;</span><br>ç›‘å¬åˆ°çš„æ¶ˆæ¯:<span class="hljs-string">&quot;æµ‹è¯•å‘é€æ•°æ®2&quot;</span><br>ç›‘å¬åˆ°çš„æ¶ˆæ¯:<span class="hljs-string">&quot;æµ‹è¯•å‘é€æ•°æ®3&quot;</span><br>ç›‘å¬åˆ°çš„æ¶ˆæ¯:<span class="hljs-string">&quot;æµ‹è¯•å‘é€æ•°æ®4&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>rediså’ŒmysqlåŒå†™ä¸€è‡´æ€§é—®é¢˜</title>
    <url>/2023/68d7307921af/index.html</url>
    <content><![CDATA[<p>å½“æ•°æ®æœ‰æ›´æ–°æ—¶ï¼Œæ˜¯å…ˆæ›´æ–°ç¼“å­˜è¿˜æ˜¯å…ˆæ›´æ–°æ•°æ®åº“ï¼Ÿæˆ–è€…æ˜¯å…¶ä»–çš„æ“ä½œï¼Ÿå¯¹äºç¼“å­˜å’Œæ•°æ®åº“çš„æ›´æ–°ç»„åˆæœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼</p>
<h2 id="å…ˆæ›´æ–°ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“"><a href="#å…ˆæ›´æ–°ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“" class="headerlink" title="å…ˆæ›´æ–°ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“"></a>å…ˆæ›´æ–°ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“</h2><p>å‡è®¾æ›´æ–°ç¼“å­˜æˆåŠŸï¼Œä½†æ˜¯æ›´æ–°æ•°æ®åº“å¤±è´¥ï¼Œç¼“å­˜ä¸­æ•°æ®å°±æ˜¯é”™è¯¯ï¼Œè€Œä¸” redis æ˜¯ä¸æ”¯æŒäº‹åŠ¡å›æ»šï¼Œæ‰€ä»¥è¿™ç§æ–¹æ¡ˆæœ‰æ¯”è¾ƒå¤§çš„ç¼ºé™·</p>
<h2 id="å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“"><a href="#å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“" class="headerlink" title="å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“"></a>å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“</h2><ol>
<li>ä½¿ç”¨è¿™ç§æ–¹æ¡ˆï¼Œå³ä½¿æ›´æ–°æ•°æ®åº“å¤±è´¥äº†ä¹Ÿä¸éœ€è¦å›æ»šç¼“å­˜ã€‚è¿™ç§åšæ³•è™½ç„¶å·§å¦™è§„é¿äº†å¤±è´¥å›æ»šçš„é—®é¢˜ï¼Œä½†æ˜¯ä¼šæœ‰å…¶ä»–çš„é—®é¢˜</li>
<li>å‡è®¾çº¿ç¨‹Aå…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“ã€‚åœ¨çº¿ç¨‹Aå®Œæˆæ›´æ–°æ•°æ®åº“ä¹‹å‰ï¼Œåæ‰§è¡Œçš„çº¿ç¨‹Båè€Œè¶…å‰å®Œæˆäº†æ“ä½œï¼Œè¯»å–Keyå‘ç°æ²¡æœ‰æ•°æ®åï¼Œå°†æ•°æ®åº“ä¸­çš„æ—§å€¼å­˜æ”¾åˆ°äº†ç¼“å­˜ä¸­ã€‚çº¿ç¨‹Aåœ¨çº¿ç¨‹Béƒ½å®Œæˆåå†æ›´æ–°æ•°æ®åº“ï¼Œè¿™æ ·å°±ä¼šå‡ºç°ç¼“å­˜ï¼ˆæ—§å€¼ï¼‰ä¸æ•°æ®åº“çš„å€¼ï¼ˆæ–°å€¼ï¼‰ä¸ä¸€è‡´çš„é—®é¢˜</li>
</ol>
<h2 id="å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜"><a href="#å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜" class="headerlink" title="å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜"></a>å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜</h2><ol>
<li>å½“æ›´æ–°æ•°æ®åº“æˆåŠŸï¼Œæ›´æ–°ç¼“å­˜å¤±è´¥æ—¶ï¼Œå¯ä»¥é‡‡å–é‡è¯•çš„ç­–ç•¥ï¼Œä½†é‡è¯•æœºåˆ¶å¦‚æœå­˜åœ¨å»¶æ—¶è¿˜æ˜¯ä¼šå‡ºç°æ•°æ®åº“ä¸ç¼“å­˜ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä¸å¥½å¤„ç†</li>
<li>å‡è®¾ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ›´æ–°åŒä¸€ä¸ªæ•°æ®ï¼Œçº¿ç¨‹Aå…ˆå®Œæˆäº†ç¬¬ä¸€æ­¥ï¼Œçº¿ç¨‹Bå…ˆå®Œæˆäº†ç¬¬äºŒæ­¥æ€ä¹ˆåŠï¼Ÿçº¿ç¨‹AæŠŠå€¼æ›´æ–°æˆaï¼Œçº¿ç¨‹BæŠŠå€¼æ›´æ–°æˆbï¼Œæ­¤æ—¶æ•°æ®åº“ä¸­çš„æœ€æ–°å€¼æ˜¯bï¼Œå› ä¸ºçº¿ç¨‹Aå…ˆå®Œæˆäº†ç¬¬ä¸€æ­¥ï¼Œåå®Œæˆç¬¬äºŒæ­¥ï¼Œæ‰€ä»¥ç¼“å­˜ä¸­çš„æœ€æ–°å€¼æ˜¯aï¼Œæ•°æ®åº“ä¸ç¼“å­˜çš„å€¼è¿˜æ˜¯ä¸ä¸€è‡´ï¼Œè¿™ä¸ªé€»è¾‘è¿˜æ˜¯æœ‰é—®é¢˜çš„</li>
</ol>
<h2 id="å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜"><a href="#å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜" class="headerlink" title="å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜"></a>å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</h2><ol>
<li>å› ä¸ºæ›´æ–°æ•°æ®åº“ä¹‹åæ˜¯åˆ é™¤ç¼“å­˜ï¼Œæ‰€ä»¥å¯ä»¥è§£å†³ <strong>å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜</strong> å¸¦æ¥çš„ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜</li>
<li>å‡è®¾çº¿ç¨‹Aè¦æ›´æ–°æ•°æ®ï¼Œå…ˆå®Œæˆç¬¬ä¸€æ­¥æ›´æ–°æ•°æ®åº“ï¼Œåœ¨çº¿ç¨‹Aåˆ é™¤ç¼“å­˜ä¹‹å‰ï¼Œçº¿ç¨‹Bè¦è®¿é—®ç¼“å­˜ï¼Œé‚£ä¹ˆå–å¾—çš„å°±æ˜¯æ—§æ•°æ®ï¼Œ ä¸è¿‡è¿™ç§æƒ…å†µå‡ºç°çš„æ¦‚ç‡æ¯”è¾ƒä½</li>
</ol>
<h2 id="å…ˆåˆ é™¤ç¼“å­˜ï¼Œæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜"><a href="#å…ˆåˆ é™¤ç¼“å­˜ï¼Œæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜" class="headerlink" title="å…ˆåˆ é™¤ç¼“å­˜ï¼Œæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜"></a>å…ˆåˆ é™¤ç¼“å­˜ï¼Œæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</h2><ol>
<li>å’Œ <strong>å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</strong> å¤„ç†æ–¹å¼ç±»ä¼¼ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¼šå‡ºç°ç±»ä¼¼çš„é—®é¢˜ï¼Œå‡è®¾çº¿ç¨‹Aè¦æ›´æ–°æ•°æ®åº“ï¼Œå…ˆåˆ é™¤äº†ç¼“å­˜ï¼Œè¿™ä¸€ç¬é—´çº¿ç¨‹Cè¦è¯»ç¼“å­˜ï¼Œå…ˆæŠŠæ•°æ®è¿ç§»åˆ°ç¼“å­˜ï¼›ç„¶åçº¿ç¨‹Aå®Œæˆäº†æ›´æ–°æ•°æ®åº“çš„æ“ä½œï¼Œè¿™ä¸€ç¬é—´çº¿ç¨‹Bä¹Ÿè¦è®¿é—®ç¼“å­˜ï¼Œæ­¤æ—¶å®ƒè®¿é—®åˆ°çš„å°±æ˜¯çº¿ç¨‹Cæ”¾åˆ°ç¼“å­˜é‡Œé¢çš„æ—§æ•°æ®ï¼Œ ä¸è¿‡è¿™ç§æƒ…å†µå‡ºç°çš„æ¦‚ç‡æ›´ä½ï¼Œè¿™æ˜¯éœ€è¦ä¸‰ä¸ªçº¿ç¨‹é…åˆæ‰å¯èƒ½ä¼šå‡ºç°çš„é—®é¢˜</li>
</ol>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œæ¯ä¸€ç§æ–¹æ¡ˆéƒ½æ˜¯æœ‰ä¸€å®šçš„ç¼ºé™·çš„ï¼Œåªæ˜¯æœ€åä¸€ç§æ–¹å¼å¯ä»¥è®©ç¼ºé™·å‘ç”Ÿçš„æœºç‡æ›´ä½è€Œå·²</p>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>redisåº•å±‚æ•°æ®ç»“æ„</title>
    <url>/2023/19e21a188fd0/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="redis-å¯¹è±¡"><a href="#redis-å¯¹è±¡" class="headerlink" title="redis å¯¹è±¡"></a>redis å¯¹è±¡</h2><p><code>redis</code> ä¸­æ‰€æœ‰æ•°æ®ç±»å‹éƒ½æ˜¯ä½¿ç”¨ <code>RedisObject</code> å¯¹è±¡å½¢å¼æ¥è¡¨ç¤ºï¼Œ<code>RedisObject</code> ä¸»è¦åŒ…å«ä¸‰ä¸ªå­—æ®µ</p>
<span id="more"></span>

<pre class="mermaid">graph LR
    A[RedisObject]
    A-->B["type (è®°å½•å¯¹è±¡çš„ç±»å‹) \n å¸¸ç”¨5ç§åŸºæœ¬ç±»å‹ï¼Œå®é™…è¿˜æœ‰BitMapï¼ˆ2.2 ç‰ˆæ–°å¢ï¼‰\nã€HyperLogLogï¼ˆ2.8 ç‰ˆæ–°å¢ï¼‰ã€\n GEOï¼ˆ3.2 ç‰ˆæ–°å¢ï¼‰ã€Streamï¼ˆ5.0 ç‰ˆæ–°å¢ï¼‰"]

    B1[String å­—ç¬¦ä¸²å¯¹è±¡]
    B2[List åˆ—è¡¨é›†åˆ]
    B3[Hash å“ˆå¸Œå¯¹è±¡]
    B4[Set é›†åˆå¯¹è±¡]
    B5[Zset æœ‰åºé›†åˆå¯¹è±¡]
    B--> B1 & B2 & B3 & B4 & B5

    A-->C["encoding (è®°å½•å¯¹è±¡çš„ç¼–ç )"]
    C1[Intset æ•´æ•°é›†åˆ]
    C2[embstr embstrç¼–ç çš„ç®€å•åŠ¨æ€å­—ç¬¦ä¸²]
    C3[raw ç®€å•åŠ¨æ€å­—ç¬¦ä¸²]
    C4[HT å­—å…¸]
    C5[Linkedlist åŒç«¯åˆ—è¡¨]
    C6[ziplist å‹ç¼©åˆ—è¡¨]
    C7[skiplist è·³è·ƒè¡¨å’Œå­—å…¸]
    C8[quicklist å¿«é€Ÿåˆ—è¡¨]
    C-->C1 & C2 & C3 & C4 & C5 & C6 & C7 & C8

    A-->D["*ptr (æŒ‡å‘å…·ä½“çš„ç±»å‹)"]</pre>

<h3 id="ä¸ºä»€ä¹ˆä¸€ä¸ªå¯¹è±¡éœ€è¦åŒ…å«-type-å’Œ-encoding"><a href="#ä¸ºä»€ä¹ˆä¸€ä¸ªå¯¹è±¡éœ€è¦åŒ…å«-type-å’Œ-encoding" class="headerlink" title="ä¸ºä»€ä¹ˆä¸€ä¸ªå¯¹è±¡éœ€è¦åŒ…å« type å’Œ encoding"></a>ä¸ºä»€ä¹ˆä¸€ä¸ªå¯¹è±¡éœ€è¦åŒ…å« <code>type</code> å’Œ <code>encoding</code></h3><ol>
<li>å› ä¸º <code>type</code> åªæ˜¯è®°å½•å¯¹è±¡çš„ç±»å‹</li>
<li>æ¯ä¸€ä¸ª <code>type</code> å¯ä»¥ä½¿ç”¨ä¸åŒçš„åº•å±‚æ•°æ®ç»“æ„æ¥å®ç°ï¼Œæ‰€ä»¥è¿˜éœ€è¦å…·ä½“çš„ <code>encoding</code> æ¥æŒ‡æ˜è¿™ä¸ª <code>type</code> çš„å®ç°æ˜¯ä»€ä¹ˆï¼Œ ä¸‹å›¾å°±åˆ—å‡ºæ¯ä¸€ä¸ª <code>type</code> æœ‰å“ªå‡ ç§åº•å±‚æ•°æ®ç»“æ„</li>
</ol>
<h2 id="5-ç§åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„åº•å±‚å®ç°"><a href="#5-ç§åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„åº•å±‚å®ç°" class="headerlink" title="5 ç§åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„åº•å±‚å®ç°"></a>5 ç§åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„åº•å±‚å®ç°</h2><h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><ol>
<li><code>String</code> ç±»å‹çš„åº•å±‚çš„æ•°æ®ç»“æ„å®ç°ä¸»è¦æ˜¯ <code>int</code> å’Œ <code>SDS</code>ï¼ˆç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼‰<ol>
<li>å¦‚æœå­˜å‚¨çš„æ˜¯æ•°å­—ï¼Œåˆ™ç¼–ç ä½¿ç”¨ <code>int</code> ç±»å‹</li>
</ol>
</li>
<li><code>sds</code> çš„å®é™…ç¼–ç åˆåŒ…å« <code>raw</code> å’Œ <code>embstr</code><ol>
<li>å­—ç¬¦ä¸²é•¿åº¦å°äº 32ä½æ—¶ä½¿ç”¨ <code>embstr</code>(<code>embstr</code> çš„ç©ºé—´æŒ¨ç€ <code>RedisObjectï¼ŒRedisObject</code> å’Œ <code>embstr</code> çš„å†…å­˜æ˜¯ä¸€æ¬¡æ€§åˆ†é…çš„)</li>
<li>å­—ç¬¦ä¸²é•¿åº¦å¤§äº 32ä½æ—¶ä½¿ç”¨ <code>raw</code> ç¼–ç (<code>RedisObject</code> çš„å†…å­˜åˆ†åŒºå’Œ <code>raw</code> ç¼–ç ç±»å‹çš„ç©ºé—´åˆ†é…æ˜¯åˆ†å¼€çš„ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ä¸¤æ¬¡å†…å­˜åˆ†é…)</li>
</ol>
</li>
</ol>
<h4 id="SDS-å’Œ-C-åŸç”Ÿå­—ç¬¦ä¸²çš„åŒºåˆ«"><a href="#SDS-å’Œ-C-åŸç”Ÿå­—ç¬¦ä¸²çš„åŒºåˆ«" class="headerlink" title="SDS å’Œ C åŸç”Ÿå­—ç¬¦ä¸²çš„åŒºåˆ«"></a>SDS å’Œ C åŸç”Ÿå­—ç¬¦ä¸²çš„åŒºåˆ«</h4><ol>
<li><code>sds</code> å¯ä»¥ä¿å­˜æ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ•°æ®ï¼Œå› ä¸º <code>sds</code> æœ‰ <code>length</code> å­—æ®µæ¥åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç»“æŸï¼Œc ä½¿ç”¨ â€˜\0â€™ ä½œä¸ºç»“æŸç¬¦</li>
<li><code>sds</code> çš„ <code>api</code> å®‰å…¨ï¼Œä¸ä¼šå‡ºç°ç¼“å†²åŒºæº¢å‡ºï¼Œå› ä¸º <code>sds</code> æ‹¼æ¥å­—ç¬¦ä¸²å‰æœ‰åšå®¹é‡æ£€æŸ¥</li>
</ol>
<h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><ol>
<li><code>List</code> ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ç”±åŒå‘é“¾è¡¨æˆ–å‹ç¼©åˆ—è¡¨å®ç°çš„<ol>
<li>å…ƒç´ ä¸ªæ•°å°äº 512 ä¸ªï¼ˆé»˜è®¤å€¼ï¼Œå¯ç”± <code>list-max-ziplist-entries</code> é…ç½®ï¼‰ï¼Œåˆ—è¡¨æ¯ä¸ªå…ƒç´ çš„å€¼éƒ½å°äº 64 å­—èŠ‚ï¼ˆé»˜è®¤å€¼ï¼Œå¯ç”± <code>list-max-ziplist-value</code> <code>é…ç½®ï¼‰ï¼ŒRedis</code> ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸º <code>List</code> ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›</li>
</ol>
</li>
<li>åœ¨ <code>Redis3.2</code> ç‰ˆæœ¬ä¹‹åï¼Œ<code>List</code> ç±»å‹åº•å±‚æ•°æ®ç»“æ„åªæœ‰ <code>quicklist</code> ä¸€ç§</li>
</ol>
<h3 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h3><ol>
<li><code>Hash</code> ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ç”±å‹ç¼©åˆ—è¡¨æˆ–å“ˆå¸Œè¡¨å®ç°çš„<ol>
<li>å…ƒç´ ä¸ªæ•°å°äº 512 ä¸ªï¼ˆå¯é€šè¿‡ <code>hash-max-ziplist-entries</code> ä¿®æ”¹ï¼‰ï¼Œæ‰€æœ‰å€¼å°äº 64 å­—èŠ‚ï¼ˆå¯é€šè¿‡ <code>hash-max-ziplist-value</code> ä¿®æ”¹ï¼‰æ—¶ï¼Œ<code>Redis</code> ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸º <code>Hash</code> ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„</li>
</ol>
</li>
<li>åœ¨ <code>Redis7.0</code> ä¸­ï¼Œå‹ç¼©åˆ—è¡¨æ•°æ®ç»“æ„è¢«åºŸå¼ƒï¼Œç”± <code>listpack</code> æ•°æ®ç»“æ„æ¥å®ç°</li>
</ol>
<h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h3><ol>
<li><code>Set</code> ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ç”±å“ˆå¸Œè¡¨æˆ–æ•´æ•°é›†åˆå®ç°çš„<ol>
<li>å¦‚æœé›†åˆä¸­çš„å…ƒç´ éƒ½æ˜¯æ•´æ•°ä¸”å…ƒç´ ä¸ªæ•°å°äº 512 ï¼ˆå¯é€šè¿‡ <code>set-maxintset-entries</code> ä¿®æ”¹ï¼‰ä¸ªï¼Œ<code>Redis</code> ä¼šä½¿ç”¨æ•´æ•°é›†åˆä½œä¸º Set ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„</li>
</ol>
</li>
</ol>
<h3 id="Zset"><a href="#Zset" class="headerlink" title="Zset"></a>Zset</h3><ol>
<li><p>Zset ç±»å‹åº•å±‚æ•°æ®ç»“æ„æ˜¯ç”±å‹ç¼©åˆ—è¡¨æˆ–è·³è¡¨å®ç°</p>
<ol>
<li>è‹¥æœ‰åºé›†åˆçš„å…ƒç´ ä¸ªæ•°å°äº 128 ä¸ªä¸”æ¯ä¸ªå…ƒç´ çš„å€¼å°äº 64 å­—èŠ‚ï¼Œ<code>Redis</code> ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸º <code>Zset</code> ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„</li>
</ol>
</li>
<li><p><code>Redis 7.0</code> ä¸­ï¼Œå‹ç¼©åˆ—è¡¨æ•°æ®ç»“æ„è¢«åºŸå¼ƒï¼Œäº¤ç”± <code>listpack</code> æ•°æ®ç»“æ„æ¥å®ç°</p>
</li>
</ol>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>redisçº¿ç¨‹æ¨¡å‹</title>
    <url>/2023/e4db3f95ceb5/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<p>æ€»ç»“ï¼š<code>redis</code> æ•´ä½“æ˜¯å¤šçº¿ç¨‹çš„ï¼Œè‡³äºå¹³æ—¶æ‰€è¯´çš„ <code>redis</code> å•çº¿ç¨‹æ˜¯æŒ‡ <strong>redisçš„ç½‘ç»œio å’Œ é”®å€¼å¯¹è¯»å†™</strong> æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆ</p>
<h2 id="ä¸€æ¬¡-redis-è¯·æ±‚è¿‡ç¨‹"><a href="#ä¸€æ¬¡-redis-è¯·æ±‚è¿‡ç¨‹" class="headerlink" title="ä¸€æ¬¡ redis è¯·æ±‚è¿‡ç¨‹"></a>ä¸€æ¬¡ redis è¯·æ±‚è¿‡ç¨‹</h2><ol>
<li>ç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚ï¼ˆ<code>bind/listen</code>ï¼‰</li>
<li>ç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ï¼ˆ<code>accept</code>ï¼‰</li>
<li>ä» <code>socket</code> ä¸­è¯»å–æ•°æ®ï¼ˆ<code>recv</code>ï¼‰</li>
<li>è§£æå®¢æˆ·ç«¯å‘é€çš„å†…å®¹ï¼ˆ<code>parse</code>ï¼‰</li>
<li>æ ¹æ®è§£æå‡ºæ¥çš„å†…å®¹è¿›è¡Œå†…å­˜æ“ä½œï¼ˆ<code>get/set</code>ï¼‰</li>
<li>æ‰§è¡Œå®Œæˆå‘½ä»¤ä¹‹åç»™å®¢æˆ·ç«¯å“åº”ç»“æœï¼Œå³å‘ <code>socket</code> ä¸­å†™æ•°æ®ï¼ˆ<code>send</code>ï¼‰</li>
</ol>
<pre class="mermaid">graph TB
    subgraph A[redisçº¿ç¨‹]
        subgraph B[ç½‘ç»œIOå¤„ç†]
            B1[bind/listen]
            B2[accept]
            B3[recv]
            B4[parse]
        end
        subgraph C[é”®å€¼å¯¹è¯»å†™]
            C1[get/set]
        end
        subgraph D[ç½‘ç»œIOå¤„ç†]
            D1[send]
        end
    end
    B-->C-->D</pre>
<ul>
<li>ç½‘ç»œ io å¤„ç†è¿‡ç¨‹ä¸­ï¼Œ <code>listen</code> å’Œ <code>recv</code> è¿™ä¸¤ä¸ªæ­¥éª¤æ˜¯å¯èƒ½é˜»å¡çš„ï¼Œå³å½“æ²¡æœ‰é“¾æ¥æˆ–å®¢æˆ·ç«¯æ²¡æœ‰å‘é€å‘½ä»¤æ—¶ï¼ŒæœåŠ¡å™¨å¤„ç†è¿™ä¸¤ä¸ªç¯èŠ‚æ—¶ä¼šé˜»å¡ï¼Œ<strong>ä½†æ˜¯socketç½‘ç»œæ¨¡å‹è‡ªèº«å°±æ”¯æŒéé˜»å¡çš„å½¢å¼</strong></li>
</ul>
<h2 id="redis4-ç‰ˆæœ¬ä¸­çš„å¤šçº¿ç¨‹"><a href="#redis4-ç‰ˆæœ¬ä¸­çš„å¤šçº¿ç¨‹" class="headerlink" title="redis4 ç‰ˆæœ¬ä¸­çš„å¤šçº¿ç¨‹"></a>redis4 ç‰ˆæœ¬ä¸­çš„å¤šçº¿ç¨‹</h2><ol>
<li>åœ¨ <code>redis4</code> ä¸­ä¸»è¦æ˜¯å¢åŠ äº†å¼‚æ­¥åˆ é™¤æœºåˆ¶ï¼Œæ¯”å¦‚ <code>UNLINKã€FLUSHALL ASYNCã€FLUSHDB ASYNC</code> ç­‰éé˜»å¡çš„åˆ é™¤æ“ä½œã€‚</li>
<li>å¼•å…¥å¼‚æ­¥åˆ é™¤çš„åŸå› æ˜¯ç°åœ¨æœåŠ¡å™¨çš„å†…å­˜åŸæ¥è¶Šå¤§ï¼Œ<code>redis</code> ä¸­å¯èƒ½ä¼šå­˜åœ¨ <code>bigKey</code>, å¯¹äºè¿™äº› <code>bigKey</code> çš„åˆ é™¤å¦‚æœä½¿ç”¨é˜»å¡çš„æ–¹å¼ï¼Œä¼šå¯¼è‡´æœåŠ¡å™¨çš„å“åº”æ—¶é—´å˜é•¿ï¼Œæ‰€ä»¥å¼•å…¥äº†å¼‚æ­¥åˆ é™¤çš„æœºåˆ¶ï¼Œå³å½“åˆ é™¤ <code>bigKey</code> çš„æ—¶å€™ï¼Œä¼šå°†åˆ é™¤æ“ä½œæ”¾å…¥ä¸€ä¸ªå¼‚æ­¥é˜Ÿåˆ—ä¸­ï¼Œç”±ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥è´Ÿè´£å¼‚æ­¥åˆ é™¤ï¼Œè¿™æ ·å°±å¯ä»¥æé«˜æœåŠ¡å™¨çš„å“åº”æ—¶é—´</li>
</ol>
<h2 id="redis6-ç‰ˆæœ¬çš„å¤šçº¿ç¨‹"><a href="#redis6-ç‰ˆæœ¬çš„å¤šçº¿ç¨‹" class="headerlink" title="redis6 ç‰ˆæœ¬çš„å¤šçº¿ç¨‹"></a>redis6 ç‰ˆæœ¬çš„å¤šçº¿ç¨‹</h2><p>åœ¨ <code>redis6</code> ä¸­æœ‰å‡ ä¸ªé‡è¦ç‰¹æ€§ï¼Œæ¯”å¦‚</p>
<ol>
<li>é¢å‘<strong>ç½‘ç»œå¤„ç†</strong>çš„å¤š <code>IO</code> çº¿ç¨‹</li>
<li>å®¢æˆ·ç«¯ç¼“å­˜</li>
<li>ç»†ç²’åº¦çš„æƒé™æ§åˆ¶</li>
</ol>
<p>æœ¬èŠ‚ä¸»è¦è®²è§£ <code>redis6</code> ä¸­çš„å¤šçº¿ç¨‹æ¨¡å‹ï¼Œåœ¨ <code>redis6</code> ä¹‹å‰ï¼Œ<strong>ä»ç½‘ç»œioå¤„ç†åˆ°é”®å€¼å¯¹è¯»å†™éƒ½æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆçš„</strong>ï¼Œ éšç€ç½‘ç»œç¡¬ä»¶çš„æ€§èƒ½æå‡ï¼Œ<code>redis</code> çš„æ€§èƒ½ç“¶é¢ˆæœ‰æ—¶ä¼šå‡ºç°åœ¨ç½‘ç»œ<code>io</code>çš„å¤„ç†ä¸Šï¼Œå³ <strong>å•ä¸ªä¸»çº¿ç¨‹å¤„ç†ç½‘ç»œè¯·æ±‚çš„é€Ÿåº¦è·Ÿä¸ä¸Šåº•å±‚ç½‘ç»œç¡¬ä»¶çš„é€Ÿåº¦</strong>ï¼Œæ‰€ä»¥åœ¨ <code>redis6</code> ä¸­ä½¿ç”¨å¤šä¸ªç½‘ç»œ<code>io</code>çº¿ç¨‹æ¥å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œæé«˜ç½‘ç»œè¯·æ±‚å¤„ç†å¹¶è¡Œçš„èƒ½åŠ›, éœ€è¦æ³¨æ„çš„æ˜¯ <strong>redis6çš„å¤šçº¿ç¨‹æ¨¡å‹åªæ˜¯é’ˆå¯¹ç½‘ç»œioéƒ¨åˆ†ï¼Œredisçš„æ•°æ®è¯»å†™ä¾ç„¶æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆçš„</strong></p>
<h3 id="redis6ä¸­ä¸»çº¿ç¨‹å’Œioçº¿ç¨‹åä½œæµç¨‹"><a href="#redis6ä¸­ä¸»çº¿ç¨‹å’Œioçº¿ç¨‹åä½œæµç¨‹" class="headerlink" title="redis6ä¸­ä¸»çº¿ç¨‹å’Œioçº¿ç¨‹åä½œæµç¨‹"></a>redis6ä¸­ä¸»çº¿ç¨‹å’Œioçº¿ç¨‹åä½œæµç¨‹</h3><pre class="mermaid">graph TB
    subgraph A["redisä¸»çº¿ç¨‹(æ¥æ”¶è¯·æ±‚)"]
        direction TB
        style A fill:#f9f
        A1["æ¥æ”¶å»ºç«‹è¿æ¥è¯·æ±‚ï¼Œè·å–socket"]
        A2["å°†socketæ”¾å…¥å…¨å±€ç­‰å¾…é˜Ÿåˆ—"]
        A3["ä»¥è½®è¯¢æ–¹å¼å°†socketè¿æ¥åˆ†é…ç»™IOçº¿ç¨‹, ä¸»çº¿ç¨‹å¼€å§‹é˜»å¡-----"]
        A1-->A2-->A3
    end
    subgraph B["redisç½‘ç»œIOçº¿ç¨‹(è§£æè¯·æ±‚)"]
        direction TB
        B1["å°†socketå’Œçº¿ç¨‹ç»‘å®š"]
        B2["è¯»å–socketä¸­çš„è¯·æ±‚å¹¶è§£æ"]
        B3["è¯·æ±‚è§£æå®Œæˆ"]
        B1-->B2-->B3
    end
    subgraph BB["redisç½‘ç»œIOçº¿ç¨‹(è§£æè¯·æ±‚)"]
        direction TB
        BB1["å°†socketå’Œçº¿ç¨‹ç»‘å®š"]
        BB2["è¯»å–socketä¸­çš„è¯·æ±‚å¹¶è§£æ"]
        BB3["è¯·æ±‚è§£æå®Œæˆ"]
        BB1-->BB2-->BB3
    end
    A--"ioçº¿ç¨‹å¼€å§‹æ‰§è¡Œ"-->B & BB
    subgraph C["redisä¸»çº¿ç¨‹(å‘½ä»¤è¯»å†™)"]
        direction TB
        style C fill:#f9f
        C1["æ‰§è¡Œè¯·æ±‚çš„å‘½ä»¤æ“ä½œ"]
        C2["è¯·æ±‚çš„å‘½ä»¤æ“ä½œæ‰§è¡Œå®Œæˆ"]
        C3["å°†ç»“æœæ•°æ®å†™å…¥ç¼“å†²åŒº"]
        C4["ç­‰å¾…ioçº¿ç¨‹å®Œæˆæ•°æ®å›å†™socketï¼Œä¸»çº¿ç¨‹é˜»å¡---"]
        C1-->C2-->C3-->C4
    end
    B-->C
    BB-->C
    subgraph D["redisç½‘ç»œIOçº¿ç¨‹(ç»“æœå“åº”)"]
        direction TB
        D1["å°†ç»“æœæ•°æ®å›å†™socket(è¿™ä¸€æ­¥æ˜¯å¹¶è¡Œå¤„ç†)"]
        D2["socketå›å†™å®Œæˆ"]
        D1-->D2
    end
    subgraph DD["redisç½‘ç»œIOçº¿ç¨‹(ç»“æœå“åº”)"]
        direction TB
        DD1["å°†ç»“æœæ•°æ®å›å†™socket(è¿™ä¸€æ­¥æ˜¯å¹¶è¡Œå¤„ç†)"]
        DD2["socketå›å†™å®Œæˆ"]
        DD1-->DD2
    end
    C-->D & DD
    D-->E["ä¸»çº¿ç¨‹æ¸…ç©ºç­‰å¾…é˜Ÿåˆ—ï¼Œç­‰å¾…åç»­è¯·æ±‚"]
    DD-->E["ä¸»çº¿ç¨‹æ¸…ç©ºç­‰å¾…é˜Ÿåˆ—ï¼Œç­‰å¾…åç»­è¯·æ±‚"]
    style E fill:#f9f</pre>
<h3 id="é˜¶æ®µ1"><a href="#é˜¶æ®µ1" class="headerlink" title="é˜¶æ®µ1"></a>é˜¶æ®µ1</h3><ol>
<li>æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯è¿æ¥ <code>socket</code> è¿æ¥ï¼Œå¹¶å°† <code>socket</code> æ”¾å…¥å…¨å±€ç­‰å¾…é˜Ÿåˆ—</li>
<li>ä¸»çº¿ç¨‹é€šè¿‡è½®è¯¢çš„æ–¹å¼ï¼Œå°† <code>socket</code> è¿æ¥åˆ†é…ç»™ <code>io</code> çº¿ç¨‹</li>
<li>ä¸»çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€</li>
</ol>
<h3 id="é˜¶æ®µ2"><a href="#é˜¶æ®µ2" class="headerlink" title="é˜¶æ®µ2"></a>é˜¶æ®µ2</h3><ol>
<li><code>io</code> çº¿ç¨‹å®Œæˆå®¢æˆ·ç«¯è¯·æ±‚è¯»å–å’Œè§£æ</li>
<li><code>io</code> çº¿ç¨‹æœ‰å¤šä¸ªï¼Œæ˜¯å¹¶å‘æ“ä½œçš„, æ‰€ä»¥ä¼šå¾ˆå¿«</li>
</ol>
<h3 id="é˜¶æ®µ3"><a href="#é˜¶æ®µ3" class="headerlink" title="é˜¶æ®µ3"></a>é˜¶æ®µ3</h3><ol>
<li>ç­‰å¾… <code>io</code> xçº¿ç¨‹å°†å‘½ä»¤è§£æå®Œæˆåï¼Œ<strong>ä¸»çº¿ç¨‹ä¼šä»¥å•çº¿ç¨‹çš„æ–¹å¼æ‰§è¡Œè¿™ä¸ªå‘½ä»¤æ“ä½œ</strong></li>
</ol>
<h3 id="é˜¶æ®µ4"><a href="#é˜¶æ®µ4" class="headerlink" title="é˜¶æ®µ4"></a>é˜¶æ®µ4</h3><ol>
<li>ä¸»çº¿ç¨‹æ‰§è¡Œå®Œè¯·æ±‚æ“ä½œåï¼Œå°†éœ€è¦è¿”å›çš„ç»“æœå†™å…¥ç¼“å†²åŒºï¼Œç„¶ä¼šï¼Œä¸»çº¿ç¨‹ä¼šé˜»å¡ç­‰å¾… <code>io</code> çº¿ç¨‹æŠŠè¿™äº›ç»“æœå†™å›åˆ° <code>socket</code> ä¸­ï¼Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯</li>
<li><code>io</code> çº¿ç¨‹å›å†™ <code>socket</code> ä¹‹åï¼Œä¸»çº¿ç¨‹ä¼šæ¸…ç©ºå…¨å±€é˜Ÿåˆ—ï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„åç»­è¯·æ±‚</li>
</ol>
<h2 id="redis6-å¤šçº¿ç¨‹æ¨¡å‹çš„å¯ç”¨"><a href="#redis6-å¤šçº¿ç¨‹æ¨¡å‹çš„å¯ç”¨" class="headerlink" title="redis6 å¤šçº¿ç¨‹æ¨¡å‹çš„å¯ç”¨"></a>redis6 å¤šçº¿ç¨‹æ¨¡å‹çš„å¯ç”¨</h2><ol>
<li>åœ¨ <code>redis6</code> ä¸­ï¼Œå¤šçº¿ç¨‹æ¨¡å—é»˜è®¤æ˜¯å…³é—­çš„</li>
<li>å¯ä»¥åœ¨ <code>redis.conf</code> ä¸­è®¾ç½® <code>io-threads-do-reads yes</code> æ¥å¼€å¯å¤šçº¿ç¨‹</li>
<li>å¯ä»¥åœ¨ <code>redis.conf</code> ä¸­è®¾ç½®çº¿ç¨‹ä¸ªæ•°ï¼Œæ¯”å¦‚ <code>io-threads 4</code>, ä¸€èˆ¬å»ºè®®çº¿ç¨‹ä¸ªæ•°å°äº <code>redis</code> å®ä¾‹æ‰€åœ¨æœºå™¨çš„ <code>cpu</code> æ ¸ä¸ªæ•°</li>
</ol>
<h2 id="ç–‘é—®è§£ç­”"><a href="#ç–‘é—®è§£ç­”" class="headerlink" title="ç–‘é—®è§£ç­”"></a>ç–‘é—®è§£ç­”</h2><ol>
<li><code>Redis6.0</code>å¢åŠ äº†<code>IO</code>çº¿ç¨‹æ¥å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œå¦‚æœå®¢æˆ·ç«¯å…ˆå‘é€äº†ä¸€ä¸ª<code>set key1 val1</code>å†™å‘½ä»¤ï¼Œç´§æ¥ç€å‘é€ä¸€ä¸ª<code>get key1</code>è¯»å‘½ä»¤ã€‚ç”±äºIOçº¿ç¨‹æ˜¯å¤šçº¿ç¨‹å¤„ç†çš„ï¼Œæ˜¯å¦ä¼šå¯¼è‡´<code>get key1</code>è¯»å‘½ä»¤ å…ˆäº <code>set key1 val1</code>å†™å‘½ä»¤æ‰§è¡Œå‘¢ï¼Ÿç»“æœå®¢æˆ·ç«¯è¯»åˆ°äº†<code>key1</code>çš„æ—§å€¼çš„æƒ…å†µå‘ç”Ÿï¼Ÿ</li>
</ol>
<blockquote>
<p>å¦‚æœè¿™ä¸¤æ¡å‘½ä»¤æ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯å‘é€çš„ï¼Œæœ‰æ˜æ˜¾çš„å…ˆåé¡ºåºï¼Œå°±ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œå› ä¸ºæ¥æ”¶è¯·æ±‚çš„è¿˜æ˜¯ä¸»çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹æ¥æ”¶è¯·æ±‚åä¼šå°†å‘½ä»¤å…¥é˜Ÿåˆ—ï¼Œè¿™ä¸ªæ˜¯å¯ä»¥ä¿è¯é¡ºåºçš„ï¼Œè™½ç„¶åç»­æ˜¯äº¤ç»™å¤šçº¿ç¨‹æ¥è§£æè¯·æ±‚ï¼Œä½†æ˜¯å‘½ä»¤è¯»å†™çš„é¡ºåºè¿˜æ˜¯ä¼šæŒ‰ç…§é˜Ÿåˆ—ä¸­å‘½ä»¤å…ˆåå‡ºç°çš„é¡ºåºï¼Œè€Œä¸”å‘½ä»¤è¯»å†™æ˜¯é€šè¿‡ä¸»çº¿ç¨‹å•çº¿ç¨‹æ“ä½œçš„ã€‚</p>
<p>å¦‚æœè¿™é‡Œè¯´çš„æ˜¯å¤šä¸ªå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤ï¼Œé‚£å°±éœ€è¦çœ‹å“ªä¸ªå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚å…ˆåˆ°è¾¾æœåŠ¡ç«¯ï¼Œå…ˆåˆ°è¾¾çš„å‘½ä»¤ä¼šå…ˆæ‰§è¡Œ</p>
</blockquote>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¼“å­˜é›ªå´©ç¼“å­˜å‡»ç©¿ç¼“å­˜ç©¿é€</title>
    <url>/2023/90567821a93b/index.html</url>
    <content><![CDATA[<h2 id="ç¼“å­˜é›ªå´©"><a href="#ç¼“å­˜é›ªå´©" class="headerlink" title="ç¼“å­˜é›ªå´©"></a>ç¼“å­˜é›ªå´©</h2><h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨ç¼“å­˜æœåŠ¡å™¨é‡å¯æˆ–è€…å¤§é‡ <code>key</code> é›†ä¸­åœ¨æŸä¸€æ—¶åˆ»åŒæ—¶å¤±æ•ˆï¼Œè€Œè¿™äº›ç¼“å­˜åœ¨åŒä¸€æ—¶åˆ»è¢«å¤§é‡çš„è¯·æ±‚æ‰€è®¿é—®ï¼Œä»è€Œå¼•èµ·å¤§é‡çš„ç¼“å­˜é›†ä¸­å¤±æ•ˆï¼Œå¼•èµ·è¯·æ±‚çš„æ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚</p>
<h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><ol>
<li>é¿å…ç¼“å­˜è®¾ç½®ç›¸è¿‘çš„æœ‰æ•ˆæœŸ</li>
<li>å¯¹æ•°æ®è¿›è¡Œé¢„çƒ­</li>
</ol>
<h2 id="ç¼“å­˜å‡»ç©¿"><a href="#ç¼“å­˜å‡»ç©¿" class="headerlink" title="ç¼“å­˜å‡»ç©¿"></a>ç¼“å­˜å‡»ç©¿</h2><h3 id="æ¦‚å¿µ-1"><a href="#æ¦‚å¿µ-1" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><p>ç¼“å­˜å‡»ç©¿æ˜¯æŒ‡ä¸€ä¸ªçƒ­ç‚¹ <code>key</code>åœ¨ç¼“å­˜å¤±æ•ˆçš„æ—¶å€™ï¼ŒåŒæ—¶å¤§é‡çš„è¯·æ±‚éƒ½åœ¨è®¿é—®è¿™ä¸ª<code>key</code>ï¼Œè€Œè¿™äº›è¯·æ±‚éƒ½åœ¨åŒæ—¶å¤±æ•ˆï¼Œä»è€Œå¼•èµ·å¤§é‡çš„è¯·æ±‚é›†ä¸­åˆ°è¾¾æ•°æ®åº“ï¼Œä»è€Œå¼•èµ·æ•°æ®åº“çš„å‹åŠ›ã€‚</p>
<h3 id="è§£å†³æ–¹æ¡ˆ-1"><a href="#è§£å†³æ–¹æ¡ˆ-1" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><ol>
<li>çƒ­ç‚¹æ•°æ®æ°¸è¿œä¸è¿‡æœŸï¼Œå³åœ¨æ•°æ®è¿‡æœŸä¹‹é—´å¯ä»¥å…ˆè¿›è¡Œæ›´æ–°</li>
<li>ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œåªè®©ä¸€ä¸ªçº¿ç¨‹å»æŸ¥è¯¢ <code>db</code> å¹¶è¿”å›ç»“æœï¼Œä¸è¿‡è¿™ç§æ–¹å¼åœ¨é«˜å¹¶å‘ä¸‹æ¯”è¾ƒå½±å“æ€§èƒ½</li>
</ol>
<h2 id="ç¼“å­˜ç©¿é€"><a href="#ç¼“å­˜ç©¿é€" class="headerlink" title="ç¼“å­˜ç©¿é€"></a>ç¼“å­˜ç©¿é€</h2><h3 id="æ¦‚å¿µ-2"><a href="#æ¦‚å¿µ-2" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><p>ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½æ²¡æœ‰çš„æ•°æ®ï¼Œè¿˜æ˜¯æœ‰æºæºä¸æ–­çš„è¯·æ±‚åˆ°è¾¾ï¼Œå¯¼è‡´æ¯æ¬¡è¯·æ±‚éƒ½ä¼šåˆ°æ•°æ®åº“ï¼Œä»è€Œå‹å®æ•°æ®åº“</p>
<h3 id="è§£å†³æ–¹æ¡ˆ-2"><a href="#è§£å†³æ–¹æ¡ˆ-2" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><ol>
<li>å¯¹äºæŸ¥è¯¢æ•°æ®åº“ä¹Ÿä¸å­˜åœ¨çš„æ•°æ®ï¼Œä¾ç„¶å¯ä»¥å­˜æ”¾åœ¨ <code>redis</code> ä¸­ï¼Œå¹¶ä¸”è®¾ç½®ä¸€ä¸ªè¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´</li>
<li>ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨</li>
</ol>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>InnoDBå­˜å‚¨å¼•æ“è¯¦è§£</title>
    <url>/2023/a421bfc0bf81/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<h2 id="InnoDB-å­˜å‚¨å¼•æ“æ•°æ®æ“ä½œè¿‡ç¨‹"><a href="#InnoDB-å­˜å‚¨å¼•æ“æ•°æ®æ“ä½œè¿‡ç¨‹" class="headerlink" title="InnoDB å­˜å‚¨å¼•æ“æ•°æ®æ“ä½œè¿‡ç¨‹"></a>InnoDB å­˜å‚¨å¼•æ“æ•°æ®æ“ä½œè¿‡ç¨‹</h2><ol>
<li><code>InnoDB</code> å­˜å‚¨å¼•æ“æ˜¯åŸºäºç£ç›˜å­˜å‚¨çš„ï¼Œå¹¶å°†å…¶ä¸­çš„è®°å½•æŒ‰ç…§é¡µçš„æ–¹å¼è¿›è¡Œç®¡ç†, é¡µå¤§å°é»˜è®¤æ—¶ <code>16KB</code></li>
<li>ä»æ•°æ®åº“ä¸­è¯»å–æ•°æ®ï¼Œæ˜¯ä¼šå…ˆä»ç£ç›˜è¯»å–åˆ°ä¹Ÿæ”¾å…¥ç¼“å†²æ± ä¸­ï¼Œè¯¥è¿‡ç¨‹ç§°ä¸ºå°†é¡µ <code>Fix</code> åœ¨ç¼“å†²æ± ä¸­</li>
<li>å¯¹äºæ•°æ®åº“ä¸­é¡µçš„ä¿®æ”¹æ“ä½œï¼Œæ˜¯å…ˆä¿®æ”¹ç¼“å†²åŒºä¸­çš„é¡µ(å¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨æ­¥éª¤2è¿›è¡ŒåŠ è½½)ï¼Œç„¶åä½¿ç”¨ä¸€å®šçš„é¢‘ç‡åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œåˆ·æ–°æ•°æ®åˆ°ç£ç›˜æ˜¯é€šè¿‡ <code>Checkpoint</code> æœºåˆ¶å®ç°</li>
</ol>
<h2 id="ç¼“å†²æ± å†…å­˜æ•°æ®å¯¹è±¡"><a href="#ç¼“å†²æ± å†…å­˜æ•°æ®å¯¹è±¡" class="headerlink" title="ç¼“å†²æ± å†…å­˜æ•°æ®å¯¹è±¡"></a>ç¼“å†²æ± å†…å­˜æ•°æ®å¯¹è±¡</h2><pre class="mermaid">flowchart TB
  subgraph A["InnoDBå†…å­˜ç»“æ„"]
    B["é‡åšæ—¥å¿—ç¼“å†² \n(redo log buffer)"]
    C["é¢å¤–å†…å­˜"]
    subgraph D["ç¼“å†²æ± (innodb_buffer_pool)"]
      style D fill:green
      D1["æ•°æ®é¡µ"]
      D2["ç´¢å¼•é¡µ"]
      D3["æ’å…¥ç¼“å†²"]
      D4["é”ä¿¡æ¯"]
      D5["è‡ªé€‚åº”hashç´¢å¼•"]
      D6["æ•°æ®å­—å…¸ä¿¡æ¯"]
    end
    subgraph E["ç¼“å†²æ± (innodb_buffer_pool)"]
      style E fill:green
      E1["æ•°æ®é¡µ"]
      E2["ç´¢å¼•é¡µ"]
      E3["æ’å…¥ç¼“å†²"]
      E4["é”ä¿¡æ¯"]
      E5["è‡ªé€‚åº”hashç´¢å¼•"]
      E6["æ•°æ®å­—å…¸ä¿¡æ¯"]
    end
  end</pre>
<ol>
<li><code>InnoDB</code> å¼•æ“å…è®¸æœ‰å¤šä¸ª <code>Buffer Pool</code> å¯¹è±¡ï¼Œ æ¯ä¸ªé¡µå¯ä»¥æ ¹æ®å“ˆå¸Œå€¼å¹³å‡åˆ†é…åˆ°ä¸ç®—çš„ç¼“å†²æ± ä¸­ï¼Œè¿™æ ·å¯ä»¥æ£€æµ‹æ•°æ®åº“å†…éƒ¨çš„èµ„æºç«äº‰ï¼Œå¢åŠ æ•°æ®åº“çš„å¹¶å‘èƒ½åŠ›ï¼Œ å¯ä»¥é€šè¿‡ <code>innodb_buffer_pool_instances</code> æ¥è¿›è¡Œè®¾ç½®ï¼Œé»˜è®¤æ˜¯1</li>
</ol>
<h2 id="LRU-Listï¼ŒFree-List-å’Œ-Flush-List"><a href="#LRU-Listï¼ŒFree-List-å’Œ-Flush-List" class="headerlink" title="LRU Listï¼ŒFree List å’Œ Flush List"></a>LRU Listï¼ŒFree List å’Œ Flush List</h2><h3 id="Free-List-ç©ºé—²é“¾è¡¨"><a href="#Free-List-ç©ºé—²é“¾è¡¨" class="headerlink" title="Free List ç©ºé—²é“¾è¡¨"></a>Free List ç©ºé—²é“¾è¡¨</h3><ol>
<li><code>Free List</code> æ˜¯ <code>InnoDB</code> å­˜å‚¨å¼•æ“ä¸­ä¸€ä¸ªé‡è¦çš„æ•°æ®ç»“æ„ï¼Œå®ƒç”¨äºç®¡ç† <code>Buffer Pool</code> ä¸­çš„ç©ºé—²é¡µï¼Œå½“éœ€è¦ä½¿ç”¨ä¸€ä¸ªæ–°çš„é¡µçš„æ—¶å€™ï¼Œä¼šä»ç©ºé—²é“¾è¡¨ä¸­è·å–ä¸€ä¸ªé¡µï¼Œåœ¨æ•°æ®åº“åˆšè¿è¡Œæ—¶ï¼Œæ‰€æœ‰çš„é¡µéƒ½æ˜¯ç©ºé—²é¡µ</li>
</ol>
<h3 id="LRU-List-Latest-Recent-Used-æœ€è¿‘æœ€å°‘ä½¿ç”¨"><a href="#LRU-List-Latest-Recent-Used-æœ€è¿‘æœ€å°‘ä½¿ç”¨" class="headerlink" title="LRU List(Latest Recent Used) æœ€è¿‘æœ€å°‘ä½¿ç”¨"></a>LRU List(Latest Recent Used) æœ€è¿‘æœ€å°‘ä½¿ç”¨</h3><ol>
<li>æ•°æ®åº“ä¸­çš„ç¼“å†²æ± æ˜¯é€šè¿‡<code>LRU</code>ï¼ˆ<code>Latest Recent Used</code>ï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç®—æ³•æ¥ç®¡ç†ç¼“å­˜é¡µçš„ã€‚å³æœ€é¢‘ç¹ä½¿ç”¨çš„é¡µåœ¨ <code>LRU</code> åˆ—è¡¨çš„å‰ç«¯ï¼Œè€Œæœ€å°‘ä½¿ç”¨çš„é¡µåœ¨ <code>LRU</code> åˆ—è¡¨çš„å°¾ç«¯</li>
<li>å¯¹äº <code>InnoDB</code> è€Œè¨€ï¼Œæ•°æ®æ”¾åœ¨ç£ç›˜ä¸­å°±æ˜¯æ•°æ®é¡µï¼Œå½“æ•°æ®é¡µåŠ è½½åˆ°ç¼“å†²åŒºä¸­åå°±å˜æˆäº†ç¼“å­˜é¡µï¼ŒäºŒè€…å¤§å°æ˜¯ç›¸åŒçš„</li>
<li><code>InnoDB</code> ä¸­æ ¹æ® <strong>æ•°æ®å†·çƒ­åˆ†ç¦»æ€æƒ³</strong> å¯¹ <code>LRU</code> é“¾è¡¨è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä»ç£ç›˜ä¸­åŠ è½½çš„æ•°æ®é¡µé»˜è®¤å…ˆæ”¾åœ¨ <code>LRU</code> çš„å†·æ•°æ®åŒºåŸŸï¼Œæ»¡è¶³ä¸€å®šæ¡ä»¶åæ‰ä¼šå°†ç§»åŠ¨åˆ°çƒ­å–æ•°æ®åŒºåŸŸï¼ˆå†·æ•°æ®åŒºåŸŸé»˜è®¤å  3&#x2F;8ï¼‰ï¼Œå¯ä»¥é€šè¿‡ <code>innodb_old_blocks_pct</code> å‚æ•°ä¿®æ”¹</li>
<li><code>Mysql</code> çš„é¢„è¯»æœºåˆ¶å¯èƒ½ä¼šåŠ è½½å®é™…ä¸ä¼šä½¿ç”¨åˆ°çš„æ•°æ®åˆ°ç¼“å†²æ± ä¸­ï¼Œä¼šå ç”¨ç¼“å†²æ± çš„ç©ºé—´</li>
<li>é‡åˆ°ç±»ä¼¼ <code>select * from table</code> è¿™ç§å…¨è¡¨æ‰«æçš„è¯­å¥ï¼Œä¼šåŠ è½½å¤§é‡çš„ç£ç›˜ä¸­çš„æ•°æ®é¡µåˆ°ç¼“å†²åŒºä¸­ï¼Œä½†æ˜¯è¿™äº›æ•°æ®å¯èƒ½åªç”¨ä¸€æ¬¡å°±ä¸ç”¨äº†ï¼Œå¦‚æœç›´æ¥æ”¾åœ¨ <code>LRU</code> é“¾è¡¨å¤´éƒ¨å¯èƒ½ä¼šå°†å…¶ä»–å¸¸ç”¨çš„æ•°æ®æŒ¤å‡ºç¼“å†²åŒº</li>
</ol>
<h3 id="Flush-åˆ—è¡¨"><a href="#Flush-åˆ—è¡¨" class="headerlink" title="Flush åˆ—è¡¨"></a>Flush åˆ—è¡¨</h3><ol>
<li><code>LRU</code> é“¾è¡¨ä¸­ç®¡ç†çš„ç¼“å­˜é¡µè¢«ä¿®æ”¹ä¹‹åå°±ä¼šå˜æˆ <strong>è„é¡µ</strong>ï¼Œ è¿™äº›è„é¡µæœ€ç»ˆæ˜¯éœ€è¦å°†å…¶åˆ·æ–°åˆ°ç£ç›˜ä¸­çš„ï¼Œæ‰€ä»¥éœ€è¦å°†æ‰€æœ‰çš„è„é¡µæ”¾åœ¨ä¸€èµ·è¿›è¡Œç®¡ç†ï¼Œäºæ˜¯ <code>Flush List</code> å°±è¯ç”Ÿäº†</li>
<li><code>LRU</code> åˆ—è¡¨ç”¨æ¥ç®¡ç†ç¼“å†²æ± ä¸­é¡µçš„å¯ç”¨æ€§ï¼Œ<code>Flush</code>åˆ—è¡¨ç”¨æ¥ç®¡ç†å°†é¡µåˆ·æ–°å›ç£ç›˜ï¼ŒäºŒè€…äº’ä¸å½±å“</li>
</ol>
<h2 id="é‡åšæ—¥å¿—ç¼“å†²"><a href="#é‡åšæ—¥å¿—ç¼“å†²" class="headerlink" title="é‡åšæ—¥å¿—ç¼“å†²"></a>é‡åšæ—¥å¿—ç¼“å†²</h2><blockquote>
<p>InnoDB å­˜å‚¨å¼•æ“çš„å†…å­˜åŒºåŸŸé™¤äº†æœ‰ç¼“å†²æ± å¤–ï¼Œè¿˜æœ‰é‡åšæ—¥å¿—ç¼“å†²ï¼ˆredo log bufferï¼‰ã€‚InnoDBå­˜å‚¨å¼•æ“é¦–å…ˆå°†é‡åšæ—¥å¿—ä¿¡æ¯å…ˆæ”¾å…¥åˆ°è¿™ä¸ªç¼“å†²åŒºï¼Œç„¶åæŒ‰ä¸€å®šé¢‘ç‡å°†å…¶åˆ·æ–°åˆ°é‡åšæ—¥å¿—æ–‡ä»¶ã€‚é‡åšæ—¥å¿—ç¼“å†²ä¸€èˆ¬ä¸éœ€è¦è®¾ç½®å¾—å¾ˆå¤§ï¼Œå› ä¸ºä¸€èˆ¬æƒ…å†µä¸‹æ¯ä¸€ç§’é’Ÿä¼šå°†é‡åšæ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œå› æ­¤ç”¨æˆ·åªéœ€è¦ä¿è¯æ¯ç§’äº§ç”Ÿçš„äº‹åŠ¡é‡åœ¨è¿™ä¸ªç¼“å†²å¤§å°ä¹‹å†…å³å¯ã€‚è¯¥å€¼å¯ç”±é…ç½®å‚æ•°innodb_log_buffer_sizeæ§åˆ¶ï¼Œé»˜è®¤ä¸º8MB</p>
</blockquote>
<h3 id="é‡åšæ—¥å¿—ç¼“å†²åˆ·ç›˜æ—¶æœº"><a href="#é‡åšæ—¥å¿—ç¼“å†²åˆ·ç›˜æ—¶æœº" class="headerlink" title="é‡åšæ—¥å¿—ç¼“å†²åˆ·ç›˜æ—¶æœº"></a>é‡åšæ—¥å¿—ç¼“å†²åˆ·ç›˜æ—¶æœº</h3><ol>
<li><code>Master Thread</code> æ¯ä¸€ç§’å°†é‡åšæ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°é‡åšæ—¥å¿—æ–‡ä»¶ï¼›</li>
<li>æ¯ä¸ªäº‹åŠ¡æäº¤æ—¶ä¼šå°†é‡åšæ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°é‡åšæ—¥å¿—æ–‡ä»¶ï¼›</li>
<li>å½“é‡åšæ—¥å¿—ç¼“å†²æ± å‰©ä½™ç©ºé—´å°äº1&#x2F;2æ—¶ï¼Œé‡åšæ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°é‡åšæ—¥å¿—æ–‡ä»¶ã€‚</li>
</ol>
<h2 id="Checkpoint-æŠ€æœ¯"><a href="#Checkpoint-æŠ€æœ¯" class="headerlink" title="Checkpoint æŠ€æœ¯"></a>Checkpoint æŠ€æœ¯</h2><h3 id="redo-äº§ç”ŸèƒŒæ™¯"><a href="#redo-äº§ç”ŸèƒŒæ™¯" class="headerlink" title="redo äº§ç”ŸèƒŒæ™¯"></a>redo äº§ç”ŸèƒŒæ™¯</h3><ol>
<li>æ•°æ®é¡µåŠ è½½åˆ°ç¼“å†²åŒºå˜æˆç¼“å­˜é¡µï¼Œç¼“å­˜é¡µè¢«ä¿®æ”¹åå°±å˜æˆè„é¡µï¼Œè„é¡µæœ€ç»ˆæ˜¯è¦åˆ·å›ç£ç›˜ï¼Œå¦‚æœç¼“å­˜é¡µæœ‰å˜åŒ–å°±åˆ·ç›˜é‚£ä¹ˆæ€§èƒ½å¾ˆå·®ï¼ˆç£ç›˜éšæœºè¯»å†™ï¼‰ï¼Œå¦‚æœå¾ˆä¹…éƒ½ä¸åˆ·ç›˜ï¼Œå¯èƒ½ä¼šæœ‰æ•°æ®ä¸¢å¤±çš„æƒ…å†µ</li>
<li>ä¸ºäº†é¿å…æ•°æ®ä¸¢å¤±ï¼Œå¾ˆå¤šç³»ç»Ÿæ™®é <code>Write Ahead Log</code> ç­–ç•¥ï¼Œå³å½“äº‹åŠ¡æäº¤æ—¶ï¼Œå…ˆå†™é‡åšæ—¥å¿—ï¼Œå†ä¿®æ”¹é¡µã€‚å½“ç”±äºå‘ç”Ÿå®•æœºè€Œå¯¼è‡´æ•°æ®ä¸¢å¤±æ—¶ï¼Œé€šè¿‡é‡åšæ—¥å¿—æ¥å®Œæˆæ•°æ®çš„æ¢å¤ï¼ˆæ—¥å¿—æ˜¯ç£ç›˜é¡ºåºå†™ï¼‰</li>
</ol>
<h3 id="checkpoint-ä½œç”¨"><a href="#checkpoint-ä½œç”¨" class="headerlink" title="checkpoint ä½œç”¨"></a>checkpoint ä½œç”¨</h3><p>ä»ä¸Šé¢ä¸¤ç‚¹å¯ä»¥çŸ¥é“ <code>redo</code> æ—¥å¿—çš„ä½œç”¨ï¼Œä½†æ˜¯ <code>redo</code> æ—¥å¿—æ–‡ä»¶ä¹Ÿä¸å¯èƒ½æ— é™å¤§ï¼Œå³ä½¿å¯ä»¥æ— é™å¤§ï¼Œæœ€ç»ˆæ•°æ®æ¢å¤æ—¶é—´ä¹Ÿå¾ˆæ¼«é•¿ï¼Œæ‰€ä»¥æ‰å¼•å…¥ <code>checkpoint</code> æŠ€æœ¯ï¼Œä¸»è¦è§£å†³ä»¥ä¸‹å‡ ä¸ªé—®é¢˜</p>
<ol>
<li>ç¼©çŸ­æ•°æ®åº“çš„æ¢å¤æ—¶é—´</li>
<li>ç¼“å†²åŒºä¸å¤Ÿç”¨æ—¶ï¼Œå°†è„é¡µåˆ·æ–°åˆ°ç£ç›˜</li>
<li>é‡åšæ—¥å¿—ä¸å¯ç”¨æ—¶ï¼Œåˆ·æ–°è„é¡µ</li>
<li>å› ä¸ºé‡åšæ—¥å¿—ä¸æ˜¯æ— é™å¤§ï¼Œè€Œæ˜¯å¾ªç¯ä½¿ç”¨ï¼Œæ‰€ä»¥å½“è®¾ç½®çš„å¤§å°éƒ½è¢«å ç”¨äº†ï¼Œå°±éœ€è¦å°†è„é¡µæ•°æ®åˆ·ç›˜</li>
</ol>
<p>å¯ä»¥è®¤ä¸º <code>checkpoint</code> å°±æ˜¯ä¸€ä¸ªä¸´ç•Œç‚¹ï¼Œåœ¨ <code>checkpoint</code> ä¹‹å‰çš„æ•°æ®éƒ½å·²ç»å­˜åœ¨ç£ç›˜ä¸Šäº†ï¼Œåœ¨ <code>checkpoint</code> ä¹‹åçš„æ•°æ®å­˜åœ¨ <code>redo</code> æ—¥å¿—å’Œç¼“å­˜é¡µä¸­</p>
<h3 id="checkpoint-å®ç°"><a href="#checkpoint-å®ç°" class="headerlink" title="checkpoint å®ç°"></a>checkpoint å®ç°</h3><ol>
<li>å¯¹äº <code>InnoDB</code> å­˜å‚¨å¼•æ“è€Œè¨€ï¼Œå…¶æ˜¯é€šè¿‡<code>LSNï¼ˆLog Sequence Numberï¼‰</code>æ¥æ ‡è®°ç‰ˆæœ¬çš„ï¼Œ <code>LSN</code> æ˜¯8å­—èŠ‚çš„æ•°å­—ï¼Œ æ¯ä¸ªæ•°æ®é¡µéƒ½æœ‰ <code>LSN</code></li>
<li>é‡åšæ—¥å¿—å’Œ <code>Checkpoint</code> éƒ½ä¼š <code>LSN</code>, å¯ä»¥é€šè¿‡å‘½ä»¤ <code>show engine innodb status\G</code> æŸ¥çœ‹ <code>innodb</code> å¼•æ“ä¿¡æ¯ï¼Œå…¶ä¸­å°±åŒ…å« <code>LSN</code>ï¼Œ æ¯”å¦‚å¦‚ä¸‹æ‰€ç¤º<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">Log</span> <span class="hljs-keyword">sequence</span> number <span class="hljs-number">92561351052</span> <br><span class="hljs-keyword">Log</span> flushed up <span class="hljs-keyword">to</span> <span class="hljs-number">92561351052</span> <br>Last <span class="hljs-keyword">checkpoint</span> at <span class="hljs-number">92561351052</span><br></code></pre></td></tr></table></figure></li>
<li>åœ¨ <code>InnoDB</code> å­˜å‚¨å¼•æ“å†…éƒ¨ï¼Œæœ‰ä¸¤ç§ <code>Checkpoint</code></li>
<li><strong>Sharp Checkpoint</strong>: å‘ç”Ÿåœ¨æ•°æ®åº“å…³é—­æ—¶ï¼Œéœ€è¦å°†æ‰€æœ‰çš„è„é¡µéƒ½åˆ·æ–°ä¼šç£ç›˜ï¼Œå¯¹åº”çš„æ˜¯ <code>innodb_fast_shutdown=1</code>, ä¹Ÿæ˜¯é»˜è®¤çš„è¡Œä¸º</li>
<li><strong>Fuzzy Checkpoint</strong>ï¼š <code>InnoDB</code> å­˜å‚¨å¼•æ“å†…éƒ¨ä½¿ç”¨ <code>Fuzzy Checkpoint</code>è¿›è¡Œé¡µçš„åˆ·æ–°ï¼Œå³åªåˆ·æ–°ä¸€éƒ¨åˆ†è„é¡µï¼Œè€Œä¸æ˜¯åˆ·æ–°æ‰€æœ‰çš„è„é¡µå›ç£ç›˜</li>
</ol>
<h4 id="Fuzzy-Checkpoint-åˆ·ç›˜æ—¶æœº"><a href="#Fuzzy-Checkpoint-åˆ·ç›˜æ—¶æœº" class="headerlink" title="Fuzzy Checkpoint åˆ·ç›˜æ—¶æœº"></a>Fuzzy Checkpoint åˆ·ç›˜æ—¶æœº</h4><ol>
<li>Master Thread Checkpoint</li>
<li>å·®ä¸å¤šä»¥æ¯ç§’æˆ–æ¯åç§’çš„é€Ÿåº¦ä»ç¼“å†²æ± çš„è„é¡µåˆ—è¡¨ä¸­åˆ·æ–°ä¸€å®šæ¯”ä¾‹çš„é¡µå›ç£ç›˜ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯å¼‚æ­¥çš„</li>
<li>FLUSH_LRU_LIST Checkpoint</li>
<li><code>InnoDB</code> å­˜å‚¨å¼•æ“éœ€è¦ä¿è¯ <code>LRU</code> åˆ—è¡¨ä¸­éœ€è¦æœ‰å·®ä¸å¤š100ä¸ªç©ºé—²é¡µå¯ä¾›ä½¿ç”¨, å…·ä½“å¤šå°‘ä¸ªå¯ä»¥é€šè¿‡å‚æ•° <code>innodb_lru_scan_depth</code> æ§åˆ¶</li>
<li>å½“å‘ç° <code>LRU</code> åˆ—è¡¨ä¸­æ²¡æœ‰é‚£ä¹ˆå¤šç©ºé—²é¡µæ—¶ï¼Œå°±éœ€è¦å°† <code>LRU</code> å°¾ç«¯çš„é¡µç§»é™¤ï¼Œå¦‚æœè¿™äº›é¡µæœ‰è„é¡µï¼Œå°±éœ€è¦è¿›è¡Œ <code>checkpoint</code></li>
<li>Async&#x2F;Sync Flush Checkpoint</li>
<li>å½“é‡åšæ—¥å¿—ä¸å¯ç”¨æ—¶ï¼Œéœ€è¦ä»è„é¡µä¸­å¼ºåˆ¶å°†ä¸€äº›é¡µè¿›è¡Œåˆ·ç›˜</li>
<li>Dirty Page too much Checkpoint</li>
<li>å½“è„é¡µçš„æ•°é‡å¤ªå¤šæ—¶ï¼Œä¸ºäº†ä¿è¯ç¼“å†²åŒºä»æœ‰ç©ºé—´å¯ç”¨ï¼Œä¹Ÿä¼šå¼ºåˆ¶å°†ä¸€äº›è„é¡µåˆ·ç›˜ï¼Œ å¯ä»¥é€šè¿‡å‚æ•° <code>innodb_max_dirty_pages_pct</code> æ§åˆ¶è„é¡µå æ¯”ï¼Œé»˜è®¤æ˜¯ <code>75%</code>ï¼Œ å³å½“ç¼“å†²æ± ä¸­è„é¡µæ•°é‡å åˆ°äº† <code>75%</code> ä¼šå¼ºåˆ¶ <code>checkpoint</code></li>
</ol>
<h2 id="Master-çº¿ç¨‹"><a href="#Master-çº¿ç¨‹" class="headerlink" title="Master çº¿ç¨‹"></a>Master çº¿ç¨‹</h2><ol>
<li><p><code>Master Thread</code> å…·æœ‰æœ€é«˜çš„çº¿ç¨‹ä¼˜å…ˆçº§åˆ«ã€‚å†…éƒ¨ç”±å¤šä¸ªå¾ªç¯ï¼ˆ<code>loop</code>ï¼‰ç»„æˆ</p>
</li>
<li><p><code>Master Thread</code> ä¼šæ ¹æ®æ•°æ®åº“è¿è¡Œçš„çŠ¶æ€åœ¨ <code>loop</code>ã€<code>background loop</code>ã€<code>flush loop</code>å’Œ<code>suspend loop</code>ä¸­è¿›è¡Œåˆ‡æ¢</p>
</li>
</ol>
<p><strong>ä¸»å¾ªç¯ï¼ˆloopï¼‰</strong></p>
<ul>
<li>æ¯ <code>1s</code> çš„æ“ä½œ<ol>
<li>æ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°ç£ç›˜ï¼Œå³ä½¿è¿™ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰æï¼ˆæ€»æ˜¯ï¼‰</li>
<li>åˆå¹¶æ’å…¥ç¼“å†²ï¼ˆå¯èƒ½ï¼‰</li>
<li>è‡³å¤šåˆ·æ–°100ä¸ª <code>InnoDB</code> çš„ç¼“å†²æ± ä¸­çš„è„é¡µç£ç›˜ï¼ˆå¯èƒ½ï¼‰</li>
<li>å¦‚æœå½“å‰æ²¡æœ‰ç”¨æˆ·æ´»åŠ¨ï¼Œåˆ™åˆ‡æ¢åˆ°<code>background loop</code>ï¼ˆå¯èƒ½ï¼‰</li>
</ol>
</li>
<li>æ¯ <code>10s</code> çš„æ“ä½œ<ol>
<li>åˆ·æ–°100ä¸ªè„é¡µåˆ°ç£ç›˜ï¼ˆå¯èƒ½ï¼‰</li>
<li>åˆå¹¶è‡³å¤š5ä¸ªæ’å…¥ç¼“å†²ï¼ˆæ€»æ˜¯ï¼‰</li>
<li>å°†æ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°ç£ç›˜ï¼ˆæ€»æ˜¯ï¼‰</li>
<li>åˆ é™¤æ— ç”¨çš„ <code>Undo</code> é¡µï¼ˆæ€»æ˜¯ï¼‰</li>
</ol>
</li>
</ul>
<p><strong>åå°å¾ªç¯ï¼ˆbackgroup loopï¼‰</strong></p>
<p>è‹¥å½“å‰æ²¡æœ‰ç”¨æˆ·æ´»åŠ¨ï¼ˆæ•°æ®åº“ç©ºé—²æ—¶ï¼‰æˆ–è€…æ•°æ®åº“å…³é—­ï¼ˆ<code>shutdown</code>ï¼‰ï¼Œå°±ä¼šåˆ‡æ¢åˆ°è¿™ä¸ªå¾ªç¯, ä¼šå­˜åœ¨ä»¥ä¸‹æ“ä½œ</p>
<ul>
<li>åˆ é™¤æ— ç”¨çš„ <code>Undo</code> é¡µï¼ˆæ€»æ˜¯ï¼‰</li>
<li>åˆå¹¶20ä¸ªæ’å…¥ç¼“å†²ï¼ˆæ€»æ˜¯ï¼‰</li>
<li>è·³å›åˆ°ä¸»å¾ªç¯ï¼ˆæ€»æ˜¯ï¼‰</li>
<li>ä¸æ–­åˆ·æ–°100ä¸ªé¡µç›´åˆ°ç¬¦åˆæ¡ä»¶ï¼ˆå¯èƒ½ï¼Œè·³è½¬åˆ°<code>flush loop</code>ä¸­å®Œæˆï¼‰</li>
</ul>
<p><strong>åˆ·æ–°å¾ªç¯ï¼ˆflush loopï¼‰</strong> </p>
<p>ä¸»è¦æ˜¯å°†ç¼“å†²åŒºè„é¡µæ•°æ®åˆ·æ–°åˆ°ç£ç›˜</p>
<p><strong>æš‚åœå¾ªç¯ï¼ˆsuspend loopï¼‰</strong><br>è‹¥ <code>flush loop</code> ä¸­ä¹Ÿæ²¡æœ‰ä»€ä¹ˆäº‹æƒ…å¯ä»¥åšäº†ï¼Œ<code>InnoDB</code>å­˜å‚¨å¼•æ“ä¼šåˆ‡æ¢åˆ°<code>suspend loop</code>ï¼Œå°†<code>Master Thread</code>æŒ‚èµ·ï¼Œç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿ</p>
<p>åœ¨ <code>InnoDB1.2.x</code>ç‰ˆæœ¬ä¸­ä» <code>Master Thread</code> çº¿ç¨‹åˆ†ç¦»åˆ°ä¸€ä¸ªå•ç‹¬çš„<code> Page Cleaner Thread</code>ï¼Œä»è€Œå‡è½»äº†<code>Master Thread</code>çš„å·¥ä½œï¼ŒåŒæ—¶è¿›ä¸€æ­¥æé«˜äº†ç³»ç»Ÿçš„å¹¶å‘æ€§</p>
<h2 id="æ’å…¥ç¼“å†²-Insert-Buffer"><a href="#æ’å…¥ç¼“å†²-Insert-Buffer" class="headerlink" title="æ’å…¥ç¼“å†² Insert Buffer"></a>æ’å…¥ç¼“å†² Insert Buffer</h2><h3 id="Insert-Buffer-åœ¨å“ªé‡Œ"><a href="#Insert-Buffer-åœ¨å“ªé‡Œ" class="headerlink" title="Insert Buffer åœ¨å“ªé‡Œ"></a>Insert Buffer åœ¨å“ªé‡Œ</h3><p><code>Insert Buffer</code>å’Œæ•°æ®é¡µä¸€æ ·ï¼Œä¹Ÿæ˜¯ç‰©ç†é¡µçš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼ˆç¼“å†²åŒºä¸­ä¹Ÿæœ‰ <code>Insert Buffer</code>, å«ä¹‰ä¸åŒï¼‰</p>
<h3 id="ä¸ºä»€ä¹ˆè¦æœ‰-Insert-Buffer"><a href="#ä¸ºä»€ä¹ˆè¦æœ‰-Insert-Buffer" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æœ‰ Insert Buffer"></a>ä¸ºä»€ä¹ˆè¦æœ‰ Insert Buffer</h3><ol>
<li>æ¯ä¸ªè¡¨éƒ½æœ‰ä¸€ä¸ªä¸»é”®ï¼Œå¦‚æœæ˜¯è‡ªå¢çš„é‚£ä¹ˆæ•°æ®æ˜¯æŒ‰ç…§ä¸»é”®é¡ºåºå­˜å‚¨çš„ï¼Œè¿™ç§æƒ…å†µä¸‹æ•°æ®æ–°å¢æ˜¯å¾ˆå¿«çš„ï¼Œå› ä¸ºæ˜¯æœ‰é¡ºåºçš„</li>
<li>å¦‚æœä¸»é”®ä¸æ˜¯è‡ªå¢çš„ï¼Œæˆ–è€…å…¶ä»–éèšé›†ç´¢å¼•ï¼ˆå…ˆç†è§£æˆéä¸»é”®ç´¢å¼•ï¼‰éƒ½å¯èƒ½ä¸æ˜¯è‡ªå¢çš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®é¡µçš„å­˜æ”¾è¿˜æ˜¯æŒ‰ä¸»é”®è¿›è¡Œé¡ºåºå­˜æ”¾çš„ï¼Œä½†æ˜¯å¯¹äºéèšé›†ç´¢å¼•å¶å­èŠ‚ç‚¹çš„æ’å…¥ä¸å†æ˜¯é¡ºåºçš„äº†ï¼Œè¿™æ—¶å°±éœ€è¦ç¦»æ•£åœ°è®¿é—®éèšé›†ç´¢å¼•é¡µï¼Œç”±äºéšæœºè¯»å–çš„å­˜åœ¨è€Œå¯¼è‡´äº†æ’å…¥æ“ä½œæ€§èƒ½ä¸‹é™</li>
<li><code>Insert Buffer</code> çš„ä½œç”¨å°±æ˜¯å¯¹äºéèšé›†ç´¢å¼•çš„æ’å…¥æˆ–æ›´æ–°æ“ä½œï¼Œä¸æ˜¯æ¯ä¸€æ¬¡ç›´æ¥æ’å…¥åˆ°ç´¢å¼•é¡µä¸­ï¼Œè€Œæ˜¯å…ˆåˆ¤æ–­æ’å…¥çš„éèšé›†ç´¢å¼•é¡µæ˜¯å¦åœ¨ç¼“å†²æ± ä¸­ï¼Œè‹¥åœ¨ï¼Œåˆ™ç›´æ¥æ’å…¥ï¼›è‹¥ä¸åœ¨ï¼Œåˆ™å…ˆæ”¾å…¥åˆ°ä¸€ä¸ª<code>Insert Buffer</code>å¯¹è±¡ä¸­ï¼Œ ç„¶åå†ä»¥ä¸€å®šçš„é¢‘ç‡å’Œæƒ…å†µè¿›è¡Œ<code>Insert Buffer</code>å’Œè¾…åŠ©ç´¢å¼•é¡µå­èŠ‚ç‚¹çš„<code>merge</code>ï¼ˆåˆå¹¶ï¼‰æ“ä½œï¼Œè¿™æ—¶é€šå¸¸èƒ½å°†å¤šä¸ªæ’å…¥åˆå¹¶åˆ°ä¸€ä¸ªæ“ä½œä¸­ï¼ˆå› ä¸ºåœ¨ä¸€ä¸ªç´¢å¼•é¡µä¸­ï¼‰ï¼Œè¿™å°±å¤§å¤§æé«˜äº†å¯¹äºéèšé›†ç´¢å¼•æ’å…¥çš„æ€§èƒ½</li>
</ol>
<h3 id="ä½¿ç”¨-Insert-Buffer-éœ€è¦æ»¡è¶³çš„æ¡ä»¶"><a href="#ä½¿ç”¨-Insert-Buffer-éœ€è¦æ»¡è¶³çš„æ¡ä»¶" class="headerlink" title="ä½¿ç”¨ Insert Buffer éœ€è¦æ»¡è¶³çš„æ¡ä»¶"></a>ä½¿ç”¨ Insert Buffer éœ€è¦æ»¡è¶³çš„æ¡ä»¶</h3><ol>
<li>ç´¢å¼•æ˜¯è¾…åŠ©ç´¢å¼•</li>
<li>ç´¢å¼•ä¸æ˜¯å”¯ä¸€çš„ï¼š å¦‚æœç´¢å¼•å”¯ä¸€ï¼Œå°±è¿˜éœ€è¦æŸ¥æ‰¾åˆ¤æ–­æ“ä½œï¼Œæ­¤æ—¶ä½¿ç”¨ <code>Insert Buffer</code> å°±ä¸èƒ½æå‡æ€§èƒ½äº†</li>
</ol>
<p>æ‰€ä»¥ <code>Insert Buffer</code> ä¸»è¦æ˜¯ä¸ºäº†æé«˜ç´¢å¼•é¡µæ•°æ®æ’å…¥çš„æ€§èƒ½</p>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>InnoDBå­˜å‚¨å¼•æ“ä¹‹MVCCè¯¦è§£</title>
    <url>/2023/7aa9bac70e9b/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>


<h2 id="mysql8-æŸ¥çœ‹äº‹åŠ¡çš„éš”ç¦»çº§åˆ«"><a href="#mysql8-æŸ¥çœ‹äº‹åŠ¡çš„éš”ç¦»çº§åˆ«" class="headerlink" title="mysql8 æŸ¥çœ‹äº‹åŠ¡çš„éš”ç¦»çº§åˆ«"></a>mysql8 æŸ¥çœ‹äº‹åŠ¡çš„éš”ç¦»çº§åˆ«</h2><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- æŸ¥çœ‹å½“å‰ä¼šè¯çš„éš”ç¦»çº§åˆ«</span><br><span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@transaction_isolation</span>;<br><span class="hljs-comment">-- æŸ¥çœ‹å…¨å±€çš„éš”ç¦»çº§åˆ«</span><br><span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@global</span>.transaction_isolation;<br></code></pre></td></tr></table></figure>

<h2 id="undo-log-ç‰ˆæœ¬é“¾"><a href="#undo-log-ç‰ˆæœ¬é“¾" class="headerlink" title="undo log ç‰ˆæœ¬é“¾"></a>undo log ç‰ˆæœ¬é“¾</h2><ul>
<li>æ¯ä¸€æ¡æ•°æ®éƒ½æœ‰ä¸¤ä¸ªéšè—å­—æ®µ<ul>
<li><code>trx_id</code>: äº‹åŠ¡id</li>
<li><code>roll_pointer</code>: æŒ‡å‘äº†æ›´æ–°è¿™ä¸ªäº‹åŠ¡ä¹‹å‰çš„ <code>undo log</code></li>
</ul>
</li>
</ul>
<h3 id="trx-id-çš„ä½œç”¨"><a href="#trx-id-çš„ä½œç”¨" class="headerlink" title="trx_id çš„ä½œç”¨"></a>trx_id çš„ä½œç”¨</h3><p>åœ¨ <code>InnoDB</code> å­˜å‚¨å¼•æ“ä¸­ï¼Œ<code>trx_id</code> æ˜¯ä¸€ä¸ªç”¨äº<strong>æ ‡è¯†äº‹åŠ¡çš„å”¯ä¸€æ ‡è¯†ç¬¦</strong>ã€‚<code>trx_id</code> çš„ç”Ÿæˆæ—¶æœºæ˜¯åœ¨äº‹åŠ¡å¼€å§‹æ—¶ç”Ÿæˆçš„</p>
<p>ä¸‹é¢ä¸¾ä¾‹è¯´æ˜ï¼Œæ¯”å¦‚æ–°å¢ä¸€æ¡æ•°æ®ï¼Œäº‹åŠ¡ id ä¸º10ï¼Œå› ä¸ºä¹‹å‰æ²¡æœ‰æ•°æ®ï¼Œæ‰€ä»¥ <code>roll_pointer</code> æŒ‡å‘ <code>null</code></p>
<pre class="mermaid">graph LR
    subgraph A["äº‹åŠ¡A"]
        direction LR
        A1["å€¼A"]
        A2["trx_id=10"]
        A3["roll_pointer"]
        A1~~~A2~~~A3
    end</pre>

<p>æ¥ä¸‹æ¥å¦å¤–ä¸€ä¸ªäº‹åŠ¡å¯åŠ¨ï¼Œæ›´æ–°åŒä¸€æ¡æ•°æ®ï¼Œå°†å€¼ä» A æ”¹ä¸º B, æ­¤æ—¶å¯¹åº”æ•°æ®çŠ¶æ€ä¸º</p>
<pre class="mermaid">graph LR
    subgraph A["äº‹åŠ¡A"]
        direction LR
        A1["å€¼A"]
        A2["trx_id=10"]
        A3["roll_pointer"]
        A1~~~A2~~~A3
    end
    subgraph B["äº‹åŠ¡B"]
        direction LR
        B1["å€¼B"]
        B2["trx_id=15"]
        B3["roll_pointer"]
        B1~~~B2~~~B3
    end
    B3-.->A3
    style B3 fill:#8ff600
    style A3 fill:#8ff600</pre>

<p>åå¯åŠ¨çš„äº‹åŠ¡çš„ <code>roll_pointer</code> æŒ‡å‘äº†å‰é¢çš„æ•°æ®</p>
<p>å½“è¿˜æœ‰å…¶ä»–äº‹åŠ¡æ¥ä¿®æ”¹è¿™æ¡æ•°æ®æ—¶ï¼Œå¯¹åº”çš„æ•°æ®çŠ¶æ€ä¸º</p>
<pre class="mermaid">graph LR
    subgraph A["äº‹åŠ¡A"]
        direction LR
        A1["å€¼A"]
        A2["trx_id=10"]
        A3["roll_pointer"]
        A1~~~A2~~~A3
    end
    subgraph B["äº‹åŠ¡B"]
        direction LR
        B1["å€¼B"]
        B2["trx_id=15"]
        B3["roll_pointer"]
        B1~~~B2~~~B3
    end
    subgraph C["äº‹åŠ¡C"]
        direction LR
        C1["å€¼C"]
        C2["trx_id=20"]
        C3["roll_pointer"]
        C1~~~C2~~~C3
    end
    C3-.->B3-.->A3
    style B3 fill:#8ff600
    style A3 fill:#8ff600
    style C3 fill:#8ff600</pre>

<p>è¿™å°±æ˜¯ <code>undo log</code> ç‰ˆæœ¬é“¾ï¼Œä¹Ÿæ˜¯ <code>MVCC</code> çš„å®ç°åŸºç¡€ï¼Œ å¦å¤–ä¸€ä¸ªå®ç°åŸºç¡€æ˜¯ <code>ReadView</code> æœºåˆ¶</p>
<h2 id="ReadView-æœºåˆ¶"><a href="#ReadView-æœºåˆ¶" class="headerlink" title="ReadView æœºåˆ¶"></a>ReadView æœºåˆ¶</h2><p>å½“æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡çš„æ—¶å€™ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ª <code>ReadView</code>ï¼Œ <code>ReadView</code> ä¸­æ¯”è¾ƒé‡è¦çš„æœ‰å››ä¸ªå­—æ®µ</p>
<ol>
<li><code>m_ids</code>: å½“å‰äº‹åŠ¡å¼€å§‹æ—¶ï¼Œè¿˜æœ‰å“ªäº›äº‹åŠ¡ä¹Ÿæ­£åœ¨æ‰§è¡Œï¼ˆå³è¿˜æäº¤çš„äº‹åŠ¡ï¼‰</li>
<li><code>min_trx_id</code>: <code>m_ids</code> ä¸­æœ€å°çš„å€¼</li>
<li><code>max_trx_id</code>: <code>Mysql</code> ä¸‹ä¸€ä¸ªè¦ç”Ÿæˆçš„äº‹åŠ¡id</li>
<li><code>creator_trx_id</code>: å½“å‰äº‹åŠ¡çš„id</li>
</ol>
<h3 id="ReadView-ç”Ÿæˆæ—¶æœº"><a href="#ReadView-ç”Ÿæˆæ—¶æœº" class="headerlink" title="ReadView ç”Ÿæˆæ—¶æœº"></a>ReadView ç”Ÿæˆæ—¶æœº</h3><p>å‰é¢æœ‰æåˆ° <code>trx_id</code> çš„ç”Ÿæˆæ—¶æœºæ˜¯åœ¨äº‹åŠ¡å¼€å§‹æ—¶ç”Ÿæˆçš„ï¼Œè€Œ <code>ReadView</code> å¹¶ä¸æ˜¯åœ¨äº‹åŠ¡å¼€å§‹æ—¶ç”Ÿæˆçš„ï¼Œè€Œæ˜¯åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œè¯»æ“ä½œæ“ä½œæ—¶æ‰ä¼šç”Ÿæˆ <code>ReadView</code></p>
<p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨å½“å‰äº‹åŠ¡çš„ <code>ReadView</code> ä¸­å¯èƒ½ä¼šå­˜åœ¨äº‹åŠ¡id æ¯”å½“å‰äº‹åŠ¡id å¤§çš„äº‹åŠ¡å­˜åœ¨</p>
<h2 id="RCï¼ˆRead-Commitedï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†"><a href="#RCï¼ˆRead-Commitedï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†" class="headerlink" title="RCï¼ˆRead Commitedï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†"></a>RCï¼ˆRead Commitedï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†</h2><p><code>RC</code> éš”ç¦»çº§åˆ«æŒ‡çš„æ˜¯ä¸€ä¸ªäº‹åŠ¡ä¸­å¯ä»¥è¯»å–åˆ°å…¶ä»–äº‹åŠ¡æäº¤çš„æ•°æ®ï¼Œå…¶ä»–äº‹åŠ¡æœªæäº¤æ•°æ®æ— æ³•è¯»å–åˆ°</p>
<p>ä¸‹é¢ä¸¾ä¾‹è¯´æ˜å¦‚ä½•åŸºäº <code>undo log</code> å’Œ <code>ReadView</code> æœºåˆ¶å®ç° <code>RC</code> éš”ç¦»çº§åˆ«</p>
<p>db ä¸­æŸæ¡æ•°æ®çš„åˆå§‹å€¼ <code>trx_id=10</code><br>åœ¨æŸä¸ªæ—¶åˆ»æœ‰äº‹åŠ¡ A å’Œ äº‹åŠ¡ B åŒæ—¶æ“ä½œè¿™æ¡æ•°æ®ï¼Œäº‹åŠ¡A æ˜¯æŸ¥è¯¢ï¼Œäº‹åŠ¡Bæ˜¯ä¿®æ”¹ï¼Œæˆ‘ä»¬çš„è§‚å¯Ÿè§’åº¦æ˜¯äº‹åŠ¡A</p>
<p><strong>äº‹åŠ¡Bä¿®æ”¹äº†æ•°æ®ä½†æœªæäº¤</strong><br>å› ä¸ºäº‹åŠ¡B ä¿®æ”¹äº†æ•°æ®ï¼Œæ­¤æ—¶ <code>undo log</code> ç‰ˆæœ¬é“¾å¦‚ä¸‹æ‰€ç¤º</p>
<pre class="mermaid">graph LR
    subgraph A["åˆå§‹æ•°æ®"]
        direction LR
        A1["åˆå§‹å€¼"]
        A2["trx_id=10"]
        A3["roll_pointer"]
        A1~~~A2~~~A3
    end
    subgraph B["äº‹åŠ¡B"]
        direction LR
        B1["å€¼B"]
        B2["trx_id=15"]
        B3["roll_pointer"]
        B1~~~B2~~~B3
    end
    B3-.->A3
    style B3 fill:#8ff600
    style A3 fill:#8ff600</pre>

<p><strong>äº‹åŠ¡Aè¯»å–æ•°æ®</strong><br>äº‹åŠ¡A æ‰§è¡Œ <code>select</code> æ“ä½œæ—¶ï¼Œå°±ä¼šç”Ÿæˆ <code>ReadView</code>ï¼Œ æ­¤æ—¶ <code>ReadView</code> æ¶‰åŠåˆ°çš„å€¼å¦‚ä¸‹æ‰€ç¤º<br>äº‹åŠ¡A(trx_id&#x3D;15), äº‹åŠ¡B(trx_id&#x3D;20)<br><code>m_ids</code>: [15, 20]<br><code>min_trx_id</code>: 15<br><code>max_trx_id</code>: 21<br><code>creator_trx_id</code>: 15</p>
<p>è¯»å–åˆ°æ•°æ®B, è¿™æ¡æ•°æ®çš„ <code>trx_id=20</code>, <code>trx_id</code> æ¯”è‡ªå·±çš„äº‹åŠ¡idå¤§ï¼Œä½†æ˜¯<strong>åœ¨</strong> <code>m_ids</code> ä¸­ï¼Œè¯´æ˜è¿™æ¡æ•°æ®æ˜¯å’Œäº‹åŠ¡A å·®ä¸å¤šåŒæ—¶å¯åŠ¨çš„äº‹åŠ¡æ“ä½œçš„ï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰æäº¤ï¼Œé‚£ä¹ˆäº‹åŠ¡A å°±ä¸èƒ½è¿›è¡Œè¯»å–ï¼Œéœ€è¦é¡ºç€ <code>undo log</code> ç‰ˆæœ¬é“¾ç»§ç»­å¯»æ‰¾ï¼Œ<code>undo log</code> çš„ä¸‹ä¸€æ¡æ•°æ®çš„ <code>trx_id=10</code>, æ¯” <code>creator_trx_id=15</code> å°ï¼Œè¯´æ˜æ˜¯åœ¨äº‹åŠ¡A å¼€å¯ä¹‹å‰å°±å·²ç»æäº¤çš„ï¼Œå¯ä»¥è¯»å–ï¼Œæ‰€ä»¥è¯»å–åˆ°çš„æ˜¯ <strong>åˆå§‹å€¼</strong> è€Œä¸æ˜¯ <strong>æ•°æ®B</strong></p>
<p><strong>äº‹åŠ¡Bæäº¤æ•°æ®åäº‹åŠ¡Aå†è¯»å–</strong><br>å¯¹äº <code>RC</code> éš”ç¦»çº§åˆ«ï¼Œæ˜¯æ¯æ¬¡è¯»å–æ•°æ®æ—¶éƒ½ä¼šç”Ÿæˆ <code>ReadView</code>ï¼Œ æ‰€ä»¥äº‹åŠ¡B æäº¤æ•°æ®åï¼Œäº‹åŠ¡A å†è¯»å–æ—¶ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ <code>ReadView</code>ï¼Œæ­¤æ—¶ <code>ReadView</code> æ¶‰åŠåˆ°çš„å€¼å¦‚ä¸‹æ‰€ç¤º<br>äº‹åŠ¡A(trx_id&#x3D;15)<br><code>m_ids</code>: [15]<br><code>min_trx_id</code>: 15<br><code>max_trx_id</code>: 21<br><code>creator_trx_id</code>: 15</p>
<p>è¯»å–åˆ°æ•°æ®B, è¿™æ¡æ•°æ®çš„ <code>trx_id=20</code>, <code>trx_id</code> æ¯”è‡ªå·±çš„äº‹åŠ¡idå¤§ï¼Œä½†æ˜¯<strong>ä¸åœ¨</strong> <code>m_ids</code> ä¸­ï¼Œè¯´æ˜è¿™æ¡æ•°æ®æ˜¯å’Œäº‹åŠ¡A å·®ä¸å¤šåŒæ—¶å¯åŠ¨çš„äº‹åŠ¡æ“ä½œçš„ï¼Œå¹¶ä¸”å·²ç»æäº¤ï¼Œé‚£ä¹ˆäº‹åŠ¡A å°±å¯ä»¥è¿›è¡Œè¯»å–ï¼Œè¯»å–åˆ°çš„å°±æ˜¯ <strong>æ•°æ®B</strong></p>
<p><strong>æ€»ç»“ï¼šRC éš”ç¦»çº§åˆ«å¯ä»¥å®ç°è¯»å–åˆ°å…¶ä»–äº‹åŠ¡æäº¤çš„æ•°æ®çš„æ ¸å¿ƒæ˜¯åœ¨å½“å‰äº‹åŠ¡ä¸­æ¯æ¬¡æ‰§è¡Œ <code>select</code> ä¸­éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ <code>ReadView</code></strong></p>
<h2 id="RRï¼ˆRepeatable-Readï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†"><a href="#RRï¼ˆRepeatable-Readï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†" class="headerlink" title="RRï¼ˆRepeatable Readï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†"></a>RRï¼ˆRepeatable Readï¼‰éš”ç¦»çº§åˆ«å®ç°åŸç†</h2><p>åœ¨ <code>Mysql</code> ä¸­ <code>RR</code>  éš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢ å¹»è¯»ï¼Œä¸å¯é‡å¤è¯»å’Œå¹»è¯»</p>
<p><code>RR</code> å’Œ <code>RC</code> éš”ç¦»çº§åˆ«å®ç°ä¸Šçš„åŒºåˆ«æ˜¯ï¼š <code>RR</code> éš”ç¦»çº§åˆ«åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­åªä¼šåœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶ç”Ÿæˆ <code>ReadView</code>ï¼Œä¹‹åçš„æŸ¥è¯¢åªä¼šä½¿ç”¨å½“å‰äº‹åŠ¡çš„ <code>ReadView</code></p>
<p>ä¸‹é¢ä¸¾ä¾‹è¯´æ˜å¦‚ä½•åŸºäº <code>undo log</code> å’Œ <code>ReadView</code> æœºåˆ¶å®ç° <code>RR</code> éš”ç¦»çº§åˆ«, ä¾ç„¶ä½¿ç”¨ <code>RC</code> éš”ç¦»çº§åˆ«çš„ä¾‹å­</p>
<p>db ä¸­æŸæ¡æ•°æ®çš„åˆå§‹å€¼ <code>trx_id=10</code><br>åœ¨æŸä¸ªæ—¶åˆ»æœ‰äº‹åŠ¡A å’Œ äº‹åŠ¡B åŒæ—¶æ“ä½œè¿™æ¡æ•°æ®ï¼Œäº‹åŠ¡A æ˜¯æŸ¥è¯¢ï¼Œäº‹åŠ¡Bæ˜¯ä¿®æ”¹ï¼Œæˆ‘ä»¬çš„è§‚å¯Ÿè§’åº¦æ˜¯äº‹åŠ¡A</p>
<p><strong>äº‹åŠ¡Bä¿®æ”¹äº†æ•°æ®ä½†æœªæäº¤</strong><br>å› ä¸ºäº‹åŠ¡ B ä¿®æ”¹äº†æ•°æ®ï¼Œæ­¤æ—¶ <code>undo log</code> ç‰ˆæœ¬é“¾å¦‚ä¸‹æ‰€ç¤º</p>
<pre class="mermaid">graph LR
    subgraph A["åˆå§‹æ•°æ®"]
        direction LR
        A1["åˆå§‹å€¼"]
        A2["trx_id=10"]
        A3["roll_pointer"]
        A1~~~A2~~~A3
    end
    subgraph B["äº‹åŠ¡B"]
        direction LR
        B1["å€¼B"]
        B2["trx_id=15"]
        B3["roll_pointer"]
        B1~~~B2~~~B3
    end
    B3-.->A3
    style B3 fill:#8ff600
    style A3 fill:#8ff600</pre>

<p><strong>äº‹åŠ¡Aè¯»å–æ•°æ®</strong><br>äº‹åŠ¡ A æ‰§è¡Œ <code>select</code> æ“ä½œæ—¶ï¼Œå°±ä¼šç”Ÿæˆ <code>ReadView</code>ï¼Œ æ­¤æ—¶ <code>ReadView</code> æ¶‰åŠåˆ°çš„å€¼å¦‚ä¸‹æ‰€ç¤º<br>äº‹åŠ¡A(trx_id&#x3D;15), äº‹åŠ¡B(trx_id&#x3D;20)<br><code>m_ids</code>: [15, 20]<br><code>min_trx_id</code>: 15<br><code>max_trx_id</code>: 21<br><code>creator_trx_id</code>: 15</p>
<p>è¯»å–åˆ°æ•°æ®B, è¿™æ¡æ•°æ®çš„ <code>trx_id=20</code>, <code>trx_id</code> æ¯”è‡ªå·±çš„äº‹åŠ¡idå¤§ï¼Œä½†æ˜¯<strong>åœ¨</strong> <code>m_ids</code> ä¸­ï¼Œè¯´æ˜è¿™æ¡æ•°æ®æ˜¯å’Œäº‹åŠ¡ A å·®ä¸å¤šåŒæ—¶å¯åŠ¨çš„äº‹åŠ¡æ“ä½œçš„ï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰æäº¤ï¼Œé‚£ä¹ˆäº‹åŠ¡ A å°±ä¸èƒ½è¿›è¡Œè¯»å–ï¼Œéœ€è¦é¡ºç€ <code>undo log</code> ç‰ˆæœ¬é“¾ç»§ç»­å¯»æ‰¾ï¼Œ<code>undo log</code> çš„ä¸‹ä¸€æ¡æ•°æ®çš„ <code>trx_id=10</code>, æ¯” <code>creator_trx_id=15</code> å°ï¼Œè¯´æ˜æ˜¯åœ¨äº‹åŠ¡ A å¼€å¯ä¹‹å‰å°±å·²ç»æäº¤çš„ï¼Œå¯ä»¥è¯»å–ï¼Œæ‰€ä»¥è¯»å–åˆ°çš„æ˜¯ <strong>åˆå§‹å€¼</strong> è€Œä¸æ˜¯ <strong>æ•°æ®B</strong></p>
<p><strong>äº‹åŠ¡Bæäº¤æ•°æ®åäº‹åŠ¡Aå†è¯»å–</strong><br>å¯¹äº <code>RR</code> éš”ç¦»çº§åˆ«ï¼Œåªä¼šåœ¨ç¬¬ä¸€æ¬¡ <code>select</code> æ—¶ç”Ÿæˆ <code>ReadView</code>ï¼Œ æ‰€ä»¥äº‹åŠ¡ B æäº¤æ•°æ®åï¼Œäº‹åŠ¡ A å†è¯»å–æ—¶ï¼Œä½¿ç”¨çš„è¿˜æ˜¯ä¹‹å‰é‚£ä¸ª <code>ReadView</code>ï¼Œæ­¤æ—¶ <code>ReadView</code> æ¶‰åŠåˆ°çš„å€¼å¦‚ä¸‹æ‰€ç¤º<br>äº‹åŠ¡A(trx_id&#x3D;15)<br><code>m_ids</code>: [15, 20]<br><code>min_trx_id</code>: 15<br><code>max_trx_id</code>: 21<br><code>creator_trx_id</code>: 15</p>
<p>è¯»å–åˆ°æ•°æ®B, è¿™æ¡æ•°æ®çš„ <code>trx_id=20</code>, <code>trx_id</code> æ¯”è‡ªå·±çš„äº‹åŠ¡idå¤§ï¼Œå¹¶ä¸”åœ¨ <code>min_trx_id</code> å’Œ <code>max_trx_id</code> ä¹‹é—´ï¼ŒåŒæ—¶è¿˜åœ¨ <code>m_ids</code> ä¸­ï¼Œè¯´æ˜è¿™æ¡æ•°æ®æ˜¯å’Œäº‹åŠ¡ A å·®ä¸å¤šåŒæ—¶å¯åŠ¨çš„äº‹åŠ¡æ“ä½œçš„ï¼Œäº‹åŠ¡ A ä¸å¯ä»¥è¯»å–ï¼Œæ‰€ä»¥é¡ºç€ <code>undo log</code> ç‰ˆæœ¬é“¾ç»§ç»­å¾€å‰æ‰¾ï¼Œæ‰¾åˆ° <code>trx_id=10</code>, è¯´æ˜æ˜¯åœ¨äº‹åŠ¡ A å¼€å¯ä¹‹å‰å°±å·²ç»æäº¤çš„ï¼Œå¯ä»¥è¯»å–ï¼Œæ‰€ä»¥è¯»å–åˆ°çš„æ˜¯ <strong>åˆå§‹å€¼</strong></p>
<h3 id="ä¸ºä»€ä¹ˆ-Mysql-çš„-RR-éš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢å¹»è¯»"><a href="#ä¸ºä»€ä¹ˆ-Mysql-çš„-RR-éš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢å¹»è¯»" class="headerlink" title="ä¸ºä»€ä¹ˆ Mysql çš„ RR éš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢å¹»è¯»"></a>ä¸ºä»€ä¹ˆ Mysql çš„ RR éš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢å¹»è¯»</h3><p>åœ¨ <ol><li><a href="/2023/ba87d5c56893/index.html" title="Mysqläº‹åŠ¡éš”ç¦»çº§åˆ«">Mysqläº‹åŠ¡éš”ç¦»çº§åˆ«</a></li></ol> ä¸­æœ‰æåˆ°åœ¨ <code>Sql</code> æ ‡å‡†ä¸­ï¼Œ<code>RR</code> éš”ç¦»çº§åˆ«ä¸‹ä¸èƒ½é˜²æ­¢å¹»è¯»ï¼Œä½†æ˜¯åœ¨ <code>Mysql</code> ä¸­ï¼Œ<code>RR</code> éš”ç¦»çº§åˆ«ä¸‹å¯ä»¥è®¿é—®å¹»è¯»ï¼Œä¸‹é¢ä¸¾ä¾‹è¯´æ˜</p>
<p>æ¯”å¦‚ä¸‹é¢çš„ <code>sql</code> è¯­å¥å¯ä»¥æŸ¥è¯¢å‡ºä¸¤æ¡æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs Sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> student <span class="hljs-keyword">where</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure>
<p>æ•°æ®åˆå§‹å€¼ä¸º</p>
<table>
<thead>
<tr>
<th>trx_idï¼ˆéšè—å­—æ®µï¼‰</th>
<th>id</th>
</tr>
</thead>
<tbody><tr>
<td>10</td>
<td>11</td>
</tr>
<tr>
<td>15</td>
<td>12</td>
</tr>
</tbody></table>
<p>ç°åœ¨æœ‰äº‹åŠ¡ Aï¼Œ B åŒæ—¶æ“ä½œï¼Œäº‹åŠ¡ A æ˜¯æŸ¥è¯¢ï¼Œäº‹åŠ¡ B æ˜¯æ–°å¢æ•°æ®</p>
<p><strong>äº‹åŠ¡A ç¬¬ä¸€æ¬¡æŸ¥è¯¢</strong><br>æ­¤æ—¶å‡è®¾äº‹åŠ¡ A çš„ <code>ReadView</code> å¦‚ä¸‹<br>äº‹åŠ¡A(trx_id&#x3D;16), äº‹åŠ¡B(trx_id&#x3D;17)<br><code>m_ids</code>: [16, 17]<br><code>min_trx_id</code>: 16<br><code>max_trx_id</code>: 18<br><code>creator_trx_id</code>: 16</p>
<p>å› ä¸ºäº‹åŠ¡ B è¿˜æ²¡æœ‰çœŸæ­£æ’å…¥æ•°æ®ï¼Œæ‰€ä»¥äº‹åŠ¡ A æŸ¥è¯¢çš„å°±æ˜¯ä¸Šé¢å±•ç¤ºçš„ä¸¤æ¡æ•°æ®</p>
<p><strong>äº‹åŠ¡B æ–°å¢æ•°æ®å¹¶æäº¤</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> student(id) <span class="hljs-keyword">values</span>(<span class="hljs-number">13</span>);<br><span class="hljs-keyword">commit</span>;<br></code></pre></td></tr></table></figure>
<p>æ­¤æ—¶æ•°æ®åº“ä¸­æœ‰ä¸‰æ¡æ•°æ®</p>
<table>
<thead>
<tr>
<th>trx_idï¼ˆéšè—å­—æ®µï¼‰</th>
<th>id</th>
</tr>
</thead>
<tbody><tr>
<td>10</td>
<td>11</td>
</tr>
<tr>
<td>15</td>
<td>12</td>
</tr>
<tr>
<td>17</td>
<td>13</td>
</tr>
</tbody></table>
<p><strong>äº‹åŠ¡A ç¬¬äºŒæ¬¡æŸ¥è¯¢</strong><br>æ­¤æ—¶äº‹åŠ¡ A çš„ <code>ReadVew</code> è¿˜æ˜¯å’Œä¹‹å‰ä¸€æ ·ï¼Œå¹¶ä¸ä¼šæ”¹å˜<br><code>m_ids</code>: [16, 17]<br><code>min_trx_id</code>: 16<br><code>max_trx_id</code>: 18<br><code>creator_trx_id</code>: 16<br>å½“æ‰§è¡Œä¸‹é¢çš„ <code>sql</code> æ—¶å¯ä»¥æŸ¥è¯¢å‡º 3 æ¡æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs Sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> student <span class="hljs-keyword">where</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure>
<p>ä½†æ˜¯å…¶ä¸­æœ‰ä¸€æ¡æ•°æ®çš„ <code>trx_id=17</code>, 17 åœ¨å½“å‰ <code>ReadView</code> çš„ <code>min_trx_id</code> å’Œ <code>max_trx_id</code> ä¹‹é—´ï¼Œè¯´æ˜æ˜¯åœ¨äº‹åŠ¡ A å¼€å¯ä¹‹åæ‰æ–°å¢çš„æ•°æ®ï¼Œè¿™æ¡æ•°æ®å°±ä¸èƒ½å±•ç¤ºå‡ºæ¥</p>
<p><strong>æ€»ç»“ï¼š<code>RR</code> éš”ç¦»çº§åˆ«åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­åªä¼šåœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶ç”Ÿæˆ <code>ReadView</code>ï¼Œä¹‹åçš„æŸ¥è¯¢åªä¼šä½¿ç”¨å½“å‰äº‹åŠ¡çš„ <code>ReadView</code></strong></p>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysqläº‹åŠ¡éš”ç¦»çº§åˆ«</title>
    <url>/2023/ba87d5c56893/index.html</url>
    <content><![CDATA[<h2 id="äº‹åŠ¡çš„å››ä¸ªç‰¹ç‚¹"><a href="#äº‹åŠ¡çš„å››ä¸ªç‰¹ç‚¹" class="headerlink" title="äº‹åŠ¡çš„å››ä¸ªç‰¹ç‚¹"></a>äº‹åŠ¡çš„å››ä¸ªç‰¹ç‚¹</h2><ol>
<li>åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šäº‹åŠ¡æ˜¯ä¸€ä¸ªåŸå­æ“ä½œå•å…ƒï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œï¼Œä¸ä¼šå‡ºç°éƒ¨åˆ†æ‰§è¡Œçš„æƒ…å†µã€‚</li>
<li>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸæ²¡æœ‰è¢«ç ´åï¼Œå³æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚</li>
<li>éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šå¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œæ¯ä¸ªäº‹åŠ¡çš„æ“ä½œåº”è¯¥ä¸å…¶ä»–äº‹åŠ¡çš„æ“ä½œç›¸äº’éš”ç¦»ï¼Œä¸ä¼šç›¸äº’å¹²æ‰°ã€‚</li>
<li>æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šä¸€æ—¦äº‹åŠ¡æäº¤ï¼Œå…¶æ‰€åšçš„ä¿®æ”¹ä¼šæ°¸ä¹…ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œå³ä½¿ç³»ç»Ÿå‘ç”Ÿæ•…éšœä¹Ÿä¸ä¼šä¸¢å¤±ã€‚</li>
</ol>
<h2 id="å¹¶å‘è¯»å†™æ•°æ®å¸¦æ¥çš„é—®é¢˜"><a href="#å¹¶å‘è¯»å†™æ•°æ®å¸¦æ¥çš„é—®é¢˜" class="headerlink" title="å¹¶å‘è¯»å†™æ•°æ®å¸¦æ¥çš„é—®é¢˜"></a>å¹¶å‘è¯»å†™æ•°æ®å¸¦æ¥çš„é—®é¢˜</h2><ol>
<li>è„å†™</li>
<li>è„è¯»</li>
<li>ä¸å¯é‡å¤è¯»</li>
<li>å¹»è¯»</li>
</ol>
<p><strong>è„å†™</strong></p>
<ol>
<li>äº‹åŠ¡ Aï¼ŒB åŒæ—¶å¼€å§‹å‡†å¤‡æ›´æ–°ä¸€æ¡æ•°æ®</li>
<li>äº‹åŠ¡ A æ›´æ–°</li>
<li>äº‹åŠ¡ B æ›´æ–°</li>
<li>äº‹åŠ¡ A å›æ»šï¼Œå°†äº‹åŠ¡ B æ›´æ–°çš„æ•°æ®ä¹Ÿå›æ»šäº†</li>
</ol>
<p>å¯¹äºäº‹åŠ¡ B æ¥è¯´ï¼Œè‡ªå·±æ›´æ–°äº†ï¼Œä½†æ˜¯çœ‹åˆ°çš„æ˜¯æ²¡æœ‰æ›´æ–°çš„æ•°æ®ï¼Œè¿™å°±æ˜¯è„å†™ã€‚</p>
<p><strong>è„è¯»</strong></p>
<ol>
<li>äº‹åŠ¡ Aï¼ŒB åŒæ—¶å¼€å¯å‡†å¤‡å¤„ç†æ•°æ®</li>
<li>äº‹åŠ¡ B æ›´æ–°äº†æ•°æ®ï¼Œä½†æ˜¯æ²¡æœ‰æäº¤</li>
<li>äº‹åŠ¡ A æ‹¿åˆ°äº‹åŠ¡ B æ›´æ–°çš„æ•°æ®</li>
<li>äº‹åŠ¡ B å›æ»š</li>
<li>äº‹åŠ¡ A å†æ¬¡æŸ¥è¯¢ï¼Œå‘ç°æ•°æ®å˜äº†</li>
</ol>
<p>å¯¹äºäº‹åŠ¡ A æ¥è¯´ï¼Œå› ä¸ºè¯»å–åˆ°äº†äº‹åŠ¡ B è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¯¼è‡´è‡ªå·±å…ˆåä¸¤æ¬¡è¯»å–çš„ç»“æœä¸åŒï¼Œè¿™å°±æ˜¯è„è¯»ã€‚</p>
<p><strong>ä¸å¯é‡å¤è¯»</strong></p>
<ol>
<li>äº‹åŠ¡ Aï¼ŒB åŒæ—¶å¼€å§‹å‡†å¤‡å¤„ç†æ•°æ®</li>
<li>äº‹åŠ¡ A è¯»å–æ•°æ® Aï¼ˆäº‹åŠ¡ A ä¸€ç›´å¼€å¯ç€ï¼‰</li>
<li>äº‹åŠ¡ B å°†æ•°æ® A æ›´æ–°æˆæ•°æ® B</li>
<li>äº‹åŠ¡ A å†æ¬¡è¯»å–ï¼Œç»“æœå˜æˆäº† æ•°æ®B, åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œäº‹åŠ¡ A ä¸¤æ¬¡è¯»å–çš„ç»“æœä¸ä¸€è‡´ï¼Œè¿™å°±æ˜¯ä¸å¯é‡å¤è¯»</li>
</ol>
<p>æ€»ç»“ï¼šä¸€ä¸ªäº‹åŠ¡è¯»å–åˆ°äº†å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¸­<strong>æäº¤</strong>çš„ <code>update</code> çš„æ•°æ®</p>
<p><strong>å¹»è¯»</strong><br>æŒ‡ä¸€ä¸ªäº‹åŠ¡è¯»å–åˆ°äº†å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¸­<strong>æäº¤</strong>çš„ <code>insert</code> çš„æ•°æ®</p>
<h2 id="Sql-éš”ç¦»çº§åˆ«"><a href="#Sql-éš”ç¦»çº§åˆ«" class="headerlink" title="Sql éš”ç¦»çº§åˆ«"></a>Sql éš”ç¦»çº§åˆ«</h2><p>é’ˆå¯¹ä»¥ä¸Šåœ¨å¤šäº‹åŠ¡å¹¶å‘æ—¶å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼Œåœ¨ <code>Sql</code> æ ‡å‡†ä¸­è§„å®šäº†å‡ ç§éš”ç¦»çº§åˆ«ï¼Œç”¨æ¥è§£å†³è¿™äº›é—®é¢˜</p>
<table>
<thead>
<tr>
<th>éš”ç¦»çº§åˆ«</th>
<th>è„è¯»</th>
<th>ä¸å¯é‡å¤è¯»</th>
<th>å¹»è¯»</th>
</tr>
</thead>
<tbody><tr>
<td>è¯»æœªæäº¤ï¼ˆRead uncommittedï¼‰</td>
<td>å¯èƒ½</td>
<td>å¯èƒ½</td>
<td>å¯èƒ½</td>
</tr>
<tr>
<td>è¯»å·²æäº¤ï¼ˆRead committedï¼‰</td>
<td>ä¸å¯èƒ½</td>
<td>å¯èƒ½</td>
<td>å¯èƒ½</td>
</tr>
<tr>
<td>å¯é‡å¤è¯»ï¼ˆRepeatable readï¼‰</td>
<td>ä¸å¯èƒ½</td>
<td>ä¸å¯èƒ½</td>
<td>å¯èƒ½</td>
</tr>
<tr>
<td>ä¸²è¡ŒåŒ–</td>
<td>ä¸å¯èƒ½</td>
<td>ä¸å¯èƒ½</td>
<td>ä¸å¯èƒ½</td>
</tr>
</tbody></table>
<p>åœ¨ <code>Sql</code> æ ‡å‡†çš„éš”ç¦»çº§åˆ«ä¸­ï¼Œ<code>RR</code> éš”ç¦»çº§åˆ«æ˜¯ç”¨æ¥ä¿è¯åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¯¹åŒä¸€è¡Œæ•°æ®çš„å¤šæ¬¡æŸ¥è¯¢ï¼Œä¸ä¼šè¯»å–åˆ°ä¸ä¸€æ ·çš„æ•°æ®ï¼Œä½†æ˜¯é’ˆå¯¹èŒƒå›´æŸ¥è¯¢æ¥è¯´ï¼Œå¦‚æœåœ¨æŸ¥è¯¢èŒƒå›´å†…æ–°å¢äº†æ•°æ®å¹¶ä¸”è¿˜æäº¤äº†ï¼Œä¾ç„¶æ˜¯å¯ä»¥è¢«è¯»å–åˆ°çš„ï¼Œæ‰€ä»¥ <code>RR</code> éš”ç¦»çº§åˆ«è¿˜æ˜¯å¯èƒ½å‘ç”Ÿ <strong>å¹»è¯»</strong></p>
<p>åœ¨ <code>Mysql</code> çš„ <code>RR</code> éš”ç¦»çº§åˆ«ä¸‹ä¸ä¼šå‘ç”Ÿ <strong>å¹»è¯»</strong>ï¼Œå…·ä½“åŸå› å¯ä»¥å‚è€ƒ</p>
<ol><li><a href="/2023/7aa9bac70e9b/index.html" title="InnoDBå­˜å‚¨å¼•æ“ä¹‹MVCCè¯¦è§£">InnoDBå­˜å‚¨å¼•æ“ä¹‹MVCCè¯¦è§£</a></li></ol>

<h2 id="æŸ¥çœ‹-Mysql8-éš”ç¦»çº§åˆ«"><a href="#æŸ¥çœ‹-Mysql8-éš”ç¦»çº§åˆ«" class="headerlink" title="æŸ¥çœ‹ Mysql8 éš”ç¦»çº§åˆ«"></a>æŸ¥çœ‹ Mysql8 éš”ç¦»çº§åˆ«</h2><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@transaction_isolation</span>;<br></code></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysqlæ•´ä½“æ¶æ„</title>
    <url>/2023/fd974035a1b5/index.html</url>
    <content><![CDATA[<span class="hide_first_mermaid">
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
    A
  </pre></div>
</span>

<pre class="mermaid">flowchart LR
    K1["å®¢æˆ·ç«¯è¿æ¥"]
    K2["å®¢æˆ·ç«¯è¿æ¥"]
    K1 & K2--1--->A
    subgraph A["MysqlæœåŠ¡å™¨"]
        direction LR
        subgraph A1["è¿æ¥æ± "]
            direction TB
            A11[è¿æ¥]
            A12[è¿æ¥]
            A13[è¿æ¥]
            A11~~~A12~~~A13
        end
        subgraph A3["çº¿ç¨‹"]
        end
        
        A1--"2(è·å–sqlè¯­å¥)"-->A3

        subgraph A2["sqlç›¸å…³å¤„ç†"]
            direction TB
            A23["3(sqlæ¥å£)"]
            A24["4(sqlè§£æå™¨)"]
            A25["5(æŸ¥è¯¢ä¼˜åŒ–å™¨)"]
            A26["6(æ‰§è¡Œå™¨)"]
            A23-->A24-->A25-->A26
        end

        A3-->A2
        subgraph A4["7(å­˜å‚¨å¼•æ“)"]
        end
        A2-->A4
    end</pre>
<p>ä¸‹é¢æŒ‰ç…§ä¸Šå›¾ä¸­æ ‡çš„æ•°å­—çš„é¡ºåºè¿›è¡Œæ¢³ç†</p>
<h2 id="1-è¿æ¥æ± "><a href="#1-è¿æ¥æ± " class="headerlink" title="1 è¿æ¥æ± "></a>1 è¿æ¥æ± </h2><ol>
<li>æˆ‘ä»¬å¹³æ—¶æ‰€è¯´çš„è¿æ¥æ± ä¸€èˆ¬éƒ½æ˜¯æŒ‡åº”ç”¨ç«¯çš„è¿æ¥æ± ï¼Œæ¯”å¦‚ä¸€ä¸ª <code>Java</code> åº”ç”¨è¿æ¥æ•°æ®åº“æ—¶ï¼Œ<code>Java</code> åº”ç”¨ä¼šæœ‰ä¸€ä¸ªè¿æ¥æ± å»è¿æ¥æ•°æ®åº“</li>
<li><code>Mysql</code> æœåŠ¡å™¨è‡ªèº«ä¹Ÿæ˜¯æœ‰ä¸€ä¸ªè¿æ¥æ± æ¥å’Œå®¢æˆ·ç«¯è¿›è¡Œè¿æ¥ï¼Œè¿™ä¸ªè¿æ¥æ± ç®¡ç†äº†å„ç§ç³»ç»Ÿè·Ÿè¿™å°æ•°æ®åº“æœåŠ¡å™¨å»ºç«‹çš„æ‰€æœ‰è¿æ¥</li>
</ol>
<h2 id="2-çº¿ç¨‹å¤„ç†è¿æ¥"><a href="#2-çº¿ç¨‹å¤„ç†è¿æ¥" class="headerlink" title="2 çº¿ç¨‹å¤„ç†è¿æ¥"></a>2 çº¿ç¨‹å¤„ç†è¿æ¥</h2><p>å¯¹äºç½‘ç»œè¿æ¥ä¸€èˆ¬éƒ½æ˜¯éœ€è¦å•ç‹¬çš„çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ªçº¿ç¨‹æ¥ç›‘å¬è¯·æ±‚ä»¥åŠè·å–è¯·æ±‚æ•°æ®</p>
<h2 id="3-sqlæ¥å£"><a href="#3-sqlæ¥å£" class="headerlink" title="3 sqlæ¥å£"></a>3 sqlæ¥å£</h2><ol>
<li><code>MySQL</code> çš„å·¥ä½œçº¿ç¨‹æ¥æ”¶åˆ°<code>SQL</code>è¯­å¥ä¹‹åï¼Œå°±ä¼šè½¬äº¤ç»™<code>SQL</code>æ¥å£å»æ‰§è¡Œ</li>
<li>è¿™ç§è®¾è®¡å’Œ <code>java</code> ç±»ä¼¼ï¼Œä¹Ÿæ˜¯é¢å‘æ¥å£ç¼–ç¨‹ï¼Œå¤–éƒ¨ä½¿ç”¨åªéœ€è¦å’Œæ¥å£æ‰“äº¤é“ï¼Œå±è”½äº†å†…éƒ¨å¤æ‚çš„å®ç°é€»è¾‘</li>
</ol>
<h2 id="4-sqlè§£æå™¨"><a href="#4-sqlè§£æå™¨" class="headerlink" title="4 sqlè§£æå™¨"></a>4 sqlè§£æå™¨</h2><ol>
<li>æŸ¥è¯¢è§£æå™¨<code>(Parser)</code>å°±æ˜¯è´Ÿè´£å¯¹<code>SQL</code>è¯­å¥è¿›è¡Œè§£æ, è¿™é‡Œçš„è§£æçš„å«ä¹‰å…¶å®å°±æ˜¯æŒ‰ç…§ <code>SQL</code> è¯­æ³•å¯¹ <code>SQL</code> è¿›è¡Œæ‹†è§£ï¼Œ æ¯”å¦‚ä¸‹é¢çš„ä¸€ä¸ª <code>SQL</code></li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™ä¸ª <code>SQL</code> è¯­å¥åªæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²è€Œå·²ï¼Œä½†æ˜¯é€šè¿‡ <strong>æŸ¥è¯¢è§£æå™¨</strong> åï¼Œå°±å¯ä»¥çŸ¥é“ <code>user</code> å¯¹åº”çš„æ˜¯è¡¨ï¼Œ<code>id</code> å¯¹åº”çš„æ˜¯è¡¨é‡Œé¢çš„ä¸€ä¸ªå­—æ®µ</p>
<h2 id="5-æŸ¥è¯¢ä¼˜åŒ–å™¨"><a href="#5-æŸ¥è¯¢ä¼˜åŒ–å™¨" class="headerlink" title="5 æŸ¥è¯¢ä¼˜åŒ–å™¨"></a>5 æŸ¥è¯¢ä¼˜åŒ–å™¨</h2><ol>
<li>æŸ¥è¯¢ä¼˜åŒ–å™¨çš„ä½œç”¨æ˜¯ <strong>é€‰æ‹©æœ€ä¼˜çš„æŸ¥è¯¢è·¯å¾„</strong></li>
<li>ä¸€æ¡ <code>SQL</code> è¯­å¥å¯ä»¥æœ‰å¤šä¸ªæ–¹å¼è¾¾åˆ°æœ€ç»ˆçš„æ•ˆæœï¼Œè¿˜æ˜¯å·² <code>select * from user where id = 1;</code> è¿™ä¸ª <code>SQL</code> è¯­å¥ä¸¾ä¾‹<ol>
<li>ç¬¬ä¸€ç§æ–¹å¼æ˜¯å¯ä»¥å…ˆè·å–åˆ°æ‰€æœ‰æ•°æ®ï¼Œç„¶åæ ¹æ® <code>id=1</code> è¿™ä¸ªæ¡ä»¶å»è¿‡æ»¤ï¼Œå†å°†ç»“æœè¿”å›</li>
<li>ç¬¬äºŒç§æ–¹å¼ä¹Ÿå¯ä»¥æ˜¯å…ˆæ‹¿åˆ° <code>id=1</code> è¿™ä¸ªæ¡ä»¶ï¼Œç„¶åç›´æ¥å®šä½ <code>id=1</code> çš„æ•°æ®ï¼Œå†å°†ç»“æœè¿”å›</li>
</ol>
</li>
</ol>
<h2 id="6-æ‰§è¡Œå™¨"><a href="#6-æ‰§è¡Œå™¨" class="headerlink" title="6 æ‰§è¡Œå™¨"></a>6 æ‰§è¡Œå™¨</h2><ol>
<li>æ‰§è¡Œå™¨æ˜¯æ ¹æ®æ‰§è¡Œè®¡åˆ’è°ƒç”¨å­˜å‚¨å¼•æ“çš„æ¥å£</li>
<li>æ‰§è¡Œå™¨ä¼šæ ¹æ®ä¼˜åŒ–å™¨é€‰æ‹©çš„æ‰§è¡Œæ–¹æ¡ˆï¼ŒæŒ‰ç…§ä¸€å®šçš„é¡ºåºå»è°ƒç”¨å­˜å‚¨å¼•æ“çš„æ¥å£ï¼ŒæŠŠ<code>SQL</code>è¯­å¥çš„é€»è¾‘ç»™æ‰§è¡Œ</li>
</ol>
<h2 id="7-å­˜å‚¨å¼•æ“"><a href="#7-å­˜å‚¨å¼•æ“" class="headerlink" title="7 å­˜å‚¨å¼•æ“"></a>7 å­˜å‚¨å¼•æ“</h2><p>å­˜å‚¨å¼•æ“å…¶å®å°±æ˜¯çœŸæ­£æ‰§è¡Œ<code>SQL</code>è¯­å¥çš„ï¼Œä»–ä¼šæŒ‰ç…§ä¸€å®šçš„æ­¥éª¤å»æŸ¥è¯¢å†…å­˜ç¼“å­˜æ•°æ®ï¼Œæ›´æ–°ç£ç›˜æ•°æ®ï¼ŒæŸ¥è¯¢ç£ç›˜æ•°æ®ç­‰æ“ä½œ</p>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysqlé…ç½®é¡¹å’Œé…ç½®æ–‡ä»¶</title>
    <url>/2023/59d19215016d/index.html</url>
    <content><![CDATA[<p>ä»¥ä¸‹åŸºäº <code>Mysql8</code> ç‰ˆæœ¬</p>
<h2 id="Mysql-ç¨‹åºé€‰é¡¹"><a href="#Mysql-ç¨‹åºé€‰é¡¹" class="headerlink" title="Mysql ç¨‹åºé€‰é¡¹"></a>Mysql ç¨‹åºé€‰é¡¹</h2><p><code>Mysql</code> æ˜¯ä¸€ä¸ª <strong>å®¢æˆ·ç«¯-æœåŠ¡ç«¯</strong> ç¨‹åºï¼Œå®‰è£… <code>Mysql</code> å <code>bin</code> ç›®å½•ä¸‹æœ‰å¾ˆå¤šå¯æ‰§è¡Œç¨‹åºï¼Œæ¯”å¦‚</p>
<ul>
<li>å¯åŠ¨æœåŠ¡ç«¯çš„ <code>Mysqld</code> ç¨‹åº</li>
<li>å¯åŠ¨æœåŠ¡ç«¯çš„ <code>mysqld_safe</code> è„šæœ¬ç¨‹åºï¼Œè¿™ä¸ªè„šæœ¬ä¹Ÿä¼šå¯åŠ¨ <code>Mysqld</code>, ä½†ä¼šåŒ…å«æ›´å¤šåŠŸèƒ½</li>
<li>å¯åŠ¨å®¢æˆ·ç«¯çš„ <code>Mysql</code> ç¨‹åº</li>
</ul>
<p>è¿˜æœ‰å¾ˆå¤šå¯æ‰§è¡Œç¨‹åºï¼Œå…·ä½“å¯ä»¥å‚è€ƒ <a href="https://dev.mysql.com/doc/refman/8.0/en/programs-overview.html">Mysql programs</a></p>
<p>è¿™äº›å¯æ‰§è¡Œç¨‹åºåœ¨å¯åŠ¨æ—¶éƒ½å¯ä»¥æŒ‡å®šå‚æ•°ï¼Œè¿™äº›å‚æ•°æœ‰ä¸¤ç§å½¢å¼</p>
<ul>
<li>é•¿æ ¼å¼<ul>
<li>ä»¥ <code>--</code> å¼€å¤´</li>
<li>å¦‚æœå¯¹åº”çš„å‚æ•°æœ‰å€¼ï¼Œåˆ™æ˜¯ <code>--key=value</code> å½¢å¼ï¼Œæ¯”å¦‚ <code>--port=3306</code>ï¼Œ æ³¨æ„ å¯¹åº”çš„ <code>key</code>, <code>=</code> å’Œ <code>value</code> ä¹‹é—´ä¸è¦æœ‰ç©ºæ ¼ï¼Œ æ¯”å¦‚ <code>--port = 3306</code> å½¢å¼æ˜¯é”™è¯¯çš„</li>
</ul>
</li>
<li>çŸ­æ ¼å¼<ul>
<li>ä»¥ <code>-</code> å¼€å¤´</li>
<li>å¦‚æœå¯¹åº”çš„å‚æ•°æœ‰å€¼ï¼Œåˆ™æ˜¯ <code>-key value</code> å½¢å¼ï¼Œæ¯”å¦‚ <code>-p 3306</code>ï¼Œ å‚æ•°å’Œå€¼ä¹‹é—´ä¸éœ€è¦ <code>=</code></li>
</ul>
</li>
</ul>
<h3 id="å¯æ‰§è¡Œç¨‹åºæ”¯æŒçš„é€‰é¡¹"><a href="#å¯æ‰§è¡Œç¨‹åºæ”¯æŒçš„é€‰é¡¹" class="headerlink" title="å¯æ‰§è¡Œç¨‹åºæ”¯æŒçš„é€‰é¡¹"></a>å¯æ‰§è¡Œç¨‹åºæ”¯æŒçš„é€‰é¡¹</h3><p>å¯ä»¥é€šè¿‡ <code>--help</code> æ¥æŸ¥çœ‹å¯¹åº”å¯æ‰§è¡Œå‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯ï¼Œä¸€èˆ¬ä¼šåœ¨å¸®åŠ©ä¿¡æ¯ä¸­åˆ—å‡ºæ”¯æŒçš„é€‰é¡¹ï¼Œæ¯”å¦‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ mysql --<span class="hljs-built_in">help</span><br>mysql  Ver 8.0.35 <span class="hljs-keyword">for</span> Linux on x86_64 (MySQL Community Server - GPL)<br>Copyright (c) 2000, 2023, Oracle and/or its affiliates.<br><br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Usage: mysql [OPTIONS] [database]<br>  -?, --<span class="hljs-built_in">help</span>          Display this <span class="hljs-built_in">help</span> and <span class="hljs-built_in">exit</span>.<br>  -I, --<span class="hljs-built_in">help</span>          Synonym <span class="hljs-keyword">for</span> -?<br>  --auto-rehash       Enable automatic rehashing. One doesn<span class="hljs-string">&#x27;t need to use</span><br><span class="hljs-string">                      &#x27;</span><span class="hljs-built_in">rehash</span><span class="hljs-string">&#x27; to get table and field completion, but startup</span><br><span class="hljs-string">                      and reconnecting may take a longer time. Disable with</span><br><span class="hljs-string">                      --disable-auto-rehash.</span><br><span class="hljs-string">                      (Defaults to on; use --skip-auto-rehash to disable.)</span><br><span class="hljs-string">    â€¦â€¦ çœç•¥</span><br></code></pre></td></tr></table></figure>

<h2 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h2><p>é€šè¿‡å‘½ä»¤è¡Œæ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶å¹¶ä¸”åœ¨å‘½ä»¤åé¢å¢åŠ å‚æ•°æ˜¯ä¸€æ¬¡æ€§æœ‰æ•ˆçš„ï¼Œå¦‚æœåœæ­¢äº† <code>Mysql</code> æœåŠ¡ï¼Œå†æ¬¡å¯åŠ¨éœ€è¦é‡æ–°æŒ‡å®šå‚æ•°ï¼Œæ‰€ä»¥å¯ä»¥å°†å‚æ•°å†™åœ¨é…ç½®æ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨æ¯æ¬¡éƒ½æŒ‡å®šå‚æ•°äº†ã€‚</p>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/option-files.html">Mysqlé…ç½®æ–‡ä»¶å®˜æ–¹æ–‡æ¡£è¯´æ˜</a></p>
<h3 id="Unix-å’Œ-ç±»-Unix-ä¸‹é…ç½®æ–‡ä»¶è¯»å–ä½ç½®"><a href="#Unix-å’Œ-ç±»-Unix-ä¸‹é…ç½®æ–‡ä»¶è¯»å–ä½ç½®" class="headerlink" title="Unix å’Œ ç±» Unix ä¸‹é…ç½®æ–‡ä»¶è¯»å–ä½ç½®"></a>Unix å’Œ ç±» Unix ä¸‹é…ç½®æ–‡ä»¶è¯»å–ä½ç½®</h3><table>
<thead>
<tr>
<th>File Name</th>
<th>Purpose</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;etc&#x2F;my.cnf</td>
<td>Global options</td>
</tr>
<tr>
<td>&#x2F;etc&#x2F;mysql&#x2F;my.cnf</td>
<td>Global options</td>
</tr>
<tr>
<td>SYSCONFDIR&#x2F;my.cnf</td>
<td>Global options</td>
</tr>
<tr>
<td>$MYSQL_HOME&#x2F;my.cnf</td>
<td>Server-specific options (server only)</td>
</tr>
<tr>
<td>defaults-extra-file</td>
<td>The file specified with â€“defaults-extra-file, if any</td>
</tr>
<tr>
<td>~&#x2F;.my.cn</td>
<td>User-specific options</td>
</tr>
<tr>
<td>~&#x2F;.mylogin.cnf</td>
<td>User-specific login path options (clients only)</td>
</tr>
<tr>
<td>DATADIR&#x2F;mysqld-auto.cnf</td>
<td>System variables persisted with SET PERSIST or SET PERSIST_ONLY (server only)</td>
</tr>
</tbody></table>
<ul>
<li><code>$MYSQL_HOME</code> æ˜¯ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥è‡ªå·±è®¾ç½®<ol><li><a href="/2023/1f7648c2ff11/index.html" title="Ubuntuä¸­è®¾ç½®ç¯å¢ƒå˜é‡çš„å‡ ç§æ–¹å¼">Ubuntuä¸­è®¾ç½®ç¯å¢ƒå˜é‡çš„å‡ ç§æ–¹å¼</a></li></ol></li>
<li>ä»¥ <code>~</code> å¼€å¤´çš„åˆ™æ˜¯ç”¨æˆ·ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶</li>
<li><code>defaults-extra-file</code> æ˜¯æŒ‡é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚ <code>mysqld --defaults-extra-file=/usr/loca/mysql.cnf</code></li>
</ul>
<h3 id="é…ç½®æ–‡ä»¶åŒ…å«çš„å†…å®¹"><a href="#é…ç½®æ–‡ä»¶åŒ…å«çš„å†…å®¹" class="headerlink" title="é…ç½®æ–‡ä»¶åŒ…å«çš„å†…å®¹"></a>é…ç½®æ–‡ä»¶åŒ…å«çš„å†…å®¹</h3><p>ä¸‹é¢æ˜¯ä¸€ä¸ª <code>my.cnf</code> é…ç½®æ–‡ä»¶çš„ç¤ºä¾‹</p>
<figure class="highlight clean"><table><tr><td class="code"><pre><code class="hljs clean">###### [mysql]é…ç½®æ¨¡å— ######<br>[mysql]<br># è®¾ç½®MySQLå®¢æˆ·ç«¯é»˜è®¤å­—ç¬¦é›†<br>default-character-set=utf8mb4<br>socket=/var/lib/mysql/mysql.sock<br><br><br>###### [mysqld]é…ç½®æ¨¡å— ######<br>[mysqld]<br>port=<span class="hljs-number">3306</span><br>user=root<br>#skip-grant-tables<br>sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION<br><br>datadir=/var/lib/mysql<br>socket=/var/lib/mysql/mysql.sock<br></code></pre></td></tr></table></figure>

<p>ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ éƒ¨åˆ†å†…å®¹</p>
<ul>
<li>æ³¨é‡Šå’Œç©ºè¡Œ</li>
<li>[mysql]ï¼Œ [mysqld] è¿™ç§åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ç§°ä¸º  <code>group</code>, ä¹Ÿå°±æ˜¯é…ç½®æ–‡ä»¶è¢«åˆ†ç»„äº†ï¼Œç»„é‡Œé¢çš„å†…å®¹å°±æ˜¯å¯æ‰§è¡Œæ–‡ä»¶å<ul>
<li>ä¸åŒç»„ä¸‹çš„é…ç½®é¡¹æ˜¯ç»™ä¸åŒçš„å¯åŠ¨å‘½ä»¤ä½¿ç”¨çš„ï¼Œå¦‚æœé€‰é¡¹ç»„åç§°ä¸ç¨‹åºåç§°ç›¸åŒï¼Œåˆ™ç»„ä¸­çš„é€‰é¡¹å°†åº”ç”¨äºè¯¥ç¨‹åºï¼Œ æ¯”å¦‚ <code>[mysql]</code> ç»„ä¸‹é¢çš„é€‰é¡¹ä¼šåœ¨ä½¿ç”¨ <code>mysql</code> å‘½ä»¤æ—¶è¯»å–</li>
<li><code>[server]</code> ç»„ä¸‹é…ç½®é¡¹å°†ä½œç”¨äºæ‰€æœ‰çš„æœåŠ¡å™¨ç¨‹åº</li>
<li><code>[client]</code> ç»„ä¸‹é…ç½®é¡¹å°†ä½œç”¨äºæ‰€æœ‰çš„å®¢æˆ·ç«¯ç¨‹åº</li>
<li><code>[mysqld_safe]</code> å’Œ <code>[mysql.server]</code> è¿™ä¸¤ä¸ªç¨‹åºåœ¨å¯åŠ¨æ—¶é™¤äº†è¯»å–è‡ªå·±ç»„ä¸‹çš„é…ç½®è¿˜ä¼šè¯»å– <code>[mysqld]</code> ä¸‹çš„é…ç½®</li>
</ul>
</li>
<li>ç»„ä¸‹é¢çš„å…·ä½“é…ç½®<ul>
<li>é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®é¡¹åªèƒ½æ˜¯é•¿æ ¼å¼ï¼Œè€Œä¸”ä¸éœ€è¦ <code>--</code> å¼€å¤´</li>
</ul>
</li>
</ul>
<h3 id="é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§"><a href="#é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§" class="headerlink" title="é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§"></a>é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§</h3><p><strong>ä¸åŒé…ç½®æ–‡ä»¶çš„ä¼˜å…ˆçº§</strong></p>
<p>ä¸åŒç›®å½•ä¸‹éƒ½æœ‰é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”æœ‰ç›¸åŒçš„é…ç½®é¡¹çš„æƒ…å†µä¸‹ï¼Œä»¥åè¯»å–çš„ä¸ºå‡†ï¼Œä¸Šé¢å·²ç»åˆ—å‡ºäº†è¯»å–çš„ç›®å½•</p>
<table>
<thead>
<tr>
<th>File Name</th>
<th>Purpose</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;etc&#x2F;my.cnf</td>
<td>Global options</td>
</tr>
<tr>
<td>&#x2F;etc&#x2F;mysql&#x2F;my.cnf</td>
<td>Global options</td>
</tr>
<tr>
<td>SYSCONFDIR&#x2F;my.cnf</td>
<td>Global options</td>
</tr>
<tr>
<td>$MYSQL_HOME&#x2F;my.cnf</td>
<td>Server-specific options (server only)</td>
</tr>
<tr>
<td>defaults-extra-file</td>
<td>The file specified with â€“defaults-extra-file, if any</td>
</tr>
<tr>
<td>~&#x2F;.my.cn</td>
<td>User-specific options</td>
</tr>
<tr>
<td>~&#x2F;.mylogin.cnf</td>
<td>User-specific login path options (clients only)</td>
</tr>
<tr>
<td>DATADIR&#x2F;mysqld-auto.cnf</td>
<td>System variables persisted with SET PERSIST or SET PERSIST_ONLY (server only)</td>
</tr>
</tbody></table>
<p>å¦‚æœ <code>/etc/my.cnf </code> å’Œ <code>~/.my.cn</code> ä¸‹éƒ½æœ‰ç›¸åŒçš„é…ç½®ï¼Œåˆ™ä½¿ç”¨çš„æ˜¯ <code> ~/.my.cn</code> é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹</p>
<p><strong>ç›¸åŒé…ç½®æ–‡ä»¶çš„ä¼˜å…ˆçº§</strong></p>
<ol>
<li><code>mysql</code> é…ç½®æ–‡ä»¶æœ‰å¤šä¸ª <code>group</code></li>
<li>è‹¥æ˜¯åœ¨ä¸åŒçš„ <code>group</code> ä¸­å‡ºç°ç›¸åŒçš„é…ç½®åˆ™ä»¥æœ€åä¸€ä¸ª <code>group</code> ä¸­å‡ºç°çš„é…ç½®ä¸ºå‡†ï¼ˆå‰ææ˜¯å¯¹åº”çš„ç¨‹åºä¼šè¯»å–è¿™ä¸ª <code>group</code> çš„é…ç½®ï¼‰</li>
</ol>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysqlé”æœºåˆ¶è¯¦è§£</title>
    <url>/2023/fefcb42b5b82/index.html</url>
    <content><![CDATA[<h2 id="Mysql-ä¸­é”çš„æ¦‚å¿µ"><a href="#Mysql-ä¸­é”çš„æ¦‚å¿µ" class="headerlink" title="Mysql ä¸­é”çš„æ¦‚å¿µ"></a>Mysql ä¸­é”çš„æ¦‚å¿µ</h2><p>é”æ˜¯æ•°æ®åº“ç³»ç»ŸåŒºåˆ«äºæ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªå…³é”®ç‰¹æ€§ã€‚é”æœºåˆ¶ç”¨äºç®¡ç†å¯¹å…±äº«èµ„æºçš„å¹¶å‘è®¿é—®</p>
<h2 id="Mysql-ä¸­ä¸é”ç›¸å…³çš„è¡¨"><a href="#Mysql-ä¸­ä¸é”ç›¸å…³çš„è¡¨" class="headerlink" title="Mysql ä¸­ä¸é”ç›¸å…³çš„è¡¨"></a>Mysql ä¸­ä¸é”ç›¸å…³çš„è¡¨</h2><h3 id="Mysql5-ç‰ˆæœ¬"><a href="#Mysql5-ç‰ˆæœ¬" class="headerlink" title="Mysql5.* ç‰ˆæœ¬"></a>Mysql5.* ç‰ˆæœ¬</h3><ol>
<li><code>information_schema.INNODB_TRX</code></li>
<li><code>information_schema.INNODB_LOCKS</code></li>
<li><code>information_schema.INNODB_LOCK_WAITS</code></li>
</ol>
<h3 id="Mysql8-ç‰ˆæœ¬"><a href="#Mysql8-ç‰ˆæœ¬" class="headerlink" title="Mysql8 ç‰ˆæœ¬"></a>Mysql8 ç‰ˆæœ¬</h3><ol>
<li><code>information_schema.INNODB_TRX</code></li>
<li><code>performance_schema.INNODB_LOCKS</code></li>
<li><code>performance_schema.INNODB_LOCK_WAITS</code></li>
</ol>
<h2 id="å…±äº«é”å’Œäº’æ–¥é”"><a href="#å…±äº«é”å’Œäº’æ–¥é”" class="headerlink" title="å…±äº«é”å’Œäº’æ–¥é”"></a>å…±äº«é”å’Œäº’æ–¥é”</h2><p>å…±äº«é”ç®€å†™ä¸º      S<br>æ„å‘å…±äº«é”ç®€å†™ä¸º  IS<br>æ’ä»–é”ç®€å†™ä¸º      X<br>æ„å‘æ’ä»–é”ç®€å†™ä¸º  IX</p>
<table>
<thead>
<tr>
<th>é”ç±»å‹</th>
<th>ç‹¬å é”</th>
<th>å…±äº«é”</th>
</tr>
</thead>
<tbody><tr>
<td>ç‹¬å é”</td>
<td>äº’æ–¥</td>
<td>äº’æ–¥</td>
</tr>
<tr>
<td>å…±äº«é”</td>
<td>äº’æ–¥</td>
<td>ä¸äº’æ–¥</td>
</tr>
</tbody></table>
<ul>
<li><code>Mysql</code> æŸ¥è¯¢æ“ä½œé»˜è®¤é»˜è®¤ä¸ä¼šåŠ é”</li>
<li><code>Mysql</code> åœ¨è¯»å’Œå†™ä¹‹é—´ä¸ä¼šäº’æ–¥ï¼Œå› ä¸ºå¯¹äºè¯»æ“ä½œæ˜¯ç›´æ¥ä½¿ç”¨ <code>MVCC</code> æ¥å®ç°</li>
<li>æ‰‹åŠ¨ç»™ <code>select</code> å¢åŠ å…±äº«é”çš„æ–¹å¼æ˜¯  <code>select * from table_name lock in share mode;</code></li>
<li>æ‰‹åŠ¨ç»™ <code>select</code> å¢åŠ ç‹¬å é”çš„æ–¹å¼æ˜¯   <code>select * from table_name for update;</code></li>
</ul>
<h2 id="è¡¨çº§é”"><a href="#è¡¨çº§é”" class="headerlink" title="è¡¨çº§é”"></a>è¡¨çº§é”</h2><p>è¡¨çº§é”åˆ†ä¸ºä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯ <strong>è¡¨é”</strong> å’Œ <strong>è¡¨çº§æ„å‘é”</strong></p>
<p><strong>è¡¨é”</strong></p>
<ol>
<li>è¡¨çº§å…±äº«é”ï¼š <code>LOCK TABLES xxx READ</code></li>
<li>è¡¨çº§ç‹¬å é”ï¼š <code>LOCK TABLES xxx WRITE</code></li>
</ol>
<p>å¯ä»¥ä½¿ç”¨ <code>unlock tables;</code> æ¥é‡Šæ”¾æ‰€æœ‰çš„è¡¨çº§é”</p>
<p><strong>è¡¨çº§æ„å‘é”</strong></p>
<ul>
<li>æ›´æ–°æ•°æ®æ—¶ï¼Œé™¤äº†ä¼šå¢åŠ è¡Œçº§é”å¤–ï¼Œè¿˜ä¼šå¢åŠ ä¸€ä¸ª è¡¨çº§æ„å‘ç‹¬å é”</li>
<li>åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå¦‚æœæ‰§è¡Œäº†æŸ¥è¯¢æ“ä½œï¼Œé‚£ä¹ˆä¼šåœ¨å¯¹åº”çš„è¡¨çº§åŠ ä¸€ä¸ªæ„å‘å…±äº«é”</li>
</ul>
<h3 id="ä¸¤ç§è¡¨çº§é”çš„äº’æ–¥å…³ç³»"><a href="#ä¸¤ç§è¡¨çº§é”çš„äº’æ–¥å…³ç³»" class="headerlink" title="ä¸¤ç§è¡¨çº§é”çš„äº’æ–¥å…³ç³»"></a>ä¸¤ç§è¡¨çº§é”çš„äº’æ–¥å…³ç³»</h3><p><strong>æ‰‹åŠ¨æ·»åŠ çš„è¡¨é”</strong>å’Œè¡¨çº§æ„å‘é”æ˜¯å­˜åœ¨äº’æ–¥å…³ç³»çš„ï¼Œå¯¹åº”çš„äº’æ–¥å…³ç³»å¦‚ä¸‹</p>
<table>
<thead>
<tr>
<th align="center">é”ç±»å‹(éƒ½æ˜¯è¡¨çº§)</th>
<th align="center">ç‹¬å é”</th>
<th align="center">æ„å‘ç‹¬å é”</th>
<th align="center">å…±äº«é”</th>
<th align="center">æ„å‘å…±äº«é”</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ç‹¬å é”</td>
<td align="center">äº’æ–¥</td>
<td align="center">äº’æ–¥</td>
<td align="center">äº’æ–¥</td>
<td align="center">äº’æ–¥</td>
</tr>
<tr>
<td align="center">æ„å‘ç‹¬å é”</td>
<td align="center">äº’æ–¥</td>
<td align="center">ä¸äº’æ–¥</td>
<td align="center">äº’æ–¥</td>
<td align="center">ä¸äº’æ–¥</td>
</tr>
<tr>
<td align="center">å…±äº«é”</td>
<td align="center">äº’æ–¥</td>
<td align="center">äº’æ–¥</td>
<td align="center">ä¸äº’æ–¥</td>
<td align="center">ä¸äº’æ–¥</td>
</tr>
<tr>
<td align="center">æ„å‘å…±äº«é”</td>
<td align="center">äº’æ–¥</td>
<td align="center">ä¸äº’æ–¥</td>
<td align="center">ä¸äº’æ–¥</td>
<td align="center">ä¸äº’æ–¥</td>
</tr>
</tbody></table>
<h3 id="è¡¨çº§æ„å‘é”çš„ä½œç”¨"><a href="#è¡¨çº§æ„å‘é”çš„ä½œç”¨" class="headerlink" title="è¡¨çº§æ„å‘é”çš„ä½œç”¨"></a>è¡¨çº§æ„å‘é”çš„ä½œç”¨</h3><ul>
<li><code>InnoDB</code> å­˜å‚¨å¼•æ“å¯¹æ ‡çš„è¡Œè®°å½•æ·»åŠ  <code>S</code> é”ä¹‹å‰ï¼Œä¼šå…ˆåœ¨è¡¨çº§åˆ«æ·»åŠ ä¸€ä¸ª <code>IS</code> é”</li>
<li><code>InnoDB</code> å­˜å‚¨å¼•æ“å¯¹æ ‡çš„è¡Œè®°å½•æ·»åŠ  <code>X</code> é”ä¹‹å‰ï¼Œä¼šå…ˆåœ¨è¡¨çº§åˆ«æ·»åŠ ä¸€ä¸ª <code>IX</code> é” </li>
<li><code>IS</code> é”å’Œ <code>IX</code> é”çš„ä½œç”¨æ˜¯ä¸ºäº†åç»­åœ¨åŠ è¡¨çº§åˆ«çš„ <code>S</code> é”å’Œ <code>X</code> é”æ—¶åˆ¤æ–­è¡¨ä¸­æ˜¯å¦æœ‰å·²ç»è¢«åŠ é”çš„è®°å½•ï¼Œä»¥é¿å…ç”¨éå†çš„æ–¹å¼æ¥æŸ¥çœ‹è¡¨ä¸­æœ‰æ²¡æœ‰ä¸Šé”çš„è®°å½•ï¼Œä¸‹é¢ä¸¾ä¾‹è¯´æ˜</li>
</ul>
<p>äº‹åŠ¡ A ä¿®æ”¹ä¸€æ¡æ•°æ®ï¼Œæ‰€ä»¥äº‹åŠ¡ A ä¼šç»™è¿™æ¡æ•°æ®å¢åŠ  <strong>è¡Œé”</strong>(ä¸‹é¢ä¼šè®²è§£)</p>
<p>äº‹åŠ¡ B æƒ³è¦æ·»åŠ è¡¨çº§æ’ä»–é”ï¼Œå› ä¸ºæ˜¯è¡¨çº§ï¼Œæ‰€ä»¥å¯ä»¥ç†è§£æˆä¼šç»™æ‰€æœ‰è¡Œéƒ½ä¸Šé”ï¼Œå› ä¸ºäº‹åŠ¡ A å·²ç»ä¸Šé”æˆåŠŸï¼Œäº‹åŠ¡ B è‚¯å®šæ˜¯æ— æ³•åŠ é”æˆåŠŸçš„ï¼Œè¿™ç‚¹æ²¡æœ‰ç–‘é—®ï¼Œé—®é¢˜å°±æ˜¯åˆ¤æ–­çš„è¿‡ç¨‹ï¼Œäº‹åŠ¡ B æ€ä¹ˆçŸ¥é“å“ªä¸€è¡ŒåŠ é”äº†å‘¢? é‚£åªèƒ½ä¸€è¡Œä¸€è¡Œå»åˆ¤æ–­äº†ï¼Œè¿™æ ·æ•ˆç‡å°±å¾ˆä½äº†ï¼Œæ‰€ä»¥æ‰æœ‰äº†æ„å‘é”ï¼Œä¹Ÿå°±æ˜¯è¯´å®é™…æƒ…å†µä¼šæ˜¯ä¸‹é¢è¿™æ ·çš„</p>
<p>äº‹åŠ¡ A ä¿®æ”¹ä¸€æ¡æ•°æ®ï¼Œæ‰€ä»¥äº‹åŠ¡ A ä¼šç»™è¿™æ¡æ•°æ®å¢åŠ  <strong>è¡Œé”</strong>(ä¸‹é¢ä¼šè®²è§£)ï¼ŒåŒæ—¶ä¼šç»™è¿™å¼ è¡¨åŠ ä¸€ä¸ªæ„å‘æ’ä»–é”</p>
<p>äº‹åŠ¡ B æƒ³è¦æ·»åŠ è¡¨çº§æ’ä»–é”ï¼Œä¸€çœ‹å‘ç°è¿™ä¸ªè¡¨ä¸Šé¢å·²ç»å­˜åœ¨äº† æ„å‘æ’ä»–é”ï¼Œæ ¹æ®ä¸Šé¢çš„äº’æ–¥å…³ç³»è¡¨ï¼Œå¯ä»¥çŸ¥é“ï¼Œè¡¨çº§æ’ä»–é”å’Œè¡¨çº§æ„å‘æ’ä»–é”æ˜¯äº’æ–¥çš„ï¼Œé‚£äº‹åŠ¡ B å°±ä¸èƒ½åŠ é”æˆåŠŸäº†ï¼Œè¿™æ ·åªéœ€è¦åˆ¤æ–­ä¸€æ¬¡ï¼Œæ•ˆç‡æ˜æ˜¾æé«˜</p>
<h2 id="è¡Œçº§é”"><a href="#è¡Œçº§é”" class="headerlink" title="è¡Œçº§é”"></a>è¡Œçº§é”</h2><ul>
<li>å‰é¢è®²è§£çš„æ˜¯è¡¨çº§é”ï¼Œè¡¨çº§æ„å‘é”æ˜¯ <code>InnoDB</code> è‡ªåŠ¨å¸®æˆ‘ä»¬æ·»åŠ çš„ï¼Œä¿®æ”¹æ•°æ®æ—¶ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æ·»åŠ  <strong>è¡¨çº§æ„å‘ç‹¬å é”</strong>ï¼Œè‡³äºæ‰‹åŠ¨æ·»åŠ çš„æƒ…å†µæ¯”è¾ƒå°‘ï¼Œæ¥ä¸‹æ¥éœ€è¦è®²è§£çš„å°±æ˜¯è¡Œçº§é”äº†</li>
<li>è¡Œçº§é”é”ä½çš„æ˜¯ç´¢å¼•</li>
</ul>
<h3 id="è¡Œçº§é”çš„åˆ†ç±»"><a href="#è¡Œçº§é”çš„åˆ†ç±»" class="headerlink" title="è¡Œçº§é”çš„åˆ†ç±»"></a>è¡Œçº§é”çš„åˆ†ç±»</h3><ul>
<li><code>Record Locks</code>ï¼š è®°å½•é”ï¼Œ å®˜æ–¹æ­£å¼çš„åç§°æ˜¯ <code>LOCK_REC_NOT_GAP</code>ï¼Œå¯¹å¯¹åº”çš„ç´¢å¼•è®°å½•é¡¹åŠ é”ï¼Œ <strong>è¡¨ä¸­å±•ç¤ºçš„æ˜¯ <code>X,REC_NOT_GAP</code></strong></li>
<li><code>Gap Locks</code>ï¼š é—´éš™é”ï¼Œé”ä½çš„æ˜¯ç´¢å¼•ä¹‹é—´çš„é—´éš™ï¼Œ** è¡¨ä¸­å±•ç¤ºçš„æ˜¯ <code>X,GAP</code>**</li>
<li><code>Next-key Lock</code>ï¼š é‚»é”®é” <code>Next-key Lock</code> &#x3D; <code>Gap Locks</code> + <code>Record Locks</code>, <strong>è¡¨ä¸­å±•ç¤ºçš„æ˜¯ <code>X</code></strong></li>
<li><code>Insert Intention Locks</code>ï¼š æ’å…¥æ•°æ®æ—¶éœ€è¦æ’å…¥çš„ä½ç½®æ˜¯å¦è¢«åˆ«çš„äº‹åŠ¡æ·»åŠ äº† <code>Gap</code> é”ï¼ˆä¹Ÿå°±æ˜¯ <code>Gap Locks</code> æˆ– <code>Next-key Lock</code> ï¼‰ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œå½“å‰äº‹åŠ¡çš„æ’å…¥æ“ä½œéœ€è¦ç­‰å¾…ï¼Œç›´åˆ°æ‹¥æœ‰ <code>Gap</code> é”çš„äº‹åŠ¡æäº¤ã€‚æ­¤æ—¶å¯¹äºç­‰å¾…çš„é‚£ä¸ªäº‹åŠ¡å°±ä¼šæ·»åŠ ä¸€ä¸ª <code>Insert Intention Locks</code></li>
</ul>
<h2 id="Mysql8-REPEATABLE-READ-éš”ç¦»çº§åˆ«ä¸‹é”ç¤ºä¾‹"><a href="#Mysql8-REPEATABLE-READ-éš”ç¦»çº§åˆ«ä¸‹é”ç¤ºä¾‹" class="headerlink" title="Mysql8 REPEATABLE-READ éš”ç¦»çº§åˆ«ä¸‹é”ç¤ºä¾‹"></a>Mysql8 REPEATABLE-READ éš”ç¦»çº§åˆ«ä¸‹é”ç¤ºä¾‹</h2><p>åˆ›å»ºæµ‹è¯•è¡¨</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> student<br>(<br>    id   <span class="hljs-type">int</span>          <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span><br>        <span class="hljs-keyword">primary</span> key,<br>    name <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">null</span>,<br>    id_card <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span><br>) engine <span class="hljs-operator">=</span> InnoDB;<br><br><span class="hljs-keyword">create</span> index s_name <span class="hljs-keyword">on</span> student (name);<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">unique</span> index s_id_card <span class="hljs-keyword">on</span> student(id_card);<br></code></pre></td></tr></table></figure>
<ul>
<li>è¡¨ä¸­æœ‰ä¸‰ä¸ªå­—æ®µï¼Œä¸€ä¸ªæ˜¯ä¸»é”® <code>id</code></li>
<li>é’ˆå¯¹ <code>name</code> å­—æ®µåˆ›å»ºäº†ä¸€ä¸ªæ™®é€šç´¢å¼•</li>
<li>é’ˆå¯¹ <code>id_card</code> å­—æ®µåˆ›å»ºäº†ä¸€ä¸ªå”¯ä¸€ç´¢å¼•</li>
</ul>
<p>æ’å…¥æµ‹è¯•æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs Sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> student(id, name, id_card) <span class="hljs-keyword">values</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;name1&#x27;</span>, <span class="hljs-string">&#x27;1_card&#x27;</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> student(id, name, id_card) <span class="hljs-keyword">values</span> (<span class="hljs-number">5</span>, <span class="hljs-string">&#x27;name5&#x27;</span>, <span class="hljs-string">&#x27;5_card&#x27;</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> student(id, name, id_card) <span class="hljs-keyword">values</span> (<span class="hljs-number">10</span>, <span class="hljs-string">&#x27;name10&#x27;</span>, <span class="hljs-string">&#x27;10_card&#x27;</span>);<br></code></pre></td></tr></table></figure>

<p>å…ˆåœ¨ <code>student</code> è¡¨é’ˆå¯¹ <code>id</code> å­—æ®µçš„é‚»é”®é”ä¸º</p>
<ul>
<li>ï¼ˆ-âˆï¼Œ 1]</li>
<li>ï¼ˆ1ï¼Œ 5]</li>
<li>ï¼ˆ5ï¼Œ 10]</li>
<li>ï¼ˆ10ï¼Œ +âˆ]  +âˆ ä½¿ç”¨çš„æ˜¯ <code>supremum</code> ä»£æ›¿</li>
</ul>
<h3 id="æµ‹è¯•å‰å…³é—­äº‹åŠ¡çš„è‡ªåŠ¨æäº¤"><a href="#æµ‹è¯•å‰å…³é—­äº‹åŠ¡çš„è‡ªåŠ¨æäº¤" class="headerlink" title="æµ‹è¯•å‰å…³é—­äº‹åŠ¡çš„è‡ªåŠ¨æäº¤"></a>æµ‹è¯•å‰å…³é—­äº‹åŠ¡çš„è‡ªåŠ¨æäº¤</h3><p>æŸ¥çœ‹äº‹åŠ¡è‡ªåŠ¨æäº¤çŠ¶æ€</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs Sql"><span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;autocommit&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>å…³é—­äº‹åŠ¡è‡ªåŠ¨æäº¤</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs Sql"><span class="hljs-keyword">SET</span> autocommit <span class="hljs-operator">=</span> OFF;<br></code></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥æ˜¾å¼å¼€å¯äº‹åŠ¡ï¼Œå³ä½¿ç”¨ <code>begin</code> å¼€å¯äº‹åŠ¡ï¼Œç„¶åä½¿ç”¨ <code>commit</code> æäº¤äº‹åŠ¡ï¼Œä½¿ç”¨ <code>rollback</code> å›æ»šäº‹åŠ¡</p>
<h3 id="æµ‹è¯•å‰ä¿®æ”¹é”ç­‰å¾…è¶…æ—¶æ—¶é—´"><a href="#æµ‹è¯•å‰ä¿®æ”¹é”ç­‰å¾…è¶…æ—¶æ—¶é—´" class="headerlink" title="æµ‹è¯•å‰ä¿®æ”¹é”ç­‰å¾…è¶…æ—¶æ—¶é—´"></a>æµ‹è¯•å‰ä¿®æ”¹é”ç­‰å¾…è¶…æ—¶æ—¶é—´</h3><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs Sql"><span class="hljs-comment">-- æŸ¥çœ‹é”ç­‰å¾…è¶…æ—¶æ—¶é—´</span><br><span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;innodb_lock_wait_timeout&#x27;</span>;<br><span class="hljs-comment">-- è®¾ç½®é”ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤æ˜¯50ï¼Œå•ä½æ˜¯sï¼Œè¿™é‡Œè®¾ç½® 600s, æ²¡æœ‰æ·»åŠ  global å°±æ˜¯å½“å‰ ä¼šè¯æœ‰æ•ˆ</span><br><span class="hljs-keyword">set</span> <span class="hljs-keyword">global</span> innodb_lock_wait_timeout<span class="hljs-operator">=</span><span class="hljs-number">600</span>;<br></code></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨ä¸»é”®è¿›è¡Œæ“ä½œçš„åœºæ™¯"><a href="#ä½¿ç”¨ä¸»é”®è¿›è¡Œæ“ä½œçš„åœºæ™¯" class="headerlink" title="ä½¿ç”¨ä¸»é”®è¿›è¡Œæ“ä½œçš„åœºæ™¯"></a>ä½¿ç”¨ä¸»é”®è¿›è¡Œæ“ä½œçš„åœºæ™¯</h3><p>éœ€è¦å¼€å¯ä¸‰ä¸ªçª—å£ï¼Œä»¥ä¸‹ç®€ç§°ä¸º <strong>çª—å£1</strong>ï¼Œ<strong>çª—å£2</strong>ï¼Œ<strong>çª—å£3</strong>ï¼Œå…¶ä¸­ç¬¬ä¸‰ä¸ªçª—å£å¯ä»¥ä¸ç”¨å…³é—­è‡ªåŠ¨æäº¤ï¼Œè¿™ä¸ªçª—å£ä¸»è¦æ˜¯æ¥æŸ¥è¯¢ <code>information_schema.INNODB_TRX</code> å’Œ <code>performance_schema.data_locks</code> è§‚å¯Ÿé”çŠ¶æ€</p>
<ol>
<li><p><strong>çª—å£1</strong> æ‰§è¡Œ</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs Sql"><span class="hljs-keyword">update</span> student <span class="hljs-keyword">set</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;name5_1&#x27;</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>çª—å£3</strong> æ‰§è¡Œä¸‹é¢è¯­å¥æŸ¥çœ‹é”çŠ¶æ€</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs Sql"><span class="hljs-keyword">select</span> ENGINE_LOCK_ID, ENGINE_TRANSACTION_ID, INDEX_NAME,LOCK_TYPE, LOCK_MODE, LOCK_DATA <span class="hljs-keyword">from</span> performance_schema.data_locks;<br></code></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹</p>
<table>
<thead>
<tr>
<th align="left">ENGINE_LOCK_ID</th>
<th align="left">ENGINE_TRANSACTION_ID</th>
<th align="left">INDEX_NAME</th>
<th align="left">LOCK_TYPE</th>
<th align="left">LOCK_MODE</th>
<th align="left">LOCK_DATA</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1853609022608:1067:1853614658072</td>
<td align="left">4188</td>
<td align="left">null</td>
<td align="left">TABLE</td>
<td align="left">IX</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">1853609022608:5:4:5:1853598537752</td>
<td align="left">4188</td>
<td align="left">PRIMARY</td>
<td align="left">RECORD</td>
<td align="left">X,REC_NOT_GAP</td>
<td align="left">5</td>
</tr>
</tbody></table>
</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ <code>id</code> æ¡ä»¶æ›´æ–°ï¼Œä¼šç»™è¡¨å¢åŠ  <code>IX</code> é”ï¼Œç»™ <code>id=5</code> è¿™æ¡è®°å½•å¢åŠ  <code>X,REC_NOT_GAP</code> ï¼Œè¿™å°±æ˜¯ <code>Record Lock</code></p>
<ol start="3">
<li><p><strong>çª—å£2</strong> æ‰§è¡Œä¸‹é¢è¯­å¥ï¼ˆåœ¨è¿™é‡Œçª—å£1çš„äº‹åŠ¡å¹¶æ²¡æœ‰æäº¤ï¼‰</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs Sql"><span class="hljs-keyword">update</span> student <span class="hljs-keyword">set</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;name5_2&#x27;</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>çª—å£3</strong> æ‰§è¡Œä¸‹é¢è¯­å¥æŸ¥çœ‹é”çŠ¶æ€</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs Sql"><span class="hljs-keyword">select</span> ENGINE_LOCK_ID, ENGINE_TRANSACTION_ID, INDEX_NAME,LOCK_TYPE, LOCK_MODE, LOCK_DATA <span class="hljs-keyword">from</span> performance_schema.data_locks;<br></code></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="left">ENGINE_LOCK_ID</th>
<th align="left">ENGINE_TRANSACTION_ID</th>
<th align="left">INDEX_NAME</th>
<th align="left">LOCK_TYPE</th>
<th align="left">LOCK_MODE</th>
<th align="left">LOCK_DATA</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1853609023384:1067:1853614658840</td>
<td align="left">4193</td>
<td align="left">null</td>
<td align="left">TABLE</td>
<td align="left">IX</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">1853609023384:5:4:5:1853598540824</td>
<td align="left">4193</td>
<td align="left">PRIMARY</td>
<td align="left">RECORD</td>
<td align="left">X,REC_NOT_GAP</td>
<td align="left">5</td>
</tr>
<tr>
<td align="left">1853609022608:1067:1853614658072</td>
<td align="left">4188</td>
<td align="left">null</td>
<td align="left">TABLE</td>
<td align="left">IX</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">1853609022608:5:4:5:1853598537752</td>
<td align="left">4188</td>
<td align="left">PRIMARY</td>
<td align="left">RECORD</td>
<td align="left">X,REC_NOT_GAP</td>
<td align="left">5</td>
</tr>
</tbody></table>
</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡ <code>4193</code>(çª—å£1çš„é‚£ä¸ªäº‹åŠ¡ <code>id</code> æ˜¯ <code>4188</code>)ï¼Œ ä¹Ÿæ˜¯ç»™è¡¨å¢åŠ äº† <code>IX</code> é”ï¼Œç»™ <code>id=5</code> é‚£ä¸€è¡Œå¢åŠ äº† <code>X,REC_NOT_GAP</code></p>
<p>æ¥ä¸‹æ¥è¿˜æ˜¯åœ¨çª—å£3æ‰§è¡Œä¸‹é¢ä¸¤æ¡è¯­å¥ï¼Œçœ‹ä¸‹äº‹åŠ¡ç­‰å¾…çŠ¶æ€<br>å…ˆæ‰§è¡Œ</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs Sql"><span class="hljs-keyword">select</span> trx_id, trx_state, trx_requested_lock_id, trx_wait_started <span class="hljs-keyword">from</span> information_schema.INNODB_TRX;<br></code></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="left">trx_id</th>
<th align="left">trx_state</th>
<th align="left">trx_requested_lock_id</th>
<th align="left">trx_wait_started</th>
</tr>
</thead>
<tbody><tr>
<td align="left">4193</td>
<td align="left">LOCK WAIT</td>
<td align="left">1853609023384:5:4:5:1853598540824</td>
<td align="left">2023-12-14 08:58:05</td>
</tr>
<tr>
<td align="left">4188</td>
<td align="left">RUNNING</td>
<td align="left">null</td>
<td align="left">null</td>
</tr>
<tr>
<td align="left">å¯ä»¥çœ‹åˆ° <code>4188</code> è¿™ä¸ªäº‹åŠ¡åœ¨è¿è¡Œä¸­ï¼Œ<code>4193</code>ï¼ˆç¬¬äºŒä¸ªçª—å£çš„äº‹åŠ¡ï¼‰æ˜¯ <code>lock wait</code> çŠ¶æ€ï¼Œ åŒæ—¶å¯ä»¥çœ‹åˆ° <code>4193</code> è¿™ä¸ªäº‹åŠ¡çš„ <code>trx_requested_lock_id=1853609023384:5:4:5:1853598540824</code></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">æ¥ä¸‹æ¥æ‰§è¡Œå¦‚ä¸‹ sql</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs Sql"><span class="hljs-keyword">select</span> REQUESTING_ENGINE_LOCK_ID,  BLOCKING_ENGINE_TRANSACTION_ID, BLOCKING_THREAD_ID <span class="hljs-keyword">from</span> performance_schema.data_lock_waits;<br></code></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="left">REQUESTING_ENGINE_LOCK_ID</th>
<th align="left">BLOCKING_ENGINE_TRANSACTION_ID</th>
<th align="left">BLOCKING_THREAD_ID</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1853609023384:5:4:5:1853598540824</td>
<td align="left">4188</td>
<td align="left">68</td>
</tr>
</tbody></table>
<p>å¯ä»¥çœ‹åˆ° <code>trx_requested_lock_id=1853609023384:5:4:5:1853598540824</code> å°±æ˜¯è¢« <code>4188</code> è¿™ä¸ªäº‹åŠ¡æ‰€é˜»å¡çš„</p>
<p><strong>æ¥ä¸‹æ¥æ€»ç»“ä¸€ä¸‹ï¼šä½¿ç”¨ä¸»é”®è¿›è¡Œç­‰å€¼æ›´æ–°ï¼Œæ·»åŠ çš„æ˜¯ <code>Record Lock</code></strong></p>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Windowä¸‹å®‰è£…mysql8è§£å‹ç‰ˆ</title>
    <url>/2023/ff432902bea0/index.html</url>
    <content><![CDATA[<ul>
<li><a href="https://dev.mysql.com/downloads/mysql/">ä¸‹è½½Mysql8</a>ï¼Œ é€‰æ‹© <code>Windows (x86, 64-bit), ZIP Archive</code> è¿™ä¸ª</li>
<li>è§£å‹åˆ°æŸä¸ªç›®å½•ï¼Œæ¯”å¦‚ <code>E:\config\mysql-8.2.0-winx64</code>ï¼Œ è¿™å°±æ˜¯ <code>Mysql</code> å®‰è£…ç›®å½•</li>
<li>åœ¨ <code>Mysql</code> å®‰è£…ç›®å½•ä¸‹æ–°å»º <code>data</code> ç›®å½•ç”¨æ¥å­˜æ”¾æ•°æ®ï¼Œå³ <code>data</code> ç›®å½•å…¨è·¯å¾„ä¸º <code>E:\config\mysql-8.2.0-winx64\data</code></li>
<li>åœ¨ <code>Mysql</code> å®‰è£…ç›®å½•ä¸‹æ–°å»ºé…ç½®æ–‡ä»¶ <code>my.cnf</code>, å†…å®¹å¦‚ä¸‹</li>
</ul>
<figure class="highlight ini"><table><tr><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[mysqld]</span><br><span class="hljs-comment">#è®¾ç½®æ—¶åŒºä¸ºä¸œå…«åŒºï¼Œæ­¤é¡¹è®¾ç½®åï¼Œåœ¨è¿æ¥MySQLçš„æ—¶å€™å¯ä»¥ä¸ç”¨æ¯æ¬¡éƒ½æ‰‹åŠ¨è®¾ç½®æ—¶åŒº</span><br><span class="hljs-attr">default-time-zone</span> = <span class="hljs-string">&#x27;+8:00&#x27;</span><br><span class="hljs-comment"># è®¾ç½®3306ç«¯å£</span><br><span class="hljs-attr">port</span>=<span class="hljs-number">3306</span><br><span class="hljs-comment"># è®¾ç½®mysqlçš„å®‰è£…ç›®å½•ï¼Œæ›¿æ¢ä¸ºè‡ªå·±çš„è·¯å¾„</span><br><span class="hljs-attr">basedir</span>=E:\config\mysql-<span class="hljs-number">8.2</span>.<span class="hljs-number">0</span>-winx64<br><span class="hljs-comment"># è®¾ç½®mysqlæ•°æ®åº“çš„æ•°æ®çš„å­˜æ”¾ç›®å½•ï¼Œ æ›¿æ¢ä¸ºè‡ªå·±çš„è·¯å¾„</span><br><span class="hljs-attr">datadir</span>=E:\config\mysql-<span class="hljs-number">8.2</span>.<span class="hljs-number">0</span>-winx64\data<br><span class="hljs-comment"># å…è®¸æœ€å¤§è¿æ¥æ•°</span><br><span class="hljs-attr">max_connections</span>=<span class="hljs-number">200</span><br><span class="hljs-comment"># å…è®¸è¿æ¥å¤±è´¥çš„æ¬¡æ•°</span><br><span class="hljs-attr">max_connect_errors</span>=<span class="hljs-number">10</span><br><span class="hljs-comment"># æœåŠ¡ç«¯ä½¿ç”¨çš„å­—ç¬¦é›†é»˜è®¤ä¸ºUTF8</span><br><span class="hljs-attr">character-set-server</span>=utf8<br><span class="hljs-comment"># åˆ›å»ºæ–°è¡¨æ—¶å°†ä½¿ç”¨çš„é»˜è®¤å­˜å‚¨å¼•æ“</span><br><span class="hljs-attr">default-storage-engine</span>=INNODB<br><span class="hljs-comment"># é»˜è®¤ä½¿ç”¨â€œmysql_native_passwordâ€æ’ä»¶è®¤è¯</span><br><span class="hljs-attr">default_authentication_plugin</span>=mysql_native_password<br><br><br><span class="hljs-section">[mysql]</span><br><span class="hljs-comment"># è®¾ç½®mysqlå®¢æˆ·ç«¯é»˜è®¤å­—ç¬¦é›†</span><br><span class="hljs-attr">default-character-set</span>=utf8<br><span class="hljs-section">[client]</span><br><span class="hljs-comment"># è®¾ç½®mysqlå®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯æ—¶é»˜è®¤ä½¿ç”¨çš„ç«¯å£</span><br><span class="hljs-attr">port</span>=<span class="hljs-number">3306</span><br><span class="hljs-attr">default-character-set</span>=utf8<br></code></pre></td></tr></table></figure>

<ul>
<li>ä½¿ç”¨ç®¡ç†å‘˜èº«ä»½æ‰“å¼€ <code>cmd</code>, è¿›å…¥ <code>Mysql</code> å®‰è£…ç›®å½•ä¸‹çš„ <code>bin</code> ç›®å½•</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd"><span class="hljs-built_in">cd</span> E:\config\mysql-<span class="hljs-number">8</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>-winx64\bin<br>mysqld --initialize --console<br></code></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–å®Œæˆååœ¨ <code>cmd</code> çª—å£ä¼šå‡ºç° <code> A temporary password is generated for root@localhost: ,mDQ&gt;kFHI65w</code> å­—æ ·(å¯†ç ç”Ÿæˆçš„ä¸åŒ)ï¼Œ å¤åˆ¶ä¿å­˜è¿™ä¸ªå¯†ç </p>
<ul>
<li>ç»§ç»­åœ¨å½“å‰ <code>cmd</code> çª—å£æ‰§è¡Œ <code>mysqld --install</code> å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤æ˜¯å°† <code>Mysqld</code> ç¨‹åºä½œä¸ºå®‰è£…ä¸º <code>Windows</code> æœåŠ¡ï¼Œ è¿™æ ·å°±å¯ä»¥åœ¨ç³»ç»ŸæœåŠ¡ä¸­çœ‹åˆ° <code>Mysqld</code> äº†</li>
<li>æ‰§è¡Œ <code>net start MySQL</code> å°±å¯ä»¥å¯åŠ¨ <code>Mysql</code> æœåŠ¡äº†</li>
<li>æ‰§è¡Œ <code>mysql -u root -p</code> å‘½ä»¤ï¼Œç„¶åå¤åˆ¶ä¸Šé¢æ‹·è´å‡ºæ¥çš„ <code>,mDQ&gt;kFHI65w</code> å¯†ç ï¼Œç›´æ¥ç”¨è¿™ä¸ªå¯†ç å»ç™»å½•å°±è¡Œäº†</li>
<li>ä¿®æ”¹å¯†ç ä¸º <code>admin</code>, åç»­å°±å¯ä»¥ä½¿ç”¨ <code>root</code> è´¦å·å’Œ <code>admin</code> å¯†ç ç™»å½•äº†</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;admin&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜</strong><br>æ‰§è¡Œ <code>net start mysql</code> æ—¶å‡ºç° <strong>æ— æ³•å¯åŠ¨æœåŠ¡ï¼ŒåŸå› å¯èƒ½æ˜¯å·²è¢«ç¦ç”¨æˆ–ä¸å…¶ç›¸å…³è”çš„è®¾å¤‡æ²¡æœ‰å¯åŠ¨ã€‚</strong><br>æ­¤æ—¶å¯ä»¥å…ˆå¸è½½ <code>Mysql</code> æœåŠ¡å†é‡è¯•å®‰è£…</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml">mysqld -remove<br><span class="hljs-comment">&lt;!-- å¦‚æœä¸Šé¢æ‰§è¡Œä¸æˆåŠŸçš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤å¸è½½è¯•è¯• --&gt;</span><br>mysqld -nt -remove<br><span class="hljs-comment">&lt;!-- ç„¶åå†æ¬¡å®‰è£… --&gt;</span><br>mysqld -install<br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Postgresæ¸…é™¤idleç±»å‹çš„è¿æ¥</title>
    <url>/2023/d2329b029733/index.html</url>
    <content><![CDATA[<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- æŸ¥è¯¢ç©ºé—²è¿æ¥çš„æ•°é‡</span><br><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">FROM</span> pg_stat_activity <span class="hljs-keyword">WHERE</span> state<span class="hljs-operator">=</span><span class="hljs-string">&#x27;idle&#x27;</span>;<br><br><span class="hljs-comment">-- å…³é—­æ‰æ‰€æœ‰çš„ç©ºé—²è¿æ¥</span><br><span class="hljs-keyword">SELECT</span> pg_terminate_backend(pid) <span class="hljs-keyword">FROM</span> pg_stat_activity <span class="hljs-keyword">WHERE</span> state<span class="hljs-operator">=</span><span class="hljs-string">&#x27;idle&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>å¦‚æœçº¿ä¸Šç¯å¢ƒæ‰€æœ‰è¿æ¥å·²ç»è¢«å ç”¨ï¼Œæ— æ³•è¿›è¡Œæ§åˆ¶å°æ“ä½œï¼Œåˆ™å¯ä»¥è€ƒè™‘å¦‚ä¸‹æ–¹å¼</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">pkill -f idle; psql -Upostgres -d db_name<br></code></pre></td></tr></table></figure>
<p><code>pkill -f</code> å¯ä»¥æ ¹æ®å…³é”®å­—æ¥å…³æ‰è¿›ç¨‹ï¼Œè¿™é‡Œä½¿ç”¨çš„å…³é”®å­—æ˜¯ <code>idle</code><br><code>psql -Upostgres -d db_name</code> è¯¥å‘½ä»¤æ˜¯ç™»å½• <code>psql</code> å®¢æˆ·ç«¯ï¼Œè¿›å…¥ç‰¹å®šçš„æ•°æ®åº“</p>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>PostgreSQL</category>
      </categories>
      <tags>
        <tag>PostgreSQL</tag>
      </tags>
  </entry>
  <entry>
    <title>postgreså°†æ¯«ç§’å€¼è½¬æ¢æˆå­—ç¬¦ä¸²</title>
    <url>/2023/3a8e444a3e04/index.html</url>
    <content><![CDATA[<h2 id="åŸºæœ¬ä¿¡æ¯"><a href="#åŸºæœ¬ä¿¡æ¯" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h2><p>æ¯«ç§’å€¼ç±»å‹:  <code>numeric(13)</code></p>
<p>å­—æ®µåç§°: <code>check_time</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> to_char(to_timestamp(check_time <span class="hljs-operator">/</span> <span class="hljs-number">1000</span>) <span class="hljs-keyword">AT</span> <span class="hljs-type">TIME</span> ZONE <span class="hljs-string">&#x27;Asia/Shanghai&#x27;</span>, <span class="hljs-string">&#x27;YYYY-MM-DD HH24:MI:SS.MS&#x27;</span>) <span class="hljs-keyword">AS</span> check_time <span class="hljs-keyword">from</span> table_neme;<br></code></pre></td></tr></table></figure>

<h2 id="ä½¿ç”¨åˆ°çš„å‡½æ•°"><a href="#ä½¿ç”¨åˆ°çš„å‡½æ•°" class="headerlink" title="ä½¿ç”¨åˆ°çš„å‡½æ•°"></a>ä½¿ç”¨åˆ°çš„å‡½æ•°</h2><p><a href="http://www.postgres.cn/docs/12/functions-formatting.html">postgres12ç‰ˆæœ¬çš„æ—¥æœŸå‡½æ•°å‚è€ƒ</a></p>
<ol>
<li><code>to_timestamp</code>ï¼š å°† <strong>ç§’</strong> å€¼è½¬æ¢æˆ <code>timestamp</code> ç±»å‹ï¼Œ æ‰€ä»¥å¦‚æœæ˜¯æ¯«ç§’å€¼çš„è¯è¿˜éœ€è¦ <code>æ¯«ç§’å€¼/1000</code><ol>
<li><code>AT TIME ZONE &#39;Asia/Shanghai</code> ä»£è¡¨å°†è¿”å›çš„æ—¶é—´æˆ³æŒ‡å®šæ—¶åŒº</li>
</ol>
</li>
<li><code>to_char</code> å°† <code>timestamp</code> ç±»å‹è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œ å…¶ä¸­ <code>YYYY-MM-DD HH24:MI:SS.MS</code> ä»£è¡¨æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²<ol>
<li><code>HH24</code> ä»£è¡¨ 24 å°æ—¶åˆ¶</li>
<li><code>MI</code> è¡¨ç¤ºåˆ†é’Ÿ</li>
</ol>
</li>
</ol>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>PostgreSQL</category>
      </categories>
      <tags>
        <tag>PostgreSQL</tag>
      </tags>
  </entry>
  <entry>
    <title>gitå¿½ç•¥å·²ç»è¢«æäº¤çš„æ–‡ä»¶</title>
    <url>/2024/55b91fd7d632/index.html</url>
    <content><![CDATA[<h2 id="é—®é¢˜èƒŒæ™¯"><a href="#é—®é¢˜èƒŒæ™¯" class="headerlink" title="é—®é¢˜èƒŒæ™¯"></a>é—®é¢˜èƒŒæ™¯</h2><p>å¦‚æœå·²ç»ä½¿ç”¨ <code>git add</code> æˆ– <code>git commit</code> ç­‰å‘½ä»¤å¯¹æ–‡ä»¶è¿›è¡Œäº†æäº¤ï¼Œåç»­åœ¨  <code>.gitignore</code> æ–‡ä»¶ä¸­å†æƒ³å¿½ç•¥è¯¥æ–‡ä»¶æ˜¯æ— æ•ˆçš„</p>
<h2 id="è§£å†³æ–¹å¼"><a href="#è§£å†³æ–¹å¼" class="headerlink" title="è§£å†³æ–¹å¼"></a>è§£å†³æ–¹å¼</h2><p>ä¸»è¦æ˜¯ä¸¤ä¸ªæ­¥éª¤</p>
<ol>
<li><p>æ¸…é™¤æœ¬åœ°ç¼“å­˜ï¼Œå…·ä½“æƒ³è¦</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs git">&lt;!-- è¿™é‡Œæ˜¯åˆ é™¤å½“å‰ç›®å½•ä¸‹æ‰€æœ‰è¢«ç¼“å­˜çš„å†…å®¹ --&gt;<br>git rm --cached .<br>&lt;!-- åˆ é™¤å½“å‰ç›®å½•ä¸‹çš„ tomcat å­ç›®å½•æ‰€æœ‰å†…å®¹ --&gt;<br>git rm --cached tomcat\*<br></code></pre></td></tr></table></figure>
</li>
<li><p>é‡æ–°æäº¤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs git">git commit -m &#x27;add ignore&#x27;<br></code></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>tools</category>
        <category>git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>é€šè¿‡ideaæŸ¥æ‰¾æ³¨è§£è¢«ä½¿ç”¨çš„åœ°æ–¹</title>
    <url>/2023/4bed69252515/index.html</url>
    <content><![CDATA[<blockquote>
<p>ideaç‰ˆæœ¬: 2023.3</p>
</blockquote>
<p>åœ¨ <code>Mybatis</code> æ•´åˆ <code>SpringBoot</code> çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨ <code>MapperScan</code> æ³¨è§£ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å¿«é€ŸçŸ¥é“è¿™ä¸ªæ³¨è§£æ˜¯åœ¨å“ªé‡Œè¢«è§£æ(è¢«ä½¿ç”¨çš„)ï¼Œå¯ä»¥é€šè¿‡ <code>idea</code> çš„ <code>Find Usages</code> åŠŸèƒ½, å…·ä½“æ­¥éª¤å¦‚ä¸‹</p>
<ul>
<li>å…ˆè¿›å…¥ <code>MapperScan</code> æ³¨è§£ç±»ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯ <code>jar</code> åŒ…ï¼Œæ‰€ä»¥å¯ä»¥å…ˆ <code>download resource</code></li>
<li>å…‰æ ‡æ”¾åœ¨ <code>MapperScan</code> æ³¨è§£ä¸Š -&gt; å³é”® -&gt; <code>Find Usages</code></li>
</ul>
<p><img src="https://s2.loli.net/2023/12/28/RA4pDHQVjZgt15m.png" alt="Find UsagesåŠŸèƒ½"></p>
<p> <code>Scope</code> é€‰æ‹©é‚£ä¸ªç•Œé¢æ˜¯ç‚¹å‡»æœ€å·¦è¾¹çš„ <code>è®¾ç½®å›¾æ ‡</code> æŒ‰é’®å³å¯</p>
]]></content>
      <categories>
        <category>tools</category>
        <category>idea</category>
      </categories>
      <tags>
        <tag>idea</tag>
      </tags>
  </entry>
  <entry>
    <title>mavenç¼–è¯‘è·³è¿‡test</title>
    <url>/2023/5614a2f5fdca/index.html</url>
    <content><![CDATA[<h2 id="æ–¹å¼ä¸€"><a href="#æ–¹å¼ä¸€" class="headerlink" title="æ–¹å¼ä¸€"></a>æ–¹å¼ä¸€</h2><figure class="highlight armasm"><table><tr><td class="code"><pre><code class="hljs armasm"><span class="hljs-keyword">mvn</span> clean install -DskipTests<br></code></pre></td></tr></table></figure>

<h2 id="æ–¹å¼äºŒ"><a href="#æ–¹å¼äºŒ" class="headerlink" title="æ–¹å¼äºŒ"></a>æ–¹å¼äºŒ</h2><figure class="highlight cmake"><table><tr><td class="code"><pre><code class="hljs cmake">mvn clean <span class="hljs-keyword">install</span> -Dmaven.<span class="hljs-keyword">test</span>.skip=<span class="hljs-keyword">true</span><br></code></pre></td></tr></table></figure>
<p>å¦‚æœåœ¨ <code>window</code> ä¸­ä½¿ç”¨ <code>powershell</code> æˆ–åœ¨ <code>idea</code> çš„ç»ˆç«¯ä¸‹ä½¿ç”¨è¿™ç§æ–¹å¼å¯èƒ½ä¼šæç¤º <code>Unknown lifecycle phase &quot;.test.skip=true&quot;</code>ï¼Œæ­¤æ—¶éœ€è¦å¢åŠ å¼•å·ï¼Œæ¯”å¦‚</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><code class="hljs cmake">mvn clean <span class="hljs-keyword">install</span> &#x27;-Dmaven.<span class="hljs-keyword">test</span>.skip=<span class="hljs-keyword">true</span>&#x27;<br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>tools</category>
        <category>maven</category>
      </categories>
      <tags>
        <tag>maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Win11é€šè¿‡è„šæœ¬åˆ‡æ¢ä¸»é¢˜</title>
    <url>/2023/a3ce1a2f074a/index.html</url>
    <content><![CDATA[<blockquote>
<p>å…·ä½“ä¸»é¢˜çš„æ–‡ä»¶åç§°å¯ä»¥åˆ° <code>C:\\Windows\\Resources\\Themes</code> ç›®å½•ä¸‹è¿›è¡ŒæŸ¥çœ‹</p>
</blockquote>
<p>åˆ‡æ¢ Light ä¸»é¢˜</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><code class="hljs bat"><span class="hljs-built_in">start</span> &quot;&quot; &quot;C:\\Windows\\Resources\\Themes\\Light.theme&quot; &amp; timeout /t <span class="hljs-number">2</span> &amp; <span class="hljs-built_in">taskkill</span> /im &quot;systemsettings.exe&quot; /f<br></code></pre></td></tr></table></figure>

<p>åˆ‡æ¢ Dark ä¸»é¢˜</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><code class="hljs bat"><span class="hljs-built_in">start</span> &quot;&quot; &quot;C:\\Windows\\Resources\\Themes\\dark.theme&quot; &amp; timeout /t <span class="hljs-number">2</span> &amp; <span class="hljs-built_in">taskkill</span> /im &quot;systemsettings.exe&quot; /f<br></code></pre></td></tr></table></figure>

<h2 id="éšè—æ‰§è¡Œè„šæœ¬æ—¶çš„é»‘æ¡†"><a href="#éšè—æ‰§è¡Œè„šæœ¬æ—¶çš„é»‘æ¡†" class="headerlink" title="éšè—æ‰§è¡Œè„šæœ¬æ—¶çš„é»‘æ¡†"></a>éšè—æ‰§è¡Œè„šæœ¬æ—¶çš„é»‘æ¡†</h2><p><strong>æ–¹æ³•ä¸€</strong><br>æ‰§è¡Œä¸Šé¢ä¸¤ä¸ªè„šæœ¬éƒ½ä¼šå‡ºç°é»‘è‰²çª—å£ï¼Œå¯ä»¥ä¿®æ”¹ <code>bat</code> æ–‡ä»¶ï¼Œå˜æˆå¦‚ä¸‹å½¢å¼</p>
<p>åˆ‡æ¢é»‘è‰²ä¸»é¢˜</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><code class="hljs bat"><span class="hljs-keyword">if</span> &quot;%<span class="hljs-number">1</span>&quot;==&quot;hide&quot; <span class="hljs-keyword">goto</span> CmdBegin<br><span class="hljs-built_in">start</span> mshta vbscript:createobject(&quot;wscript.shell&quot;).run(&quot;&quot;&quot;%~<span class="hljs-number">0</span>&quot;&quot; hide&quot;,<span class="hljs-number">0</span>)(window.close)&amp;&amp;<span class="hljs-keyword">exit</span><br>:CmdBegin<br><br><span class="hljs-built_in">start</span> &quot;&quot; &quot;C:\\Windows\\Resources\\Themes\\dark.theme&quot; &amp; timeout /t <span class="hljs-number">2</span> &amp; <span class="hljs-built_in">taskkill</span> /im &quot;systemsettings.exe&quot; /f<br></code></pre></td></tr></table></figure>

<p>åˆ‡æ¢ç™½è‰²ä¸»é¢˜</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><code class="hljs bat"><span class="hljs-keyword">if</span> &quot;%<span class="hljs-number">1</span>&quot;==&quot;hide&quot; <span class="hljs-keyword">goto</span> CmdBegin<br><span class="hljs-built_in">start</span> mshta vbscript:createobject(&quot;wscript.shell&quot;).run(&quot;&quot;&quot;%~<span class="hljs-number">0</span>&quot;&quot; hide&quot;,<span class="hljs-number">0</span>)(window.close)&amp;&amp;<span class="hljs-keyword">exit</span><br>:CmdBegin<br><br><span class="hljs-built_in">start</span> &quot;&quot; &quot;C:\\Windows\\Resources\\Themes\\Light.theme&quot; &amp; timeout /t <span class="hljs-number">2</span> &amp; <span class="hljs-built_in">taskkill</span> /im &quot;systemsettings.exe&quot; /f<br></code></pre></td></tr></table></figure>

<p><strong>æ–¹æ³•äºŒ</strong><br>ç¬¬äºŒç§æ–¹å¼æ˜¯å¦å¤–å†åˆ›å»ºä¸€ä¸ª <code>vbs</code> æ–‡ä»¶ï¼Œåœ¨ <code>vbs</code> ä¸­æ‰§è¡Œ <code>bat</code> æ–‡ä»¶</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">set</span> <span class="hljs-attribute">ws</span>=WScript.CreateObject(&quot;WScript.Shell&quot;)<br>ws.<span class="hljs-built_in">Run</span> <span class="hljs-string">&quot;C:\xxx.bat&quot;</span>,0<br></code></pre></td></tr></table></figure>

<p>ç„¶åå¯ä»¥ç»“åˆ <a href="https://u.tools/">utools</a> ä½¿ç”¨ï¼Œå°±å¯ä»¥å¿«é€Ÿæ‰§è¡Œä¸»é¢˜åˆ‡æ¢</p>
]]></content>
      <categories>
        <category>tools</category>
        <category>other</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>WindTermåŠŸèƒ½è®¾ç½®</title>
    <url>/2023/0ff9c6825506/index.html</url>
    <content><![CDATA[<h2 id="è‡ªå®šä¹‰å¿«æ·é”®"><a href="#è‡ªå®šä¹‰å¿«æ·é”®" class="headerlink" title="è‡ªå®šä¹‰å¿«æ·é”®"></a>è‡ªå®šä¹‰å¿«æ·é”®</h2><p><a href="https://github.com/kingToolbox/WindTerm/issues/267">å‚è€ƒgithub</a></p>
<h2 id="å»é™¤é”å±"><a href="#å»é™¤é”å±" class="headerlink" title="å»é™¤é”å±"></a>å»é™¤é”å±</h2><ol>
<li>æ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥åœ¨ <strong>ä¼šè¯-&gt;é¦–é€‰é¡¹-&gt;é…ç½®æ–‡ä»¶</strong> ä¸­æŸ¥çœ‹é…ç½®æ–‡ä»¶çš„ä½ç½®</li>
<li>æ‰¾åˆ° <code>application.lockScreenTimeout</code>ï¼Œ å°†å€¼æ”¹æˆ 0</li>
</ol>
<h2 id="å®‰è£…-Nord-ä¸»é¢˜"><a href="#å®‰è£…-Nord-ä¸»é¢˜" class="headerlink" title="å®‰è£… Nord ä¸»é¢˜"></a>å®‰è£… Nord ä¸»é¢˜</h2><p><a href="https://github.com/teaper/windterm-nord-theme">ä¸‹è½½Nordä¸»é¢˜</a></p>
]]></content>
      <categories>
        <category>tools</category>
        <category>other</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>å¸¸ç”¨çš„å·¥å…·ç½‘ç«™è®°å½•</title>
    <url>/2023/366386a79bec/index.html</url>
    <content><![CDATA[<h2 id="pdf"><a href="#pdf" class="headerlink" title="pdf"></a>pdf</h2><p><a href="https://www.ilovepdf.com/compress_pdf">pdfåœ¨çº¿å‹ç¼©</a><br><a href="https://tools.pdf24.org/zh/compress-pdf#s=1604459737862%20%20%20%20%20pdf%E5%8E%8B%E7%BC%A9%E8%BD%AF%E4%BB%B6">pdfåœ¨çº¿å‹ç¼©</a></p>
<h2 id="èµ„æºç½‘ç«™"><a href="#èµ„æºç½‘ç«™" class="headerlink" title="èµ„æºç½‘ç«™"></a>èµ„æºç½‘ç«™</h2><ul>
<li><a href="https://cmsblogs.cn/">å¤§ç™½èœåšå®¢</a></li>
</ul>
<h2 id="æˆªå›¾å·¥å…·"><a href="#æˆªå›¾å·¥å…·" class="headerlink" title="æˆªå›¾å·¥å…·"></a>æˆªå›¾å·¥å…·</h2><p><a href="https://pixpinapp.com/">pixpin</a>,  è¯¥æˆªå›¾å·¥å…·åŒ…å«å¸¸ç”¨çš„ï¼Œæ ‡æ³¨ï¼Œè´´å›¾ï¼Œé•¿æˆªå›¾ï¼Œ<code>ocr</code> ç­‰åŠŸèƒ½</p>
<ul>
<li>å¯¹äºé•¿æˆªå›¾éœ€è¦æ‰“å¼€ <strong>é…ç½® -&gt; å¿«æ·é”®&#x2F;åŠ¨ä½œ -&gt; æ·»åŠ æ–°åŠ¨ä½œ</strong> ä¸­æ‰¾åˆ°é•¿æˆªå›¾ï¼Œç„¶åå°† <strong>æ‰˜ç›˜èœå•</strong> å‹¾ä¸Šå°±å¯ä»¥çœ‹åˆ°é•¿æˆªå›¾åŠŸèƒ½</li>
<li><code>ocr</code> åŠŸèƒ½ï¼Œæ˜¯æŒ‡è´´å›¾åå¯ä»¥ç›´æ¥å¤åˆ¶å›¾ç‰‡ä¸­çš„æ–‡å­—</li>
</ul>
]]></content>
      <categories>
        <category>tools</category>
        <category>other</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>utoolsè‡ªåŠ¨åŒ–è„šæœ¬æ’ä»¶</title>
    <url>/2023/d899f5ff1973/index.html</url>
    <content><![CDATA[<h2 id="utools-ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬æ‰“å¼€æœ¬åœ°ç¨‹åº"><a href="#utools-ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬æ‰“å¼€æœ¬åœ°ç¨‹åº" class="headerlink" title="utools ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬æ‰“å¼€æœ¬åœ°ç¨‹åº"></a>utools ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬æ‰“å¼€æœ¬åœ°ç¨‹åº</h2><ol>
<li>æ¯”å¦‚ typora å¯ä»¥æ‰“å¼€ä¹‹å‰çš„æ–‡ä»¶å’Œç›®å½•ï¼Œä½†æ˜¯ç›®å½•åªèƒ½åˆ°æ–‡ä»¶çš„ä¸Šä¸€ä¸ªå±‚çº§ï¼Œå¦‚æœæºç›®å½•åŒ…å«å¾ˆå¤šå­ç›®å½•ï¼Œé‡æ–°æ‰“å¼€æ—¶å¯èƒ½ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œé‚£å¯ä»¥åœ¨å‘½ä»¤è¡Œæ‰§è¡Œ <code>typora folder</code>, eg: <code>typora E:\\blog</code> <span id="more"></span></li>
</ol>
<blockquote>
<p>åœ¨å‘½ä»¤è¡Œæ‰§è¡Œ typora å‘½ä»¤éœ€è¦å…ˆé…ç½® typora çš„ç¯å¢ƒå˜é‡</p>
</blockquote>
<ol>
<li>æ›´ç®€ä¾¿çš„æ–¹å¼æ˜¯ç›´æ¥ä½¿ç”¨ utools çš„è‡ªåŠ¨åŒ–è„šæœ¬è¿™ä¸ªæ’ä»¶ï¼Œæ–°å¢ä¸€ä¸ªè‡ªå·±çš„æ’ä»¶è„šæœ¬ï¼Œå†…å®¹å¦‚ä¸‹</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> &#123; execFile &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;child_process&quot;</span>)<br><br> <span class="hljs-comment">// ä»¥ä¸‹æ˜¯å…³é”®ä»£ç ï¼Œè°ƒç”¨ typora æ¥æ‰§è¡Œç›®æ ‡æ–‡ä»¶</span><br><span class="hljs-title function_">execFile</span>(<span class="hljs-string">&#x27;typora&#x27;</span>, [<span class="hljs-string">&#x27;E:/code/learnerguo&#x27;</span>], <span class="hljs-function">(<span class="hljs-params">error, stdout, stderr</span>) =&gt;</span> &#123;<br>    process.<span class="hljs-title function_">exit</span>()<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>ç„¶åè‡ªå®šä¹‰å…³é”®å­—ï¼Œåç»­å½“æ‰“å¼€ utools è¾“å…¥å¯¹åº”å…³é”®å­—å°±å¯ä»¥æ‰“å¼€ typora çš„ç›®å½•</p>
<h2 id="ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬è·å–å½“å¤©èµ·å§‹æ—¶é—´"><a href="#ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬è·å–å½“å¤©èµ·å§‹æ—¶é—´" class="headerlink" title="ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬è·å–å½“å¤©èµ·å§‹æ—¶é—´"></a>ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬è·å–å½“å¤©èµ·å§‹æ—¶é—´</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> now = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br><span class="hljs-comment">// è®¾ç½®å½“å‰æ—¶é—´çš„å°æ—¶ã€åˆ†é’Ÿã€ç§’å’Œæ¯«ç§’ä¸º0ï¼Œå³å°†æ—¶é—´è®¾ç½®ä¸ºå½“å¤©çš„å¼€å§‹æ—¶é—´</span><br>now.<span class="hljs-title function_">setHours</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><span class="hljs-comment">// è·å–å½“å¤©å¼€å§‹æ—¶é—´ç‚¹çš„æ¯«ç§’æ•°</span><br><span class="hljs-keyword">const</span> startTime = now.<span class="hljs-title function_">getTime</span>();<br>utools.<span class="hljs-title function_">copyText</span>(<span class="hljs-string">&quot;&quot;</span>+startTime);<br><span class="hljs-title function_">print</span>(<span class="hljs-string">&#x27;å¼€å§‹æ—¶é—´å·²å¤åˆ¶&#x27;</span> + startTime);<br>utools.<span class="hljs-title function_">hideMainWindow</span>();<br>process.<span class="hljs-title function_">exit</span>()<br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>tools</category>
        <category>utools</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>utools</tag>
      </tags>
  </entry>
  <entry>
    <title>vscodeç›¸å…³è®¾ç½®</title>
    <url>/2023/6b613d963af3/index.html</url>
    <content><![CDATA[<h2 id="vscode-ä¸­-markdown-çš„-snippets-çš„è®¾ç½®"><a href="#vscode-ä¸­-markdown-çš„-snippets-çš„è®¾ç½®" class="headerlink" title="vscode ä¸­ markdown çš„ snippets çš„è®¾ç½®"></a>vscode ä¸­ markdown çš„ snippets çš„è®¾ç½®</h2><h3 id="snippets-çš„è®¾ç½®"><a href="#snippets-çš„è®¾ç½®" class="headerlink" title="snippets çš„è®¾ç½®"></a>snippets çš„è®¾ç½®</h3><ol>
<li>æ‰“å¼€ ctrl+shift+p , æœç´¢ <code>configure user snippets</code> </li>
<li>é€‰æ‹© markdown.json, ä¼šå‡ºç°å¦‚ä¸‹å†…å®¹</li>
</ol>
<span id="more"></span>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>	<span class="hljs-comment">// Place your snippets for markdown here. Each snippet is defined under a snippet name and has a prefix, body and </span><br>	<span class="hljs-comment">// description. The prefix is what is used to trigger the snippet and the body will be expanded and inserted. Possible variables are:</span><br>	<span class="hljs-comment">// $1, $2 for tab stops, $0 for the final cursor position, and $&#123;1:label&#125;, $&#123;2:another&#125; for placeholders. Placeholders with the </span><br>	<span class="hljs-comment">// same ids are connected.</span><br>	<span class="hljs-comment">// Example:</span><br>	<span class="hljs-comment">// &quot;Print to console&quot;: &#123;</span><br>	<span class="hljs-comment">// 	&quot;prefix&quot;: &quot;log&quot;,</span><br>	<span class="hljs-comment">// 	&quot;body&quot;: [</span><br>	<span class="hljs-comment">// 		&quot;console.log(&#x27;$1&#x27;);&quot;,</span><br>	<span class="hljs-comment">// 		&quot;$2&quot;</span><br>	<span class="hljs-comment">// 	],</span><br>	<span class="hljs-comment">// 	&quot;description&quot;: &quot;Log output to console&quot;</span><br>	<span class="hljs-comment">// &#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<ol>
<li>å¯ä»¥æ ¹æ®ç¤ºä¾‹æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-string">&quot;markdown code graph&quot;</span>: &#123;<br>	<span class="hljs-string">&quot;prefix&quot;</span>: <span class="hljs-string">&quot;codeblock&quot;</span>,<br>	<span class="hljs-string">&quot;body&quot;</span>: [<br>		<span class="hljs-string">&quot;&lt;pre class=&quot;</span>mermaid<span class="hljs-string">&quot;&gt;<span class="hljs-variable">$0</span>&quot;</span>,<br>		<span class="hljs-string">&quot;```&quot;</span><br>	],<br>	<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;insert markdown code graph&quot;</span><br>&#125;&lt;/pre&gt;<br><br>ä¸Šé¢ç¤ºä¾‹çš„æ„æ€æ˜¯ å½“è¾“å…¥ codeblock æ—¶å°±ä¼šå‡ºç° mermaid ä»£ç å—ï¼Œ <span class="hljs-variable">$0</span> æ˜¯å…‰æ ‡å‡ºç°çš„åœ°æ–¹<br><br><span class="hljs-comment">### markdown snippets ä¸ç”Ÿæ•ˆçš„è§£å†³æ–¹å¼</span><br>ä½¿ç”¨ä¸Šé¢çš„æ­¥éª¤è®¾ç½®å®Œ snippets ä¹‹åï¼Œåœ¨ markdown æ–‡æ¡£ä¸­ç¼–å†™å…³é”®å­—ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼Œè¿˜éœ€è¦åœ¨  settings.json ä¸­ï¼ˆå¯ä»¥è¾“å…¥ ctrl+<span class="hljs-built_in">shift</span>+p, æœç´¢ settingsï¼Œ é€‰æ‹© Open User Settings(JSON)ï¼‰, ç„¶åå¡«å†™ä¸‹é¢çš„å†…å®¹<br><br>```java<br><span class="hljs-string">&quot;[markdown]&quot;</span>:&#123;<br>	<span class="hljs-string">&quot;editor.formatOnSave&quot;</span>: <span class="hljs-literal">true</span>,<br>	<span class="hljs-string">&quot;editor.renderWhitespace&quot;</span>: <span class="hljs-string">&quot;all&quot;</span>,<br>	<span class="hljs-string">&quot;editor.quickSuggestions&quot;</span>: &#123;<br>		<span class="hljs-string">&quot;other&quot;</span>: <span class="hljs-string">&quot;on&quot;</span>,<br>		<span class="hljs-string">&quot;comments&quot;</span>: <span class="hljs-string">&quot;on&quot;</span>,<br>		<span class="hljs-string">&quot;strings&quot;</span>: <span class="hljs-string">&quot;on&quot;</span><br>	&#125;,<br>	<span class="hljs-string">&quot;editor.acceptSuggestionOnEnter&quot;</span>: <span class="hljs-string">&quot;on&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<p>æ·»åŠ ä¸Šè¿°å†…å®¹åå°±å¯ä»¥ç”Ÿæ•ˆäº†</p>
<h2 id="vscode-è®¾ç½®ç™½å¤©é»‘å¤œè‡ªåŠ¨åˆ‡æ¢ä¸»é¢˜"><a href="#vscode-è®¾ç½®ç™½å¤©é»‘å¤œè‡ªåŠ¨åˆ‡æ¢ä¸»é¢˜" class="headerlink" title="vscode è®¾ç½®ç™½å¤©é»‘å¤œè‡ªåŠ¨åˆ‡æ¢ä¸»é¢˜"></a>vscode è®¾ç½®ç™½å¤©é»‘å¤œè‡ªåŠ¨åˆ‡æ¢ä¸»é¢˜</h2><ol>
<li>vscode å¯ä»¥æ ¹æ®ç³»ç»Ÿè®¾ç½®çš„ <code>light</code> æˆ– <code>dark</code> ä¸»é¢˜æ¥è¿›è¡Œåˆ‡æ¢</li>
<li>ç³»ç»Ÿè‡ªåŠ¨åˆ‡æ¢ä¸»é¢˜è½¯ä»¶å¯ä»¥åœ¨ <code>store</code> ä¸­å®‰è£… <code>Auto Dark Mode</code> è¿™ä¸ªè½¯ä»¶å¹¶è¿›è¡Œè®¾ç½®</li>
<li><code>window</code> ç³»ç»Ÿè®¾ç½®å®Œæˆä¹‹åå¯ä»¥åœ¨ <code>vscode</code> çš„ <code>user setting</code> ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹, ç¬¬ä¸€ä¸ªé…ç½®æ˜¯å¼€å¯è‡ªåŠ¨åˆ‡æ¢ï¼Œåé¢çš„é…ç½®æ˜¯è®¾ç½®çš„ <code>light</code> å’Œ <code>dark</code> ä¸»é¢˜çš„åç§°</li>
</ol>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;window.autoDetectColorScheme&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;workbench.preferredLightColorTheme&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Atom One Light&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;workbench.preferredDarkColorTheme&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Default Dark Modern&quot;</span><br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>tools</category>
        <category>vscode</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>vscode</tag>
      </tags>
  </entry>
  <entry>
    <title>vscodeè®¾ç½®markdownå›¾ç‰‡é»˜è®¤è·¯å¾„</title>
    <url>/2023/5b4d784e18c2/index.html</url>
    <content><![CDATA[<p><code>vscode</code> åœ¨ <code>markdown</code> æ–‡æ¡£ä¸­ç›´æ¥å¤åˆ¶å›¾ç‰‡æ—¶æ˜¯æ”¾åœ¨å½“å‰ç›®å½•ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹å¯ä»¥æŒ‰ç…§ä¸‹é¢æ–¹å¼è®¾ç½®</p>
<span id="more"></span>
<ol>
<li>è¾“å…¥å¿«æ·é”® <code>ctrl+,</code> å¯ä»¥å¿«é€Ÿæ‰“å¼€è®¾ç½®</li>
<li>æœç´¢ <code>markdown.copy: Destination</code></li>
</ol>
<p><img src="/2023/5b4d784e18c2/index/1700033681108.png" alt="Alt text"></p>
]]></content>
      <categories>
        <category>tools</category>
        <category>vscode</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>dockerä¸­è¿è¡Œnacos</title>
    <url>/2023/f67204379054/index.html</url>
    <content><![CDATA[<p>ä½¿ç”¨çš„ç³»ç»Ÿä¸º <code>ubuntu22.04</code></p>
<ol><li><a href="/2023/71e6b223e45b/index.html" title="ubuntu22.04å®‰è£…docker-compose">ubuntu22.04å®‰è£…docker-compose</a></li></ol>

<p>å‚è€ƒ <a href="https://nacos.io/zh-cn/docs/quick-start-docker.html">nacoså®˜æ–¹æ–‡æ¡£ä¹‹ä½¿ç”¨dockerå¯åŠ¨</a></p>
<p>è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>mysql8</code> å•æœºç‰ˆå¯åŠ¨</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- å…‹éš†é¡¹ç›® --&gt;</span><br>git clone https://github.com/nacos-group/nacos-docker.git<br>cd nacos-docker<br><br><span class="hljs-comment">&lt;!-- ä»¥åå°æ¨¡å¼å¯åŠ¨ nacos æœåŠ¡ --&gt;</span><br>docker-compose -f example/standalone-mysql-8.yaml up -d<br><br><span class="hljs-comment">&lt;!-- æŸ¥çœ‹å¯åŠ¨çš„dockeræœåŠ¡ --&gt;</span><br>docker container ps<br><br><span class="hljs-comment">&lt;!-- å…³é—­æœåŠ¡ --&gt;</span><br>docker-compose -f example/standalone-mysql-8.yaml down<br><br><span class="hljs-comment">&lt;!-- å¯åŠ¨åï¼Œè®¿é—® nacos  --&gt;</span><br>http://localhost:8848/nacos/index.html<br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>äº‘åŸç”Ÿ</category>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>dockeré…ç½®é˜¿é‡Œäº‘åŠ é€Ÿé•œåƒ</title>
    <url>/2023/2b35420a425c/index.html</url>
    <content><![CDATA[<ol>
<li>è®¿é—®<a href="https://cr.console.aliyun.com/">é˜¿é‡Œäº‘é•œåƒæ§åˆ¶å°</a>ï¼Œ æ‰¾åˆ°é•œåƒåŠ é€Ÿé“¾æ¥</li>
</ol>
<p><img src="https://blog-1308475102.cos.ap-guangzhou.myqcloud.com/picture/202311272213645.webp" alt="åŠ é€Ÿé•œåƒ"></p>
<ol start="2">
<li>åœ¨æ–‡æ¡£çš„ä¸‹æ–¹å°±æœ‰ä¸åŒç¯å¢ƒé…ç½®çš„ä»£ç ï¼Œä¸‹é¢æ˜¯ <code>ubuntu</code> ç¯å¢ƒçš„é…ç½®ï¼ˆåŠ é€Ÿè·¯å¾„æ›¿æ¢æˆè‡ªå·±çš„ï¼‰</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sudo <span class="hljs-built_in">mkdir</span> -p /etc/docker<br>sudo <span class="hljs-built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="hljs-string">&#x27;EOF&#x27;</span><br>&#123;<br>  <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<span class="hljs-string">&quot;https://xxx.mirror.aliyuncs.com&quot;</span>]<br>&#125;<br>EOF<br>sudo systemctl daemon-reload<br>sudo systemctl restart docker<br></code></pre></td></tr></table></figure>

<ol>
<li>ä¿®æ”¹ Cgroup Driver, ä¿®æ”¹ <code>/etc/docker/daemon.json</code> æ–‡ä»¶ï¼Œå¢åŠ å¦‚ä¸‹å†…å®¹</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-string">&quot;exec-opts&quot;</span>: [<span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span>]<br></code></pre></td></tr></table></figure>
<p>æœ€ç»ˆ <code>daemon.json</code> æ–‡ä»¶å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">&#123;<br>  <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<span class="hljs-string">&quot;https://xxx.mirror.aliyuncs.com&quot;</span>],<br>  <span class="hljs-string">&quot;exec-opts&quot;</span>: [<span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span>]<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>é‡å¯ <code>docker</code> æœåŠ¡</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sudo systemctl daemon-reload<br>sudo systemctl restart docker<br></code></pre></td></tr></table></figure>




]]></content>
      <categories>
        <category>äº‘åŸç”Ÿ</category>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>ubuntu22.04å®‰è£…docker-compose</title>
    <url>/2023/71e6b223e45b/index.html</url>
    <content><![CDATA[<ol>
<li><a href="https://github.com/docker/compose/releases">docker-composeä¸‹è½½</a>, é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬å³å¯ï¼Œå¯¹äº <code>ubuntu</code> ç³»ç»Ÿé€‰æ‹©çš„æ˜¯ <code>Linux</code> ç‰ˆæœ¬ï¼Œ ä¸‹è½½å®Œæˆåï¼Œå°†å…¶ç§»åŠ¨åˆ° <code>/usr/local/bin/</code> ç›®å½•ä¸‹å³å¯ã€‚</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># é‡å‘½å</span><br><span class="hljs-built_in">mv</span> docker-compose-linux-x86_64 docker-compose<br><span class="hljs-comment"># ç§»åŠ¨åˆ°æ‰§è¡Œç›®å½•</span><br>sudo <span class="hljs-built_in">mv</span> docker-compose /usr/local/bin/<br><span class="hljs-comment"># èµ‹äºˆæ‰§è¡Œæƒé™</span><br>sudo <span class="hljs-built_in">chmod</span> u+x docker-compose<br></code></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>äº‘åŸç”Ÿ</category>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨docker-composeå®‰è£…mysqlå’ŒredisåŸºæœ¬ç¯å¢ƒ</title>
    <url>/2023/3c61103fd97b/index.html</url>
    <content><![CDATA[<h2 id="åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ"><a href="#åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ" class="headerlink" title="åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ"></a>åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker network create service_default<br></code></pre></td></tr></table></figure>

<h2 id="docker-compose-å®‰è£…mysql-redis"><a href="#docker-compose-å®‰è£…mysql-redis" class="headerlink" title="docker-compose å®‰è£…mysql,redis"></a>docker-compose å®‰è£…mysql,redis</h2><p>ä¸‹é¢å°†æ‰€æœ‰çš„è½¯ä»¶å®‰è£…åœ¨ <code>/opt/docker_soft</code> ç›®å½•ä¸‹</p>
<ol>
<li>åœ¨ <code>/opt/docker_soft</code> ç›®å½•ä¸‹åˆ›å»ºå¦‚ä¸‹ç›®å½•ç»“æ„</li>
</ol>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">â”œâ”€â”€ config<br>â”‚   â”œâ”€â”€ mysql8<br>â”‚   â”‚   â””â”€â”€ my<span class="hljs-selector-class">.cnf</span><br>â”‚   â”œâ”€â”€ nginx<br>â”‚   â”‚   â””â”€â”€ nginx<span class="hljs-selector-class">.conf</span><br>â”‚   â”œâ”€â”€ redis7<br>â”‚   â”‚   â””â”€â”€ redis<span class="hljs-selector-class">.conf</span><br>â”‚   â””â”€â”€ zk<br>â”‚       â””â”€â”€ zoo<span class="hljs-selector-class">.cfg</span><br>â”œâ”€â”€ data<br>â”‚   â”œâ”€â”€ mysql8<br>â”‚   â”œâ”€â”€ nginx<br>â”‚   â”œâ”€â”€ redis<br>â”œâ”€â”€ docker-compose<span class="hljs-selector-class">.yml</span><br>â””â”€â”€ log<br>    â”œâ”€â”€ mysql8<br>    â””â”€â”€ nginx<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /opt/docker_soft<br><span class="hljs-built_in">mkdir</span> -p config data <span class="hljs-built_in">log</span><br><span class="hljs-built_in">cd</span> config/<br><span class="hljs-built_in">mkdir</span> mysql8<br><span class="hljs-built_in">mkdir</span> nginx<br><span class="hljs-built_in">mkdir</span> redis7<br><span class="hljs-built_in">touch</span> mysql8/my.cnf<br><span class="hljs-built_in">touch</span> nginx/nginx.conf<br><span class="hljs-built_in">touch</span> redis7/redis.conf<br><br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">mkdir</span> data/mysql8<br><span class="hljs-built_in">mkdir</span> data/nginx<br><span class="hljs-built_in">mkdir</span> data/redis<br><span class="hljs-built_in">mkdir</span> <span class="hljs-built_in">log</span>/mysql8<br><span class="hljs-built_in">mkdir</span> <span class="hljs-built_in">log</span>/nginx<br><br><span class="hljs-comment"># ç»™mysqlæŒ‚è½½ç›®å½•èµ‹äºˆæ‰€æœ‰æƒé™ï¼Œé¿å…mysqlå¯åŠ¨æŠ¥é”™</span><br><span class="hljs-built_in">chmod</span> -R 777 data/mysql8<br></code></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šé¢å‘½ä»¤åˆ›å»ºäº†ä¸‰ä¸ªé…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­ <code>my.cnf</code> æ˜¯ mysql çš„é…ç½®æ–‡ä»¶ï¼Œ<code>nginx.conf</code> æ˜¯ nginx çš„é…ç½®æ–‡ä»¶ï¼Œ<code>redis.conf</code> æ˜¯ redis çš„é…ç½®æ–‡ä»¶ï¼Œ å¯ä»¥å°†ä¸‹é¢å†…å®¹æ‹·è´åˆ°å¯¹åº”çš„é…ç½®æ–‡ä»¶ä¸­ã€‚</p>
<div class="tabs" id="é…ç½®æ–‡ä»¶"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="é…ç½®æ–‡ä»¶-1">mysqlçš„é…ç½®æ–‡ä»¶(my.cnf)</button><button type="button" class="tab " data-href="é…ç½®æ–‡ä»¶-2">nginxçš„é…ç½®æ–‡ä»¶(nginx.conf)</button><button type="button" class="tab " data-href="é…ç½®æ–‡ä»¶-3">redisçš„é…ç½®æ–‡ä»¶(redis.conf)</button></ul><div class="tab-contents"><div class="tab-item-content active" id="é…ç½®æ–‡ä»¶-1"><figure class="highlight ini"><table><tr><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">###### [mysql]é…ç½®æ¨¡å— ######</span><br><span class="hljs-section">[mysql]</span><br><span class="hljs-comment"># è®¾ç½®MySQLå®¢æˆ·ç«¯é»˜è®¤å­—ç¬¦é›†</span><br><span class="hljs-attr">default-character-set</span>=utf8mb4<br><span class="hljs-attr">socket</span>=/var/lib/mysql/mysql.sock<br><br><br><span class="hljs-comment">###### [mysqld]é…ç½®æ¨¡å— ######</span><br><span class="hljs-section">[mysqld]</span><br><span class="hljs-attr">port</span>=<span class="hljs-number">3306</span><br><span class="hljs-attr">user</span>=root<br><span class="hljs-comment"># æ³¨é‡Š1</span><br><span class="hljs-comment">#skip-grant-tables</span><br><span class="hljs-attr">sql_mode</span>=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION<br><br><span class="hljs-attr">datadir</span>=/var/lib/mysql<br><span class="hljs-attr">socket</span>=/var/lib/mysql/mysql.sock<br><br><span class="hljs-comment"># MySQL8 çš„å¯†ç è®¤è¯æ’ä»¶</span><br><span class="hljs-comment">#default_authentication_plugin=mysql_native_password</span><br><br><span class="hljs-comment"># ç¦ç”¨ç¬¦å·é“¾æ¥ä»¥é˜²æ­¢å„ç§å®‰å…¨é£é™©</span><br><span class="hljs-comment">#symbolic-links=0</span><br><br><span class="hljs-comment"># å…è®¸æœ€å¤§è¿æ¥æ•°</span><br><span class="hljs-attr">max_connections</span>=<span class="hljs-number">1000</span><br><br><span class="hljs-comment"># æœåŠ¡ç«¯ä½¿ç”¨çš„å­—ç¬¦é›†é»˜è®¤ä¸º8æ¯”ç‰¹ç¼–ç çš„latin1å­—ç¬¦é›†</span><br><span class="hljs-attr">character-set-server</span>=utf8mb4<br><br><span class="hljs-comment"># åˆ›å»ºæ–°è¡¨æ—¶å°†ä½¿ç”¨çš„é»˜è®¤å­˜å‚¨å¼•æ“</span><br><span class="hljs-attr">default-storage-engine</span>=INNODB<br><br><span class="hljs-comment"># è¡¨åå­˜å‚¨åœ¨ç£ç›˜æ˜¯å°å†™çš„ï¼Œä½†æ˜¯æ¯”è¾ƒçš„æ—¶å€™æ˜¯ä¸åŒºåˆ†å¤§å°å†™</span><br><span class="hljs-attr">lower_case_table_names</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">max_allowed_packet</span>=<span class="hljs-number">16</span>M <br><br><span class="hljs-comment"># è®¾ç½®æ—¶åŒº</span><br><span class="hljs-attr">default-time_zone</span>=<span class="hljs-string">&#x27;+8:00&#x27;</span><br><br><span class="hljs-comment"># binlog é…ç½®</span><br><span class="hljs-attr">log-bin</span> = /logs/mysql-bin.log<br><span class="hljs-attr">expire-logs-days</span> = <span class="hljs-number">90</span><br><span class="hljs-attr">max-binlog-size</span> = <span class="hljs-number">500</span>M<br><br><span class="hljs-comment"># server-id é…ç½®</span><br><span class="hljs-attr">server-id</span> = <span class="hljs-number">1</span><br><br><br><span class="hljs-comment">###### [client]é…ç½®æ¨¡å— ######</span><br><span class="hljs-section">[client]</span><br><span class="hljs-attr">default-character-set</span>=utf8mb4<br><br><span class="hljs-comment">#â€“initialize --lower-case-table-names=1</span><br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="é…ç½®æ–‡ä»¶-2"><figure class="highlight nginx"><table><tr><td class="code"><pre><code class="hljs nginx"><br><span class="hljs-comment">#user  nobody;</span><br><span class="hljs-comment"># å¦‚æœè®¾ç½®äº† autoï¼Œ åˆ™ work-processes çš„æ•°é‡ä¸º CPU çš„æ ¸æ•°</span><br><span class="hljs-comment"># worker_processes  auto;</span><br><span class="hljs-attribute">worker_processes</span>  <span class="hljs-number">2</span>;<br><br><span class="hljs-comment">#error_log  logs/error.log;</span><br><span class="hljs-comment">#error_log  logs/error.log  notice;</span><br><span class="hljs-comment">#error_log  logs/error.log  info;</span><br><br><span class="hljs-attribute">pid</span>        /var/log/nginx/nginx.pid;<br><br><br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;<br>&#125;<br><br><br><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-comment">#include       mime.types;</span><br>    <span class="hljs-attribute">default_type</span>  application/octet-stream;<br><br>    <span class="hljs-attribute">sendfile</span>        <span class="hljs-literal">on</span>;<br>    <span class="hljs-comment">#tcp_nopush     on;</span><br><br>    <span class="hljs-comment">#keepalive_timeout  0;</span><br>    <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span>;<br><br>    <span class="hljs-comment">#gzip  on;</span><br><br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span>  localhost;<br><br>        <span class="hljs-section">location</span> / &#123;<br>            <span class="hljs-attribute">root</span>   /usr/share/nginx/html;<br>            <span class="hljs-attribute">index</span>  index.html index.htm;<br>        &#125;<br><br>        <span class="hljs-comment">#error_page  404              /404.html;</span><br><br>        <span class="hljs-comment"># redirect server error pages to the static page /50x.html</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-attribute">error_page</span>   <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span>  /50x.html;<br>        <span class="hljs-section">location</span> = /50x.html &#123;<br>            <span class="hljs-attribute">root</span>   html;<br>        &#125;<br><br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="é…ç½®æ–‡ä»¶-3"><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">protected-mode <span class="hljs-keyword">no</span><br>port <span class="hljs-number">6379</span><br>tcp-backlog <span class="hljs-number">511</span><br>timeout <span class="hljs-number">0</span><br>tcp-keepalive <span class="hljs-number">300</span><br>daemonize <span class="hljs-keyword">no</span><br>pidfile /var/run/redis_6379.pid<br>loglevel <span class="hljs-keyword">notice</span><br>logfile &quot;&quot;<br>databases <span class="hljs-number">16</span><br><span class="hljs-keyword">always</span>-<span class="hljs-keyword">show</span>-logo <span class="hljs-keyword">no</span><br><span class="hljs-keyword">set</span>-proc-title yes<br>proc-title-<span class="hljs-keyword">template</span> &quot;&#123;title&#125; &#123;listen-addr&#125; &#123;server-mode&#125;&quot;<br>stop-writes-<span class="hljs-keyword">on</span>-bgsave-error yes<br>rdbcompression yes<br>rdbchecksum yes<br>dbfilename dump.rdb<br>rdb-del-sync-files <span class="hljs-keyword">no</span><br>dir ./<br><span class="hljs-keyword">replica</span>-serve-stale-data yes<br><span class="hljs-keyword">replica</span>-<span class="hljs-keyword">read</span>-<span class="hljs-keyword">only</span> yes<br>repl-diskless-sync yes<br>repl-diskless-sync-max-replicas <span class="hljs-number">0</span><br>repl-diskless-<span class="hljs-keyword">load</span> disabled<br>repl-<span class="hljs-keyword">disable</span>-tcp-nodelay <span class="hljs-keyword">no</span><br><span class="hljs-keyword">replica</span>-priority <span class="hljs-number">100</span><br>acllog-max-len <span class="hljs-number">128</span><br><br>lazyfree-lazy-eviction <span class="hljs-keyword">no</span><br>lazyfree-lazy-expire <span class="hljs-keyword">no</span><br>lazyfree-lazy-<span class="hljs-keyword">server</span>-del <span class="hljs-keyword">no</span><br><span class="hljs-keyword">replica</span>-lazy-flush <span class="hljs-keyword">no</span><br><br><br>lazyfree-lazy-<span class="hljs-keyword">user</span>-del <span class="hljs-keyword">no</span><br><br><br>lazyfree-lazy-<span class="hljs-keyword">user</span>-flush <span class="hljs-keyword">no</span><br>oom-score-adj <span class="hljs-keyword">no</span><br><br>oom-score-adj-<span class="hljs-keyword">values</span> <span class="hljs-number">0</span> <span class="hljs-number">200</span> <span class="hljs-number">800</span><br><br><span class="hljs-keyword">disable</span>-thp yes<br><br>appendonly <span class="hljs-keyword">no</span><br><br>appendfilename &quot;appendonly.aof&quot;<br>appenddirname &quot;appendonlydir&quot;<br>appendfsync everysec<br><span class="hljs-keyword">no</span>-appendfsync-<span class="hljs-keyword">on</span>-rewrite <span class="hljs-keyword">no</span><br>auto-aof-rewrite-percentage <span class="hljs-number">100</span><br>auto-aof-rewrite-min-size <span class="hljs-number">64</span>mb<br><br>aof-<span class="hljs-keyword">load</span>-truncated yes<br><br>aof-use-rdb-preamble yes<br><br>aof-<span class="hljs-type">timestamp</span>-enabled <span class="hljs-keyword">no</span><br><br>slowlog-<span class="hljs-keyword">log</span>-slower-than <span class="hljs-number">10000</span><br><br>slowlog-max-len <span class="hljs-number">128</span><br><br><br>latency-monitor-threshold <span class="hljs-number">0</span><br><br><span class="hljs-keyword">notify</span>-keyspace-events &quot;&quot;<br><br><br>hash-max-listpack-entries <span class="hljs-number">512</span><br>hash-max-listpack-<span class="hljs-keyword">value</span> <span class="hljs-number">64</span><br><br>list-max-listpack-size <span class="hljs-number">-2</span><br><br>list-compress-depth <span class="hljs-number">0</span><br><br><span class="hljs-keyword">set</span>-max-intset-entries <span class="hljs-number">512</span><br><br>zset-max-listpack-entries <span class="hljs-number">128</span><br>zset-max-listpack-<span class="hljs-keyword">value</span> <span class="hljs-number">64</span><br><br>hll-sparse-max-bytes <span class="hljs-number">3000</span><br><br>stream-node-max-bytes <span class="hljs-number">4096</span><br>stream-node-max-entries <span class="hljs-number">100</span><br><br>activerehashing yes<br><br>client-output-buffer-<span class="hljs-keyword">limit</span> normal <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span><br>client-output-buffer-<span class="hljs-keyword">limit</span> <span class="hljs-keyword">replica</span> <span class="hljs-number">256</span>mb <span class="hljs-number">64</span>mb <span class="hljs-number">60</span><br>client-output-buffer-<span class="hljs-keyword">limit</span> pubsub <span class="hljs-number">32</span>mb <span class="hljs-number">8</span>mb <span class="hljs-number">60</span><br>hz <span class="hljs-number">10</span><br><br>dynamic-hz yes<br><br>aof-rewrite-incremental-fsync yes<br><br>rdb-save-incremental-fsync yes<br>jemalloc-bg-thread yes<br></code></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<ol start="3">
<li>åœ¨ <code>/opt/docker_soft</code> ç›®å½•ä¸‹åˆ›å»º <code>docker-compose.yml</code> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">service_default:</span><br>    <span class="hljs-attr">external:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">mysql8:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql8</span><br>    <span class="hljs-comment">#restart: always</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">service_default</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">3306</span><span class="hljs-string">:3306</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span><br>      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">admin</span><br>      <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">test</span><br>      <span class="hljs-attr">MYSQL_USER:</span> <span class="hljs-string">mysql</span><br>      <span class="hljs-attr">MYSQL_PASSWORD:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-comment"># æ•°æ®æŒ‚è½½</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/opt/docker_soft/data/mysql8/:/var/lib/mysql/</span><br>      <span class="hljs-comment"># é…ç½®æŒ‚è½½</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/opt/docker_soft/config/mysql8/:/etc/mysql/conf.d/</span><br>      <span class="hljs-comment"># æ—¥å¿—æŒ‚è½½</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/opt/docker_soft/log/mysql8:/logs</span><br>    <span class="hljs-attr">command:</span><br>      <span class="hljs-comment"># å°†mysql8.0é»˜è®¤å¯†ç ç­–ç•¥ ä¿®æ”¹ä¸º åŸå…ˆ ç­–ç•¥ (mysql8.0å¯¹å…¶é»˜è®¤ç­–ç•¥åšäº†æ›´æ”¹ ä¼šå¯¼è‡´å¯†ç æ— æ³•åŒ¹é…)</span><br>      <span class="hljs-string">--authentication_policy=mysql_native_password</span><br>      <span class="hljs-string">--character-set-server=utf8mb4</span><br>      <span class="hljs-string">--collation-server=utf8mb4_general_ci</span><br>      <span class="hljs-string">--explicit_defaults_for_timestamp=true</span><br>      <span class="hljs-string">--lower_case_table_names=1</span><br>  <span class="hljs-attr">nginx:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.25.0</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-comment">#restart: always</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">service_default</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">80</span><span class="hljs-string">:80</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/opt/docker_soft/config/nginx:/etc/nginx</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/opt/docker_soft/log/nginx:/var/log/nginx</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7-alpine3.18</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-comment">#restart: always</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">service_default</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">6379</span><span class="hljs-string">:6379</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/opt/docker_soft/config/redis7/:/usr/local/etc/redis/</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/opt/docker_soft/data/redis:/data</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>å®‰è£… <code>docker</code> é•œåƒ</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker pull mysql:8.0<br>docker pull redis:7-alpine3.18<br>docker pull nginx:1.25.0<br></code></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>äº‘åŸç”Ÿ</category>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>æ™®é€šç”¨æˆ·æ‰§è¡Œdockerå‘½ä»¤</title>
    <url>/2023/6987d518f2d5/index.html</url>
    <content><![CDATA[<p>ä»¥ä¸‹æ“ä½œæ˜¯åœ¨ <code>ubuntu22.04</code> ç‰ˆæœ¬å®‰è£… <code>docker</code> åï¼Œæ™®é€šç”¨æˆ·æ‰§è¡Œ <code>docker</code> å‘½ä»¤æ—¶ä¸ç”¨æ·»åŠ  <code>sudo</code></p>
<ol>
<li>åˆ›å»º <code>docker</code> ç”¨æˆ·ç»„</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sudo groupadd docker<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>å°†å½“å‰ç”¨æˆ·åŠ å…¥åˆ° <code>docker</code> ç”¨æˆ·ç»„</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sudo usermod -aG docker <span class="hljs-variable">$USER</span><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>é€€å‡ºå½“å‰ç”¨æˆ·ï¼Œé‡æ–°ç™»å½•ï¼Œå³å¯ä½¿ç”¨ <code>docker</code> å‘½ä»¤</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>äº‘åŸç”Ÿ</category>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
</search>
